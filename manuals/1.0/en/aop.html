<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>AOP &#124; BEAR.Sunday</title>
    <meta name="description" content="BEAR.Sunday is a resource orientated framework with a REST centered architecture, implementing Dependency Injection and Aspect Orientated Programming' at its core.">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.css">
    <link rel="stylesheet" href="/css/syntax.css">
    
    <link rel="stylesheet" href="/css/bearsunday.css">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" href="/icon.png">
</head>
<body data-page-category="Manual" data-spy="scroll" data-target="#ArticleToc" data-offset="65">
<header>
    <nav class="navbar navbar-expand flex-column flex-md-row bg-light">
        <a class="navbar-brand mr-0 mr-md-2" href="/index.html"></a>
        <div class="navbar-nav-scroll">
            <ul class="navbar-nav flex-row">
                <li class="nav-item">
                    <a class="nav-link " href="/index.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/manuals/1.0/en/index.html">Manual</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link " href="/contributors.html">Contributors</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/slide.html">Slide</a>
                </li>
            </ul>
        </div>
        
        <ul class="navbar-nav ml-md-auto d-none d-md-flex language-list">
            <li>
                <a class="active" href="/manuals/1.0/en/aop.html">En</a>
            </li>
            <li>
                <a class="" href="/manuals/1.0/ja/aop.html">Ja</a>
            </li>
        </ul>
        
    </nav>
</header>

<main class="container-fluid">
    <div class="row flex-xl-nowrap">
        <div class="col-md-3 col-lg-2">
            <div class="side-bar">
                <nav class="navbar navbar-expand-md navbar-light">
    <div class="navigation-header">
        <div class="ml-auto d-sm-block d-md-none">
            <ul class="navbar-nav language-list">
                <li>
                    <a class="active" href="/manuals/1.0/en/aop.html">En</a>
                </li>
                <li>
                    <a class="" href="/manuals/1.0/ja/aop.html">Ja</a>
                </li>
            </ul>
            <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#Navber" aria-controls="Navber" aria-expanded="false" aria-label="ナビゲーションの切替">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </div>
    <div class="collapse navbar-collapse" id="Navber">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/en/">Introduction</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/version.html">Version</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/quick-start.html">Quick Start</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/tutorial.html">Tutorial</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/tutorial2.html">Tutorial 2</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/package.html">Package</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/application.html">Application</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/module.html">Module</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/di.html">DI</a>
            </li>
            <li>
                <a class="nav-link active" href="/manuals/1.0/en/aop.html">AOP</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/resource.html">Resource</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/en/resource_param.html">・Parameter</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/en/resource_link.html">・Link</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/en/resource_renderer.html">・Rendering and Transfer</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/router.html">Router</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/production.html">Production</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/import.html">Import</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/database.html">Database</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/validation.html">Validation</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/html.html">HTML</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/form.html">Form</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/content-negotiation.html">Content Negotiation</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/hypermedia-api.html">Hypermedia API</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/psr7.html">Request / PSR-7</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/js-ui.html">JavaScript UI</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/stream.html">Stream Response</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/cache.html">Cache</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/swoole.html">Swoole</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/coding-guide.html">Coding Guide</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/en/types.html">Type</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/test.html">Test</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/examples.html">Examples</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/en/attribute.html">Attribute</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/en/apidoc.html">API Doc</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/1page.html">1 Page</a>
            </li>
        </ul>
    </div>
</nav>

            </div>
        </div>
        <div class="col-md-9 col-lg-8">
            <article id="article" class="markdown-body">
                <h1 id="aop">AOP</h1>

<p>BEAR.Sunday <strong>AOP</strong> enables you to write code that is executed each time a matching method is invoked. It’s suited for cross cutting concerns (“aspects”), such as transactions, security and logging. Because interceptors divide a problem into aspects rather than objects, their use is called Aspect Oriented Programming (AOP).</p>

<p>The method interceptor API implemented is a part of a public specification called <a href="http://aopalliance.sourceforge.net/">AOP Alliance</a>.</p>

<h2 id="interceptor">Interceptor</h2>

<p><a href="https://github.com/ray-di/Ray.Aop/blob/2.x/src/MethodInterceptor.php">MethodInterceptors</a> are executed whenever a matching method is invoked.
They have the opportunity to inspect the call: the method, its arguments, and the receiving instance.
They can perform their cross-cutting logic and then delegate to the underlying method.
Finally, they may inspect the return value or the exception and return. Since interceptors may be applied to many methods and will receive many calls, their implementation should be efficient and unintrusive.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Aop\MethodInterceptor</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Aop\MethodInvocation</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyInterceptor</span> <span class="kd">implements</span> <span class="nc">MethodInterceptor</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">invoke</span><span class="p">(</span><span class="kt">MethodInvocation</span> <span class="nv">$invocation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Process before method invocation</span>
        <span class="c1">// ...</span>

        <span class="c1">// Original method invocation</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="nf">proceed</span><span class="p">();</span>

        <span class="c1">// Process after method invocation</span>
        <span class="c1">// ...</span>

        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="bindings">Bindings</h2>

<p>“Find” the target class and method with <code class="language-plaintext highlighter-rouge">Matcher</code> and bind the interceptor to the matching method in <a href="module.html">Module</a>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bindInterceptor</span><span class="p">(</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">any</span><span class="p">(),</span>                   <span class="c1">// In any class,</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">startsWith</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">),</span>    <span class="c1">// Method(s) names that start with "delete",</span>
    <span class="p">[</span><span class="nc">Logger</span><span class="o">::</span><span class="n">class</span><span class="p">]</span>                          <span class="c1">// Bind a Logger interceptor</span>
<span class="p">);</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bindInterceptor</span><span class="p">(</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">subclassesOf</span><span class="p">(</span><span class="nc">AdminPage</span><span class="o">::</span><span class="n">class</span><span class="p">),</span>  <span class="c1">// Of the AdminPage class or a class inherited from it</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">Auth</span><span class="o">::</span><span class="n">class</span><span class="p">),</span>      <span class="c1">// Annotated method with the @Auth annotation</span>
    <span class="p">[</span><span class="nc">AdminAuthentication</span><span class="o">::</span><span class="n">class</span><span class="p">]</span>                     <span class="c1">//Bind the AdminAuthenticationInterceptor</span>
<span class="p">);</span>
</code></pre></div></div>

<p>There are various matchers.</p>

<ul>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L16">Matcher::any</a></li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L23">Matcher::annotatedWith</a></li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L30">Matcher::subclassesOf</a></li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L37">Matcher::startsWith</a></li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L44">Matcher::logicalOr</a></li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L51">Matcher::logicalAnd</a></li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L58">Matcher::logicalNot</a>
```</li>
</ul>

<p>With the <code class="language-plaintext highlighter-rouge">MethodInvocation</code> object, you can access the target method’s invocation object, method’s and parameters.</p>

<ul>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/Joinpoint.php#L39">MethodInvocation::proceed</a> - Invoke method</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MethodInvocation.php">MethodInvocation::getMethod</a> -  Get method reflection</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/Joinpoint.php#L48">MethodInvocation::getThis</a> - Get object</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/Invocation.php">MethodInvocation::getArguments</a> - Pet parameters</li>
</ul>

<p>Annotations can be obtained using the reflection API.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$method</span> <span class="o">=</span> <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="nf">getMethod</span><span class="p">();</span>
<span class="nv">$class</span> <span class="o">=</span> <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="nf">getMethod</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getDeclaringClass</span><span class="p">();</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">$method-&gt;getAnnotations()</code>    // get method annotations</li>
  <li><code class="language-plaintext highlighter-rouge">$method-&gt;getAnnotation($name)</code></li>
  <li><code class="language-plaintext highlighter-rouge">$class-&gt;getAnnotations()</code>     // get class annotations</li>
  <li><code class="language-plaintext highlighter-rouge">$class-&gt;getAnnotation($name)</code></li>
</ul>

<h2 id="own-matcher">Own matcher</h2>

<p>You can have your own matcher.
To create <code class="language-plaintext highlighter-rouge">contains</code> matcher, You need to provide a class which has two methods. One is <code class="language-plaintext highlighter-rouge">matchesClass</code> for a class match.
The other one is <code class="language-plaintext highlighter-rouge">matchesMethod</code> method match. Both return the boolean result of match.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Aop\AbstractMatcher</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ContainsMatcher</span> <span class="kd">extends</span> <span class="nc">AbstractMatcher</span>
<span class="p">{</span>
    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">matchesClass</span><span class="p">(</span><span class="err">\</span><span class="nc">ReflectionClass</span> <span class="nv">$class</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$arguments</span><span class="p">)</span> <span class="o">:</span> <span class="n">bool</span>
    <span class="p">{</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$contains</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$arguments</span><span class="p">;</span>

        <span class="k">return</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$class</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="nv">$contains</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">matchesMethod</span><span class="p">(</span><span class="err">\</span><span class="nc">ReflectionMethod</span> <span class="nv">$method</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$arguments</span><span class="p">)</span> <span class="o">:</span> <span class="n">bool</span>
    <span class="p">{</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$contains</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$arguments</span><span class="p">;</span>

        <span class="k">return</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$method</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="nv">$contains</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Module</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bindInterceptor</span><span class="p">(</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">any</span><span class="p">(),</span>       <span class="c1">// In any class,</span>
            <span class="k">new</span> <span class="nc">ContainsMatcher</span><span class="p">(</span><span class="s1">'user'</span><span class="p">),</span> <span class="c1">// When 'user' contained in method name</span>
            <span class="p">[</span><span class="nc">UserLogger</span><span class="o">::</span><span class="n">class</span><span class="p">]</span>          <span class="c1">// Bind UserLogger class</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

            </article>
        </div>
        <div id="ArticleToc" class="col-lg-2 d-none d-lg-block">
            <nav class="nav side-bar-right"></nav>
        </div>
    </div>
</main>
<footer>
    <div class="container d-md-flex">
        <i class="bear-icon d-none d-lg-block"></i>
        <small>
            © 2011-2024 BEAR.Sunday
        </small>
        <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex">
            <li>
                <a href="https://gitter.im/bearsunday/BEAR.Sunday?utm_source=badge&utm_medium=badge&utm_campaign=pr-badge">Gitter</a>
            </li>
            <li>
                <a href="https://github.com/bearsunday/BEAR.Sunday">Github</a>
            </li>
            <li>
                <a href="https://twitter.com/BEARSunday">Twitter</a>
            </li>
            <li>
                <a href="https://www.facebook.com/pages/BEARSunday/110116939178462?ref=hl">Facebook</a>
            </li>
            <li>
                <a href="http://koriym.github.io/">Blog (JA)</a>
            </li>
            <li>
                <a href="https://github.com/bearsunday/bearsunday.github.io">PR ?</a>
            </li>
        </ul>
    </div>
</footer>
<script src="//code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="//stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-6074569-8', 'bearsunday.github.io'); ga('send', 'pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

<script src="/js/generate-table-of-contents/index.min.js"></script>
<script>
    var toc = generateTableOfContents(document.getElementById('article'));
    var sideBarRight = $('.side-bar-right');
    sideBarRight.append(toc);

    var scrollOffset = $('body').attr('data-offset');
    var articlePaddingTop = $('article').css('padding-top').replace('px', '');
    sideBarRight.find('a').on('click', function (e) {
        e.preventDefault();
        var targetId = $(this).attr('href');
        var targetPositionTop = $(targetId).offset().top - scrollOffset - articlePaddingTop;
        window.scrollTo(0, targetPositionTop)
    });
</script>

</body>
</html>
