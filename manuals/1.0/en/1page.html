<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>1 Page Manual &#124; BEAR.Sunday</title>
    <meta name="description" content="BEAR.Sunday is a resource orientated framework with a REST centered architecture, implementing Dependency Injection and Aspect Orientated Programming' at its core.">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.css">
    <link rel="stylesheet" href="/css/syntax.css">
    
    <link rel="stylesheet" href="/css/bearsunday.css">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" href="/icon.png">
</head>
<body data-page-category="Manual" data-spy="scroll" data-target="#ArticleToc" data-offset="65">
<header>
    <nav class="navbar navbar-expand flex-column flex-md-row bg-light">
        <a class="navbar-brand mr-0 mr-md-2" href="/index.html"></a>
        <div class="navbar-nav-scroll">
            <ul class="navbar-nav flex-row">
                <li class="nav-item">
                    <a class="nav-link " href="/index.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/manuals/1.0/en/index.html">Manual</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link " href="/contributors.html">Contributors</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/slide.html">Slide</a>
                </li>
            </ul>
        </div>
        
        <ul class="navbar-nav ml-md-auto d-none d-md-flex language-list">
            <li>
                <a class="active" href="/manuals/1.0/en/1page.html">En</a>
            </li>
            <li>
                <a class="" href="/manuals/1.0/ja/1page.html">Ja</a>
            </li>
        </ul>
        
    </nav>
</header>

<main class="container-fluid">
    <div class="row flex-xl-nowrap">
        <div class="col-md-3 col-lg-2">
            <div class="side-bar">
                <nav class="navbar navbar-expand-md navbar-light">
    <div class="navigation-header">
        <div class="ml-auto d-sm-block d-md-none">
            <ul class="navbar-nav language-list">
                <li>
                    <a class="active" href="/manuals/1.0/en/1page.html">En</a>
                </li>
                <li>
                    <a class="" href="/manuals/1.0/ja/1page.html">Ja</a>
                </li>
            </ul>
            <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#Navber" aria-controls="Navber" aria-expanded="false" aria-label="ナビゲーションの切替">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </div>
    <div class="collapse navbar-collapse" id="Navber">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/en/">Introduction</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/version.html">Version</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/quick-start.html">Quick Start</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/tutorial.html">Tutorial</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/tutorial2.html">Tutorial 2</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/package.html">Package</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/application.html">Application</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/module.html">Module</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/di.html">DI</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/aop.html">AOP</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/resource.html">Resource</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/en/resource_param.html">・Parameter</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/en/resource_link.html">・Link</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/en/resource_renderer.html">・Rendering and Transfer</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/router.html">Router</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/production.html">Production</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/import.html">Import</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/database.html">Database</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/validation.html">Validation</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/html.html">HTML</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/form.html">Form</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/content-negotiation.html">Content Negotiation</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/hypermedia-api.html">Hypermedia API</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/psr7.html">Request / PSR-7</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/js-ui.html">JavaScript UI</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/stream.html">Stream Response</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/cache.html">Cache</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/swoole.html">Swoole</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/coding-guide.html">Coding Guide</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/en/types.html">Type</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/test.html">Test</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/en/examples.html">Examples</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/en/attribute.html">Attribute</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/en/apidoc.html">API Doc</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/1page.html">1 Page</a>
            </li>
        </ul>
    </div>
</nav>

            </div>
        </div>
        <div class="col-md-9 col-lg-8">
            <article id="article" class="markdown-body">
                <p>This is the page that collects all BEAR.Sunday manuals in one place.</p>

<p>##
Application Import</p>

<p>Resources created with BEAR.Sunday have unrivaled re-usability.
You can run multiple applications at the same time and use resources of other applications. You do not need to set up separate web servers.</p>

<p>Let’s try using a resource in another application.</p>

<p>Normally you would set up the new application as a package, For this tutorial let’s create a new <code class="language-plaintext highlighter-rouge">my-vendor</code> and manually add it to the auto loader. .</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>my-vendor
<span class="nb">cd </span>my-vendor
composer create-project bear/skeleton Acme.Blog
</code></pre></div></div>

<p>In the <code class="language-plaintext highlighter-rouge">composer.json</code> in the <code class="language-plaintext highlighter-rouge">autoload</code> section add <code class="language-plaintext highlighter-rouge">Acme\\Blog</code>.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"autoload"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"psr-4"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"MyVendor\\Weekday\\"</span><span class="p">:</span><span class="w"> </span><span class="s2">"src/"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Acme\\Blog\\"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-vendor/Acme.Blog/src/"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>

<p>Dump the <code class="language-plaintext highlighter-rouge">autoload</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer dump-autoload
</code></pre></div></div>

<p>With this the configuration for the <code class="language-plaintext highlighter-rouge">Acme\Blog</code> application is complete.</p>

<p>Next in order to import the application in <code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code> we use the <code class="language-plaintext highlighter-rouge">ImportAppModule</code> in <code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code> to install as an override.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Module\ImportAppModule</span><span class="p">;</span> <span class="c1">// add this line</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ImportApp</span><span class="p">;</span> <span class="c1">// add this line</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\Context</span><span class="p">;</span> <span class="c1">// add this line</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$importConfig</span> <span class="o">=</span> <span class="p">[</span>
            <span class="k">new</span> <span class="nc">ImportApp</span><span class="p">(</span><span class="s1">'blog'</span><span class="p">,</span> <span class="s1">'Acme\Blog'</span><span class="p">,</span> <span class="s1">'prod-hal-app'</span><span class="p">)</span> <span class="c1">// host, name, context</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">override</span><span class="p">(</span><span class="k">new</span> <span class="nc">ImportAppModule</span><span class="p">(</span><span class="nv">$importConfig</span> <span class="p">,</span> <span class="nc">Context</span><span class="o">::</span><span class="n">class</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>With this a <code class="language-plaintext highlighter-rouge">Acme\Blog</code> application using a <code class="language-plaintext highlighter-rouge">prod-hal-app</code> context can create resources that will be available to the <code class="language-plaintext highlighter-rouge">blog</code> host.</p>

<p>Let’s check it works by creating an Import resource in <code class="language-plaintext highlighter-rouge">src/Resource/App/Import.php</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Sunday\Inject\ResourceInject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Import</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">ResourceInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span><span class="p">[</span>
            <span class="s1">'blog'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'page://blog/index'</span><span class="p">)[</span><span class="s1">'greeting'</span><span class="p">]</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">page://blog/index</code> resource should now be assigned to <code class="language-plaintext highlighter-rouge">blog</code>. <code class="language-plaintext highlighter-rouge">@Embed</code> can be used in the same way.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php get /import
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
content-type: application/hal+json

<span class="o">{</span>
    <span class="s2">"blog"</span>: <span class="s2">"Hello BEAR.Sunday"</span>,
    <span class="s2">"_links"</span>: <span class="o">{</span>
        <span class="s2">"self"</span>: <span class="o">{</span>
            <span class="s2">"href"</span>: <span class="s2">"/import"</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Great, we could now use another application’s resource. We do not even need to use HTTP to fetch this data.</p>

<p>The combined application is now seen as 1 layer of a single application. A
<a href="http://en.wikipedia.org/wiki/Representational_state_transfer#Layered_system">Layered System</a> is another feature of REST.</p>

<p>Next lets look at how we use a resource in a system that is not BEAR.Sunday based. We create an app.php. You can place this anywhere but be careful that it picks up <code class="language-plaintext highlighter-rouge">autoload.php</code> path correctly.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Package\Bootstrap</span><span class="p">;</span>

<span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/autoload.php'</span><span class="p">;</span>

<span class="nv">$api</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nc">Bootstrap</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getApp</span><span class="p">(</span><span class="s1">'MyVendor\Weekday'</span><span class="p">,</span> <span class="s1">'prod-hal-app'</span><span class="p">);</span>

<span class="nv">$blog</span> <span class="o">=</span> <span class="nv">$api</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/import'</span><span class="p">)[</span><span class="s1">'blog'</span><span class="p">];</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$blog</span><span class="p">);</span>
</code></pre></div></div>

<p>Let’s try it..</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/import.php
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>string(17) "Hello BEAR.Sunday"
</code></pre></div></div>

<p>Other examples..</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$weekday</span> <span class="o">=</span> <span class="nv">$api</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/weekday'</span><span class="p">)([</span><span class="s1">'year'</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">'month'</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'day'</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">]);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$weekday</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">);</span> <span class="c1">// as array</span>
<span class="c1">//array(1) {</span>
<span class="c1">//    ["weekday"]=&gt;</span>
<span class="c1">//  string(3) "Sat"</span>
<span class="c1">//}</span>

<span class="k">echo</span> <span class="nv">$weekday</span><span class="p">;</span> <span class="c1">// as string</span>
<span class="c1">//{</span>
<span class="c1">//    "weekday": "Sat",</span>
<span class="c1">//    "_links": {</span>
<span class="c1">//    "self": {</span>
<span class="c1">//        "href": "/weekday/2000/1/1"</span>
<span class="c1">//        }</span>
<span class="c1">//    }</span>
<span class="c1">//}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$html</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nc">Bootstrap</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getApp</span><span class="p">(</span><span class="s1">'MyVendor\Weekday'</span><span class="p">,</span> <span class="s1">'prod-html-app'</span><span class="p">);</span>
<span class="nv">$index</span> <span class="o">=</span> <span class="nv">$html</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'page://self/index'</span><span class="p">)([</span><span class="s1">'year'</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">'month'</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'day'</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">]);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$index</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
<span class="c1">//int(200)</span>

<span class="k">echo</span> <span class="nv">$index</span><span class="p">;</span>
<span class="c1">//&lt;!DOCTYPE html&gt;</span>
<span class="c1">//&lt;html&gt;</span>
<span class="c1">//&lt;body&gt;</span>
<span class="c1">//The weekday of 2000/1/1 is Sat.</span>
<span class="c1">//&lt;/body&gt;</span>
<span class="c1">//&lt;/html&gt;</span>
</code></pre></div></div>

<p>Response is returned with a stateless request REST’s resource is like a PHP function. You can get the value in <code class="language-plaintext highlighter-rouge">body</code> or you can express it like JSON or HTML with <code class="language-plaintext highlighter-rouge">(string)</code>. You can operate on any resource of the application with two lines except autoload, one line script if you concatenate it.</p>

<p>In this way, resources created with BEAR.Sunday can be easily used from other CMS and framework. You can handle the values of multiple applications at once.</p>

<h1 id="aop">AOP</h1>

<p>BEAR.Sunday <strong>AOP</strong> enables you to write code that is executed each time a matching method is invoked. It’s suited for cross cutting concerns (“aspects”), such as transactions, security and logging. Because interceptors divide a problem into aspects rather than objects, their use is called Aspect Oriented Programming (AOP).</p>

<p>The method interceptor API implemented is a part of a public specification called <a href="http://aopalliance.sourceforge.net/">AOP Alliance</a>.</p>

<h2 id="interceptor">Interceptor</h2>

<p><a href="https://github.com/ray-di/Ray.Aop/blob/2.x/src/MethodInterceptor.php">MethodInterceptors</a> are executed whenever a matching method is invoked.
They have the opportunity to inspect the call: the method, its arguments, and the receiving instance.
They can perform their cross-cutting logic and then delegate to the underlying method.
Finally, they may inspect the return value or the exception and return. Since interceptors may be applied to many methods and will receive many calls, their implementation should be efficient and unintrusive.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Aop\MethodInterceptor</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Aop\MethodInvocation</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyInterceptor</span> <span class="kd">implements</span> <span class="nc">MethodInterceptor</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">invoke</span><span class="p">(</span><span class="kt">MethodInvocation</span> <span class="nv">$invocation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Process before method invocation</span>
        <span class="c1">// ...</span>

        <span class="c1">// Original method invocation</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="nf">proceed</span><span class="p">();</span>

        <span class="c1">// Process after method invocation</span>
        <span class="c1">// ...</span>

        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="bindings">Bindings</h2>

<p>“Find” the target class and method with <code class="language-plaintext highlighter-rouge">Matcher</code> and bind the interceptor to the matching method in <a href="module.html">Module</a>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bindInterceptor</span><span class="p">(</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">any</span><span class="p">(),</span>                   <span class="c1">// In any class,</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">startsWith</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">),</span>    <span class="c1">// Method(s) names that start with "delete",</span>
    <span class="p">[</span><span class="nc">Logger</span><span class="o">::</span><span class="n">class</span><span class="p">]</span>                          <span class="c1">// Bind a Logger interceptor</span>
<span class="p">);</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bindInterceptor</span><span class="p">(</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">subclassesOf</span><span class="p">(</span><span class="nc">AdminPage</span><span class="o">::</span><span class="n">class</span><span class="p">),</span>  <span class="c1">// Of the AdminPage class or a class inherited from it</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">Auth</span><span class="o">::</span><span class="n">class</span><span class="p">),</span>      <span class="c1">// Annotated method with the @Auth annotation</span>
    <span class="p">[</span><span class="nc">AdminAuthentication</span><span class="o">::</span><span class="n">class</span><span class="p">]</span>                     <span class="c1">//Bind the AdminAuthenticationInterceptor</span>
<span class="p">);</span>
</code></pre></div></div>

<p>There are various matchers.</p>

<ul>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L16">Matcher::any</a></li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L23">Matcher::annotatedWith</a></li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L30">Matcher::subclassesOf</a></li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L37">Matcher::startsWith</a></li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L44">Matcher::logicalOr</a></li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L51">Matcher::logicalAnd</a></li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L58">Matcher::logicalNot</a>
```</li>
</ul>

<p>With the <code class="language-plaintext highlighter-rouge">MethodInvocation</code> object, you can access the target method’s invocation object, method’s and parameters.</p>

<ul>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/Joinpoint.php#L39">MethodInvocation::proceed</a> - Invoke method</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MethodInvocation.php">MethodInvocation::getMethod</a> -  Get method reflection</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/Joinpoint.php#L48">MethodInvocation::getThis</a> - Get object</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/Invocation.php">MethodInvocation::getArguments</a> - Pet parameters</li>
</ul>

<p>Annotations can be obtained using the reflection API.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$method</span> <span class="o">=</span> <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="nf">getMethod</span><span class="p">();</span>
<span class="nv">$class</span> <span class="o">=</span> <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="nf">getMethod</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getDeclaringClass</span><span class="p">();</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">$method-&gt;getAnnotations()</code>    // get method annotations</li>
  <li><code class="language-plaintext highlighter-rouge">$method-&gt;getAnnotation($name)</code></li>
  <li><code class="language-plaintext highlighter-rouge">$class-&gt;getAnnotations()</code>     // get class annotations</li>
  <li><code class="language-plaintext highlighter-rouge">$class-&gt;getAnnotation($name)</code></li>
</ul>

<h2 id="own-matcher">Own matcher</h2>

<p>You can have your own matcher.
To create <code class="language-plaintext highlighter-rouge">contains</code> matcher, You need to provide a class which has two methods. One is <code class="language-plaintext highlighter-rouge">matchesClass</code> for a class match.
The other one is <code class="language-plaintext highlighter-rouge">matchesMethod</code> method match. Both return the boolean result of match.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Aop\AbstractMatcher</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ContainsMatcher</span> <span class="kd">extends</span> <span class="nc">AbstractMatcher</span>
<span class="p">{</span>
    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">matchesClass</span><span class="p">(</span><span class="err">\</span><span class="nc">ReflectionClass</span> <span class="nv">$class</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$arguments</span><span class="p">)</span> <span class="o">:</span> <span class="n">bool</span>
    <span class="p">{</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$contains</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$arguments</span><span class="p">;</span>

        <span class="k">return</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$class</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="nv">$contains</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">matchesMethod</span><span class="p">(</span><span class="err">\</span><span class="nc">ReflectionMethod</span> <span class="nv">$method</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$arguments</span><span class="p">)</span> <span class="o">:</span> <span class="n">bool</span>
    <span class="p">{</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$contains</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$arguments</span><span class="p">;</span>

        <span class="k">return</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$method</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="nv">$contains</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Module</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bindInterceptor</span><span class="p">(</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">any</span><span class="p">(),</span>       <span class="c1">// In any class,</span>
            <span class="k">new</span> <span class="nc">ContainsMatcher</span><span class="p">(</span><span class="s1">'user'</span><span class="p">),</span> <span class="c1">// When 'user' contained in method name</span>
            <span class="p">[</span><span class="nc">UserLogger</span><span class="o">::</span><span class="n">class</span><span class="p">]</span>          <span class="c1">// Bind UserLogger class</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h1 id="api-doc">API Doc</h1>

<p>ApiDoc generates API documentation from your application.</p>

<p>The auto-generated documentation from your code and JSON schema will reduce your effort and keep your API documentation accurate.</p>

<h2 id="usage">Usage</h2>

<p>Install BEAR.ApiDoc.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require bear/api-doc --dev
</code></pre></div></div>

<p>Copy the configuration file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp ./vendor/bear/api-doc/apidoc.xml.dist ./apidoc.xml
</code></pre></div></div>

<h2 id="source">Source</h2>

<p>ApiDoc generates documentation by retrieving information from phpdoc, method signatures, and JSON schema.</p>

<h4 id="phpdoc">PHPDOC</h4>

<p>In phpdoc, the following parts are retrieved.
For information that applies across resources, such as authentication, prepare a separate documentation page and link it with <code class="language-plaintext highlighter-rouge">@link</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * {title}
 *
 * {description}
 *
 * {@link htttp;//example.com/docs/auth 認証}
 */</span>
 <span class="kd">class</span> <span class="nc">Foo</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
 <span class="p">{</span>
 <span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * {title}
 *
 * {description}
 *
 * @param string $id ユーザーID
 */</span>
 <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span> <span class="o">=</span><span class="s1">'kuma'</span><span class="p">):</span> <span class="kt">static</span>
 <span class="p">{</span>
 <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>If there is no <code class="language-plaintext highlighter-rouge">@param</code> description in the phpdoc of the method, get the information of the argument from the method signature.</li>
  <li>The order of priority for information acquisition is phpdoc, JSON schema, and profile.</li>
</ul>

<h2 id="configuration">Configuration</h2>

<p>The configuration is written in XML.
The minimum specification is as follows.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;apidoc</span>
        <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
        <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"https://bearsunday.github.io/BEAR.ApiDoc/apidoc.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;appName&gt;</span>MyVendor\MyProject<span class="nt">&lt;/appName&gt;</span>
    <span class="nt">&lt;scheme&gt;</span>app<span class="nt">&lt;/scheme&gt;</span>
    <span class="nt">&lt;docDir&gt;</span>docs<span class="nt">&lt;/docDir&gt;</span>
    <span class="nt">&lt;format&gt;</span>html<span class="nt">&lt;/format&gt;</span>
<span class="nt">&lt;/apidoc&gt;</span>
</code></pre></div></div>

<h3 id="required-attributes">Required Attributes</h3>

<h4 id="appname">appName</h4>

<p>Application namespaces</p>

<h4 id="scheme">scheme</h4>

<p>The name of the schema to use for API documentation. <code class="language-plaintext highlighter-rouge">page</code> or <code class="language-plaintext highlighter-rouge">app</code>.</p>

<h4 id="docdir">docDir</h4>

<p>Output directory name.</p>

<h4 id="format">format</h4>

<p>The output format, HTML or MD (Mark down).</p>

<h3 id="optional-attributes">Optional attributes</h3>

<h4 id="title">title</h4>

<p>API title</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;title&gt;</span>MyBlog API<span class="nt">&lt;/title&gt;</span>
</code></pre></div></div>

<h4 id="description">description</h4>

<p>API description</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;description&gt;</span>MyBlog API description<span class="err">&lt;</span>/description
</code></pre></div></div>

<h4 id="links">links</h4>

<p>Links. The <code class="language-plaintext highlighter-rouge">href</code> is the URL of the link, and the <code class="language-plaintext highlighter-rouge">rel</code> is its content.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;links&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"https://www.example.com/issue"</span> <span class="na">rel=</span><span class="s">"issue"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"https://www.example.com/help"</span> <span class="na">rel=</span><span class="s">"help"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/links&gt;</span>
</code></pre></div></div>

<h4 id="alps">alps</h4>

<p>Specifies an “ALPS profile” that defines the terms used by the API.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;alps&gt;</span>alps/profile.json<span class="nt">&lt;/alps&gt;</span>.
</code></pre></div></div>

<h2 id="profile">Profile</h2>

<p>ApiDoc supports the <a href="http://alps.io/">ALPS</a> format of the <a href="https://tools.ietf.org/html/rfc6906">RFC 6906 Profile</a> which gives additional information to the application.</p>

<p>Words used in API request and response keys are called semantic descriptors, and if you create a dictionary of profiles, you don’t need to describe the words for each request.
Centralized definitions of words and phrases prevent notational errors and aid in shared understanding.</p>

<p>The words used in API request and response keys are called semantic descriptors, and creating a dictionary of profiles eliminates the need to explain the words for each request.
Centralized definitions of words and phrases prevent shaky notation and aid in shared understanding.</p>

<p>The following is an example of defining descriptors <code class="language-plaintext highlighter-rouge">firstName</code> and <code class="language-plaintext highlighter-rouge">familyName</code> with <code class="language-plaintext highlighter-rouge">title</code> and <code class="language-plaintext highlighter-rouge">def</code> respectively.
While <code class="language-plaintext highlighter-rouge">title</code> describes a word and clarifies its meaning, <code class="language-plaintext highlighter-rouge">def</code> links standard words defined in vocabulary sites such as <a href="https://schema.org/">Schema.org</a>.</p>

<p>ALPS profiles can be written in XML or JSON.</p>

<p>profile.xml</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;alps</span>
     <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
     <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"https://alps-io.github.io/schemas/alps.xsd"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- Ontology --&gt;</span>
    <span class="nt">&lt;descriptor</span> <span class="na">id=</span><span class="s">"firstName"</span> <span class="na">title=</span><span class="s">"The person's first name."</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;descriptor</span> <span class="na">id=</span><span class="s">"familyName"</span> <span class="na">def=</span><span class="s">"https://schema.org/familyName"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/alps&gt;</span>
</code></pre></div></div>

<p>profile.json</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://alps-io.github.io/schemas/alps.json"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"alps"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"descriptor"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"firstName"</span><span class="p">,</span><span class="w"> </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The person's first name."</span><span class="p">}</span><span class="w">
      </span><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"familyName"</span><span class="p">,</span><span class="w"> </span><span class="nl">"def"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://schema.org/familyName"</span><span class="p">},</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Descriptions of words appearing in ApiDoc take precedence over phpdoc &gt; JsonSchema &gt; ALPS in that order.</p>

<h2 id="reference">Reference</h2>

<ul>
  <li><a href="https://bearsunday.github.io/BEAR.ApiDoc/">Demo</a></li>
  <li><a href="http://alps.io/">ALPS</a></li>
  <li><a href="https://github.com/koriym/app-state-diagram">ALPS-ASD</a></li>
</ul>

<h1 id="application"><a name="app"></a>Application</h1>

<h2 id="sequence">Sequence</h2>

<p>A BEAR.Sunday app has a run order of <code class="language-plaintext highlighter-rouge">compile</code>, <code class="language-plaintext highlighter-rouge">request</code> and <code class="language-plaintext highlighter-rouge">response</code>.</p>

<h3 id="0-compile">0. Compile</h3>

<p>An <code class="language-plaintext highlighter-rouge">$app</code> application object is created through <code class="language-plaintext highlighter-rouge">DI</code> and <code class="language-plaintext highlighter-rouge">AOP</code> configuration depending on a specified context.
An <code class="language-plaintext highlighter-rouge">$app</code> is made up of service objects as it’s properties that are needed to run the application such as a <code class="language-plaintext highlighter-rouge">router</code> or <code class="language-plaintext highlighter-rouge">transfer</code> etc.
<code class="language-plaintext highlighter-rouge">$app</code> then connects these object together depending on whether it is owned by another or contains other objects.
This is called an <a href="http://en.wikipedia.org/wiki/Object_graph">Object Graph</a>.
<code class="language-plaintext highlighter-rouge">$app</code> is then serialized and reused in each request and response.</p>

<ul>
  <li>router - Converting external input to resource requests</li>
  <li>resource - Resource client</li>
  <li>transfer - Output</li>
</ul>

<h3 id="1-request">1. Request</h3>

<p>An application resource request and resource object is created based on the HTTP request.</p>

<p>A resource object which has methods that respond to <code class="language-plaintext highlighter-rouge">onGet</code>, <code class="language-plaintext highlighter-rouge">onPost</code> etc upon request sets the <code class="language-plaintext highlighter-rouge">code</code> or <code class="language-plaintext highlighter-rouge">body</code> property of it’s own resource state.</p>

<p>The resource object can then <code class="language-plaintext highlighter-rouge">#[Embed]</code> or <code class="language-plaintext highlighter-rouge">#[Link]</code> other resource objects.</p>

<p>Methods on the resource object are only for changing the resources state and have no interest in the representation itself (HTML, JSON etc).</p>

<p>Before and after the method, application logic bound to the method, such as logging and authentication, is executed in AOP.</p>

<h3 id="2-response">2. Response</h3>

<p>A <code class="language-plaintext highlighter-rouge">Renderer</code> is injected into the resource object, then the state of resource is represented as HTML, JSON etc or however it has been configured, it is then transfered to the client.</p>

<p><img src="/images/screen/diagram.png" style="max-width: 100%;height: auto;" /></p>

<h2 id="boot-file">Boot File</h2>

<p>To run an application, we need just two lines of code.
An entry point for a web server or console application access is usually set to <code class="language-plaintext highlighter-rouge">public/index.php</code> or <code class="language-plaintext highlighter-rouge">bin/app.php</code>.
As you can see below, we need to pass an application context to <code class="language-plaintext highlighter-rouge">bootstrap.php</code> the application script.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/autoload.php'</span><span class="p">;</span>
<span class="k">exit</span><span class="p">((</span><span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/bootstrap.php'</span><span class="p">)(</span><span class="s1">'prod-html-app'</span><span class="p">));</span>
</code></pre></div></div>

<p>Depending on your context choose a boot file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// fire php server
php <span class="nt">-S</span> 127.0.0.1:8080 public/index.php
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// console access
php bin/app.php get /user/1
</code></pre></div></div>

<h2 id="context">Context</h2>

<p>The composition of the application object <code class="language-plaintext highlighter-rouge">$app</code> changes in response to the defined context, so that application behavior changes.</p>

<p>Depending on the defined context the building of the application object <code class="language-plaintext highlighter-rouge">$app</code> changes, altering the overall behavior.</p>

<p>For example, <code class="language-plaintext highlighter-rouge">WebRouter</code> is bound to <code class="language-plaintext highlighter-rouge">RouterInterface</code> by default.
However, if <code class="language-plaintext highlighter-rouge">Cli</code> mode is set (instead of HTTP) the <code class="language-plaintext highlighter-rouge">CliRouter</code> is bound to the <code class="language-plaintext highlighter-rouge">RouterInterface</code> and it will then take console input.</p>

<p>There are built-in and custom contexts that can be used in an application.</p>

<h3 id="built-in-contexts">Built-in Contexts</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">api</code>  API Application</li>
  <li><code class="language-plaintext highlighter-rouge">cli</code>  Console Application</li>
  <li><code class="language-plaintext highlighter-rouge">hal</code>  HAL Application</li>
  <li><code class="language-plaintext highlighter-rouge">prod</code> Production</li>
</ul>

<p>For <code class="language-plaintext highlighter-rouge">app</code>, resources are rendered in JSON.
<code class="language-plaintext highlighter-rouge">api</code> changes the default resource schema from page to app; web root access (GET /) is from page://self/ to app://self/.
Set <code class="language-plaintext highlighter-rouge">cli</code> to be a console application.
prod` makes it a production application with cache settings, etc.</p>

<p>You can also use a combination of these built-in contexts and add your own custom contexts.
If you set the context to <code class="language-plaintext highlighter-rouge">prod-hal-api-app</code> your application will run as an API application in production mode using the <a href="http://stateless.co/hal_specification.html">HAL</a> media type.</p>

<h3 id="custom-context">Custom Context</h3>

<p>Place it in <code class="language-plaintext highlighter-rouge">src/Module</code>/ of the application; if it has the same name as the builtin context, the custom context will take precedence. You can override some of the constraints by calling the built-in context from the custom context.</p>

<p>Each application context (cli, app etc) represents a module.
For example the <code class="language-plaintext highlighter-rouge">cli</code> context relates to a <code class="language-plaintext highlighter-rouge">CliModule</code>, then binds all of the DI and AOP bindings that is needed for a console application.</p>

<h3 id="context-agnostic">Context Agnostic</h3>

<p>The context value is used only to create the root object and then disappears. There is no global “mode” that can be referenced by the application, and the application can not know what context it is currently running in. The behavior should only change through <strong>code that is dependent on an interface</strong><sup id="fnref:dip" role="doc-noteref"><a href="#fn:dip" class="footnote" rel="footnote">1</a></sup> and changes of dependencies by context.</p>

<hr />

<h1 id="attributes">Attributes</h1>

<p>BEAR.Sunday supports PHP8’s <a href="https://www.php.net/manual/en/language.attributes.overview.php">attributes</a> in addition to the annotations.</p>

<p><strong>Annotation</strong></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @Inject
 * @Named('admin')
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">setLogger</span><span class="p">(</span><span class="kt">LoggerInterface</span> <span class="nv">$logger</span><span class="p">)</span>
</code></pre></div></div>
<p><strong>Attribute</strong></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[Inject, Named('admin')]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">setLogger</span><span class="p">(</span><span class="kt">LoggerInterface</span> <span class="nv">$logger</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[Embed(rel: 'weather', src: 'app://self/weather{?date}')]</span>
<span class="c1">#[Link(rel: 'event', href: 'app://self/event{?news_date}')]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$date</span><span class="p">):</span> <span class="kt">self</span>
</code></pre></div></div>

<h2 id="apply-to-parameters">Apply to parameters</h2>

<p>While some annotations can only be applied to methods and require the argument names to be specified by name, the
Attributes can be used to decorate arguments directly.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="kt">__construct</span><span class="p">(</span><span class="c1">#[Named('payment')] LoggerInterface $paymentLogger, #[Named('debug')] LoggerInterface $debugLogger)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="c1">#[Assisted] DbInterface $db = null)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="c1">#[CookieParam('id')]string $tokenId): void</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="c1">#[ResourceParam(uri: 'app://self/login#nickname')] string $nickname = null): static</span>
</code></pre></div></div>
<h2 id="compatibility">Compatibility</h2>

<p>Attributes and annotations can be mixed in a single project. <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">2</a></sup>
All annotations described in this manual will work when converted to attributes.</p>

<h2 id="performance">Performance</h2>

<p>Although the cost of loading annotations/attributes for production is minimal due to optimization, you can speed up development by declaring that you will only use attribute readers, as follows</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// tests/bootstap.php </span>

<span class="kn">use</span> <span class="nc">Ray\ServiceLocator\ServiceLocator</span><span class="p">;</span>

<span class="nc">ServiceLocator</span><span class="o">::</span><span class="nf">setReader</span><span class="p">(</span><span class="k">new</span> <span class="nc">AttributeReader</span><span class="p">());</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// DevModule</span>
 
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AttributeModule</span><span class="p">());</span>
</code></pre></div></div>

<hr />

<h1 id="cache">Cache</h1>

<blockquote>
  <p>There are only two hard things in Computer Science: cache invalidation and naming things.</p>

  <p>– Phil Karlton</p>
</blockquote>

<h2 id="overview">Overview</h2>

<p>A good caching system improves the intrinsic quality of the user experience and reduces the cost of resource usage and environmental impact.
Sunday supports the following caching features in addition to the traditional simple TTL-based caching</p>

<ul>
  <li>Event-driven cache invalidation</li>
  <li>Cache dependency resolution</li>
  <li>Donut cache and donut hole cache</li>
  <li>CDN control</li>
  <li>Conditional requests.</li>
</ul>

<h3 id="distributed-cache-framework">Distributed Cache Framework</h3>

<p>A distributed caching system that obeys REST constraints saves not only computational resources but also network resources.</p>

<p>PHP directly handles <strong>server-side caches</strong> such as Redis and APC, <strong>shared caches</strong> known as content delivery networks (CDNs), <strong>client-side caches</strong> cached by web browsers and API clients, BEAR.Sunday provides a caching framework that integrates these caches with modern CDNs.</p>

<p><img src="https://user-images.githubusercontent.com/529021/137062427-c733c832-0631-4a43-a6ee-4204e6be007c.png" alt="distributed cache " /></p>

<h2 id="tag-based-cache-invalidation">Tag-based cache invalidation</h2>

<p><img width="369" alt="dependency graph 2021-10-19 21 38 02" src="https://user-images.githubusercontent.com/529021/137910748-b6e95839-eeb7-4ade-a564-3cdcd5fdc09e.png" /></p>

<p>There is a dependency problem in the content cache. If content A depends on content B, and B depends on C, then when C is updated, not only C’s cache and ETag must be updated, but also B’s cache and ETag which depend on C, and A’s cache and ETag which depend on B.</p>

<p>Sunday solves this problem by having each resource hold the URI of the dependent resource as a tag. When a resource embedded with <code class="language-plaintext highlighter-rouge">#[Embed]</code> is modified, the cache and ETag of all the resources involved will be invalidated and the cache will be regenerated for the next request.</p>

<h2 id="donut-cache">Donut cache</h2>

<p><img width="200" alt="donut caching" src="https://user-images.githubusercontent.com/529021/137097856-f9428918-5b76-4c0e-8cea-2472c15d82e9.png" /></p>

<p>Donut caching is one of the partial caching techniques for cache optimization. It composes the content into cacheable and non-cacheable parts.</p>

<p>For example, consider the content “<code class="language-plaintext highlighter-rouge">Welcome to $name</code>”, which contains a non-cacheable resource. The do-not-cache part will be combined with the other cacheable parts and output.</p>

<p><img width="557" alt="image" src="https://user-images.githubusercontent.com/529021/139617102-1f7f436c-a1f4-4c6c-b90b-de24491e4c8c.png " /></p>

<p>In this case, the entire content is dynamic, so the entire donut will not be cached. Therefore, no ETag will be output either.</p>

<h2 id="donut-hole-cache">Donut hole cache</h2>

<p><img width="544" alt="image" src="https://user-images.githubusercontent.com/529021/139617571-31aea99a-533f-4b95-b3f3-6c613407d377.png " /></p>

<p>When the hole part of the doughnut is cacheable, it can be treated in the same way as the doughnut cache.</p>

<p>In the example above, the resource for the weather forecast, which changes once an hour, is cached and included in the news resource. In this case, since the content of the donut as a whole (news) is static, the whole thing is also cached and given an ETag.</p>

<p>This is where the cache dependency comes in. When the content of the hole part of the donut is updated, the entire cached donut needs to be regenerated.</p>

<p>The nice thing is that this dependency resolution is done automatically. The computation of the donut part is then reused to minimize the computational resources. When the hole part (weather resource) is updated, the cache and ETag of the entire content is also automatically updated.
Translated with www.DeepL.com/Translator (free version)</p>

<h3 id="recursive-donut">recursive donut</h3>

<p><img width="191" alt="recursive donut 2021-10-19 21 27 06" src="https://user-images.githubusercontent.com/529021/137909083-2c5176f7-edb7-422b-bccc-1db90460fc15.png" /></p>

<p>The donut structure will be recursively applied.
For example, if A contains B and B contains C and C is modified, A’s cache and B’s cache will be reused except for the modified C. A’s and B’s caches and ETags will be regenerated, but DB access to retrieve A’s and B’s content and rendering of views will not be done.
For example, if A contains B and B contains C, and C is changed, A’s cache and B’s cache will be reused except for the part of C that is changed. The new partially-composed A and B caches and ETags will be regenerated.</p>

<p>The optimized structure of the partial cache performs content regeneration with minimal cost. The client does not need to know about the content cache structure.</p>

<h2 id="event-driven-content">Event-driven content</h2>

<p>Traditionally, CDNs have believed that content that requires application logic is “dynamic” and therefore cannot be cached by a CDN. However, some CDNs, such as Fastly and Akamai, allow immediate or tag-based cache invalidation within seconds, <a href="https://www.fastly.com/blog/leveraging-your-cdn-cache- uncacheable-content">this idea is a thing of the past</a>.</p>

<p>Sunday dependency resolution is done not only on the server side, but also on the shared cache; when AOP detects a change and makes a PURGE request to the shared cache, the related cache on the shared cache will be invalidated, just like on the server side.</p>

<h2 id="conditional-request">Conditional request</h2>

<p><img width="468" alt="conditional request" src="https://user-images.githubusercontent.com/529021/137151061-8d7a5605-3aa3-494c-91c5-c1 deddd987dd.png" /></p>

<p>Content changes are managed by AOP, and the entity tag (ETag) of the content is automatically updated. conditional requests for HTTP using ETag not only minimize the use of computational resources, but responses that only return <code class="language-plaintext highlighter-rouge">304 Not Modified</code> also minimize the use of network resources. Conditional HTTP requests using ETag not only minimize the use of computational resources, but also minimize the use of network resources by simply returning <code class="language-plaintext highlighter-rouge">304 Not Modified</code>.</p>

<h1 id="usage-1">Usage</h1>

<p>Give the class to be cached the attribute <code class="language-plaintext highlighter-rouge">#[DonutCache]</code> if it is a donut cache (embedded content is not cacheable) and <code class="language-plaintext highlighter-rouge">#[CacheableResponse]</code> otherwise.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\CacheableResponse</span><span class="p">;</span>

<span class="c1">#[CacheableResponse]</span>
<span class="kd">class</span> <span class="nc">BlogPosting</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$headers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">RequestHeader</span><span class="o">::</span><span class="no">CACHE_CONTROL</span> <span class="o">=&gt;</span> <span class="nc">CacheControl</span><span class="o">::</span><span class="no">NO_CACHE</span>
    <span class="p">];</span>

    <span class="c1">#[Embed(rel: "comment", src: "page://self/html/comment")]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'article'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'hello world'</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onDelete</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="recursive-donut-1">recursive donut</h3>

<p><img width="191" alt="recursive donut 2021-10-19 21 27 06" src="https://user-images.githubusercontent.com/529021/137909083-2c5176f7-edb7- 422b-bccc-1db90460fc15.png" /></p>

<p>The donut structure will be recursively applied.
For example, if A contains B and B contains C and C is modified, A’s cache and B’s cache will be reused except for the modified C. A’s and B’s caches and ETags will be regenerated, but DB access to retrieve A’s and B’s content and rendering of views will not be done.
For example, if A contains B and B contains C, and C is changed, A’s cache and B’s cache will be reused except for the part of C that is changed. The new partially-composed A and B caches and ETags will be regenerated.</p>

<p>The optimized structure of the partial cache performs content regeneration with minimal cost. The client does not need to know about the content cache structure.</p>

<h2 id="event-driven-content-1">Event-driven content</h2>

<p>Traditionally, CDNs have believed that content that requires application logic is “dynamic” and therefore cannot be cached by a CDN. However, some CDNs, such as Fastly and Akamai, allow immediate or tag-based cache invalidation within seconds, <a href="https://www.fastly.com/blog/leveraging-your-cdn-cache- uncacheable-content">this idea is a thing of the past</a>.</p>

<p>Sunday dependency resolution is done not only on the server side, but also on the shared cache; when AOP detects a change and makes a PURGE request to the shared cache, the related cache on the shared cache will be invalidated, just like on the server side.</p>

<h2 id="conditional-request-1">Conditional request</h2>

<p><img width="468" alt="conditional request" src="https://user-images.githubusercontent.com/529021/137151061-8d7a5605-3aa3-494c-91c5-c1 deddd987dd.png" /></p>

<p>Content changes are managed by AOP, and the entity tag (ETag) of the content is automatically updated. conditional requests for HTTP using ETag not only minimize the use of computational resources, but responses that only return <code class="language-plaintext highlighter-rouge">304 Not Modified</code> also minimize the use of network resources. Conditional HTTP requests using ETag not only minimize the use of computational resources, but also minimize the use of network resources by simply returning <code class="language-plaintext highlighter-rouge">304 Not Modified</code>.</p>

<h1 id="usage-2">Usage</h1>

<p>Give the class to be cached the attribute <code class="language-plaintext highlighter-rouge">#[DonutCache]</code> if it is a donut cache (embedded content is not cacheable) and <code class="language-plaintext highlighter-rouge">#[CacheableResponse]</code> otherwise.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[CacheableResponse]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPut</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$todo</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="c1">#[RefreshCache]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onDelete</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
    <span class="p">}</span>	
<span class="p">}</span>
</code></pre></div></div>

<p>If you give attributes in either way, all the features introduced in the overview will apply.
Caching is not disabled by time (TTL) by default, assuming event-driven content</p>

<p>Note that with <code class="language-plaintext highlighter-rouge">#[DonutCache]</code> the whole content will not be cached, but with <code class="language-plaintext highlighter-rouge">#[CacheableResponse]</code> it will be.</p>

<h2 id="ttl">TTL</h2>

<p>TTL is specified with <code class="language-plaintext highlighter-rouge">DonutRepositoryInterface::put()</code>.
<code class="language-plaintext highlighter-rouge">ttl</code> is the cache time for non-donut holes, <code class="language-plaintext highlighter-rouge">sMaxAge</code> is the cache time for CDNs.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\CacheableResponse</span><span class="p">;</span>

<span class="c1">#[CacheableResponse]</span>
<span class="kd">class</span> <span class="nc">BlogPosting</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">private</span> <span class="nc">DonutRepositoryInterface</span> <span class="nv">$repository</span><span class="p">)</span>
    <span class="p">{}</span>

    <span class="c1">#[Embed(rel: "comment", src: "page://self/html/comment")]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="c1">// process ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">repository</span><span class="o">-&gt;</span><span class="nf">put</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="n">ttl</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span> <span class="n">sMaxAge</span><span class="o">:</span><span class="mi">100</span><span class="p">);</span><span class="err">　</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="default-ttl-value">Default TTL value</h3>

<p>For event-driven content, changes to the content must be reflected immediately in the cache, so the default TTL varies depending on the CDN module installed. Therefore, the default TTL will vary depending on the CDN module installed: indefinitely (1 year) if the CDN supports tag-based disabling of caching, or 10 seconds if it does not.</p>

<p>The expected cache reflection time is immediate for Fastly, a few seconds for Akamai, and 10 seconds for others.</p>

<p>To customize it, bind it by implementing <code class="language-plaintext highlighter-rouge">CdnCacheControlHeaderSetterInterface</code> with reference to <code class="language-plaintext highlighter-rouge">CdnCacheControlHeader</code>.</p>

<h2 id="cache-invalidation">Cache invalidation</h2>

<p>Use the methods of <code class="language-plaintext highlighter-rouge">DonutRepositoryInterface</code> to manually invalidate the cache.
This will invalidate not only the specified cache, but also the cache of the ETag, any other resources it depends on, and the cache of the ETag on the server side and, if possible, on the CDN.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">DonutRepositoryInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">purge</span><span class="p">(</span><span class="kt">AbstractUri</span> <span class="nv">$uri</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">invalidateTags</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$tags</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="invalidate-by-uri">Invalidate by URI</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// example</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">repository</span><span class="o">-&gt;</span><span class="nf">purge</span><span class="p">(</span><span class="k">new</span> <span class="nc">Uri</span><span class="p">(</span><span class="s1">'app://self/blog/comment'</span><span class="p">));</span>
</code></pre></div></div>

<h3 id="disable-by-tag">Disable by tag</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">repository</span><span class="o">-&gt;</span><span class="nf">invalidateTags</span><span class="p">([</span><span class="s1">'template_a'</span><span class="p">,</span> <span class="s1">'campaign_b'</span><span class="p">]);</span>
</code></pre></div></div>
<h3 id="tag-invalidation-in-cdn">Tag Invalidation in CDN</h3>

<p>In order to enable tag-based cache invalidation in CDN, you need to implement and bind <code class="language-plaintext highlighter-rouge">PurgerInterface</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\QueryRepository\PurgerInterface</span><span class="p">;</span>

<span class="kd">interface</span> <span class="nc">PurgerInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$tag</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="specify-dependent-tags">Specify dependent tags.</h3>

<p>Use the <code class="language-plaintext highlighter-rouge">SURROGATE_KEY</code> header to specify the key for PURGE. Use a space as a separator for multiple strings.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\QueryRepository\Header</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Foo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$headers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">Header</span><span class="o">::</span><span class="no">SURROGATE_KEY</span> <span class="o">=&gt;</span> <span class="s1">'template_a campaign_b'</span>
    <span class="p">];</span>
</code></pre></div></div>

<p>If the cache is invalidated by <code class="language-plaintext highlighter-rouge">template_a</code> or <code class="language-plaintext highlighter-rouge">campaign_b</code> tags, Foo’s cache and Foo’s ETag will be invalidated both server-side and CDN.</p>

<h3 id="resource-dependencies">Resource Dependencies.</h3>

<p>Use <code class="language-plaintext highlighter-rouge">UriTagInterface</code> to convert a URI into a dependency tag string.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">private</span> <span class="nc">UriTagInterface</span> <span class="nv">$uriTag</span><span class="p">)</span>
<span class="p">{}</span>
</code></pre></div></div>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="nc">Header</span><span class="o">::</span><span class="no">SURROGATE_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">uriTag</span><span class="p">)(</span><span class="k">new</span> <span class="nc">Uri</span><span class="p">(</span><span class="s1">'app://self/foo'</span><span class="p">));</span>
</code></pre></div></div>

<p>This cache will be invalidated both server-side and CDN when <code class="language-plaintext highlighter-rouge">app://self/foo</code> is modified.</p>

<h3 id="make-associative-array-a-resource-dependency">Make associative array a resource dependency.</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// bodyの内容</span>
<span class="p">[</span>
    <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'a'</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'b'</span><span class="p">],</span>
<span class="p">]</span>
</code></pre></div></div>
<p>If you want to generate a list of dependent URI tags from a <code class="language-plaintext highlighter-rouge">body</code> associative array like the above, you can specify the URI template with the <code class="language-plaintext highlighter-rouge">fromAssoc()</code> method.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="nc">Header</span><span class="o">::</span><span class="no">SURROGATE_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">uriTag</span><span class="o">-&gt;</span><span class="nf">fromAssoc</span><span class="p">(</span>
    <span class="n">uriTemplate</span><span class="o">:</span> <span class="s1">'app://self/item{?id}'</span><span class="p">,</span>
    <span class="n">assoc</span><span class="o">:</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span>
<span class="p">);</span>
</code></pre></div></div>

<p>In the above case, this cache will be invalidated for both server-side and CDN when <code class="language-plaintext highlighter-rouge">app://self/item?id=1</code> and <code class="language-plaintext highlighter-rouge">app://self/item?id=2</code> are changed.</p>

<h2 id="cdn">CDN</h2>

<p>If you install a module that supports a specific CDN, vendor-specific headers will be output.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">FastlyModule</span><span class="p">())</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AkamaiModule</span><span class="p">())</span>
</code></pre></div></div>

<h2 id="multi-cdn">Multi-CDN</h2>

<p>You can also configure a multi-tier CDN and set the TTL according to the role. For example, in this diagram, a multi-functional CDN is placed upstream, and a conventional CDN is placed downstream. Content invalidation is done for the upstream CDN, and the downstream CDN uses it.</p>

<p><img width="344" alt="multi cdn diagram" src="https://user-images.githubusercontent.com/529021/137098809-ec949a15-8efb-4d03-9808-3be15523ade7.png" /></p>

<h1 id="response-headers">Response headers</h1>

<p>Sunday will automatically do the cache control for the CDN and output the header for the CDN. Client cache control is described in <code class="language-plaintext highlighter-rouge">$header</code> of ResourceObject depending on the content.</p>

<p>This section is important for security and maintenance purposes.
Make sure to specify the <code class="language-plaintext highlighter-rouge">Cache-Control</code> in all ResourceObjects.</p>

<h3 id="cannot-cache">Cannot cache</h3>

<p>Always specify content that cannot be cached.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">CACHE_CONTROL</span> <span class="o">=&gt;</span> <span class="nc">CacheControl</span><span class="o">::</span><span class="no">NO_STORE</span>
</code></pre></div></div>

<h3 id="conditional-requests">Conditional requests</h3>

<p>Check the server for content changes before using the cache. Server-side content changes will be detected and reflected.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">CACHE_CONTROL</span> <span class="o">=&gt;</span> <span class="nc">CacheControl</span><span class="o">::</span><span class="no">NO_CACHE</span>
</code></pre></div></div>

<h3 id="specify-client-cache-time">Specify client cache time.</h3>

<p>The client is cached on the client. This is the most efficient cache, but server-side content changes will not be reflected at the specified time.</p>

<p>Also, this cache is not used when the browser reloads. The cache is used when a transition is made with the <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code> tag or when a URL is entered.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">CACHE_CONTROL</span> <span class="o">=&gt;</span> <span class="s1">'max-age=60'</span>
</code></pre></div></div>

<p>If response time is important to you, consider specifying SWR.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">CACHE_CONTROL</span> <span class="o">=&gt;</span> <span class="s1">'max-age=30 stale-while-revalidate=10'</span>
</code></pre></div></div>

<p>In this case, when the max-age of 30 seconds is exceeded, the old cached (stale) response will be returned for up to 10 seconds, as specified in the SWR, until a fresh response is obtained from the origin server. This means that the cache will be updated sometime between 30 and 40 seconds after the last cache update, but every request will be a response from the cache and will be fast.</p>

<h4 id="rfc7234-compliant-clients">RFC7234 compliant clients</h4>

<p>To use the client cache with APIs, use an RFC7234 compliant API client.</p>

<ul>
  <li>iOS <a href="https://nshipster.com/nsurlcache/">NSURLCache</a></li>
  <li>Android <a href="https://developer.android.com/reference/android/net/http/HttpResponseCache">HttpResponseCache</a></li>
  <li>PHP <a href="https://github.com/Kevinrob/guzzle-cache-middleware">guzzle-cache-middleware</a></li>
  <li>JavaScript(Node) <a href="https://www.npmjs.com/package/cacheable-request">cacheable-request</a></li>
  <li>Go <a href="https://github.com/lox/httpcache">lox/httpcache</a></li>
  <li>Ruby <a href="https://github.com/plataformatec/faraday-http-cache">faraday-http-cache</a></li>
  <li>Python <a href="https://pypi.org/project/requests-cache/">requests-cache</a></li>
</ul>

<h3 id="private">private</h3>

<p>Specify <code class="language-plaintext highlighter-rouge">private</code> if you do not want to share the cache with other clients. The cache will be saved only on the client side. In this case, do not specify the cache on the server side.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">CACHE_CONTROL</span> <span class="o">=&gt;</span> <span class="s1">'private, max-age=30'</span>
</code></pre></div></div>

<blockquote>
  <p>Even if you use shared cache, you don’t need to specify <code class="language-plaintext highlighter-rouge">public</code> in most cases.</p>
</blockquote>

<h2 id="cache-design">Cache design</h2>

<p>APIs (or content) can be divided into two categories: <strong>Information APIs</strong> (Information APIs) and <strong>Computation APIs</strong> (Computation APIs). The <strong>Computation API</strong> is content that is difficult to reproduce and is truly dynamic, making it unsuitable for caching. The Information API, on the other hand, is an API for content that is essentially static, even if it is read from a DB and processed by PHP.</p>

<p>It analyzes the content in order to apply the appropriate cache.</p>

<ul>
  <li>Information API or Computation API?</li>
  <li>Dependencies are</li>
  <li>Are the comprehension relationships</li>
  <li>Is the invalidation triggered by an event or TTL?</li>
  <li>Is the event detectable by the application or does it need to be monitored?</li>
  <li>Is the TTL predictable or unpredictable?</li>
</ul>

<p>Consider making cache design a part of the application design process and make it a specification. It should also contribute to the safety of your project throughout its lifecycle.</p>

<h3 id="adaptive-ttl">Adaptive TTL</h3>

<p>Adaptive TTL is the ability to predict the lifetime of content and correctly tell the client or CDN when it will not be updated by an event during that time. For example, when dealing with a stock API, if it is Friday night, we know that the information will not be updated until the start of trading on Monday. We calculate the number of seconds until that time, specify it as the TTL, and then specify the appropriate TTL when it is time to trade.</p>

<p>The client does not need to request a resource that it knows will not be updated.</p>

<h2 id="cacheable">#[Cacheable].</h2>

<p>The traditional ##[Cacheable] TTL caching is also supported.</p>

<p>Example: 30 seconds cache on the server side, 30 seconds cache on the client.</p>

<p>The same number of seconds will be cached on the client side since it is specified on the server side.</p>

<p>The same number of seconds will be cached on the client side.
use BEAR\RepositoryModule\Annotation\Cacheable;</p>

<p>#[Cacheable(expirySecond: 30)]]
class CachedResource extends ResourceObject
{</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Example: Cache the resource on the server and client until the specified expiration date (the date in `$body['expiry_at']`)

```php?start_inline
use BEAR\RepositoryModule\Annotation\Cacheable;

#[Cacheable(expiryAt: 'expiry_at')]]
class CachedResource extends ResourceObject
{
```.

See the [HTTP Cache](https://bearsunday.github.io/manuals/1.0/ja/http-cache.html) page for more information.

## Conclusion

Web content can be of the information (data) type or the computation (process) type. Although the former is essentially static, it is difficult to treat it as completely static content due to the problems of managing content changes and dependencies, so the cache was invalidated by TTL even though no content changes occurred. Sunday's caching framework treats information type content as static as possible, maximizing the power of the cache.


## Terminology

* [条件付きリクエスト](https://developer.mozilla.org/ja/docs/Web/HTTP/Conditional_requests)
* [ETag (バージョン識別子)](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/ETag)
* [イベントドリブン型コンテンツ](https://www.fastly.com/blog/rise-event-driven-content-or-how-cache-more-edge)
* [ドーナッツキャッシュ / 部分キャッシュ](https://www.infoq.com/jp/news/2011/12/MvcDonutCaching/)
* [サロゲートキー / タグベースの無効化](https://docs.fastly.com/ja/guides/getting-started-with-surrogate-keys)
* ヘッダー
  * [Cache-Control](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Cache-Control)
  * [CDN-Cache-Control](https://blog.cloudflare.com/cdn-cache-control/)
  * [Vary](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Vary)
  * [Stale-While-Revalidate (SWR)](https://www.infoq.com/jp/news/2020/12/ux-stale-while-revalidate/)



# Coding Guide

## Project

`Vendor` should be the company name, team name or the owner (`excite`, `koriym` etc.).
`Package` is the name of the application or service (`blog`, `news` etc.).
Projects must be created on a per application basis. Even when you create a Web API and an HTML from different hosts, they are considered one project.


## Style

BEAR.Sunday follows the PSR style.

  * [PSR1](https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-1-basic-coding-standard.md)
  * [PSR2](https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-2-coding-style-guide.md)
  * [PSR4](https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-4-autoloader.md)


Here is ResourceObject code example.

```php
&lt;?php
namespace Koriym\Blog\Resource\App;

use BEAR\RepositoryModule\Annotation\Cacheable;
use BEAR\Resource\Annotation\Embed;
use BEAR\Resource\Annotation\Link;
use BEAR\Resource\Code;
use BEAR\Resource\ResourceObject;
use BEAR\Sunday\Inject\ResourceInject;
use Ray\AuraSqlModule\AuraSqlInject;

/**
 * @Cacheable
 */
class Entry extends ResourceObject
{
    use AuraSqlInject;
    use ResourceInject;

    /**
     * @Embed(rel="author", src="/author{?author_id}")
     */
    public function onGet(string $author_id, string $slug): static
    {
        // ...

        return $this;
    }

    /**
     * @Link(rel="next_act", href="/act1")
     * @Link(rel="next_act2", href="/act2")
     */
    public function onPost (
        string $tile,
        string $body,
        string $uid,
        string $slug
    ): static {
        // ...
        $this-&gt;code = Code::CREATED;

        return $this;
    }
}
```

A [DocBlock comment]([https://phpdoc.org/docs/latest/getting-started/your-first-set-of-documentation.html]) is optional. A DocBlock contains the method summary in one line.
Then followed by the description, which can be a multiple lines.
We should also put @params and @Link after description if possible.



```php?start_inline
/**
 * A summary informing the user what the associated element does.
 *
 * A *description*, that can span multiple lines, to go _in-depth_ into the details of this element
 * and to provide some background information or textual references.
 *
 * @param string $arg1 *description*
 * @param string $arg2 *description*
 * @param string $arg3 *description*
 *
 * @Link(rel="next_act", href="/next_act_uri")
 * @Link(rel="next_act2", href="/next_act_uri2")
*/
```

## Resources

See [Resource Best Practices](resource_bp.html) for best practices for resources.

## Globals

We do not recommend referencing global values in resources or application classes. It is only used with Modules.

* Do not refer to the value of [Superglobal](http://php.net/manual/ja/language.variables.superglobals.php)
* Do not use [define](http://php.net/manual/en/function.define.php)
* Do not create `Config` class to hold set values.
* Do not use global object container (service locator) [[1]](http://koriym.github.io/adv10/), [[2]](http://blog.ploeh.dk/2010/02/03/ServiceLocatorisanAnti-Pattern/)
* Use [Date](http://php.net/manual/en/function.date.php) function and [DateTime](http://php.net/manual/en/class.datetime.php) class. It is not recommended to get the time directly. Inject the time from outside using [koriym/now](https://github.com/koriym/Koriym.Now).


Global method calls such as static methods are also not recommended.

The values required by the application code are all injected. The setting files are used for injecting. When you need an external value such as Web API, make a special gateway class for all requests. Then you can mock that special class with DI or AOP.

## Classes and object

* * [Traits](http://php.net/manual/en/language.oop5.traits.php) are not recommended. Traits for injection such as `ResourceInject` that reduce boilerplate code for injection were added in PHP8 [constructor property promotion (declaring properties in the constructor signature)](https://www.php.net/manual/en/language.oop5.decon.php#language.oop5.decon.constructor.promotion). Use constructor injection.
* It is not recommended for the child classes to use the parent class methods. Common functions are not shared by inheritance and trait, they are dedicated classes and they are injected and used. [Composite from inheritance](https://en.wikipedia.org/wiki/Composition_over_inheritance).
* A class with only one method should reflect the function to the class name and should set the name of the method to `__invoke ()` so that function access can be made.

## Script command

* It is recommended to end the setup by using the `composer setup` command. This script includes the necessary database initialization and library checking. If manual operation such as `.env` setting is required, it is recommended that the procedure be displayed on the screen.
* It is recommended that all application caches and logs are cleared with `composer cleanup` command.
* It is recommended that all executable test (phpinit/phpcs/phpmd ..) are invoked with `composer test` command.
* It is recommended an application is deployed with `composer deploy` command.

## Code check

It is recommended to check the codes for each commit with the following commands. These commands can be installed with [bear/qatools](https://github.com/bearsunday/BEAR.QATools).

```
phpcs src tests
phpmd src text ./phpmd.xml
php-cs-fixer fix --config-file=./.php_cs
phpcbf src
```

## Resources

Please also refer to [Resouce best practice](/manuals/1.0/en/resource.html#best-practice).

### Code

Returns the appropriate status code. Testing is easier, and the correct information can be conveyed to bots and crawlers.

* `100` Continue Continuation of multiple requests
* `200` OK
* `201` Created Resource Creation
* `202` Accepted queue / batch acceptance
* `204` If there is no content body
* `304` Not Modified Not Updated
* `400` Bad request
* `401` Unauthorized Authentication required
* `403` Forbidden ban
* `404` Not Found
* `405` Method Not Allowed
* `503` Service Unavailable Temporary error on server side

In `OnPut` method, you deal with the resource state with idempotence. For example, resource creation with UUID or update resource state.

`OnPatch` is implemented when changing the state of a part of a resource.

### HTML Form Method

BEAR.Sunday can overwrite methods using the `X-HTTP-Method-Override` header or` _method` query at the `POST` request in the HTML web form, but it is not necessarily recommended . For the Page resource, it is OK to implement policies other than `onGet` and` onPost`. [[1]](http://programmers.stacxchange.com/questions/114156/why-are-there-are-no-put-and-delete-methods-on-html-forms), [[2]](Http://roy.gbiv.com/untangled/2009/it-is-okay-to-use-post)

### Hyperlink

* It is recommended that resources with links be indicated by `#[Link]`.
* It is recommended that resources be embedded as a graph of semantic coherence with `#[Embed]`.

## DI

 * Do not inject the value itself of the execution context (prod, dev etc). Instead, we inject instances according to the context. The application does not know in which context it is running.
 * Setter injection is not recommended for library code.
 * It is recommended that you override the `toConstructor` bindings instead and avoid the `Provider` bindings as much as possible.
 * Avoid binding by `Module` according to conditions. [AvoidConditionalLogicInModules](https://github.com/google/guice/wiki/AvoidConditionalLogicInModules)
 * It is not recommended to reference environmental variables since there is no module. Pass it in the constructor.

## AOP

 * Do not make interceptor mandatory. We will make the program work even without an interceptor. (For example, if you remove `@Transactional` interceptor, the function of transaction will be lost, but "core concers" will work without issue.)
 * Prevent the interceptor from injecting dependencies in methods. Values that can only be determined at implementation time are injected into arguments via `@Assisted` injection.
 * If there are multiple interceptors, do not depend on the execution order.
 * If it is an interceptor unconditionally applied to all methods, consider the description in `bootstrap.php`.

## Environment

To make applications testable, it should also work on the console, and not only on the Web.

It is recommended not to include the `.env` file in the project repository.

## Testing

* Focus on resource testing using resource clients, adding resource representation testing (e.g. HTML) if needed.
* Hypermedia tests can leave use cases as tests.
* `prod` is the context for production. Use of the `prod` context in tests should be minimal, preferably none.

## HTML templates

* Avoid large loop statements. Consider replacing if statements in loops with [Generator](https://www.php.net/manual/en/language.generators.overview.php).

---



# Content Negotiation

In HTTP, [Content Negotiation](https://en.wikipedia.org/wiki/Content_negotiation) is a mechanism used to provide various versions of resources for the same URL. BEAR.Sunday supports server-side content negotiation of media type 'Accept' and 'Accept-Language' of language. It can be specified on an application basis or resource basis.

## Install

Install [BEAR.Accept](https://github.com/bearsunday/BEAR.Accept) with composer

```bash
composer require bear/accept ^0.1
```

Next, save the context corresponding to the `Accept *` request header in `/var/locale/available.php`

```php?
&lt;?php
return [
    'Accept' =&gt; [
        'text/hal+json' =&gt; 'hal-app',
        'application/json' =&gt; 'app',
        'cli' =&gt; 'cli-hal-app'
    ],
    'Accept-Language' =&gt; [ // lower case for key
        'ja-jp' =&gt; 'ja',
        'ja' =&gt; 'ja',
        'en-us' =&gt; 'en',
        'en' =&gt; 'en'
    ]
];
```

The `Accept` key array specifies an array whose context is a value with the media type as a key. `cli` is not used in web access in the context of console access.

The `Accept-Language` key array specifies an array with the context key as the key for the language.

## Enable by Application

Change `public/index.php` to enable content negotiation **throughout the application**.

```php
&lt;?php
use BEAR\Accept\Accept;

require dirname(__DIR__) . '/vendor/autoload.php';

$accept = new Accept(require dirname(__DIR__) . '/var/locale/available.php');
list($context, $vary) = $accept($_SERVER);

require dirname(__DIR__) . '/bootstrap/bootstrap.php';
```

For example, in the above setting, the access context of the following `Accept*` header will be `prod-hal-ja-app`.

```
Accept: application/hal+json
Accept-Language: ja-JP
```

At this time `JaModule` requires binding for Japanese text. For details, refer to the demo application [MyVendor.Locale](https://github.com/koriym/MyVendor.Locale).

## Enable by Resource

To do content negotiation on a resource basis, install the `AcceptModule` module and use the `@Produces` annotation.

### Module Install

```php?start_inline
protected function configure()
{
    // ...
    $available = $appDir . '/var/locale/available.php';
    $this-&gt;install(new AcceptModule(available));
}
```

## @Produces annotation

```php?start_inline
use BEAR\Accept\Annotation\Produces;

/**
 * @Produces({"application/hal+json", "text/csv"})
 */
public function onGet()
```

Annotate available media type from left by priority. The representation (JSON or HTML) is changed by the contextual renderer. You do not need to add `Vary` header manually unlike application level content-negotiation.

## Access using curl

Specify the `Accept*` header with the `-H` option.

```
curl -H 'Accept-Language: en' http://127.0.0.1:8080/
```

```
curl -i -H 'Accept-Language: en' -H 'Accept: application/hal+json' http://127.0.0.1:8080/
```

```
HTTP/1.1 200 OK
Host: 127.0.0.1:8080
Date: Fri, 11 Aug 2017 08:32:33 +0200
Connection: close
X-Powered-By: PHP/7.1.4
Vary: Accept, Accept-Language
content-type: application/hal+json

{
    "greeting": "Hello BEAR.Sunday",
    "_links": {
        "self": {
            "href": "/index"
        }
    }
}
```


# Database

The following modules are available for database use, with different problem solving methods. They are all independent libraries for SQL based on [PDO](https://www.php.net/manual/ja/intro.pdo.php).

* ExtendedPdo with PDO extended ([Aura.sql](https://github.com/auraphp/Aura.Sql))
* Query Builder ([Aura.SqlQuery](https://github.com/auraphp/Aura.SqlQuery))
* Binding PHP interface and SQL execution ([Ray.MediaQuery](database_media.html))

Having static SQL in a file[^locator] makes it easier to use and tune with other SQL tools. SqlQuery can dynamically assemble queries, but the rest of the library is for basic static SQL execution. Ray.MediaQuery can also replace parts of the SQL with those assembled by the builder.

[^locator]: [query-locater](https://github.com/koriym/Koriym.QueryLocator) is a library for handling SQL as files, which is useful with Aura.Sql.

## Module

Modules are provided for using the database. They are all independent libraries for SQL.

* [Ray.AuraSqlModule](database_aura.html)
* [Ray.MediaQuery](database_media.html)

`Ray.AuraSqlModule` is a PDO extension [Aura.Sql](https://github.com/auraphp/Aura.Sql) and a query builder [Aura.SqlQuery](https://github.com/auraphp/) SqlQuery, plus a low-level module that provides pagination functionality.
`Ray.MediaQuery` is a high-performance DB access framework that generates and injects SQL execution objects from user-provided interfaces and SQL [^doma] .

[^doma]: The mechanism is similar to Java's DB access framework [Doma](https://doma.readthedocs.io/en/latest/basic/#examples).

## Other

* [DBAL](database_dbal.html)
* [CakeDb](database_cake.html)
* [Ray.QueryModule](https://github.com/ray-di/Ray.QueryModule/blob/1.x/README.md)

`DBAL` is Doctrine and `CakeDB` is CakePHP's DB library. `Ray.QueryModule` is an earlier library of Ray.MediaQuery that converts SQL to anonymous functions.

----



# Aura.Sql

[Aura.Sql](https://github.com/auraphp/Aura.Sql) is an Aura database library that extends from `PDO` .

### Installation

Install `Ray.AuraSqlModule` via composer.

```bash
composer require ray/aura-sql-module
```

Installing `AuraSqlModule` in your application module`src/Module/AppModule.php`.

```php?start_inline
use BEAR\Package\AbstractAppModule;
use BEAR\AppMeta\AppMeta;
use BEAR\Package\PackageModule;
use Ray\AuraSqlModule\AuraSqlModule; // add this line

class AppModule extends AbstractAppModule
{
    protected function configure()
    {
        // ...
        // Add the below install method call and contents
        $this-&gt;install(
            new AuraSqlModule(
                'mysql:host=localhost;dbname=test',
                'username',
                'password',
                // $options,
                // $attributes
            )
        );
        $this-&gt;install(new PackageModule));
    }
}
```

Now the `DI` bindings are ready. The db object will be injected via a constructor or the `AuraSqlInject` setter trait.

```php?start_inline
use Aura\Sql\ExtendedPdoInterface;

class Index
{
    public function __construct(ExtendedPdoInterface $pdo)
    {
        return $this-&gt;pdo; // \Aura\Sql\ExtendedPdo
    }
}
```


```php?start_inline
use Ray\AuraSqlModule\AuraSqlInject;

class Index
{
    use AuraSqlInject;

    public function onGet()
    {
        return $this-&gt;pdo; // \Aura\Sql\ExtendedPdo
    }
}
```

`Ray.AuraSqlModule` contains [Aura.SqlQuery](https://github.com/auraphp/Aura.SqlQuery) to help you build sql queries.
[Aura.SqlQuery](https://github.com/auraphp/Aura.SqlQuery) also have other useful methods like [Array Quoting](https://github.com/auraphp/Aura.Sql/tree/2.x#array-quoting), [fetch*()](https://github.com/auraphp/Aura.Sql/tree/2.x#new-fetch-methods), [perform()](https://github.com/auraphp/Aura.Sql/tree/2.x#the-perform-method) and [yield*()](https://github.com/auraphp/Aura.Sql/tree/2.x#new-yield-methods) that you can use for your needs, please check their documentation.

## Replication

To automatically perform master / slave connection, specify the IP of the slave DB as the fourth argument.

```php?start_inline
$this-&gt;install(
  new AuraSqlModule(
    'mysql:host=localhost;dbname=test',
    'username',
    'password',
    'slave1,slave2' // specify slave IP as a comma separated value
  )
);
```

You will now have a slave db connection when using HTTP GET, or a master db connection in other HTTP methods.

```php?start_inline
use Aura\Sql\ExtendedPdoInterface;
use BEAR\Resource\ResourceObject;
use PDO;

class User extends ResourceObject
{
    public $pdo;

    public function __construct(ExtendedPdoInterface $pdo)
    {
        $this-&gt;pdo = $pdo;
    }

    public function onGet()
    {
         $this-&gt;pdo; // slave db
    }

    public function onPost($todo)
    {
         $this-&gt;pdo; // master db
    }
}
```

`$this-&gt;pdo` is overwritten if the method is annotated with`@ReadOnlyConnection` or`@WriteConnection`. The master / slave db connection corresponds to the annotation.

```php?start_inline
use Ray\AuraSqlModule\Annotation\ReadOnlyConnection;  // important
use Ray\AuraSqlModule\Annotation\WriteConnection;     // important

class User
{
    public $pdo; // override when @ReadOnlyConnection or @WriteConnection annotated method called

    public function onPost($todo)
    {
         $this-&gt;read();
    }

    /**
     * @ReadOnlyConnection
     */
    public function read()
    {
         $this-&gt;pdo; // slave db
    }

    /**
     * @WriteConnection
     */
    public function write()
    {
         $this-&gt;pdo; // master db
    }
}
```

## Connect to multiple databases

To receive multiple `PdoExtendedInterface` objects with different connection destinations, use `@Named` annotation.

```php?start_inline
/**
 * @Inject
 * @Named("log_db")
 */
public function setLoggerDb(ExtendedPdoInterface $pdo)
{
    // ...
}
```

Specify an identifier with `NamedPdoModule` and bind it.

```php?start_inline
$this-&gt;install(new NamedPdoModule('log_db', 'mysql:host=localhost;dbname=log', 'username',
$this-&gt;install(new NamedPdoModule('job_db', 'mysql:host=localhost;dbname=job', 'username',
```

In the module, you specify an identifier in `NamedPdoModule` and bind it.

```php?start_inline
$this-&gt;install(
  new NamedPdoModule(
    'log_db', // Type of database specified by @Named
    'mysql:host=localhost;dbname=log',
    'username',
    'pass',
    'slave1,slave2' // specify slave IP as a comma separated value
  )
);
```

## Transactions

Using the `@Transactional` annotation wraps methods with a transaction.

```php?start_inline
use Ray\AuraSqlModule\Annotation\Transactional;

// ....
    /**
     * @Transactional
     */
    public function write()
    {
         // \Ray\AuraSqlModule\Exception\RollbackException thrown if it failed.
    }
```

To do transactions on multiple connected databases, specify properties in the `@Transactional` annotation.
If not specified, it becomes `{"pdo"}`.

```php?start_inline
/**
 * @Transactional({"pdo", "userDb"})
 */
public function write()
```

It is run as follows.

```php?start_inline
$this-&gt;pdo-&gt;beginTransaction()
$this-&gt;userDb-&gt;beginTransaction()

// ...

$this-&gt;pdo-&gt;commit();
$this-&gt;userDb-&gt;commit();
```

## Aura.SqlQuery

[Aura.Sql](https://github.com/auraphp/Aura.Sql) is an extension of PDO. [Aura.SqlQuery](https://github.com/auraphp/Aura.SqlQuery) provides database-specific SQL builder for MySQL, Postgres, SQLite or Microsoft SQL Server.

Specify the database and install it with the application module `src/Module/AppModule.php`.

```php?start_inline
// ...
$this-&gt;install(new AuraSqlQueryModule('mysql')); // pgsql, sqlite, or sqlsrv
```

### SELECT

The resource receives the DB Query Builder object and constructs a SELECT query using the following methods.
You can also call the method multiple times in any order.

```php?start_inline
use Ray\AuraSqlModule\AuraSqlInject;
use Ray\AuraSqlModule\AuraSqlSelectInject;

class User extend ResourceObject
{
    use AuraSqlInject;
    use AuraSqlSelectInject;

    public function onGet()
    {
        $this-&gt;select
            -&gt;distinct()                    // SELECT DISTINCT
            -&gt;cols([                        // select these columns
                'id',                       // column name
                'name AS namecol',          // one way of aliasing
                'col_name' =&gt; 'col_alias',  // another way of aliasing
                'COUNT(foo) AS foo_count'   // embed calculations directly
            ])
            -&gt;from('foo AS f')              // FROM these tables
            -&gt;fromSubselect(                // FROM sub-select AS my_sub
                'SELECT ...',
                'my_sub'
            )
            -&gt;join(                         // JOIN ...
                'LEFT',                     // left/inner/natural/etc
                'doom AS d'                 // this table name
                'foo.id = d.foo_id'         // ON these conditions
            )
            -&gt;joinSubSelect(                // JOIN to a sub-select
                'INNER',                    // left/inner/natural/etc
                'SELECT ...',               // the subselect to join on
                'subjoin'                   // AS this name
                'sub.id = foo.id'           // ON these conditions
            )
            -&gt;where('bar &gt; :bar')           // AND WHERE these conditions
            -&gt;where('zim = ?', 'zim_val')   // bind 'zim_val' to the ? placeholder
            -&gt;orWhere('baz &lt; :baz')         // OR WHERE these conditions
            -&gt;groupBy(['dib'])              // GROUP BY these columns
            -&gt;having('foo = :foo')          // AND HAVING these conditions
            -&gt;having('bar &gt; ?', 'bar_val')  // bind 'bar_val' to the ? placeholder
            -&gt;orHaving('baz &lt; :baz')        // OR HAVING these conditions
            -&gt;orderBy(['baz'])              // ORDER BY these columns
            -&gt;limit(10)                     // LIMIT 10
            -&gt;offset(40)                    // OFFSET 40
            -&gt;forUpdate()                   // FOR UPDATE
            -&gt;union()                       // UNION with a followup SELECT
            -&gt;unionAll()                    // UNION ALL with a followup SELECT
            -&gt;bindValue('foo', 'foo_val')   // bind one value to a placeholder
            -&gt;bindValues([                  // bind these values to named placeholders
                'bar' =&gt; 'bar_val',
                'baz' =&gt; 'baz_val',
            ]);

        $sth = $this-&gt;pdo-&gt;prepare($this-&gt;select-&gt;getStatement());

        // bind the values and execute
        $sth-&gt;execute($this-&gt;select-&gt;getBindValues());
        $result = $sth-&gt;fetch(\PDO::FETCH_ASSOC);
        // or
        // $result = $this-&gt;pdo-&gt;fetchAssoc($stm, $bind);
```

The created queries are queried as strings with the `getStatement()`.

### INSERT

### Single row INSERT


```php?start_inline
use Ray\AuraSqlModule\AuraSqlInject;
use Ray\AuraSqlModule\AuraSqlInsertInject;

class User extend ResourceObject
{
    use AuraSqlInject;
    use AuraSqlInsertInject;

    public function onPost()
    {
        $this-&gt;insert
            -&gt;into('foo')                   // INTO this table
            -&gt;cols([                        // bind values as "(col) VALUES (:col)"
                'bar',
                'baz',
            ])
            -&gt;set('ts', 'NOW()')            // raw value as "(ts) VALUES (NOW())"
            -&gt;bindValue('foo', 'foo_val')   // bind one value to a placeholder
            -&gt;bindValues([                  // bind these values
                'bar' =&gt; 'foo',
                'baz' =&gt; 'zim',
            ]);

        $sth = $this-&gt;pdo-&gt;prepare($this-&gt;insert-&gt;getStatement());
        $sth-&gt;execute($this-&gt;insert-&gt;getBindValues());
        // or
        // $sth = $this-&gt;pdo-&gt;perform($this-&gt;insert-&gt;getStatement(), this-&gt;insert-&gt;getBindValues());

        // get the last insert ID
        $name = $insert-&gt;getLastInsertIdName('id');
        $id = $pdo-&gt;lastInsertId($name);
```

The `cols()` method allows you to pass an array of key-value pairs where the key is the column name and the value is a bind value (not a raw value).

```php?start_inline
        $this-&gt;insert
            -&gt;into('foo')                   // insert into this table
            -&gt;cols([                        // insert these columns and bind these values
                'foo' =&gt; 'foo_value',
                'bar' =&gt; 'bar_value',
                'baz' =&gt; 'baz_value',
            ]);
```

### Multi-line INSERT

To do a multiple row INSERT, use the `addRow ()` method at the end of the first line. Then build the following query.

```php?start_inline
        // insert into this table
        $this-&gt;insert-&gt;into('foo');

        // set up the first row
        $this-&gt;insert-&gt;cols([
            'bar' =&gt; 'bar-0',
            'baz' =&gt; 'baz-0'
        ]);
        $this-&gt;insert-&gt;set('ts', 'NOW()');

        // set up the second row. the columns here are in a different order
        // than in the first row, but it doesn't matter; the INSERT object
        // keeps track and builds them the same order as the first row.
        $this-&gt;insert-&gt;addRow();
        $this-&gt;insert-&gt;set('ts', 'NOW()');
        $this-&gt;insert-&gt;cols([
            'bar' =&gt; 'bar-1',
            'baz' =&gt; 'baz-1'
        ]);

        // set up further rows ...
        $this-&gt;insert-&gt;addRow();
        // ...

        // execute a bulk insert of all rows
        $sth = $this-&gt;pdo-&gt;prepare($insert-&gt;getStatement());
        $sth-&gt;execute($insert-&gt;getBindValues());

```

&gt; Note: If you try to add a row without specifying the value of the first column in the first row, an exception will be thrown.
&gt; Passing an associative array of columns to `addRow()` will be used on the next line. That is, you can not specify `col()` or `cols()` on the first line.

```php?start_inline
        // set up the first row
        $insert-&gt;addRow([
            'bar' =&gt; 'bar-0',
            'baz' =&gt; 'baz-0'
        ]);
        $insert-&gt;set('ts', 'NOW()');

        // set up the second row
        $insert-&gt;addRow([
            'bar' =&gt; 'bar-1',
            'baz' =&gt; 'baz-1'
        ]);
        $insert-&gt;set('ts', 'NOW()');

        // etc.
```

You can also set the database at once using `addRows()`.

```php?start_inline
        $rows = [
            [
                'bar' =&gt; 'bar-0',
                'baz' =&gt; 'baz-0'
            ],
            [
                'bar' =&gt; 'bar-1',
                'baz' =&gt; 'baz-1'
            ],
        ];
        $this-&gt;insert-&gt;addRows($rows);
```

### UPDATE
Use the following methods to construct an UPDATE query. You can also call the method multiple times in any order.

```php?start_inline
        $this-&gt;update
            -&gt;table('foo')                  // update this table
            -&gt;cols([                        // bind values as "SET bar = :bar"
                'bar',
                'baz',
            ])
            -&gt;set('ts', 'NOW()')            // raw value as "(ts) VALUES (NOW())"
            -&gt;where('zim = :zim')           // AND WHERE these conditions
            -&gt;where('gir = ?', 'doom')      // bind this value to the condition
            -&gt;orWhere('gir = :gir')         // OR WHERE these conditions
            -&gt;bindValue('bar', 'bar_val')   // bind one value to a placeholder
            -&gt;bindValues([                  // bind these values to the query
                'baz' =&gt; 99,
                'zim' =&gt; 'dib',
                'gir' =&gt; 'doom',
            ]);
        $sth = $this-&gt;pdo-&gt;prepare($update-&gt;getStatement())
        $sth-&gt;execute($this-&gt;update-&gt;getBindValues());
        // or
        // $sth = $this-&gt;pdo-&gt;perform($this-&gt;update-&gt;getStatement(), $this-&gt;update-&gt;getBindValues());
```

You can also pass an associative array to `cols()` with the key as the column name and the value as the bound value (not the RAW value).

```php?start_inline

        $this-update-&gt;table('foo')          // update this table
            -&gt;cols([                        // update these columns and bind these values
                'foo' =&gt; 'foo_value',
                'bar' =&gt; 'bar_value',
                'baz' =&gt; 'baz_value',
            ]);
?&gt;
```

### DELETE
Use the following methods to construct a DELETE query. You can also call the method multiple times in any order.
```php?start_inline
        $this-&gt;delete
            -&gt;from('foo')                   // FROM this table
            -&gt;where('zim = :zim')           // AND WHERE these conditions
            -&gt;where('gir = ?', 'doom')      // bind this value to the condition
            -&gt;orWhere('gir = :gir')         // OR WHERE these conditions
            -&gt;bindValue('bar', 'bar_val')   // bind one value to a placeholder
            -&gt;bindValues([                  // bind these values to the query
                'baz' =&gt; 99,
                'zim' =&gt; 'dib',
                'gir' =&gt; 'doom',
            ]);
        $sth = $this-&gt;pdo-&gt;prepare($update-&gt;getStatement())
        $sth-&gt;execute($this-&gt;delete-&gt;getBindValues());
```

### Pagination

[ray/aura-sql-module](https://packagist.org/packages/ray/aura-sql-module) supports pagination (page splitting) in both Ray.Sql raw SQL and Ray.AuraSqlQuery query builder.
We create a pager using the `newInstance()` with a uri_template, binding values and the number of items per page. You can access the page by $page[$number].

### Aura.Sql
AuraSqlPagerFactoryInterface

```php?start_inline
/* @var $factory \Ray\AuraSqlModule\Pagerfanta\AuraSqlPagerFactoryInterface */
$pager = $factory-&gt;newInstance($pdo, $sql, $params, 10, '/?page={page}&amp;category=sports'); // 10 items per page
$page = $pager[2]; // page 2
/* @var $page \Ray\AuraSqlModule\Pagerfanta\Page */
// $page-&gt;data // sliced data (array|\Traversable)
// $page-&gt;current; (int)
// $page-&gt;total (int)
// $page-&gt;hasNext (bool)
// $page-&gt;hasPrevious (bool)
// $page-&gt;maxPerPage; (int)
// (string) $page // pager html (string)
```

## Aura.SqlQuery
AuraSqlQueryPagerFactoryInterface

```php?start_inline
// for Select
/* @var $factory \Ray\AuraSqlModule\Pagerfanta\AuraSqlQueryPagerFactoryInterface */
$pager = $factory-&gt;newInstance($pdo, $select, 10, '/?page={page}&amp;category=sports');
$page = $pager[2]; // page 2
/* @var $page \Ray\AuraSqlModule\Pagerfanta\Page */
```
&gt; Note: Although the Aura.Sql edits the raw SQL directly, it currently only supports the MySQL LIMIT clause format.

`$page` is iterable.

```php?start_inline
foreach ($page as $row) {
 // Process each row
}
```
To change the pager HTML template, change the binding of `TemplateInterface`.
For details about templates, please see [Pagerfanta](https://github.com/whiteoctober/Pagerfanta#views).

```php?start_inline
use Pagerfanta\View\Template\TemplateInterface;
use Pagerfanta\View\Template\TwitterBootstrap3Template;
use Ray\AuraSqlModule\Annotation\PagerViewOption;

class AppModule extends AbstractAppModule
{
    protected function configure()
    {
        // ...
        $this-&gt;bind(TemplateInterface::class)-&gt;to(TwitterBootstrap3Template::class);
        $this-&gt;bind()-&gt;annotatedWith(PagerViewOption::class)-&gt;toInstance($pagerViewOption);
    }
}
```


# CakeDb

**CakeDb** is an ORM using the active record and data mapper pattern idea. It is the same as the one provided in CakePHP3.

Install `Ray.CakeDbModule` with composer.

```bash
composer require ray/cake-database-module ~1.0
```

Please refer to [Ray.CakeDbModule](https://github.com/ray-di/Ray.CakeDbModule) for installation and refer to [CakePHP3 Database Access &amp; ORM](http://book.cakephp.org/3.0/en/orm.html) for the ORM usage.

Ray.CakeDbModule is provided by Jose ([@lorenzo](https://github.com/lorenzo)) who developed the ORM of CakePHP3.

## Connection settings

Use the [phpdotenv](https://github.com/vlucas/phpdotenv) library etc. to set the connection according to the environment destination. Please see the [Ex.Package](https://github.com/BEARSunday/Ex.Package) for implementation.


# Doctrine DBAL

[Doctrine DBAL](http://www.doctrine-project.org/projects/dbal.html) is also abstraction layer for database.

Install `Ray.DbalModule` with composer.

```bash
composer require ray/dbal-module
```

Install `DbalModule` in application module.

```php?start_inline
use BEAR\Package\AbstractAppModule;
use Ray\DbalModule\DbalModule;

class AppModule extends AbstractAppModule
{
    protected function configure()
    {
        // ...
        $this-&gt;install(new DbalModule('driver=pdo_sqlite&amp;memory=true');
    }
}
```

New DI bindings are now ready and `$this-&gt;db` can be injected with the `DbalInject` trait.

```php?start_inline
use Ray\DbalModule\DbalInject;

class Index
{
    use DbalInject;

    public function onGet()
    {
        return $this-&gt;db; // \Doctrine\DBAL\Driver\Connection
    }
}
```

### Connect to multiple databases

To connect to multiple databases, specify the identifier as the second argument.

```php?start_inline
$this-&gt;install(new DbalModule($logDsn, 'log_db');
$this-&gt;install(new DbalModule($jobDsn, 'job_db');
```

```php?start_inline
/**
 * @Inject
 * @Named("log_db")
 */
public function setLogDb(Connection $logDb)
```

[MasterSlaveConnection](http://www.doctrine-project.org/api/dbal/2.0/class-Doctrine.DBAL.Connections.MasterSlaveConnection.html) is provided for master/slave connections.


# Ray.MediaQuery

`Ray.QueryModule` makes a query to an external media such as a database or Web API with a function object to be injected.

## Motivation

* You can have a clear boundary between domain layer (usage code) and infrastructure layer (injected function) in code.
* Execution objects are generated automatically so you do not need to write procedural code for execution.
* Since usage codes are indifferent to the actual state of external media, storage can be changed later. Easy parallel development and stabbing.

## Composer install

    $ composer require ray/media-query

## Getting Started

Define the interface for media access.

### DB

Specify the SQL ID with the attribute `DbQuery`.

```php
interface TodoAddInterface
{
    #[DbQuery('user_add')]
    public function add(string $id, string $title): void;
}
```

### Web API

Specify the Web request ID with the attribute `WebQuery`.

```php
interface PostItemInterface
{
    #[WebQuery('user_item')]
    public function get(string $id): array;
}
```

Create the web api path list file as `web_query.json`.

```json
{
    "$schema": "https://ray-di.github.io/Ray.MediaQuery/schema/web_query.json",
    "webQuery": [
        {"id": "user_item", "method": "GET", "path": "https://{domain}/users/{id}"}
    ]
}
```

### Module

MediaQueryModule binds the execution of SQL and Web API requests to an interface by setting `DbQueryConfig` or `WebQueryConfig` or both.

```php
use Ray\AuraSqlModule\AuraSqlModule;
use Ray\MediaQuery\ApiDomainModule;
use Ray\MediaQuery\DbQueryConfig;
use Ray\MediaQuery\MediaQueryModule;
use Ray\MediaQuery\Queries;
use Ray\MediaQuery\WebQueryConfig;

protected function configure(): void
{
    $this-&gt;install(
        new MediaQueryModule(
            Queries::fromDir('/path/to/queryInterface'),[
                new DbQueryConfig('/path/to/sql'),
                new WebQueryConfig('/path/to/web_query.json', ['domain' =&gt; 'api.exmaple.com'])
            ],
        ),
    );
    $this-&gt;install(new AuraSqlModule('mysql:host=localhost;dbname=test', 'username', 'password'));
}
```

MediaQueryModule requires AuraSqlModule to be installed.

### Request object injection

You don't need to provide any implementation classes. It will be generated and injected.

```php
class Todo
{
    public function __construct(
        private TodoAddInterface $todoAdd
    ) {}

    public function add(string $id, string $title): void
    {
        $this-&gt;todoAdd-&gt;add($id, $title);
    }
}
```

### Notes

#### DbQuery

SQL execution is mapped to a method, and the SQL specified by ID is bound and executed by the method argument.
For example, if the ID is `todo_item`, `todo_item.sql` SQL statement will be executed with `['id =&gt; $id]` bound.

* Prepare the SQL file in the `$sqlDir` directory.

#### Entity

* The SQL execution result can be hydrated to the entity class with `entity` parameter

```php
interface TodoItemInterface
{
    #[DbQuery('todo_item', entity: Todo::class, type:'row')]
    public function getItem(string $id): Todo;
}
```
```php
final class Todo
{
    public string $id;
    public string $title;
}
```

Use `CameCaseTrait` to convert a property to camelCase.

```php
use Ray\MediaQuery\CamelCaseTrait;

class Invoice
{
    use CamelCaseTrait;

    public $userName;
}
```

If the entity has a constructor, the constructor will be called with the fetched data.

```php
final class Todo
{
    public function __construct(
        public string $id,
        public string $title
    ) {}
}
```

#### type: 'row'

If the return value of SQL execution is a single row, specify the attribute `type: 'row'`. However, if the return value of the interface is an entity class, it can be omitted. [^v0dot5].

[^v0dot5]: Until the previous version `0.5`, the SQL file was identified by its name as follows:" If the return value of the SQL execution is a single row, add a postfix of `item`; if it is multiple rows, add a postfix of `list`."

```php
/** If the return value is Entity */
interface TodoItemInterface
{
    #[DbQuery('todo_item', entity: Todo::class)]
    public function getItem(string $id): Todo;
}
```

```php
/** If the return value is array */
interface TodoItemInterface
{
    #[DbQuery('todo_item', entity: Todo::class, type: 'row')]
    public function getItem(string $id): array;
}
```

#### Web API

* Customization such as header for authentication is done by binding Guzzle's `ClinetInterface`.

```php
$this-&gt;bind(ClientInterface::class)-&gt;toProvider(YourGuzzleClientProvicer::class);
```

## Parameters

### DateTime

You can pass a value object as a parameter.
For example, you can specify a `DateTimeInterface` object like this.

```php
interface TaskAddInterface
{
    public function __invoke(string $title, DateTimeInterface $cratedAt = null): void;
}
```

The value will be converted to a date formatted string at SQL execution time or Web API request time.

```sql
INSERT INTO task (title, created_at) VALUES (:title, :createdAt); # 2021-2-14 00:00:00
```

If no value is passed, the bound current time will be injected.
This eliminates the need to hard-code `NOW()` inside SQL and pass the current time every time.

### Test clock

When testing, you can also use a single time binding for the `DateTimeInterface`, as shown below.

```php
$this-&gt;bind(DateTimeInterface::class)-&gt;to(UnixEpochTime::class);
```

## VO

If a value object other than `DateTime` is passed, the return value of the `ToScalar()` method that implements the `toScalar` interface or the `__toString()` method will be the argument.

```php
interface MemoAddInterface
{
    public function __invoke(string $memo, UserId $userId = null): void;
}
```

```php
class UserId implements ToScalarInterface
{
    public function __construct(
        private LoginUser $user;
    ){}
    
    public function toScalar(): int
    {
        return $this-&gt;user-&gt;id;
    }
}
```

```sql
INSERT INTO memo (user_id, memo) VALUES (:user_id, :memo);
```

### Parameter Injection

Note that the default value of `null` for the value object argument is never used in SQL. If no value is passed, the scalar value of the value object injected with the parameter type will be used instead of null.

```php
public function __invoke(Uuid $uuid = null): void; // UUID is generated and passed.
</code></pre></div></div>

<h2 id="pagination">Pagination</h2>

<p>The <code class="language-plaintext highlighter-rouge">#[Pager]</code> annotation allows paging of SELECT queries.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\MediaQuery\PagesInterface</span><span class="p">;</span>

<span class="kd">interface</span> <span class="nc">TodoList</span>
<span class="p">{</span>
    <span class="c1">#[DbQuery, Pager(perPage: 10, template: '/{?page}')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">():</span> <span class="kt">PagesInterface</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You can get the number of pages with <code class="language-plaintext highlighter-rouge">count()</code>, and you can get the page object with array access by page number.
<code class="language-plaintext highlighter-rouge">Pages</code> is a SQL lazy execution object.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$pages</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$todoList</span><span class="p">)();</span>
<span class="nv">$cnt</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$pages</span><span class="p">);</span> <span class="c1">// When count() is called, the count SQL is generated and queried.</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nv">$pages</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// A page query is executed when an array access is made.</span>

<span class="c1">// $page-&gt;data // sliced data</span>
<span class="c1">// $page-&gt;current;</span>
<span class="c1">// $page-&gt;total</span>
<span class="c1">// $page-&gt;hasNext</span>
<span class="c1">// $page-&gt;hasPrevious</span>
<span class="c1">// $page-&gt;maxPerPage;</span>
<span class="c1">// (string) $page // pager html</span>
</code></pre></div></div>

<h1 id="sqlquery">SqlQuery</h1>

<p>If you pass a <code class="language-plaintext highlighter-rouge">DateTimeIntetface</code> object, it will be converted to a date formatted string and queried.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$sqlQuery</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'memo_add'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'memo'</span> <span class="o">=&gt;</span> <span class="s1">'run'</span><span class="p">,</span> <span class="s1">'created_at'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">DateTime</span><span class="p">()]);</span>
</code></pre></div></div>

<p>When an object is passed, it is converted to a value of <code class="language-plaintext highlighter-rouge">toScalar()</code> or <code class="language-plaintext highlighter-rouge">__toString()</code> as in Parameter Injection.</p>

<h2 id="get-method">Get* Method</h2>

<p>To get the SELECT result, use <code class="language-plaintext highlighter-rouge">get*</code> method depending on the result you want to get.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$sqlQuery</span><span class="o">-&gt;</span><span class="nf">getRow</span><span class="p">(</span><span class="nv">$queryId</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span> <span class="c1">// Result is a single row</span>
<span class="nv">$sqlQuery</span><span class="o">-&gt;</span><span class="nf">getRowList</span><span class="p">(</span><span class="nv">$queryId</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span> <span class="c1">// result is multiple rows</span>
<span class="nv">$statement</span> <span class="o">=</span> <span class="nv">$sqlQuery</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">();</span> <span class="c1">// Retrieve the PDO Statement</span>
<span class="nv">$pages</span> <span class="o">=</span> <span class="nv">$sqlQuery</span><span class="o">-&gt;</span><span class="nf">getPages</span><span class="p">();</span> <span class="c1">// Get the pager</span>
</code></pre></div></div>

<p>Ray.MediaQuery contains the <a href="https://github.com/ray-di/Ray.AuraSqlModule">Ray.AuraSqlModule</a>.
If you need more lower layer operations, you can use Aura.Sql’s <a href="https://github.com/ray-di/Ray.AuraSqlModule#query-builder">Query Builder</a> or <a href="https://github.com/auraphp/Aura.Sql">Aura.Sql</a> which extends PDO.
<a href="https://github.com/ray-di/Ray.DbalModule">doctrine/dbal</a> is also available.</p>

<h2 id="profiler">Profiler</h2>

<p>Media accesses are logged by a logger. By default, a memory logger is bound to be used for testing.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">testAdd</span><span class="p">():</span> <span class="kt">void</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sqlQuery</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'todo_add'</span><span class="p">,</span> <span class="nv">$todoRun</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertStringContainsString</span><span class="p">(</span><span class="s1">'query: todo_add({"id": "1", "title": "run"})'</span><span class="p">,</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Implement your own <a href="src/MediaQueryLoggerInterface.php">MediaQueryLoggerInterface</a> and run
You can also implement your own <a href="src/MediaQueryLoggerInterface.php">MediaQueryLoggerInterface</a> to benchmark each media query and log it with the injected PSR logger.</p>

<h2 id="annotations--attributes">Annotations / Attributes</h2>

<p>You can use either <a href="https://github.com/doctrine/annotations/">doctrine annotations</a> or <a href="https://www.php.net/manual/en/language.attributes.overview.php">PHP8 attributes</a> can both be used.
The next two are the same.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\MediaQuery\Annotation\DbQuery</span><span class="p">;</span>

<span class="c1">#[DbQuery('user_add')]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">add1</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$title</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>

<span class="cd">/** @DbQuery("user_add") */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">add2</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$title</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
</code></pre></div></div>

<h1 id="database">Database</h1>

<p><code class="language-plaintext highlighter-rouge">Aura.Sql</code>、<code class="language-plaintext highlighter-rouge">Doctrine DBAL</code>, <code class="language-plaintext highlighter-rouge">CakeDB</code> modules are available for database connections.</p>

<h2 id="aurasql">Aura.Sql</h2>

<p><a href="https://github.com/auraphp/Aura.Sql">Aura.Sql</a> is an Aura database library that extends from <code class="language-plaintext highlighter-rouge">PDO</code> .</p>

<h3 id="installation">Installation</h3>

<p>Install <code class="language-plaintext highlighter-rouge">Ray.AuraSqlModule</code> via composer.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require ray/aura-sql-module
</code></pre></div></div>

<p>Installing <code class="language-plaintext highlighter-rouge">AuraSqlModule</code> in your application module<code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\AppMeta\AppMeta</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\PackageModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlModule</span><span class="p">;</span> <span class="c1">// add this line</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="c1">// Add the below install method call and contents</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">AuraSqlModule</span><span class="p">(</span>
                <span class="s1">'mysql:host=localhost;dbname=test'</span><span class="p">,</span>
                <span class="s1">'username'</span><span class="p">,</span>
                <span class="s1">'password'</span><span class="p">,</span>
                <span class="c1">// $options,</span>
                <span class="c1">// $attributes</span>
            <span class="p">)</span>
        <span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">PackageModule</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now the <code class="language-plaintext highlighter-rouge">DI</code> bindings are ready. The db object will be injected via a constructor or the <code class="language-plaintext highlighter-rouge">AuraSqlInject</code> setter trait.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Aura\Sql\ExtendedPdoInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">ExtendedPdoInterface</span> <span class="nv">$pdo</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// \Aura\Sql\ExtendedPdo</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlInject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">AuraSqlInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// \Aura\Sql\ExtendedPdo</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Ray.AuraSqlModule</code> contains <a href="https://github.com/auraphp/Aura.SqlQuery">Aura.SqlQuery</a> to help you build sql queries.
<a href="https://github.com/auraphp/Aura.SqlQuery">Aura.SqlQuery</a> also have other useful methods like <a href="https://github.com/auraphp/Aura.Sql/tree/2.x#array-quoting">Array Quoting</a>, <a href="https://github.com/auraphp/Aura.Sql/tree/2.x#new-yield-methods">fetch<em>()](https://github.com/auraphp/Aura.Sql/tree/2.x#new-fetch-methods), [perform()](https://github.com/auraphp/Aura.Sql/tree/2.x#the-perform-method) and [yield</em>()</a> that you can use for your needs, please check their documentation.</p>

<h2 id="replication">Replication</h2>

<p>To automatically perform master / slave connection, specify the IP of the slave DB as the fourth argument.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
  <span class="k">new</span> <span class="nc">AuraSqlModule</span><span class="p">(</span>
    <span class="s1">'mysql:host=localhost;dbname=test'</span><span class="p">,</span>
    <span class="s1">'username'</span><span class="p">,</span>
    <span class="s1">'password'</span><span class="p">,</span>
    <span class="s1">'slave1,slave2'</span> <span class="c1">// specify slave IP as a comma separated value</span>
  <span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<p>You will now have a slave db connection when using HTTP GET, or a master db connection in other HTTP methods.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Aura\Sql\ExtendedPdoInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="no">PDO</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$pdo</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">ExtendedPdoInterface</span> <span class="nv">$pdo</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
    <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// slave db</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="nv">$todo</span><span class="p">)</span>
    <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// master db</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">$this-&gt;pdo</code> is overwritten if the method is annotated with<code class="language-plaintext highlighter-rouge">@ReadOnlyConnection</code> or<code class="language-plaintext highlighter-rouge">@WriteConnection</code>. The master / slave db connection corresponds to the annotation.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\Annotation\ReadOnlyConnection</span><span class="p">;</span>  <span class="c1">// important</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\Annotation\WriteConnection</span><span class="p">;</span>     <span class="c1">// important</span>

<span class="kd">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$pdo</span><span class="p">;</span> <span class="c1">// override when @ReadOnlyConnection or @WriteConnection annotated method called</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="nv">$todo</span><span class="p">)</span>
    <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">read</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @ReadOnlyConnection
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">read</span><span class="p">()</span>
    <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// slave db</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @WriteConnection
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">write</span><span class="p">()</span>
    <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// master db</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="connect-to-multiple-databases">Connect to multiple databases</h2>

<p>To receive multiple <code class="language-plaintext highlighter-rouge">PdoExtendedInterface</code> objects with different connection destinations, use <code class="language-plaintext highlighter-rouge">@Named</code> annotation.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @Inject
 * @Named("log_db")
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">setLoggerDb</span><span class="p">(</span><span class="kt">ExtendedPdoInterface</span> <span class="nv">$pdo</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Specify an identifier with <code class="language-plaintext highlighter-rouge">NamedPdoModule</code> and bind it.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">NamedPdoModule</span><span class="p">(</span><span class="s1">'log_db'</span><span class="p">,</span> <span class="s1">'mysql:host=localhost;dbname=log'</span><span class="p">,</span> <span class="s1">'username'</span><span class="p">,</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">NamedPdoModule</span><span class="p">(</span><span class="s1">'job_db'</span><span class="p">,</span> <span class="s1">'mysql:host=localhost;dbname=job'</span><span class="p">,</span> <span class="s1">'username'</span><span class="p">,</span>
</code></pre></div></div>

<p>In the module, you specify an identifier in <code class="language-plaintext highlighter-rouge">NamedPdoModule</code> and bind it.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
  <span class="k">new</span> <span class="nc">NamedPdoModule</span><span class="p">(</span>
    <span class="s1">'log_db'</span><span class="p">,</span> <span class="c1">// Type of database specified by @Named</span>
    <span class="s1">'mysql:host=localhost;dbname=log'</span><span class="p">,</span>
    <span class="s1">'username'</span><span class="p">,</span>
    <span class="s1">'pass'</span><span class="p">,</span>
    <span class="s1">'slave1,slave2'</span> <span class="c1">// specify slave IP as a comma separated value</span>
  <span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<h2 id="transactions">Transactions</h2>

<p>Using the <code class="language-plaintext highlighter-rouge">@Transactional</code> annotation wraps methods with a transaction.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\Annotation\Transactional</span><span class="p">;</span>

<span class="c1">// ....</span>
    <span class="cd">/**
     * @Transactional
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">write</span><span class="p">()</span>
    <span class="p">{</span>
         <span class="c1">// \Ray\AuraSqlModule\Exception\RollbackException thrown if it failed.</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>To do transactions on multiple connected databases, specify properties in the <code class="language-plaintext highlighter-rouge">@Transactional</code> annotation.
If not specified, it becomes <code class="language-plaintext highlighter-rouge">{"pdo"}</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @Transactional({"pdo", "userDb"})
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">write</span><span class="p">()</span>
</code></pre></div></div>

<p>It is run as follows.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">beginTransaction</span><span class="p">()</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">userDb</span><span class="o">-&gt;</span><span class="nf">beginTransaction</span><span class="p">()</span>

<span class="c1">// ...</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">commit</span><span class="p">();</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">userDb</span><span class="o">-&gt;</span><span class="nf">commit</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="aurasqlquery">Aura.SqlQuery</h2>

<p><a href="https://github.com/auraphp/Aura.Sql">Aura.Sql</a> is an extension of PDO. <a href="https://github.com/auraphp/Aura.SqlQuery">Aura.SqlQuery</a> provides database-specific SQL builder for MySQL, Postgres, SQLite or Microsoft SQL Server.</p>

<p>Specify the database and install it with the application module <code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AuraSqlQueryModule</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">));</span> <span class="c1">// pgsql, sqlite, or sqlsrv</span>
</code></pre></div></div>

<h3 id="select">SELECT</h3>

<p>The resource receives the DB Query Builder object and constructs a SELECT query using the following methods.
You can also call the method multiple times in any order.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlInject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlSelectInject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">User</span> <span class="n">extend</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">AuraSqlInject</span><span class="p">;</span>
    <span class="kn">use</span> <span class="nc">AuraSqlSelectInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">select</span>
            <span class="o">-&gt;</span><span class="nf">distinct</span><span class="p">()</span>                    <span class="c1">// SELECT DISTINCT</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>                        <span class="c1">// select these columns</span>
                <span class="s1">'id'</span><span class="p">,</span>                       <span class="c1">// column name</span>
                <span class="s1">'name AS namecol'</span><span class="p">,</span>          <span class="c1">// one way of aliasing</span>
                <span class="s1">'col_name'</span> <span class="o">=&gt;</span> <span class="s1">'col_alias'</span><span class="p">,</span>  <span class="c1">// another way of aliasing</span>
                <span class="s1">'COUNT(foo) AS foo_count'</span>   <span class="c1">// embed calculations directly</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">from</span><span class="p">(</span><span class="s1">'foo AS f'</span><span class="p">)</span>              <span class="c1">// FROM these tables</span>
            <span class="o">-&gt;</span><span class="nf">fromSubselect</span><span class="p">(</span>                <span class="c1">// FROM sub-select AS my_sub</span>
                <span class="s1">'SELECT ...'</span><span class="p">,</span>
                <span class="s1">'my_sub'</span>
            <span class="p">)</span>
            <span class="o">-&gt;</span><span class="nb">join</span><span class="p">(</span>                         <span class="c1">// JOIN ...</span>
                <span class="s1">'LEFT'</span><span class="p">,</span>                     <span class="c1">// left/inner/natural/etc</span>
                <span class="s1">'doom AS d'</span>                 <span class="c1">// this table name</span>
                <span class="s1">'foo.id = d.foo_id'</span>         <span class="c1">// ON these conditions</span>
            <span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">joinSubSelect</span><span class="p">(</span>                <span class="c1">// JOIN to a sub-select</span>
                <span class="s1">'INNER'</span><span class="p">,</span>                    <span class="c1">// left/inner/natural/etc</span>
                <span class="s1">'SELECT ...'</span><span class="p">,</span>               <span class="c1">// the subselect to join on</span>
                <span class="s1">'subjoin'</span>                   <span class="c1">// AS this name</span>
                <span class="s1">'sub.id = foo.id'</span>           <span class="c1">// ON these conditions</span>
            <span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'bar &gt; :bar'</span><span class="p">)</span>           <span class="c1">// AND WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'zim = ?'</span><span class="p">,</span> <span class="s1">'zim_val'</span><span class="p">)</span>   <span class="c1">// bind 'zim_val' to the ? placeholder</span>
            <span class="o">-&gt;</span><span class="nf">orWhere</span><span class="p">(</span><span class="s1">'baz &lt; :baz'</span><span class="p">)</span>         <span class="c1">// OR WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">groupBy</span><span class="p">([</span><span class="s1">'dib'</span><span class="p">])</span>              <span class="c1">// GROUP BY these columns</span>
            <span class="o">-&gt;</span><span class="nf">having</span><span class="p">(</span><span class="s1">'foo = :foo'</span><span class="p">)</span>          <span class="c1">// AND HAVING these conditions</span>
            <span class="o">-&gt;</span><span class="nf">having</span><span class="p">(</span><span class="s1">'bar &gt; ?'</span><span class="p">,</span> <span class="s1">'bar_val'</span><span class="p">)</span>  <span class="c1">// bind 'bar_val' to the ? placeholder</span>
            <span class="o">-&gt;</span><span class="nf">orHaving</span><span class="p">(</span><span class="s1">'baz &lt; :baz'</span><span class="p">)</span>        <span class="c1">// OR HAVING these conditions</span>
            <span class="o">-&gt;</span><span class="nf">orderBy</span><span class="p">([</span><span class="s1">'baz'</span><span class="p">])</span>              <span class="c1">// ORDER BY these columns</span>
            <span class="o">-&gt;</span><span class="nf">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>                     <span class="c1">// LIMIT 10</span>
            <span class="o">-&gt;</span><span class="nf">offset</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>                    <span class="c1">// OFFSET 40</span>
            <span class="o">-&gt;</span><span class="nf">forUpdate</span><span class="p">()</span>                   <span class="c1">// FOR UPDATE</span>
            <span class="o">-&gt;</span><span class="nf">union</span><span class="p">()</span>                       <span class="c1">// UNION with a followup SELECT</span>
            <span class="o">-&gt;</span><span class="nf">unionAll</span><span class="p">()</span>                    <span class="c1">// UNION ALL with a followup SELECT</span>
            <span class="o">-&gt;</span><span class="nf">bindValue</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'foo_val'</span><span class="p">)</span>   <span class="c1">// bind one value to a placeholder</span>
            <span class="o">-&gt;</span><span class="nf">bindValues</span><span class="p">([</span>                  <span class="c1">// bind these values to named placeholders</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar_val'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz_val'</span><span class="p">,</span>
            <span class="p">]);</span>

        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">select</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">());</span>

        <span class="c1">// bind the values and execute</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">select</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">fetch</span><span class="p">(</span><span class="err">\</span><span class="no">PDO</span><span class="o">::</span><span class="no">FETCH_ASSOC</span><span class="p">);</span>
        <span class="c1">// or</span>
        <span class="c1">// $result = $this-&gt;pdo-&gt;fetchAssoc($stm, $bind);</span>
</code></pre></div></div>

<p>The created queries are queried as strings with the <code class="language-plaintext highlighter-rouge">getStatement()</code>.</p>

<h3 id="insert">INSERT</h3>

<h3 id="single-row-insert">Single row INSERT</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlInject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlInsertInject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">User</span> <span class="n">extend</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">AuraSqlInject</span><span class="p">;</span>
    <span class="kn">use</span> <span class="nc">AuraSqlInsertInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span>
            <span class="o">-&gt;</span><span class="nf">into</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>                   <span class="c1">// INTO this table</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>                        <span class="c1">// bind values as "(col) VALUES (:col)"</span>
                <span class="s1">'bar'</span><span class="p">,</span>
                <span class="s1">'baz'</span><span class="p">,</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">)</span>            <span class="c1">// raw value as "(ts) VALUES (NOW())"</span>
            <span class="o">-&gt;</span><span class="nf">bindValue</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'foo_val'</span><span class="p">)</span>   <span class="c1">// bind one value to a placeholder</span>
            <span class="o">-&gt;</span><span class="nf">bindValues</span><span class="p">([</span>                  <span class="c1">// bind these values</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'foo'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'zim'</span><span class="p">,</span>
            <span class="p">]);</span>

        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">());</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>
        <span class="c1">// or</span>
        <span class="c1">// $sth = $this-&gt;pdo-&gt;perform($this-&gt;insert-&gt;getStatement(), this-&gt;insert-&gt;getBindValues());</span>

        <span class="c1">// get the last insert ID</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">getLastInsertIdName</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">lastInsertId</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">cols()</code> method allows you to pass an array of key-value pairs where the key is the column name and the value is a bind value (not a raw value).</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span>
            <span class="o">-&gt;</span><span class="nf">into</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>                   <span class="c1">// insert into this table</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>                        <span class="c1">// insert these columns and bind these values</span>
                <span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="s1">'foo_value'</span><span class="p">,</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar_value'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz_value'</span><span class="p">,</span>
            <span class="p">]);</span>
</code></pre></div></div>

<h3 id="multi-line-insert">Multi-line INSERT</h3>

<p>To do a multiple row INSERT, use the <code class="language-plaintext highlighter-rouge">addRow ()</code> method at the end of the first line. Then build the following query.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">// insert into this table</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">into</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">);</span>

        <span class="c1">// set up the first row</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>
            <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-0'</span><span class="p">,</span>
            <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-0'</span>
        <span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">);</span>

        <span class="c1">// set up the second row. the columns here are in a different order</span>
        <span class="c1">// than in the first row, but it doesn't matter; the INSERT object</span>
        <span class="c1">// keeps track and builds them the same order as the first row.</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">addRow</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>
            <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-1'</span><span class="p">,</span>
            <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-1'</span>
        <span class="p">]);</span>

        <span class="c1">// set up further rows ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">addRow</span><span class="p">();</span>
        <span class="c1">// ...</span>

        <span class="c1">// execute a bulk insert of all rows</span>
        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">());</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>

</code></pre></div></div>

<blockquote>
  <p>Note: If you try to add a row without specifying the value of the first column in the first row, an exception will be thrown.
Passing an associative array of columns to <code class="language-plaintext highlighter-rouge">addRow()</code> will be used on the next line. That is, you can not specify <code class="language-plaintext highlighter-rouge">col()</code> or <code class="language-plaintext highlighter-rouge">cols()</code> on the first line.</p>
</blockquote>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">// set up the first row</span>
        <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">addRow</span><span class="p">([</span>
            <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-0'</span><span class="p">,</span>
            <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-0'</span>
        <span class="p">]);</span>
        <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">);</span>

        <span class="c1">// set up the second row</span>
        <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">addRow</span><span class="p">([</span>
            <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-1'</span><span class="p">,</span>
            <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-1'</span>
        <span class="p">]);</span>
        <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">);</span>

        <span class="c1">// etc.</span>
</code></pre></div></div>

<p>You can also set the database at once using <code class="language-plaintext highlighter-rouge">addRows()</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nv">$rows</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-0'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-0'</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-1'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-1'</span>
            <span class="p">],</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">addRows</span><span class="p">(</span><span class="nv">$rows</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="update">UPDATE</h3>
<p>Use the following methods to construct an UPDATE query. You can also call the method multiple times in any order.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">update</span>
            <span class="o">-&gt;</span><span class="nf">table</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>                  <span class="c1">// update this table</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>                        <span class="c1">// bind values as "SET bar = :bar"</span>
                <span class="s1">'bar'</span><span class="p">,</span>
                <span class="s1">'baz'</span><span class="p">,</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">)</span>            <span class="c1">// raw value as "(ts) VALUES (NOW())"</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'zim = :zim'</span><span class="p">)</span>           <span class="c1">// AND WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'gir = ?'</span><span class="p">,</span> <span class="s1">'doom'</span><span class="p">)</span>      <span class="c1">// bind this value to the condition</span>
            <span class="o">-&gt;</span><span class="nf">orWhere</span><span class="p">(</span><span class="s1">'gir = :gir'</span><span class="p">)</span>         <span class="c1">// OR WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">bindValue</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'bar_val'</span><span class="p">)</span>   <span class="c1">// bind one value to a placeholder</span>
            <span class="o">-&gt;</span><span class="nf">bindValues</span><span class="p">([</span>                  <span class="c1">// bind these values to the query</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="mi">99</span><span class="p">,</span>
                <span class="s1">'zim'</span> <span class="o">=&gt;</span> <span class="s1">'dib'</span><span class="p">,</span>
                <span class="s1">'gir'</span> <span class="o">=&gt;</span> <span class="s1">'doom'</span><span class="p">,</span>
            <span class="p">]);</span>
        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$update</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">())</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">update</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>
        <span class="c1">// or</span>
        <span class="c1">// $sth = $this-&gt;pdo-&gt;perform($this-&gt;update-&gt;getStatement(), $this-&gt;update-&gt;getBindValues());</span>
</code></pre></div></div>

<p>You can also pass an associative array to <code class="language-plaintext highlighter-rouge">cols()</code> with the key as the column name and the value as the bound value (not the RAW value).</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
        <span class="nv">$this</span><span class="o">-</span><span class="n">update</span><span class="o">-&gt;</span><span class="nf">table</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>          <span class="c1">// update this table</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>                        <span class="c1">// update these columns and bind these values</span>
                <span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="s1">'foo_value'</span><span class="p">,</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar_value'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz_value'</span><span class="p">,</span>
            <span class="p">]);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<h3 id="delete">DELETE</h3>
<p>Use the following methods to construct a DELETE query. You can also call the method multiple times in any order.</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">delete</span>
            <span class="o">-&gt;</span><span class="nf">from</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>                   <span class="c1">// FROM this table</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'zim = :zim'</span><span class="p">)</span>           <span class="c1">// AND WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'gir = ?'</span><span class="p">,</span> <span class="s1">'doom'</span><span class="p">)</span>      <span class="c1">// bind this value to the condition</span>
            <span class="o">-&gt;</span><span class="nf">orWhere</span><span class="p">(</span><span class="s1">'gir = :gir'</span><span class="p">)</span>         <span class="c1">// OR WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">bindValue</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'bar_val'</span><span class="p">)</span>   <span class="c1">// bind one value to a placeholder</span>
            <span class="o">-&gt;</span><span class="nf">bindValues</span><span class="p">([</span>                  <span class="c1">// bind these values to the query</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="mi">99</span><span class="p">,</span>
                <span class="s1">'zim'</span> <span class="o">=&gt;</span> <span class="s1">'dib'</span><span class="p">,</span>
                <span class="s1">'gir'</span> <span class="o">=&gt;</span> <span class="s1">'doom'</span><span class="p">,</span>
            <span class="p">]);</span>
        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$update</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">())</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">delete</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>
</code></pre></div></div>

<h3 id="pagination-1">Pagination</h3>

<p><a href="https://packagist.org/packages/ray/aura-sql-module">ray/aura-sql-module</a> supports pagination (page splitting) in both Ray.Sql raw SQL and Ray.AuraSqlQuery query builder.
We create a pager using the <code class="language-plaintext highlighter-rouge">newInstance()</code> with a uri_template, binding values and the number of items per page. You can access the page by $page[$number].</p>

<h3 id="aurasql-1">Aura.Sql</h3>
<p>AuraSqlPagerFactoryInterface</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* @var $factory \Ray\AuraSqlModule\Pagerfanta\AuraSqlPagerFactoryInterface */</span>
<span class="nv">$pager</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="nf">newInstance</span><span class="p">(</span><span class="nv">$pdo</span><span class="p">,</span> <span class="nv">$sql</span><span class="p">,</span> <span class="nv">$params</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">'/?page={page}&amp;category=sports'</span><span class="p">);</span> <span class="c1">// 10 items per page</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nv">$pager</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// page 2</span>
<span class="cm">/* @var $page \Ray\AuraSqlModule\Pagerfanta\Page */</span>
<span class="c1">// $page-&gt;data // sliced data (array|\Traversable)</span>
<span class="c1">// $page-&gt;current; (int)</span>
<span class="c1">// $page-&gt;total (int)</span>
<span class="c1">// $page-&gt;hasNext (bool)</span>
<span class="c1">// $page-&gt;hasPrevious (bool)</span>
<span class="c1">// $page-&gt;maxPerPage; (int)</span>
<span class="c1">// (string) $page // pager html (string)</span>
</code></pre></div></div>

<h2 id="aurasqlquery-1">Aura.SqlQuery</h2>
<p>AuraSqlQueryPagerFactoryInterface</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// for Select</span>
<span class="cm">/* @var $factory \Ray\AuraSqlModule\Pagerfanta\AuraSqlQueryPagerFactoryInterface */</span>
<span class="nv">$pager</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="nf">newInstance</span><span class="p">(</span><span class="nv">$pdo</span><span class="p">,</span> <span class="nv">$select</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">'/?page={page}&amp;category=sports'</span><span class="p">);</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nv">$pager</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// page 2</span>
<span class="cm">/* @var $page \Ray\AuraSqlModule\Pagerfanta\Page */</span>
</code></pre></div></div>
<blockquote>
  <p>Note: Although the Aura.Sql edits the raw SQL directly, it currently only supports the MySQL LIMIT clause format.</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">$page</code> is iterable.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">foreach</span> <span class="p">(</span><span class="nv">$page</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
 <span class="c1">// Process each row</span>
<span class="p">}</span>
</code></pre></div></div>
<p>To change the pager HTML template, change the binding of <code class="language-plaintext highlighter-rouge">TemplateInterface</code>.
For details about templates, please see <a href="https://github.com/whiteoctober/Pagerfanta#views">Pagerfanta</a>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Pagerfanta\View\Template\TemplateInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Pagerfanta\View\Template\TwitterBootstrap3Template</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\Annotation\PagerViewOption</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">TemplateInterface</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nc">TwitterBootstrap3Template</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">PagerViewOption</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="nv">$pagerViewOption</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="doctrine-dbal">Doctrine DBAL</h2>

<p><a href="http://www.doctrine-project.org/projects/dbal.html">Doctrine DBAL</a> is also abstraction layer for database.</p>

<p>Install <code class="language-plaintext highlighter-rouge">Ray.DbalModule</code> with composer.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require ray/dbal-module
</code></pre></div></div>

<p>Install <code class="language-plaintext highlighter-rouge">DbalModule</code> in application module.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\DbalModule\DbalModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">DbalModule</span><span class="p">(</span><span class="s1">'driver=pdo_sqlite&amp;memory=true'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>New DI bindings are now ready and <code class="language-plaintext highlighter-rouge">$this-&gt;db</code> can be injected with the <code class="language-plaintext highlighter-rouge">DbalInject</code> trait.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\DbalModule\DbalInject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">DbalInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">;</span> <span class="c1">// \Doctrine\DBAL\Driver\Connection</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="connect-to-multiple-databases-1">Connect to multiple databases</h3>

<p>To connect to multiple databases, specify the identifier as the second argument.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">DbalModule</span><span class="p">(</span><span class="nv">$logDsn</span><span class="p">,</span> <span class="s1">'log_db'</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">DbalModule</span><span class="p">(</span><span class="nv">$jobDsn</span><span class="p">,</span> <span class="s1">'job_db'</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @Inject
 * @Named("log_db")
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">setLogDb</span><span class="p">(</span><span class="kt">Connection</span> <span class="nv">$logDb</span><span class="p">)</span>
</code></pre></div></div>

<p><a href="http://www.doctrine-project.org/api/dbal/2.0/class-Doctrine.DBAL.Connections.MasterSlaveConnection.html">MasterSlaveConnection</a> is provided for master/slave connections.</p>

<h2 id="cakedb">CakeDb</h2>

<p><strong>CakeDb</strong> is an ORM using the active record and data mapper pattern idea. It is the same as the one provided in CakePHP3.</p>

<p>Install <code class="language-plaintext highlighter-rouge">Ray.CakeDbModule</code> with composer.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require ray/cake-database-module ~1.0
</code></pre></div></div>

<p>Please refer to <a href="https://github.com/ray-di/Ray.CakeDbModule">Ray.CakeDbModule</a> for installation and refer to <a href="http://book.cakephp.org/3.0/en/orm.html">CakePHP3 Database Access &amp; ORM</a> for the ORM usage.</p>

<p>Ray.CakeDbModule is provided by Jose (<a href="https://github.com/lorenzo">@lorenzo</a>) who developed the ORM of CakePHP3.</p>

<h2 id="connection-settings">Connection settings</h2>

<p>Use the <a href="https://github.com/vlucas/phpdotenv">phpdotenv</a> library etc. to set the connection according to the environment destination. Please see the <a href="https://github.com/BEARSunday/Ex.Package">Ex.Package</a> for implementation.</p>

<h1 id="di">DI</h1>

<p>Dependency injection is basically providing the objects that an object needs (its dependencies) instead of having it construct them itself.</p>

<p>With dependency injection, objects accept dependencies in their constructors. To construct an object, you first build its dependencies. But to build each dependency, you need its dependencies, and so on. So when you build an object, you really need to build an object graph.</p>

<p>Building object graphs by hand is labour intensive, error prone, and makes testing difficult. Instead, <strong>Dependency Injector</strong> (<a href="https://github.com/ray-di/Ray.Di">Ray.Di</a>) can build the object graph for you.</p>

<table>
  <tbody>
    <tr>
      <td>What is object graph ?</td>
    </tr>
    <tr>
      <td>Object-oriented applications contain complex webs of interrelated objects. Objects are linked to each other by one object either owning or containing another object or holding a reference to another object. This web of objects is called an object graph and it is the more abstract structure that can be used in discussing an application’s state. - <a href="http://en.wikipedia.org/wiki/Object_graph">Wikipedia</a></td>
    </tr>
  </tbody>
</table>

<p>Ray.Di is the core DI framework used in BEAR.Sunday, which is heavily inspired by Google <a href="http://code.google.com/p/google-guice/wiki/Motivation?tm=6">Guice</a> DI framework.See more detail at <a href="https://ray-di.github.io/manuals/1.0/en/index.html">Ray.Di Manual</a>.</p>

<h1 id="examples">Examples</h1>

<p>This example application is built on the principles described in the <a href="http://bearsunday.github.io/manuals/1.0/en/coding-guide.html">Coding Guide</a>.</p>

<h2 id="polidogtodo">Polidog.Todo</h2>

<p><a href="https://github.com/koriym/Polidog.Todo">https://github.com/koriym/Polidog.Todo</a></p>

<p><code class="language-plaintext highlighter-rouge">Todos</code> is a basic CRUD application. The DB is accessed using the static　SQL file in the <code class="language-plaintext highlighter-rouge">var/sql</code> directory. Includes REST API using hyperlinks and testing, as well as form validation tests.</p>

<ul>
  <li><a href="https://github.com/ray-di/Ray.AuraSqlModule">ray/aura-sql-module</a> - Extended PDO (<a href="https://github.com/auraphp/Aura.Sql">Aura.Sql</a>)</li>
  <li><a href="https://github.com/ray-di/Ray.WebFormModule">ray/web-form-module</a> - Web form (<a href="https://github.com/auraphp/Aura.Input">Aura.Input</a>)</li>
  <li><a href="https://github.com/madapaja/Madapaja.TwigModule">madapaja/twig-module</a> - Twig template engine</li>
  <li><a href="https://github.com/koriym/Koriym.Now">koriym/now</a> - Current datetime</li>
  <li><a href="https://github.com/koriym/Koriym.QueryLocator">koriym/query-locator</a> - SQL locator</li>
  <li><a href="https://github.com/koriym/Koriym.HttpConstants">koriym/http-constants</a> - Contains the values HTTP</li>
</ul>

<h2 id="myvendorcontactform">MyVendor.ContactForm</h2>

<p><a href="https://github.com/bearsunday/MyVendor.ContactForm">https://github.com/bearsunday/MyVendor.ContactForm</a></p>

<p>It is a sample of various form pages.</p>

<ul>
  <li>Minimal form page</li>
  <li>Multiple forms page</li>
  <li>Looped input form page</li>
  <li>Preview form page including checkbox and radio button</li>
</ul>

<h1 id="form">Form</h1>

<p>Each related function of Web Forms using <a href="https://github.com/auraphp/Aura.Input">Aura.Input</a> and <a href="https://github.com/auraphp/Aura.Filter">Aura.Filter</a> is aggregated to a single class so that it is easy to test and change.
We can use a corresponding class for the use of Web Forms and validation.</p>

<h2 id="install">Install</h2>

<p>Install <code class="language-plaintext highlighter-rouge">ray/web-form-module</code> via composer to add form using Aura.Input</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require ray/web-form-module
</code></pre></div></div>

<p>Install <code class="language-plaintext highlighter-rouge">AuraInputModule</code> in our application module <code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebFormModule\WebFormModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AuraInputModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="web-form">Web Form</h2>

<p>Create <strong>a form class</strong> that defines the registration and the rules of form elements, then bind it to a method using <code class="language-plaintext highlighter-rouge">@FormValidation</code> annotation.
The method runs only when the sent data is validated.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\WebFormModule\AbstractForm</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebFormModule\SetAntiCsrfTrait</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyForm</span> <span class="kd">extends</span> <span class="nc">AbstractForm</span>
<span class="p">{</span>
    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">init</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// set input fields</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">setField</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'text'</span><span class="p">)</span>
             <span class="o">-&gt;</span><span class="nf">setAttribs</span><span class="p">([</span>
                 <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="s1">'name'</span>
             <span class="p">]);</span>
        <span class="c1">// set rules and user defined error message</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="nf">validate</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">is</span><span class="p">(</span><span class="s1">'alnum'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="nf">useFieldMessage</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'Name must be alphabetic only.'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can register the input elements in the <code class="language-plaintext highlighter-rouge">init()</code> method of the form class and apply the rules of validation and sanitation.
Please refer to <a href="https://github.com/auraphp/Aura.Filter/blob/2.x/docs/validate.md">Rules To Validate Fields</a> of Aura.Filter with respect to validation rules, and <a href="https://github.com/auraphp/Aura.Filter/blob/2.x/docs/sanitize.md">Rules To Sanitize Fields</a> with respect to sanitize rules.</p>

<p>We validate an associative array of the argument of the method.
If we want to change the input, we can set the values by implementing <code class="language-plaintext highlighter-rouge">submit()</code> method of <code class="language-plaintext highlighter-rouge">SubmitInterface</code> interface.</p>

<h2 id="formvalidation-annotation">@FormValidation Annotation</h2>

<p>Annotate the method that we want to validate with the <code class="language-plaintext highlighter-rouge">@FormValidation</code>, so that the validation is done in the form object specified by the <code class="language-plaintext highlighter-rouge">form</code> property before execution.
When validation fails, the method with the <code class="language-plaintext highlighter-rouge">ValidationFailed</code> suffix is called.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Di\Di\Inject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\Di\Named</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebFormModule\Annotation\FormValidation</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebFormModule\FormInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyController</span>
<span class="p">{</span>
    <span class="cd">/**
     * @var FormInterface
     */</span>
    <span class="k">protected</span> <span class="nv">$form</span><span class="p">;</span>

    <span class="cd">/**
     * @Inject
     * @Named("contact_form")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">setForm</span><span class="p">(</span><span class="kt">FormInterface</span> <span class="nv">$form</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">form</span> <span class="o">=</span> <span class="nv">$form</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @FormValidation
     * // or
     * @FormValidation(form="form", onFailure="onPostValidationFailed")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$age</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// validation success</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onPostValidationFailed</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$age</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// validation failed</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can explicitly specify the name and the method by changing the <code class="language-plaintext highlighter-rouge">form</code> property of <code class="language-plaintext highlighter-rouge">@FormValidation</code> annotation or the <code class="language-plaintext highlighter-rouge">onValidationFailed</code> property.</p>

<p>The submit parameters will be passed to the <code class="language-plaintext highlighter-rouge">onPostValidationFailed</code> method.</p>

<h2 id="view">View</h2>

<p>Specify the element name to get the <code class="language-plaintext highlighter-rouge">input</code> elements and error messages</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$form</span><span class="o">-&gt;</span><span class="nf">input</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span> <span class="c1">// &lt;input id="name" type="text" name="name" size="20" maxlength="20" /&gt;</span>
  <span class="nv">$form</span><span class="o">-&gt;</span><span class="nf">error</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span> <span class="c1">// "Please enter a double-byte characters or letters in the name." or blank</span>
</code></pre></div></div>

<p>The same applies to Twig template</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{{</span> <span class="n">form</span><span class="mf">.</span><span class="nf">input</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span> <span class="p">}}</span>
<span class="p">{{</span> <span class="n">form</span><span class="mf">.</span><span class="nf">error</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span> <span class="p">}}</span>
</code></pre></div></div>

<h2 id="csrf-protections">CSRF Protections</h2>

<p>We can add a CSRF(Cross site request forgeries) object to the form to apply CSRF protections.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\WebFormModule\SetAntiCsrfTrait</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyForm</span> <span class="kd">extends</span> <span class="nc">AbstractAuraForm</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">SetAntiCsrfTrait</span><span class="p">;</span>
</code></pre></div></div>

<p>In order to increase the security level, add a custom CSRF class that contains the user authentication to the form class.
Please refer to the <a href="https://github.com/auraphp/Aura.Input#applying-csrf-protections">Applying CSRF Protections</a> of Aura.Input for more information.</p>

<h2 id="inputvalidation-annotation">@InputValidation annotation</h2>

<p>If we annotate the method with <code class="language-plaintext highlighter-rouge">@InputValidation</code> instead of <code class="language-plaintext highlighter-rouge">@FormValidation</code>, the exception <code class="language-plaintext highlighter-rouge">Ray\WebFormModule\Exception\ValidationException</code> is thrown when validation fails.
For convenience, HTML representation is not used in this case.</p>

<p>When we <code class="language-plaintext highlighter-rouge">echo</code> the <code class="language-plaintext highlighter-rouge">error</code> property of the caught exception, we can see the representation of the media type <a href="https://github.com/blongden/vnd.error">application/vnd.error+json</a>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">http_response_code</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
<span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>

<span class="c1">// {</span>
<span class="c1">//     "message": "Validation failed",</span>
<span class="c1">//     "path": "/path/to/error",</span>
<span class="c1">//     "validation_messages": {</span>
<span class="c1">//         "name": [</span>
<span class="c1">//             "Please enter a double-byte characters or letters in the name."</span>
<span class="c1">//         ]</span>
<span class="c1">//     }</span>
<span class="c1">// }</span>
</code></pre></div></div>

<p>We can add the necessary information to <code class="language-plaintext highlighter-rouge">vnd.error+json</code> using <code class="language-plaintext highlighter-rouge">@VndError</code> annotation.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @FormValidation(form="contactForm")
 * @VndError(
 *   message="foo validation failed",
 *   logref="a1000", path="/path/to/error",
 *   href={"_self"="/path/to/error", "help"="/path/to/help"}
 * )
 */</span>
 <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="formvnderrormodule">FormVndErrorModule</h2>

<p>If we install <code class="language-plaintext highlighter-rouge">Ray\WebFormModule\FormVndErrorModule</code>, the method annotated with <code class="language-plaintext highlighter-rouge">@FormValidation</code>
will throw an exception in the same way as the method annotated with <code class="language-plaintext highlighter-rouge">@InputValidation</code>.
We can use the page resources as API.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">FooModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AuraInputModule</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">override</span><span class="p">(</span><span class="k">new</span> <span class="nc">FormVndErrorModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="demo">Demo</h2>

<p>Try the demo app <a href="https://github.com/bearsunday/MyVendor.ContactForm">MyVendor.ContactForm</a> to get an idea on how forms such as
a confirmation form and multiple forms in a single page work.</p>

<h1 id="html-qiq">HTML (Qiq)</h1>

<h2 id="setup">Setup</h2>

<p>Install <code class="language-plaintext highlighter-rouge">bear/qiq-module</code> in composer to get HTML view in Qiq.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require bear/qiq-module
</code></pre></div></div>

<p>Next, Provide a directory to store templates and helpers.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /path/to/project
cp -r vendor/bear/qiq-module/var/qiq var
</code></pre></div></div>

<p>Provide the <code class="language-plaintext highlighter-rouge">html</code> context file <code class="language-plaintext highlighter-rouge">src/Module/HtmlModule.php</code> and install <code class="language-plaintext highlighter-rouge">QiqModule</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">MyVendor\MyPackage\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\QiqModule\QiqModule</span><span class="p">;</span>


<span class="kd">class</span> <span class="nc">HtmlModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">QiqModule</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">appMeta</span><span class="o">-&gt;</span><span class="n">appDir</span> <span class="mf">.</span> <span class="s1">'/var/qiq/template'</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span><span class="sb">```

## Change context

Change the context of `</span><span class="n">bin</span><span class="o">/</span><span class="n">page</span><span class="mf">.</span><span class="n">php</span><span class="sb">` to enable `</span><span class="n">html</span><span class="sb">`.

```</span><span class="n">bash</span>
<span class="nv">$context</span> <span class="o">=</span> <span class="s1">'cli-html-app'</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="template">Template</h2>

<p>Prepare the template for the Index resource in <code class="language-plaintext highlighter-rouge">var/qiq/template/Page/Index.php</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;h1&gt;{{h $this-&gt;greeting }}&lt;/h1&gt;
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">$body</code> of the ResourceObject will be assigned to the template as <code class="language-plaintext highlighter-rouge">$this</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/page.php get /
200 OK
content-type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8

&lt;h1&gt;Hello BEAR.Sunday&lt;/h1&gt;
</code></pre></div></div>

<h2 id="custom-helper">Custom helper</h2>

<p><a href="https://qiqphp-ja.github.io/1.x/helpers/custom.html#1-8-4">Custom Helpers</a> will be created in the <code class="language-plaintext highlighter-rouge">Qiq\Helper\</code> namespace. Example: <code class="language-plaintext highlighter-rouge">Qiq\Helper\Foo</code>.</p>

<p>Specify the <code class="language-plaintext highlighter-rouge">Qiq\Helper</code> in the <code class="language-plaintext highlighter-rouge">autoload</code> of composer.json (e.g: <a href="https://github.com/bearsunday/BEAR.QiqModule/blob/1.x/demo/composer.json#L26">composer.json</a>) and run <code class="language-plaintext highlighter-rouge">composr dump-autoload</code> to enable to autoload the custom helper class. Custom helpers placed in the specified directory will be made available.</p>

<h2 id="prodmodule">ProdModule</h2>

<p>Install a module in ProdModule to make the error page HTML for production and to enable compiler cache.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ProdModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">QiqErrorModule</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">QiqProdModule</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">appDir</span> <span class="mf">.</span> <span class="s1">'/var/tmp'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="html-twig-v1">HTML (Twig v1)</h1>

<p>In order to have an HTML reprensentation lets install <code class="language-plaintext highlighter-rouge">madapaja/twig-module</code> with composer.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require madapaja/twig-module ^1.0
</code></pre></div></div>

<p>Next create the context file <code class="language-plaintext highlighter-rouge">src/Module/HtmlModule.php</code> and install the <code class="language-plaintext highlighter-rouge">TwigModule</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">MyVendor\MyPackage\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\AppMeta\AppMeta</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\TwigModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">HtmlModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Update the context in <code class="language-plaintext highlighter-rouge">bin/page.php</code> and enable <code class="language-plaintext highlighter-rouge">html</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$context</span> <span class="o">=</span> <span class="s1">'cli-html-app'</span><span class="p">;</span>
</code></pre></div></div>
<p>We prepare twig templates by placing them in the same directory as the <code class="language-plaintext highlighter-rouge">page resource</code> that you want to bind it to. Replace the <code class="language-plaintext highlighter-rouge">.php</code> suffix with <code class="language-plaintext highlighter-rouge">.html.twig</code>. So a template for the <code class="language-plaintext highlighter-rouge">Page/Index.php</code> resource would be <code class="language-plaintext highlighter-rouge">Page/Index.html.twig</code>.</p>

<pre><code class="language-hml">&lt;h1&gt;{{ greeting }}&lt;/h1&gt;
</code></pre>

<p>The <code class="language-plaintext highlighter-rouge">$body</code> in a resource is assigned to the template and then rendered.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/page.php get /
200 OK
content-type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8

&lt;h1&gt;Hello BEAR.Sunday&lt;/h1&gt;
</code></pre></div></div>

<p>By default partials and template files are found in <code class="language-plaintext highlighter-rouge">var/lib/twig</code>.</p>

<h2 id="custom-settings">Custom Settings</h2>

<p>If you would like to change options depending on the context or add a template path, configuration values are bound to <code class="language-plaintext highlighter-rouge">@TwigPaths</code>and <code class="language-plaintext highlighter-rouge">@TwigOptions</code> annotations.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">MyVendor\MyPackage\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\Annotation\TwigOptions</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\Annotation\TwigPaths</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\TwigModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigModule</span><span class="p">());</span>

        <span class="c1">// You can add twig template paths by the following</span>
        <span class="nv">$appDir</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">));</span>
        <span class="nv">$paths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/src/Resource'</span><span class="p">,</span>
            <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/var/lib/twig'</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">TwigPaths</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="nv">$paths</span><span class="p">);</span>

        <span class="c1">// Also you can set environment options</span>
        <span class="c1">// @see http://twig.sensiolabs.org/doc/api.html#environment-options</span>
        <span class="nv">$options</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'debug'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
            <span class="s1">'cache'</span> <span class="o">=&gt;</span> <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/tmp'</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">TwigOptions</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="other-template-engines">Other template engines</h2>

<p>You can not only select a template engine, but you can also provide multiple template engines and assign them to different resources.</p>

<h1 id="html-twig-v2">HTML (Twig v2)</h1>

<h2 id="install-1">Install</h2>

<p>In order to have an HTML reprensentation, Let’s install <a href="https://twig.symfony.com/doc/2.x/">Twig v2</a> module with composer.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require madapaja/twig-module ^2.0
</code></pre></div></div>

<p>Next create the context file <code class="language-plaintext highlighter-rouge">src/Module/HtmlModule.php</code> and install the <code class="language-plaintext highlighter-rouge">TwigModule</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">MyVendor\MyPackage\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\AppMeta\AppMeta</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\TwigErrorPageModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\TwigModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\AbstractModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">HtmlModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigModule</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigErrorPageModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Update the context in <code class="language-plaintext highlighter-rouge">bin/page.php</code> or <code class="language-plaintext highlighter-rouge">public/index.php</code> and enable <code class="language-plaintext highlighter-rouge">html</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$context</span> <span class="o">=</span> <span class="s1">'cli-html-app'</span><span class="p">;</span> // or <span class="s1">'html-app'</span>
</code></pre></div></div>
<h2 id="template-1">Template</h2>

<p>One template file is required for one resource object class in <code class="language-plaintext highlighter-rouge">var/templates</code> directory to represent in HTML.
For example, for <code class="language-plaintext highlighter-rouge">src/Page/Index.php</code> resource class, a template file is required in <code class="language-plaintext highlighter-rouge">var/templates/Page/Index.html.twig</code>.</p>

<p>The body of the resource is assigned to the template.</p>

<p>example）</p>

<p><code class="language-plaintext highlighter-rouge">src/Page/Index.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$body</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'greeting'</span> <span class="o">=&gt;</span> <span class="s1">'Hello BEAR.Sunday'</span>
    <span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">var/templates/Page/Index.twig.php</code></p>

<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">greeting</span> <span class="cp">}}</span><span class="nt">&lt;/h1&gt;</span>
</code></pre></div></div>

<p>Output:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/page.php get /
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
content-type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8

&lt;h1&gt;Hello BEAR.Sunday&lt;/h1&gt;
</code></pre></div></div>
<h2 id="select-template-file">Select template file</h2>

<p>Resource does not select the template file. It <code class="language-plaintext highlighter-rouge">includes</code> depending on the state of the resource.</p>

<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.is_login</span> <span class="cp">%}</span>
    <span class="cp">{{</span> <span class="nv">include</span><span class="p">(</span><span class="s1">'member.html.twig'</span><span class="p">)</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
    <span class="cp">{{</span> <span class="nv">include</span><span class="p">(</span><span class="s1">'guest.html.twig'</span><span class="p">)</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
</code></pre></div></div>

<p>In the resource class, you should only concern resource state. Then template should concern the resource representation.
See <a href="https://en.wikipedia.org/wiki/Separation_of_concerns">Separation of concerns (SoC)</a>.</p>

<h2 id="error-page">Error Page</h2>

<p>Edit <code class="language-plaintext highlighter-rouge">var/templates/error.html.twig</code>. Following values are assigned to the error page.</p>

<table>
  <tbody>
    <tr>
      <td>Variable</td>
      <td>Title</td>
      <td>Key</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>status</td>
      <td>HTTP status</td>
      <td>code, message</td>
    </tr>
    <tr>
      <td>e</td>
      <td>Exception</td>
      <td>code, message, class</td>
    </tr>
    <tr>
      <td>logref</td>
      <td>Log ID</td>
      <td>n/a</td>
    </tr>
  </tbody>
</table>

<p>例</p>

<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'layout/base.html.twig'</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}{{</span> <span class="nv">status.code</span> <span class="cp">}}</span> <span class="cp">{{</span> <span class="nv">status.message</span> <span class="cp">}}{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
    <span class="nt">&lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">status.code</span> <span class="cp">}}</span> <span class="cp">{{</span> <span class="nv">status.message</span> <span class="cp">}}</span><span class="nt">&lt;/h1&gt;</span>
    <span class="cp">{%</span> <span class="k">if</span> <span class="nv">status.code</span> <span class="o">==</span> <span class="nv">404</span> <span class="cp">%}</span>
        <span class="nt">&lt;p&gt;</span>The requested URL was not found on this server.<span class="nt">&lt;/p&gt;</span>
    <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
        <span class="nt">&lt;p&gt;</span>The server is temporarily unable to service your request.<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>refference number: <span class="cp">{{</span> <span class="nv">logref</span> <span class="cp">}}</span><span class="nt">&lt;/p&gt;</span>
    <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</code></pre></div></div>

<h2 id="assign-resource">Assign resource</h2>

<p>To refer to the properties of the resource object class, Use <code class="language-plaintext highlighter-rouge">_ro</code> (resource object) to which the entire resource object is assigned</p>

<p>exmaple）</p>

<p><code class="language-plaintext highlighter-rouge">Todos.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Todos</span> <span class="n">extend</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$code</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$text</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'BEAR'</span>
    <span class="p">];</span>

    <span class="k">public</span> <span class="nv">$body</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'run'</span><span class="p">]</span>
    <span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Todos.html.twig</code></p>

<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{{</span> <span class="nv">_ro.code</span> <span class="cp">}}</span> // 200
<span class="cp">{{</span> <span class="nv">_ro.text.name</span> <span class="cp">}}</span> // 'BEAR'
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">todo</span> <span class="ow">in</span> <span class="nv">_ro.body</span> <span class="cp">%}</span>
  <span class="cp">{{</span> <span class="nv">todo.title</span> <span class="cp">}}</span> // 'run'
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</code></pre></div></div>

<h2 id="hierarchical-view-structure">Hierarchical view structure</h2>

<p>You can have a view on a resource class basis. It represents the structure well. Also, the cache is also hierarchically done on a resource basis, so it is efficient.</p>

<p>example) <code class="language-plaintext highlighter-rouge">page://self/index</code> which embeds <code class="language-plaintext highlighter-rouge">app://self/todos</code></p>

<h3 id="appselftodos">app://self/todos</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Todos</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">AuraSqlInject</span><span class="p">;</span>
    <span class="kn">use</span> <span class="nc">QueryLocatorInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">fetchAll</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">[</span><span class="s1">'todos_list'</span><span class="p">]);</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{%</span> <span class="k">for</span> <span class="nv">todo</span> <span class="ow">in</span> <span class="nv">_ro.body</span> <span class="cp">%}</span>
  <span class="cp">{{</span> <span class="nv">todo.title</span> <span class="cp">}}</span><span class="nt">&lt;/td&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</code></pre></div></div>

<h3 id="pageselfindex">page://self/index</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="cd">/**
     * @Embed(rel="todos", src="app://self/todos")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'layout/base.html.twig'</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
  <span class="cp">{{</span> <span class="nv">todos</span><span class="o">|</span><span class="nf">raw</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</code></pre></div></div>

<h2 id="extending-twig">Extending Twig</h2>

<p>When you extend Twig with the <code class="language-plaintext highlighter-rouge">addExtension()</code> method, prepare Twig’s Provider class which performs extension and bind <code class="language-plaintext highlighter-rouge">Provider</code> to <code class="language-plaintext highlighter-rouge">Twig_Environment</code> class.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Di\Di\Named</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\ProviderInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyTwigProvider</span> <span class="kd">implements</span> <span class="nc">ProviderInterface</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$twig</span><span class="p">;</span>

    <span class="cd">/**
     * @Named("original")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="err">\</span><span class="n">Twig_Environment</span> <span class="nv">$twig</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// $twig is an original \Twig_Environment instance</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">twig</span> <span class="o">=</span> <span class="nv">$twig</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">get</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Extending Twig</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">twig</span><span class="o">-&gt;</span><span class="nf">addExtension</span><span class="p">(</span><span class="k">new</span> <span class="nc">MyTwigExtension</span><span class="p">());</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">twig</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">HtmlModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigModule</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="err">\</span><span class="n">Twig_Environment</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toProvider</span><span class="p">(</span><span class="nc">MyTwigProvider</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">in</span><span class="p">(</span><span class="nc">Scope</span><span class="o">::</span><span class="no">SINGLETON</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="template-for-mobile-device">Template for mobile device</h2>

<p>To use the template for mobile devices, install <code class="language-plaintext highlighter-rouge">MobileTwigModule</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">HtmlModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigModule</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">MobileTwigModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If <strong>there is</strong> a mobile site template <code class="language-plaintext highlighter-rouge">Index.mobile.twig</code> that will replace <code class="language-plaintext highlighter-rouge">Index.html.twig</code>, it will be used in preference.</p>

<h2 id="custom-settings-1">Custom Settings</h2>

<p>If you would like to change options depending on the context or add a template path, configuration values are bound to <code class="language-plaintext highlighter-rouge">@TwigPaths</code>and <code class="language-plaintext highlighter-rouge">@TwigOptions</code> annotations.</p>

<p>Note: Since caches are always created in the <code class="language-plaintext highlighter-rouge">var/tmp</code> folder, there is no particular need for special settings for production.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">MyVendor\MyPackage\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\Annotation\TwigDebug</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\Annotation\TwigOptions</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\Annotation\TwigPaths</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\TwigModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigModule</span><span class="p">);</span>

        <span class="c1">// You can add twig template paths by the following</span>
        <span class="nv">$appDir</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">appMeta</span><span class="o">-&gt;</span><span class="n">appDir</span><span class="p">;</span>
        <span class="nv">$paths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/src/Resource'</span><span class="p">,</span>
            <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/var/templates'</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">TwigPaths</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="nv">$paths</span><span class="p">);</span>

        <span class="c1">// Also you can set environment options</span>
        <span class="c1">// @see http://twig.sensiolabs.org/doc/api.html#environment-options</span>
        <span class="nv">$options</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'debug'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
            <span class="s1">'cache'</span> <span class="o">=&gt;</span> <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/tmp'</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">TwigOptions</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
        
        <span class="c1">// Only for debug option</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">TwigDebug</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="html">HTML</h1>

<p>The following template engines are available for HTML representation.</p>

<ul>
  <li><a href="html-twig-v1.html">Twig v1</a></li>
  <li><a href="html-twig-v2.html">Twig v2</a></li>
  <li><a href="html-qiq.html">Qiq</a></li>
</ul>

<h2 id="twig-vs-qiq">Twig vs Qiq</h2>

<p><a href="https://twig.symfony.com">Twig</a> was first released in 2009 and has many users, <a href="https://qiqphp.com">Qiq</a> is a new template engine released in 2021.</p>

<p>Qiq is a newer template engine released in 2021.Twig　defaults to implicit escaping and uses Twig’s own syntax for control structures. In contrast, Qiq requires explicit escaping and is based on PHP syntax. The Twig code base is large and feature-rich, while Qiq is compact and simple. （It’s a bit verbose, but writing Qiq in the full PHP syntax makes it IDE and static analysis friendly.）</p>

<h3 id="syntax-comparison">Syntax comparison</h3>

<p>PHP</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$var</span><span class="p">,</span> <span class="no">ENT_QUOTES</span><span class="o">|</span><span class="no">ENT_DISALLOWED</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">)</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nf">helper</span><span class="p">(</span><span class="nv">$var</span><span class="p">,</span> <span class="no">ENT_QUOTES</span><span class="o">|</span><span class="no">ENT_DISALLOWED</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">))</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$users</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
 * <span class="cp">&lt;?=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>
</code></pre></div></div>

<p>Twig</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{{ var | raw }}
{{ var }}
{{ var | helper }}
{% for user in users %}
  * {{ user.name }}
{% endfor %}
</code></pre></div></div>

<p>Qiq</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{{% var }}
{{h $var }}
{{h helper($var) }}
{{ foreach($users =&gt; $user) }}
  * {{h $user-&gt;name }}
{{ endforeach }}

{{ var }} // not displayed 
</code></pre></div></div>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="cd">/** @var Template $this */</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">h</span><span class="p">(</span><span class="nv">$var</span><span class="p">)</span> <span class="cp">?&gt;</span>
</code></pre></div></div>

<h2 id="renderer">Renderer</h2>

<p>A renderer bound to a <code class="language-plaintext highlighter-rouge">RenderInetrface</code> and injected into a ResourceObject generates a representation of the resource. The resource itself is indifferent about its representation.</p>

<p>Since it is injected on a per-resource basis, multiple template engines can be used simultaneously.</p>

<h1 id="hypermedia-api">Hypermedia API</h1>

<h2 id="hal">HAL</h2>

<p>BEAR.Sunday supports the <a href="https://en.wikipedia.org/wiki/Hypertext_Application_Language">HAL</a> hypermedia (<code class="language-plaintext highlighter-rouge">application/hal+json</code>) API.</p>

<p>The HAL resource model consists of the following elements:</p>

<ul>
  <li>Link</li>
  <li>Embedded resources</li>
  <li>State</li>
</ul>

<p>HAL is the JSON which represents only the state of the conventional resource plus the link <code class="language-plaintext highlighter-rouge">_links</code> plus <code class="language-plaintext highlighter-rouge">_embedded</code> to embed other resources. HAL makes API searchable and can find its API document from the API itself.</p>

<h3 id="links-1">Links</h3>

<p>Resources should have a <code class="language-plaintext highlighter-rouge">self</code> URI</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "_links": {
        "self": { "href": "/user" }
    }
}
</code></pre></div></div>

<h3 id="link-relations">Link Relations</h3>

<p>Link rels are the main way of distinguishing between a resource’s links.</p>

<p>There is a <code class="language-plaintext highlighter-rouge">rel</code> (relation) on the link, and it shows how the relationship is linked. It is similar to the <code class="language-plaintext highlighter-rouge">rel</code> used in the HTML <code class="language-plaintext highlighter-rouge">&lt;link&gt;</code> and <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code> tag.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "_links": {
        "next": { "href": "/page=2" }
    }
}
</code></pre></div></div>

<p>For more information about HAL please visit <a href="http://stateless.co/hal_specification.html">http://stateless.co/hal_specification.html</a>.</p>

<h2 id="resource-class">Resource Class</h2>

<p>You can annotate links and embed other resources.</p>

<h3 id="link">#[Link]</h3>

<p>You can declaratively describe the <code class="language-plaintext highlighter-rouge">@Link</code> annotation, or dynamic ones are assigned to <code class="language-plaintext highlighter-rouge">body['_links']</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[Link(rel="user", href="/user")]</span>
<span class="c1">#[Link(rel="latest-post", href="/latest-post", title="latest post entrty")]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
</code></pre></div></div>

<p>or</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$hasCommentPrivilege</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="s1">'_links'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'comment'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="s1">'href'</span> <span class="o">=&gt;</span> <span class="s1">'/comments/{post-id}'</span><span class="p">,</span>
                    <span class="s1">'templated'</span> <span class="o">=&gt;</span> <span class="kc">true</span>
                <span class="p">]</span>
            <span class="p">]</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="embed">#[Embed]</h3>

<p>To embed other resources statically, use the <code class="language-plaintext highlighter-rouge">@Embed</code> annotation, and to embed it dynamically, assign the “request” to<code class="language-plaintext highlighter-rouge"> body</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[Embed(rel="todos", src="/todos{?status}")]</span>
<span class="c1">#[Embed(rel="me", src="/me")]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$status</span><span class="p">):</span> <span class="kt">static</span>

</code></pre></div></div>

<p>or</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'_embedded'</span><span class="p">][</span><span class="s1">'todos'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/todos'</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="api-document-service">API document service</h2>

<p>The API server can also be an API document server. It solves problems such as the time required to create the API document, deviation from actual API, verification, maintenance.</p>

<p>In order for it to be on service, install <code class="language-plaintext highlighter-rouge">bear/api-doc</code> and install it by inheriting the <code class="language-plaintext highlighter-rouge">BEAR\ApiDoc\ApiDoc</code> page class</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require bear/api-doc
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">MyVendor\MyPorject\Resource\Page\Rels</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\ApiDoc\ApiDoc</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ApiDoc</span>
<span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Publish the folder of JSON Schema to the web</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ln -s var/json_schema public/schemas
</code></pre></div></div>

<p>API documents are automatically generated using Docblock comments and JSON Schema. The page class has its own renderer and is not affected by <code class="language-plaintext highlighter-rouge">$context</code>, it serves a document (<code class="language-plaintext highlighter-rouge">text/html</code>) for people. Since it is not affected by <code class="language-plaintext highlighter-rouge">$context</code>, you can install either<code class="language-plaintext highlighter-rouge"> App</code> or <code class="language-plaintext highlighter-rouge">Page</code>.</p>

<p>If CURIEs is installed at the root, the API itself can be used even for raw JSON which is not hypermedia. Documents generated in real time always accurately reflect property information and validation constraints.</p>

<h3 id="run-demo">Run demo</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/koriym/Polidog.Todo.git
cd Polidog.Todo/
composer install
composer setup
composer doc
</code></pre></div></div>

<p>Open <a href="https://github.com/koriym/Polidog.Todo/blob/master/docs/index.md">docs/index.md</a> to see API doc page.</p>

<h2 id="browsable">Browsable</h2>

<p>The API set written in HAL functions as <strong>headless REST application</strong>.</p>

<p>You can access all the resources by following the link from the root like the website with the Web-based HAL Browser or the CURL command of the console.</p>

<ul>
  <li><a href="https://github.com/mikekelly/hal-browser">HAL Browser</a> - <a href="http://haltalk.herokuapp.com/explorer/browser.html#/">example</a></li>
  <li><a href="https://weluse.github.io/hyperagent/">hyperagent.js</a></li>
</ul>

<h2 id="siren">Siren</h2>

<p><a href="https://github.com/kuma-guy/BEAR.SirenModule">Siren Module</a> is also available for <a href="https://github.com/kevinswiber/siren">Siren</a> hypermedia (<code class="language-plaintext highlighter-rouge">application/vnd.siren+json</code>) type.</p>

<h1 id="import">Import</h1>

<p>BEAR applications can cooperate with multiple BEAR applications into a single system without having to be microservices. It is also easy to use BEAR resources from other applications.</p>

<h2 id="composer-install">Composer Install</h2>

<p>Install the BEAR application you want to use as a composer package.</p>

<p>composer.json</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"require"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"bear/package"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^1.13"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"my-vendor/weekday"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dev-master"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"repositories"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vcs"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://github.com/bearsunday/tutorial1.git"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Requires <code class="language-plaintext highlighter-rouge">bear/package ^1.13</code>.</p>

<h2 id="module-install">Module Install</h2>

<p>Install other applications with <code class="language-plaintext highlighter-rouge">ImportAppModule</code>, specifying the hostname, application name (namespace) and context to import.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gi">+use BEAR\Package\Module\ImportAppModule;
+use BEAR\Package\Module\Import\ImportApp;
</span>
class AppModule extends AbstractAppModule
<span class="err">{</span>
    protected function configure(): void
    {
        // ...
<span class="gi">+        $this-&gt;install(new ImportAppModule([
+            new ImportApp('foo', 'MyVendor\Weekday', 'prod-app')
+        ]));
</span>        $this-&gt;install(new PackageModule());
    }
<span class="err">}</span>
</code></pre></div></div>

<h2 id="request">Request</h2>

<p>The imported resource will be used with the specified host name.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">ResourceInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'BEAR.Sunday'</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$weekday</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://foo/weekday?year=2022&amp;month=1&amp;day=1'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'greeting'</span> <span class="o">=&gt;</span> <span class="s1">'Hello '</span> <span class="mf">.</span> <span class="nv">$name</span><span class="p">,</span>
            <span class="s1">'weekday'</span> <span class="o">=&gt;</span> <span class="nv">$weekday</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You can also use <code class="language-plaintext highlighter-rouge">#[Embed]</code> and <code class="language-plaintext highlighter-rouge">#[Link]</code> in the same way.</p>

<h2 id="requests-from-other-systems">Requests from other systems</h2>

<p>It is easy to use BEAR resources from other frameworks or CMS.</p>

<p>Install it as a package in the same way, and use <code class="language-plaintext highlighter-rouge">Injector::getInstance</code> to get the resource client of the application you require and request it.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">use</span> <span class="nc">BEAR\Package\Injector</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceInterface</span><span class="p">;</span>

<span class="nv">$resource</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">(</span>
    <span class="s1">'MyVendor\Weekday'</span><span class="p">,</span>
    <span class="s1">'prod-api-app'</span><span class="p">,</span>
    <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/vendor/my-vendor/weekday'</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="nc">ResourceInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
<span class="nv">$weekdday</span> <span class="o">=</span> <span class="nv">$resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/weekday'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'year'</span> <span class="o">=&gt;</span> <span class="s1">'2022'</span><span class="p">,</span> <span class="s1">'month'</span> <span class="o">=&gt;</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'day'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">]);</span>

<span class="k">echo</span> <span class="nv">$weekdday</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'weekday'</span><span class="p">]</span> <span class="mf">.</span> <span class="kc">PHP_EOL</span><span class="p">;</span>
</code></pre></div></div>
<h2 id="environment-variables">Environment variables</h2>

<p>Environment variables are global. Care should be taken to prefix them to avoid conflicts between applications. Instead of using <code class="language-plaintext highlighter-rouge">.env</code> files, the application to be imported will get the shell environment variables just like in production.</p>

<h2 id="system-boundary">System Boundary</h2>

<p>It is similar to microservices in that a large application can be built as a collection of multiple smaller applications, but without the disadvantages of microservices such as increased infrastructure overhead. It also has clearer component independence and boundaries than modular monoliths.</p>

<p>The code for this page can be found at <a href="https://github.com/bearsunday/example-import-app/commits/master">bearsunday/example-app-import</a>.</p>

<h1 id="what-is-bearsunday">What is BEAR.Sunday?</h1>

<p>BEAR.Sunday is a PHP application framework that combines clean object-oriented design with a resource-oriented architecture aligned with the fundamental principles of the web. This framework emphasizes compliance with standards, a long-term perspective, high efficiency, flexibility, self-description, and importantly, simplicity.</p>

<h2 id="framework">Framework</h2>

<p>BEAR.Sunday consists of three frameworks.</p>

<p><code class="language-plaintext highlighter-rouge">Ray.Di</code> interfaces object dependencies based on the <a href="http://en.wikipedia.org/wiki/Dependency_inversion_principle">Principle of Dependency Inversion</a>.</p>

<p><code class="language-plaintext highlighter-rouge">Ray.Aop</code> connects core concerns and cross-cutting concerns with <a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming">aspect-oriented programming</a>.</p>

<p><code class="language-plaintext highlighter-rouge">BEAR.Resource</code> connects application data and functionality with resources with <a href="https://en.wikipedia.org/wiki/Representational_state_transfer">REST constraints</a>.</p>

<p>The framework provides constraints and design principles that guide the entire application, promoting consistent design and implementation, and resulting in high-quality, clean code.</p>

<h2 id="libraries">Libraries</h2>

<p>Unlike full-stack frameworks, BEAR.Sunday does not include its own libraries for specific tasks like authentication or database management. Instead, it favors the use of high-quality third-party libraries.</p>

<p>This approach is based on two key design philosophies: firstly, the belief that “frameworks remain, libraries change,” acknowledging that while the framework provides a stable foundation, libraries evolve to meet changing needs over time. Secondly, it empowers “application architects with the right and responsibility to choose libraries” that best fit their application’s requirements, constraints, and goals.</p>

<p>BEAR.Sunday draws a clear distinction between frameworks and libraries, emphasizing the role of the framework as an application constraint.</p>

<h2 id="architecture">Architecture</h2>

<p>BEAR.Sunday departs from the traditional MVC (Model-View-Controller) architecture, embracing a resource-oriented architecture (ROA). In this paradigm, data and business logic are unified as resources, and the design revolves around links and operations on those resources. While ROA is commonly used for REST API design, BEAR.Sunday extends it to the entire web application.</p>

<h2 id="long-term-perspective">Long-term perspective</h2>

<p>BEAR.Sunday is designed with a long-term view, focusing on application maintainability:</p>

<ul>
  <li>
    <p><strong>Constraints</strong>: The consistent application constraints imposed by DI, AOP, and REST remain unchanged over time.</p>
  </li>
  <li>
    <p><strong>Eternal 1.x</strong>:The System That Never Breaks Backward Compatibility. Since its initial release in 2015, BEAR.Sunday has continuously evolved without introducing any backward-incompatible changes. This steadfast approach eliminates the need for compatibility fixes and their associated testing, thereby preventing future technical debt. The system remains cutting-edge, ensuring easy upgrades and access to the latest features without compatibility concerns.</p>
  </li>
  <li>
    <p><strong>Standards Compliance</strong>: BEAR.Sunday adheres to various standards, including HTTP, JsonSchema, and others. For DI, it follows Google Guice, and for AOP, it aligns with the Java Aop Alliance.</p>
  </li>
</ul>

<h2 id="connectivity">Connectivity</h2>

<p>BEAR.Sunday transcends traditional web applications, offering seamless integration with a diverse range of clients:</p>

<ul>
  <li>
    <p><strong>HTTP Client</strong>: All resources are directly accessible via HTTP, unlike models or controllers in MVC.</p>
  </li>
  <li>
    <p><strong>composer package</strong>: Resources from applications installed under the vendor directory via Composer can be invoked directly, enabling coordination between multiple applications without resorting to microservices.</p>
  </li>
  <li>
    <p><strong>Multilingual framework</strong>: BEAR.Thrift facilitates seamless and efficient interoperability with other languages and PHP versions.</p>
  </li>
</ul>

<h2 id="web-cache">Web Cache</h2>

<p>By integrating resource-oriented architecture with modern CDN technology, we achieve distributed caching that surpasses traditional server-side TTL caching. BEAR.Sunday’s design philosophy adheres to the fundamental principles of the Web, utilizing a CDN-centered distributed caching system to ensure high performance and availability.</p>

<ul>
  <li>
    <p><strong>Distributed Caching</strong>: By caching on the client, CDN, and server-side, both CPU and network costs are minimized.</p>
  </li>
  <li>
    <p><strong>Identification</strong>: ETag-based verification ensures that only modified content is retrieved, enhancing network efficiency.</p>
  </li>
  <li>
    <p><strong>Fault tolerance</strong>: Event-based cache invalidation allows all content to be stored in CDN caches without TTL limitations. This improves fault tolerance to the point where the system remains available even if the PHP or database servers go down.</p>
  </li>
</ul>

<h2 id="performance-1">Performance</h2>

<p>BEAR.Sunday is designed with a focus on performance and efficiency while maintaining maximum flexibility. This approach enables a highly optimized bootstrap, positively impacting both user experience and system resources. Performance is always one of the primary concerns for BEAR.Sunday, playing a central role in our design and development decisions.</p>

<h2 id="because-everything-is-a-resource">Because Everything is a Resource</h2>

<p>BEAR.Sunday embraces the essence of the Web, where “Everything is a Resource.” As a PHP web application framework, it excels by providing superior constraints based on object-oriented and REST principles, applicable to the entire application.</p>

<p>These constraints encourage developers to design and implement consistently and improve the quality of the application in the long run. At the same time, the constraints provide developers with freedom and enhance creativity in building the application.</p>

<h1 id="javascript-ui">Javascript UI</h1>

<p>Instead of rendering views with PHP template engines such Twig etc, we will be doing so using server-side JavaScript. On the PHP side we will be carrying out the authorisation, authentication, initialization and API delivery then we will do the rendering of the UI using JS.</p>

<p>Currently within our project architecture, we will only be making changes to annotated resources so should be simple.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li>PHP 7.1</li>
  <li><a href="https://nodejs.org/">Node.js</a></li>
  <li><a href="https://yarnpkg.com/">yarn</a></li>
  <li><a href="http://php.net/manual/en/book.v8js.php">V8Js</a> (Development option)</li>
</ul>

<p>Note: If you do not install V8Js then JS will be run using Node.js.</p>

<h2 id="terminology">Terminology</h2>

<ul>
  <li><strong>CSR</strong> Client Side Rendering (via Web Browser)</li>
  <li><strong>SSR</strong> Server Side Rendering (via V8 or Node.js)</li>
</ul>

<h2 id="javascript">JavaScript</h2>

<h3 id="installation-1">Installation</h3>

<p>Install <code class="language-plaintext highlighter-rouge">koriym/ssr-module</code> into the project.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// composer create-project bear/skeleton MyVendor.MyProject <span class="o">&amp;&amp;</span> <span class="nb">cd </span>MyVendor.MyProject<span class="p">;</span>
composer require bear/ssr-module
</code></pre></div></div>

<p>Install the UI skeleton app <code class="language-plaintext highlighter-rouge">koriym/js-ui-skeleton</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require koriym/js-ui-skeleton 1.x-dev
<span class="nb">cp</span> <span class="nt">-r</span> vendor/koriym/js-ui-skeleton/ui <span class="nb">.</span>
<span class="nb">cp</span> <span class="nt">-r</span> vendor/koriym/js-ui-skeleton/package.json <span class="nb">.</span>
yarn <span class="nb">install</span>
</code></pre></div></div>

<h3 id="running-the-ui-application">Running the UI application</h3>

<p>Lets start by running the demo application.
From the displayed web page lets select the rendering engine and run the JS application.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn run ui
</code></pre></div></div>
<p>This applications inputs can be set using the <code class="language-plaintext highlighter-rouge">ui/dev/config/</code> config files.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$app</span> <span class="o">=</span> <span class="s1">'index'</span><span class="p">;</span>                   <span class="c1">// =index.bundle.js</span>
<span class="nv">$state</span> <span class="o">=</span> <span class="p">[</span>                        <span class="c1">// Application state</span>
    <span class="s1">'hello'</span> <span class="o">=&gt;</span><span class="p">[</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'World'</span><span class="p">]</span>
<span class="p">];</span>
<span class="nv">$metas</span> <span class="o">=</span> <span class="p">[</span>                        <span class="c1">// value used in SSR only</span>
    <span class="s1">'title'</span> <span class="o">=&gt;</span><span class="s1">'page-title'</span>
<span class="p">];</span>

<span class="k">return</span> <span class="p">[</span><span class="nv">$app</span><span class="p">,</span> <span class="nv">$state</span><span class="p">,</span> <span class="nv">$metas</span><span class="p">];</span>
</code></pre></div></div>
<p>Lets copy the configuration file and try changing the input values.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp ui/dev/config/index.php ui/dev/config/myapp.php
</code></pre></div></div>

<p>Reload the browser and try out the new settings.</p>

<p>In this way without changing the JavaScript or core PHP application we can alter the UI data and check that it is working.</p>

<p>The PHP configuration files that have been edited in this section are only used when executing <code class="language-plaintext highlighter-rouge">yarn run ui</code>.
All the PHP side needs is the output bundled JS file.</p>

<h3 id="creating-the-ui-application">Creating the UI application.</h3>

<p>Using the variables that have been passed in from PHP, create a <strong>render</strong> function that returns a rendered string.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const render = (state, metas) =&gt; (
  __AWESOME_UI__ // Using a SSR compatible library or JS template engine return an output string.
)
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">state</code> value is needed in the document root, <code class="language-plaintext highlighter-rouge">metas</code> contains other variables, such as those needed in &lt;head&gt;. The <code class="language-plaintext highlighter-rouge">render</code> function name cannot be changed.</p>

<p>Here we can grab the name and create a greeting string to be returned.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const render = state =&gt; (
  `Hello ${state.name}`
)
</code></pre></div></div>

<p>Save this as <code class="language-plaintext highlighter-rouge">ui/src/page/index/hello/server.js</code> and register this as a Webpack entry point in<code class="language-plaintext highlighter-rouge">ui/entry.js</code>.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">hello</span><span class="p">:</span> <span class="dl">'</span><span class="s1">src/page/hello/server</span><span class="dl">'</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Having done this a <code class="language-plaintext highlighter-rouge">hello.bundle.js</code> bundled file is created for us.</p>

<p>Create a file at <code class="language-plaintext highlighter-rouge">ui/dev/config/myapp.php</code> to test run this application.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$app</span> <span class="o">=</span> <span class="s1">'hello'</span><span class="p">;</span>
<span class="nv">$state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'World'</span><span class="p">]</span>
<span class="p">];</span>
<span class="nv">$metas</span> <span class="o">=</span> <span class="p">[];</span>

<span class="k">return</span> <span class="p">[</span><span class="nv">$app</span><span class="p">,</span> <span class="nv">$state</span><span class="p">,</span> <span class="nv">$metas</span><span class="p">];</span>
</code></pre></div></div>

<p>Thats it! Reload the browser to try it out.</p>

<p>Inside the render function you can use any UI framework such as React or Vue.js to create a rich UI.
In a regular application in order to limit the number of dependencies in the <code class="language-plaintext highlighter-rouge">server.js</code> entry file import the render module as below.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">render</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./render</span><span class="dl">'</span><span class="p">;</span>
<span class="nb">global</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="nx">render</span><span class="p">;</span>
</code></pre></div></div>

<p>Thus far there has been nothing happening on the PHP side. Development on the SSR application and PHP development can done independently.</p>

<h2 id="php">PHP</h2>

<h3 id="module-installation">Module Installation</h3>

<p>Install <code class="language-plaintext highlighter-rouge">SsrModule</code> in AppModule.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">use</span> <span class="nc">BEAR\SsrModule\SsrModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$build</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/var/www/build'</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">SsrModule</span><span class="p">(</span><span class="nv">$build</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">$build</code> directory is where the JS files live.(The Webpack output location set in <code class="language-plaintext highlighter-rouge">ui/ui.config.js</code>)</p>

<h3 id="ssr-annotation">@Ssr Annotation</h3>

<p>Annotate the resource function to be SSR’d with <code class="language-plaintext highlighter-rouge">@Ssr</code>. The JS application name is required in <code class="language-plaintext highlighter-rouge">app</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">php</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\MyRedux\Resource\Page</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\SsrModule\Annotation\Ssr</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="cd">/**
     * @Ssr(app="index_ssr")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="nv">$name</span> <span class="o">=</span> <span class="s1">'BEAR.Sunday'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'hello'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">]</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When you want to pass in distinct values for SSR and CSR set a key in <code class="language-plaintext highlighter-rouge">state</code> and <code class="language-plaintext highlighter-rouge">metas</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @Ssr(
 *   app="index_ssr",
 *   state={"name", "age"},
 *   metas={"title"}
 * )
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'World'</span><span class="p">,</span>
        <span class="s1">'age'</span> <span class="o">=&gt;</span> <span class="mf">4.6E8</span><span class="p">;</span>
        <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'Age of the World'</span>
    <span class="p">];</span>

    <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To see exactly how you pass in <code class="language-plaintext highlighter-rouge">state</code> and <code class="language-plaintext highlighter-rouge">metas</code> to achieve SSR see the sample application <code class="language-plaintext highlighter-rouge">ui/src/page/index/server</code>. The only influence is from the annotated method, the rest comes straight from the API or HTML rendering configuration.</p>

<h3 id="runtime-php-application-settings">Runtime PHP Application Settings</h3>

<p>Edit <code class="language-plaintext highlighter-rouge">ui/ui.config.js</code>, set the Webpack build location in <code class="language-plaintext highlighter-rouge">build</code> and web directory in <code class="language-plaintext highlighter-rouge">public</code>. The <code class="language-plaintext highlighter-rouge">build</code> directory is the same that you set in the SsrModule installation.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">public</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">../var/www</span><span class="dl">'</span><span class="p">),</span>
  <span class="na">build</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">../var/www/build</span><span class="dl">'</span><span class="p">)</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="running-the-php-application">Running the PHP application</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn run dev
</code></pre></div></div>

<p>Run using live updating.
When the PHP file is changed it will be automatically reloaded, if there is a change in a React component without hitting refresh the component will update. If you want to run the app without live updating you can by running <code class="language-plaintext highlighter-rouge">yarn run start</code>.</p>

<p>For other commands such <code class="language-plaintext highlighter-rouge">lint</code> or <code class="language-plaintext highlighter-rouge">test</code> etc. please see <a href="https://github.com/koriym/Koriym.JsUiSkeleton/blob/1.x/README.md#command">commands</a>.</p>

<h2 id="performance-2">Performance</h2>

<p>The ability to save the V8 Snapshot into APC means we can see dramatic performance benefits. In <code class="language-plaintext highlighter-rouge">ProdModule</code> install <code class="language-plaintext highlighter-rouge">ApcSsrModule</code>.
ReactJs or your application snapshot is saved in <code class="language-plaintext highlighter-rouge">APCu</code> and can be reused. V8 is required.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">ApcSsrModule</span><span class="p">);</span>
</code></pre></div></div>
<p>To use caches other than APC look at  the code in <code class="language-plaintext highlighter-rouge">ApcSsrModule</code> as a reference to make your own module. It is possible to use a cache compatible with PSR16.</p>

<p>In order to tune performance at compile time pulling in your JS code (and ReactJs etc) into the V8 snapshot can give you further performance improvements.
For more info please see the following.</p>

<ul>
  <li><a href="http://stesie.github.io/2016/02/snapshot-performance">20x performance boost with V8Js snapshots</a></li>
  <li><a href="https://github.com/phpv8/v8js/issues/205">v8js - Possibility to Improve Performance with Precompiled Templates/Classes ?</a></li>
</ul>

<h2 id="debugging">Debugging</h2>

<ul>
  <li>Chrome Plugin <a href="https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi">React developer tools</a> or <a href="https://chrome.google.com/webstore/detail/redux-devtools/lmhkpmbekcpmknklioeibfkpmmfibljd">Redux devTools</a> can be used.</li>
  <li>When a 500 error is returned look at the response details by using <code class="language-plaintext highlighter-rouge">var/log</code> or <code class="language-plaintext highlighter-rouge">curl</code> etc.</li>
</ul>

<h2 id="references">References</h2>

<ul>
  <li><a href="http://postd.cc/es6-cheatsheet/">ECMAScript 6</a></li>
  <li><a href="https://github.com/airbnb/javascript">Airbnb JavaScript Styleguide</a></li>
  <li><a href="https://facebook.github.io/react/">React</a></li>
  <li><a href="http://redux.js.org/">Redux</a></li>
  <li><a href="https://github.com/reactjs/redux">Redux github</a></li>
  <li><a href="https://github.com/gaearon/redux-devtools">Redux devtools</a></li>
  <li><a href="http://karma-runner.github.io/1.0/index.html">Karma test runner</a></li>
  <li><a href="https://mochajs.org/">Mocha test framework</a></li>
  <li><a href="http://chaijs.com/">Chai assertion library</a></li>
  <li><a href="https://yarnpkg.com/">Yarn package manager</a></li>
  <li><a href="https://webpack.js.org/">Webpack module bundler</a></li>
</ul>

<h2 id="other-view-libraries">Other view libraries</h2>

<ul>
  <li><a href="https://vuejs.org/">Vue.js</a></li>
  <li><a href="http://handlebarsjs.com/">Handlesbar.js</a></li>
  <li><a href="http://olado.github.io/doT/index.html">doT.js</a></li>
  <li><a href="https://pugjs.org/api/getting-started.html">pug</a></li>
  <li><a href="http://twitter.github.io/hogan.js/">Hogan</a> (Twitter)</li>
  <li><a href="https://mozilla.github.io/nunjucks/">Nunjucks</a>(Mozilla)</li>
  <li><a href="http://www.dustjs.com/">dust.js</a> (LinkedIn)</li>
  <li><a href="http://markojs.com/">marko</a> (Ebay)</li>
</ul>

<h1 id="modules">Modules</h1>

<p>A Module is a collection of DI &amp; AOP bindings that sets up your application.</p>

<p>BEAR.Sunday doesn’t have a <em>global</em> config file or a config class to set default values for components such as a database or a template engine.
Instead for each peice of functionality we set up DI and AOP by injecting configuration values into a stand alone module.</p>

<p><code class="language-plaintext highlighter-rouge">AppModule</code> (src/Module/AppModule.php) is the root module. We use an <code class="language-plaintext highlighter-rouge">install()</code> method in here to load each module that we would like to invoke.</p>

<p>You can also override existing bindings by using <code class="language-plaintext highlighter-rouge">override()</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="c1">// install additional modules</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AuraSqlModule</span><span class="p">(</span><span class="s1">'mysql:host=localhost;dbname=test'</span><span class="p">,</span> <span class="s1">'username'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigModule</span><span class="p">));</span>
        <span class="c1">// install basic module</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">PackageModule</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="di-bindings">DI bindings</h2>

<p><code class="language-plaintext highlighter-rouge">Ray.Di</code> is the core DI framework used in BEAR.Sunday. It binds interfaces to a class or factory to create an object graph.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Class binding</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nv">$interface</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nv">$class</span><span class="p">);</span>
<span class="c1">// Provider (factory) binding</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nv">$interface</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toProvider</span><span class="p">(</span><span class="nv">$provider</span><span class="p">);</span>
<span class="c1">// Instance binding</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nv">$interface</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="nv">$instance</span><span class="p">);</span>
<span class="c1">// Named binding</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nv">$interface</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nv">$annotation</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nv">$class</span><span class="p">);</span>
<span class="c1">// Singleton</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nv">$interface</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nv">$class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">in</span><span class="p">(</span><span class="nc">Scope</span><span class="o">::</span><span class="no">SINGLETON</span><span class="p">);</span>
<span class="c1">// Constructor binding</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nv">$interface</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toConstructor</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$named</span><span class="p">);</span>
</code></pre></div></div>

<p>Bindings declared first take priority
More info can be found at Ray.Di <a href="https://github.com/ray-di/Ray.Di/blob/2.x/README.md">README</a></p>

<h2 id="aop-bindings">AOP Bindings</h2>

<p>We can “search” for classes and methods with a built-in <code class="language-plaintext highlighter-rouge">Matcher</code>, then interceptors can be bound to any found methods.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bindInterceptor</span><span class="p">(</span>
    <span class="c1">// In any class</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">any</span><span class="p">(),</span>
    <span class="c1">// Method(s) names that start with "delete"</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">startWith</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">),</span>
    <span class="c1">// Bind a Logger interceptor</span>
    <span class="p">[</span><span class="nc">LoggerInterceptor</span><span class="o">::</span><span class="n">class</span><span class="p">]</span>
<span class="p">);</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bindInterceptor</span><span class="p">(</span>
    <span class="c1">// The AdminPage class or a class inherited from it.</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">SubclassesOf</span><span class="p">(</span><span class="nc">AdminPage</span><span class="o">::</span><span class="n">class</span><span class="p">),</span>
    <span class="c1">// Annotated with the @Auth annotation</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">Auth</span><span class="o">::</span><span class="n">class</span><span class="p">),</span>
    <span class="c1">// Bind the AdminAuthenticationInterceptor</span>
    <span class="p">[</span><span class="nc">AdminAuthenticationInterceptor</span><span class="o">::</span><span class="n">class</span><span class="p">]</span>
<span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Matcher</code> has various binding methods.</p>

<ul>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L16">Matcher::any</a> - Any</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L23">Matcher::annotatedWith</a> - Annotation</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/2.x/src/MatcherInterface.php#L30">Matcher::subclassesOf</a> - Sub class</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/2.x/src/MatcherInterface.php#L37">Matcher::startsWith</a> - start with name (class or method)</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/2.x/src/MatcherInterface.php#L44">Matcher::logicalOr</a> - OR</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/2.x/src/MatcherInterface.php#L51">Matcher::logicalAnd</a> - AND</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/2.x/src/MatcherInterface.php#L58">Matcher::logicalNot</a> - NOT</li>
</ul>

<h2 id="interceptor-1">Interceptor</h2>

<p>In an interceptor a <code class="language-plaintext highlighter-rouge">MethodInvocation</code> object gets passed to the <code class="language-plaintext highlighter-rouge">invoke</code> method. We can the decorate the targetted instances so that you run computations before or after any methods on the target are invoked.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyInterceptor</span> <span class="kd">implements</span> <span class="nc">MethodInterceptor</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">invoke</span><span class="p">(</span><span class="kt">MethodInvocation</span> <span class="nv">$invocation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Before invocation</span>
        <span class="c1">// ...</span>

        <span class="c1">//  Method invocation</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="nf">proceed</span><span class="p">();</span>

        <span class="c1">//  After invocation</span>
        <span class="c1">// ...</span>

        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>With the <code class="language-plaintext highlighter-rouge">MethodInvocation</code> object, you can access the target method’s invocation object, method’s and parameters.</p>

<ul>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/Joinpoint.php#L39">MethodInvocation::proceed</a> - Invoke method</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MethodInvocation.php">MethodInvocation::getMethod</a> -  Get method reflection</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/Joinpoint.php#L48">MethodInvocation::getThis</a> - Get object</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/Invocation.php">MethodInvocation::getArguments</a> - Pet parameters</li>
</ul>

<p>Annotations can be obtained using the reflection API.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$method</span> <span class="o">=</span> <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="nf">getMethod</span><span class="p">();</span>
<span class="nv">$class</span> <span class="o">=</span> <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="nf">getMethod</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getDeclaringClass</span><span class="p">();</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">$method-&gt;getAnnotations()</code></li>
  <li><code class="language-plaintext highlighter-rouge">$method-&gt;getAnnotation($name)</code></li>
  <li><code class="language-plaintext highlighter-rouge">$class-&gt;-&gt;getAnnotations()</code></li>
  <li><code class="language-plaintext highlighter-rouge">$class-&gt;-&gt;getAnnotation($name)</code></li>
</ul>

<h2 id="environment-settings">Environment Settings</h2>

<p>BEAR.Sunday does not have any special environment mode except <code class="language-plaintext highlighter-rouge">prod</code>.
A Module and the application itself are unaware of the current environment.</p>

<p>There is no way to get the current “mode”, this is intentional to keep the code clean.</p>

<h1 id="package">Package</h1>

<p>BEAR.Sunday application is a composer package taking BEAR.Sunday framework as dependency package.
You can also install another BEAR.Sunday application package as dependency.</p>

<h2 id="application-organization">Application organization</h2>

<p>The file layout of the BEAR.Sunday application conforms to <a href="https://github.com/php-pds/skeleton">php-pds/skeleton</a> standard.</p>

<h3 id="invoke-sequence">Invoke sequence</h3>

<ol>
  <li>Console input(<code class="language-plaintext highlighter-rouge">bin/app.php</code>, <code class="language-plaintext highlighter-rouge">bin/page.php</code>) or web entry file (<code class="language-plaintext highlighter-rouge">public/index.php</code>) excute <code class="language-plaintext highlighter-rouge">bootstrap.php</code> function.</li>
  <li><code class="language-plaintext highlighter-rouge">$app</code> application object is created by <code class="language-plaintext highlighter-rouge">$context</code> in <code class="language-plaintext highlighter-rouge">boostrap.php</code>.</li>
  <li>A router in <code class="language-plaintext highlighter-rouge">$app</code> convert external resource request to internal resource request.</li>
  <li>A resource request is invoked. The representation of the result transfered to a client.</li>
</ol>

<h3 id="bootstrap">bootstrap/</h3>

<p>You can access same resource through console input or web access with same boot file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php options /todos // console API access　<span class="o">(</span>app resource<span class="o">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/page.php get <span class="s1">'/todos?id=1'</span> // console Web access <span class="o">(</span>page resource<span class="o">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php <span class="nt">-S</span> 127.0.0.1bin/app.php // PHP server
</code></pre></div></div>

<p>You can create your own boot file for different context.</p>

<h3 id="bin">bin/</h3>

<p>Plavce command-line executable files.</p>

<h3 id="src">src/</h3>

<p>Place application class file.</p>

<h3 id="publc">publc/</h3>

<p>Web public folder.</p>

<h3 id="var">var/</h3>

<p><code class="language-plaintext highlighter-rouge">log</code> and <code class="language-plaintext highlighter-rouge">tmp</code> folder need write permission.</p>

<h2 id="framework-package">Framework Package</h2>

<h3 id="rayaop">ray/aop</h3>
<p><a href="https://scrutinizer-ci.com/g/ray-di/Ray.Aop/"><img src="https://scrutinizer-ci.com/g/ray-di/Ray.Aop/badges/quality-score.png?b=2.x" alt="Scrutinizer Quality Score" /></a>
<a href="https://codecov.io/gh/ray-di/Ray.Aop"><img src="https://codecov.io/gh/ray-di/Ray.Aop/branch/2.x/graph/badge.svg?token=eh3c9AF4Mr" alt="codecov" /></a>
<a href="https://shepherd.dev/github/ray-di/Ray.Aop"><img src="https://shepherd.dev/github/ray-di/Ray.Aop/coverage.svg" alt="Type Coverage" /></a>
<a href="https://github.com/ray-di/Ray.Aop/actions/workflows/continuous-integration.yml"><img src="https://github.com/ray-di/Ray.Aop/actions/workflows/continuous-integration.yml/badge.svg" alt="Continuous Integration" /></a></p>

<p>An aspect oriented framework based on Java AOP Alliance API.</p>

<h3 id="raydi">ray/di</h3>
<p><a href="https://scrutinizer-ci.com/g/ray-di/Ray.Di/"><img src="https://scrutinizer-ci.com/g/ray-di/Ray.Di/badges/quality-score.png?b=2.x" alt="Scrutinizer Quality Score" /></a>
<a href="https://codecov.io/gh/ray-di/Ray.Di"><img src="https://codecov.io/gh/ray-di/Ray.Di/branch/2.x/graph/badge.svg?token=eh3c9AF4Mr" alt="codecov" /></a>
<a href="https://shepherd.dev/github/ray-di/Ray.Di"><img src="https://shepherd.dev/github/ray-di/Ray.Di/coverage.svg" alt="Type Coverage" /></a>
<a href="https://github.com/ray-di/Ray.Di/actions/workflows/continuous-integration.yml"><img src="https://github.com/ray-di/Ray.Di/actions/workflows/continuous-integration.yml/badge.svg" alt="Continuous Integration" /></a></p>

<p>A Google Guice style DI framework. It contains <code class="language-plaintext highlighter-rouge">ray/aop</code>.</p>

<h3 id="bearresource">bear/resource</h3>
<p><a href="https://scrutinizer-ci.com/g/bearsunday/BEAR.Resource/?branch=1.x"><img src="https://scrutinizer-ci.com/g/bearsunday/BEAR.Resource/badges/quality-score.png?b=1.x" alt="Scrutinizer Code Quality" /></a>
<a href="https://codecov.io/gh/bearsunday/BEAR.Resource"><img src="https://codecov.io/gh/bearsunday/BEAR.Resource/branch/1.x/graph/badge.svg?token=eh3c9AF4Mr" alt="codecov" /></a>
<a href="https://shepherd.dev/github/bearsunday/BEAR.Resource"><img src="https://shepherd.dev/github/bearsunday/BEAR.Resource/coverage.svg" alt="Type Coverage" /></a>
<a href="https://github.com/bearsunday/BEAR.Resource/actions/workflows/continuous-integration.yml"><img src="https://github.com/bearsunday/BEAR.Resource/actions/workflows/continuous-integration.yml/badge.svg" alt="Continuous Integration" /></a></p>

<p>A REST framework for PHP object as a service. It contains <code class="language-plaintext highlighter-rouge">ray/di</code>.</p>

<h3 id="bearsunday">bear/sunday</h3>
<p><a href="https://scrutinizer-ci.com/g/bearsunday/BEAR.Sunday/?branch=1.x"><img src="https://scrutinizer-ci.com/g/bearsunday/BEAR.Sunday/badges/quality-score.png?b=1.x" alt="Scrutinizer Code Quality" /></a>
<a href="https://codecov.io/gh/bearsunday/BEAR.Sunday"><img src="https://codecov.io/gh/bearsunday/BEAR.Sunday/branch/1.x/graph/badge.svg?token=eh3c9AF4Mr" alt="codecov" /></a>
<a href="https://shepherd.dev/github/bearsunday/BEAR.Sunday"><img src="https://shepherd.dev/github/bearsunday/BEAR.Sunday/coverage.svg" alt="Type Coverage" /></a>
<a href="https://github.com/bearsunday/BEAR.Sunday/actions/workflows/continuous-integration.yml"><img src="https://github.com/bearsunday/BEAR.Sunday/actions/workflows/continuous-integration.yml/badge.svg" alt="Continuous Integration" /></a></p>

<p>A web application interface package. It contains <code class="language-plaintext highlighter-rouge">bear/resource</code>.</p>

<h3 id="bearpackage">bear/package</h3>
<p><a href="https://scrutinizer-ci.com/g/bearsunday/BEAR.Package/?branch=1.x"><img src="https://scrutinizer-ci.com/g/bearsunday/BEAR.Package/badges/quality-score.png?b=1.x" alt="Scrutinizer Code Quality" /></a>
<a href="https://codecov.io/gh/bearsunday/BEAR.Pacakge"><img src="https://codecov.io/gh/bearsunday/BEAR.Package/branch/1.x/graph/badge.svg?token=eh3c9AF4Mr" alt="codecov" /></a>
<a href="https://shepherd.dev/github/bearsunday/BEAR.Package"><img src="https://shepherd.dev/github/bearsunday/BEAR.Package/coverage.svg" alt="Type Coverage" /></a>
<a href="https://github.com/bearsunday/BEAR.Package/actions/workflows/continuous-integration.yml"><img src="https://github.com/bearsunday/BEAR.Package/actions/workflows/continuous-integration.yml/badge.svg" alt="Continuous Integration" /></a></p>

<p>A web application implmentation package. It contains <code class="language-plaintext highlighter-rouge">bear/sunday</code>.</p>

<h2 id="library-package">Library Package</h2>

<p>Optional library package can be installed with <code class="language-plaintext highlighter-rouge">composer require</code> command.</p>

<table>
  <tbody>
    <tr>
      <td><strong>Category</strong></td>
      <td><strong>Composer package</strong></td>
      <td><strong>Library</strong></td>
    </tr>
    <tr>
      <td>Router</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/bearsunday/BEAR.AuraRouterModule">bear/aura-router-module</a></td>
      <td><a href="https://github.com/auraphp/Aura.Router/tree/2.x">Aura.Router v2</a></td>
    </tr>
    <tr>
      <td>Database</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.MediaQuery">ray/media-query</a></td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.AuraSqlModule">ray/aura-sql-module</a></td>
      <td><a href="https://github.com/auraphp/Aura.Sql/tree/2.x">Aura.Sql v2</a></td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.DbalModule">ray/dbal-module</a></td>
      <td><a href="https://github.com/doctrine/dbal">Doctrine DBAL</a></td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.CakeDbModule">ray/cake-database-module</a></td>
      <td><a href="https://github.com/cakephp/database">CakePHP v3 database</a></td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/kawanamiyuu/Ray.DoctrineOrmModule">ray/doctrine-orm-module</a></td>
      <td><a href="https://github.com/doctrine/doctrine2">Doctrine ORM</a></td>
    </tr>
    <tr>
      <td>Storage</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/bearsunday/BEAR.QueryRepository">bear/query-repository</a></td>
      <td>CQRS inspired repository</td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.QueryModule">bear/query-module</a></td>
      <td>Separation of external access such as DB or Web API</td>
    </tr>
    <tr>
      <td>Web</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="http://bearsunday.github.io/manuals/1.0/ja/html.html">madapaja/twig-module</a></td>
      <td><a href="http://twig.sensiolabs.org/">Twig</a></td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="http://bearsunday.github.io/manuals/1.0/ja/form.html">ray/web-form-module</a></td>
      <td>Web form</td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/Ray-Di/Ray.AuraWebModule">ray/aura-web-module</a></td>
      <td><a href="https://github.com/auraphp/Aura.Web">Aura.Web</a></td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.AuraSessionModule">ray/aura-session-module</a></td>
      <td><a href="https://github.com/auraphp/Aura.Session">Aura.Session</a></td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/kawanamiyuu/Ray.SymfonySessionModule">ray/symfony-session-module</a></td>
      <td><a href="https://github.com/symfony/http-foundation/tree/master/Session">Symfony Session</a></td>
    </tr>
    <tr>
      <td>Validation</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.ValidateModule">ray/validate-module</a></td>
      <td><a href="https://github.com/auraphp/Aura.Filter">Aura.Filter</a></td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/satomif/ExtraAuraFilterModule">satomif/extra-aura-filter-module</a></td>
      <td><a href="https://github.com/auraphp/Aura.Filter">Aura.Filter</a></td>
    </tr>
    <tr>
      <td>Authorization and Authentication</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/Ray-Di/Ray.OAuthModule">ray/oauth-module</a></td>
      <td>OAuth</td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/kuma-guy/BEAR.JwtAuthModule">kuma-guy/jwt-auth-module</a></td>
      <td>JSON Web Token</td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.RoleModule">ray/role-module</a></td>
      <td>Zend Acl</td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/bearsunday/BEAR.AclResource">bear/acl-resource</a></td>
      <td>ACL based embedded resource</td>
    </tr>
    <tr>
      <td>Hypermedia</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/kuma-guy/BEAR.SirenModule">kuma-guy/siren-module</a></td>
      <td>Siren</td>
    </tr>
    <tr>
      <td>Development</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.TestDouble">ray/test-double</a></td>
      <td>Test Double</td>
    </tr>
    <tr>
      <td>Asynchronous high performance</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/bearsunday/MyVendor.Swoole">MyVendor.Swoole</a></td>
      <td><a href="https://github.com/swoole/swoole-src">Swoole</a></td>
    </tr>
  </tbody>
</table>

<h2 id="vendor-package">Vendor Package</h2>

<p>You can reuse common packages and tool combinations as modules with only modules and share modules of similar projects.<sup id="fnref:1:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">2</a></sup></p>

<h2 id="semver">Semver</h2>

<p>All packages adhere to <a href="http://semver.org/">Semantic Versioning</a>.</p>

<hr />

<p>(This chapter is not yet updated for the BEAR.Package 1.10+)</p>

<h1 id="production">Production</h1>

<p>In this section, we will cover how to setup the cache and the system for the production environment.</p>

<h2 id="context-1">Context</h2>

<p><code class="language-plaintext highlighter-rouge">prod</code> is the context for production.
Cache is used for root object <code class="language-plaintext highlighter-rouge">$app</code>, annotation reader, etc.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/autoload.php'</span><span class="p">;</span>
<span class="k">exit</span><span class="p">((</span><span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/bootstrap.php'</span><span class="p">)(</span><span class="s1">'prod-api-app'</span><span class="p">));</span>
</code></pre></div></div>

<h2 id="refresh-app">Refresh $app</h2>

<p><strong>IMPORTANT</strong></p>

<p><strong>In production, You need to regenerate $app cache in each deploy.</strong></p>

<p>To regenerate the <code class="language-plaintext highlighter-rouge">$app</code> cache, You <strong>change the timestamp of the <code class="language-plaintext highlighter-rouge">src/</code> directory</strong>. The BEAR.Sunday framework recognise it, then it re-generate <code class="language-plaintext highlighter-rouge">$app</code> and whole DI/AOP files under <code class="language-plaintext highlighter-rouge">tmp/</code> directory.</p>

<h2 id="prodmodule-1">ProdModule</h2>

<p>Set <code class="language-plaintext highlighter-rouge">ProdModule</code> for the application in <code class="language-plaintext highlighter-rouge">src/Module/ProdModule.php</code> to customize the bindings for production and to allow HTTP OPTIONS methods.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">Polidog\Todo\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Package\Context\ProdModule</span> <span class="k">as</span> <span class="nc">PackageProdModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\QueryRepository\CacheVersionModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Module\OptionsMethodModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ProdModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">PackageProdModule</span><span class="p">);</span>       <span class="c1">// default setting (recommended)</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">override</span><span class="p">(</span><span class="k">new</span> <span class="nc">OptionsMethodModule</span><span class="p">);</span>    <span class="c1">// Enable HTTP OPTIONS method in production</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">CacheVersionModule</span><span class="p">(</span><span class="s1">'1'</span><span class="p">));</span> <span class="c1">// Specify version number of resource cache</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<h2 id="cache-1">Cache</h2>

<p>There are two kinds of caches: a local cache that does not share between multiple Web servers and a shared cache that shares. The local cache is used for unchanged cachesafter deploy, such as annotations. The shared cache is used to store the resource state.</p>

<p>Both caches are by default chain cache of [APCu + file cache]. APCu is used preferentially and the write is done to both storages.</p>

<h3 id="resource-cache">Resource Cache</h3>

<p>In order to configure multiple web servers, it is necessary to set shared cache storage. Install ([Memcached] (http://php.net/manual/en/book.memcached.php) or [Redis] (https://redis.io/)) module.</p>

<h3 id="memcached">Memcached</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">BEAR\HelloWorld\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\QueryRepository\StorageMemcachedModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\Context\ProdModule</span> <span class="k">as</span> <span class="nc">PackageProdModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\Scope</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ProdModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// memcache</span>
        <span class="c1">// {host}:{port}:{weight},...</span>
        <span class="nv">$memcachedServers</span> <span class="o">=</span> <span class="s1">'mem1.domain.com:11211:33,mem2.domain.com:11211:67'</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">StorageMemcachedModule</span><span class="p">(</span><span class="n">memcachedServers</span><span class="p">);</span>

        <span class="c1">// Install default ProdModule</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">PackageProdModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="redis">Redis</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// redis</span>
<span class="nv">$redisServer</span> <span class="o">=</span> <span class="s1">'localhost:6379'</span><span class="p">;</span> <span class="c1">// {host}:{port}</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">StorageRedisModule</span><span class="p">(</span><span class="nv">$redisServer</span><span class="p">);</span>
</code></pre></div></div>

<p>When using storage other than the above, create a new module with reference to each module.</p>

<h3 id="set-cache-expiration-ttl">Set cache expiration (TTL)</h3>

<p>To change the default TTL,Install <code class="language-plaintext highlighter-rouge">StorageExpiryModule</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Cache time</span>
<span class="nv">$short</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
<span class="nv">$medium</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">;</span>
<span class="nv">$long</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">;</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">StorageExpiryModule</span><span class="p">(</span><span class="nv">$short</span><span class="p">,</span> <span class="nv">$medium</span><span class="p">,</span> <span class="nv">$long</span><span class="p">);</span>
</code></pre></div></div>
<h3 id="specify-the-cache-version">Specify the cache version</h3>

<p>Resource cache incompatibility is lost In the case of deploy, change the cache version.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$this-&gt;install(new CacheVersionModule($cacheVersion));
</code></pre></div></div>

<p>If you want to destroy the resource cache every time you deploy, assign time and random value to <code class="language-plaintext highlighter-rouge">$ cacheVersion</code>. (This statement is invoked only once after deploy.)</p>

<h2 id="deploy">Deploy</h2>

<h3 id="️-avoid-overwriting-updates">⚠️ Avoid overwriting updates</h3>

<p>Overwriting a running project folder with <code class="language-plaintext highlighter-rouge">rsync</code> or the like has a risk of inconsistency between the resource cache and automatic generation class file created in　<code class="language-plaintext highlighter-rouge">tmp/</code> and the actual class. On heavily loaded sites, it is possible that multiple jobs such as cache creation and opcode creation are executed at the same time, exceeding the performance capacity of the site.</p>

<p>Set up in a different directory and switch it (by symlink) if the setup is OK.</p>

<h3 id="-compilation-recommended">👍🏻 Compilation recommended</h3>

<p>When setting up, you can warm up the project using the <code class="language-plaintext highlighter-rouge">vendor/bin/bear.compile</code> script. The compilation script prepares all static cache files such as dynamically created files and annotations for DI / AOP in advance.</p>

<p>Since injection is done in all classes, there is no problem of DI error at runtime. In addition, although <code class="language-plaintext highlighter-rouge">.env</code> generally contains credential information such as API key and password, all contents are imported into PHP file and can be deleted after compilation. Compilation makes the deployment faster and safer. The optimized autoload.php file and preload.php are also output.</p>

<p><strong>Execution at the console</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vendor/bin/bear.compile 'Polidog\Todo' prod-html-app /path/to/prject
</code></pre></div></div>

<h3 id="autoloadphp">autoload.php</h3>

<p>It will output an autoload.php file optimized for <code class="language-plaintext highlighter-rouge">{project_path}/autoload.php</code>, which is much faster than the <code class="language-plaintext highlighter-rouge">vendor/autoload.php</code> dumped by <code class="language-plaintext highlighter-rouge">composer dumpa-autoload --optimize</code>.</p>

<h3 id="preloadphp">preload.php</h3>

<p>You need to specify <code class="language-plaintext highlighter-rouge">opcache.preload</code> and <code class="language-plaintext highlighter-rouge">opcache.preload</code> in <code class="language-plaintext highlighter-rouge">php.ini</code> to enable preload, a feature supported in PHP 7.4 but not recommended for <code class="language-plaintext highlighter-rouge">7.4.0</code>-<code class="language-plaintext highlighter-rouge">7.4.2</code>.</p>

<p>Example)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opcache.preload=/path/to/project/preload.php
opcache.preload_user=www-data
</code></pre></div></div>

<p>Note: Please refer to bechmark for performance information.</p>

<h2 id="deploy-1">Deploy</h2>

<p>Deployer’s <a href="https://github.com/bearsunday/deploy">BEAR.Sunday recipe</a> is convenient and safe to use. Consider using the other server configuration tool as well as referring or running the Deployer script. Since Deployer generates a project directory each time, you do not have to worry about regenerating <code class="language-plaintext highlighter-rouge">$app</code>.</p>

<h1 id="psr-7">PSR-7</h1>

<p>You can get server side request information using <a href="https://www.php-fig.org/psr/psr-7/">PSR7 HTTP message interface</a>. Also, you can run BEAR.Sunday application as PSR 7 middleware.</p>

<h2 id="http-request">HTTP Request</h2>

<p>PHP has <code class="language-plaintext highlighter-rouge">Superglobals</code> such as <code class="language-plaintext highlighter-rouge">$_SERVER</code> and <code class="language-plaintext highlighter-rouge">$_COOKIE</code>, but instead of using them it receives server side request information using the PSR-7 HTTP message interface.</p>

<h3 id="serverrequest-general">ServerRequest （general）</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">ServerRequestInterface</span> <span class="nv">$serverRequest</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// retrieve cookies</span>
        <span class="nv">$cookie</span> <span class="o">=</span> <span class="nv">$serverRequest</span><span class="o">-&gt;</span><span class="nf">getCookieParams</span><span class="p">();</span> <span class="c1">// $_COOKIE</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="upload-files">Upload Files</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">use</span> <span class="nc">Psr\Http\Message\UploadedFileInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\HttpMessage\Annotation\UploadFiles</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="cd">/**
     * @UploadFiles
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$files</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// retrieve file name</span>
        <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$files</span><span class="p">[</span><span class="s1">'my-form'</span><span class="p">][</span><span class="s1">'details'</span><span class="p">][</span><span class="s1">'avatar'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="cm">/* @var UploadedFileInterface $file */</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="nf">getClientFilename</span><span class="p">();</span> <span class="c1">// my-avatar3.png</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="uri">URI</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">use</span> <span class="nc">Psr\Http\Message\UriInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">UriInterface</span> <span class="nv">$uri</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// retrieve host name</span>
        <span class="nv">$host</span> <span class="o">=</span> <span class="nv">$uri</span><span class="o">-&gt;</span><span class="nf">getHost</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="psr-7-1">PSR-7</h2>

<p>An existing BEAR.Sunday application can work as
a <a href="http://www.php-fig.org/psr/psr-7/">PSR-7</a> middleware with these easy steps:</p>

<p>1) Add <code class="language-plaintext highlighter-rouge">bear/middleware</code> package then replace <a href="https://github.com/bearsunday/BEAR.Middleware/blob/1.x/bootstrap/bootstrap.php">bootstrap.php</a> script.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require bear/middleware
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp </span>vendor/bear/middleware/bootstrap/bootstrap.php bootstrap/bootstrap.php
</code></pre></div></div>

<p>2) Replace <code class="language-plaintext highlighter-rouge">__PACKAGE__\__VENDOR__</code> in bootstrap.php to application namespace.</p>

<p>Stat the server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php <span class="nt">-S</span> 127.0.0.1:8080 <span class="nt">-t</span> public
</code></pre></div></div>

<h3 id="stream">Stream</h3>

<p>BEAR.Sunday supports HTTP body of a message output in a <a href="http://php.net/manual/ja/intro.stream.php">stream</a>.</p>

<p>In <code class="language-plaintext highlighter-rouge">ResourceObject</code>, you can mix stream with a normal string. The output is converted to a single stream.
<code class="language-plaintext highlighter-rouge">StreamTransfer</code> is the default HTTP transfer. Seem more at <a href="http://bearsunday.github.io/manuals/1.0/en/stream.html">Stream Response</a>.</p>

<h3 id="new-project">New Project</h3>

<p>You can also create a BEAR.Sunday PSR-7 project with <code class="language-plaintext highlighter-rouge">bear/project</code> from scratch.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer create-project bear/project my-psr7-project
cd my-psr7-project/
php -S 127.0.0.1:8080 -t public
</code></pre></div></div>

<h3 id="psr-7-middleware">PSR-7 middleware</h3>

<ul>
  <li><a href="https://github.com/oscarotero/psr7-middlewares">oscarotero/psr7-middlewares</a></li>
</ul>

<h1 id="quick-start">Quick Start</h1>

<p>Installation is done via <a href="http://getcomposer.org">composer</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer create-project <span class="nt">-n</span> bear/skeleton MyVendor.MyProject
<span class="nb">cd </span>MyVendor.MyProject
</code></pre></div></div>

<p>Next, let’s create a new resource. A resource is a class which corresponds, for instance, to a JSON payload (if working with an API-first driven model) 
or a web page.
Create your own basic page resource in <code class="language-plaintext highlighter-rouge">src/Resource/Page/Hello.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">MyVendor\MyProject\Resource\Page</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Hello</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'BEAR.Sunday'</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'greeting'</span> <span class="o">=&gt;</span> <span class="s1">'Hello '</span> <span class="mf">.</span> <span class="nv">$name</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the above example, when the page is requested using a GET method, <code class="language-plaintext highlighter-rouge">Hello</code> and <code class="language-plaintext highlighter-rouge">$_GET['name']</code> strings are joined, and assigned to a variable <code class="language-plaintext highlighter-rouge">greeting</code>.
The BEAR.Sunday application that you have created will work on a web server, but also in the console.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/page.php get /hello
php bin/page.php get <span class="s1">'/hello?name=World'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
Content-Type: application/hal+json

<span class="o">{</span>
    <span class="s2">"greeting"</span>: <span class="s2">"Hello World"</span>,
    <span class="s2">"_links"</span>: <span class="o">{</span>
        <span class="s2">"self"</span>: <span class="o">{</span>
            <span class="s2">"href"</span>: <span class="s2">"/hello?name=World"</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Let us fire up the php server and access our page at <a href="http://127.0.0.1:8080/hello">http://127.0.0.1:8080/hello</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php <span class="nt">-S</span> 127.0.0.1:8080 <span class="nt">-t</span> public
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> 127.0.0.1:8080/hello
</code></pre></div></div>

<h1 id="resource">Resource</h1>

<p>A BEAR.Sunday application is <a href="http://en.wikipedia.org/wiki/Representational_state_transfer">RESTful</a> and is made up of a collection of resources connected by links.</p>

<h2 id="object-as-a-service">Object as a service</h2>

<p>An HTTP method is mapped to a PHP method in the <code class="language-plaintext highlighter-rouge">ResourceObject</code> class.
It transfers its resource state as a resource representation from stateless request.
(<a href="http://en.wikipedia.org/wiki/REST">Representational State Transfer)</a></p>

<p>Here are some examples of a resource object:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$code</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$headers</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$a</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$b</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'sum'</span> <span class="o">=&gt;</span> <span class="nv">$a</span> <span class="o">+</span> <span class="nv">$b</span> <span class="c1">// $_GET['a'] + $_GET['b']</span>
        <span class="p">]</span> <span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$todo</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">201</span><span class="p">;</span> <span class="c1">// status code</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span> <span class="o">=</span> <span class="p">[</span> <span class="c1">// header</span>
            <span class="s1">'Location'</span> <span class="o">=&gt;</span> <span class="s1">'/todo/new_id'</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The PHP resource class has URIs such as  <code class="language-plaintext highlighter-rouge">page://self/index</code> similar to the URI of the web, and conforms to the HTTP method <code class="language-plaintext highlighter-rouge">onGet</code>,<code class="language-plaintext highlighter-rouge"> onPost</code>, <code class="language-plaintext highlighter-rouge">onPut</code>,<code class="language-plaintext highlighter-rouge"> onPatch</code>, <code class="language-plaintext highlighter-rouge">onDelete</code> interface.</p>

<p>$_GET for <code class="language-plaintext highlighter-rouge">onGet</code> and $_POST for <code class="language-plaintext highlighter-rouge">onPost</code> are passed to the arguments of the method depending on the variable name, and the methods of <code class="language-plaintext highlighter-rouge">onPut</code>,<code class="language-plaintext highlighter-rouge"> onPatch</code>, <code class="language-plaintext highlighter-rouge">onDelete</code> are content. The value that can be handled according to <code class="language-plaintext highlighter-rouge">content-type</code>(<code class="language-plaintext highlighter-rouge">x-www-form-urlencoded</code> or <code class="language-plaintext highlighter-rouge">application/json</code>) is an argument.</p>

<p>The resource state (<code class="language-plaintext highlighter-rouge">code</code>,<code class="language-plaintext highlighter-rouge">headers</code> or<code class="language-plaintext highlighter-rouge">body</code>) is handled by these method using the given parameters. Then the resource class returns itself(<code class="language-plaintext highlighter-rouge">$this</code>).</p>

<h2 id="uri-1">URI</h2>

<p>URIs are mapped to PHP classes. Applications use the URI instead of the class name to access resources.</p>

<table>
  <thead>
    <tr>
      <th>URI</th>
      <th>Class</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>page://self/index</td>
      <td>Koriym\Todo\Resource\Page\Index</td>
    </tr>
    <tr>
      <td>app://self/blog/posts</td>
      <td>Koriym\Todo\Resource\App\Blog\Posts</td>
    </tr>
  </tbody>
</table>

<h2 id="method">Method</h2>

<p>Resources have 6 interfaces conforming to HTTP methods.<sup id="fnref:method" role="doc-noteref"><a href="#fn:method" class="footnote" rel="footnote">3</a></sup></p>

<h3 id="get">GET</h3>
<p>Reads resources. This method does not provide any changing of the resource state. A safe method with no possible side affects.</p>

<h3 id="post">POST</h3>
<p>The POST method requests processing of the representation contained in the request. For example, adding a new resource to a target URI or adding a representation to an existing resource. Unlike PUT, requests do not have <a href="https://ja.wikipedia.org/wiki/%E5%86%AA%E7%AD%89">idempotence</a>, and multiple consecutive executions will not produce the same result.</p>

<h3 id="put">PUT</h3>
<p>Replaces the resource with the payload of the request at the requested URI. If the target resource does not exist, it is created. Unlike POST, there is not idempotent.</p>

<h3 id="patch">PATCH</h3>

<p>Performs resource updates, but unlike PUT, it applies a delta rather than replacing the entire resource.</p>

<h3 id="delete-1">DELETE</h3>
<p>Resource deletion. Has idempotence just like PUT.</p>

<h3 id="options">OPTIONS</h3>
<p>Get information on parameters and responses required for resource request. It is as secure as GET method.</p>

<h4 id="list-of-method-properties">List of method properties</h4>

<table>
  <thead>
    <tr>
      <th>Methods</th>
      <th><a href="https://developer.mozilla.org/en-US/docs/Glossary/Safe/HTTP">Safe</a></th>
      <th><a href="https://developer.mozilla.org/en-US/docs/Glossary/Idempotent">Idempotent</a></th>
      <th><a href="https://developer.mozilla.org/en-US/docs/Glossary/cacheable">Cacheable</a></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>GET</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td>POST</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <td>PUT</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
    </tr>
    <tr>
      <td>PATCH</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
    </tr>
    <tr>
      <td>DELETE</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
    </tr>
    <tr>
      <td>OPTIONS</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>No</td>
    </tr>
  </tbody>
</table>

<h2 id="parameters">Parameters</h2>

<p>The response method argument is passed the request value corresponding to the variable name.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">// $_GET['id'] to $id</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="c1">// $_POST['name'] to $name</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$name</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>See <a href="resource_param.html">Resource Parameters</a> for other methods and how to pass external variables such as cookies as parameters.</p>

<h2 id="rendering-and-transfer">Rendering and transfer</h2>

<p>The request method of a ResourceObject is not concerned with the representation of the resource. The injected renderer generates the representation of the resource and the responder outputs it. See <a href="resource_renderer.html">Rendering and Transferring</a> for details.</p>

<h2 id="client">Client</h2>

<p>Use the resource client to request other resources. This request executes a request to the <code class="language-plaintext highlighter-rouge">app://self/blog/posts</code> resource with the query <code class="language-plaintext highlighter-rouge">?id=1</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Sunday\Inject\ResourceInject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">ResourceInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'posts'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self/blog/posts'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">])</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Other historical notations include the following</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// PHP 5.x and up</span>
<span class="nv">$posts</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">get</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/posts'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">withQuery</span><span class="p">([</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">eager</span><span class="o">-&gt;</span><span class="nf">request</span><span class="p">();</span>
<span class="c1">// PHP 7.x and up</span>
<span class="nv">$posts</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">get</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/posts'</span><span class="p">)([</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">]);</span>
<span class="c1">// you can omit `get`</span>
<span class="nv">$posts</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/posts'</span><span class="p">)([</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">]);</span>
<span class="c1">// bear/resource 1.11 and up</span>
<span class="nv">$posts</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self/posts'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">]);</span>
</code></pre></div></div>

<h2 id="lazy-evaluation">Lazy evaluation</h2>

<p>The above is an <code class="language-plaintext highlighter-rouge">eager</code> request that makes the request immediately, but it is also possible to generate a request and delay execution instead of the request result.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$request</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self/posts'</span><span class="p">);</span> <span class="c1">// callable</span>
<span class="nv">$posts</span> <span class="o">=</span> <span class="nv">$request</span><span class="p">([</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">]);</span>
</code></pre></div></div>

<p>When this request is embedded in a template or resource, it is evaluated lazily. That is, when it is not evaluated, the request is not made and has no execution cost.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'lazy'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self/posts'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">withQuery</span><span class="p">([</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">])</span><span class="o">-&gt;</span><span class="nf">requrest</span><span class="p">();</span>
<span class="p">];</span>
</code></pre></div></div>

<h2 id="cache-2">Cache</h2>

<p>Along with regular TTL caching, we support REST client caching and advanced partial caching (doughnut caching), including CDN. See <a href="cache.html">cache</a> for details. Also see the previous <a href="resourcev1.html#Resource Cache">resource(v1)</a> document for the previous <code class="language-plaintext highlighter-rouge">@Cacheable</code> annotation.</p>

<h2 id="link-1">Link</h2>

<p>One important REST constraint is resource linking; ResourceObject supports both internal and external linking. See <a href="resource_link.html">Resource Linking</a> for details.</p>

<h2 id="bearresource-1">BEAR.Resource</h2>

<p>The functionality of the BEAR.Sunday resource object is also available in a stand-alone package for stand-alone use: BEAR.Resource <a href="https://github.com/bearsunday/BEAR.Resource/blob/1.x/README.ja.md">README</a>.</p>

<hr />

<h2 id="best-practices">Best Practices</h2>

<p>In REST, resources are connected to other resources. Good use of links makes code concise, easy to read, test and change.</p>

<h3 id="embed-1">#[Embed].</h3>

<p>Embed a resource with <code class="language-plaintext highlighter-rouge">#[Embed]</code> instead of <code class="language-plaintext highlighter-rouge">get</code> the state of another resource.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// OK but not the best</span>
<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ResourceInterface</span> <span class="nv">$resource</span>
    <span class="p">)</span>

    <span class="kt">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$status</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'todos'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/todos'</span><span class="p">)([</span><span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="nv">$status</span><span class="p">])</span> <span class="c1">// lazy request</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Better</span>
<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[@Embed(rel: 'todos', src: 'app://self/todos{?status}')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$status</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="link-2">#[Link]</h3>

<p>The next action indicated by <code class="language-plaintext highlighter-rouge">#[Link]</code> when changing the state of another resource is traced using <code class="language-plaintext highlighter-rouge">href()</code> (hyper reference).</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// OK but not the best</span>
<span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ResourceInterface</span> <span class="nv">$resource</span>
    <span class="p">)</span>

    <span class="kt">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$title</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="s1">'app://self/todo'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">301</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">LOCATION</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'/'</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Better</span>
<span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ResourceInterface</span> <span class="nv">$resource</span>
    <span class="p">)</span>

    <span class="c1">#[Link(rel: 'create', href: 'app://self/todo', method: 'post')]</span>
    <span class="kt">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$title</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">href</span><span class="p">(</span><span class="s1">'create'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">301</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">LOCATION</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'/'</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="resourceparam">#[ResourceParam]</h3>

<p>Use <code class="language-plaintext highlighter-rouge">#[ResourceParam]</code> if you need other resource results to request other resources.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// OK but not the best</span>
<span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ResourceInterface</span> <span class="nv">$resource</span>
    <span class="p">)</span>

    <span class="kt">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$nickname</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self/login-user'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'nickname'</span><span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'profile'</span><span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self/profile'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$nickname</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">body</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Better</span>
<span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ResourceInterface</span> <span class="nv">$resource</span>
    <span class="p">)</span>

    <span class="c1">#[ResourceParam(param: 'name', uri: 'app://self//login-user#nickname')]</span>
    <span class="kt">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$name</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'profile'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self/profile'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">body</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Best</span>
<span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[ResourceParam(param: 'name', uri: 'app://self//login-user#nickname')]</span>
    <span class="c1">#[Embed(rel: 'profile', src: 'app://self/profile')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$name</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'profile'</span><span class="p">]</span><span class="o">-&gt;</span><span class="nf">addQuery</span><span class="p">([</span><span class="s1">'name'</span><span class="o">=&gt;</span><span class="nv">$name</span><span class="p">]);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="reousrce-link">Reousrce link</h1>

<p>Resources can be linked to other resources. There are two types of links: external links <sup id="fnref:LO" role="doc-noteref"><a href="#fn:LO" class="footnote" rel="footnote">4</a></sup>, which link external resources, and internal links <sup id="fnref:LE" role="doc-noteref"><a href="#fn:LE" class="footnote" rel="footnote">5</a></sup>, which embed other resources in the resource itself.</p>

<h2 id="out-bound-links">Out-bound links</h2>

<p>Specify links by <code class="language-plaintext highlighter-rouge">rel</code> (relation) and <code class="language-plaintext highlighter-rouge">href</code> of the link name. The <code class="language-plaintext highlighter-rouge">href</code> can be a regular URI or <a href="https://github.com/ioseb/uri-template">RFC6570 URI template</a>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">#[Link rel: 'profile', href: '/profile{?id}']</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="nv">$id</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="mi">10</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>In the above example, <code class="language-plaintext highlighter-rouge">href</code> is represented by and <code class="language-plaintext highlighter-rouge">$body['id']</code> is assigned to <code class="language-plaintext highlighter-rouge">{?id}</code>. The output in <a href="https://stateless.group/hal_specification.html">HAL</a> format is as follows</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">
    </span><span class="nl">"_links"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"self"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"href"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/test"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"profile"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"href"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/profile?id=10"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="internal-links">Internal links</h2>

<p>A resource can embed another resource. Specify the resource in the <code class="language-plaintext highlighter-rouge">src</code> of <code class="language-plaintext highlighter-rouge">#[Embed]</code>.</p>

<p>Internally linked resources may also internally link other resources. In that case, another internally linked resource is needed, and the process is repeated recursively to obtain a <strong>resource graph</strong>. The client can retrieve the desired set of resources at once without having to fetch the resources multiple times. <sup id="fnref:di" role="doc-noteref"><a href="#fn:di" class="footnote" rel="footnote">6</a></sup> For example, instead of calling a customer resource and a product resource respectively, embed them both in an order resource.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\Embed</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[Embed(rel: 'sports', src: '/news/sports')]</span>
    <span class="c1">#[Embed(rel: 'weather', src: '/news/weather')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
</code></pre></div></div>

<p>It is the resource <strong>request</strong> that is embedded. It is executed at rendering time, but before that you can add arguments with the <code class="language-plaintext highlighter-rouge">addQuery()</code> method or replace them with <code class="language-plaintext highlighter-rouge">withQuery()</code>.</p>

<p>A URI template can be used for the <code class="language-plaintext highlighter-rouge">src</code>, and <strong>request method arguments</strong> will be bound to it. (Unlike external links, it is not <code class="language-plaintext highlighter-rouge">$body</code>)</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\Embed</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[Embed(rel: 'website', src: '/website{?id}']</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'website'</span><span class="p">]</span><span class="o">-&gt;</span><span class="nf">addQuery</span><span class="p">([</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">]);</span> <span class="c1">// 引数追加</span>
</code></pre></div></div>

<p>Handled as <code class="language-plaintext highlighter-rouge">_embedded </code> in the <a href="https://github.com/blongden/hal">HAL</a> renderer.</p>

<h2 id="link-request">Link request</h2>

<p>Clients can link resources connected by hyperlinks.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$blog</span> <span class="o">=</span> <span class="nv">$this</span>
    <span class="o">-&gt;</span><span class="n">resource</span>
    <span class="o">-&gt;</span><span class="n">get</span>
    <span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/user'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">withQuery</span><span class="p">([</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="nf">linkSelf</span><span class="p">(</span><span class="s2">"blog"</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="n">eager</span>
    <span class="o">-&gt;</span><span class="nf">request</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="n">body</span><span class="p">;</span>
</code></pre></div></div>

<p>There are three types of links. The <code class="language-plaintext highlighter-rouge">body</code> linked resource of the original resource is embedded using <code class="language-plaintext highlighter-rouge">$rel</code> as the key.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">linkSelf($rel)</code> which will be replaced with the link destination.</li>
  <li><code class="language-plaintext highlighter-rouge">linkNew($rel)</code> the linked resource is added to the original resource</li>
  <li><code class="language-plaintext highlighter-rouge">linkCrawl($rel)</code> crawl the link and create a resource graph.</li>
</ul>

<h2 id="crawl">crawl</h2>

<p>Crawls are lists (arrays) of resources, and links can be traversed in sequence to compose complex resource graphs.
Just as a crawler crawls a web page, the resource client crawls hyperlinks and generates a source graph.</p>

<h4 id="crawl-example">Crawl Example</h4>

<p>Consider a resource graph with author, post, meta, tag, and tag/name associated with each.
Name this resource graph <strong>post-tree</strong> and specify a hyperreference <strong>href</strong> in the `#[Link]’ attribute of each resource.</p>

<p>The first starting point, the author resource, has a hyperlink to the post resource. 1:n relationship.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[Link(crawl: "post-tree", rel: "post", href: "app://self/post?author_id={id}")]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="nv">$id</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span>
</code></pre></div></div>

<p>The post resource has hyperlinks to the meta and tag resources. 1:n relationship.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[Link(crawl: "post-tree", rel: "meta", href: "app://self/meta?post_id={id}")]</span>
<span class="c1">#[Link(crawl: "post-tree", rel: "tag", href: "app://self/tag?post_id={id}")]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="nv">$author_id</span><span class="p">)</span>
<span class="p">{</span>
</code></pre></div></div>

<p>A tag resource is just an ID with a hyperlink to the corresponding tag/name resource. 1:1 relationship.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[Link(crawl:"post-tree", rel:"tag_name", href:"app://self/tag/name?tag_id={tag_id}")]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">)</span>
</code></pre></div></div>

<p>Each is now connected. Request with a crawl name.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$graph</span> <span class="o">=</span> <span class="nv">$resource</span>
  <span class="o">-&gt;</span><span class="n">get</span>
  <span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/marshal/author'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">linkCrawl</span><span class="p">(</span><span class="s1">'post-tree'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="n">eager</span>
  <span class="o">-&gt;</span><span class="nf">request</span><span class="p">();</span>
</code></pre></div></div>

<p>When a resource client finds a crawl name specified in the #[Link] attribute, it creates a resource graph by connecting resources by their <strong>rel</strong> names.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var_export($graph-&gt;body);

array (
    0 =&gt;
    array (
        'name' =&gt; 'Athos',
        'post' =&gt;
        array (
            0 =&gt;
            array (
                'author_id' =&gt; '1',
                'body' =&gt; 'Anna post #1',
                'meta' =&gt;
                array (
                    0 =&gt;
                    array (
                        'data' =&gt; 'meta 1',
                    ),
                ),
                'tag' =&gt;
                array (
                    0 =&gt;
                    array (
                        'tag_name' =&gt;
                        array (
                            0 =&gt;
                            array (
                                'name' =&gt; 'zim',
                            ),
                        ),
                    ),
 ...
</code></pre></div></div>

<h1 id="resource-parameters">Resource Parameters</h1>

<h2 id="basics">Basics</h2>

<p>Web runtime values such as HTTP requests and cookies that require ResourceObjects are passed directly to the method arguments.</p>

<p>For requests from HTTP, the arguments of the <code class="language-plaintext highlighter-rouge">onGet</code> and <code class="language-plaintext highlighter-rouge">onPost</code> methods are passed <code class="language-plaintext highlighter-rouge">$_GET</code> and <code class="language-plaintext highlighter-rouge">$_POST</code>, respectively, depending on the variable name. For example, <code class="language-plaintext highlighter-rouge">$id</code> in the following is passed <code class="language-plaintext highlighter-rouge">$_GET['id']</code>. Arguments passed as strings when the input is HTTP will be casted to the specified type.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="c1">// ....</span>
</code></pre></div></div>

<h2 id="parameter-type">Parameter type</h2>

<h3 id="scalar-parameters">Scalar parameters</h3>

<p>All parameters passed via HTTP are strings, but if you specify a non-string type such as <code class="language-plaintext highlighter-rouge">int</code>, it will be cast.</p>

<h3 id="array-parameters">Array parameters</h3>

<p>Parameters can be nested data <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">7</a></sup>; data sent as JSON or nested query strings can be received as arrays.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$user</span><span class="p">):</span><span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">'name'</span><span class="p">];</span> <span class="c1">// bear</span>
</code></pre></div></div>

<h3 id="class-parameters">Class Parameters</h3>

<p>Parameters can also be received in a dedicated Input class.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">User</span> <span class="nv">$user</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="c1">// bear</span>
</code></pre></div></div>

<p>The Input class is defined in advance with parameters as public properties.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">php</span>

<span class="kn">namespace</span> <span class="nn">Vendor\App\Input</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="nv">$name</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>At this time, if there is a constructor, it will be called. <sup id="fnref:php8" role="doc-noteref"><a href="#fn:php8" class="footnote" rel="footnote">8</a></sup></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">php</span>

<span class="kn">namespace</span> <span class="nn">Vendor\App\Input</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__constrcut</span><span class="p">(</span>
        <span class="kt">public</span> <span class="n">readonly</span> <span class="n">int</span> <span class="nv">$id</span><span class="p">,</span>
        <span class="kt">public</span> <span class="n">readonly</span> <span class="n">string</span> <span class="nv">$name</span>
    <span class="p">}</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The Input class can implement methods to summarize and validate input data.</p>

<h3 id="enum-parameters">Enum parameters</h3>

<p>You can specify an <a href="https://www.php.net/manual/en/language.types.enumerations.php">enumerated type</a> in PHP8.1 to limit the possible values.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">enum</span> <span class="nc">IceCreamId</span><span class="o">:</span> <span class="n">int</span>
<span class="p">{</span>
    <span class="k">case</span> <span class="no">VANILLA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">case</span> <span class="no">PISTACHIO</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">IceCreamId</span> <span class="nv">$iceCreamId</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$iceCreamId</span><span class="o">-&gt;</span><span class="n">value</span> <span class="c1">// 1 or 2</span>
</code></pre></div></div>

<p>In the above case, if anything other than 1 or 2 is passed, a <code class="language-plaintext highlighter-rouge">ParameterInvalidEnumException</code> will be raised.</p>

<h2 id="web-context-binding">Web context binding</h2>

<p>PHP superglobals such as <code class="language-plaintext highlighter-rouge">$_GET</code> and <code class="language-plaintext highlighter-rouge">$_COOKIE</code> can be bound to method arguments instead of being retrieved in the method.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\WebContextParam\Annotation\QueryParam</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">foo</span><span class="p">(</span>
    	  <span class="c1">#[QueryParam('id')] string $id</span>
    <span class="p">):</span> <span class="kt">static</span> <span class="p">{</span>
       <span class="c1">// $id = $_GET['id'];</span>
</code></pre></div></div>

<p>Others can be done by binding the values of <code class="language-plaintext highlighter-rouge">$_ENV</code>, <code class="language-plaintext highlighter-rouge">$_POST</code>, and <code class="language-plaintext highlighter-rouge">$_SERVER</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\WebContextParam\Annotation\QueryParam</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebContextParam\Annotation\CookieParam</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebContextParam\Annotation\EnvParam</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebContextParam\Annotation\FormParam</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebContextParam\Annotation\ServerParam</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span>
        <span class="c1">#[QueryParam('id')] string $userId,            // $_GET['id'];</span>
        <span class="c1">#[CookieParam('id')] string $tokenId = "0000", // $_COOKIE['id'] or "0000" when unset;</span>
        <span class="c1">#[EnvParam('app_mode')] string $app_mode,      // $_ENV['app_mode'];</span>
        <span class="c1">#[FormParam('token')] string $token,           // $_POST['token'];</span>
        <span class="c1">#[ServerParam('SERVER_NAME') string $server    // $_SERVER['SERVER_NAME'];</span>
    <span class="p">):</span> <span class="kt">static</span> <span class="p">{</span>
</code></pre></div></div>

<p>When the client specifies a value, the specified value takes precedence and the bound value is invalid. This is useful for testing.</p>

<h2 id="resource-binding">Resource Binding</h2>

<p>The <code class="language-plaintext highlighter-rouge">#[ResourceParam]</code> annotation can be used to bind the results of other resource requests to the method argument.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\ResourceParam</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span>
        <span class="c1">#[ResourceParam('app://self//login#nickname') string $name</span>
    <span class="p">):</span> <span class="kt">static</span> <span class="p">{</span>
</code></pre></div></div>

<p>In this example, when the method is called, it makes a <code class="language-plaintext highlighter-rouge">get</code> request to the <code class="language-plaintext highlighter-rouge">login</code> resource and receives <code class="language-plaintext highlighter-rouge">$body['nickname']</code> with <code class="language-plaintext highlighter-rouge">$name</code>.</p>

<h2 id="content-negotiation">Content negotiation</h2>

<p>The <code class="language-plaintext highlighter-rouge">content-type</code> header of HTTP requests is supported. The <code class="language-plaintext highlighter-rouge">application/json</code> and <code class="language-plaintext highlighter-rouge">x-www-form-urlencoded</code> media types are determined and values are passed to the parameters. <sup id="fnref:json" role="doc-noteref"><a href="#fn:json" class="footnote" rel="footnote">9</a></sup>.</p>

<h1 id="rendering-and-transfer-1">Rendering and transfer</h1>

<p>The request method of a ResourceObject is not concerned with the representation of the resource. The context-sensitive injected renderer generates the representation of the resource. The same application can be output in HTML or JSON and benefit by simply changing the context.</p>

<h2 id="lazy-evaluation-1">Lazy evaluation</h2>

<p>Rendering occurs when the resource is string-evaluated.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nv">$weekday</span> <span class="o">=</span> <span class="nv">$api</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self/weekday'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'year'</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">'month'</span><span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'day'</span><span class="o">=&gt;</span> <span class="mi">1</span><span class="p">]);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$weekday</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">);</span>
<span class="c1">//array(1) {</span>
<span class="c1">//    ["weekday"]=&gt;</span>
<span class="c1">//  string(3) "Sat"</span>
<span class="c1">//}</span>

<span class="k">echo</span> <span class="nv">$weekday</span><span class="p">;</span>
<span class="c1">//{</span>
<span class="c1">//    "weekday": "Sat",</span>
<span class="c1">//    "_links": {</span>
<span class="c1">//    "self": {</span>
<span class="c1">//        "href": "/weekday/2000/1/1"</span>
<span class="c1">//        }</span>
<span class="c1">//    }</span>
<span class="c1">//}</span>
</code></pre></div></div>

<h2 id="renderer-1">Renderer</h2>

<p>Each ResourceObject is injected with a renderer for its representation as specified by its context. When performing resource-specific rendering, inject or set the <code class="language-plaintext highlighter-rouge">renderer</code> property.</p>

<p>Example: If you write a renderer for the default JSON representation from scratch</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[Inject]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">setRenderer</span><span class="p">(</span><span class="kt">RenderInterface</span> <span class="nv">$renderer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">renderer</span> <span class="o">=</span> <span class="k">new</span> <span class="kd">class</span> <span class="kd">implements</span> <span class="nc">RenderInterface</span> <span class="p">{</span>
            <span class="k">public</span> <span class="k">function</span> <span class="n">render</span><span class="p">(</span><span class="kt">ResourceObject</span> <span class="nv">$ro</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="s1">'content-type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'application/json;'</span><span class="p">;</span>
                <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">view</span> <span class="o">=</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">);</span>

                <span class="k">return</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="transfer">Transfer</h2>

<p>Transfers the resource representation injected into the root object <code class="language-plaintext highlighter-rouge">$app</code> to the client (console or web client). Normally, output is done with the <code class="language-plaintext highlighter-rouge">header</code> function or <code class="language-plaintext highlighter-rouge">echo</code>, but for large data, etc., <a href="stream.html">stream transfer</a> is useful.</p>

<p>Override the <code class="language-plaintext highlighter-rouge">transfer</code> method to perform resource-specific transfers.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">transfer</span><span class="p">(</span><span class="kt">TransferInterface</span> <span class="nv">$responder</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$server</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$responder</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="nv">$server</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="resource-autonomy">Resource autonomy</h2>

<p>Each resource class has the ability to change its own resource state upon request and transfer it as an expression.</p>

<h1 id="router">Router</h1>

<p>The router converts resource requests for external contexts such as Web and console into resource requests inside BEAR.Sunday.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$request</span> <span class="o">=</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="n">router</span><span class="o">-&gt;</span><span class="nf">match</span><span class="p">(</span><span class="nv">$GLOBALS</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">);</span>
<span class="k">echo</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nv">$request</span><span class="p">;</span>
<span class="c1">// get page://self/user?name=bear</span>
</code></pre></div></div>

<h2 id="web-router">Web Router</h2>

<p>The default web router accesses the resource class corresponding to the HTTP request path (<code class="language-plaintext highlighter-rouge">$_SERVER['REQUEST_URI']</code>).
For example, a request of <code class="language-plaintext highlighter-rouge">/index</code> is accessed by a PHP method corresponding to the HTTP method of the <code class="language-plaintext highlighter-rouge">{Vendor name}\{Project name}\Resource\Page\Index</code> class.</p>

<p>The Web Router is a convention-based router. No configuration or scripting is required.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">MyVendor\MyProject\Resource\Page</span><span class="p">;</span>

<span class="c1">// page://self/index</span>
<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span> <span class="c1">// GET request</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="cli-router">CLI Router</h2>

<p>In the <code class="language-plaintext highlighter-rouge">cli</code> context, the argument from the console is “input of external context”.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/page.php get /
</code></pre></div></div>

<p>The BEAR.Sunday application works on both the Web and the CLI.</p>

<h2 id="multiple-words-uri">Multiple words URI</h2>

<p>The path of the URI using hyphens and using multiple words uses the class name of Camel Case.
For example <code class="language-plaintext highlighter-rouge">/wild-animal</code> requests are accessed to the <code class="language-plaintext highlighter-rouge">WildAnimal</code> class.</p>

<h2 id="parameters-1">Parameters</h2>

<p>The name of the PHP method executed corresponding to the HTTP method and the value passed are as follows.</p>

<p>| HTTP method | PHP method | Parameters |
||
*<a href="https://github.com/bearsunday/bearsunday.github.io/blob/master/manuals/1.0/en/router.md">This document</a> needs to be proofread by native speaker. *</p>

<h1 id="stream-response">Stream Response</h1>

<p>Normally, resources are rendered by renderers into one string and finally <code class="language-plaintext highlighter-rouge">echo</code>ed out, but then you cannot output content whose size exceeds the memory limit of PHP. With <code class="language-plaintext highlighter-rouge">StreamRenderer</code> you can stream HTTP output and you can output large size content while keeping memory consumption low. Stream output can also be used in coexistence with existing renderers.</p>

<h2 id="change-transferer-and-renderer">Change Transferer and Renderer</h2>

<p>Use the <a href="https://github.com/bearsunday/BEAR.Streamer/blob/1.x/src/StreamTransferInject.php">StreamTransferInject</a> trait on the page to render and respond to the stream output. In the example of this download page, since <code class="language-plaintext highlighter-rouge">$body</code> is made to be a resource variable of the stream, the injected renderer is ignored and the resource is streamed.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Streamer\StreamTransferInject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Download</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">StreamTransferInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$headers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'image/jpeg'</span><span class="p">,</span>
        <span class="s1">'Content-Disposition'</span> <span class="o">=&gt;</span> <span class="s1">'attachment; filename="image.jpg"'</span>
    <span class="p">];</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/BEAR.jpg'</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="nv">$fp</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="with-renderers">With Renderers</h2>

<p>Stream output can coexist with conventional renderers. Normally, Twig renderers and JSON renderers generate character strings, but when a stream is assigned to a part of it, the whole is output as a stream.</p>

<p>This is an example of assigning a <code class="language-plaintext highlighter-rouge">string</code> and a <code class="language-plaintext highlighter-rouge">resource</code> variable to the Twig template and generating a page of inline image.</p>

<p>Template</p>

<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;p&gt;</span>Hello, <span class="cp">{{</span> <span class="nv">name</span> <span class="cp">}}</span><span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"data:image/jpg;base64,</span><span class="cp">{{</span> <span class="nv">image</span> <span class="cp">}}</span><span class="s">"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">name</code> assigns the string as usual, but assigns the resource variable of the image file’s pointer resource to<code class="language-plaintext highlighter-rouge"> image</code> with the <code class="language-plaintext highlighter-rouge">base64-encode</code> filter.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Image</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">StreamTransferInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'inline image'</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/image.jpg'</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">);</span>
        <span class="nb">stream_filter_append</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="s1">'convert.base64-encode'</span><span class="p">);</span> <span class="c1">// image base64 format</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">,</span>
            <span class="s1">'image'</span> <span class="o">=&gt;</span> <span class="nv">$fp</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If you want to further control streaming such as streaming bandwidth and timing control, uploading to the cloud, etc use <a href="https://github.com/bearsunday/BEAR.Streamer/blob/1.x/src /StreamResponder.php">StreamResponder</a> which is build for it.</p>

<p>The demo is available at <a href="https://github.com/bearsunday/MyVendor.Stream">MyVendor.Stream</a>.</p>

<hr />
<p><em><a href="https://github.com/bearsunday/bearsunday.github.io/blob/master/manuals/1.0/en/stream.md">This document</a> needs to be proofread by native speaker.</em></p>

<h1 id="swoole">Swoole</h1>

<p>You can execute your BEAR.Sunday application using Swoole directly from the command line. It dramatically improves performance.</p>

<h2 id="install-2">Install</h2>

<h3 id="swoole-install">Swoole Install</h3>

<p>See <a href="https://github.com/swoole/swoole-src#%EF%B8%8F-installation">https://github.com/swoole/swoole-src#%EF%B8%8F-installation</a></p>

<h3 id="bearswoole-install">BEAR.Swoole Install</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require bear/swoole ^0.4
</code></pre></div></div>
<p>Place the bootstrap script at <code class="language-plaintext highlighter-rouge">bin/swoole.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/autoload.php'</span><span class="p">;</span>
<span class="k">exit</span><span class="p">((</span><span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/vendor/bear/swoole/bootstrap.php'</span><span class="p">)(</span>
    <span class="s1">'prod-hal-app'</span><span class="p">,</span>       <span class="c1">// context</span>
    <span class="s1">'MyVendor\MyProject'</span><span class="p">,</span> <span class="c1">// application name</span>
    <span class="s1">'127.0.0.1'</span><span class="p">,</span>          <span class="c1">// IP</span>
    <span class="mi">8080</span>                  <span class="c1">// port</span>
<span class="p">));</span>
</code></pre></div></div>

<h2 id="excute">Excute</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/swoole.php
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Swoole http server is started at http://127.0.0.1:8088
</code></pre></div></div>

<h2 id="benchmarking-site">Benchmarking site</h2>

<p>See <a href="https://github.com/bearsunday/BEAR.HelloworldBenchmark">BEAR.HelloworldBenchmark</a>
You can expect x2 to x10 times bootstrap performance boost.</p>

<ul>
  <li><a href="https://github.com/bearsunday/BEAR.HelloworldBenchmark/wiki">The benchmarking result</a></li>
</ul>

<p><a href="https://github.com/swoole/swoole-src"><img src="https://github.com/swoole/swoole-src/raw/master/mascot.png" /></a></p>

<h1 id="test">Test</h1>

<p>Proper testing makes software better with continuity. A clean application of BEAR.Sunday is test friendly, with all dependencies injected and crosscutting interests provided in the AOP.</p>

<h2 id="run-test">Run test</h2>

<p>Run <code class="language-plaintext highlighter-rouge">vendor/bin/phpunit</code> or <code class="language-plaintext highlighter-rouge">composer test</code>.　Other commands are as follows.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer test    // phpunit test
composer tests   // test + sa + cs
composer coverge // test coverage
composer pcov    // test coverage (pcov)
composer sa      // static analysis
composer cs      // coding standards check
composer cs-fix  // coding standards fix
</code></pre></div></div>

<h2 id="resource-test">Resource test</h2>

<p><strong>Everything is a resource</strong> - BEAR.Sunday application can be tested with resoure access.</p>

<p>This is a test that tests that <code class="language-plaintext highlighter-rouge">201 (Created)</code> will be returned by POSTing <code class="language-plaintext highlighter-rouge">['title' =&gt; 'test']</code> to URI <code class="language-plaintext highlighter-rouge">page://self/todo</code> of <code class="language-plaintext highlighter-rouge">Myvendor\MyProject</code> application in <code class="language-plaintext highlighter-rouge">html-app</code> context.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">TodoTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">ResourceInterface</span> <span class="nv">$resource</span><span class="p">;</span>
    
    <span class="k">protected</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$injector</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">(</span><span class="s1">'test-html-app'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span> <span class="o">=</span> <span class="nv">$injector</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="nc">ResourceInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">testOnPost</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="s1">'page://self/todo'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'test'</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="nc">StatusCode</span><span class="o">::</span><span class="no">CREATED</span><span class="p">,</span> <span class="nv">$page</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="test-double">Test Double</h2>

<p>A Test Double is a substitute that replaces a component on which the software test object depends. Test doubles can have the following patterns</p>

<ul>
  <li>Stub (provides “indirect input” to the test target)</li>
  <li>Mock ( validate “indirect output” from the test target inside a test double)</li>
  <li>Spy (records “indirect output” from the target to be tested)</li>
  <li>Fake (simpler implementation that works closer to the actual object)</li>
  <li><em>Dummy</em> (necessary to generate the test target but no call is made)</li>
</ul>

<h3 id="test-double-binding">Test Double Binding</h3>

<p>There are two ways to change the bundling for a test. One is to change the bundling across all tests in the context module, and the other is to temporarily change the bundling only for a specific purpose within one test only.</p>

<h4 id="context-module">Context Module</h4>

<p>Create a <code class="language-plaintext highlighter-rouge">TestModule</code> to make the <code class="language-plaintext highlighter-rouge">test</code> context available in bootstrap.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TestModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">configure</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">DateTimeInterface</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="k">new</span> <span class="nc">DateTimeImmutable</span><span class="p">(</span><span class="s1">'1970-01-01 00:00:00'</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">Auth</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nc">FakeAuth</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>    
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Injector with test context.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$injector</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">(</span><span class="s1">'test-hal-app'</span><span class="p">,</span> <span class="nv">$module</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="temporary-binding-change">Temporary binding change</h4>

<p>Temporary bundle changes for a single test specify the bundle to override with <code class="language-plaintext highlighter-rouge">Injector::getOverrideInstance</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">testBindFake</span><span class="p">():</span> <span class="kt">void</span>
<span class="p">{</span>
    <span class="nv">$module</span> <span class="o">=</span> <span class="k">new</span> <span class="kd">class</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span> <span class="p">{</span>
        <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">():</span> <span class="kt">void</span>
        <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">FooInterface</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nc">FakeFoo</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nv">$injector</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getOverrideInstance</span><span class="p">(</span><span class="s1">'hal-app'</span><span class="p">,</span> <span class="nv">$module</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="mock">Mock</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">testBindMock</span><span class="p">():</span> <span class="kt">void</span>
<span class="p">{</span> 
    <span class="nv">$mock</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createMock</span><span class="p">(</span><span class="nc">FooInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="c1">// expect that update() will be called once and the parameter will be the string 'something'.</span>
    <span class="n">mock</span><span class="o">-&gt;</span><span class="nf">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">once</span><span class="p">())</span>
             <span class="o">-&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'update'</span><span class="p">)</span>
             <span class="o">-&gt;</span><span class="nf">with</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">equalTo</span><span class="p">(</span><span class="s1">'something'</span><span class="p">));</span>
    <span class="nv">$module</span> <span class="o">=</span> <span class="k">new</span> <span class="kd">class</span><span class="p">(</span><span class="nv">$mock</span><span class="p">)</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span> <span class="p">{</span>
        <span class="k">public</span> <span class="k">function</span> <span class="n">__constcuct</span><span class="p">(</span>
            <span class="kt">private</span> <span class="nc">FooInterface</span> <span class="nv">$foo</span>
        <span class="p">){}</span>
        <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">():</span> <span class="kt">void</span>
        <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">FooInterface</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="nv">$injector</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getOverrideInstance</span><span class="p">(</span><span class="s1">'hal-app'</span><span class="p">,</span> <span class="nv">$module</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="spy">spy</h3>

<p>Installs a <code class="language-plaintext highlighter-rouge">SpyModule</code> by specifying the interface or class name of the spy target. <sup id="fnref:spy-module" role="doc-noteref"><a href="#fn:spy-module" class="footnote" rel="footnote">10</a></sup> After running the SUT containing the spy target, verify the number of calls and the value of the calls in the spy log.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">testBindSpy</span><span class="p">():</span> <span class="kt">void</span>
<span class="p">{</span>
    <span class="nv">$module</span> <span class="o">=</span> <span class="k">new</span> <span class="kd">class</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span> <span class="p">{</span>
        <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">():</span> <span class="kt">void</span>
        <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">SpyModule</span><span class="p">([</span><span class="nc">FooInterface</span><span class="o">::</span><span class="n">class</span><span class="p">]));</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="nv">$injector</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getOverrideInstance</span><span class="p">(</span><span class="s1">'hal-app'</span><span class="p">,</span> <span class="nv">$module</span><span class="p">);</span>
    <span class="nv">$resource</span> <span class="o">=</span> <span class="nv">$injector</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="nc">ResourceInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="c1">// Spy logs of FooInterface objects are logged, whether directly or indirectly.</span>
    <span class="nv">$resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
    <span class="c1">// Spyログの取り出し</span>
    <span class="nv">$spyLog</span> <span class="o">=</span> <span class="nv">$injector</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="err">\</span><span class="nc">Ray\TestDouble\LoggerInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="c1">// @var array&lt;int, Log&gt; $addLog</span>
    <span class="nv">$addLog</span> <span class="o">=</span> <span class="nv">$spyLog</span><span class="o">-&gt;</span><span class="nf">getLogs</span><span class="p">(</span><span class="nc">FooInterface</span><span class="p">,</span> <span class="s1">'add'</span><span class="p">);</span>   
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$addLog</span><span class="p">),</span> <span class="s1">'Should have received once'</span><span class="p">);</span>
    <span class="c1">// Argument validation from SUT</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="nv">$addLog</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">arguments</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$addLog</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">namedArguments</span><span class="p">[</span><span class="s1">'a'</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="dummy">Dummy</h3>

<p>Use <a href="https://ray-di.github.io/manuals/1.0/ja/null_object_binding.html">Null Binding</a> to bind a null object to an interface.</p>

<h2 id="hypermedia-test">Hypermedia Test</h2>

<p>Resource testing is an input/output test for each endpoint. Hypermedia tests, on the other hand, test the workflow behavior of how the endpoints are connected.</p>

<p>Workflow tests are inherited from HTTP tests and are tested at both the PHP and HTTP levels in a single code. HTTP testing is done with <code class="language-plaintext highlighter-rouge">curl</code> and the request/response is logged in a log file.</p>

<h2 id="best-practice">Best Practice</h2>

<ul>
  <li>Test the interface, not the implementation.</li>
  <li>Create a actual fake class rather than using a mock library.</li>
  <li>Testing is a specification. Ease of reading rather than ease of coding.</li>
</ul>

<p>Reference</p>

<ul>
  <li><a href="https://nedbatchelder.com/blog/201206/tldw_stop_mocking_start_testing.html">Stop mocking, start testing</a></li>
  <li><a href="https://www.thoughtworks.com/insights/blog/mockists-are-dead-long-live-classicists">Mockists Are Dead</a></li>
</ul>

<h1 id="tutorial">Tutorial</h1>

<p>This tutorial introduces the basic features of BEAR.Sunday that use resources, DI, AOP, REST API etc.
Each section of the source code of this project is committed at <a href="https://github.com/bearsunday/tutorial/commits/v2-php8.2">bearsunday/tutorial1</a>.</p>

<h2 id="get-started">Get started</h2>

<p>Let’s make a web service that returns the weekday for a given year-month-day.</p>

<p>First, create a new project with <a href="https://getcomposer.org/">composer</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer create-project bear/skeleton MyVendor.Weekday
</code></pre></div></div>

<p>Add the first application resource file at <code class="language-plaintext highlighter-rouge">src/Resource/App/Weekday.php</code></p>

<h2 id="resource-1">Resource</h2>

<p>First, create an application resource file in <code class="language-plaintext highlighter-rouge">src/Resource/App/Weekday.php</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">DateTimeImmutable</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Weekday</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$year</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$month</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$day</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$dateTime</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nc">DateTimeImmutable</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">,</span> <span class="s2">"</span><span class="nv">$year</span><span class="s2">-</span><span class="nv">$month</span><span class="s2">-</span><span class="nv">$day</span><span class="s2">"</span><span class="p">);</span>
        <span class="nv">$weekday</span> <span class="o">=</span> <span class="nv">$dateTime</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'D'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'weekday'</span> <span class="o">=&gt;</span> <span class="nv">$weekday</span><span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This <code class="language-plaintext highlighter-rouge">MyVendor\Weekday\Resource\App\Weekday</code> resource class is mapped to the <code class="language-plaintext highlighter-rouge">/weekday</code> path (by default, Bear.Sunday automatically creates route based on the filename - this point will be explained later).
The request query is automatically converted to PHP method parameters (internally, Bear.Sunday introspect the method parameters).</p>

<p>Let’s try to access it in the console. Let’s try the error first.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php get /weekday
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>400 Bad Request
content-type: application/vnd.error+json

{
    "message": "Bad Request",
    "logref": "e29567cd",
</code></pre></div></div>

<p>Errors are returned with the <a href="https://github.com/blongden/vnd.error">application/vnd.error+json</a> media type.
<code class="language-plaintext highlighter-rouge">400</code> is the error code for a problem with the request. Errors are marked with a <code class="language-plaintext highlighter-rouge">logref</code> ID and can be found in <code class="language-plaintext highlighter-rouge">var/log/</code> for a detailed description of the error.</p>

<p>Next, we will try a correct request with an argument.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php get <span class="s1">'/weekday?year=2001&amp;month=1&amp;day=1'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
Content-Type: application/hal+json

<span class="o">{</span>
    <span class="s2">"weekday"</span>: <span class="s2">"Mon"</span>,
    <span class="s2">"_links"</span>: <span class="o">{</span>
        <span class="s2">"self"</span>: <span class="o">{</span>
            <span class="s2">"href"</span>: <span class="s2">"/weekday?year=2001&amp;month=1&amp;day=1"</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The result is returned successfully with the <code class="language-plaintext highlighter-rouge">application/hal+json</code> media type.
The previous example can be executed as a webservice as well. To do this, fire the built-in PHP server:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php <span class="nt">-S</span> 127.0.0.1:8080 bin/app.php
</code></pre></div></div>

<p>Send a HTTP <code class="language-plaintext highlighter-rouge">GET</code> request with <code class="language-plaintext highlighter-rouge">curl</code> (or type the URL in your browser):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -i 'http://127.0.0.1:8080/weekday?year=2001&amp;month=1&amp;day=1'
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Host: 127.0.0.1:8080
Date: Tue, 04 May 2021 01:55:59 GMT
Connection: close
X-Powered-By: PHP/8.0.3
Content-Type: application/hal+json

{
    "weekday": "Mon",
    "_links": {
        "self": {
            "href": "/weekday/2001/1/1"
        }
    }
}
</code></pre></div></div>

<p>This resource class only has a GET method, therefore <code class="language-plaintext highlighter-rouge">405 Method Not Allowed</code> will be returned with any other HTTP method. Try it out!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -i -X POST 'http://127.0.0.1:8080/weekday?year=2001&amp;month=1&amp;day=1'
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 405 Method Not Allowed
...
</code></pre></div></div>

<p>You can use the OPTIONS method to retrieve the supported HTTP methods and the required parameters in the request. (<a href="https://tools.ietf.org/html/rfc7231#section-4.3.7">RFC7231</a>)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -i -X OPTIONS http://127.0.0.1:8080/weekday
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
...
Content-Type: application/json
Allow: GET

{
    "GET": {
        "parameters": {
            "year": {
                "type": "integer"
            },
            "month": {
                "type": "integer"
            },
            "day": {
                "type": "integer"
            }
        },
        "required": [
            "year",
            "month",
            "day"
        ]
    }
}
</code></pre></div></div>
<h2 id="test-1">Test</h2>

<p>Let’s create a resource test using <a href="https://phpunit.readthedocs.io/ja/latest/">PHPUnit</a>.
Create test file at <code class="language-plaintext highlighter-rouge">tests/Resource/App/WeekdayTest.php</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">MyVendor\Weekday\Injector</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PHPUnit\Framework\TestCase</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">WeekdayTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">ResourceInterface</span> <span class="nv">$resource</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$injector</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">(</span><span class="s1">'app'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span> <span class="o">=</span> <span class="nv">$injector</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="nc">ResourceInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">testOnGet</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$ro</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self/weekday'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'year'</span> <span class="o">=&gt;</span> <span class="s1">'2001'</span><span class="p">,</span> <span class="s1">'month'</span> <span class="o">=&gt;</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'day'</span> <span class="o">=&gt;</span> <span class="s1">'1'</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="s1">'Mon'</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'weekday'</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">setUp()</code>, an application injector that can be created by any object of the application given a context (app).
The <code class="language-plaintext highlighter-rouge">Injector</code> is used to get the resource client (<code class="language-plaintext highlighter-rouge">ResourceInterface</code>), and the test method <code class="language-plaintext highlighter-rouge">testOnGet</code> is used to request and test the resource.</p>

<p>Let’s run it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./vendor/bin/phpunit
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PHPUnit 9.5.4 by Sebastian Bergmann and contributors.

....                                                                4 / 4 (100%)

Time: 00:00.281, Memory: 14.00 MB
</code></pre></div></div>

<p>There are other commands to perform test and code checking.
To get test coverage, run <code class="language-plaintext highlighter-rouge">composer coverage</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer coverage
</code></pre></div></div>

<p><a href="https://pecl.php.net/package/pcov">pcov</a> provides a faster coverage measurement.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer pcov
</code></pre></div></div>

<p>You can see the details of the coverage by opening <code class="language-plaintext highlighter-rouge">build/coverage/index.html</code> with a web browser.</p>

<p>You can inspect whether you are following coding standard with <code class="language-plaintext highlighter-rouge">composer cs</code> command.
Fix it with <code class="language-plaintext highlighter-rouge">composer cs-fix</code> command.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer cs
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer cs-fix
</code></pre></div></div>
<h2 id="static-analysis">Static Analysis</h2>

<p>Static analysis of the code is done with the <code class="language-plaintext highlighter-rouge">composer sa</code> command.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer sa
</code></pre></div></div>

<p>When I ran the code so far, the following error was detected by phpstan.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   
  15     Cannot call method format() on DateTimeImmutable|false.  
  --- 
</code></pre></div></div>

<p>The previous code did not take into account the fact that <code class="language-plaintext highlighter-rouge">DateTimeImmutable::createFromFormat</code> will return false if an invalid value (such as -1 for the year) is passed.</p>

<p>Let’s try it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php get '/weekday?year=-1&amp;month=1&amp;day=1'
</code></pre></div></div>

<p>PHP errors are still caught by the error handler and error messages are displayed with the correct <code class="language-plaintext highlighter-rouge">application/vnd.error+json</code> media type, but
To pass the static parsing check, you can either <code class="language-plaintext highlighter-rouge">assert</code> the result of <code class="language-plaintext highlighter-rouge">DateTimeImmutable</code> or add code to check the type and throw an exception.</p>
<h3 id="assert">assert</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$dateTime</span> <span class="o">=</span><span class="p">(</span><span class="k">new</span> <span class="nc">DateTimeImmutable</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">,</span> <span class="s2">"</span><span class="nv">$year</span><span class="s2">-</span><span class="nv">$month</span><span class="s2">-</span><span class="nv">$day</span><span class="s2">"</span><span class="p">);</span>
<span class="nb">assert</span><span class="p">(</span><span class="nv">$dateTime</span> <span class="k">instanceof</span> <span class="nc">DateTimeImmutable</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="exception">Exception</h3>

<p>First, create a dedicated exception <code class="language-plaintext highlighter-rouge">src/Exception/InvalidDateTimeException.php</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday\Exception</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">RuntimeException</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">InvalidDateTimeException</span> <span class="kd">extends</span> <span class="nc">RuntimeException</span>
<span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Modify the code to inspect the value.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">&lt;?php
</span>
declare(strict_types=1);

namespace MyVendor\Weekday\Resource\App;

use BEAR\Resource\ResourceObject;
<span class="p">use DateTimeImmutable;
</span><span class="gi">+use MyVendor\Weekday\Exception\InvalidDateTimeException;
</span>
class Weekday extends ResourceObject
<span class="err">{</span>
    public function onGet(int $year, int $month, int $day): static
    {
        $dateTime = (new DateTimeImmutable)-&gt;createFromFormat('Y-m-d', "$year-$month-$day");
<span class="gi">+        if (! $dateTime instanceof DateTimeImmutable) {
+            throw new InvalidDateTimeException("$year-$month-$day");
+        }
</span>
        $weekday = $dateTime-&gt;format('D');
        $this-&gt;body = ['weekday' =&gt; $weekday];

        return $this;
    }
<span class="err">}</span>
</code></pre></div></div>

<p>We’ll also add a unit test.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gi">+    public function tesInvalidDateTime(): void
+    {
+        $this-&gt;expectException(InvalidDateTimeException::class);
+        $this-&gt;resource-&gt;get('app://self/weekday', ['year' =&gt; '-1', 'month' =&gt; '1', 'day' =&gt; '1']);
+    }
</span></code></pre></div></div>

<h4 id="best-practices-for-exception-creation">Best Practices for Exception Creation</h4>
<blockquote>
  <p>There is nothing wrong with the code itself, since the exception was caused by a mistake in the input. Such an exception that turns up at runtime is a <code class="language-plaintext highlighter-rouge">RuntimeException</code>. We have extended it to create a dedicated exception.
On the other hand, if the exception is caused by a bug and you need to fix the code, you can extend <code class="language-plaintext highlighter-rouge">LogicException</code> to create an exception. Instead of using the message of the exception to describe the type, create a dedicated exception for each.</p>
</blockquote>

<h4 id="defensive-programming">Defensive programming</h4>

<blockquote>
  <p>This fix eliminates the possibility of false values in <code class="language-plaintext highlighter-rouge">$dateTime</code> when executing <code class="language-plaintext highlighter-rouge">$dateTime-&gt;format('D');</code>. This kind of programming that avoids problems before they occur is called defensive programming, and static analysis is useful for checking it.</p>
</blockquote>

<h4 id="testing-before-committing">Testing before committing</h4>

<p><code class="language-plaintext highlighter-rouge">composer tests</code> performs coding convention (cs) and static analysis (sa) tests in addition to <code class="language-plaintext highlighter-rouge">composer test</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer tests
</code></pre></div></div>

<h2 id="routing">Routing</h2>

<p>A default router is set to <code class="language-plaintext highlighter-rouge">WebRouter</code> which simply maps URL’s to the resource class directory.
To receive a dynamic parameter in URI path, we can use <code class="language-plaintext highlighter-rouge">AuraRouter</code>. This can be done with an override install of the <code class="language-plaintext highlighter-rouge">AuraRouterModule</code> in <code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code>.
Get it with <a href="http://getcomposer.org">composer</a> first.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require bear/aura-router-module ^2.0
</code></pre></div></div>

<p>Next, install the <code class="language-plaintext highlighter-rouge">AuraRouterModule</code> in <code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code></p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">&lt;?php
</span>
declare(strict_types=1);

namespace MyVendor\Weekday\Module;

use BEAR\Dotenv\Dotenv;
<span class="p">use BEAR\Package\AbstractAppModule;
use BEAR\Package\PackageModule;
</span><span class="gi">+use BEAR\Package\Provide\Router\AuraRouterModule;
</span><span class="p">use function dirname;
</span>
class AppModule extends AbstractAppModule
<span class="err">{</span>
    protected function configure(): void
    {
        (new Dotenv())-&gt;load(dirname(__DIR__, 2));
<span class="gi">+        $appDir = $this-&gt;appMeta-&gt;appDir;
+        $this-&gt;install(new AuraRouterModule($appDir . '/var/conf/aura.route.php'));
</span>        $this-&gt;install(new PackageModule());
    }
<span class="err">}</span>

</code></pre></div></div>

<p>This module looks for a router script file at <code class="language-plaintext highlighter-rouge">var/conf/aura.route.php</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="cd">/** 
 * @see http://bearsunday.github.io/manuals/1.0/ja/router.html
 * @var \Aura\Router\Map $map 
 */</span>

<span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">route</span><span class="p">(</span><span class="s1">'/weekday'</span><span class="p">,</span> <span class="s1">'/weekday/{year}/{month}/{day}'</span><span class="p">);</span>
</code></pre></div></div>

<p>Let’s try it out.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php get /weekday/1981/09/08
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
Content-Type: application/hal+json

<span class="o">{</span>
    <span class="s2">"weekday"</span>: <span class="s2">"Tue"</span>,
    <span class="s2">"_links"</span>: <span class="o">{</span>
        <span class="s2">"self"</span>: <span class="o">{</span>
            <span class="s2">"href"</span>: <span class="s2">"/weekday/1981/09/08"</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="di-1">DI</h2>

<p>To demonstrate the power of DI, let’s log a result !</p>

<p>First create <code class="language-plaintext highlighter-rouge">src/MyLoggerInterface.php</code> which logs the days of the week.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday</span><span class="p">;</span>

<span class="kd">interface</span> <span class="nc">MyLoggerInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">log</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$message</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Change the resource to use this logger.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">&lt;?php
</span><span class="p">namespace MyVendor\Weekday\Resource\App;
</span>
use BEAR\Resource\ResourceObject;
<span class="p">use MyVendor\Weekday\MyLoggerInterface;
</span>
class Weekday extends ResourceObject
<span class="err">{</span>
+    public function __construct(public MyLoggerInterface $logger)
<span class="gi">+    {
+    }
</span>
    public function onGet(int $year, int $month, int $day): static
    {
        $weekday = (new DateTimeImmutable)-&gt;createFromFormat('Y-m-d', "$year-$month-$day")-&gt;format('D');
        $this-&gt;body = [
            'weekday' =&gt; $weekday
        ];
<span class="gi">+        $this-&gt;logger-&gt;log("$year-$month-$day {$weekday}");
</span>
        return $this;
    }
<span class="err">}</span>
</code></pre></div></div>
<p>A naive approach is to instantiate a logger object with the new operator whenever you need it.
However this approach is strongly discouraged (and make testing much harder). Instead, your objects should receive a created instance as a constructor dependency.
This is called the <a href="https://en.wikipedia.org/wiki/Dependency_injection">DI pattern</a>.</p>

<p>Next we will implement <code class="language-plaintext highlighter-rouge">MyLoggerInterface</code> in<code class="language-plaintext highlighter-rouge"> MyLogger</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\AppMeta\AbstractAppMeta</span><span class="p">;</span>

<span class="kn">use</span> <span class="k">function</span> <span class="nf">error_log</span><span class="p">;</span>

<span class="kn">use</span> <span class="k">const</span> <span class="nf">PHP_EOL</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyLogger</span> <span class="kd">implements</span> <span class="nc">MyLoggerInterface</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="nv">$logFile</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">AbstractAppMeta</span> <span class="nv">$meta</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">logFile</span> <span class="o">=</span> <span class="nv">$meta</span><span class="o">-&gt;</span><span class="n">logDir</span> <span class="mf">.</span> <span class="s1">'/weekday.log'</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">log</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$message</span><span class="p">):</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nb">error_log</span><span class="p">(</span><span class="nv">$message</span> <span class="mf">.</span> <span class="kc">PHP_EOL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">logFile</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In order to implement <code class="language-plaintext highlighter-rouge">MyLogger</code> you need the application’s log directory information (<code class="language-plaintext highlighter-rouge">AbstractAppMeta</code>), but this is also accepted as <code class="language-plaintext highlighter-rouge">dependency</code> in the constructor.
In other words, the <code class="language-plaintext highlighter-rouge">Weekday</code> resource depends on<code class="language-plaintext highlighter-rouge"> MyLogger</code>, but <code class="language-plaintext highlighter-rouge">MyLogger</code> also depends on the log directory information. Objects built with DI in this way are dependencies depend on .. and dependency assignments are made.</p>

<p>It is the DI tool (dependency injector) that makes this dependency solution.</p>

<p>Edit the <code class="language-plaintext highlighter-rouge">configure</code> method of<code class="language-plaintext highlighter-rouge"> src/Module/AppModule.php</code> to bind <code class="language-plaintext highlighter-rouge">MyLoggerInterface</code> and<code class="language-plaintext highlighter-rouge"> MyLogger</code> with the DI tool.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">class AppModule extends AbstractAppModule
</span><span class="err">{</span>
    protected function configure(): void
    {
        (new Dotenv())-&gt;load(dirname(__DIR__, 2));
        $appDir = $this-&gt;appMeta-&gt;appDir;
        $this-&gt;install(new AuraRouterModule($appDir . '/var/conf/aura.route.php'));
<span class="gi">+        $this-&gt;bind(MyLoggerInterface::class)-&gt;to(MyLogger::class);
</span>        $this-&gt;install(new PackageModule());
    }
<span class="err">}</span>
</code></pre></div></div>

<p>Now all classes can now accept loggers with <code class="language-plaintext highlighter-rouge">MyLoggerInterface</code> in the constructor.
Let’s make sure that the result is output to <code class="language-plaintext highlighter-rouge">var/log/cli-hal-api-app/weekday.log</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php get /weekday/2011/05/23
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>var/log/cli-hal-api-app/weekday.log
</code></pre></div></div>

<h2 id="aop-1">AOP</h2>

<p>We can benchmarking method invocation like is often done like this.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$start</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="c1">// method invokation</span>
<span class="nv">$time</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$start</span><span class="p">;</span>
</code></pre></div></div>

<p>Changing code to benchmark each different method can be tedious.
For such problems <a href="https://github.com/google/guice/wiki/AOP">Aspect Oriented Programming</a> works great. Using this concept you can compose a clean separation of a <code class="language-plaintext highlighter-rouge">cross cutting concern</code> and <code class="language-plaintext highlighter-rouge">core concern</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday\Interceptor</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">MyVendor\Weekday\MyLoggerInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Aop\MethodInterceptor</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Aop\MethodInvocation</span><span class="p">;</span>

<span class="kn">use</span> <span class="k">function</span> <span class="n">microtime</span><span class="p">;</span>
<span class="kn">use</span> <span class="k">function</span> <span class="n">sprintf</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">BenchMarker</span> <span class="kd">implements</span> <span class="nc">MethodInterceptor</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">private</span> <span class="nc">MyLoggerInterface</span> <span class="nv">$logger</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">invoke</span><span class="p">(</span><span class="kt">MethodInvocation</span> <span class="nv">$invocation</span><span class="p">):</span> <span class="kt">mixed</span>
    <span class="p">{</span>
        <span class="nv">$start</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="nf">proceed</span><span class="p">();</span> <span class="c1">// Execute the original method</span>
        <span class="nv">$time</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$start</span><span class="p">;</span>
        <span class="nv">$message</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'%s: %0.5f(µs)'</span><span class="p">,</span> <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="nf">getMethod</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">(),</span> <span class="nv">$time</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">logger</span><span class="o">-&gt;</span><span class="nb">log</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ou can invoke the original method with <code class="language-plaintext highlighter-rouge">$invocation-&gt;proceed();</code> inside an <code class="language-plaintext highlighter-rouge">invoke</code> method.
You can then reset and stop the timer on before and after this is invoked. The target method object and method name is taken in the form of a <a href="https://github.com/ray-di/Ray.Aop/blob/2.x/src/MethodInvocation.php">MethodInvocation</a> object sent to the invoke method.</p>

<p>Next, create an <a href="https://www.php.net/manual/en/language.attributes.overview.php">attribute</a> in <code class="language-plaintext highlighter-rouge">src/Annotation/BenchMark.php </code> to mark the methods you want to benchmark. to create it.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday\Annotation</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Attribute</span><span class="p">;</span>

<span class="c1">#[Attribute(Attribute::TARGET_METHOD)]</span>
<span class="k">final</span> <span class="kd">class</span> <span class="nc">BenchMark</span>
<span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">AppModule</code>, bind the methods that apply the interceptor using <strong>Matcher</strong>.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gi">+use MyVendor\Weekday\Annotation\BenchMark;
+use MyVendor\Weekday\Interceptor\BenchMarker;
</span>
class AppModule extends AbstractAppModule
<span class="err">{</span>
    protected function configure(): void
    {
        (new Dotenv())-&gt;load(dirname(__DIR__, 2));
        $appDir = $this-&gt;appMeta-&gt;appDir;
        $this-&gt;install(new AuraRouterModule($appDir . '/var/conf/aura.route.php'));
        $this-&gt;bind(MyLoggerInterface::class)-&gt;to(MyLogger::class);
<span class="gi">+        $this-&gt;bindInterceptor(
+            $this-&gt;matcher-&gt;any(),                           // In any class,
+            $this-&gt;matcher-&gt;annotatedWith(BenchMark::class), // To #[BenchMark] attributed method
+            [BenchMarker::class]                             // Apply BenchMarker interceptor interception
+        );
</span>        $this-&gt;install(new PackageModule());
    }
<span class="err">}</span>
</code></pre></div></div>

<p>Give the method you want to benchmark an attribute of <code class="language-plaintext highlighter-rouge">#[BenchMark]</code>.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gi">+use MyVendor\Weekday\Annotation\BenchMark;
</span>
class Weekday extends ResourceObject
<span class="err">{</span>

<span class="gi">+   #[BenchMark]
</span>    public function onGet(int $year, int $month, int $day): static
    {
</code></pre></div></div>

<p>Now, you can benchmark any method you want by adding the attribute <code class="language-plaintext highlighter-rouge">#[BenchMark]</code> to it.</p>

<p>Adding functionality through attributes and interceptors is flexible. There is no change to the target method or the caller of the method.
Annotations can be left as is or unbound to avoid benchmarking. For example, you can bind them only during development and warn the user if the number of seconds exceeds a certain value.</p>

<p>Run it and make sure that the log of execution time is output to <code class="language-plaintext highlighter-rouge">var/log/weekday.log</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php get <span class="s1">'/weekday/2015/05/28'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>var/log/cli-hal-api-app/weekday.log
</code></pre></div></div>

<h2 id="html-1">HTML</h2>

<p>While modern applications will likely be API-first, you can turn this API application into an HTML application. Go ahead and create a new <code class="language-plaintext highlighter-rouge">page</code> resource at <code class="language-plaintext highlighter-rouge">src/Resource/Page/Index.php</code>. Even though <code class="language-plaintext highlighter-rouge">page</code> resource and <code class="language-plaintext highlighter-rouge">app</code> resource are effectively the same class, their role and location differs.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday\Resource\Page</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">MyVendor\Weekday\Resource\App\Weekday</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">private</span> <span class="nc">Weekday</span> <span class="nv">$weekday</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$year</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$month</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$day</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$weekday</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">weekday</span><span class="o">-&gt;</span><span class="nf">onGet</span><span class="p">(</span><span class="nv">$year</span><span class="p">,</span> <span class="nv">$month</span><span class="p">,</span> <span class="nv">$day</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'year'</span> <span class="o">=&gt;</span> <span class="nv">$year</span><span class="p">,</span>
            <span class="s1">'month'</span> <span class="o">=&gt;</span> <span class="nv">$month</span><span class="p">,</span>
            <span class="s1">'day'</span> <span class="o">=&gt;</span> <span class="nv">$day</span><span class="p">,</span>
            <span class="s1">'weekday'</span> <span class="o">=&gt;</span> <span class="nv">$weekday</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'weekday'</span><span class="p">]</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">page</code> resource class is essentially the same class as the <code class="language-plaintext highlighter-rouge">app</code> resource, except for its location and role.</p>

<p>In a typical scenario, the <code class="language-plaintext highlighter-rouge">page</code> is a publicly available HTML page, and the <code class="language-plaintext highlighter-rouge">app</code> is a private resource when used with the <code class="language-plaintext highlighter-rouge">page</code>, close to the infrastructure layer such as a DB.
Which one is made public is determined by the runtime context; in the MVC analogy, the app resource plays the role of the model and the page resource plays the role of the controller.
The app resource is the model and the page resource is the controller.</p>

<p>At this stage let’s check how this resource is rendered.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/page.php get <span class="s1">'/?year=2000&amp;month=1&amp;day=1'</span>
</code></pre></div></div>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">500</span> <span class="nc">Internal</span> <span class="nc">Server</span> <span class="nc">Error</span>
<span class="n">content</span><span class="o">-</span><span class="n">type</span><span class="o">:</span> <span class="n">application</span><span class="o">/</span><span class="n">vnd</span><span class="mf">.</span><span class="n">error</span><span class="o">+</span><span class="n">json</span>

<span class="p">{</span>
    <span class="s2">"message"</span><span class="o">:</span> <span class="s2">"Internal Server Error"</span><span class="p">,</span>
    <span class="s2">"logref"</span><span class="o">:</span> <span class="s2">"477f34d9"</span><span class="p">,</span>
    <span class="s2">"request"</span><span class="o">:</span> <span class="s2">"get page://self/?year=1991&amp;month=8&amp;day=1"</span><span class="p">,</span>
    <span class="s2">"exceptions"</span><span class="o">:</span> <span class="s2">"Ray</span><span class="se">\\</span><span class="s2">Di</span><span class="se">\\</span><span class="s2">Exception</span><span class="se">\\</span><span class="s2">Unbound(dependency 'MyVendor</span><span class="se">\\</span><span class="s2">Weekday</span><span class="se">\\</span><span class="s2">Resource</span><span class="se">\\</span><span class="s2">App</span><span class="se">\\</span><span class="s2">Weekday' with name '' used in src/Resource/Page/Index.php:12 (</span><span class="nv">$weekday</span><span class="s2">))"</span><span class="p">,</span>
</code></pre></div></div>

<p>Error! This is an error that the Weekday injected into the Index is unbound.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gi">+    $this-&gt;bind(Weekday::class);
</span>     $this-&gt;install(new AuraSqlModule(sprintf('sqlite:%s/var/db/todo.sq3', this-&gt;appMeta-&gt;appDir)));
     $this-&gt;install(new PackageModule());.
</code></pre></div></div>
<p>Bind Weekday with AppModule as above.
Such binding of a concrete class is called <a href="https://ray-di.github.io/manuals/1.0/en/untargeted_bindings.html">untargeted binding</a>. Normally, a concrete class is bound to an interface, but a concrete class without an interface is bound directly.</p>

<p>Run it again.</p>

<pre><code class="language-`bash">php bin/page.php get '/?year=2000&amp;month=1&amp;day=1'
</code></pre>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
Content-Type: application/hal+json

{
    "year": 2000,
    "month": 1,
    "day": 1,
    "weekday": "Sat",
    "_links": {
        "self": {
            "href": "/index?year=2000&amp;month=1&amp;day=1"
        }
    }
}

</code></pre></div></div>

<p>The resource is output as <code class="language-plaintext highlighter-rouge">application/hal+json</code> media type, but to output it as HTML (text/html), install the HTML module. See <a href="/manuals/1.0/en/html.html">Manual for HTML</a>.</p>

<p>Composer Install</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require madapaja/twig-module ^2.0
</code></pre></div></div>

<p>Create <code class="language-plaintext highlighter-rouge">src/Module/HtmlModule.php</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\TwigErrorPageModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\TwigModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\AbstractModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">HtmlModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigModule</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigErrorPageModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Copy <code class="language-plaintext highlighter-rouge">templates</code> directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> <span class="nt">-r</span> vendor/madapaja/twig-module/var/templates var
</code></pre></div></div>

<p>Modify <code class="language-plaintext highlighter-rouge">bin/page.php</code> to set the context to <code class="language-plaintext highlighter-rouge">html-app</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">use</span> <span class="nc">MyVendor\Weekday\Bootstrap</span><span class="p">;</span>

<span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/autoload.php'</span><span class="p">;</span>
<span class="k">exit</span><span class="p">((</span><span class="k">new</span> <span class="nc">Bootstrap</span><span class="p">())(</span><span class="kc">PHP_SAPI</span> <span class="o">===</span> <span class="s1">'cli'</span> <span class="o">?</span> <span class="s1">'cli-html-app'</span> <span class="o">:</span> <span class="s1">'html-app'</span><span class="p">,</span> <span class="nv">$GLOBALS</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">));</span>
</code></pre></div></div>

<p>In this way <code class="language-plaintext highlighter-rouge">text/html</code> media output can be set. Lastly, save your Twig template <code class="language-plaintext highlighter-rouge">var/templates/Page/Index.html.twig</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>% extends <span class="s1">'layout/base.html.twig'</span> %<span class="o">}</span>
<span class="o">{</span>% block title %<span class="o">}</span>Weekday<span class="o">{</span>% endblock %<span class="o">}</span>
<span class="o">{</span>% block content %<span class="o">}</span>
The weekday of <span class="o">{{</span> year <span class="o">}}</span>/<span class="o">{{</span> month <span class="o">}}</span>/<span class="o">{{</span> day <span class="o">}}</span> is <span class="o">{{</span> weekday <span class="o">}}</span><span class="nb">.</span>
<span class="o">{</span>% endblock %<span class="o">}</span>
</code></pre></div></div>

<p>Set up is now complete. Check in the console that this kind of HTML is output.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/page.php get <span class="s1">'/?year=1991&amp;month=8&amp;day=1'</span>
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
Content-Type: text/html; charset=utf-8

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
...
</code></pre></div></div>

<p>In order to run the web service, we need to make a change to <code class="language-plaintext highlighter-rouge">public/index.php</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">use</span> <span class="nc">MyVendor\Weekday\Bootstrap</span><span class="p">;</span>

<span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/autoload.php'</span><span class="p">;</span>
<span class="k">exit</span><span class="p">((</span><span class="k">new</span> <span class="nc">Bootstrap</span><span class="p">())(</span><span class="kc">PHP_SAPI</span> <span class="o">===</span> <span class="s1">'cli-server'</span> <span class="o">?</span> <span class="s1">'html-app'</span> <span class="o">:</span> <span class="s1">'prod-html-app'</span><span class="p">,</span> <span class="nv">$GLOBALS</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">));</span>
</code></pre></div></div>

<p>Boot up the PHP web server and check it out by accessing <a href="http://127.0.0.1:8080/?year=2001&amp;month=1&amp;day=1">http://127.0.0.1:8080/?year=2001&amp;month=1&amp;day=1</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php <span class="nt">-S</span> 127.0.0.1:8080 public/index.php
</code></pre></div></div>

<p>As the <a href="/manuals/1.0/en/application.html#context">context</a> changes, so does the behaviour of the application. Let’s try it.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">php</span>

<span class="kn">use</span> <span class="nc">MyVendor\Weekday\Bootstrap</span><span class="p">;</span>

<span class="c1">// JSON Application (smallest)</span>
<span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/autoload.php'</span><span class="p">;</span>
<span class="k">exit</span><span class="p">((</span><span class="k">new</span> <span class="nc">Bootstrap</span><span class="p">())(</span><span class="s1">'prod-app'</span><span class="p">,</span> <span class="nv">$GLOBALS</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">));</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">php</span>

<span class="kn">use</span> <span class="nc">MyVendor\Weekday\Bootstrap</span><span class="p">;</span>

<span class="c1">// Production HAL Application</span>
<span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/autoload.php'</span><span class="p">;</span>
<span class="k">exit</span><span class="p">((</span><span class="k">new</span> <span class="nc">Bootstrap</span><span class="p">())(</span><span class="s1">'prod-hal-app'</span><span class="p">,</span> <span class="nv">$GLOBALS</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">));</span>
</code></pre></div></div>

<p>For each context PHP code that builds up the application is produced and saved in <code class="language-plaintext highlighter-rouge">var/tmp/</code>. These files are not normally needed, but you can use it to check how your application object is created. Using the <code class="language-plaintext highlighter-rouge">diff</code> command you can check which dependencies have changed across contexts.</p>

<h2 id="rest-api">REST API</h2>

<p>Let’s make an application resource that uses SQLite3.
First, using the console, create a database <code class="language-plaintext highlighter-rouge">var/db/todo.sqlite3</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>var/db
sqlite3 var/db/todo.sqlite3

sqlite&gt; create table todo<span class="o">(</span><span class="nb">id </span>integer primary key, todo, created_at<span class="o">)</span><span class="p">;</span>
sqlite&gt; .exit
</code></pre></div></div>

<p>For database access you can choose from <a href="https://github.com/ray-di/Ray.AuraSqlModule">AuraSql</a>, <a href="https://github.com/ray-di/Ray.DbalModule">Doctrine Dbal</a>, <a href="https://github.com/ray-di/Ray.CakeDbModule"> CakeDB</a>.
AuraSqlModule. Let’s install it here.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require ray/aura-sql-module
</code></pre></div></div>

<p>Install the module in <code class="language-plaintext highlighter-rouge">src/Module/AppModule::configure()</code>.
Then bind <code class="language-plaintext highlighter-rouge">DateTimeImmutable</code> so that the constructor can receive the current time.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">&lt;?php
</span><span class="gi">+use Ray\AuraSqlModule\AuraSqlModule;
+use DateTimeImmutable;
</span>
class AppModule extends AbstractAppModule
<span class="err">{</span>
    protected function configure(): void
    {
        // ...
<span class="gi">+        $this-&gt;bind(DateTimeImmutable::class);        
+        $this-&gt;install(new AuraSqlModule(sprintf('sqlite:%s/var/db/todo.sqlite3', $this-&gt;appMeta-&gt;appDir)));
</span>        $this-&gt;install(new PackageModule());
    }
<span class="err">}</span>
</code></pre></div></div>

<p>Build up the <code class="language-plaintext highlighter-rouge">src/Resource/App/Todos.php</code> resource.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Aura\Sql\ExtendedPdoInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\Annotation\ReturnCreatedResource</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\Cacheable</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">DateTimeImmutable</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\Annotation\Transactional</span><span class="p">;</span>

<span class="kn">use</span> <span class="k">function</span> <span class="n">sprintf</span><span class="p">;</span>

<span class="c1">#[Cacheable]</span>
<span class="kd">class</span> <span class="nc">Todos</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ExtendedPdoInterface</span> <span class="nv">$pdo</span><span class="p">,</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">DateTimeImmutable</span> <span class="nv">$date</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span> <span class="o">=</span> <span class="s1">''</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="nv">$id</span> <span class="o">?</span> <span class="cd">/** @lang SQL */</span><span class="s1">'SELECT * FROM todo WHERE id=:id'</span> <span class="o">:</span> <span class="cd">/** @lang SQL */</span><span class="s1">'SELECT * FROM todo'</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">fetchAssoc</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">]);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">#[Transactional, ReturnCreatedResource]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$todo</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">perform</span><span class="p">(</span><span class="cd">/** @lang SQL */</span><span class="s1">'INSERT INTO todo (todo, created_at) VALUES (:todo, :created_at)'</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'todo'</span> <span class="o">=&gt;</span> <span class="nv">$todo</span><span class="p">,</span>
            <span class="s1">'created_at'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">date</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d H:i:s'</span><span class="p">)</span>
        <span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">201</span><span class="p">;</span> <span class="c1">// Created</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'/todos?id=%s'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">lastInsertId</span><span class="p">());</span> <span class="c1">// new URL</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">#[Transactional]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPut</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$todo</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">perform</span><span class="p">(</span><span class="cd">/** @lang SQL */</span><span class="s1">'UPDATE todo SET todo = :todo WHERE id = :id'</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">,</span>
            <span class="s1">'todo'</span> <span class="o">=&gt;</span> <span class="nv">$todo</span>
        <span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">204</span><span class="p">;</span> <span class="c1">// No content</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>See the attributes. The class attribute <code class="language-plaintext highlighter-rouge">#[Cacheable]</code> indicates that the GET method of this resource is cacheable.
The <code class="language-plaintext highlighter-rouge">#[Transactional]</code> of <code class="language-plaintext highlighter-rouge">onPost</code> or <code class="language-plaintext highlighter-rouge">onPut</code> indicates a transaction of database access.</p>

<p>Creates an <code class="language-plaintext highlighter-rouge">onPost</code> <code class="language-plaintext highlighter-rouge">#[ReturnCreatedResource]</code> and returns the resource whose URL is given in the <code class="language-plaintext highlighter-rouge">Location</code>, including the body.
At this time, <code class="language-plaintext highlighter-rouge">onGet</code> is actually called with the URI in the <code class="language-plaintext highlighter-rouge">Location</code> header, so the content of the <code class="language-plaintext highlighter-rouge">Location</code> header is guaranteed to be correct, and calling <code class="language-plaintext highlighter-rouge">onGet</code> will also create a cache.</p>

<p>Let’s try a <code class="language-plaintext highlighter-rouge">POST</code>.</p>

<p>In order to enable caching , create the context of <code class="language-plaintext highlighter-rouge">bin/app.php</code> <code class="language-plaintext highlighter-rouge">test</code> for caching.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">use</span> <span class="nc">MyVendor\Weekday\Bootstrap</span><span class="p">;</span>

<span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/autoload.php'</span><span class="p">;</span>
<span class="k">exit</span><span class="p">((</span><span class="k">new</span> <span class="nc">Bootstrap</span><span class="p">())(</span><span class="s1">'prod-cli-hal-api-app'</span><span class="p">,</span> <span class="nv">$GLOBALS</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">));</span>
</code></pre></div></div>

<p>Request with console command. <code class="language-plaintext highlighter-rouge">POST</code>, but for convenience we pass parameters in the form of a query.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/test.php post <span class="s1">'/todos?todo=shopping'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>201 Created
Location: /todos?id<span class="o">=</span>1

<span class="o">{</span>
    <span class="s2">"id"</span>: <span class="s2">"1"</span>,
    <span class="s2">"todo"</span>: <span class="s2">"shopping"</span>,
    <span class="s2">"created"</span>: <span class="s2">"2017-06-04 15:58:03"</span>,
    <span class="s2">"_links"</span>: <span class="o">{</span>
        <span class="s2">"self"</span>: <span class="o">{</span>
            <span class="s2">"href"</span>: <span class="s2">"/todos?id=1"</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Our response returned a <code class="language-plaintext highlighter-rouge">201</code> status code, and a new resource <code class="language-plaintext highlighter-rouge">/todo/?id=1</code> has been created.　<a href="https://tools.ietf.org/html/rfc7231#section-6.3.2">RFC7231 Section-6.3.2</a>
Next we will do a <code class="language-plaintext highlighter-rouge">GET</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/test.php get <span class="s1">'/todos?id=1'</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
ETag: 2527085682
Last-Modified: Sun, 04 Jun 2017 15:23:39 GMT
content-type: application/hal+json

{
    "id": "1",
    "todo": "shopping",
    "created": "2017-06-04 15:58:03",
    "_links": {
        "self": {
            "href": "/todos?id=1"
        }
    }
}
</code></pre></div></div>

<p>The HTTP API is now complete. Let’s start up the API server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php <span class="nt">-S</span> 127.0.0.1:8081 bin/app.php
</code></pre></div></div>

<p>Let’s do a GET <code class="language-plaintext highlighter-rouge">curl</code> request:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> <span class="s1">'http://127.0.0.1:8081/todos?id=1'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Host: 127.0.0.1:8081
Date: Sun, 02 May 2021 17:10:55 GMT
Connection: close
X-Powered-By: PHP/8.0.3
Content-Type: application/hal+json
ETag: 197839553
Last-Modified: Sun, 02 May 2021 17:10:55 GMT
Cache-Control: max-age<span class="o">=</span>31536000

<span class="o">{</span>
    <span class="s2">"id"</span>: <span class="s2">"1"</span>,
</code></pre></div></div>

<p>If you run the request several times, you will notice that the <code class="language-plaintext highlighter-rouge">Last-Modified</code> timestamp does not change. This is because the class is annotated with <code class="language-plaintext highlighter-rouge">#[Cacheable]</code>.</p>

<p>On the <code class="language-plaintext highlighter-rouge">#[Cacheable]</code> attribute, if no <code class="language-plaintext highlighter-rouge">expiry</code> is set then it will be cached forever. However when updates <code class="language-plaintext highlighter-rouge">onPut($id, $todo)</code> or deletes <code class="language-plaintext highlighter-rouge">onDelete($id)</code> occur on the resource, the cached resource will automatically be flushed and refreshed for the given ID.
Next we update the resource with a <code class="language-plaintext highlighter-rouge">PUT</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> http://127.0.0.1:8081/todos <span class="nt">-X</span> PUT <span class="nt">-d</span> <span class="s2">"id=1&amp;todo=think"</span>
</code></pre></div></div>
<p>You will get a response of <code class="language-plaintext highlighter-rouge">204 No Content</code> indicating that there is no body.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 204 No Content
...
</code></pre></div></div>

<p>If you would rather send a JSON body with the PUT request you can run the following.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> http://127.0.0.1:8081/todos <span class="nt">-X</span> PUT <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-d</span> <span class="s1">'{"id": 1, "todo":"think" }'</span>
</code></pre></div></div>

<p>This time, when you perform a <code class="language-plaintext highlighter-rouge">GET</code> you can see that the <code class="language-plaintext highlighter-rouge">Last-Modified</code> has been updated.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> <span class="s1">'http://127.0.0.1:8081/todos?id=1'</span>
</code></pre></div></div>

<p>This <code class="language-plaintext highlighter-rouge">Last-Modified</code> time stamp has been provided by <code class="language-plaintext highlighter-rouge">#[Cacheable]</code>. No need to provide any special application admin or database columns.</p>

<p>With <code class="language-plaintext highlighter-rouge">#[Cacheable]</code>, resource contents are managed in a “query repository” dedicated for storing resources, which is different from the database for writing, and <code class="language-plaintext highlighter-rouge">Etag</code> and <code class="language-plaintext highlighter-rouge">Last-Modified</code> headers are added automatically.</p>

<h2 id="because-everything-is-a-resource-1">Because Everything is A Resource.</h2>

<p>Uniform resource identifier(URI), a consistent interface, stateless access, powerful caching system, hyperlinks, layered system, and self-descriptive messages. A resource built with BEAR.Sunday implements all of these REST features.</p>

<p>You can connect to data from other applications using hyperlinks, creating an API to be consumed from another CMS or framework is easy. The resource object is completely decoupled from any rendering.</p>

<p>BEAR.Sunday is a <strong>connecting layer framework</strong> that connects dependencies with <strong>DI</strong>, cross-cutting interests with <strong>AOP</strong>, and application information as resources with the power of <strong>REST</strong>.</p>

<h1 id="tutorial-2">Tutorial 2</h1>

<p>In this tutorial, you will learn how to develop high quality standards-based REST (Hypermedia) applications using the following tools.</p>

<ul>
  <li>Define a JSON schema and use it for validation and documentation <a href="https://json-schema.org/">Json Schema</a></li>
  <li>Hypermedia types <a href="https://stateless.group/hal_specification.html">HAL (Hypertext Application Language)</a></li>
  <li>A DB migration tool developed by CakePHP <a href="https://book.cakephp.org/3.0/ja/phinx.html">Phinx</a></li>
  <li>Binding PHP interfaces to SQL statement execution <a href="https://github.com/ray-di/Ray.MediaQuery">Ray. MediaQuery</a></li>
</ul>

<p>Let’s proceed with the commits found in <a href="https://github.com/bearsunday/tutorial2/commits/v2-php8.2">tutorial2</a>.</p>

<h2 id="create-the-project">Create the project</h2>

<p>Create the project skeleton.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer create-project bear/skeleton MyVendor.Ticket
</code></pre></div></div>

<p>Enter the <strong>vendor</strong> name as <code class="language-plaintext highlighter-rouge">MyVendor</code> and the <strong>project</strong> name as <code class="language-plaintext highlighter-rouge">Ticket</code>.</p>

<h2 id="migration">Migration</h2>

<p>Install Phinx.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require --dev robmorgan/phinx
</code></pre></div></div>

<p>Configure the DB connection information in the <code class="language-plaintext highlighter-rouge">.env.dist</code> file in the project root folder.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TKT_DB_HOST=127.0.0.1:3306
TKT_DB_NAME=ticket
TKT_DB_USER=root
TKT_DB_PASS=''
TKT_DB_SLAVE=''
TKT_DB_DSN=mysql:host=${TKT_DB_HOST}
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">.env.dist</code> file should look like this, and the actual connection information should be written in <code class="language-plaintext highlighter-rouge">.env</code>. ^1]</p>

<p>Next, create a folder to be used by Phinx.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> var/phinx/migrations
<span class="nb">mkdir </span>var/phinx/seeds
</code></pre></div></div>

<p>Set up <code class="language-plaintext highlighter-rouge">var/phinx/phinx.php</code> to use the <code class="language-plaintext highlighter-rouge">.env</code> connection information we have set up earlier.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">use</span> <span class="nc">BEAR\Dotenv\Dotenv</span><span class="p">;</span>

<span class="k">require_once</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/vendor/autoload.php'</span><span class="p">;</span>

<span class="p">(</span><span class="k">new</span> <span class="nc">Dotenv</span><span class="p">())</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

<span class="nv">$development</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PDO</span><span class="p">(</span><span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_DSN'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_USER'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_PASS'</span><span class="p">));</span>
<span class="nv">$test</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PDO</span><span class="p">(</span><span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_DSN'</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'_test'</span><span class="p">,</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_USER'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_PASS'</span><span class="p">));</span>
<span class="k">return</span> <span class="p">[</span>
    <span class="s1">'paths'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'migrations'</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/migrations'</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">'environments'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'development'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$development</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s2">"SELECT DATABASE()"</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">fetchColumn</span><span class="p">(),</span>
            <span class="s1">'connection'</span> <span class="o">=&gt;</span> <span class="nv">$development</span>
        <span class="p">],</span>
        <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$test</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s2">"SELECT DATABASE()"</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">fetchColumn</span><span class="p">(),</span>
            <span class="s1">'connection'</span> <span class="o">=&gt;</span> <span class="nv">$test</span>
        <span class="p">]</span>
    <span class="p">]</span>
<span class="p">];</span>
</code></pre></div></div>

<h3 id="setup-script">setup script</h3>

<p>Edit <code class="language-plaintext highlighter-rouge">bin/setup.php</code> for easy database creation and migration.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">use</span> <span class="nc">BEAR\Dotenv\Dotenv</span><span class="p">;</span>

<span class="k">require_once</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/vendor/autoload.php'</span><span class="p">;</span>

<span class="p">(</span><span class="k">new</span> <span class="nc">Dotenv</span><span class="p">())</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">));</span>

<span class="nb">chdir</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">));</span>
<span class="nb">passthru</span><span class="p">(</span><span class="s1">'rm -rf var/tmp/*'</span><span class="p">);</span>
<span class="nb">passthru</span><span class="p">(</span><span class="s1">'chmod 775 var/tmp'</span><span class="p">);</span>
<span class="nb">passthru</span><span class="p">(</span><span class="s1">'chmod 775 var/log'</span><span class="p">);</span>
<span class="c1">// db</span>
<span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">PDO</span><span class="p">(</span><span class="s1">'mysql:host='</span> <span class="mf">.</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_HOST'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_USER'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_PASS'</span><span class="p">));</span>
<span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'CREATE DATABASE IF NOT EXISTS '</span> <span class="mf">.</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_NAME'</span><span class="p">));</span>
<span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'DROP DATABASE IF EXISTS '</span> <span class="mf">.</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_NAME'</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'_test'</span><span class="p">);</span>
<span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'CREATE DATABASE '</span> <span class="mf">.</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_NAME'</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'_test'</span><span class="p">);</span>
<span class="nb">passthru</span><span class="p">(</span><span class="s1">'./vendor/bin/phinx migrate -c var/phinx/phinx.php -e development'</span><span class="p">);</span>
<span class="nb">passthru</span><span class="p">(</span><span class="s1">'./vendor/bin/phinx migrate -c var/phinx/phinx.php -e test'</span><span class="p">);</span>
</code></pre></div></div>

<p>Next, we will create a migration class to create the <code class="language-plaintext highlighter-rouge">ticket</code> table.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./vendor/bin/phinx create Ticket -c var/phinx/phinx.php
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Phinx by CakePHP - https://phinx.org.

...
created var/phinx/migrations/20210520124501_ticket.php
</code></pre></div></div>

<p>Edit <code class="language-plaintext highlighter-rouge">var/phinx/migrations/{current_date}_ticket.php</code> to implement the <code class="language-plaintext highlighter-rouge">change()</code> method.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">use</span> <span class="nc">Phinx\Migration\AbstractMigration</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">Ticket</span> <span class="kd">extends</span> <span class="nc">AbstractMigration</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">change</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$table</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">table</span><span class="p">(</span><span class="s1">'ticket'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">'primary_key'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'id'</span><span class="p">]]);</span>
        <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'uuid'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'null'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'date_created'</span><span class="p">,</span> <span class="s1">'datetime'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In addition, edit <code class="language-plaintext highlighter-rouge">.env.dist</code> like the following.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code> TKT_DB_USER=root
 TKT_DB_PASS=
 TKT_DB_SLAVE=
<span class="gd">-TKT_DB_DSN=mysql:host=${TKT_DB_HOST}
</span><span class="gi">+TKT_DB_DSN=mysql:host=${TKT_DB_HOST};dbname=${TKT_DB_NAME}
</span></code></pre></div></div>

<p>Now that we are done with the setup, run the setup command to create the table.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer setup
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; php bin/setup.php
...
All Done. Took 0.0248s
</code></pre></div></div>

<p>The table has been created. The next time you want to set up a database environment for this project, just run <code class="language-plaintext highlighter-rouge">composer setup</code>.</p>

<p>For more information about writing migration classes, see <a href="https://book.cakephp.org/3.0/ja/phinx/migrations.html">Phinx Manual: Writing Migrations</a>.</p>

<h2 id="module">Module</h2>

<p>Install the module as a composer.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require ray/identity-value-module ray/media-query -w
</code></pre></div></div>

<p>Install the package with AppModule.</p>

<p><code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Dotenv\Dotenv</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\PackageModule</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\Module\JsonSchemaModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\IdentityValueModule\IdentityValueModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\MediaQuery\DbQueryConfig</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\MediaQuery\MediaQueryModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\MediaQuery\Queries</span><span class="p">;</span>
<span class="kn">use</span> <span class="k">function</span> <span class="n">dirname</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="p">(</span><span class="k">new</span> <span class="nc">Dotenv</span><span class="p">())</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">AuraSqlModule</span><span class="p">(</span>
                <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_DSN'</span><span class="p">),</span>
                <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_USER'</span><span class="p">),</span>
                <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_PASS'</span><span class="p">),</span>
                <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_SLAVE'</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">MediaQueryModule</span><span class="p">(</span>
                <span class="nc">Queries</span><span class="o">::</span><span class="nf">fromDir</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">appMeta</span><span class="o">-&gt;</span><span class="n">appDir</span> <span class="mf">.</span> <span class="s1">'/src/Query'</span><span class="p">),</span> <span class="p">[</span>
                   <span class="k">new</span> <span class="nc">DbQueryConfig</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">appMeta</span><span class="o">-&gt;</span><span class="n">appDir</span> <span class="mf">.</span> <span class="s1">'/var/sql'</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">IdentityValueModule</span><span class="p">());</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">JsonSchemaModule</span><span class="p">(</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">appMeta</span><span class="o">-&gt;</span><span class="n">appDir</span> <span class="mf">.</span> <span class="s1">'/var/schema/response'</span><span class="p">,</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">appMeta</span><span class="o">-&gt;</span><span class="n">appDir</span> <span class="mf">.</span> <span class="s1">'/var/schema/request'</span>
            <span class="p">)</span>
        <span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">PackageModule</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="sql">SQL</h2>

<p>Save the three SQLs for the ticket in <code class="language-plaintext highlighter-rouge">var/sql</code>.<sup id="fnref:13" role="doc-noteref"><a href="#fn:13" class="footnote" rel="footnote">11</a></sup></p>

<p><code class="language-plaintext highlighter-rouge">var/sql/ticket_add.sql</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ticket add */</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">ticket</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">date_created</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(:</span><span class="n">id</span><span class="p">,</span> <span class="p">:</span><span class="n">title</span><span class="p">,</span> <span class="p">:</span><span class="n">dateCreated</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">var/sql/ticket_list.sql</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ticket list */</span>
<span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">date_created</span>
  <span class="k">FROM</span> <span class="n">ticket</span>
 <span class="k">LIMIT</span> <span class="mi">3</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">var/sql/ticket_item.sql</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ticket item */</span>
<span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">date_created</span>
  <span class="k">FROM</span> <span class="n">ticket</span>
 <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span>
</code></pre></div></div>

<p>Make sure that the SQL will work on its own when you create it.</p>

<blockquote>
  <p>PHPStorm includes a database tool, <a href="https://www.jetbrains.com/datagrip/">DataGrip</a>, which has all the necessary features for SQL development such as code completion and SQL refactoring.
Once the DB connection and other setups are made, SQL files can be executed directly in the IDE. <sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">12</a></sup><sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">13</a></sup></p>
</blockquote>

<h2 id="jsonschema">JsonSchema.</h2>

<p>Create new files that will represent the resource <code class="language-plaintext highlighter-rouge">Ticket</code> (ticket item) and <code class="language-plaintext highlighter-rouge">Tickets</code> (ticket item list) with <a href="http://json-schema.org/">JsonSchema</a>:</p>

<p><code class="language-plaintext highlighter-rouge">var/schema/response/ticket.json</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"$id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ticket.json"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://json-schema.org/draft-07/schema#"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Ticket"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"title"</span><span class="p">,</span><span class="w"> </span><span class="s2">"date_created"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The unique identifier for a ticket."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">64</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The unique identifier for a ticket."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">255</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"date_created"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The date and time that the ticket was created"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"datetime"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">var/schema/response/tickets.json</code></p>

<p>Tickets is a <code class="language-plaintext highlighter-rouge">Ticket</code> array.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"$id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tickets.json"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://json-schema.org/draft-07/schema#"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tickets"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"tickets"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"tickets"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"items"</span><span class="p">:{</span><span class="nl">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"./ticket.json"</span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<ul>
  <li><strong>$id</strong> - specifies the file name, but if it is to be published, it should be a URL.</li>
  <li><strong>title</strong> - This will be treated in the API documentation as an object name.</li>
  <li><strong>examples</strong> - specify examples as appropriate. You can also specify the entire object.</li>
</ul>

<p>In PHPStorm, you will see a green check in the upper right corner of the editor to indicate that everything is OK. You should also validate the schema itself when you create it.</p>

<h2 id="query-interface">Query Interface</h2>

<p>We will create a PHP interface that abstracts access to the infrastructure.</p>

<ul>
  <li>Read Ticket resources <strong>TicketQueryInterface</strong>.</li>
  <li>Create a Ticket resource <strong>TicketCommandInterface</strong>.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">src/Query/TicketQueryInterface.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Query</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Ray\MediaQuery\Annotation\DbQuery</span><span class="p">;</span>

<span class="kd">interface</span> <span class="nc">TicketQueryInterface</span>
<span class="p">{</span>
    <span class="c1">#[DbQuery('ticket_item']</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">item</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">Ticket</span><span class="o">|</span><span class="kc">null</span><span class="p">;</span>

    <span class="cd">/** @return array&lt;Ticket&gt; */</span>
    <span class="c1">#[DbQuery('ticket_list']</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">list</span><span class="p">():</span> <span class="kt">array</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">src/Query/TicketCommandInterface.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Query</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">DateTimeInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\MediaQuery\Annotation\DbQuery</span><span class="p">;</span>

<span class="kd">interface</span> <span class="nc">TicketCommandInterface</span>
<span class="p">{</span>
    <span class="c1">#[DbQuery('ticket_add')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">add</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$title</span><span class="p">,</span> <span class="kt">DateTimeInterface</span> <span class="nv">$dateCreated</span> <span class="o">=</span> <span class="kc">null</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Specify an SQL statement with the <code class="language-plaintext highlighter-rouge">#[DbQuery]</code> attribute. You do not need to write any implementation for this interface. An object that performs the specified SQL query will be created automatically.</p>

<p>The interface is divided into two concerns: <strong>command</strong> which has side effects, and <strong>query</strong> which returns a value.
It can be one interface and one method as in <a href="https://github.com/pmjones/adr">ADR pattern</a>. The application designer decides the policy.</p>

<h2 id="entity">Entity</h2>

<p>If you specify <code class="language-plaintext highlighter-rouge">array</code> for the return value of a method, you will get the database result as it is, an associative array, but if you specify an entity type for the return value of the method, it will be hydrated to that type.</p>

<p>``php
#[DbQuery(‘ticket_item’)
public function item(string $id): array // you get an array.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
```php
#[DbQuery('ticket_item')].
public function item(string $id): ticket|null; // yields a Ticket entity.
</code></pre></div></div>

<p>For multiple rows (row_list), use <code class="language-plaintext highlighter-rouge">/** @return array&lt;Ticket&gt;*/</code> and phpdoc to specify that <code class="language-plaintext highlighter-rouge">Ticket</code> is returned as an array.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/** @return array&lt;Ticket&gt; */
#[DbQuery('ticket_list')].
public function list(): array; // yields an array of Ticket entities.
</code></pre></div></div>
<p>The value of each row is passed to the constructor by name argument. <sup id="fnref:named" role="doc-noteref"><a href="#fn:named" class="footnote" rel="footnote">14</a></sup></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Entity</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Ticket</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">public</span> <span class="n">readonly</span> <span class="n">string</span> <span class="nv">$id</span><span class="p">,</span>
        <span class="kt">public</span> <span class="n">readonly</span> <span class="n">string</span> <span class="nv">$title</span><span class="p">,</span>
        <span class="kt">public</span> <span class="n">readonly</span> <span class="n">string</span> <span class="nv">$dateCreated</span>
    <span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="resources">Resources</h2>

<p>The resource class depends on the query interface.</p>

<h2 id="ticket-resource">Ticket resource</h2>

<p>Create a <code class="language-plaintext highlighter-rouge">ticket</code> resource in <code class="language-plaintext highlighter-rouge">src/Resource/App/Ticket.php</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\JsonSchema</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">MyVendor\Ticket\Query\TicketQueryInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Ticket</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="nc">TicketQueryInterface</span> <span class="nv">$query</span>
    <span class="p">){}</span>
    
   <span class="c1">#[JsonSchema("ticket.json")]</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span> <span class="o">=</span> <span class="s1">''</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">query</span><span class="o">-&gt;</span><span class="nf">item</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The attribute <code class="language-plaintext highlighter-rouge">#[JsonSchema]</code> indicates that the value output by <code class="language-plaintext highlighter-rouge">onGet()</code> is defined in the <code class="language-plaintext highlighter-rouge">ticket.json</code> schema.
It is validated for each request by AOP.</p>

<p>Let’s try to request a resource by entering a seed. <sup id="fnref:8" role="doc-noteref"><a href="#fn:8" class="footnote" rel="footnote">15</a></sup></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% mysql <span class="nt">-u</span> root <span class="nt">-e</span> <span class="s2">"INSERT INTO ticket (id, title, date_created) VALUES ('1', 'foo', '1970-01-01 00:00:00')"</span> ticket
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% php bin/app.php get <span class="s1">'/ticket?id=1'</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
Content-Type: application/hal+json

<span class="o">{</span>
    <span class="s2">"id"</span>: <span class="s2">"1"</span>,
    <span class="s2">"title"</span>: <span class="s2">"foo"</span>,
    <span class="s2">"date_created"</span>: <span class="s2">"1970-01-01 00:00:01"</span>,
    <span class="s2">"_links"</span>: <span class="o">{</span>
        <span class="s2">"self"</span>: <span class="o">{</span>
            <span class="s2">"href"</span>: <span class="s2">"/ticket?id=1"</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="mediaquery">MediaQuery</h3>

<p>With Ray.MediaQuery, an auto-generated SQL execution object is injected from the interface without the need to code boilerplate implementation classes. <sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">16</a></sup></p>

<p>A SQL statement can contain multiple SQLs separated by <code class="language-plaintext highlighter-rouge">;</code>, and multiple SQLs are bound to the same parameter by name, and transactions are executed for queries other than SELECT.</p>

<p>If you want to generate SQL dynamically, you can use an SQL execution class that injects the query builder instead of Ray.
For more details, please see <a href="database.html">Database</a> in the manual.</p>

<h2 id="embedded-links">Embedded links</h2>

<p>Usually, a website page contains multiple resources. For example, a blog post page might contain recommendations, advertisements, category links, etc. in addition to the post.
Instead of the client getting them separately, they can be bundled into one resource with embedded links as independent resources.</p>

<p>Think of HTML and the <code class="language-plaintext highlighter-rouge">&lt;img&gt;</code> tag that is written in it. Both have independent URLs, but the image resource is embedded in the HTML resource, and when the HTML is retrieved, the image is displayed in the HTML.
These are called hypermedia types <a href="http://amundsen.com/hypermedia/hfactor/#le">Embedding links(LE)</a>, and the resource to be embedded is linked.</p>

<p>Let’s embed the project resource into the ticket resource, and prepare the Project class.</p>

<p><code class="language-plaintext highlighter-rouge">src/Resource/App/Project.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Project</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'Project A'</span><span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Add the attribute <code class="language-plaintext highlighter-rouge">#[Embed]</code> to the Ticket resource.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gi">+use BEAR\Resource\Annotation\Embed;
+use BEAR\Resource\Request;
+
+   #[Embed(src: '/project', rel: 'project')]
</span>    #[JsonSchema("ticket.json")]
    public function onGet(string $id = ''): static
    {
<span class="gi">+        assert($this-&gt;body['project'] instanceof Request);
</span><span class="gd">-        $this-&gt;body = (array) $this-&gt;query-&gt;item($id);
</span><span class="gi">+        $this-&gt;body += (array) $this-&gt;query-&gt;item($id);
</span></code></pre></div></div>

<p>The request for the resource specified by the <code class="language-plaintext highlighter-rouge">#[Embed]</code> attribute <code class="language-plaintext highlighter-rouge">src</code> will be injected into the <code class="language-plaintext highlighter-rouge">rel</code> key of the body property, and will be lazily evaluated into a string representation when rendered.</p>

<p>For the sake of simplicity, no parameters are passed in this example, but you can pass the values received by the method arguments using the URI template, or you can modify or add parameters to the injected request.
See <a href="resource.html">resource</a> for details.</p>

<p>If you make the request again, you will see that the status of the project resource has been added to the property <code class="language-plaintext highlighter-rouge">_embedded</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% php bin/app.php get '/ticket?id=1'
</code></pre></div></div>
<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
{
    "id": "1",
    "title": "2",
    "date_created": "1970-01-01 00:00:01",
<span class="gi">+    "_embedded": {
+        "project": {
+            "title": "Project A",
+        }
</span>    },
</code></pre></div></div>

<p>Embedded resources are an important feature of the REST API. It gives a tree structure to the content and reduces the HTTP request cost. Instead of letting the client fetching it as a separate resource each time, the relationship can be represented in server-side. <sup id="fnref:6" role="doc-noteref"><a href="#fn:6" class="footnote" rel="footnote">17</a></sup></p>

<h2 id="tickets-resource">tickets resource</h2>

<p>Create a <code class="language-plaintext highlighter-rouge">tickets</code> resource in <code class="language-plaintext highlighter-rouge">src/resource/App/Tickets.php</code> that can be created with <code class="language-plaintext highlighter-rouge">POST</code> and retrieved with <code class="language-plaintext highlighter-rouge">GET</code> for a list of tickets.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\JsonSchema</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\Link</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\HttpConstants\ResponseHeader</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\HttpConstants\StatusCode</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">MyVendor\Ticket\Query\TicketCommandInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">MyVendor\Ticket\Query\TicketQueryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\IdentityValueModule\UuidInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="k">function</span> <span class="nf">uri_template</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Tickets</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="nc">TicketQueryInterface</span> <span class="nv">$query</span><span class="p">,</span>
        <span class="kt">private</span> <span class="nc">TicketCommandInterface</span> <span class="nv">$command</span><span class="p">,</span>
        <span class="kt">private</span> <span class="nc">UuidInterface</span> <span class="nv">$uuid</span>
    <span class="p">){}</span>

    <span class="c1">#[Link(rel: "doPost", href: '/tickets')]</span>
    <span class="c1">#[Link(rel: "goTicket", href: '/ticket{?id}')]</span>
    <span class="c1">#[JsonSchema("tickets.json")]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'tickets'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">query</span><span class="o">-&gt;</span><span class="k">list</span><span class="p">()</span>
        <span class="p">];</span>
        
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">#[Link(rel: "goTickets", href: '/tickets')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$title</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">command</span><span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$title</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="nc">StatusCode</span><span class="o">::</span><span class="no">CREATED</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">LOCATION</span><span class="p">]</span> <span class="o">=</span> <span class="nf">uri_template</span><span class="p">(</span><span class="s1">'/ticket{?id}'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">]);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The injected <code class="language-plaintext highlighter-rouge">$uuid</code> can be cast to a string to get the UUID. Also, <code class="language-plaintext highlighter-rouge">#Link[]</code> represents a link to another resource (application state).</p>

<p>Notice that we don’t pass the current time in the <code class="language-plaintext highlighter-rouge">add()</code> method.
If no value is passed, it will not be null, but the MySQL current time string will be bound to the SQL.
This is because the string representation of the current time DateTime object bound to the <code class="language-plaintext highlighter-rouge">DateTimeInterface</code> (current time string) is bound to SQL.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">add</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$title</span><span class="p">,</span> <span class="kt">DateTimeInterface</span> <span class="nv">$dateCreated</span> <span class="o">=</span> <span class="kc">null</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
</code></pre></div></div>
<p>It saves you the trouble of hard-coding NOW() inside SQL and passing the current time to the method every time.
You can pass a <code class="language-plaintext highlighter-rouge">DateTime object</code>, or in the context of a test, you can bind a fixed test time.</p>

<p>In this way, if you specify an interface as an argument to a query, you get that object using DI, and its string representation is bound to SQL.
For example, login user IDs can be bound and used across applications. <sup id="fnref:7" role="doc-noteref"><a href="#fn:7" class="footnote" rel="footnote">18</a></sup></p>

<h2 id="hypermedia-api-test">Hypermedia API test</h2>

<blockquote>
  <p>The term REST (representational state transfer) was introduced and defined by Roy Fielding in his doctoral dissertation in 2000, and is intended to give an idea of “the behavior of a properly designed web application”.
It is a network of web resources (a virtual state machine) where the user selects a resource identifier (URL) and a resource operation (application state transition) such as GET or POST to proceed with the application, resulting in the next representation of the resource (the next application state) being forwarded to the end user. application state) is transferred to the end user for use.</p>

  <p>– <a href="https://en.wikipedia.org/wiki/Representational_state_transfer">Wikipedia (REST)</a></p>
</blockquote>

<p>In a REST application, the following actions are provided by the service as URLs, and the client selects them.</p>

<p>HTML web applications are completely RESTful. The only operations are “<strong>Go to the provided URL</strong> (with a tag, etc.)” or “<strong>Fill the provided form and submit</strong>”.</p>

<p>The REST API tests are written in the same way.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Hypermedia</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\HttpConstants\ResponseHeader</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">MyVendor\Ticket\Injector</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">MyVendor\Ticket\Query\TicketQueryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PHPUnit\Framework\TestCase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\InjectorInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="k">function</span> <span class="nf">json_decode</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">WorkflowTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="kt">ResourceInterface</span> <span class="nv">$resource</span><span class="p">;</span>
    <span class="k">protected</span> <span class="kt">InjectorInterface</span> <span class="nv">$injector</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">injector</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">(</span><span class="s1">'hal-api-app'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">injector</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="nc">ResourceInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
        <span class="nv">$a</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">injector</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="nc">TicketQueryInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">testIndex</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$index</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nv">$index</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$index</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @depends testIndex
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testGoTickets</span><span class="p">(</span><span class="kt">ResourceObject</span> <span class="nv">$response</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>

        <span class="nv">$json</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nv">$response</span><span class="p">;</span>
        <span class="nv">$href</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$json</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">_links</span><span class="o">-&gt;</span><span class="p">{</span><span class="s1">'goTickets'</span><span class="p">}</span><span class="o">-&gt;</span><span class="n">href</span><span class="p">;</span>
        <span class="nv">$ro</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$href</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$ro</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @depends testGoTickets
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testDoPost</span><span class="p">(</span><span class="kt">ResourceObject</span> <span class="nv">$response</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$json</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nv">$response</span><span class="p">;</span>
        <span class="nv">$href</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$json</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">_links</span><span class="o">-&gt;</span><span class="p">{</span><span class="s1">'doPost'</span><span class="p">}</span><span class="o">-&gt;</span><span class="n">href</span><span class="p">;</span>
        <span class="nv">$ro</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="nv">$href</span><span class="p">,</span> <span class="p">[</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'title1'</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$ro</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @depends testDoPost
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testGoTicket</span><span class="p">(</span><span class="kt">ResourceObject</span> <span class="nv">$response</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$href</span> <span class="o">=</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">LOCATION</span><span class="p">];</span>
        <span class="nv">$ro</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$href</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$ro</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You will also need a route page as a starting point.</p>

<p><code class="language-plaintext highlighter-rouge">src/Resource/App/Index.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\Link</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[Link(rel: 'goTickets', href: '/tickets')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">setUp</code> creates a resource client, and <code class="language-plaintext highlighter-rouge">testIndex()</code> accesses the root page.</li>
  <li>The <code class="language-plaintext highlighter-rouge">testGoTickets()</code> method, which receives the response, makes a JSON representation of the response object and gets the link <code class="language-plaintext highlighter-rouge">goTickets</code> to get the next list of tickets.</li>
  <li>There is no need to write a test for the resource body. * No need to write tests for the resource body, just check the status code, since it is guaranteed that the JsonSchema validation of the response has passed.</li>
  <li>Following the uniform interface of REST, the next request URL to be accessed is always included in the response. Inspect them one after another.</li>
</ul>

<blockquote>
  <p><strong>Uniform Interface</strong></p>

  <p>REST is defined by four interface constraints: identification of resources; manipulation of resources through representations; self-descriptive messages; and, hypermedia as the engine of application state.<sup id="fnref:11" role="doc-noteref"><a href="#fn:11" class="footnote" rel="footnote">19</a></sup></p>
</blockquote>

<p>Let’s run it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./vendor/bin/phpunit <span class="nt">--testsuite</span> hypermedia
</code></pre></div></div>

<p>Hypermedia API tests (REST application tests) are a good representation of the fact that REST applications are state machines, and workflows can be described as use cases.
Ideally, REST API tests should cover how the application will be used.</p>

<h3 id="http-testing">HTTP Testing</h3>

<p>To test the REST API over HTTP, inherit the whole test and set the client to the HTTP test client with <code class="language-plaintext highlighter-rouge">setUp</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">WorkflowTest</span> <span class="kd">extends</span> <span class="nc">Workflow</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpResource</span><span class="p">(</span><span class="s1">'127.0.0.1:8080'</span><span class="p">,</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/index.php'</span><span class="p">,</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/log/workflow.log'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This client has the same interface as the resource client, but the actual request is made as an HTTP request to the built-in server and receives the response from the server.
The first argument is the URL of the built-in server. When <code class="language-plaintext highlighter-rouge">new</code> is executed, the built-in server will be started with the bootstrap script specified in the second argument.</p>

<p>The bootstrap script for the test server will also be changed to the API context.</p>

<p><code class="language-plaintext highlighter-rouge">tests/Http/index.php</code></p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">-exit((new Bootstrap())('hal-app', $GLOBALS, $_SERVER));
</span><span class="gi">+exit((new Bootstrap())('hal-api-app', $GLOBALS, $_SERVER));
</span></code></pre></div></div>

<p>Let’s run it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./vendor/bin/phpunit --testsuite http
</code></pre></div></div>

<h4 id="http-access-log">HTTP Access Log</h4>

<p>The actual HTTP request/response log made by curl will be recorded in the resource log of the third argument.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -s -i 'http://127.0.0.1:8080/'

HTTP/1.1 200 OK
Host: 127.0.0.1:8080
Date: Fri, 21 May 2021 22:41:02 GMT
Connection: close
X-Powered-By: PHP/8.0.6
Content-Type: application/hal+json

{
    "_links": {
        "self": {
            "href": "/index"
        },
        "goTickets": {
            "href": "/tickets"
        }
    }
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -s -i -H 'Content-Type:application/json' -X POST -d '{"title":"title1"}' http://127.0.0.1:8080/tickets

HTTP/1.1 201 Created
Host: 127.0.0.1:8080
Date: Fri, 21 May 2021 22:41:02 GMT
Connection: close
X-Powered-By: PHP/8.0.6
Location: /ticket?id=421d997c-9a0e-4018-a6c2-9b8758cac6d6
</code></pre></div></div>

<p>The actual recorded JSON is useful for checking, especially if it has a complex structure, and is also good to check along with the API documentation.
The HTTP client can also be used for E2E testing.</p>

<h2 id="api-documentation">API documentation</h2>

<p>In ResourceObjects, method signatures are the input parameters to the API, and responses are schema-defined.
Because of its self-descriptiveness, API documentation can be generated automatically.</p>

<p>Let’s create it. The documentation will be output to the <a href="https://bearsunday.github.io/tutorial2/">docs</a> folder.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer doc
</code></pre></div></div>

<p>It reduces the effort of writing IDL (Interface Definition Language), but more valuable is that the documentation follows the latest PHP code and is always accurate.
It is a good idea to include it in your CI so that your code and API documentation are always in sync.</p>

<p>You can also link to related documentation. See <a href="apidoc.html">ApiDoc</a> for more details on configuration.</p>

<h2 id="code-examples">Code examples</h2>

<p>The following code example is also available.</p>

<ul>
  <li>TestModulethat adds a <code class="language-plaintext highlighter-rouge">Test</code> context and clears the DB for each test.  <a href="https://github.com/bearsunday/tutorial2/commit/4e9704d3bc65b9c7e7a8c13164dfe7cc3d6929b2">4e9704d</a></li>
  <li><code class="language-plaintext highlighter-rouge">entity</code> option for <code class="language-plaintext highlighter-rouge">#[DbQuery]</code> that returns a hydrated entity class instead of an associative array in DB queries <a href="https://github.com/bearsunday/tutorial2/commit/29f0a1f4d4bf51e6c0a722fd6b2f44cb78de999e">29f0a1f</a></li>
  <li>Query builder synthesizing static and dynamic SQL <a href="https://github.com/bearsunday/tutorial2/commit/9d095acfed6150fb99f36d502ae13f03bdf2916d">9d095ac</a></li>
</ul>

<h2 id="rest-framework">REST framework</h2>

<p>There are three styles of Web APIs.</p>

<ul>
  <li>Tunnels (SOAP, GraphQL)</li>
  <li>URI (Object, CRUD)</li>
  <li>Hypermedia (REST)</li>
</ul>

<p>In contrast to the URI style, where resources are treated as just RPCs <sup id="fnref:9" role="doc-noteref"><a href="#fn:9" class="footnote" rel="footnote">20</a></sup>, what we learned in this tutorial is REST, where resources are linked. <sup id="fnref:10" role="doc-noteref"><a href="#fn:10" class="footnote" rel="footnote">21</a></sup>
Resources are connected by LOs (outbound links) in <code class="language-plaintext highlighter-rouge">#Link</code> to represent workflows, and LEs (embedded links) in <code class="language-plaintext highlighter-rouge">#[Embed]</code> to represent tree structures.</p>

<p>BEAR.Sunday emphasizes clean, standards-based code.</p>

<p>JsonSchema over framework-specific validators, standard SQL over proprietary ORM, IANA registered standard<sup id="fnref:12" role="doc-noteref"><a href="#fn:12" class="footnote" rel="footnote">22</a></sup> media type JSON over proprietary structure JSON.</p>

<p>Application design is not about “free implementation”, but about “free choice of constraints”.
Applications should aim for evolvability without breaking development efficiency, performance, and backward compatibility based on the constraints.</p>

<p>(This manual has been prepared through deepL automated translation.)</p>

<hr />

<p>The comment is not only descriptive, but also makes it easier to identify the SQL in the slow query log, etc.</p>

<h1 id="type">Type</h1>

<p>Use <strong>PHPDoc types</strong> for richer types that are not supported by native PHP.</p>

<p>E.g.: Assign an associative array of the resource class <code class="language-plaintext highlighter-rouge">body</code> as an “object-like array”.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @var array{greeting: string} */</span>
<span class="k">public</span> <span class="nv">$body</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @var list&lt;array{name: string, age:int}&gt; */</span>
<span class="k">public</span> <span class="nv">$body</span><span class="p">;</span>
</code></pre></div></div>

<p>The tool understands the object’s type retrieved by the resource client with <code class="language-plaintext highlighter-rouge">assert()</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/user'</span><span class="p">,</span> <span class="p">[]);</span>
<span class="nb">assert</span><span class="p">(</span><span class="nv">$user</span> <span class="k">instanceof</span> <span class="nc">User</span><span class="p">);</span>
<span class="nv">$name</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'name'</span><span class="p">];</span> <span class="c1">// The name key will be interpolated</span>
<span class="nv">$user</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'__invalid__'</span><span class="p">];</span> <span class="c1">// Accessing an undefined key is an error.</span>
</code></pre></div></div>

<h1 id="reference-1">Reference</h1>

<h2 id="atomic-type">Atomic Type</h2>

<p>If a type cannot be split any more, it is called an atomic type; all PHP7 types are of this type.
Union and intersection types use a combination of atomic types.</p>

<h3 id="scalar-type">Scalar Type</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @param int $i */</span>
<span class="cd">/** @param float $f */</span>
<span class="cd">/** @param string $str */</span>
<span class="cd">/** @param class-string $class */</span>
<span class="cd">/** @param class-string&lt;AbstractFoo&gt; $fooClass */</span>
<span class="cd">/** @param callable-string $callable */</span>
<span class="cd">/** @param numeric-string $num */</span>
<span class="cd">/** @param bool $isSet */</span>
<span class="cd">/** @param array-key $key */</span>
<span class="cd">/** @param numeric $num */</span>
<span class="cd">/** @param scalar $a */</span>
</code></pre></div></div>

<h3 id="object-type">Object Type</h3>

<h4 id="generic-object">Generic Object</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return ArrayObject&lt;int, string&gt; */</span>
</code></pre></div></div>

<h4 id="generator">Generator</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return Generator&lt;int, string, mixed, void&gt; */</span>
</code></pre></div></div>

<h3 id="callable-type">Callable Type</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return callable(Type1, OptionalType2=, SpreadType3...): ReturnType */</span>
<span class="cd">/** @return Closure(bool):int */</span>
</code></pre></div></div>

<h3 id="value-type">Value Type</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return null */</span>
<span class="cd">/** @return true */</span>
<span class="cd">/** @return 42 */</span>
<span class="cd">/** Foo\Bar::MY_SCALAR_CONST $a */</span>
<span class="cd">/** @param A::class|B::class $s */</span>
</code></pre></div></div>

<h3 id="array-type">Array Type</h3>

<h4 id="generic-array">Generic Array</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return array&lt;TKey, TValue&gt; */</span>
<span class="cd">/** @return array&lt;int, Foo&gt; */</span>
<span class="cd">/** @return array&lt;string, int|string&gt; */</span>

</code></pre></div></div>

<h4 id="object-like-arrays">Object-like Arrays</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return array{0: string, 1: string, foo: stdClass, 28: false} */</span>
<span class="cd">/** @return array{foo: string, bar: int} */</span>
<span class="cd">/** @return array{optional?: string, bar: int} */</span>
</code></pre></div></div>

<h4 id="list">List</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @param list&lt;string&gt; $stringList */</span>
</code></pre></div></div>

<h4 id="phpdoc-array">PHPDoc Array</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @param string[] $strings */</span>
</code></pre></div></div>

<h3 id="other-atomic-type">Other Atomic Type</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return iterable */</span>
<span class="cd">/** @return void */</span>
<span class="cd">/** @return empty */</span>
<span class="cd">/** @return mixed */</span>
</code></pre></div></div>

<h2 id="intersection-type">Intersection Type</h2>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return A&amp;B */</span>
</code></pre></div></div>

<h2 id="union-type">Union Type</h2>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return int|false */</span>
<span class="cd">/** @return 0|1 */</span>
<span class="cd">/** @return 'a'|'b' */</span>
</code></pre></div></div>

<p>-</p>

<p>PHPStorm Plugin</p>

<ul>
  <li><a href="https://plugins.jetbrains.com/plugin/9927-deep-assoc-completion">deep-array-assoc</a></li>
  <li><a href="https://plugins.jetbrains.com/plugin/12754-phpstan--psalm--generics">phpstan–psalm–generics</a></li>
</ul>

<h1 id="validation">Validation</h1>

<ul>
  <li>You can define resource APIs in the JSON schema.</li>
  <li>You can separate the validation code with <code class="language-plaintext highlighter-rouge">@Valid</code>, <code class="language-plaintext highlighter-rouge">@OnValidate</code> annotation.</li>
  <li>Please see the form for validation by web form.</li>
</ul>

<h1 id="json-schema">JSON Schema</h1>

<p>The <a href="http://json-schema.org/">JSON Schema</a> is the standard for describing and validating JSON objects. <code class="language-plaintext highlighter-rouge">@JsonSchema</code> and the resource body returned by the method of annotated resource class are validated by JSON schema.</p>

<h3 id="install-3">Install</h3>

<p>If you want to validate in all contexts including production, create <code class="language-plaintext highlighter-rouge">AppModule</code>, if validation is done only during development, create <code class="language-plaintext highlighter-rouge">DevModule</code> and install within it</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Resource\Module\JsonSchemaModule</span><span class="p">;</span> <span class="c1">// Add this line</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">JsonSchemaModule</span><span class="p">(</span>
                <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/var/json_schema'</span><span class="p">,</span>
                <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/var/json_validate'</span>
            <span class="p">)</span>
        <span class="p">);</span>  <span class="c1">// Add this line</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Create directories for the JSON schema files</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>var/json_schema
<span class="nb">mkdir </span>var/json_validate
</code></pre></div></div>

<p>In the <code class="language-plaintext highlighter-rouge">var/json_schema/</code>, store the JSON schema file which is the specification of the body of the resource, and the <code class="language-plaintext highlighter-rouge">var/json_validate/</code> stores the JSON schema file for input validation.</p>

<h3 id="jsonschema-annotation">@JsonSchema annotation</h3>

<p>Annotate the method of the resource class by adding <code class="language-plaintext highlighter-rouge">@JsonSchema</code>, then add the <code class="language-plaintext highlighter-rouge">schema</code> property by specifying the JSON schema file name, which is <code class="language-plaintext highlighter-rouge">user.json</code> for this purpose.</p>

<h3 id="schema">schema</h3>

<p>src/Resource/App/User.php</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\JsonSchema</span><span class="p">;</span> <span class="c1">// Add this line</span>

<span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[JsonSchema('user.json')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'firstName'</span> <span class="o">=&gt;</span> <span class="s1">'mucha'</span><span class="p">,</span>
            <span class="s1">'lastName'</span> <span class="o">=&gt;</span> <span class="s1">'alfons'</span><span class="p">,</span>
            <span class="s1">'age'</span> <span class="o">=&gt;</span> <span class="mi">12</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We will create a JSON schema named <code class="language-plaintext highlighter-rouge">/var/json_schema/user.json</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"firstName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[a-z</span><span class="se">\\</span><span class="s2">d~+-]+"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"lastName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[a-z</span><span class="se">\\</span><span class="s2">d~+-]+"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"firstName"</span><span class="p">,</span><span class="w"> </span><span class="s2">"lastName"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="key">key</h3>

<p>If the body has an index key, specify it with the key property of the annotation</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\JsonSchema</span><span class="p">;</span> <span class="c1">// Add this line</span>

<span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[JsonSchema(key:'user', schema:'user.json')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'user'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'firstName'</span> <span class="o">=&gt;</span> <span class="s1">'mucha'</span><span class="p">,</span>
                <span class="s1">'lastName'</span> <span class="o">=&gt;</span> <span class="s1">'alfons'</span><span class="p">,</span>
                <span class="s1">'age'</span> <span class="o">=&gt;</span> <span class="mi">12</span>
            <span class="p">]</span>
        <span class="p">];</span>        

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="params">params</h3>

<p>The <code class="language-plaintext highlighter-rouge">params</code> property specifies the JSON schema file name for the argument validation</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\JsonSchema</span><span class="p">;</span> <span class="c1">// Add this line</span>

<span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[JsonSchema(key:'user', schema:'user.json', params:'todo.post.json')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$title</span><span class="p">)</span>
</code></pre></div></div>

<p>We place the JSON schema file</p>

<p><strong>/var/json_validate/todo.post.json</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://json-schema.org/draft-04/schema#"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/todo POST request validation"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"minLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<p>By constantly verifying in a standardized way instead of proprietary documentation, the specification is <strong>reliable and understandable</strong> to both humans and machines.</p>

<h3 id="target">target</h3>

<p>To apply schema validation to the representation of the resource object (the rendered result) rather than to the body of the ResourceObject, specify the option <code class="language-plaintext highlighter-rouge">target='view'</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[JsonSchema(schema: 'user.json', target: 'view')]</span>
</code></pre></div></div>

<h3 id="related-links">Related Links</h3>

<ul>
  <li><a href="http://json-schema.org/examples.html">Example</a></li>
  <li><a href="https://spacetelescope.github.io/understanding-json-schema/">Understanding JSON Schema</a></li>
  <li><a href="https://jsonschema.net/#/editor">JSON Schema Generator</a></li>
</ul>

<h2 id="valid-annotation">@Valid annotation</h2>

<p>The <code class="language-plaintext highlighter-rouge">@Valid</code> annotation is a validation for input.
You can set up validation as AOP for your method.
By separating validation logic from the method, the code will be readable and testable.</p>

<p>Validation libraries are available such as <a href="https://github.com/auraphp/Aura.Filter">Aura.Filter</a>, <a href="https://github.com/Respect/Validation">Respect\Validation</a>, and <a href="http://php.net/manual/en/book.filter.php">PHP Standard Filter</a></p>

<h3 id="install-4">Install</h3>

<p>Install <code class="language-plaintext highlighter-rouge">Ray.ValidateModule</code> via composer.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require ray/validate-module
</code></pre></div></div>

<p>Installing <code class="language-plaintext highlighter-rouge">ValidateModule</code> in your application module <code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Validation\ValidateModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">ValidateModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="annotation">Annotation</h3>

<p>There are three annotations <code class="language-plaintext highlighter-rouge">@Valid</code>, <code class="language-plaintext highlighter-rouge">@OnValidate</code>, <code class="language-plaintext highlighter-rouge">@OnFailure</code> for validation.</p>

<p>First of all, annotate the method that you want to validate with <code class="language-plaintext highlighter-rouge">@Valid</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Validation\Annotation\Valid</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span>
<span class="p">{</span>
    <span class="cd">/**
     * @Valid
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">createUser</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
</code></pre></div></div>

<p>Validation will be conducted in the method annotated with <code class="language-plaintext highlighter-rouge">@OnValidate</code>.</p>

<p>The arguments of the method should be the same as the original method. The method name can be anything.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Validation\Annotation\OnValidate</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span>
<span class="p">{</span>
    <span class="cd">/**
     * @OnValidate
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onValidate</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$validation</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Validation</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$name</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$validation</span><span class="o">-&gt;</span><span class="nf">addError</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'name should be string'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$validation</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Add validations to your elements by <code class="language-plaintext highlighter-rouge">addError()</code> with the <code class="language-plaintext highlighter-rouge">element name</code> and<code class="language-plaintext highlighter-rouge"> error message</code> as parameters, then return the validation object.</p>

<p>When validation fails, the exception <code class="language-plaintext highlighter-rouge">Ray\Validation\Exception\InvalidArgumentException</code> will be thrown,
but if you have a method annotated with the <code class="language-plaintext highlighter-rouge">@OnFailure</code>, it will be called, instead of throwing an exception</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Validation\Annotation\OnFailure</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span>
<span class="p">{</span>
    <span class="cd">/**
     * @OnFailure
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onFailure</span><span class="p">(</span><span class="kt">FailureInterface</span> <span class="nv">$failure</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// original parameters</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">defaultName</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$failure</span><span class="o">-&gt;</span><span class="nf">getInvocation</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getArguments</span><span class="p">();</span>

        <span class="c1">// errors</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$failure</span><span class="o">-&gt;</span><span class="nf">getMessages</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$name</span> <span class="o">=&gt;</span> <span class="nv">$messages</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$messages</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">echo</span> <span class="s2">"Input '</span><span class="si">{</span><span class="nv">$name</span><span class="si">}</span><span class="s2">': </span><span class="si">{</span><span class="nv">$message</span><span class="si">}</span><span class="s2">"</span> <span class="mf">.</span> <span class="kc">PHP_EOL</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>In the method annotated with <code class="language-plaintext highlighter-rouge">@OnFailure</code>, you can access the validated messages with <code class="language-plaintext highlighter-rouge">$failure-&gt;getMessages()</code>
and also you can get the object of the original method with <code class="language-plaintext highlighter-rouge">$failure-&gt;getInvocation()</code>.</p>

<h3 id="various-validation">Various validation</h3>

<p>If you want to have different validations for a class, you can specify the name of the validation like below</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Validation\Annotation\Valid</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Validation\Annotation\OnValidate</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Validation\Annotation\OnFailure</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span>
<span class="p">{</span>
    <span class="cd">/**
     * @Valid("foo")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">fooAction</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$address</span><span class="p">,</span> <span class="nv">$zip</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="cd">/**
     * @OnValidate("foo")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onValidateFoo</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$address</span><span class="p">,</span> <span class="nv">$zip</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="cd">/**
     * @OnFailure("foo")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onFailureFoo</span><span class="p">(</span><span class="kt">FailureInterface</span> <span class="nv">$failure</span><span class="p">)</span>
    <span class="p">{</span>
</code></pre></div></div>

<h3 id="other-validation">Other validation</h3>

<p>If you need to implement complex validation, you can have another class for validation and inject it.
And then call in the method annotated with the <code class="language-plaintext highlighter-rouge">onValidate</code>.
You can also change your validation behavior by context with DI.</p>

<h1 id="version">Version</h1>

<h2 id="supported-php">Supported PHP</h2>

<p><a href="https://github.com/bearsunday/BEAR.SupportedVersions/actions/workflows/continuous-integration.yml"><img src="https://github.com/bearsunday/BEAR.SupportedVersions/actions/workflows/continuous-integration.yml/badge.svg" alt="Continuous Integration" /></a></p>

<p>BEAR.Sunday supports the following supported PHP versions</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">8.1</code> (Old stable 25 Nov 2021 - 25 Nov 2024)</li>
  <li><code class="language-plaintext highlighter-rouge">8.2</code> (Old stable 8 Dec 2022 - 8 Dec 2025)</li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">8.3</code> (Current stable 23 Nov 2022 - 26 Nov 2026)</p>
  </li>
  <li>
    <p>End of life (<a href="http://php.net/eol.php">EOL</a>)</p>
  </li>
  <li><code class="language-plaintext highlighter-rouge">5.5</code> (21 Jul 2016)</li>
  <li><code class="language-plaintext highlighter-rouge">5.6</code> (31 Dec 2018)</li>
  <li><code class="language-plaintext highlighter-rouge">7.0</code> (3 Dec 2018)</li>
  <li><code class="language-plaintext highlighter-rouge">7.1</code> (1 Dec 2019)</li>
  <li><code class="language-plaintext highlighter-rouge">7.2</code> (30 Nov 2020)</li>
  <li><code class="language-plaintext highlighter-rouge">7.3</code> (6 Dec 2021)</li>
  <li><code class="language-plaintext highlighter-rouge">7.4</code> (28 Nov 2022)</li>
  <li><code class="language-plaintext highlighter-rouge">8.0</code> (26 Nov 2023)</li>
</ul>

<p>The new optional package will be developed based on the current stable PHP. We encourage you to use the current stable PHP for quality, performance and security.</p>

<p><a href="https://github.com/bearsunday/BEAR.SupportedVersions/">BEAR.SupportedVersions</a>, you can check the tests for each version in CI.</p>

<h2 id="semver-1">Semver</h2>

<p>BEAR.Sunday follows <a href="http://
semper.org/lang/en/">Semantic Versioning</a>. It is not necessary to modify the application code on minor version upgrades.</p>

<p><code class="language-plaintext highlighter-rouge">composer update</code> can be done at any time for packages.</p>

<h2 id="version-policy">Version Policy</h2>

<ul>
  <li>The core package of the framework does not make a breaking change which requires change of user code.</li>
  <li>Since it does not do destructive change, it handles unnecessary old ones as <code class="language-plaintext highlighter-rouge">deprecetad</code> but does not delete and new functions are always “added”.</li>
  <li>When PHP comes to an EOL and upgraded to a major version (ex. <code class="language-plaintext highlighter-rouge">5.6</code> →<code class="language-plaintext highlighter-rouge"> 7.0</code>), BEAR.Sunday will not break the BC of the application code. Even though the version number of PHP that is necessary to use the new module becomes higher, changes to the application codes are not needed.</li>
</ul>

<p>BEAR.Sunday emphasizes clean code and <strong>longevity</strong>.</p>

<h2 id="package-version">Package version</h2>

<p>The version of the framework does not lock the version of the library. The library can be updated regardless of the version of the framework.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:dip" role="doc-endnote">
      <p><a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle">Dependency inversion principle</a> <a href="#fnref:dip" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:1" role="doc-endnote">
      <p>.env should not be git committed. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:1:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:method" role="doc-endnote">
      <p>REST methods are not a mapping to CRUD. They are divided into two categories: safe ones that do not change the resource state, or idempotent ones. <a href="#fnref:method" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:LO" role="doc-endnote">
      <p><a href="http://amundsen.com/hypermedia/hfactor/#le">out-bound links</a> e.g.) html can link to other related html. <a href="#fnref:LO" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:LE" role="doc-endnote">
      <p><a href="http://amundsen.com/hypermedia/hfactor/#le">embedded links</a> Example: html can embed independent image resources. <a href="#fnref:LE" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:di" role="doc-endnote">
      <p>This is similar to an object graph where the dependency tree is a graph in DI. <a href="#fnref:di" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>For example, if it is an e-commerce site, the test will represent the transition of each application state, such as product list, add to cart, order, payment, etc. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:php8" role="doc-endnote">
      <p>This is called with named arguments in PHP8.x, but with ordinal arguments in PHP7.x. <a href="#fnref:php8" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:json" role="doc-endnote">
      <p>Set the <code class="language-plaintext highlighter-rouge">content-type</code> header to <code class="language-plaintext highlighter-rouge">application/json</code> if you are sending API requests in JSON. <a href="#fnref:json" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:spy-module" role="doc-endnote">
      <p><a href="https://github.com/ray-di/Ray.TestDouble">ray/test-double</a> must be installed to use SpyModule. <a href="#fnref:spy-module" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:13" role="doc-endnote">
      <p>This SQL conforms to the <a href="https://www.sqlstyle.guide/">SQL Style Guide</a>. It can be configured from PhpStorm as <a href="https://twitter.com/koriym/status/1410996122412150786">Joe Celko</a>. <a href="#fnref:13" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p><a href="https://pleiades.io/help/phpstorm/relational-databases.html">PHPStorm Database Tools and SQL</a> <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p><a href="https://pleiades.io/help/phpstorm/creating-diagrams.html">Database Diagrams</a>, etc. to check the query plan and execution plan to improve the quality of the SQL you create. <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:named" role="doc-endnote">
      <p><a href="https://www.php.net/manual/en/functions.arguments.php#functions.named-arguments">PHP 8.0+ named arguments ¶</a>, column order for PHP 7.x. <a href="#fnref:named" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:8" role="doc-endnote">
      <p>MediaQuery <a href="">README</a> Here we run it directly from mysql as an example, but you should also learn how to enter seed in the migration tool and use the IDE’s DB tools. <a href="#fnref:8" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p>Ray.MediaQuery also supports HTTP API requests. <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:6" role="doc-endnote">
      <p>MediaQuery also supports HTTP API requests. This hierarchical structure of content is called <strong>Taxonomy</strong> in IA (Information Architecture). See <a href="https://understandinggroup.com/ia-theory/understanding-information-architecture">Understanding Information Architecture</a>. <a href="#fnref:6" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:7" role="doc-endnote">
      <p>Ray.MediaQuery <a href="https://github.com/ray-di/Ray.MediaQuery/blob/1.x/README.ja.md#%E6%97%A5%E4%BB%98%E6%99%82%E5%88%BB">README</a> <a href="#fnref:7" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:11" role="doc-endnote">
      <p>It is a widespread misconception that the Uniform Interface is not an HTTP method. See <a href="https://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm">Uniform Interface</a>. <a href="#fnref:11" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:9" role="doc-endnote">
      <p>The so-called “Restish API”; many APIs introduced as REST APIs have this URI/object style, and REST is misused. <a href="#fnref:9" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:10" role="doc-endnote">
      <p>If you remove the links from the tutorial, you get the URI style. <a href="#fnref:10" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:12" role="doc-endnote">
      <p><a href="https://www.iana.org/assignments/media-types/media-types.xhtml">https://www.iana.org/assignments/media-types/media-types.xhtml</a> <a href="#fnref:12" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

            </article>
        </div>
        <div id="ArticleToc" class="col-lg-2 d-none d-lg-block">
            <nav class="nav side-bar-right"></nav>
        </div>
    </div>
</main>
<footer>
    <div class="container d-md-flex">
        <i class="bear-icon d-none d-lg-block"></i>
        <small>
            © 2011-2024 BEAR.Sunday
        </small>
        <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex">
            <li>
                <a href="https://gitter.im/bearsunday/BEAR.Sunday?utm_source=badge&utm_medium=badge&utm_campaign=pr-badge">Gitter</a>
            </li>
            <li>
                <a href="https://github.com/bearsunday/BEAR.Sunday">Github</a>
            </li>
            <li>
                <a href="https://twitter.com/BEARSunday">Twitter</a>
            </li>
            <li>
                <a href="https://www.facebook.com/pages/BEARSunday/110116939178462?ref=hl">Facebook</a>
            </li>
            <li>
                <a href="http://koriym.github.io/">Blog (JA)</a>
            </li>
            <li>
                <a href="https://github.com/bearsunday/bearsunday.github.io">PR ?</a>
            </li>
        </ul>
    </div>
</footer>
<script src="//code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="//stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-6074569-8', 'bearsunday.github.io'); ga('send', 'pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

<script src="/js/generate-table-of-contents/index.min.js"></script>
<script>
    var toc = generateTableOfContents(document.getElementById('article'));
    var sideBarRight = $('.side-bar-right');
    sideBarRight.append(toc);

    var scrollOffset = $('body').attr('data-offset');
    var articlePaddingTop = $('article').css('padding-top').replace('px', '');
    sideBarRight.find('a').on('click', function (e) {
        e.preventDefault();
        var targetId = $(this).attr('href');
        var targetPositionTop = $(targetId).offset().top - scrollOffset - articlePaddingTop;
        window.scrollTo(0, targetPositionTop)
    });
</script>

</body>
</html>
