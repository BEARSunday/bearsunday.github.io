---
layout: docs-ja
title: アプリケーション
category: Manual
permalink: /manuals/1.0/ja/application.html
---
# アプリケーション

## 実行シーケンス
コンパイル、リクエスト、レスポンスの順でアプリケーションが実行されます。

### 0. コンパイル

`$context`に対応したDIとAOPの設定で、アプリケーションの実行に必要なルートオブジェクト`$app`を生成します。`$app`の主なプロパティは以下の通り。

* router - 外部入力をリソースリクエストに変換
* resource - リソースクライアント
* transfer - リソース状態の出力

### 1. リクエスト

`router`によってHTTPリクエストやコンソールコマンドがリソースリクエストに変更され、リソースクラインとがリエスクトを実行します。その時`onGet`などのリソースメソッドで**リソース状態**を`code`,`header`, `body`にセットします。メソッドの前後では、ログや認証などメソッドに束縛されたアプリケーションロジックがAOPで実行されます。

### 2. レスポンス

リソースのレンダラーが**リソースの状態**を**表現**(JSONやHTML)にして、クライアントに**転送**します。
(**RE**presentational **S**tate **T**ransfer=REST)

 <img src="/images/screen/diagram.png" style="max-width: 100%;height: auto;"/>


## bootスクリプト

`public/`や`bin/`等のエントリーポイントに設置され、アプリケーションを実行します。
スクリプトではアプリケーション実行コンテキストを指定して実行します。


```php
require dirname(__DIR__) . '/autoload.php';
exit((new Bootstrap())('app', $GLOBALS, $_SERVER));
```

デフォルトではWebサーバースクリプトです。

```bash
php -S 127.0.0.1:8080 public/index.php
```

`cli` コンテキストを付加するとコンソールアプリーケーションのスクリプトになります。

```php
exit((new Bootstrap())('cli-app', $GLOBALS, $_SERVER));
```

```bash
php bin/app.php get /user/1
```

## コンテキスト

コンテキストは特定の目的のためのDIとAOPの束縛のセットです。コードは同じでも束縛が変わることで、アプリケーションが違う振る舞いをします。
コンテキストはフレームワークが用意しているbuilt-inコンテキストとアプリケーションが作成するカスタムコンテキストがあります。

### built-inコンテキスト

 * `api`  APIアプリケーション
 * `cli`  コンソールアプリケーション
 * `hal`  HALフォーマット表現
 * `prod` プロダクション
 
 * `app`は基本のアプリケーションです。リソースはJSONでレンダリングされます。
 * `api`はデフォルトのリソースのスキーマをpageからappに変更します。Webのルートアクセス(`GET /`)は`app://self/`へのアクセスになります。
 * `cli`にするとコンソールアプリケーションになります。

コンテキスト名ははそれぞれのモジュールに対応します。例えばappはAppModule, cliはCliModuleに対応します。
コンテキストは組み合わせて使う事ができます。[^example] 

[^example]:`cli-app`ならバッチ用コンソールアプリケーション、`prod-hal-api-app`ならプロダクション用HALのAPIアプリケーションなどになります。

### カスタムコンテキスト

アプリケーションの`src/Module`/に設置します。built-inコンテキストと同名にするとカスタムコンテキストが優先されます。カスタムコンテキストからbuilt-inコンテキストを呼び出すことで一部の束縛を上書きする事ができます。

### コンテキスト無知

コンテキストの値はルートオブジェクトの作成のみに使われその後に消滅します。アプリケーションから参照可能なグローバルな"モード"は存在せず、アプリケーションは現在実行されているコンテキストを知ることはできません。外部の値を参照して振る舞いを変えるのではなく、**インターフェイスのみに依存**[^dip]し**コンテキストによる束縛の変更**で振る舞いを変更します。

---

[^dip]: [依存性逆転の法則](https://ja.wikipedia.org/wiki/依存性逆転の原則)
