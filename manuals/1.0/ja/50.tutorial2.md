---
layout: docs-ja
title: チュートリアル2
category: Manual
permalink: /manuals/1.0/ja/tutorial2.html
---
# チュートリアル2

このチュートリアルでは、以下のツールを用いて標準に基づいた高品質なREST(Hypermedia)アプリケーション開発を学びます：

* [Json Schema](https://json-schema.org/)  
  JSONのスキーマを定義し、バリデーションやドキュメンテーションに利用します

* [HAL (Hypertext Application Language)](https://stateless.group/hal_specification.html)  
  ハイパーメディアタイプとして利用します

* [Phinx](https://book.cakephp.org/3.0/ja/phinx.html)  
  CakePHPが開発するDBマイグレーションツールです

* [Ray.MediaQuery](https://github.com/ray-di/Ray.MediaQuery)  
  PHPのインターフェイスとSQL文実行を束縛します

[tutorial2](https://github.com/bearsunday/tutorial2/commits/v2-php8.2)のコミットを参考に進めていきましょう。

## プロジェクト作成

プロジェクトスケルトンを作成します：

```bash
composer create-project bear/skeleton MyVendor.Ticket
```

**vendor**名を`MyVendor`に、**project**名を`Ticket`として入力してください。

## マイグレーション

はじめに、Phinxをインストールします：

```bash
composer require --dev robmorgan/phinx
```

プロジェクトルートフォルダの`.env.dist`ファイルに以下のDB接続情報を記述します：

```
TKT_DB_HOST=127.0.0.1:3306
TKT_DB_NAME=ticket
TKT_DB_USER=root
TKT_DB_PASS=''
TKT_DB_SLAVE=''
TKT_DB_DSN=mysql:host=${TKT_DB_HOST}
```

`.env.dist`ファイルはこのように設定し、実際の接続情報は`.env`に記述します。[^1]

次にphinxが利用するフォルダを作成します：

```bash
mkdir -p var/phinx/migrations
mkdir -p var/phinx/seeds
```

`.env`の接続情報をphinxで利用するために`var/phinx/phinx.php`を以下のように設置します：

```php
<?php
use BEAR\Dotenv\Dotenv;

require_once dirname(__DIR__, 2) . '/vendor/autoload.php';

(new Dotenv())->load(dirname(__DIR__, 2));

$development = new PDO(getenv('TKT_DB_DSN'), getenv('TKT_DB_USER'), getenv('TKT_DB_PASS'));
$test = new PDO(getenv('TKT_DB_DSN') . '_test', getenv('TKT_DB_USER'), getenv('TKT_DB_PASS'));
return [
    'paths' => [
        'migrations' => __DIR__ . '/migrations',
    ],
    'environments' => [
        'development' => [
            'name' => $development->query("SELECT DATABASE()")->fetchColumn(),
            'connection' => $development
        ],
        'test' => [
            'name' => $test->query("SELECT DATABASE()")->fetchColumn(),
            'connection' => $test
        ]
    ]
];
```

### セットアップスクリプト

データベース作成やマイグレーションを簡単に実行できるように`bin/setup.php`を以下のように編集します：

```php
<?php
use BEAR\Dotenv\Dotenv;

require_once dirname(__DIR__) . '/vendor/autoload.php';

(new Dotenv())->load(dirname(__DIR__));

chdir(dirname(__DIR__));
passthru('rm -rf var/tmp/*');
passthru('chmod 775 var/tmp');
passthru('chmod 775 var/log');
// db
$pdo = new \PDO('mysql:host=' . getenv('TKT_DB_HOST'), getenv('TKT_DB_USER'), getenv('TKT_DB_PASS'));
$pdo->exec('CREATE DATABASE IF NOT EXISTS ' . getenv('TKT_DB_NAME'));
$pdo->exec('DROP DATABASE IF EXISTS ' . getenv('TKT_DB_NAME') . '_test');
$pdo->exec('CREATE DATABASE ' . getenv('TKT_DB_NAME') . '_test');
passthru('./vendor/bin/phinx migrate -c var/phinx/phinx.php -e development');
passthru('./vendor/bin/phinx migrate -c var/phinx/phinx.php -e test');
```

## マイグレーションクラスの作成

`ticket`テーブルを作成するためのマイグレーションクラスを作成します：

```bash
./vendor/bin/phinx create Ticket -c var/phinx/phinx.php
```

実行すると以下のような出力が表示されます：

```
Phinx by CakePHP - https://phinx.org.

...
created var/phinx/migrations/20210520124501_ticket.php
```

作成された`var/phinx/migrations/{current_date}_ticket.php`を編集して`change()`メソッドを以下のように実装します：

```php
<?php
use Phinx\Migration\AbstractMigration;

final class Ticket extends AbstractMigration
{
    public function change(): void
    {
        $table = $this->table('ticket', ['id' => false, 'primary_key' => ['id']]);
        $table->addColumn('id', 'uuid', ['null' => false])
            ->addColumn('title', 'string')
            ->addColumn('date_created', 'datetime')
            ->create();
    }
}
```

次に、`.env.dist`ファイルを以下のように更新します：

```diff
 TKT_DB_USER=root
 TKT_DB_PASS=
 TKT_DB_SLAVE=
-TKT_DB_DSN=mysql:host=${TKT_DB_HOST}
+TKT_DB_DSN=mysql:host=${TKT_DB_HOST};dbname=${TKT_DB_NAME}
```

準備が完了したら、セットアップコマンドを実行してテーブルを作成します：

```bash
composer setup
```

実行すると以下のような出力が表示されます：

```
> php bin/setup.php
...
All Done. Took 0.0248s
```

これでテーブルが作成されました。以降、このプロジェクトのデータベース環境を整えるには`composer setup`を実行するだけで済みます。

マイグレーションクラスの詳しい記述方法については、[Phinxのマニュアル：マイグレーションを書く](https://book.cakephp.org/3.0/ja/phinx/migrations.html)をご覧ください。

## モジュールの設定

必要なモジュールをcomposerでインストールします：

```bash
composer require ray/identity-value-module ray/media-query -w
```

AppModuleでパッケージをインストールします。`src/Module/AppModule.php`を以下のように編集します：

```php
<?php
namespace MyVendor\Ticket\Module;

use BEAR\Dotenv\Dotenv;
use BEAR\Package\AbstractAppModule;
use BEAR\Package\PackageModule;
use BEAR\Resource\Module\JsonSchemaModule;
use Ray\AuraSqlModule\AuraSqlModule;
use Ray\IdentityValueModule\IdentityValueModule;
use Ray\MediaQuery\DbQueryConfig;
use Ray\MediaQuery\MediaQueryModule;
use Ray\MediaQuery\Queries;
use function dirname;

class AppModule extends AbstractAppModule
{
    protected function configure(): void
    {
        // 環境変数の読み込み
        (new Dotenv())->load(dirname(__DIR__, 2));

        // データベース接続の設定
        $this->install(
            new AuraSqlModule(
                (string) getenv('TKT_DB_DSN'),
                (string) getenv('TKT_DB_USER'),
                (string) getenv('TKT_DB_PASS'),
                (string) getenv('TKT_DB_SLAVE')
            )
        );

        // MediaQueryモジュールの設定
        $this->install(
            new MediaQueryModule(
                Queries::fromDir($this->appMeta->appDir . '/src/Query'),
                [new DbQueryConfig($this->appMeta->appDir . '/var/sql')]
            )
        );

        // その他の必要なモジュールのインストール
        $this->install(new IdentityValueModule());
        $this->install(
            new JsonSchemaModule(
                $this->appMeta->appDir . '/var/schema/response',
                $this->appMeta->appDir . '/var/schema/request'
            )
        );
        $this->install(new PackageModule());
    }
}
```

## SQL定義の作成

チケット管理に必要な3つのSQLを`var/sql`ディレクトリに作成します[^13]：

### チケット追加用SQL
`var/sql/ticket_add.sql`:

```sql
/* ticket add */
INSERT INTO ticket (id, title, date_created)
VALUES (:id, :title, :dateCreated);
```

### チケット一覧取得用SQL
`var/sql/ticket_list.sql`:

```sql
/* ticket list */
SELECT id, title, date_created
  FROM ticket
 LIMIT 3;
```

### チケット詳細取得用SQL
`var/sql/ticket_item.sql`:

```sql
/* ticket item */
SELECT id, title, date_created
  FROM ticket
 WHERE id = :id
```

composer require ray/identity-value-module ray/media-query -w
```

AppModuleでパッケージをインストールします。`src/Module/AppModule.php`を以下のように編集します：

```php
<?php
namespace MyVendor\Ticket\Module;

use BEAR\Dotenv\Dotenv;
use BEAR\Package\AbstractAppModule;
use BEAR\Package\PackageModule;
use BEAR\Resource\Module\JsonSchemaModule;
use Ray\AuraSqlModule\AuraSqlModule;
use Ray\IdentityValueModule\IdentityValueModule;
use Ray\MediaQuery\DbQueryConfig;
use Ray\MediaQuery\MediaQueryModule;
use Ray\MediaQuery\Queries;
use function dirname;

class AppModule extends AbstractAppModule
{
    protected function configure(): void
    {
        // 環境変数の読み込み
        (new Dotenv())->load(dirname(__DIR__, 2));

        // データベース接続の設定
        $this->install(
            new AuraSqlModule(
                (string) getenv('TKT_DB_DSN'),
                (string) getenv('TKT_DB_USER'),
                (string) getenv('TKT_DB_PASS'),
                (string) getenv('TKT_DB_SLAVE')
            )
        );

        // MediaQueryモジュールの設定
        $this->install(
            new MediaQueryModule(
                Queries::fromDir($this->appMeta->appDir . '/src/Query'),
                [new DbQueryConfig($this->appMeta->appDir . '/var/sql')]
            )
        );

        // その他の必要なモジュールのインストール
        $this->install(new IdentityValueModule());
        $this->install(
            new JsonSchemaModule(
                $this->appMeta->appDir . '/var/schema/response',
                $this->appMeta->appDir . '/var/schema/request'
            )
        );
        $this->install(new PackageModule());
    }
}
```

## SQL定義の作成

チケット管理に必要な3つのSQLを`var/sql`ディレクトリに作成します[^13]：

### チケット追加用SQL
`var/sql/ticket_add.sql`:

```sql
/* ticket add */
INSERT INTO ticket (id, title, date_created)
VALUES (:id, :title, :dateCreated);
```

### チケット一覧取得用SQL
`var/sql/ticket_list.sql`:

```sql
/* ticket list */
SELECT id, title, date_created
  FROM ticket
 LIMIT 3;
```

### チケット詳細取得用SQL
`var/sql/ticket_item.sql`:

```sql
/* ticket item */
SELECT id, title, date_created
  FROM ticket
 WHERE id = :id
```

SQLを作成する際は、単体で動作確認することをお勧めします。例えば、PHPStormに含まれるデータベースツール[DataGrip](https://www.jetbrains.com/ja-jp/datagrip/)を使用すると、コード補完やSQLのリファクタリングなどの機能を活用でき、SQLファイルを直接実行して動作確認できます。[^3][^4]

## JsonSchemaの定義

リソース表現をJsonSchemaで定義します。チケット管理システムでは以下の2つのスキーマが必要です：

1. `Ticket`（単一チケット情報）
2. `Tickets`（チケット一覧）

### チケット情報のスキーマ
`var/schema/response/ticket.json`:

```json
{
  "$id": "ticket.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Ticket",
  "type": "object",
  "required": ["id", "title", "date_created"],
  "properties": {
    "id": {
      "description": "The unique identifier for a ticket.",
      "type": "string",
      "maxLength": 64
    },
    "title": {
      "description": "The unique identifier for a ticket.",
      "type": "string",
      "maxLength": 255
    },
    "date_created": {
      "description": "The date and time that the ticket was created",
      "type": "string",
      "format": "datetime"
    }
  }
}
```

### チケット一覧のスキーマ
`var/schema/response/tickets.json`:

```json
{
  "$id": "tickets.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Tickets",
  "type": "object",
  "required": ["tickets"],
  "properties": {
    "tickets": {
      "type": "array",
      "items": {"$ref": "./ticket.json"}
    }
  }
}
```

JsonSchemaの主要な要素：

* **$id**: スキーマの識別子。公開APIの場合はURLを指定
* **title**: APIドキュメントで使用されるオブジェクト名
* **description**: プロパティの説明
* **required**: 必須フィールドの指定
* **properties**: 各フィールドの定義
* **$ref**: 他のスキーマファイルの参照

composer require ray/identity-value-module ray/media-query -w
```

AppModuleでパッケージをインストールします。`src/Module/AppModule.php`を以下のように編集します：

[前のコンテンツ...]

## クエリーインターフェイス

チケット管理システムのインフラストラクチャへのアクセスを抽象化するため、以下の2つのPHPインターフェイスを作成します：

1. `TicketQueryInterface` - チケット情報の読み取り
2. `TicketCommandInterface` - チケット情報の作成

### チケット照会用インターフェイス
`src/Query/TicketQueryInterface.php`:

```php
<?php

namespace MyVendor\Ticket\Query;

use MyVendor\Ticket\Entity\Ticket;
use Ray\MediaQuery\Annotation\DbQuery;

interface TicketQueryInterface
{
    /**
     * 指定されたIDのチケット情報を取得
     */
    #[DbQuery('ticket_item')]
    public function item(string $id): Ticket|null;

    /**
     * チケット一覧を取得
     * @return array<Ticket>
     */
    #[DbQuery('ticket_list')]
    public function list(): array;
}
```

### チケット作成用インターフェイス
`src/Query/TicketCommandInterface.php`:

```php
<?php

namespace MyVendor\Ticket\Query;

use DateTimeInterface;
use Ray\MediaQuery\Annotation\DbQuery;

interface TicketCommandInterface
{
    /**
     * 新規チケットを作成
     */
    #[DbQuery('ticket_add')]
    public function add(string $id, string $title, DateTimeInterface $dateCreated = null): void;
}
```
