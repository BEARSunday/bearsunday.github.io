---
layout: docs-ja
title: コマンドラインインターフェイス (CLI)
category: Manual
permalink: /manuals/1.0/ja/cli.html
---
# コマンドラインインターフェイス (CLI)

BEAR.Sundayのリソース指向アーキテクチャ（ROA）は、アプリケーションのあらゆる機能をURIでアドレス可能なリソースとして表現します。このアプローチにより、Webに限らず様々な方法でリソースにアクセスできます。

```bash
$ php page.php '/greeting?name=World&lang=ja'
{
    "greeting": "Hello, World",
    "lang": "ja"
}
```

BEAR.Cliは、このようなリソースをネイティブなCLIコマンドに変換し、Homebrewで配布可能にするツールです：


```bash
$ greet -n "World" -l ja
Hello, World
```

追加のコードを書くことなく、既存のアプリケーションリソースを標準的なCLIツールとして再利用できます。Homebrewを通じた配布により、PHPやBEAR.Sundayで動作していることを知ることなく、一般的なコマンドラインツールと同じように利用できます。

## インストール

Composerでインストールします。

```bash
composer require bear/cli
```

## 基本的な使い方

### リソースへのCLI属性の追加

リソースクラスにCLI属性を追加して、コマンドラインインターフェースを定義します。

```php
use BEAR\Cli\Attribute\Cli;
use BEAR\Cli\Attribute\Option;

class Greeting extends ResourceObject
{
    #[Cli(
        name: 'greet',
        description: 'Say hello in multiple languages',
        output: 'greeting'
    )]
    public function onGet(
        #[Option(shortName: 'n', description: 'Name to greet')]
        string $name,
        #[Option(shortName: 'l', description: 'Language (en, ja, fr, es)')]
        string $lang = 'en'
    ): static {
        $this->body = [
            'greeting' => "Hello, {$name}",
            'lang' => $lang
        ];
        
        return $this;
    }
}
```

### CLIコマンドとフォーミュラの生成

```bash
$ vendor/bin/bear-cli-gen MyVendor.MyProject
# 生成されたファイル:
#   bin/cli/greet       　 # CLIコマンド
#   var/homebrew/greet.rb  # Homebrewフォーミュラ


## コマンドの使用方法

生成されたコマンドは以下のような標準的なCLI機能を提供します：

### ヘルプの表示

```bash
$ greet --help
Say hello in multiple languages

Usage: greet [options]

Options:
  --name, -n     Name to greet (required)
  --lang, -l     Language (en, ja, fr, es) (default: en)
  --help, -h     Show this help message
  --version, -v  Show version information
  --format       Output format (text|json) (default: text)
```

### バージョン情報の表示

```bash
$ greet --version
greet version 0.1.0
```

### 基本的な使用例

```bash
# 基本的な挨拶
$ greet -n "World"
Hello, World

# 言語を指定
$ greet -n "World" -l ja
こんにちは, World

# 短いオプション
$ greet -n "World" -l fr
Bonjour, World

# 長いオプション
$ greet --name "World" --lang es
¡Hola, World
```

### JSON出力

```bash
$ greet -n "World" -l ja --format json
{
    "greeting": "こんにちは, World",
    "lang": "ja"
}
```

## 配布方法

BEAR.Cliで作成したコマンドは、以下の2つの方法でHomebrewを通じて配布できます：

### 1. ローカルフォーミュラによる配布

開発版をテストする場合：

```bash
$ brew install --formula ./var/homebrew/greet.rb
```

この方法は以下の場合に適しています：
- プライベートプロジェクト
- 開発中のテスト
- 社内ツールの配布

### 2. Homebrewタップによる配布

公開リポジトリを使用して広く配布する方法です：

```bash
$ brew tap your-vendor/greet
$ brew install your-vendor/greet
```

この方法は以下の場合に適しています：
- オープンソースプロジェクト
- 公開ツールの配布
- 継続的なアップデートの提供

#### 開発版のテスト

```bash
$ brew install --HEAD ./var/homebrew/greet.rb
```

#### 安定版のリリース

1. タグを作成：
```bash
$ git tag -a v0.1.0 -m "Initial stable release"
$ git push origin v0.1.0
```

2. フォーミュラを更新：
```diff
 class Greet < Formula
+  desc "Your CLI tool description"
+  homepage "https://github.com/your-vendor/your-project"
+  url "https://github.com/your-vendor/your-project/archive/refs/tags/v0.1.0.tar.gz"
+  sha256 "..." # 以下のコマンドで取得したハッシュ値を記述
+  version "0.1.0"
-  head "https://github.com/your-vendor/your-project.git", branch: "main"
   
   depends_on "php@8.1"
   depends_on "composer"
 end
```

フォーミュラには必要に応じてデータベースなどの依存関係を追加できます。ただし、データベースのセットアップなどの環境構築は `bin/setup` スクリプトで行うことを推奨します。

3. SHA256ハッシュの取得：
```bash
# GitHubからtarballをダウンロードしてハッシュを計算
$ curl -sL https://github.com/your-vendor/your-project/archive/refs/tags/v0.1.0.tar.gz | shasum -a 256
```

4. Homebrewタップの作成:

GitHub CLIのセットアップが必要です：
- [GitHub CLI のインストール](https://docs.github.com/ja/github-cli/github-cli/about-github-cli)
- [GitHub CLI の認証](https://cli.github.com/manual/gh_auth_login)

```bash
# GitHub CLIで認証
$ gh auth login

# 公開リポジトリ名はhomebrew-で始める必要があります
$ gh repo create your-vendor/homebrew-greet --public --clone
$ cd homebrew-greet
```

5. フォーミュラの配置と公開：
```bash
$ cp /path/to/project/var/homebrew/greet.rb .
$ git add greet.rb
$ git commit -m "Add formula for greet command"
$ git push
```

6. インストールと配布:

エンドユーザーは以下のコマンドだけでツールを使い始めることができます。PHP環境や依存パッケージのインストールは自動的に行われるため、ユーザーが環境構築について心配する必要はありません：

```bash
$ brew tap your-vendor/greet    # homebrew-プレフィックスは省略
$ brew install your-vendor/greet

# すぐに使用可能
$ greet --version
greet version 0.1.0
```

## フォーミュラのカスタマイズ

必要に応じて、`brew edit` コマンドでフォーミュラを編集できます：

```bash
$ brew edit your-vendor/greet
```

```ruby
class Greet < Formula
  desc "Your CLI tool description"
  homepage "https://github.com/your-vendor/your-project"
  url "https://github.com/your-vendor/your-project/archive/refs/tags/v0.1.0.tar.gz"
  sha256 "..." # tgzのSHA256
  version "0.1.0"
  
  depends_on "php@8.1"  # PHPバージョンの指定
  depends_on "composer"

  # アプリケーションが必要とする場合は追加
  # depends_on "mysql"
  # depends_on "redis"
end
```

## バージョン管理

特定のバージョンに固定する場合：

```bash

# バージョンの固定
$ brew pin your-vendor/greet

# 固定解除
$ brew unpin your-vendor/greet
```

## デプロイ

継続的デプロイメントのために、以下のような手順が推奨されます：

1. 開発環境での確認

```bash
$ brew install --HEAD ./var/homebrew/greet.rb
$ greet --version  # バージョン確認
$ greet --help     # ヘルプの確認
```

2. リリースとデプロイ

```bash
# バージョンタグの作成
$ git tag -a v0.1.0 -m "Initial stable release"
$ git push origin v0.1.0

# Homebrewタップの更新
$ cp var/homebrew/greet.rb /path/to/homebrew-tap/Formula/
$ cd /path/to/homebrew-tap
$ git add Formula/greet.rb
$ git commit -m "Release greet v0.1.0"
$ git push origin main
```

3. インストールの確認

```bash
$ brew update
$ brew install your-vendor/greet
$ greet --version  # 新しいバージョンの確認
```

## クリーンアーキテクチャ

BEAR.Cliは、リソース指向アーキテクチャ（ROA）とクリーンアーキテクチャの強みを実証しています。クリーンアーキテクチャが目指す「UIは詳細である」という原則に従い、同じリソースに対してWebインターフェースだけでなく、CLIという新しいアダプターを追加できます。

さらに、BEAR.Cliはコマンドの作成だけでなく、Homebrewによる配布や更新もサポートしています。これにより、エンドユーザーはコマンド一つでツールを使い始めることができ、PHPやBEAR.Sundayの存在を意識することなく、ネイティブなUNIXコマンドのように利用できます。

また、CLIツールはアプリケーションリポジトリから独立してバージョン管理と更新が可能です。これにより、APIの進化に影響されることなく、コマンドラインツールとしての安定性と継続的なアップデートを保つことができます。これは、リソース指向アーキテクチャとクリーンアーキテクチャの組み合わせにより実現した、APIの新しい提供形態です。
