<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>1 Page Manual &#124; BEAR.Sunday</title>
    <meta name="description" content="BEAR.Sunday is a resource orientated framework with a REST centered architecture, implementing Dependency Injection and Aspect Orientated Programming' at its core.">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.css">
    <link rel="stylesheet" href="/css/syntax.css">
    
    <link rel="stylesheet" href="/css/bearsunday.css">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" href="/icon.png">
</head>
<body data-page-category="Manual" data-spy="scroll" data-target="#ArticleToc" data-offset="65">
<header>
    <nav class="navbar navbar-expand flex-column flex-md-row bg-light">
        <a class="navbar-brand mr-0 mr-md-2" href="/index.html"></a>
        <div class="navbar-nav-scroll">
            <ul class="navbar-nav flex-row">
                <li class="nav-item">
                    <a class="nav-link " href="/index.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/manuals/1.0/en/index.html">Manual</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link " href="/contributors.html">Contributors</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/slide.html">Slide</a>
                </li>
            </ul>
        </div>
        
        <ul class="navbar-nav ml-md-auto d-none d-md-flex language-list">
            <li>
                <a class="" href="/manuals/1.0/en/1page.html">En</a>
            </li>
            <li>
                <a class="active" href="/manuals/1.0/ja/1page.html">Ja</a>
            </li>
        </ul>
        
    </nav>
</header>

<main class="container-fluid">
    <div class="row flex-xl-nowrap">
        <div class="col-md-3 col-lg-2">
            <div class="side-bar">
                <nav class="navbar navbar-expand-md navbar-light">
    <div class="navigation-header">
        <div class="ml-auto d-sm-block d-md-none">
            <ul class="navbar-nav language-list">
                <li>
                    <a class="" href="/manuals/1.0/en/1page.html">En</a>
                </li>
                <li>
                    <a class="active" href="/manuals/1.0/ja/1page.html">Ja</a>
                </li>
            </ul>
            <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#Navber" aria-controls="Navber" aria-expanded="false" aria-label="ナビゲーションの切替">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </div>
    <div class="collapse navbar-collapse" id="Navber">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/index.html">イントロダクション</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/version.html">バージョン</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/quick-start.html">クイックスタート</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/tutorial.html">チュートリアル</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/tutorial2.html">チュートリアル 2</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/package.html">パッケージ</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/application.html">アプリケーション</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/module.html">モジュール</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/di.html">DI</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/aop.html">AOP</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/resource.html">リソース</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/resource_param.html">・パラメーター</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/resource_link.html">・リンク</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/resource_renderer.html">・レンダリングと転送</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/router.html">ルーター</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/production.html">プロダクション</a>
            </li>
            <li>
                <a class="nav-link " href="/manuals/1.0/ja/import.html">インポート</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/database.html">データベース</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/html.html">HTML</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/validation.html">バリデーション</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/form.html">フォーム</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/content-negotiation.html">コンテントネゴシエーション</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/hypermedia-api.html">ハイパーメディア API</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/psr7.html">リクエスト / PSR-7</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/js-ui.html">JavaScript UI</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/stream.html">ストリーム出力</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/cache.html">キャッシュ</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/swoole.html">Swoole</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/coding-guide.html">コーディングガイド</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/types.html">タイプ</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/test.html">テスト</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/examples.html">サンプル</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/upgrade/injector.html">アップグレード</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/attribute.html">アトリビュート</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/manuals/1.0/ja/apidoc.html">API Doc</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/manuals/1.0/ja/1page.html">1 Page</a>
            </li>
        </ul>
    </div>
</nav>

            </div>
        </div>
        <div class="col-md-9 col-lg-8">
            <article id="article" class="markdown-body">
                <p>これはBEAR.Sundayの全てのマニュアルを1つに集めたページです。</p>

<h2 id="aaas-application-as-a-service">AaaS (Application as a Service)</h2>

<p>作成したAPIアプリケーションはWebやコンソール（バッチ）からアクセスできますが、他のPHPプロジェクトからライブラリとしてアクセスする事もできます。
このチュートリアルで作成したリポジトリは<a href="https://github.com/bearsunday/Tutorial2.git">https://github.com/bearsunday/Tutorial2.git</a>にpushしてあります。</p>

<p>このプロジェクトをライブラリとして利用してみましょう。まず最初に新しいプロジェクトフォルダを作って<code class="language-plaintext highlighter-rouge">composer.json</code>を用意します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir app
cd app
mkdir -p ticket/log
mkdir ticket/tmp
</code></pre></div></div>

<p>composer.json</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-vendor/app"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A BEAR.Sunday application"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"project"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"license"</span><span class="p">:</span><span class="w"> </span><span class="s2">"proprietary"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"require"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"my-vendor/ticket"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dev-master"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"repositories"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vcs"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://github.com/bearsunday/Tutorial2.git"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>composer installでプロジェクトがライブラリとしてインストールされます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer install
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Ticket API</code>はプロジェクトフォルダにある<code class="language-plaintext highlighter-rouge">.env</code>を読むように設定されてました。<code class="language-plaintext highlighter-rouge">vendor/my-vendor/app/.env</code>に保存出来なくもないですが、ここでは別の方法で環境変数をセットアップしましょう。</p>

<p>このような<code class="language-plaintext highlighter-rouge">app/.env</code>ファイルを用意します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">TKT_DB_HOST</span><span class="o">=</span>localhost
<span class="nb">export </span><span class="nv">TKT_DB_NAME</span><span class="o">=</span>ticket
<span class="nb">export </span><span class="nv">TKT_DB_USER</span><span class="o">=</span>root
<span class="nb">export </span><span class="nv">TKT_DB_PASS</span><span class="o">=</span><span class="s1">''</span>
<span class="nb">export </span><span class="nv">TKT_DB_SLAVE</span><span class="o">=</span><span class="s1">''</span>
<span class="nb">export </span><span class="nv">TKT_DB_DSN</span><span class="o">=</span>mysql:host<span class="o">=</span><span class="k">${</span><span class="nv">TKT_DB_HOST</span><span class="k">}</span><span class="se">\;</span><span class="nv">dbname</span><span class="o">=</span><span class="k">${</span><span class="nv">TKT_DB_NAME</span><span class="k">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">source</code>コマンドで環境変数にexportすることができます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>source .env
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Ticket API</code>を他のプロジェクトから利用する最も簡単なスクリプトは以下のようなものです。
アプリケーション名とコンテキストを指定してアプリケーションオブジェクト<code class="language-plaintext highlighter-rouge">$ticket</code>を取得してリソースアクセスします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\Bootstrap</span><span class="p">;</span>

<span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/vendor/autoload.php'</span><span class="p">;</span>

<span class="nv">$ticket</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nc">Bootstrap</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getApp</span><span class="p">(</span><span class="s1">'MyVendor\Ticket'</span><span class="p">,</span> <span class="s1">'app'</span><span class="p">);</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nv">$ticket</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="s1">'app://self/ticket'</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'run'</span><span class="p">]</span>
<span class="p">);</span>

<span class="k">echo</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="n">code</span> <span class="mf">.</span> <span class="kc">PHP_EOL</span><span class="p">;</span>


</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">index.php</code>と保存して実行してみましょう。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php index.php
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>201
</code></pre></div></div>

<p>APIを他のメソッドに渡したり、他のフレームワークなどののコンテナに格納するためには<code class="language-plaintext highlighter-rouge">callable</code>オブジェクトにします。
<code class="language-plaintext highlighter-rouge">$createTicket</code>は普通の関数のように扱うことができます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\Bootstrap</span><span class="p">;</span>

<span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/vendor/autoload.php'</span><span class="p">;</span>

<span class="nv">$ticket</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nc">Bootstrap</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getApp</span><span class="p">(</span><span class="s1">'MyVendor\Ticket'</span><span class="p">,</span> <span class="s1">'app'</span><span class="p">);</span>
<span class="nv">$createTicket</span> <span class="o">=</span> <span class="nv">$ticket</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">post</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/ticket'</span><span class="p">);</span>
<span class="c1">// invoke callable object</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nv">$createTicket</span><span class="p">([</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'run'</span><span class="p">]);</span>
<span class="k">echo</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="n">code</span> <span class="mf">.</span> <span class="kc">PHP_EOL</span><span class="p">;</span>
</code></pre></div></div>

<p>うまく動きましたか？しかし、このままでは<code class="language-plaintext highlighter-rouge">tmp</code>/ <code class="language-plaintext highlighter-rouge">log</code>ディレクトリは<code class="language-plaintext highlighter-rouge">vendor</code>の下のアプリが使われてしまいますね。
このようにアプリケーションのメタ情報を変更するとディレクトリの位置を変更することができます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">use</span> <span class="nc">BEAR\AppMeta\Meta</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\Bootstrap</span><span class="p">;</span>

<span class="k">require</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/vendor/autoload.php'</span><span class="p">;</span>

<span class="nv">$meta</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Meta</span><span class="p">(</span><span class="s1">'MyVendor\Ticket'</span><span class="p">,</span> <span class="s1">'app'</span><span class="p">);</span>
<span class="nv">$meta</span><span class="o">-&gt;</span><span class="n">tmpDir</span> <span class="o">=</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/ticket/tmp'</span><span class="p">;</span>
<span class="nv">$meta</span><span class="o">-&gt;</span><span class="n">logDir</span> <span class="o">=</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/ticket/log'</span><span class="p">;</span>
<span class="nv">$ticket</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nc">Bootstrap</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">newApp</span><span class="p">(</span><span class="nv">$meta</span><span class="p">,</span> <span class="s1">'app'</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Ticket API</code>はREST APIとしてHTTPやコンソールからアクセスできるだけでなく、BEAR.Sundayではない他のプロジェクトのライブラリとしても使えるようになりました！</p>

<hr />

<h1 id="from-tutorial1">from tutorial1</h1>

<h2 id="アプリケーションのインポート">アプリケーションのインポート</h2>

<p>BEAR.Sundayで作られたリソースは再利用性に優れています。複数のアプリケーションを同時に動作させ、他のアプリケーションのリソースを利用することができます。別々のWebサーバーを立てる必要はありません。</p>

<p>他のアプリケーションのリソースを利用して見ましょう。</p>

<p>通常はアプリケーションをパッケージとして利用しますが、ここではチュートリアルのために<code class="language-plaintext highlighter-rouge">my-vendor</code>に新規でアプリケーションを作成して手動でオートローダーを設定します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>my-vendor
<span class="nb">cd </span>my-vendor
composer create-project bear/skeleton Acme.Blog
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">composer.json</code>で<code class="language-plaintext highlighter-rouge">autoload</code>のセクションに<code class="language-plaintext highlighter-rouge">Acme\\Blog</code>を追加します。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"autoload"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"psr-4"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"MyVendor\\Weekday\\"</span><span class="p">:</span><span class="w"> </span><span class="s2">"src/"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Acme\\Blog\\"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my-vendor/Acme.Blog/src/"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">autoload</code>をダンプします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer dump-autoload
</code></pre></div></div>

<p>これで<code class="language-plaintext highlighter-rouge">Acme\Blog</code>アプリケーションが配置できました。</p>

<p>次にアプリケーションをインポートするために<code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code>で<code class="language-plaintext highlighter-rouge">ImportAppModule</code>を上書き(override)インストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">// ...</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Module\ImportAppModule</span><span class="p">;</span> <span class="c1">// add this line</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ImportApp</span><span class="p">;</span> <span class="c1">// add this line</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\Context</span><span class="p">;</span> <span class="c1">// add this line</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$importConfig</span> <span class="o">=</span> <span class="p">[</span>
            <span class="k">new</span> <span class="nc">ImportApp</span><span class="p">(</span><span class="s1">'blog'</span><span class="p">,</span> <span class="s1">'Acme\Blog'</span><span class="p">,</span> <span class="s1">'prod-hal-app'</span><span class="p">)</span> <span class="c1">// host, name, context</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">override</span><span class="p">(</span><span class="k">new</span> <span class="nc">ImportAppModule</span><span class="p">(</span><span class="nv">$importConfig</span> <span class="p">,</span> <span class="nc">Context</span><span class="o">::</span><span class="n">class</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>これは<code class="language-plaintext highlighter-rouge">Acme\Blog</code>アプリケーションを<code class="language-plaintext highlighter-rouge">prod-hal-app</code>コンテキストで作成したリソースを<code class="language-plaintext highlighter-rouge">blog</code>というホストで使用することができます。</p>

<p><code class="language-plaintext highlighter-rouge">src/Resource/App/Import.php</code>にImportリソースを作成して確かめてみましょう。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Sunday\Inject\ResourceInject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Import</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">ResourceInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span><span class="p">[</span>
            <span class="s1">'blog'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'page://blog/index'</span><span class="p">)[</span><span class="s1">'greeting'</span><span class="p">]</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">page://blog/index</code>リソースの<code class="language-plaintext highlighter-rouge">greeting</code>が<code class="language-plaintext highlighter-rouge">blog</code>に代入されているはずです。<code class="language-plaintext highlighter-rouge">@Embed</code>も同様に使えます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php get /import
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
content-type: application/hal+json

<span class="o">{</span>
    <span class="s2">"blog"</span>: <span class="s2">"Hello BEAR.Sunday"</span>,
    <span class="s2">"_links"</span>: <span class="o">{</span>
        <span class="s2">"self"</span>: <span class="o">{</span>
            <span class="s2">"href"</span>: <span class="s2">"/import"</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>他のアプリケーションのリソースを利用することができました！データ取得をHTTP越しにする必要もありません。</p>

<p>合成されたアプリケーションも他からみたら１つのアプリケーションの１つのレイヤーです。
<a href="http://en.wikipedia.org/wiki/Representational_state_transfer#Layered_system">レイヤードシステム</a>はRESTの特徴の１つです。</p>

<p>それでは最後に作成したアプリケーションのリソースを呼び出す最小限のスクリプトをコーディングして見ましょう。<code class="language-plaintext highlighter-rouge">bin/test.php</code>を作成します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Package\Bootstrap</span><span class="p">;</span>

<span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/autoload.php'</span><span class="p">;</span>

<span class="nv">$api</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nc">Bootstrap</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getApp</span><span class="p">(</span><span class="s1">'MyVendor\Weekday'</span><span class="p">,</span> <span class="s1">'prod-hal-app'</span><span class="p">);</span>

<span class="nv">$blog</span> <span class="o">=</span> <span class="nv">$api</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/import'</span><span class="p">)[</span><span class="s1">'blog'</span><span class="p">];</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$blog</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">MyVendor\Weekday</code>アプリを<code class="language-plaintext highlighter-rouge">prod-hal-app</code>で起動して<code class="language-plaintext highlighter-rouge">app://self/import</code>リソースの<code class="language-plaintext highlighter-rouge">blog</code>をvar_dumpするコードです。</p>

<p>試して見ましょう。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/import.php
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>string(17) "Hello BEAR.Sunday"
</code></pre></div></div>

<p>他にも</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$weekday</span> <span class="o">=</span> <span class="nv">$api</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/weekday'</span><span class="p">)([</span><span class="s1">'year'</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">'month'</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'day'</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">]);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$weekday</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">);</span> <span class="c1">// as array</span>
<span class="c1">//array(1) {</span>
<span class="c1">//    ["weekday"]=&gt;</span>
<span class="c1">//  string(3) "Sat"</span>
<span class="c1">//}</span>

<span class="k">echo</span> <span class="nv">$weekday</span><span class="p">;</span> <span class="c1">// as string</span>
<span class="c1">//{</span>
<span class="c1">//    "weekday": "Sat",</span>
<span class="c1">//    "_links": {</span>
<span class="c1">//    "self": {</span>
<span class="c1">//        "href": "/weekday/2000/1/1"</span>
<span class="c1">//        }</span>
<span class="c1">//    }</span>
<span class="c1">//}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$html</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nc">Bootstrap</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getApp</span><span class="p">(</span><span class="s1">'MyVendor\Weekday'</span><span class="p">,</span> <span class="s1">'prod-html-app'</span><span class="p">);</span>
<span class="nv">$index</span> <span class="o">=</span> <span class="nv">$html</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'page://self/index'</span><span class="p">)([</span><span class="s1">'year'</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">'month'</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'day'</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">]);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$index</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
<span class="c1">//int(200)</span>

<span class="k">echo</span> <span class="nv">$index</span><span class="p">;</span>
<span class="c1">//&lt;!DOCTYPE html&gt;</span>
<span class="c1">//&lt;html&gt;</span>
<span class="c1">//&lt;body&gt;</span>
<span class="c1">//The weekday of 2000/1/1 is Sat.</span>
<span class="c1">//&lt;/body&gt;</span>
<span class="c1">//&lt;/html&gt;</span>
</code></pre></div></div>

<p>ステートレスなリクエストでレスポンスが返ってくるRESTのリソースはPHPの関数のようなものです。<code class="language-plaintext highlighter-rouge">body</code>で値を取得したり<code class="language-plaintext highlighter-rouge">(string)</code>でJSONやHTMLなどの表現にすることができます。autoloadの部分を除けば二行、連結すればたった一行のスクリプトで  アプリケーションのどのリソースでも操作することができます。</p>

<p>このようにBEAR.Sundayで作られたリソースは他のCMSやフレームワークからも簡単に利用することができます。複数のアプリケーションの値を一度に扱うことができます。</p>

<h1 id="aop">AOP</h1>

<p>アスペクト指向プログラミングは、<strong>横断的関心事</strong>の問題を解決します。対象メソッドの前後に任意の処理をインターセプターで織り込むことができます。
対象となるメソッドはビジネスロジックなど本質的関心事のみに関心を払い、インターセプターはログや検証などの横断的関心事に関心を払います。</p>

<p>BEAR.Sundayは<a href="http://aopalliance.sourceforge.net/">AOP Alliance</a>に準拠したアスペクト指向プログラミングをサポートします。</p>

<h2 id="インターセプター">インターセプター</h2>

<p>インターセプターの<code class="language-plaintext highlighter-rouge">invoke</code>メソッドで<code class="language-plaintext highlighter-rouge">$invocation</code>メソッド実行変数を受け取り、メソッドの前後に処理を加えます。
この変数は、インターセプター元メソッドを実行するためだけの変数です。前後にログやトランザクションなどの横断的処理を記述します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Aop\MethodInterceptor</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Aop\MethodInvocation</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyInterceptor</span> <span class="kd">implements</span> <span class="nc">MethodInterceptor</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">invoke</span><span class="p">(</span><span class="kt">MethodInvocation</span> <span class="nv">$invocation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// メソッド実行前の処理</span>
        <span class="c1">// ...</span>

        <span class="c1">// メソッド実行</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="nf">proceed</span><span class="p">();</span>

        <span class="c1">// メソッド実行後の処理</span>
        <span class="c1">// ...</span>

        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="束縛">束縛</h2>

<p><a href="module.html">モジュール</a>で対象となるクラスとメソッドを<code class="language-plaintext highlighter-rouge">Matcher</code>で”検索”して、マッチするメソッドにインターセプターを束縛します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bindInterceptor</span><span class="p">(</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">any</span><span class="p">(),</span>                   <span class="c1">// どのクラスでも</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">startsWith</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">),</span>    <span class="c1">// "delete"で始まるメソッド名のメソッドには</span>
    <span class="p">[</span><span class="nc">Logger</span><span class="o">::</span><span class="n">class</span><span class="p">]</span>                          <span class="c1">// Loggerインターセプターを束縛</span>
<span class="p">);</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bindInterceptor</span><span class="p">(</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">subclassesOf</span><span class="p">(</span><span class="nc">AdminPage</span><span class="o">::</span><span class="n">class</span><span class="p">),</span>  <span class="c1">// AdminPageの継承または実装クラスの</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">Auth</span><span class="o">::</span><span class="n">class</span><span class="p">),</span>      <span class="c1">// @Authアノテーションがアノテートされているメソッドには</span>
    <span class="p">[</span><span class="nc">AdminAuthentication</span><span class="o">::</span><span class="n">class</span><span class="p">]</span>                     <span class="c1">// AdminAuthenticationインターセプターを束縛</span>
<span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Matcher</code>は他にこのような指定もできます。</p>

<ul>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L16">Matcher::any</a> - 無制限</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L23">Matcher::annotatedWith</a> - アノテーション</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L30">Matcher::subclassesOf</a> - 継承または実装されたクラス</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L37">Matcher::startsWith</a> - 名前の始めの文字列</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L44">Matcher::logicalOr</a> - OR条件</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L51">Matcher::logicalAnd</a> - AND条件</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/develop-2/src/MatcherInterface.php#L58">Matcher::logicalNot</a> - NOT条件
```</li>
</ul>

<p>インターセプターに渡される<code class="language-plaintext highlighter-rouge">MethodInvocation</code>で対象のメソッド実行に関連するオブジェクトやメソッド、引数にアクセスすることができます。</p>

<ul>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/2.x/src/Joinpoint.php">MethodInvocation::proceed</a> - 対象メソッド実行</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/2.x/src/MethodInvocation.php">MethodInvocation::getMethod</a> -  対象メソッドリフレクションの取得</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/2.x/src/Joinpoint.php">MethodInvocation::getThis</a> - 対象オブジェクトの取得</li>
  <li><a href="https://github.com/ray-di/Ray.Aop/blob/2.x/src/Invocation.php">MethodInvocation::getArguments</a> - 呼び出し引数配列の取得</li>
</ul>

<p>リフレクションのメソッドでアノテーションを取得することができます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$method</span> <span class="o">=</span> <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="nf">getMethod</span><span class="p">();</span>
<span class="nv">$class</span> <span class="o">=</span> <span class="nv">$invocation</span><span class="o">-&gt;</span><span class="nf">getMethod</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getDeclaringClass</span><span class="p">();</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">$method-&gt;getAnnotations()</code>     - メソッドアノテーションの取得</li>
  <li><code class="language-plaintext highlighter-rouge">$method-&gt;getAnnotation($name)</code></li>
  <li><code class="language-plaintext highlighter-rouge">$class-&gt;getAnnotations()</code>    - クラスアノテーションの取得</li>
  <li><code class="language-plaintext highlighter-rouge">$class-&gt;getAnnotation($name)</code></li>
</ul>

<h2 id="カスタムマッチャー">カスタムマッチャー</h2>

<p>独自のカスタムマッチャーを作成するためには<code class="language-plaintext highlighter-rouge">AbstractMatcher</code>の<code class="language-plaintext highlighter-rouge">matchesClass</code>と<code class="language-plaintext highlighter-rouge">matchesMethod</code>を実装したクラスを作成します。</p>

<p><code class="language-plaintext highlighter-rouge">contains</code> マッチャーを作成するためには、２つのメソッドを持つクラスを提供する必要があります。
１つはクラスのマッチを行う<code class="language-plaintext highlighter-rouge">matchesClass</code>メソッド、もう１つはメソッドのマッチを行う<code class="language-plaintext highlighter-rouge">matchesMethod</code>メソッドです。いずれもマッチしたかどうかをboolで返します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Aop\AbstractMatcher</span><span class="p">;</span>

<span class="cd">/**
 * 特定の文字列が含まれているか
 */</span>
<span class="kd">class</span> <span class="nc">ContainsMatcher</span> <span class="kd">extends</span> <span class="nc">AbstractMatcher</span>
<span class="p">{</span>
    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">matchesClass</span><span class="p">(</span><span class="err">\</span><span class="nc">ReflectionClass</span> <span class="nv">$class</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$arguments</span><span class="p">)</span> <span class="o">:</span> <span class="n">bool</span>
    <span class="p">{</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$contains</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$arguments</span><span class="p">;</span>

        <span class="k">return</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$class</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="nv">$contains</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">matchesMethod</span><span class="p">(</span><span class="err">\</span><span class="nc">ReflectionMethod</span> <span class="nv">$method</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$arguments</span><span class="p">)</span> <span class="o">:</span> <span class="n">bool</span>
    <span class="p">{</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$contains</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$arguments</span><span class="p">;</span>

        <span class="k">return</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$method</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="nv">$contains</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>モジュール</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bindInterceptor</span><span class="p">(</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">any</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nc">ContainsMatcher</span><span class="p">(</span><span class="s1">'user'</span><span class="p">),</span> <span class="c1">// 'user'がメソッド名に含まれてるか</span>
            <span class="p">[</span><span class="nc">UserLogger</span><span class="o">::</span><span class="n">class</span><span class="p">]</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<p><a href="http://qiita.com/koriym/items/1caf2a2a13f497755c88">BEAR.SundayでRESTful Web API</a>に移動しました。</p>

<h1 id="api-doc">API Doc</h1>

<p>BEAR.ApiDocは、アプリケーションからAPIドキュメントを生成します。</p>

<p>コードとJSONスキーマから自動生成されるドキュメントは、手間を減らし正確なAPIドキュメントを維持し続けることができます。</p>

<h2 id="利用方法">利用方法</h2>

<p>BEAR.ApiDocをインストールします。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require bear/api-doc --dev
</code></pre></div></div>

<p>設定ファイルをコピーします。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp ./vendor/bear/api-doc/apidoc.xml.dist ./apidoc.xml
</code></pre></div></div>

<h2 id="ソース">ソース</h2>

<p>BEAR.ApiDocはphpdoc、メソッドシグネチャ、JSONスキーマから情報を取得してドキュメントを生成します。</p>

<h4 id="phpdoc">PHPDOC</h4>

<p>phpdocでは以下の部分が取得されます。
認証などリソースに横断的に適用される情報は別のドキュメントページを用意して<code class="language-plaintext highlighter-rouge">@link</code>でリンクします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * {title}
 *
 * {description}
 *
 * {@link htttp;//example.com/docs/auth 認証}
 */</span>
 <span class="kd">class</span> <span class="nc">Foo</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
 <span class="p">{</span>
 <span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * {title}
 *
 * {description}
 *
 * @param string $id ユーザーID
 */</span>
 <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span> <span class="o">=</span><span class="s1">'kuma'</span><span class="p">):</span> <span class="kt">static</span>
 <span class="p">{</span>
 <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>メソッドのphpdocに<code class="language-plaintext highlighter-rouge">@param</code>記述が無い場合、メソッドシグネチャーから引数の情報を取得します。</li>
  <li>情報取得の優先順はphpdoc、JSONスキーマ、プロファイルの順です。</li>
</ul>

<h2 id="設定ファイル">設定ファイル</h2>

<p>設定はXMLで記述されます。
最低限の指定は以下の通りです。</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;apidoc</span>
        <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
        <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"https://bearsunday.github.io/BEAR.ApiDoc/apidoc.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;appName&gt;</span>MyVendor\MyProject<span class="nt">&lt;/appName&gt;</span>
    <span class="nt">&lt;scheme&gt;</span>app<span class="nt">&lt;/scheme&gt;</span>
    <span class="nt">&lt;docDir&gt;</span>docs<span class="nt">&lt;/docDir&gt;</span>
    <span class="nt">&lt;format&gt;</span>html<span class="nt">&lt;/format&gt;</span>
<span class="nt">&lt;/apidoc&gt;</span>
</code></pre></div></div>

<h3 id="必須属性">必須属性</h3>

<h4 id="appname">appName</h4>

<p>アプリケーションの名前空間</p>

<h4 id="scheme">scheme</h4>

<p>APIドキュメントにするスキーマ名。<code class="language-plaintext highlighter-rouge">page</code>または<code class="language-plaintext highlighter-rouge">app</code></p>

<h4 id="docdir">docDir</h4>

<p>出力ディレクトリ名</p>

<h4 id="format">format</h4>

<p>出力フォーマット。HTMLまたはMD(Mark down</p>

<h3 id="オプション属性">オプション属性</h3>

<h4 id="title">title</h4>

<p>APIタイトル</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;title&gt;</span>MyBlog API<span class="nt">&lt;/title&gt;</span>
</code></pre></div></div>

<h4 id="description">description</h4>

<p>APIディスクリプション</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;description&gt;</span>MyBlog API description<span class="nt">&lt;/description&gt;</span>
</code></pre></div></div>

<h4 id="links">links</h4>

<p>リンク。<code class="language-plaintext highlighter-rouge">href</code>でリンク先URL、<code class="language-plaintext highlighter-rouge">rel</code>でその内容を表します。</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;links&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"https://www.example.com/issue"</span> <span class="na">rel=</span><span class="s">"issue"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"https://www.example.com/help"</span> <span class="na">rel=</span><span class="s">"help"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/links&gt;</span>
</code></pre></div></div>

<h4 id="alps">alps</h4>

<p>APIで使われる語句を定義する”ALPSプロファイル”を指定します。</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;alps&gt;</span>alps/profile.json<span class="nt">&lt;/alps&gt;</span>
</code></pre></div></div>

<h2 id="プロファイル">プロファイル</h2>

<p>BEAR.ApiDocはアプリケーションに追加情報を与える<a href="https://tools.ietf.org/html/rfc6906">RFC 6906 プロファイル</a>の<a href="http://alps.io/">ALPS</a>フォーマットをサポートします。</p>

<p>APIのリクエストやレスポンスのキーで使う語句をセマンティックディスクリプタ（意味的記述子）と呼びますが、プロファイルそのの辞書を作っておけばリクエスト毎に語句を説明する必要がなくなります。
語句の定義が集中することで表記揺れを防ぎ、理解共有を助けます。</p>

<p>以下は<code class="language-plaintext highlighter-rouge">firstName</code>,<code class="language-plaintext highlighter-rouge">familyName</code>というディスクリプタをそれぞれ<code class="language-plaintext highlighter-rouge">title</code>、<code class="language-plaintext highlighter-rouge">def</code>で定義した例です。
<code class="language-plaintext highlighter-rouge">title</code>は言葉を記述して意味を明らかにしますが、<code class="language-plaintext highlighter-rouge">def</code>は<a href="https://schema.org/">Schema.org</a> などのボキャブラリサイトで定義されたスタンダードな語句をリンクします。</p>

<p>ALPSプロファイルはXMLまたはJSONで記述します。</p>

<p>profile.xml</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;alps</span>
     <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
     <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"https://alps-io.github.io/schemas/alps.xsd"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- Ontology --&gt;</span>
    <span class="nt">&lt;descriptor</span> <span class="na">id=</span><span class="s">"firstName"</span> <span class="na">title=</span><span class="s">"The person's first name."</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;descriptor</span> <span class="na">id=</span><span class="s">"familyName"</span> <span class="na">def=</span><span class="s">"https://schema.org/familyName"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/alps&gt;</span>
</code></pre></div></div>

<p>profile.json</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "$schema": "https://alps-io.github.io/schemas/alps.json",
  "alps": {
    "descriptor": [
      {"id": "firstName", "title": "The person's first name."},
      {"id": "familyName", "def": "https://schema.org/familyName"},
    ]
  }
}
</code></pre></div></div>

<p>ApiDocに登場する語句の説明はphpdoc &gt; JsonSchema &gt; ALPSの順で優先します。</p>

<h2 id="リンク">リンク</h2>

<ul>
  <li><a href="https://bearsunday.github.io/BEAR.ApiDoc/">Demo</a></li>
  <li><a href="http://alps.io/">ALPS</a></li>
  <li><a href="https://github.com/koriym/app-state-diagram">ALPS-ASD</a></li>
  <li><a href="https://qiita.com/koriym/items/2e928efb2167d559052e">メディアタイプとALPSプロファイル</a></li>
</ul>

<h1 id="アプリケーション">アプリケーション</h1>

<h2 id="実行シーケンス">実行シーケンス</h2>
<p>コンパイル、リクエスト、レスポンスの順でアプリケーションが実行されます。</p>

<h3 id="0-コンパイル">0. コンパイル</h3>

<p>コンテキストに応じたDIとAOPの設定で、アプリケーションの実行に必要なルートオブジェクト<code class="language-plaintext highlighter-rouge">$app</code>を生成します。$appは<code class="language-plaintext highlighter-rouge">router</code>や<code class="language-plaintext highlighter-rouge">transfer</code>などアプリケーションの実行に必要なサービスオブジェクトで構成されます。<sup id="fnref:graph" role="doc-noteref"><a href="#fn:graph" class="footnote" rel="footnote">1</a></sup> $appはシリアライズされ各リクエストで再利用されます。</p>

<ul>
  <li>router - 外部入力をリソースリクエストに変換</li>
  <li>resource - リソースクライアント</li>
  <li>transfer - 出力</li>
</ul>

<h3 id="1-リクエスト">1. リクエスト</h3>

<p>リクエストに基づき、リソースオブジェクトが作成されます。</p>

<p>リクエストに応じて <code class="language-plaintext highlighter-rouge">onGet</code> や <code class="language-plaintext highlighter-rouge">onPost</code> などに応答するメソッドを持つリソースオブジェクトは、自身の<strong>リソースの状態</strong>として <code class="language-plaintext highlighter-rouge">code</code> または <code class="language-plaintext highlighter-rouge">body</code> プロパティを設定します。</p>

<p>リソースオブジェクトのメソッドは、リソースの状態を変更するためだけのものであり、表現そのもの（HTML、JSONなど）には関心がありません。</p>

<p>メソッドの前後では、ログや認証などメソッドに束縛されたアプリケーションロジックがAOPで実行されます。</p>

<h3 id="2-レスポンス">2. レスポンス</h3>

<p>リソースに注入されたレンダラーがJSONやHTMLなどの<strong>リソースの状態表現</strong>を作りクライアントに<strong>転送</strong>します。
(<strong>RE</strong>presentational <strong>S</strong>tate <strong>T</strong>ransfer=REST)</p>

<p><img src="/images/screen/diagram.png" style="max-width: 100%;height: auto;" /></p>

<h2 id="bootスクリプト">bootスクリプト</h2>

<p><code class="language-plaintext highlighter-rouge">public/</code>や<code class="language-plaintext highlighter-rouge">bin/</code>等のエントリーポイントに設置され、アプリケーションを実行します。
スクリプトではアプリケーション実行コンテキストを指定して実行します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/autoload.php'</span><span class="p">;</span>
<span class="k">exit</span><span class="p">((</span><span class="k">new</span> <span class="nc">Bootstrap</span><span class="p">())(</span><span class="s1">'app'</span><span class="p">,</span> <span class="nv">$GLOBALS</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">));</span>
</code></pre></div></div>

<p>デフォルトではWebサーバースクリプトです。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php <span class="nt">-S</span> 127.0.0.1:8080 public/index.php
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">cli</code> コンテキストを付加するとコンソールアプリーケーションのスクリプトになります。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">exit</span><span class="p">((</span><span class="k">new</span> <span class="nc">Bootstrap</span><span class="p">())(</span><span class="s1">'cli-app'</span><span class="p">,</span> <span class="nv">$GLOBALS</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">));</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php get /user/1
</code></pre></div></div>

<h2 id="コンテキスト">コンテキスト</h2>

<p>コンテキストは特定の目的のためのDIとAOPの束縛のセットです。コードは同じでも束縛が変わることで、アプリケーションが違う振る舞いをします。
コンテキストはフレームワークが用意しているbuilt-inコンテキストとアプリケーションが作成するカスタムコンテキストがあります。</p>

<h3 id="built-inコンテキスト">built-inコンテキスト</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">app</code> ベースアプリケーション</li>
  <li><code class="language-plaintext highlighter-rouge">api</code> APIアプリケーション</li>
  <li><code class="language-plaintext highlighter-rouge">cli</code> コンソールアプリケーション</li>
  <li><code class="language-plaintext highlighter-rouge">hal</code> HALアプリケーション</li>
  <li><code class="language-plaintext highlighter-rouge">prod</code> プロダクション</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">app</code>の場合、リソースはJSONでレンダリングされます。
<code class="language-plaintext highlighter-rouge">api</code>はデフォルトのリソースのスキーマをpageからappに変更します。webのルートアクセス(GET /)はpage://self/からapp://self/へのアクセスになります。
<code class="language-plaintext highlighter-rouge">cli</code>にするとコンソールアプリケーションになります。
<code class="language-plaintext highlighter-rouge">prod</code>はキャッシュの設定などをプロダクション用にします。</p>

<p>コンテキスト名はそれぞれのモジュールに対応します。例えばappはAppModule, cliはCliModuleに対応します。
コンテキストは組み合わせて使う事ができます。例えば<code class="language-plaintext highlighter-rouge">prod-hal-api-app</code>ならプロダクション用HALのAPIアプリケーションなどになります。</p>

<h3 id="カスタムコンテキスト">カスタムコンテキスト</h3>

<p>アプリケーションの<code class="language-plaintext highlighter-rouge">src/Module</code>/に設置します。built-inコンテキストと同名にするとカスタムコンテキストが優先されます。カスタムコンテキストからbuilt-inコンテキストを呼び出すことで一部の束縛を上書きする事ができます。</p>

<h3 id="コンテキスト無知">コンテキスト無知</h3>

<p>コンテキストの値はルートオブジェクトの作成のみに使われその後に消滅します。アプリケーションから参照可能なグローバルな”モード”は存在せず、アプリケーションは現在実行されているコンテキストを知ることはできません。外部の値を参照して振る舞いを変えるのではなく、<strong>インターフェイスのみに依存</strong><sup id="fnref:dip" role="doc-noteref"><a href="#fn:dip" class="footnote" rel="footnote">2</a></sup>し<strong>コンテキストによる束縛の変更</strong>で振る舞いを変更します。</p>

<hr />

<h1 id="アトリビュート">アトリビュート</h1>

<p>BEAR.SundayはBEAR.Package<code class="language-plaintext highlighter-rouge">^1.10.3</code>から従来のアノテーションに加えて、PHP8の<a href="https://www.php.net/manual/ja/language.attributes.overview.php">アトリビュート</a>をサポートします。</p>

<p><strong>アノテーション</strong></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @Inject
 * @Named('admin')
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">setLogger</span><span class="p">(</span><span class="kt">LoggerInterface</span> <span class="nv">$logger</span><span class="p">)</span>
</code></pre></div></div>
<p><strong>アトリビュート</strong></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[Inject, Named('admin')]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">setLogger</span><span class="p">(</span><span class="kt">LoggerInterface</span> <span class="nv">$logger</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[Embed(rel: 'weather', src: 'app://self/weather{?date}')]</span>
<span class="c1">#[Link(rel: 'event', href: 'app://self/event{?news_date}')]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$date</span><span class="p">):</span> <span class="kt">self</span>
</code></pre></div></div>

<h2 id="引数に適用">引数に適用</h2>

<p>アノテーションはメソッドにしか適用できず引数名を名前で指定する必要があるものがありましたが、
PHP8では直接、引数のアトリビュートで指定することができます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="kt">__construct</span><span class="p">(</span><span class="c1">#[Named('payment')] LoggerInterface $paymentLogger, #[Named('debug')] LoggerInterface $debugLogger)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="c1">#[Assisted] DbInterface $db = null)</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="c1">#[CookieParam('id')]string $tokenId): void</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="c1">#[ResourceParam(uri: 'app://self/login#nickname')] string $nickname = null): static</span>
</code></pre></div></div>
<h2 id="互換性">互換性</h2>

<p>アトリビュートとアノテーションは１つのプロジェクトに混在する事もできます。<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">3</a></sup>
このマニュアルに表記されている全てのアノテーションはアトリビュートに変更しても動作します。</p>

<h2 id="パフォーマンス">パフォーマンス</h2>

<p>最適化されるため、プロダクション用にアノテーション/アトリビュート読み込みコストがかかることはほとんどありませんが 以下のようにアトリビュートリーダーしか使用しないと宣言すると開発時の速度が向上します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// tests/bootstap.php </span>

<span class="kn">use</span> <span class="nc">Ray\ServiceLocator\ServiceLocator</span><span class="p">;</span>

<span class="nc">ServiceLocator</span><span class="o">::</span><span class="nf">setReader</span><span class="p">(</span><span class="k">new</span> <span class="nc">AttributeReader</span><span class="p">());</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// DevModule</span>
 
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AttributeModule</span><span class="p">());</span>
</code></pre></div></div>

<hr />

<h1 id="cache">Cache</h1>

<blockquote>
  <p>There are only two hard things in Computer Science: cache invalidation and naming things.</p>

  <p>– Phil Karlton</p>
</blockquote>

<h2 id="概要">概要</h2>

<p>優れたキャッシュシステムはユーザー体験の本質的な質を向上させ、資源利用コストと環境負荷を下げます。
BEAR.Sundayは従来のTTLによる単純なキャッシュに加えて、以下のキャッシュ機能をサポートします。</p>

<ul>
  <li>イベント駆動のキャッシュ無効化</li>
  <li>キャッシュの依存解決</li>
  <li>ドーナッツキャッシュとドーナッツの穴キャッシュ</li>
  <li>CDNコントロール</li>
  <li>条件付きリクエスト</li>
</ul>

<h3 id="分散キャッシュフレームワーク">分散キャッシュフレームワーク</h3>

<p>REST制約に従った分散キャッシュシステムは、計算資源だけでなくネットワーク資源も節約します。</p>

<p>PHPが直接扱うRedisやAPCなどの<strong>サーバーサイドキャッシュ</strong>、コンテンツ配信ネットワーク(CDN)として知られる<strong>共有キャッシュ</strong>、WebブラウザやAPIクライアントでキャッシュされる<strong>クライアントサイドキャッシュ</strong>、BEAR.SundayはこれらのキャッシュとモダンCDNを統合したキャッシングフレームワークを提供します。</p>

<p><img src="https://user-images.githubusercontent.com/529021/137062427-c733c832-0631-4a43-a6ee-4204e6be007c.png" alt="distributed cache" /></p>

<h2 id="タグベースでのキャッシュ無効化">タグベースでのキャッシュ無効化</h2>

<p><img width="369" alt="dependency graph 2021-10-19 21 38 02" src="https://user-images.githubusercontent.com/529021/137910748-b6e95839-eeb7-4ade-a564-3cdcd5fdc09e.png" /></p>

<p>コンテンツキャッシュには依存性の問題があります。コンテンツAがコンテンツBに依存し、BがCに依存している場合、Cが更新されるとCのキャッシュとETagだけでなく、Cに依存するBのキャッシュとETag、Bに依存するAのキャッシュとETagも更新されなければなりません。</p>

<p>BEAR.Sundayはそれぞれのリソースが依存リソースのURIをタグとして保持する事でこの問題を解決します。<code class="language-plaintext highlighter-rouge">#[Embed]</code>で埋め込まれたリソースに変更があると、関係する全てのリソースのキャッシュとETagが無効化され、次のリクエストのためにキャッシュの再生性が行われます。</p>

<h2 id="ドーナッツキャッシュ">ドーナッツキャッシュ</h2>

<p><img width="200" alt="donut caching" src="https://user-images.githubusercontent.com/529021/137097856-f9428918-5b76-4c0e-8cea-2472c15d82e9.png" /></p>

<p>ドーナツキャッシュはキャッシュの最適化のための部分キャッシュ技術の１つです。コンテンツをキャッシュ可能な箇所とそうでない箇所に分けて合成します。</p>

<p>例えば”<code class="language-plaintext highlighter-rouge">Welcome to $name</code>“というキャッシュできないリソースが含まれるコンテンツを考えてみてください。キャッシュできない(do-not cache)部分と、その他のキャッシュ可能な部分と合成して出力します。</p>

<p><img width="557" alt="image" src="https://user-images.githubusercontent.com/529021/139617102-1f7f436c-a1f4-4c6c-b90b-de24491e4c8c.png" /></p>

<p>この場合コンテンツ全体としては動的なので、ドーナッツ全体はキャッシュされません。そのためETagも出力されません。</p>

<h2 id="ドーナッツの穴キャッシュ">ドーナッツの穴キャッシュ</h2>

<p><img width="544" alt="image" src="https://user-images.githubusercontent.com/529021/139617571-31aea99a-533f-4b95-b3f3-6c613407d377.png" /></p>

<p>ドーナッツの穴部分がキャッシュ可能の時もドーナッツキャッシュと同じように扱えます。</p>

<p>上記の例では、1時間に一度変更される天気予報のリソースがキャッシュされニュースリソースに含まれます。この場合、ドーナツ全体（ニュース）としてのコンテンツは静的なので全体もキャッシュされETagも付与されます。</p>

<p>この時にキャッシュの依存性が発生します。 ドーナッツの穴部分のコンテンツが更新された時に、キャッシュされたドーナッツ全体も再生成される必要があります。</p>

<p>素晴らしい事にこの依存解決は自動で行われます。その時に計算資源を最小化するためにドーナツ部分の計算は再利用されます。穴の部分（天気リソース）が更新されると全体のコンテンツのキャッシュとETagも自動で更新されます。</p>

<h3 id="リカーシブドーナッツ">リカーシブ・ドーナッツ</h3>

<p><img width="191" alt="recursive donut 2021-10-19 21 27 06" src="https://user-images.githubusercontent.com/529021/137909083-2c5176f7-edb7-422b-bccc-1db90460fc15.png" /></p>

<p>ドーナッツ構造は再起され適用されます。
例えば、AがBを含みBがCを含むコンテンツのCが変更された時に、変更されたCの部分を除いてAのキャッシュとBのキャッシュは再利用されます。AとBのキャッシュ、ETagは再生成されますが、A、Bのコンテンツ取得のためのDBアクセスやビューのレンダリングは行われません。
例えば、AがBを含み、BがCを含むコンテンツの場合に、Cが変更された時に、変更されたCの部分を除いてAのキャッシュとBのキャッシュは再利用されます。AやBのコンテンツ取得のためのDBアクセスやビューのレンダリングは行われません。新しく部分合成されたAとBのキャッシュ、ETagは再生成されます。</p>

<p>最適化された構造の部分キャッシュが、最小のコストでコンテンツ再生成を行います。クライアントはコンテンツのキャッシュ構造について知る必要がありません。</p>

<h2 id="イベントドリブン型コンテンツ">イベントドリブン型コンテンツ</h2>

<p>従来、CDNはアプリケーションロジックを必要とするコンテンツは「動的」であり、したがってCDNではキャッシュはできないと考えられてきました。しかしFastlyやAkamaiなどの一部のCDNは即時または数秒以内でのタグベースでのキャッシュ無効化が可能になり、<a href="https://www.fastly.com/blog/leveraging-your-cdn-cache-uncacheable-content">この考えは過去のもの</a>になろうとしています。</p>

<p>BEAR.Sundayの依存解決はサーバーサイドだけでなく共有キャッシュでも行われます。AOPが変更を検知し共有キャッシュにPURGEリクエストを行うことで、サーバーサイドと同じように共有キャッシュ上の関連キャッシュの無効化が行われます。</p>

<h2 id="条件付きリクエスト">条件付きリクエスト</h2>

<p><img width="468" alt="conditional request" src="https://user-images.githubusercontent.com/529021/137151061-8d7a5605-3aa3-494c-91c5-c1deddd987dd.png" /></p>

<p>コンテンツの変更はAOPで管理され、コンテンツのエンティティタグ(ETag)は自動で更新されます。ETagを使ったHTTPの条件付きリクエストは計算資源の利用を最小化するだけでなく、<code class="language-plaintext highlighter-rouge">304 Not Modified</code>を返すだけの応答はネットワーク資源の利用も最小化します。</p>

<h1 id="利用法">利用法</h1>

<p>キャッシュ対象のクラスにドーナッツキャッシュの場合（埋め込みコンテンツがキャッシュ不可能な場合）は<code class="language-plaintext highlighter-rouge">#[DonutCache]</code>、それ以外の場合は<code class="language-plaintext highlighter-rouge">#[CacheableResponse]</code>とアトリビュートを付与します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\CacheableResponse</span><span class="p">;</span>

<span class="c1">#[CacheableResponse]</span>
<span class="kd">class</span> <span class="nc">BlogPosting</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$headers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">RequestHeader</span><span class="o">::</span><span class="no">CACHE_CONTROL</span> <span class="o">=&gt;</span> <span class="nc">CacheControl</span><span class="o">::</span><span class="no">NO_CACHE</span>
    <span class="p">];</span>

    <span class="c1">#[Embed(rel: "comment", src: "page://self/html/comment")]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'article'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'hello world'</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onDelete</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>キャッシュ対象メソッドを選択したい場合はクラスに属性を指定しないで、メソッドに指定します。その場合はキャッシュ変更メソッドに<code class="language-plaintext highlighter-rouge">#[RefreshCache]</code>という属性を付与します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[CacheableResponse]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPut</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$todo</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="c1">#[RefreshCache]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onDelete</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
    <span class="p">}</span>	
<span class="p">}</span>
</code></pre></div></div>

<p>どちらかの方法でアトリビュートを付与すると、概要で紹介した全ての機能が適用されます。
イベントドリブン型コンテンツを想定してデフォルトでは時間(TTL)によるキャッシュの無効化は行われません</p>

<p><code class="language-plaintext highlighter-rouge">#[DonutCache]</code>の場合はコンテンツ全体はキャッシュされず、<code class="language-plaintext highlighter-rouge"> #[CacheableResponse]</code>の場合はされる事に注意してください。</p>

<h2 id="ttl">TTL</h2>

<p>TTLの指定は<code class="language-plaintext highlighter-rouge">DonutRepositoryInterface::put()</code>で行います。
<code class="language-plaintext highlighter-rouge">ttl</code>はドーナツの穴以外のキャッシュ時間、<code class="language-plaintext highlighter-rouge">sMaxAge</code>はCDNのキャッシュ時間です。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\CacheableResponse</span><span class="p">;</span>

<span class="c1">#[CacheableResponse]</span>
<span class="kd">class</span> <span class="nc">BlogPosting</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">private</span> <span class="nc">DonutRepositoryInterface</span> <span class="nv">$repository</span><span class="p">)</span>
    <span class="p">{}</span>

    <span class="c1">#[Embed(rel: "comment", src: "page://self/html/comment")]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="c1">// process ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">repository</span><span class="o">-&gt;</span><span class="nf">put</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="n">ttl</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span> <span class="n">sMaxAge</span><span class="o">:</span><span class="mi">100</span><span class="p">);</span><span class="err">　</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="ttlの既定値">TTLの既定値</h3>

<p>イベントドリブン型コンテンツでは、コンテンツが変更されたらキャッシュにすぐに反映されなければなりません。そのため、既定値のTTLはCDNのモジュールのインストールによって変わります。CDNがタグベースでのキャッシュ化を無効化をサポートしていればTTLは無期限（1年間）で、サポートの無い場合には10秒です。</p>

<p>キャッシュ反映時間は、Fastlyなら即時、Akamaiなら数秒、それ以外なら10秒が期待される時間です。</p>

<p>カスタマイズするには<code class="language-plaintext highlighter-rouge">CdnCacheControlHeader</code>を参考に<code class="language-plaintext highlighter-rouge">CdnCacheControlHeaderSetterInterface</code>を実装して束縛します。</p>

<h2 id="キャッシュ無効化">キャッシュ無効化</h2>

<p>手動でキャッシュを無効化するには<code class="language-plaintext highlighter-rouge">DonutRepositoryInterface</code>のメソッドを用います。
指定されたキャッシュだけでなく、そのETag、依存にしている他のリソースののキャッシュとそのETagがサーバーサイド、及び可能な場合はCDN上のキャッシュも共に無効化されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">DonutRepositoryInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">purge</span><span class="p">(</span><span class="kt">AbstractUri</span> <span class="nv">$uri</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">invalidateTags</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$tags</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="uriによる無効化">URIによる無効化</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// example</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">repository</span><span class="o">-&gt;</span><span class="nf">purge</span><span class="p">(</span><span class="k">new</span> <span class="nc">Uri</span><span class="p">(</span><span class="s1">'app://self/blog/comment'</span><span class="p">));</span>
</code></pre></div></div>

<h3 id="タグによる無効化">タグによる無効化</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">repository</span><span class="o">-&gt;</span><span class="nf">invalidateTags</span><span class="p">([</span><span class="s1">'template_a'</span><span class="p">,</span> <span class="s1">'campaign_b'</span><span class="p">]);</span>
</code></pre></div></div>
<h3 id="cdnでタグの無効化">CDNでタグの無効化</h3>

<p>CDNでタグベースでのキャッシュ無効化を有効にするためには<code class="language-plaintext highlighter-rouge">PurgerInterface</code>を実装して束縛する必要があります。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\QueryRepository\PurgerInterface</span><span class="p">;</span>

<span class="kd">interface</span> <span class="nc">PurgerInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$tag</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="依存タグの指定">依存タグの指定</h3>

<p>PURGE用のキーを指定するためには<code class="language-plaintext highlighter-rouge">SURROGATE_KEY</code>ヘッダーで指定します。複数文字列の時はスペースをセパレータに使います。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\QueryRepository\Header</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Foo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$headers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">Header</span><span class="o">::</span><span class="no">SURROGATE_KEY</span> <span class="o">=&gt;</span> <span class="s1">'template_a campaign_b'</span>
    <span class="p">];</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">template_a</code>または<code class="language-plaintext highlighter-rouge">campaign_b</code>のタグによるキャッシュの無効化が行われた場合、FooのキャッシュとFooのETagはサーバーサイド、CDN共に無効になります。</p>

<h3 id="リソースの依存">リソースの依存</h3>

<p><code class="language-plaintext highlighter-rouge">UriTagInterface</code>を使ってURIを依存タグ文字列に変換します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">private</span> <span class="nc">UriTagInterface</span> <span class="nv">$uriTag</span><span class="p">)</span>
<span class="p">{}</span>
</code></pre></div></div>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="nc">Header</span><span class="o">::</span><span class="no">SURROGATE_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">uriTag</span><span class="p">)(</span><span class="k">new</span> <span class="nc">Uri</span><span class="p">(</span><span class="s1">'app://self/foo'</span><span class="p">));</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">app://self/foo</code>に変更があった場合にこのキャッシュはサーバーサイド、CDN共に無効化されます。</p>

<h3 id="連想配列をリソースの依存に">連想配列をリソースの依存に</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// bodyの内容</span>
<span class="p">[</span>
    <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'a'</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'b'</span><span class="p">],</span>
<span class="p">]</span>
</code></pre></div></div>
<p>上記のような<code class="language-plaintext highlighter-rouge">body</code>連想配列から、依存するURIタグリストを生成する場合は<code class="language-plaintext highlighter-rouge">fromAssoc()</code>メソッドでURIテンプレートを指定します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="nc">Header</span><span class="o">::</span><span class="no">SURROGATE_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">uriTag</span><span class="o">-&gt;</span><span class="nf">fromAssoc</span><span class="p">(</span>
    <span class="n">uriTemplate</span><span class="o">:</span> <span class="s1">'app://self/item{?id}'</span><span class="p">,</span>
    <span class="n">assoc</span><span class="o">:</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span>
<span class="p">);</span>
</code></pre></div></div>

<p>上記の場合、<code class="language-plaintext highlighter-rouge">app://self/item?id=1</code>及び<code class="language-plaintext highlighter-rouge">app://self/item?id=2</code>に変更があった場合に、このキャッシュはサーバーサイド、CDN共に無効化されます。</p>

<h2 id="cdn">CDN</h2>

<p>特定CDN対応のモジュールをインストールするとベンダー固有のヘッダーが出力されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">FastlyModule</span><span class="p">())</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AkamaiModule</span><span class="p">())</span>
</code></pre></div></div>

<h2 id="マルチcdn">マルチCDN</h2>

<p>CDNを多段構成にして、役割に応じたTTLを設定することもできます。例えばこの図では上流に多機能なCDNを配置して、下流にはコンベンショナルなCDNを配置しています。コンテンツのインバリデーションなどは上流のCDNに対して行い、下流のCDNはそれを利用するようにします。</p>

<p><img width="344" alt="multi cdn diagram" src="https://user-images.githubusercontent.com/529021/137098809-ec949a15-8efb-4d03-9808-3be15523ade7.png" /></p>

<h1 id="レスポンスヘッダー">レスポンスヘッダー</h1>

<p>CDNのキャッシュコントロールについてはBEAR.Sundayが自動で行いCDN用のヘッダーを出力します。クライアントのキャッシュコントロールはコンテンツに応じてResourceObjectの<code class="language-plaintext highlighter-rouge">$header</code>に記述します。</p>

<p>セキュリティやメンテナンスの観点からこのセクションは重要です。
全てのResourceObjectで<code class="language-plaintext highlighter-rouge">Cache-Control</code>を指定するようにしましょう。</p>

<h3 id="キャッシュ不可">キャッシュ不可</h3>

<p>キャッシュができないコンテンツは必ず指定しましょう。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">CACHE_CONTROL</span> <span class="o">=&gt;</span> <span class="nc">CacheControl</span><span class="o">::</span><span class="no">NO_STORE</span>
</code></pre></div></div>

<h3 id="条件付きリクエスト-1">条件付きリクエスト</h3>

<p>サーバーにコンテンツ変更がないかを確認してから、キャッシュを利用します。サーバーサイドのコンテンツの変更は検知され反映されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">CACHE_CONTROL</span> <span class="o">=&gt;</span> <span class="nc">CacheControl</span><span class="o">::</span><span class="no">NO_CACHE</span>
</code></pre></div></div>

<h3 id="クライアントキャッシュ時間の指定">クライアントキャッシュ時間の指定</h3>

<p>クライントでキャッシュされます。最も効率的なキャッシュですが、サーバーサイドでコンテンツが変更されても指定した時間に反映されません。</p>

<p>またブラウザのリロード動作ではこのキャッシュは利用されません。<code class="language-plaintext highlighter-rouge">&lt;a&gt;</code>タグで遷移、またはURL入力した場合にキャッシュが利用されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">CACHE_CONTROL</span> <span class="o">=&gt;</span> <span class="s1">'max-age=60'</span>
</code></pre></div></div>

<p>レスポンス速度を重視する場合には、SWRの指定も検討しましょう。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">CACHE_CONTROL</span> <span class="o">=&gt;</span> <span class="s1">'max-age=30 stale-while-revalidate=10'</span>
</code></pre></div></div>

<p>この場合、max-ageの30秒を超えた時にオリジンサーバーからフレッシュなレスポンス取得が完了するまで、SWRで指定された最大10秒間はそれまでの古いキャッシュ(stale)レスポンスを返します。つまりキャッシュが更新されるのは最後のキャッシュ更新から30秒から40秒間の間のいずれかになりますが、どのリクエストもキャッシュからの応答になり高速です。</p>

<h4 id="rfc7234対応クライアント">RFC7234対応クライアント</h4>

<p>APIでクライアントキャッシュを利用する場合にはRFC7234対応APIクライアントを利用します。</p>

<ul>
  <li>iOS <a href="https://nshipster.com/nsurlcache/">NSURLCache</a></li>
  <li>Android <a href="https://developer.android.com/reference/android/net/http/HttpResponseCache">HttpResponseCache</a></li>
  <li>PHP <a href="https://github.com/Kevinrob/guzzle-cache-middleware">guzzle-cache-middleware</a></li>
  <li>JavaScript(Node) <a href="https://www.npmjs.com/package/cacheable-request">cacheable-request</a></li>
  <li>Go <a href="https://github.com/lox/httpcache">lox/httpcache</a></li>
  <li>Ruby <a href="https://github.com/plataformatec/faraday-http-cache">faraday-http-cache</a></li>
  <li>Python <a href="https://pypi.org/project/requests-cache/">requests-cache</a></li>
</ul>

<h3 id="プライベート">プライベート</h3>

<p>キャッシュを他のクライアントと共有しない時には<code class="language-plaintext highlighter-rouge">private</code>を指定します。クライアントサイドのみキャッシュ保存されます。この場合サーバーサイドではキャッシュ指定をしないようにします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">CACHE_CONTROL</span> <span class="o">=&gt;</span> <span class="s1">'private, max-age=30'</span>
</code></pre></div></div>

<blockquote>
  <p>共用キャッシュを利用する場合でもほとんどの場合において<code class="language-plaintext highlighter-rouge">public</code>を指定する必要はありません。</p>
</blockquote>

<h2 id="キャッシュ設計">キャッシュ設計</h2>

<p>API（またはコンテンツ）は<strong>情報API</strong> (Information API)、<strong>計算API</strong> (Computation API)は２つに分けることができます。計算APIは再現が難しく真に動的でキャッシュに不適なコンテンツです。一方の情報APIはDBから読み出され、PHPで加工されたとしても本質的には静的なコンテンツのAPIです。</p>

<p>適切なキャシュを適用するためにコンテンツを分析します。</p>

<ul>
  <li>情報APIか計算APIか</li>
  <li>依存関係は</li>
  <li>内包関係は</li>
  <li>無効化はイベントがトリガーか、それともTTLか</li>
  <li>イベントはアプリケーションが検知可能か、監視が必要か</li>
  <li>TTLは予測可能か不可能か</li>
</ul>

<p>キャッシュ設計をアプリケーション設計プロセスの一部にして、仕様にする事も検討しましょう。 ライフサイクルを通してプロジェクトの安全性にも寄与するはずです。</p>

<h3 id="アダプティブ-ttl">アダプティブ TTL</h3>

<p>コンテンツの生存期間が予測可能で、その期間にイベントによる更新が行われない時はそれをクライントやCDNに正しく伝えます。例えば株価のAPIを扱う時、現在が金曜日の夜だとすると月曜の取引開始時間までは情報更新が行われない事が分かっています。その時間までの秒数を計算してTTLとして指定し、取引時間の時には適切なTTLを指定します。</p>

<p>クライアントは更新がないと分かっているリソースにリクエストする必要はありません。</p>

<h2 id="cacheable">#[Cacheable]</h2>

<p>従来の#[Cacheable]によるTTLキャッシュもサポートされます。</p>

<p>例）サーバーサイドで30秒キャシュ、クライアントでも30秒キャシュ。</p>

<p>サーバーサイドで指定してるのでクライアントサイドでも同じ秒数でキャッシュされます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\Cacheable</span><span class="p">;</span>

<span class="c1">#[Cacheable(expirySecond: 30)]</span>
<span class="kd">class</span> <span class="nc">CachedResource</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
</code></pre></div></div>

<p>例）指定した有効期限(<code class="language-plaintext highlighter-rouge">$body['expiry_at']</code>の日付)までサーバー、クライアント供にキャッシュ</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\Cacheable</span><span class="p">;</span>

<span class="c1">#[Cacheable(expiryAt: 'expiry_at')]</span>
<span class="kd">class</span> <span class="nc">CachedResource</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
</code></pre></div></div>

<p>その他は<a href="https://bearsunday.github.io/manuals/1.0/ja/http-cache.html">HTTPキャッシュ</a>ページをご覧ください。</p>

<h2 id="結論">結論</h2>

<p>Webのコンテンツは情報（データ）型のものと計算（プロセス）型のものがあります。前者は本質的には静的ですが、コンテンツの変更や依存性の管理の問題で完全に静的コンテンツとして扱うのが難しく、コンテンツの変更が発生していないのにTTLによるキャッシュの無効化が行われていました。 BEAR.Sundayのキャッシングフレームワークは情報型のコンテンツを可能な限り静的に扱い、キャッシュの力を最大化します。</p>

<h2 id="用語">用語</h2>

<ul>
  <li><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Conditional_requests">条件付きリクエスト</a></li>
  <li><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/ETag">ETag (バージョン識別子)</a></li>
  <li><a href="https://www.fastly.com/blog/rise-event-driven-content-or-how-cache-more-edge">イベントドリブン型コンテンツ</a></li>
  <li><a href="https://www.infoq.com/jp/news/2011/12/MvcDonutCaching/">ドーナッツキャッシュ / 部分キャッシュ</a></li>
  <li><a href="https://docs.fastly.com/ja/guides/getting-started-with-surrogate-keys">サロゲートキー / タグベースの無効化</a></li>
  <li>ヘッダー
    <ul>
      <li><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Cache-Control">Cache-Control</a></li>
      <li><a href="https://blog.cloudflare.com/cdn-cache-control/">CDN-Cache-Control</a></li>
      <li><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Vary">Vary</a></li>
      <li><a href="https://www.infoq.com/jp/news/2020/12/ux-stale-while-revalidate/">Stale-While-Revalidate (SWR)</a></li>
    </ul>
  </li>
</ul>

<h1 id="コーディングガイド">コーディングガイド</h1>

<h2 id="プロジェクト">プロジェクト</h2>

<p><code class="language-plaintext highlighter-rouge">vendor</code>は会社の名前やチームの名前または個人の名前（<code class="language-plaintext highlighter-rouge">excite</code>,<code class="language-plaintext highlighter-rouge">koriym</code>等)を指定して、<code class="language-plaintext highlighter-rouge">package</code>にはアプリケーション（サービス）の名前（<code class="language-plaintext highlighter-rouge">blog</code>, <code class="language-plaintext highlighter-rouge">news</code>等)を指定します。
プロジェクトはアプリケーション単位で作成し、Web APIとHTMLを別ホストでサービスする場合でも1つのプロジェクトにします。</p>

<h2 id="スタイル">スタイル</h2>

<p><a href="https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-1-basic-coding-standard.md">PSR1</a>, <a href="https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-2-coding-style-guide.md">PSR2</a>, <a href="https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-4-autoloader.md">PSR4</a>に準拠します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">Koriym\Blog\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\Cacheable</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\Embed</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\Link</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Code</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>

<span class="c1">#[CacheableResponse]</span>
<span class="kd">class</span> <span class="nc">Entry</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ExtendPdoInterface</span> <span class="nv">$pdo</span><span class="p">,</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ResourceInterface</span> <span class="nv">$resource</span>
    <span class="p">)</span> <span class="p">{}</span>

    <span class="c1">#[Embed(rel: "author", src: "/author{?author_id}")]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$author_id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$slug</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">#[Link(rel: "next_action1", href: "/next_action1")]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span> <span class="p">(</span>
        <span class="kt">string</span> <span class="nv">$tile</span><span class="p">,</span>
        <span class="kt">string</span> <span class="nv">$body</span><span class="p">,</span>
        <span class="kt">string</span> <span class="nv">$uid</span><span class="p">,</span>
        <span class="kt">string</span> <span class="nv">$slug</span>
    <span class="p">):</span> <span class="kt">static</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="nc">Code</span><span class="o">::</span><span class="no">CREATED</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>リソースの<a href="[https://phpdoc.org/docs/latest/getting-started/your-first-set-of-documentation.html]">docBlockコメント</a>はオプションです。リソースURIや引数名だけで説明不十分な時にメソッドの要約（一行）、説明（複数行可）、<code class="language-plaintext highlighter-rouge">@params</code>を付加します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * A summary informing the user what the associated element does.
 *
 * A *description*, that can span multiple lines, to go _in-depth_ into the details of this element
 * and to provide some background information or textual references.
 *
 * @param string $arg1 *description*
 * @param string $arg2 *description*
*/</span>
</code></pre></div></div>

<h2 id="リソース">リソース</h2>

<p>リソースについてのベストプラクティスは<a href="resource_bp.html">リソースのベストプラクティス</a>をご覧ください。</p>

<h2 id="グローバル">グローバル</h2>

<p>グローバルな値をリソースやアプリケーションのクラスで参照することは推奨されません。(Modulesでのみ使用します)</p>

<ul>
  <li><a href="http://php.net/manual/ja/language.variables.superglobals.php">スーパーグローバル</a>の値を参照しない</li>
  <li><a href="http://php.net/manual/ja/function.define.php">define</a>は使用しない</li>
  <li>設定値を保持する<code class="language-plaintext highlighter-rouge">Config</code>クラスを作成しない</li>
  <li>グローバルなオブジェクトコンテナ（サービスロケータ）を使用しない <a href="http://koriym.github.io/adv10/">[1]</a>, <a href="http://blog.ploeh.dk/2010/02/03/ServiceLocatorisanAnti-Pattern/">[2]</a></li>
  <li><a href="http://php.net/manual/ja/function.date.php">date</a>関数や<a href="http://php.net/manual/ja/class.datetime.php">DateTime</a>クラスで現在時刻を直接取得することは推奨されません。外部から時刻をインジェクトします。<sup id="fnref:now" role="doc-noteref"><a href="#fn:now" class="footnote" rel="footnote">4</a></sup></li>
</ul>

<ul>
  <li>
    <p>スタティックメソッドなどのグローバルなメソッドコールも推奨されません。</p>
  </li>
  <li>
    <p>アプリケーションコードが必要とする値は設定ファイルなどから取得するのではなく、全てインジェクトします。<sup id="fnref:inject-all" role="doc-noteref"><a href="#fn:inject-all" class="footnote" rel="footnote">5</a></sup></p>
  </li>
</ul>

<h2 id="クラスとオブジェクト">クラスとオブジェクト</h2>

<ul>
  <li><a href="http://php.net/manual/ja/language.oop5.traits.php">トレイト</a>は推奨されません。<sup id="fnref:no-trait" role="doc-noteref"><a href="#fn:no-trait" class="footnote" rel="footnote">6</a></sup></li>
  <li>親クラスのメソッドを子クラスが使うことは推奨されません。共通する機能は継承やtraitで共有ではなくクラスにしてインジェクトして使います。<a href="https://en.wikipedia.org/wiki/Composition_over_inheritance">継承より合成</a>します。</li>
</ul>

<h2 id="スクリプトコマンド">スクリプトコマンド</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">composer setup</code>コマンドでアプリケーションのセットアップが完了することが推奨されます。このスクリプトではデータベースの初期化、必要ライブラリの確認が含まれます。<code class="language-plaintext highlighter-rouge">.env</code>の設定などマニュアルな操作が必要な場合はその手順が画面表示されることが推奨されます。</li>
</ul>

<h2 id="リソース-1">リソース</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">onPost</code>で作成したリソースのURIは<code class="language-plaintext highlighter-rouge">Location</code>ヘッダーで示します。</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$title</span><span class="p">):</span> <span class="kt">static</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">201</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"/task?id=</span><span class="si">{</span><span class="nv">$id</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>リソースのベストプラクティスは<a href="/manuals/1.0/ja/resource.html#best-practice">リソースベストプラクティス</a>もご覧ください。</p>

<h3 id="コード">コード</h3>

<p>適切なステータスコードを返します。テストが容易になり、botやクローラーにも正しい情報が伝えることができます。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">100</code> Continue 複数のリクエストの継続</li>
  <li><code class="language-plaintext highlighter-rouge">200</code> OK</li>
  <li><code class="language-plaintext highlighter-rouge">201</code> Created リソース作成</li>
  <li><code class="language-plaintext highlighter-rouge">202</code> Accepted キュー/バッチ 受付</li>
  <li><code class="language-plaintext highlighter-rouge">204</code> No Content bodyがない場合</li>
  <li><code class="language-plaintext highlighter-rouge">304</code> Not Modified 未更新</li>
  <li><code class="language-plaintext highlighter-rouge">400</code> Bad Request　リクエストに不備</li>
  <li><code class="language-plaintext highlighter-rouge">401</code> Unauthorized 認証が必要</li>
  <li><code class="language-plaintext highlighter-rouge">403</code> Forbidden 禁止</li>
  <li><code class="language-plaintext highlighter-rouge">404</code> Not Found</li>
  <li><code class="language-plaintext highlighter-rouge">405</code> Method Not Allowed</li>
  <li><code class="language-plaintext highlighter-rouge">503</code> Service Unavailable サーバーサイドでの一時的エラー</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">304</code>は<code class="language-plaintext highlighter-rouge">#[Cacheable]</code>アトリビュートを使っていると自動設定されます。<code class="language-plaintext highlighter-rouge">404</code>はリソースクラスがない場合、<code class="language-plaintext highlighter-rouge">405</code>はリソースのメソッドがない場合に自動設定されます。またDBの接続エラーなどは必ず<code class="language-plaintext highlighter-rouge">503</code>で返しクローラーに伝えます。<a href="https://googlewebmastercentral-ja.blogspot.jp/2011/02/blog-post.html">[1]</a></p>

<h3 id="htmlのformメソッド">HTMLのFormメソッド</h3>

<p>BEAR.SundayはHTMLのWebフォームで<code class="language-plaintext highlighter-rouge">POST</code>リクエストの時に<code class="language-plaintext highlighter-rouge">X-HTTP-Method-Override</code>ヘッダーや<code class="language-plaintext highlighter-rouge">_method</code>クエリーを用いてメソッドを上書きする事ができますが、推奨しているわけではありません。Pageリソースでは<code class="language-plaintext highlighter-rouge">onGet</code>と<code class="language-plaintext highlighter-rouge">onPost</code>以外を実装しない方針でも問題ありません。<a href="http://programmers.stackexchange.com/questions/114156/why-are-there-are-no-put-and-delete-methods-on-html-forms">[1]</a>,<a href="http://roy.gbiv.com/untangled/2009/it-is-okay-to-use-post">[2]</a></p>

<h3 id="ハイパーリンク">ハイパーリンク</h3>

<ul>
  <li>リンクを持つリソースは<code class="language-plaintext highlighter-rouge">#[Link]</code>で示すことが推奨されます。</li>
  <li>リソースは意味のまとまりのグラフにして<code class="language-plaintext highlighter-rouge">#[Embed]</code>で埋め込む事が推奨されます。</li>
</ul>

<h2 id="di">DI</h2>

<ul>
  <li>実行コンテキスト(prod, devなど)の値そのものをインジェクトしてはいけません。代わりにコンテキストに応じたインスタンスをインジェクトします。アプリケーションはどのコンテキストで動作しているのか無知にします。</li>
  <li>ライブラリコードではセッターインジェクションは推奨されません。</li>
  <li><code class="language-plaintext highlighter-rouge">Provider</code>束縛を可能な限り避け<code class="language-plaintext highlighter-rouge">toConstructor</code>束縛を優先することが推奨されます。</li>
  <li><code class="language-plaintext highlighter-rouge">Module</code>で条件に応じて束縛をすることを避けます。 (<a href="https://github.com/google/guice/wiki/AvoidConditionalLogicInModules">AvoidConditionalLogicInModules</a>)</li>
  <li>モジュールの<code class="language-plaintext highlighter-rouge">configure()</code>から環境変数を参照しないで、コンストラクタインジェクションにします。</li>
</ul>

<h2 id="aop-1">AOP</h2>

<ul>
  <li>インターセプターの適用を必須にしてはいけません。例えばログやDBのトランザクションなどはインターセプターの有無でプログラムの本質的な動作は変わりません。</li>
  <li>メソッド内の依存をインターセプターがインジェクトしないようにします。メソッド実装時にしか決定できない値は<code class="language-plaintext highlighter-rouge">@Assisted</code>インジェクションで引数にインジェクトします。</li>
  <li>複数のインタセプターがある場合にその実行順に可能な限り依存しないようにします。</li>
  <li>無条件に全メソッドに適用するインターセプターであれば<code class="language-plaintext highlighter-rouge">bootstrap.php</code>での記述を考慮してください。</li>
  <li>横断的関心事と、本質的関心事を分けるために使われるものです。特定のメソッドのhackのためにインターセプトするような使い方は推奨されません。</li>
</ul>

<h2 id="環境">環境</h2>

<ul>
  <li>Webだけでしか動作しないアプリケーションは推奨されません。テスト可能にするためにコンソールでも動作するようにします。</li>
  <li><code class="language-plaintext highlighter-rouge">.env</code>ファイルをプロジェクトリポジトリに含まない事が推奨されます。</li>
  <li><code class="language-plaintext highlighter-rouge">.env</code>の代わりにスキーマを記述する<a href="https://github.com/koriym/Koriym.EnvJson">Koriym.EnvJson</a>の利用を検討してください。</li>
</ul>

<h2 id="テスト">テスト</h2>

<ul>
  <li>リソースクライアントを使ったリソーステストを中心にし、必要があればリソースの表現のテスト(HTMLなど)を加えます。</li>
  <li>ハイパーメディアテストはユースケースをテストとして残すことができます。</li>
  <li><code class="language-plaintext highlighter-rouge">prod</code>はプロダクション用のコンテキストです。テストで<code class="language-plaintext highlighter-rouge">prod</code>コンテキストの利用は最低限、できれば無しにしましょう。</li>
</ul>

<h2 id="htmlテンプレート">HTMLテンプレート</h2>

<ul>
  <li>大きなループ文を避けます。ループの中のif文は<a href="https://www.php.net/manual/ja/language.generators.overview.php">ジェネレーター</a> で置き換えれないか検討しましょう。</li>
</ul>

<hr />

<h1 id="コンテントネゴシエーション">コンテントネゴシエーション</h1>

<p>HTTPにおいてコンテントネゴシエーション (<a href="https://en.wikipedia.org/wiki/Content_negotiation">content negotiation</a>) は、同じ URL に対してさまざまなバージョンのリソースを提供するために使用する仕組みです。BEAR.Sundayではその内のメディアタイプの<code class="language-plaintext highlighter-rouge">Accept</code>と言語の<code class="language-plaintext highlighter-rouge">Accept-Language</code>のサーバーサイドのコンテントネゴシエーションをサポートします。アプリケーション単位またはリソース単位で指定することができます。</p>

<h2 id="インストール">インストール</h2>

<p>composerで<a href="https://github.com/bearsunday/BEAR.Accept">BEAR.Accept</a>をインストールします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require bear/accept ^0.1
</code></pre></div></div>

<p>次に<code class="language-plaintext highlighter-rouge">Accept*</code>リクエストヘッダーに応じたコンテキストを<code class="language-plaintext highlighter-rouge">/var/locale/available.php</code>に保存します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">return</span> <span class="p">[</span>
    <span class="s1">'Accept'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'text/hal+json'</span> <span class="o">=&gt;</span> <span class="s1">'hal-app'</span><span class="p">,</span>
        <span class="s1">'application/json'</span> <span class="o">=&gt;</span> <span class="s1">'app'</span><span class="p">,</span>
        <span class="s1">'cli'</span> <span class="o">=&gt;</span> <span class="s1">'cli-hal-app'</span>
    <span class="p">],</span>
    <span class="s1">'Accept-Language'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="c1">// キーを小文字で</span>
        <span class="s1">'ja-jp'</span> <span class="o">=&gt;</span> <span class="s1">'ja'</span><span class="p">,</span>
        <span class="s1">'ja'</span> <span class="o">=&gt;</span> <span class="s1">'ja'</span><span class="p">,</span>
        <span class="s1">'en-us'</span> <span class="o">=&gt;</span> <span class="s1">'en'</span><span class="p">,</span>
        <span class="s1">'en'</span> <span class="o">=&gt;</span> <span class="s1">'en'</span>
    <span class="p">]</span>
<span class="p">];</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Accept</code>キー配列はメディアタイプをキーにしてコンテキストが値にした配列を指定します。<code class="language-plaintext highlighter-rouge">cli</code>はコンソールアクセスでのコンテキストでwebアクセスで使われることはありません。</p>

<p><code class="language-plaintext highlighter-rouge">Accept-Language</code>キー配列は言語をキーにしてコンテキストキーを値した配列を指定します。</p>

<h2 id="アプリケーション-1">アプリケーション</h2>

<p>アプリケーション全体でコンテントネゴシエーションを有効にするために<code class="language-plaintext highlighter-rouge">public/index.php</code>を変更します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">use</span> <span class="nc">BEAR\Accept\Accept</span><span class="p">;</span>

<span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/vendor/autoload.php'</span><span class="p">;</span>

<span class="nv">$accept</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Accept</span><span class="p">(</span><span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/var/locale/available.php'</span><span class="p">);</span>
<span class="k">list</span><span class="p">(</span><span class="nv">$context</span><span class="p">,</span> <span class="nv">$vary</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$accept</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">);</span>

<span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/bootstrap/bootstrap.php'</span><span class="p">;</span>
</code></pre></div></div>

<p>上記の設定で例えば以下の<code class="language-plaintext highlighter-rouge">Accept*</code>ヘッダーのアクセスのコンテキストは<code class="language-plaintext highlighter-rouge">prod-hal-ja-app</code>になります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Accept: application/hal+json
Accept-Language: ja-JP
</code></pre></div></div>

<p>この時<code class="language-plaintext highlighter-rouge">JaModule</code>で日本語テキストのための束縛が必要です。詳しくはデモアプリケーション<a href="https://github.com/koriym/MyVendor.Locale">MyVendor.Locale</a>をごらんください。</p>

<h2 id="リソース-2">リソース</h2>

<p>リソース単位でコンテントネゴシエーションを行う場合は<code class="language-plaintext highlighter-rouge">AcceptModule</code>モジュールをインストールして<code class="language-plaintext highlighter-rouge">@Produces</code>アノテーションを使います。</p>

<h3 id="モジュール">モジュール</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nv">$available</span> <span class="o">=</span> <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/var/locale/available.php'</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AcceptModule</span><span class="p">(</span><span class="n">available</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="producesアノテーション">@Producesアノテーション</h2>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Accept\Annotation\Produces</span><span class="p">;</span>

<span class="cd">/**
 * @Produces({"application/hal+json", "text/csv"})
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
</code></pre></div></div>

<p>利用可能なメディアタイプを左から優先順位でアノテートします。対応したコンテキストのレンダラーがAOPでセットされ表現が変わります。アプリケーション単位でのネゴシエーションの時と違って、<code class="language-plaintext highlighter-rouge">Vary</code>ヘッダーを手動で付加する必要はありません。</p>

<h2 id="curlを使ったアクセス">curlを使ったアクセス</h2>

<p><code class="language-plaintext highlighter-rouge">-H</code>オプションで<code class="language-plaintext highlighter-rouge">Accept*</code>ヘッダーを指定します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H 'Accept-Language: en' http://127.0.0.1:8080/
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -i -H 'Accept-Language: en' -H 'Accept: application/hal+json' http://127.0.0.1:8080/
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Host: 127.0.0.1:8080
Date: Fri, 11 Aug 2017 08:32:33 +0200
Connection: close
X-Powered-By: PHP/7.1.4
Vary: Accept, Accept-Language
content-type: application/hal+json

{
    "greeting": "Hello BEAR.Sunday",
    "_links": {
        "self": {
            "href": "/index"
        }
    }
}
</code></pre></div></div>

<h1 id="データベース">データベース</h1>

<p>データベースの利用のために、問題解決方法の異なった以下のモジュールが用意されています。いずれも<a href="https://www.php.net/manual/ja/intro.pdo.php">PDO</a> をベースにしたSQLのための独立ライブラリです。</p>

<ul>
  <li>PDOをextendしたExtendedPdo (<a href="https://github.com/auraphp/Aura.Sql">Aura.sql</a>)</li>
  <li>クエリービルダー (<a href="https://github.com/auraphp/Aura.SqlQuery">Aura.SqlQuery</a>)</li>
  <li>PHPのインターフェイスとSQL実行を束縛 (<a href="database_media.html">Ray.MediaQuery</a>)</li>
</ul>

<p>静的なSQLはファイルにすると<sup id="fnref:locater" role="doc-noteref"><a href="#fn:locater" class="footnote" rel="footnote">7</a></sup>、管理や他のSQLツールでの検証などの使い勝手もよくなります。 
Aura.SqlQueryは動的にクエリーを組み立てる事ができますが、その他は基本静的なSQLの実行のためのライブラリです。
また、Ray.MediaQueryではSQLの一部をビルダーで組み立てたものに入れ替えることもできます。</p>

<h2 id="モジュール-1">モジュール</h2>

<p>必要なライブラリに応じたモジュールをインストールします。</p>

<ul>
  <li><a href="database_aura.html">Ray.AuraSqlModule</a></li>
  <li><a href="database_media.html">Ray.MediaQuery</a></li>
</ul>

<p><code class="language-plaintext highlighter-rouge">Ray.AuraSqlModule</code>はAura.SqlQueryとAura.SqlQueryを含みます。
<code class="language-plaintext highlighter-rouge">Ray.MediaQuery</code>はユーザーが用意したインターフェイスとSQLから、SQL実行オブジェクトを生成しインジェクトする<sup id="fnref:doma" role="doc-noteref"><a href="#fn:doma" class="footnote" rel="footnote">8</a></sup>高機能なDBアクセスフレームワークです。</p>

<h2 id="その他">その他</h2>

<ul>
  <li><a href="database_dbal.html">DBAL</a></li>
  <li><a href="database_cake.html">CakeDb</a></li>
  <li><a href="https://github.com/ray-di/Ray.QueryModule/blob/1.x/README.ja.md">Ray.QueryModule</a></li>
</ul>

<p><code class="language-plaintext highlighter-rouge">DBAL</code>はDoctrine、<code class="language-plaintext highlighter-rouge">CakeDB</code>はCakePHPのDBライブラリです。<code class="language-plaintext highlighter-rouge">Ray.QueryModule</code>はRay.MediaQueryの以前のライブラリでSQLを無名関数に変換します。</p>

<hr />

<h1 id="rayaurasqlmodule">Ray.AuraSqlModule</h1>

<p><code class="language-plaintext highlighter-rouge">Ray.AuraSqlModule</code>はPDO拡張のAura.SqlとクエリビルダーAura.SqlQuery、その他にデータベースクエリー結果のページネーションのためのライブラリを提供します。</p>

<h2 id="インストール-1">インストール</h2>

<p>composerで<code class="language-plaintext highlighter-rouge">ray/aura-sql-module</code>をインストールします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require ray/aura-sql-module
</code></pre></div></div>

<p>アプリケーションモジュール<code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code>で<code class="language-plaintext highlighter-rouge">AuraSqlModule</code>をインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\AppMeta\AppMeta</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\PackageModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlModule</span><span class="p">;</span> <span class="c1">// この行を追加</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
          <span class="k">new</span> <span class="nc">AuraSqlModule</span><span class="p">(</span>
            <span class="s1">'mysql:host=localhost;dbname=test'</span> <span class="c1">// またはgetenv('PDO_DSN')</span>
            <span class="s1">'username'</span><span class="p">,</span>
            <span class="s1">'password'</span><span class="p">,</span>
          <span class="p">)</span>
        <span class="p">);</span>  <span class="c1">// この行を追加</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">PackageModule</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>設定時に直接値を指定するのではなく、実行時に毎回環境変数から取得するためには<code class="language-plaintext highlighter-rouge">AuraSqlEnvModule</code>を使います。
接続先と認証情報の値を直接指定する代わりに、該当する環境変数のキーを渡します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">AuraSqlEnvModule</span><span class="p">(</span>
                <span class="s1">'PDO_DSN'</span><span class="p">,</span>             <span class="c1">// getenv('PDO_DSN')</span>
                <span class="s1">'PDO_USER'</span><span class="p">,</span>            <span class="c1">// getenv('PDO_USER')</span>
                <span class="s1">'PDO_PASSWORD'</span><span class="p">,</span>        <span class="c1">// getenv('PDO_PASSWORD')</span>
                <span class="s1">'PDO_SLAVE'</span>            <span class="c1">// getenv('PDO_SLAVE')</span>
                <span class="nv">$options</span><span class="p">,</span>              <span class="c1">// optional key=&gt;value array of driver-specific connection options</span>
                <span class="nv">$queris</span>                <span class="c1">// Queries to execute after the connection.</span>
        <span class="p">);</span>
</code></pre></div></div>

<h2 id="aurasql">Aura.Sql</h2>

<p><a href="https://github.com/auraphp/Aura.Sql">Aura.Sql</a>はPHPのPDOを拡張したデータベースライブラリです。
コンストラクタインジェクションや<code class="language-plaintext highlighter-rouge">AuraSqlInject</code>トレイトを利用して<code class="language-plaintext highlighter-rouge">PDO</code>を拡張したDBオブジェクト<code class="language-plaintext highlighter-rouge">ExtendedPDO</code>を受け取ります。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Aura\Sql\ExtendedPdoInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ExtendedPdoInterface</span> <span class="nv">$pdo</span>
    <span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlInject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">AuraSqlInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// \Aura\Sql\ExtendedPdo</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Ray.AuraSqlModule</code>は<a href="https://github.com/auraphp/Aura.SqlQuery">Aura.SqlQuery</a>を含んでいてMySQLやPostgresなどのSQLを組み立てるのに利用できます。</p>

<h3 id="perform-メソッド">perform() メソッド</h3>

<p><code class="language-plaintext highlighter-rouge">perform()</code>メソッドは、1つのプレイスホルダーしかないSQLに配列の値をバインドすることが出来ます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$stm</span> <span class="o">=</span> <span class="s1">'SELECT * FROM test WHERE foo IN (:foo)'</span>
<span class="nv">$array</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'baz'</span><span class="p">];</span>
</code></pre></div></div>

<p>既存のPDOの場合</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// the native PDO way does not work (PHP Notice:  Array to string conversion)</span>
<span class="c1">// ネイティブのPDOでは`:foo`に配列を指定することは出来ません</span>
<span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$stm</span><span class="p">);</span>
<span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">bindValue</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="nv">$array</span><span class="p">);</span>
</code></pre></div></div>

<p>Aura.SqlのExtendedPDOの場合</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$stm</span> <span class="o">=</span> <span class="s1">'SELECT * FROM test WHERE foo IN (:foo)'</span>
<span class="nv">$values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'baz'</span><span class="p">]];</span>
<span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">perform</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$values</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">:foo</code>に<code class="language-plaintext highlighter-rouge">['foo', 'bar', 'baz']</code>がバインドがされます。<code class="language-plaintext highlighter-rouge">queryString</code>で実際のクエリーを調べることが出来ます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">echo</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">queryString</span><span class="p">;</span>
<span class="c1">// the query string has been modified by ExtendedPdo to become</span>
<span class="c1">// "SELECT * FROM test WHERE foo IN ('foo', 'bar', 'baz')"</span>
</code></pre></div></div>

<h3 id="fetch-メソッド">fetch*() メソッド</h3>

<p><code class="language-plaintext highlighter-rouge">prepare()</code>、<code class="language-plaintext highlighter-rouge">bindValue()</code>、 <code class="language-plaintext highlighter-rouge">execute()</code>を繰り返してデータベースから値を取得する代わりに<code class="language-plaintext highlighter-rouge">fetch*()</code>メソッドを使うとボイラープレートコードを減らすことができます。
（内部では<code class="language-plaintext highlighter-rouge">perform()</code>メソッドを実行しているので配列のプレイスホルダーもサポートしています）</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$stm</span>  <span class="o">=</span> <span class="s1">'SELECT * FROM test WHERE foo = :foo AND bar = :bar'</span><span class="p">;</span>
<span class="nv">$bind</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="s1">'baz'</span><span class="p">,</span> <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'dib'</span><span class="p">);</span>
<span class="c1">// ネイティブのPDOで"fetch all"を行う場合</span>
<span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PDO</span><span class="p">(</span><span class="mf">...</span><span class="p">);</span>
<span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$stm</span><span class="p">);</span>
<span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$bind</span><span class="p">);</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">fetchAll</span><span class="p">(</span><span class="no">PDO</span><span class="o">::</span><span class="no">FETCH_ASSOC</span><span class="p">);</span>

<span class="c1">// ExtendedPdoで"fetch all"を行う場合</span>
<span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExtendedPdo</span><span class="p">(</span><span class="mf">...</span><span class="p">);</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchAll</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">);</span>

<span class="c1">// fetchAssoc()は全ての行がコラム名のキーを持つ連想配列が返ります。</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchAssoc</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">);</span>

<span class="c1">// fetchGroup() is like fetchAssoc() except that the values aren't wrapped in</span>
<span class="c1">// arrays. Instead, single column values are returned as a single dimensional</span>
<span class="c1">// array and multiple columns are returned as an array of arrays</span>
<span class="c1">// Set style to PDO::FETCH_NAMED when values are an array</span>
<span class="c1">// (i.e. there are more than two columns in the select)</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchGroup</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">,</span> <span class="nv">$style</span> <span class="o">=</span> <span class="no">PDO</span><span class="o">::</span><span class="no">FETCH_COLUMN</span><span class="p">)</span>

<span class="c1">// fetchOne()は最初の行をキーをコラム名にした連想配列で返します。</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchOne</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">);</span>

<span class="c1">// fetchPairs()は最初の列の値をキーに二番目の列の値を値にした連想配列を返します  </span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchPairs</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">);</span>

<span class="c1">// fetchValue()は最初の列の値を返します。</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchValue</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">);</span>

<span class="c1">// fetchAffected()は影響を受けた行数を返します。</span>
<span class="nv">$stm</span> <span class="o">=</span> <span class="s2">"UPDATE test SET incr = incr + 1 WHERE foo = :foo AND bar = :bar"</span><span class="p">;</span>
<span class="nv">$row_count</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchAffected</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">fetchAll()</code>, <code class="language-plaintext highlighter-rouge">fetchAssoc()</code>, <code class="language-plaintext highlighter-rouge">fetchCol()</code>, 及び <code class="language-plaintext highlighter-rouge">fetchPairs()</code>のメソッドは三番目のオプションの引数に、それぞれの列に適用されるコールバックを指定することができます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$result</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchAssoc</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="o">&amp;</span><span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// add a column to the row</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">'my_new_col'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Added this column from the callable.'</span><span class="p">;</span>
<span class="p">});</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<h3 id="yield-メソッド">yield*() メソッド</h3>

<p>メモリを節約するために<code class="language-plaintext highlighter-rouge">yield*()</code>メソッドを使うことができます。 <code class="language-plaintext highlighter-rouge">fetch*()</code>メソッドは全ての行を一度に取得しますが、
<code class="language-plaintext highlighter-rouge">yield*()</code>メソッドはイテレーターが返ります。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$stm</span>  <span class="o">=</span> <span class="s1">'SELECT * FROM test WHERE foo = :foo AND bar = :bar'</span><span class="p">;</span>
<span class="nv">$bind</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="s1">'baz'</span><span class="p">,</span> <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'dib'</span><span class="p">);</span>

<span class="c1">// fetchAll()のように行は連想配列です</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">yieldAll</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// fetchAssoc()のようにキーが最初の列名で行が連想配列です。</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">yieldAssoc</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// fetchCol()のように最初の列が値になった値を返します。</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">yieldCol</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// fetchPairs()と同様に最初の列からキー/バリューのペアの値を返します。</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">yieldPairs</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="リプリケーション">リプリケーション</h2>

<p>マスター／スレーブ構成のデータベース接続を行うためには4つ目の引数にスレーブDBのホストを指定します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
  <span class="k">new</span> <span class="nc">AuraSqlModule</span><span class="p">(</span>
    <span class="s1">'mysql:host=localhost;dbname=test'</span><span class="p">,</span>
    <span class="s1">'username'</span><span class="p">,</span>
    <span class="s1">'password'</span><span class="p">,</span>
    <span class="s1">'slave1,slave2'</span> <span class="c1">// スレーブのホストをカンマ区切りで指定</span>
  <span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<p>これでHTTPリクエストがGETの時がスレーブDB、その他のメソッドの時はマスターDBのDBオブジェクトがコンスタラクタに渡されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Aura\Sql\ExtendedPdoInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="no">PDO</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$pdo</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">ExtendedPdoInterface</span> <span class="nv">$pdo</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
    <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// slave db</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="nv">$todo</span><span class="p">)</span>
    <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// master db</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">@ReadOnlyConnection</code>、<code class="language-plaintext highlighter-rouge">@WriteConnection</code>でアノテートされたメソッドはメソッド名に関わらず、呼ばれた時にアノテーションに応じたDBオブジェクトが<code class="language-plaintext highlighter-rouge">$this-&gt;pdo</code>に上書きされます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\Annotation\ReadOnlyConnection</span><span class="p">;</span>  <span class="c1">// important</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\Annotation\WriteConnection</span><span class="p">;</span>     <span class="c1">// important</span>

<span class="kd">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$pdo</span><span class="p">;</span> <span class="c1">// @ReadOnlyConnectionや@WriteConnectionのメソッドが呼ばれた時に上書きされる</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="nv">$todo</span><span class="p">)</span>
    <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">read</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @ReadOnlyConnection
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">read</span><span class="p">()</span>
    <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// slave db</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @WriteConnection
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">write</span><span class="p">()</span>
    <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// master db</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="複数データベースの接続">複数データベースの接続</h2>

<p>接続先の異なるデータベースのPDOインスタンスをインジェクトするには識別子<sup id="fnref:qualifier" role="doc-noteref"><a href="#fn:qualifier" class="footnote" rel="footnote">9</a></sup>をつけます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">function</span> <span class="n">__constrcut</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="c1">#[Log] ExtendedPdoInterface $logDb,</span>
        <span class="k">private</span> <span class="kt">readonly</span> <span class="c1">#[Mail] ExtendedPdoInterface $mailDb,</span>
    <span class="p">){}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">NamedPdoModule</code>でその識別子と接続情報を指定してインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">NamedPdoModule</span><span class="p">(</span><span class="nc">Log</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="s1">'mysql:host=localhost;dbname=log'</span><span class="p">,</span> <span class="s1">'username'</span><span class="p">,</span> 
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">NamedPdoModule</span><span class="p">(</span><span class="nc">Mail</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="s1">'mysql:host=localhost;dbname=mail'</span><span class="p">,</span> <span class="s1">'username'</span><span class="p">,</span> 
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>接続情報を環境変数から都度取得するときはNamedPdoEnvModuleを使います。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">NamedPdoEnvModule</span><span class="p">(</span><span class="nc">Log</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="s1">'LOG_DSN'</span><span class="p">,</span> <span class="s1">'LOG_USERNAME'</span><span class="p">,</span>  
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">NamedPdoEnvModule</span><span class="p">(</span><span class="nc">Mail</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="s1">'MAIL_DSN'</span><span class="p">,</span> <span class="s1">'MAIL_USERNAME'</span><span class="p">,</span> 
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="トランザクション">トランザクション</h2>

<p><code class="language-plaintext highlighter-rouge">#[Transactional]</code>アトリビュートを追加したメソッドはトランザクション管理されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\Annotation\Transactional</span><span class="p">;</span>

<span class="c1">// ....</span>
    <span class="c1">#[Transactional]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">write</span><span class="p">()</span>
    <span class="p">{</span>
         <span class="c1">// 例外発生したら\Ray\AuraSqlModule\Exception\RollbackExceptionに</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>複数接続したデータベースのトランザクションを行うためには<code class="language-plaintext highlighter-rouge">@Transactional</code>アノテーションにプロパティを指定します。
指定しない場合は<code class="language-plaintext highlighter-rouge">{"pdo"}</code>になります。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[Transactional({"pdo", "userDb"})]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">write</span><span class="p">()</span>
</code></pre></div></div>

<p>以下のように実行されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">beginTransaction</span><span class="p">()</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">userDb</span><span class="o">-&gt;</span><span class="nf">beginTransaction</span><span class="p">()</span>

<span class="c1">// ...</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">commit</span><span class="p">();</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">userDb</span><span class="o">-&gt;</span><span class="nf">commit</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="aurasqlquery">Aura.SqlQuery</h2>

<p><a href="https://github.com/auraphp/Aura.Sql">Aura.Sql</a>はPDOを拡張したライブラリですが、<a href="https://github.com/auraphp/Aura.SqlQuery">Aura.SqlQuery</a>は MySQL、Postgres,、SQLiteあるいは Microsoft SQL Serverといったデータベース固有のSQLのビルダーを提供します。</p>

<p>データベースを指定してアプリケーションモジュール<code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code>でインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AuraSqlQueryModule</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">));</span> <span class="c1">// pgsql, sqlite, or sqlsrv</span>
</code></pre></div></div>

<h3 id="select">SELECT</h3>

<p>リソースではDBクエリービルダオブジェクトを受け取り、下記のメソッドを使ってSELECTクエリーを組み立てます。
メソッドに特定の順番はなく複数回呼ぶことこともできます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Aura\Sql\ExtendedPdoInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Aura\SqlQuery\Common\SelectInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">User</span> <span class="n">extend</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ExtendedPdoInterface</span> <span class="nv">$pdo</span><span class="p">,</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">SelectInterface</span> <span class="nv">$select</span>
    <span class="p">)</span> <span class="p">{}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">select</span>
            <span class="o">-&gt;</span><span class="nf">distinct</span><span class="p">()</span>                    <span class="c1">// SELECT DISTINCT</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>                        <span class="c1">// select these columns</span>
                <span class="s1">'id'</span><span class="p">,</span>                       <span class="c1">// column name</span>
                <span class="s1">'name AS namecol'</span><span class="p">,</span>          <span class="c1">// one way of aliasing</span>
                <span class="s1">'col_name'</span> <span class="o">=&gt;</span> <span class="s1">'col_alias'</span><span class="p">,</span>  <span class="c1">// another way of aliasing</span>
                <span class="s1">'COUNT(foo) AS foo_count'</span>   <span class="c1">// embed calculations directly</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">from</span><span class="p">(</span><span class="s1">'foo AS f'</span><span class="p">)</span>              <span class="c1">// FROM these tables</span>
            <span class="o">-&gt;</span><span class="nf">fromSubselect</span><span class="p">(</span>                <span class="c1">// FROM sub-select AS my_sub</span>
                <span class="s1">'SELECT ...'</span><span class="p">,</span>
                <span class="s1">'my_sub'</span>
            <span class="p">)</span>
            <span class="o">-&gt;</span><span class="nb">join</span><span class="p">(</span>                         <span class="c1">// JOIN ...</span>
                <span class="s1">'LEFT'</span><span class="p">,</span>                     <span class="c1">// left/inner/natural/etc</span>
                <span class="s1">'doom AS d'</span>                 <span class="c1">// this table name</span>
                <span class="s1">'foo.id = d.foo_id'</span>         <span class="c1">// ON these conditions</span>
            <span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">joinSubSelect</span><span class="p">(</span>                <span class="c1">// JOIN to a sub-select</span>
                <span class="s1">'INNER'</span><span class="p">,</span>                    <span class="c1">// left/inner/natural/etc</span>
                <span class="s1">'SELECT ...'</span><span class="p">,</span>               <span class="c1">// the subselect to join on</span>
                <span class="s1">'subjoin'</span>                   <span class="c1">// AS this name</span>
                <span class="s1">'sub.id = foo.id'</span>           <span class="c1">// ON these conditions</span>
            <span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'bar &gt; :bar'</span><span class="p">)</span>           <span class="c1">// AND WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'zim = ?'</span><span class="p">,</span> <span class="s1">'zim_val'</span><span class="p">)</span>   <span class="c1">// bind 'zim_val' to the ? placeholder</span>
            <span class="o">-&gt;</span><span class="nf">orWhere</span><span class="p">(</span><span class="s1">'baz &lt; :baz'</span><span class="p">)</span>         <span class="c1">// OR WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">groupBy</span><span class="p">([</span><span class="s1">'dib'</span><span class="p">])</span>              <span class="c1">// GROUP BY these columns</span>
            <span class="o">-&gt;</span><span class="nf">having</span><span class="p">(</span><span class="s1">'foo = :foo'</span><span class="p">)</span>          <span class="c1">// AND HAVING these conditions</span>
            <span class="o">-&gt;</span><span class="nf">having</span><span class="p">(</span><span class="s1">'bar &gt; ?'</span><span class="p">,</span> <span class="s1">'bar_val'</span><span class="p">)</span>  <span class="c1">// bind 'bar_val' to the ? placeholder</span>
            <span class="o">-&gt;</span><span class="nf">orHaving</span><span class="p">(</span><span class="s1">'baz &lt; :baz'</span><span class="p">)</span>        <span class="c1">// OR HAVING these conditions</span>
            <span class="o">-&gt;</span><span class="nf">orderBy</span><span class="p">([</span><span class="s1">'baz'</span><span class="p">])</span>              <span class="c1">// ORDER BY these columns</span>
            <span class="o">-&gt;</span><span class="nf">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>                     <span class="c1">// LIMIT 10</span>
            <span class="o">-&gt;</span><span class="nf">offset</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>                    <span class="c1">// OFFSET 40</span>
            <span class="o">-&gt;</span><span class="nf">forUpdate</span><span class="p">()</span>                   <span class="c1">// FOR UPDATE</span>
            <span class="o">-&gt;</span><span class="nf">union</span><span class="p">()</span>                       <span class="c1">// UNION with a followup SELECT</span>
            <span class="o">-&gt;</span><span class="nf">unionAll</span><span class="p">()</span>                    <span class="c1">// UNION ALL with a followup SELECT</span>
            <span class="o">-&gt;</span><span class="nf">bindValue</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'foo_val'</span><span class="p">)</span>   <span class="c1">// bind one value to a placeholder</span>
            <span class="o">-&gt;</span><span class="nf">bindValues</span><span class="p">([</span>                  <span class="c1">// bind these values to named placeholders</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar_val'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz_val'</span><span class="p">,</span>
            <span class="p">]);</span>

        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">select</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">());</span>

        <span class="c1">// bind the values and execute</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">select</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">fetch</span><span class="p">(</span><span class="err">\</span><span class="no">PDO</span><span class="o">::</span><span class="no">FETCH_ASSOC</span><span class="p">);</span>
        <span class="c1">// or</span>
        <span class="c1">// $result = $this-&gt;pdo-&gt;fetchAssoc($stm, $bind);</span>
</code></pre></div></div>

<p>組み立てたクエリーは<code class="language-plaintext highlighter-rouge">getStatement()</code>で文字列にしてクエリーを行います。</p>

<h3 id="insert">INSERT</h3>

<h4 id="単一行のinsert">単一行のINSERT</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">User</span> <span class="n">extend</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ExtendedPdoInterface</span> <span class="nv">$pdo</span><span class="p">,</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">SelectInterface</span> <span class="nv">$select</span>
    <span class="p">)</span> <span class="p">{}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span>
            <span class="o">-&gt;</span><span class="nf">into</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>                   <span class="c1">// INTO this table</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>                        <span class="c1">// bind values as "(col) VALUES (:col)"</span>
                <span class="s1">'bar'</span><span class="p">,</span>
                <span class="s1">'baz'</span><span class="p">,</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">)</span>            <span class="c1">// raw value as "(ts) VALUES (NOW())"</span>
            <span class="o">-&gt;</span><span class="nf">bindValue</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'foo_val'</span><span class="p">)</span>   <span class="c1">// bind one value to a placeholder</span>
            <span class="o">-&gt;</span><span class="nf">bindValues</span><span class="p">([</span>                  <span class="c1">// bind these values</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'foo'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'zim'</span><span class="p">,</span>
            <span class="p">]);</span>

        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">());</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>
        <span class="c1">// or</span>
        <span class="c1">// $sth = $this-&gt;pdo-&gt;perform($this-&gt;insert-&gt;getStatement(), this-&gt;insert-&gt;getBindValues());</span>

        <span class="c1">// get the last insert ID</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">getLastInsertIdName</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">lastInsertId</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">cols()</code>メソッドはキーがコラム名、値をバインドする値にした連想配列を渡すこともできます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span>
            <span class="o">-&gt;</span><span class="nf">into</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>                   <span class="c1">// insert into this table</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>                        <span class="c1">// insert these columns and bind these values</span>
                <span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="s1">'foo_value'</span><span class="p">,</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar_value'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz_value'</span><span class="p">,</span>
            <span class="p">]);</span>
</code></pre></div></div>

<h4 id="複数行のinsert">複数行のINSERT</h4>

<p>複数の行のINSERTを行うためには、最初の行の最後で<code class="language-plaintext highlighter-rouge">addRow()</code>メソッドを使います。その後に次のクエリーを組み立てます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">// insert into this table</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">into</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">);</span>

        <span class="c1">// set up the first row</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>
            <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-0'</span><span class="p">,</span>
            <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-0'</span>
        <span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">);</span>

        <span class="c1">// set up the second row. the columns here are in a different order</span>
        <span class="c1">// than in the first row, but it doesn't matter; the INSERT object</span>
        <span class="c1">// keeps track and builds them the same order as the first row.</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">addRow</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>
            <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-1'</span><span class="p">,</span>
            <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-1'</span>
        <span class="p">]);</span>

        <span class="c1">// set up further rows ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">addRow</span><span class="p">();</span>
        <span class="c1">// ...</span>

        <span class="c1">// execute a bulk insert of all rows</span>
        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">());</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>

</code></pre></div></div>

<blockquote>
  <p>注:最初の行で始めて現れた列の値を指定しないで、行を追加しようとすると例外が投げられます。
<code class="language-plaintext highlighter-rouge">addRow()</code>に列の連想配列を渡すと次の行で使われます。つまり最初の行で<code class="language-plaintext highlighter-rouge">col()</code>や<code class="language-plaintext highlighter-rouge">cols()</code>を指定しないこともできます。</p>
</blockquote>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">// set up the first row</span>
        <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">addRow</span><span class="p">([</span>
            <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-0'</span><span class="p">,</span>
            <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-0'</span>
        <span class="p">]);</span>
        <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">);</span>

        <span class="c1">// set up the second row</span>
        <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">addRow</span><span class="p">([</span>
            <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-1'</span><span class="p">,</span>
            <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-1'</span>
        <span class="p">]);</span>
        <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">);</span>

        <span class="c1">// etc.</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">addRows()</code>を使ってデータベースを一度にセットすることもできます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nv">$rows</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-0'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-0'</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-1'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-1'</span>
            <span class="p">],</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">addRows</span><span class="p">(</span><span class="nv">$rows</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="update">UPDATE</h3>
<p>下記のメソッドを使ってUPDATEクエリーを組み立てます。 メソッドに特定の順番はなく複数回呼ぶことこともできます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">update</span>
            <span class="o">-&gt;</span><span class="nf">table</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>                  <span class="c1">// update this table</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>                        <span class="c1">// bind values as "SET bar = :bar"</span>
                <span class="s1">'bar'</span><span class="p">,</span>
                <span class="s1">'baz'</span><span class="p">,</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">)</span>            <span class="c1">// raw value as "(ts) VALUES (NOW())"</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'zim = :zim'</span><span class="p">)</span>           <span class="c1">// AND WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'gir = ?'</span><span class="p">,</span> <span class="s1">'doom'</span><span class="p">)</span>      <span class="c1">// bind this value to the condition</span>
            <span class="o">-&gt;</span><span class="nf">orWhere</span><span class="p">(</span><span class="s1">'gir = :gir'</span><span class="p">)</span>         <span class="c1">// OR WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">bindValue</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'bar_val'</span><span class="p">)</span>   <span class="c1">// bind one value to a placeholder</span>
            <span class="o">-&gt;</span><span class="nf">bindValues</span><span class="p">([</span>                  <span class="c1">// bind these values to the query</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="mi">99</span><span class="p">,</span>
                <span class="s1">'zim'</span> <span class="o">=&gt;</span> <span class="s1">'dib'</span><span class="p">,</span>
                <span class="s1">'gir'</span> <span class="o">=&gt;</span> <span class="s1">'doom'</span><span class="p">,</span>
            <span class="p">]);</span>
        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$update</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">())</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">update</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>
        <span class="c1">// or</span>
        <span class="c1">// $sth = $this-&gt;pdo-&gt;perform($this-&gt;update-&gt;getStatement(), $this-&gt;update-&gt;getBindValues());</span>
</code></pre></div></div>

<p>キーを列名、値をバインドされた値（RAW値ではなりません）にした連想配列を<code class="language-plaintext highlighter-rouge">cols()</code>に渡すこともできます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
        <span class="nv">$this</span><span class="o">-</span><span class="n">update</span><span class="o">-&gt;</span><span class="nf">table</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>          <span class="c1">// update this table</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>                        <span class="c1">// update these columns and bind these values</span>
                <span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="s1">'foo_value'</span><span class="p">,</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar_value'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz_value'</span><span class="p">,</span>
            <span class="p">]);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<h3 id="delete">DELETE</h3>
<p>下記のメソッドを使ってDELETEクエリーを組み立てます。 メソッドに特定の順番はなく複数回呼ぶことこともできます。</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">delete</span>
            <span class="o">-&gt;</span><span class="nf">from</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>                   <span class="c1">// FROM this table</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'zim = :zim'</span><span class="p">)</span>           <span class="c1">// AND WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'gir = ?'</span><span class="p">,</span> <span class="s1">'doom'</span><span class="p">)</span>      <span class="c1">// bind this value to the condition</span>
            <span class="o">-&gt;</span><span class="nf">orWhere</span><span class="p">(</span><span class="s1">'gir = :gir'</span><span class="p">)</span>         <span class="c1">// OR WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">bindValue</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'bar_val'</span><span class="p">)</span>   <span class="c1">// bind one value to a placeholder</span>
            <span class="o">-&gt;</span><span class="nf">bindValues</span><span class="p">([</span>                  <span class="c1">// bind these values to the query</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="mi">99</span><span class="p">,</span>
                <span class="s1">'zim'</span> <span class="o">=&gt;</span> <span class="s1">'dib'</span><span class="p">,</span>
                <span class="s1">'gir'</span> <span class="o">=&gt;</span> <span class="s1">'doom'</span><span class="p">,</span>
            <span class="p">]);</span>
        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$update</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">())</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">delete</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>
</code></pre></div></div>

<h3 id="パジネーション">パジネーション</h3>

<p><a href="https://packagist.org/packages/ray/aura-sql-module">ray/aura-sql-module</a>はRay.Sqlの生SQL、Ray.AuraSqlQueryのクエリービルダー双方でパジネーション（ページ分割）をサポートしています。
バインドする値と１ページあたりのアイテム数、それに{page}をページ番号にしたuri_templateでページャーファクトリーを<code class="language-plaintext highlighter-rouge">newInstance()</code>で生成して、ページ番号で配列アクセスします。</p>

<h4 id="aurasql用">Aura.Sql用</h4>
<p>AuraSqlPagerFactoryInterface</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* @var $factory \Ray\AuraSqlModule\Pagerfanta\AuraSqlPagerFactoryInterface */</span>
<span class="nv">$pager</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="nf">newInstance</span><span class="p">(</span><span class="nv">$pdo</span><span class="p">,</span> <span class="nv">$sql</span><span class="p">,</span> <span class="nv">$params</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">'/?page={page}&amp;category=sports'</span><span class="p">);</span> <span class="c1">// 10 items per page</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nv">$pager</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// page 2</span>
<span class="cm">/* @var $page \Ray\AuraSqlModule\Pagerfanta\Page */</span>
<span class="c1">// $page-&gt;data // sliced data (array|\Traversable)</span>
<span class="c1">// $page-&gt;current; (int)</span>
<span class="c1">// $page-&gt;total (int)</span>
<span class="c1">// $page-&gt;hasNext (bool)</span>
<span class="c1">// $page-&gt;hasPrevious (bool)</span>
<span class="c1">// $page-&gt;maxPerPage; (int)</span>
<span class="c1">// (string) $page // pager html (string)</span>
</code></pre></div></div>

<h4 id="aurasqlquery用">Aura.SqlQuery用</h4>
<p>AuraSqlQueryPagerFactoryInterface</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// for Select</span>
<span class="cm">/* @var $factory \Ray\AuraSqlModule\Pagerfanta\AuraSqlQueryPagerFactoryInterface */</span>
<span class="nv">$pager</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="nf">newInstance</span><span class="p">(</span><span class="nv">$pdo</span><span class="p">,</span> <span class="nv">$select</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">'/?page={page}&amp;category=sports'</span><span class="p">);</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nv">$pager</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// page 2</span>
<span class="cm">/* @var $page \Ray\AuraSqlModule\Pagerfanta\Page */</span>
</code></pre></div></div>
<blockquote>
  <p>注：Aura.Sqlは生SQLを直接編集していますが現在MySql形式のLIMIT句しか対応していません。</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">$page</code>はイテレータブルです。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">foreach</span> <span class="p">(</span><span class="nv">$page</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
 <span class="c1">// 各行の処理</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ページャーのリンクHTMLのテンプレートを変更するには<code class="language-plaintext highlighter-rouge">TemplateInterface</code>の束縛を変更します。
テンプレート詳細に関しては<a href="https://github.com/whiteoctober/Pagerfanta#views">Pagerfanta</a>をご覧ください。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Pagerfanta\View\Template\TemplateInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Pagerfanta\View\Template\TwitterBootstrap3Template</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\Annotation\PagerViewOption</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ..</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">TemplateInterface</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nc">TwitterBootstrap3Template</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">PagerViewOption</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="nv">$pagerViewOption</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h1 id="cakedb">CakeDb</h1>

<p><strong>CakeDb</strong>はアクティブレコードとデータマッパーパターンのアイデアを使ったORMで、素早くシンプルにORMを使うことができます。CakePHP3で提供されているORMと同じものです。</p>

<p>composerで<code class="language-plaintext highlighter-rouge">Ray.CakeDbModule</code>をインストールします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require ray/cake-database-module ~1.0
</code></pre></div></div>

<p>インストールの方法については<a href="https://github.com/ray-di/Ray.CakeDbModule">Ray.CakeDbModule</a>を、ORMの利用には<a href="http://book.cakephp.org/3.0/en/orm.html">CakePHP3 Database Access &amp; ORM</a>をご覧ください。</p>

<p>Ray.CakeDbModuleはCakePHP3のORMを開発したJose(<a href="https://github.com/lorenzo">@lorenzo</a>)さんにより提供されています。</p>

<h1 id="doctrine-dbal">Doctrine DBAL</h1>

<p><a href="http://www.doctrine-project.org/projects/dbal.html">Doctrine DBAL</a>はDoctrineが提供しているデータベースの抽象化レイヤーです。</p>

<p>composerで<code class="language-plaintext highlighter-rouge">Ray.DbalModule</code>をインストールします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require ray/dbal-module
</code></pre></div></div>

<p>アプリケーションモジュールで<code class="language-plaintext highlighter-rouge">DbalModule</code>をインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\DbalModule\DbalModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">DbalModule</span><span class="p">(</span><span class="s1">'driver=pdo_sqlite&amp;memory=true'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>これでDIの設定が整いました。
<code class="language-plaintext highlighter-rouge">DbalInject</code>トレイトを利用すると<code class="language-plaintext highlighter-rouge">$this-&gt;db</code>にDBオブジェクトがインジェクトされます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\DbalModule\DbalInject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">DbalInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">;</span> <span class="c1">// \Doctrine\DBAL\Driver\Connection</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="複数db">複数DB</h3>

<p>複数のデータベースの接続には二番目の引数に識別子を指定します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">DbalModule</span><span class="p">(</span><span class="nv">$logDsn</span><span class="p">,</span> <span class="s1">'log_db'</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">DbalModule</span><span class="p">(</span><span class="nv">$jobDsn</span><span class="p">,</span> <span class="s1">'job_db'</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @Inject
 * @Named("log_db")
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">setLogDb</span><span class="p">(</span><span class="kt">Connection</span> <span class="nv">$logDb</span><span class="p">)</span>
</code></pre></div></div>

<p><a href="http://www.doctrine-project.org/api/dbal/2.0/class-Doctrine.DBAL.Connections.MasterSlaveConnection.html">MasterSlaveConnection</a>というリプリケーションのためのマスター／スレーブ接続が標準で用意されています。</p>

<h1 id="raymediaquery">Ray.MediaQuery</h1>

<p><code class="language-plaintext highlighter-rouge">Ray.MediaQuery</code>はDBやWeb APIなどの外部メディアのクエリーのインターフェイスから、クエリー実行オブジェクトを生成しインジェクトします。</p>

<ul>
  <li>ドメイン層とインフラ層の境界を明確にします。</li>
  <li>ボイラープレートコードを削減します。</li>
  <li>外部メディアの実体には無関係なので、後からストレージを変更することができます。並列開発やスタブ作成が容易です。</li>
</ul>

<h2 id="インストール-2">インストール</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ composer require ray/media-query
</code></pre></div></div>

<h2 id="利用方法-1">利用方法</h2>

<p>メディアアクセスするインターフェイスを定義します。</p>

<h3 id="データベースの場合">データベースの場合</h3>

<p><code class="language-plaintext highlighter-rouge">DbQuery</code>属性でSQLのIDを指定します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">TodoAddInterface</span>
<span class="p">{</span>
    <span class="c1">#[DbQuery('user_add')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">add</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$title</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="web-apiの場合">Web APIの場合</h3>

<p><code class="language-plaintext highlighter-rouge">WebQuery</code>属性でWeb APIのIDを指定します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">PostItemInterface</span>
<span class="p">{</span>
    <span class="c1">#[WebQuery('user_item')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">get</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">array</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>APIパスリストのファイルを<code class="language-plaintext highlighter-rouge">media_query.json</code>として作成します。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://ray-di.github.io/Ray.MediaQuery/schema/web_query.json"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"webQuery"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user_item"</span><span class="p">,</span><span class="w"> </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w"> </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://{domain}/users/{id}"</span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>MediaQueryModuleは、<code class="language-plaintext highlighter-rouge">DbQueryConfig</code>や<code class="language-plaintext highlighter-rouge">WebQueryConfig</code>、またはその両方の設定でSQLやWeb APIリクエストの実行をインターフェイスに束縛します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\MediaQuery\ApiDomainModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\MediaQuery\DbQueryConfig</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\MediaQuery\MediaQueryModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\MediaQuery\Queries</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\MediaQuery\WebQueryConfig</span><span class="p">;</span>

<span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">():</span> <span class="kt">void</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
        <span class="k">new</span> <span class="nc">MediaQueryModule</span><span class="p">(</span>
            <span class="nc">Queries</span><span class="o">::</span><span class="nf">fromDir</span><span class="p">(</span><span class="s1">'/path/to/queryInterface'</span><span class="p">),[</span>
                <span class="k">new</span> <span class="nc">DbQueryConfig</span><span class="p">(</span><span class="s1">'/path/to/sql'</span><span class="p">),</span>
                <span class="k">new</span> <span class="nc">WebQueryConfig</span><span class="p">(</span><span class="s1">'/path/to/web_query.json'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'domain'</span> <span class="o">=&gt;</span> <span class="s1">'api.exmaple.com'</span><span class="p">])</span>
            <span class="p">],</span>
        <span class="p">),</span>
    <span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AuraSqlModule</span><span class="p">(</span><span class="s1">'mysql:host=localhost;dbname=test'</span><span class="p">,</span> <span class="s1">'username'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>MediaQueryModuleはAuraSqlModuleのインストールが必要です。</p>

<h3 id="注入">注入</h3>

<p>インターフェイスからオブジェクトが直接生成され、インジェクトされます。実装クラスのコーディングが不要です。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Todo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="nc">TodoAddInterface</span> <span class="nv">$todoAdd</span>
    <span class="p">)</span> <span class="p">{}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">add</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$title</span><span class="p">):</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">todoAdd</span><span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$title</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="dbquery">DbQuery</h3>

<p>SQL実行がメソッドにマップされ、IDで指定されたSQLをメソッドの引数でバインドして実行します。
例えばIDが<code class="language-plaintext highlighter-rouge">todo_item</code>の指定では<code class="language-plaintext highlighter-rouge">todo_item.sql</code>SQL文に<code class="language-plaintext highlighter-rouge">['id =&gt; $id]</code>をバインドして実行します。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">$sqlDir</code>ディレクトリにSQLファイルを用意します。</li>
  <li>SQLファイルには複数のSQL文が記述できます。最後の行のSELECTが返り値になります。</li>
</ul>

<h4 id="entity">Entity</h4>

<ul>
  <li>SQL実行結果を用意したエンティティクラスを<code class="language-plaintext highlighter-rouge">entity</code>で指定して変換 (hydrate)することができます。</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">TodoItemInterface</span>
<span class="p">{</span>
    <span class="c1">#[DbQuery('todo_item', entity: Todo::class)]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">getItem</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">Todo</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="kd">class</span> <span class="nc">Todo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="nv">$title</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>プロパティをキャメルケースに変換する場合には<code class="language-plaintext highlighter-rouge">CameCaseTrait</code>を使います。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\MediaQuery\CamelCaseTrait</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Invoice</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">CamelCaseTrait</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$userName</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>コンストラクタがあると、フェッチしたデータでコールされます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="kd">class</span> <span class="nc">Todo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">public</span> <span class="n">string</span> <span class="nv">$id</span><span class="p">,</span>
        <span class="kt">public</span> <span class="n">string</span> <span class="nv">$title</span>
    <span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>
<h4 id="type-row">type: ‘row’</h4>

<p>SQL実行の戻り値が単一行ならの<code class="language-plaintext highlighter-rouge">type: 'row'</code>のアトリビュートを指定します。しかしインターフェイスの戻り値がエンティティクラスなら省略することができます。<sup id="fnref:v0dot5" role="doc-noteref"><a href="#fn:v0dot5" class="footnote" rel="footnote">10</a></sup></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** 返り値がEntityの場合 */</span>
<span class="kd">interface</span> <span class="nc">TodoItemInterface</span>
<span class="p">{</span>
    <span class="c1">#[DbQuery('todo_item', entity: Todo::class)]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">getItem</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">Todo</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** 返り値がarrayの場合 */</span>
<span class="kd">interface</span> <span class="nc">TodoItemInterface</span>
<span class="p">{</span>
    <span class="c1">#[DbQuery('todo_item', entity: Todo::class, type: 'row')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">getItem</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">array</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="web-api">Web API</h3>

<ul>
  <li>メソッドの引数が <code class="language-plaintext highlighter-rouge">uri</code>で指定されたURI templateにバインドされ、Web APIリクエストオブジェクトが生成されます。</li>
  <li>認証のためのヘッダーなどのカスタムはGuzzleの<code class="language-plaintext highlighter-rouge">ClinetInterface</code>をバインドして行います。</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">ClientInterface</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toProvider</span><span class="p">(</span><span class="nc">YourGuzzleClientProvider</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="パラメーター">パラメーター</h2>

<h3 id="日付時刻">日付時刻</h3>

<p>パラメーターにバリューオブジェクトを渡すことができます。
例えば、<code class="language-plaintext highlighter-rouge">DateTimeInterface</code>オブジェクトをこのように指定できます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">TaskAddInterface</span>
<span class="p">{</span>
    <span class="c1">#[DbQuery('task_add')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$title</span><span class="p">,</span> <span class="kt">DateTimeInterface</span> <span class="nv">$cratedAt</span> <span class="o">=</span> <span class="kc">null</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>値はSQL実行時やWeb APIリクエスト時に日付フォーマットされた文字列に変換されます。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">task</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">created_at</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(:</span><span class="n">title</span><span class="p">,</span> <span class="p">:</span><span class="n">createdAt</span><span class="p">);</span> <span class="o">#</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">14</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
</code></pre></div></div>

<p>値を渡さないとバインドされている現在時刻がインジェクションされます。
SQL内部で<code class="language-plaintext highlighter-rouge">NOW()</code>とハードコーディングする事や、毎回現在時刻を渡す手間を省きます。</p>

<h3 id="テスト時刻">テスト時刻</h3>
<p>テストの時には以下のように<code class="language-plaintext highlighter-rouge">DateTimeInterface</code>の束縛を１つの時刻にする事もできます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">DateTimeInterface</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nc">UnixEpochTime</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="vo">VO</h3>

<p><code class="language-plaintext highlighter-rouge">DateTime</code>以外のバリューオブジェクトが渡されると<code class="language-plaintext highlighter-rouge">toScalar</code>インターフェイスを実装した<code class="language-plaintext highlighter-rouge">toScalar()</code>メソッド、もしくは<code class="language-plaintext highlighter-rouge">__toString()</code>メソッドの返り値が引数になります。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">MemoAddInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$memo</span><span class="p">,</span> <span class="kt">UserId</span> <span class="nv">$userId</span> <span class="o">=</span> <span class="kc">null</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">UserId</span> <span class="kd">implements</span> <span class="nc">ToScalarInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="nc">LoginUser</span> <span class="nv">$user</span><span class="p">;</span>
    <span class="p">){}</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">toScalar</span><span class="p">():</span> <span class="kt">int</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">memo</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(:</span><span class="n">user_id</span><span class="p">,</span> <span class="p">:</span><span class="n">memo</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="パラメーターインジェクション">パラメーターインジェクション</h3>

<p>バリューオブジェクトの引数のデフォルトの値の<code class="language-plaintext highlighter-rouge">null</code>がSQLやWebリクエストで使われることは無い事に注意してください。値が渡されないと、nullの代わりにパラメーターの型でインジェクトされたバリューオブジェクトのスカラー値が使われます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">(</span><span class="kt">Uuid</span> <span class="nv">$uuid</span> <span class="o">=</span> <span class="kc">null</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span> <span class="c1">// UUIDが生成され渡される</span>
</code></pre></div></div>

<h2 id="ページネーション">ページネーション</h2>

<p>DBの場合、<code class="language-plaintext highlighter-rouge">#[Pager]</code>属性でSELECTクエリーをページングする事ができます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\MediaQuery\PagesInterface</span><span class="p">;</span>

<span class="kd">interface</span> <span class="nc">TodoList</span>
<span class="p">{</span>
    <span class="c1">#[DbQuery, Pager(perPage: 10, template: '/{?page}')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">():</span> <span class="kt">PagesInterface</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">count()</code>で件数が取得でき、ページ番号で配列アクセスをするとページオブジェクトが取得できます。
<code class="language-plaintext highlighter-rouge">Pages</code>はSQL遅延実行オブジェクトです。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$pages</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$todoList</span><span class="p">)();</span>
<span class="nv">$cnt</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$pages</span><span class="p">);</span> <span class="c1">// count()をした時にカウントSQLが生成されクエリーが行われます。</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nv">$pages</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// 配列アクセスをした時にそのページのDBクエリーが行われます。</span>

<span class="c1">// $page-&gt;data // sliced data</span>
<span class="c1">// $page-&gt;current;</span>
<span class="c1">// $page-&gt;total</span>
<span class="c1">// $page-&gt;hasNext</span>
<span class="c1">// $page-&gt;hasPrevious</span>
<span class="c1">// $page-&gt;maxPerPage;</span>
<span class="c1">// (string) $page // pager html</span>
</code></pre></div></div>

<h2 id="sqlquery">SqlQuery</h2>

<p><code class="language-plaintext highlighter-rouge">SqlQuery</code>はSQLファイルのIDを指定してSQLを実行します。
実装クラスを用意して詳細な実装を行う時に使用します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TodoItem</span> <span class="kd">implements</span> <span class="nc">TodoItemInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="nc">SqlQueryInterface</span> <span class="nv">$sqlQuery</span>
    <span class="p">){}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">)</span> <span class="p">:</span> <span class="kt">array</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sqlQuery</span><span class="o">-&gt;</span><span class="nf">getRow</span><span class="p">(</span><span class="s1">'todo_item'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="get-メソッド">Get* メソッド</h2>

<p>SELECT結果を取得するためには取得する結果に応じた<code class="language-plaintext highlighter-rouge">get*</code>を使います。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$sqlQuery</span><span class="o">-&gt;</span><span class="nf">getRow</span><span class="p">(</span><span class="nv">$queryId</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span> <span class="c1">// 結果が単数行</span>
<span class="nv">$sqlQuery</span><span class="o">-&gt;</span><span class="nf">getRowList</span><span class="p">(</span><span class="nv">$queryId</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span> <span class="c1">// 結果が複数行</span>
<span class="nv">$statement</span> <span class="o">=</span> <span class="nv">$sqlQuery</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">();</span> <span class="c1">// PDO Statementを取得</span>
<span class="nv">$pages</span> <span class="o">=</span> <span class="nv">$sqlQuery</span><span class="o">-&gt;</span><span class="nf">getPages</span><span class="p">();</span> <span class="c1">// ページャーを取得</span>
</code></pre></div></div>

<p>Ray.MediaQueryは<a href="https://github.com/ray-di/Ray.AuraSqlModule">Ray.AuraSqlModule</a> を含んでいます。
さらに低レイヤーの操作が必要な時はAura.Sqlの<a href="https://github.com/ray-di/Ray.AuraSqlModule#query-builder">Query Builder</a> やPDOを拡張した<a href="https://github.com/auraphp/Aura.Sql">Aura.Sql</a> のExtended PDOをお使いください。
<a href="https://github.com/ray-di/Ray.DbalModule">doctrine/dbal</a> も利用できます。</p>

<p>Parameter Injectionと同様、<code class="language-plaintext highlighter-rouge">DateTimeIntetface</code>オブジェクトを渡すと日付フォーマットされた文字列に変換されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$sqlQuery</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'memo_add'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'memo'</span> <span class="o">=&gt;</span> <span class="s1">'run'</span><span class="p">,</span> <span class="s1">'created_at'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">DateTime</span><span class="p">()]);</span>
</code></pre></div></div>

<p>他のオブジェクトが渡されると<code class="language-plaintext highlighter-rouge">toScalar()</code>または<code class="language-plaintext highlighter-rouge">__toString()</code>の値に変換されます。</p>

<h2 id="プロファイラー">プロファイラー</h2>

<p>メディアアクセスはロガーで記録されます。標準ではテストに使うメモリロガーがバインドされています。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">testAdd</span><span class="p">():</span> <span class="kt">void</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sqlQuery</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'todo_add'</span><span class="p">,</span> <span class="nv">$todoRun</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertStringContainsString</span><span class="p">(</span><span class="s1">'query: todo_add({"id":"1","title":"run"})'</span><span class="p">,</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>独自の<a href="src/MediaQueryLoggerInterface.php">MediaQueryLoggerInterface</a>を実装して、
各メディアクエリーのベンチマークを行ったり、インジェクトしたPSRロガーでログをする事もできます。</p>

<h2 id="アノテーション--アトリビュート">アノテーション / アトリビュート</h2>

<p>属性を表すのに<a href="https://github.com/doctrine/annotations/">doctrineアノテーション</a> 、<a href="https://www.php.net/manual/ja/language.attributes.overview.php">アトリビュート</a> どちらも利用できます。 次の2つは同じものです。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\MediaQuery\Annotation\DbQuery</span><span class="p">;</span>

<span class="c1">#[DbQuery('user_add')]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">add1</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$title</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>

<span class="cd">/** @DbQuery("user_add") */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">add2</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$title</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
</code></pre></div></div>
<hr />

<h1 id="データベース-1">データベース</h1>

<p>データベースライブラリの利用のため<code class="language-plaintext highlighter-rouge">Aura.Sql</code>、<code class="language-plaintext highlighter-rouge">Doctrine DBAL</code>, <code class="language-plaintext highlighter-rouge">CakeDB</code>などのモジュールが用意されています。</p>

<h2 id="aurasql-1">Aura.Sql</h2>

<p><a href="https://github.com/auraphp/Aura.Sql">Aura.Sql</a>はPHPのPDOを拡張したデータベースライブラリです。</p>

<h3 id="インストール-3">インストール</h3>

<p>composerで<code class="language-plaintext highlighter-rouge">Ray.AuraSqlModule</code>をインストールします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require ray/aura-sql-module
</code></pre></div></div>

<p>アプリケーションモジュール<code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code>で<code class="language-plaintext highlighter-rouge">AuraSqlModule</code>をインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\AppMeta\AppMeta</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\PackageModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlModule</span><span class="p">;</span> <span class="c1">// この行を追加</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
          <span class="k">new</span> <span class="nc">AuraSqlModule</span><span class="p">(</span>
            <span class="s1">'mysql:host=localhost;dbname=test'</span><span class="p">,</span>
            <span class="s1">'username'</span><span class="p">,</span>
            <span class="s1">'password'</span><span class="p">,</span>
            <span class="c1">// $options,</span>
            <span class="c1">// $attributes</span>
          <span class="p">)</span>
        <span class="p">);</span>  <span class="c1">// この行を追加</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">PackageModule</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>これでDIの設定が整いました。コンストラクタや<code class="language-plaintext highlighter-rouge">AuraSqlInject</code>トレイトを利用して<code class="language-plaintext highlighter-rouge">PDO</code>を拡張したDBオブジェクト<code class="language-plaintext highlighter-rouge">ExtendedPDO</code>を受け取ります。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Aura\Sql\ExtendedPdoInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">ExtendedPdoInterface</span> <span class="nv">$pdo</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// \Aura\Sql\ExtendedPdo</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlInject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">AuraSqlInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// \Aura\Sql\ExtendedPdo</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Ray.AuraSqlModule</code>は<a href="https://github.com/auraphp/Aura.SqlQuery">Aura.SqlQuery</a>を含んでいてMySQLやPostgresなどのSQLを組み立てるのに利用できます。</p>

<h3 id="perform-メソッド-1">perform() メソッド</h3>

<p><code class="language-plaintext highlighter-rouge">perform()</code>メソッドは、1つのプレイスホルダーしかないSQLに配列の値をバインドすることが出来ます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$stm</span> <span class="o">=</span> <span class="s1">'SELECT * FROM test WHERE foo IN (:foo)'</span>
<span class="nv">$array</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'baz'</span><span class="p">];</span>
</code></pre></div></div>

<p>既存のPDOの場合</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// the native PDO way does not work (PHP Notice:  Array to string conversion)</span>
<span class="c1">// ネイティブのPDOでは`:foo`に配列を指定することは出来ません</span>
<span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$stm</span><span class="p">);</span>
<span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">bindValue</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="nv">$array</span><span class="p">);</span>
</code></pre></div></div>

<p>Aura.SqlのExtendedPDOの場合</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$stm</span> <span class="o">=</span> <span class="s1">'SELECT * FROM test WHERE foo IN (:foo)'</span>
<span class="nv">$values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'baz'</span><span class="p">]];</span>
<span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">perform</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$values</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">:foo</code>に<code class="language-plaintext highlighter-rouge">['foo', 'bar', 'baz']</code>がバインドがされます。<code class="language-plaintext highlighter-rouge">queryString</code>で実際のクエリーを調べることが出来ます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">echo</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">queryString</span><span class="p">;</span>
<span class="c1">// the query string has been modified by ExtendedPdo to become</span>
<span class="c1">// "SELECT * FROM test WHERE foo IN ('foo', 'bar', 'baz')"</span>
</code></pre></div></div>

<h3 id="fetch-メソッド-1">fetch*() メソッド</h3>

<p><code class="language-plaintext highlighter-rouge">prepare()</code>、<code class="language-plaintext highlighter-rouge">bindValue()</code>、 <code class="language-plaintext highlighter-rouge">execute()</code>を繰り返してデータベースから値を取得する代わりに<code class="language-plaintext highlighter-rouge">fetch*()</code>メソッドを使うとボイラープレートコードを減らすことができます。
（内部では<code class="language-plaintext highlighter-rouge">perform()</code>メソッドを実行しているので配列のプレースフォルもサポートしています）</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$stm</span>  <span class="o">=</span> <span class="s1">'SELECT * FROM test WHERE foo = :foo AND bar = :bar'</span><span class="p">;</span>
<span class="nv">$bind</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="s1">'baz'</span><span class="p">,</span> <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'dib'</span><span class="p">);</span>
<span class="c1">// ネイティブのPDOで"fetch all"を行う場合</span>
<span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PDO</span><span class="p">(</span><span class="mf">...</span><span class="p">);</span>
<span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$stm</span><span class="p">);</span>
<span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$bind</span><span class="p">);</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">fetchAll</span><span class="p">(</span><span class="no">PDO</span><span class="o">::</span><span class="no">FETCH_ASSOC</span><span class="p">);</span>

<span class="c1">// ExtendedPdoで"fetch all"を行う場合</span>
<span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExtendedPdo</span><span class="p">(</span><span class="mf">...</span><span class="p">);</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchAll</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">);</span>

<span class="c1">// fetchAssoc()は全ての行がコラム名のキーを持つ連想配列が返ります。</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchAssoc</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">);</span>

<span class="c1">// fetchGroup() is like fetchAssoc() except that the values aren't wrapped in</span>
<span class="c1">// arrays. Instead, single column values are returned as a single dimensional</span>
<span class="c1">// array and multiple columns are returned as an array of arrays</span>
<span class="c1">// Set style to PDO::FETCH_NAMED when values are an array</span>
<span class="c1">// (i.e. there are more than two columns in the select)</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchGroup</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">,</span> <span class="nv">$style</span> <span class="o">=</span> <span class="no">PDO</span><span class="o">::</span><span class="no">FETCH_COLUMN</span><span class="p">)</span>

<span class="c1">// fetchOne()は最初の行をキーをコラム名にした連想配列で返します。</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchOne</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">);</span>

<span class="c1">// fetchPairs()は最初の列の値をキーに二番目の列の値を値にした連想配列を返します  </span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchPairs</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">);</span>

<span class="c1">// fetchValue()は最初の列の値を返します。</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchValue</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">);</span>

<span class="c1">// fetchAffected()は影響を受けた行数を返します。</span>
<span class="nv">$stm</span> <span class="o">=</span> <span class="s2">"UPDATE test SET incr = incr + 1 WHERE foo = :foo AND bar = :bar"</span><span class="p">;</span>
<span class="nv">$row_count</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchAffected</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">fetchAll()</code>, <code class="language-plaintext highlighter-rouge">fetchAssoc()</code>, <code class="language-plaintext highlighter-rouge">fetchCol()</code>, 及び <code class="language-plaintext highlighter-rouge">fetchPairs()</code>のメソッドは三番目のオプションの引数に、それぞれの列に適用されるコールバックを指定することができます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$result</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchAssoc</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="o">&amp;</span><span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// add a column to the row</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">'my_new_col'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Added this column from the callable.'</span><span class="p">;</span>
<span class="p">});</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<h3 id="yield-メソッド-1">yield*() メソッド</h3>

<p>メモリを節約するために<code class="language-plaintext highlighter-rouge">yield*()</code>メソッドを使うことができます。 <code class="language-plaintext highlighter-rouge">fetch*()</code>メソッドは全ての行を一度に取得しますが、
<code class="language-plaintext highlighter-rouge">yield*()</code>メソッドはイテレーターが返ります。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$stm</span>  <span class="o">=</span> <span class="s1">'SELECT * FROM test WHERE foo = :foo AND bar = :bar'</span><span class="p">;</span>
<span class="nv">$bind</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="s1">'baz'</span><span class="p">,</span> <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'dib'</span><span class="p">);</span>

<span class="c1">// fetchAll()のように行は連想配列です</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">yieldAll</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// fetchAssoc()のようにキーが最初の列名で行が連想配列です。</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">yieldAssoc</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// fetchCol()のように最初の列が値になった値を返します。</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">yieldCol</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// fetchPairs()と同様に最初の列からキー/バリューのペアの値を返します。</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">yieldPairs</span><span class="p">(</span><span class="nv">$stm</span><span class="p">,</span> <span class="nv">$bind</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="リプリケーション-1">リプリケーション</h3>

<p>マスター／スレーブの接続を自動で行うためには4つ目の引数にスレーブDBのIPを指定します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
  <span class="k">new</span> <span class="nc">AuraSqlModule</span><span class="p">(</span>
    <span class="s1">'mysql:host=localhost;dbname=test'</span><span class="p">,</span>
    <span class="s1">'username'</span><span class="p">,</span>
    <span class="s1">'password'</span><span class="p">,</span>
    <span class="s1">'slave1,slave2'</span> <span class="c1">// スレーブIPをカンマ区切りで指定</span>
  <span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<p>これでHTTPリクエストがGETの時がスレーブDB、その他のメソッドの時はマスターDBのDBオブジェクトがコンスタラクタに渡されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Aura\Sql\ExtendedPdoInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="no">PDO</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$pdo</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">ExtendedPdoInterface</span> <span class="nv">$pdo</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
    <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// slave db</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="nv">$todo</span><span class="p">)</span>
    <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// master db</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">@ReadOnlyConnection</code>、<code class="language-plaintext highlighter-rouge">@WriteConnection</code>でアノテートされたメソッドはメソッド名に関わらず、呼ばれた時にアノテーションに応じたDBオブジェクトが<code class="language-plaintext highlighter-rouge">$this-&gt;pdo</code>に上書きされます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\Annotation\ReadOnlyConnection</span><span class="p">;</span>  <span class="c1">// important</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\Annotation\WriteConnection</span><span class="p">;</span>     <span class="c1">// important</span>

<span class="kd">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$pdo</span><span class="p">;</span> <span class="c1">// @ReadOnlyConnectionや@WriteConnectionのメソッドが呼ばれた時に上書きされる</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="nv">$todo</span><span class="p">)</span>
    <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">read</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @ReadOnlyConnection
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">read</span><span class="p">()</span>
    <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// slave db</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @WriteConnection
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">write</span><span class="p">()</span>
    <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="p">;</span> <span class="c1">// master db</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="複数db-1">複数DB</h3>

<p>接続先の違う複数の<code class="language-plaintext highlighter-rouge">PdoExtendedInterface</code>オブジェクトを受け取るためには
<code class="language-plaintext highlighter-rouge">@Named</code>アノテーションで指定します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @Inject
 * @Named("log_db")
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">setLoggerDb</span><span class="p">(</span><span class="kt">ExtendedPdoInterface</span> <span class="nv">$pdo</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>モジュールでは<code class="language-plaintext highlighter-rouge">NamedPdoModule</code>で識別子を指定して束縛します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
  <span class="k">new</span> <span class="nc">NamedPdoModule</span><span class="p">(</span>
    <span class="s1">'log_db'</span><span class="p">,</span> <span class="c1">// @Namedで指定するデータベースの種類</span>
    <span class="s1">'mysql:host=localhost;dbname=log'</span><span class="p">,</span>
    <span class="s1">'username'</span><span class="p">,</span>
    <span class="s1">'pass'</span><span class="p">,</span>
    <span class="s1">'slave1,slave12'</span>
  <span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<h3 id="トランザクション-1">トランザクション</h3>

<p><code class="language-plaintext highlighter-rouge">@Transactional</code>とアノテートしたメソッドはトランザクション管理されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\Annotation\Transactional</span><span class="p">;</span>

<span class="c1">// ....</span>
    <span class="cd">/**
     * @Transactional
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">write</span><span class="p">()</span>
    <span class="p">{</span>
         <span class="c1">// 例外発生したら\Ray\AuraSqlModule\Exception\RollbackExceptionに</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>複数接続したデータベースのトランザクションを行うためには<code class="language-plaintext highlighter-rouge">@Transactional</code>アノテーションにプロパティを指定します。
指定しない場合は<code class="language-plaintext highlighter-rouge">{"pdo"}</code>になります。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @Transactional({"pdo", "userDb"})
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">write</span><span class="p">()</span>
</code></pre></div></div>

<p>以下のように実行されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">beginTransaction</span><span class="p">()</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">userDb</span><span class="o">-&gt;</span><span class="nf">beginTransaction</span><span class="p">()</span>

<span class="c1">// ...</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">commit</span><span class="p">();</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">userDb</span><span class="o">-&gt;</span><span class="nf">commit</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="aurasqlquery-1">Aura.SqlQuery</h2>

<p><a href="https://github.com/auraphp/Aura.Sql">Aura.Sql</a>はPDOを拡張したライブラリですが、<a href="https://github.com/auraphp/Aura.SqlQuery">Aura.SqlQuery</a>は MySQL、Postgres,、SQLiteあるいは Microsoft SQL Serverといったデータベース固有のSQLのビルダーを提供します。</p>

<p>データベースを指定してアプリケーションモジュール<code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code>でインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AuraSqlQueryModule</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">));</span> <span class="c1">// pgsql, sqlite, or sqlsrv</span>
</code></pre></div></div>

<h3 id="select-1">SELECT</h3>

<p>リソースではDBクエリービルダオブジェクトを受け取り、下記のメソッドを使ってSELECTクエリーを組み立てます。
メソッドに特定の順番はなく複数回呼ぶことこともできます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlInject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlSelectInject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">User</span> <span class="n">extend</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">AuraSqlInject</span><span class="p">;</span>
    <span class="kn">use</span> <span class="nc">AuraSqlSelectInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">select</span>
            <span class="o">-&gt;</span><span class="nf">distinct</span><span class="p">()</span>                    <span class="c1">// SELECT DISTINCT</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>                        <span class="c1">// select these columns</span>
                <span class="s1">'id'</span><span class="p">,</span>                       <span class="c1">// column name</span>
                <span class="s1">'name AS namecol'</span><span class="p">,</span>          <span class="c1">// one way of aliasing</span>
                <span class="s1">'col_name'</span> <span class="o">=&gt;</span> <span class="s1">'col_alias'</span><span class="p">,</span>  <span class="c1">// another way of aliasing</span>
                <span class="s1">'COUNT(foo) AS foo_count'</span>   <span class="c1">// embed calculations directly</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">from</span><span class="p">(</span><span class="s1">'foo AS f'</span><span class="p">)</span>              <span class="c1">// FROM these tables</span>
            <span class="o">-&gt;</span><span class="nf">fromSubselect</span><span class="p">(</span>                <span class="c1">// FROM sub-select AS my_sub</span>
                <span class="s1">'SELECT ...'</span><span class="p">,</span>
                <span class="s1">'my_sub'</span>
            <span class="p">)</span>
            <span class="o">-&gt;</span><span class="nb">join</span><span class="p">(</span>                         <span class="c1">// JOIN ...</span>
                <span class="s1">'LEFT'</span><span class="p">,</span>                     <span class="c1">// left/inner/natural/etc</span>
                <span class="s1">'doom AS d'</span>                 <span class="c1">// this table name</span>
                <span class="s1">'foo.id = d.foo_id'</span>         <span class="c1">// ON these conditions</span>
            <span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">joinSubSelect</span><span class="p">(</span>                <span class="c1">// JOIN to a sub-select</span>
                <span class="s1">'INNER'</span><span class="p">,</span>                    <span class="c1">// left/inner/natural/etc</span>
                <span class="s1">'SELECT ...'</span><span class="p">,</span>               <span class="c1">// the subselect to join on</span>
                <span class="s1">'subjoin'</span>                   <span class="c1">// AS this name</span>
                <span class="s1">'sub.id = foo.id'</span>           <span class="c1">// ON these conditions</span>
            <span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'bar &gt; :bar'</span><span class="p">)</span>           <span class="c1">// AND WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'zim = ?'</span><span class="p">,</span> <span class="s1">'zim_val'</span><span class="p">)</span>   <span class="c1">// bind 'zim_val' to the ? placeholder</span>
            <span class="o">-&gt;</span><span class="nf">orWhere</span><span class="p">(</span><span class="s1">'baz &lt; :baz'</span><span class="p">)</span>         <span class="c1">// OR WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">groupBy</span><span class="p">([</span><span class="s1">'dib'</span><span class="p">])</span>              <span class="c1">// GROUP BY these columns</span>
            <span class="o">-&gt;</span><span class="nf">having</span><span class="p">(</span><span class="s1">'foo = :foo'</span><span class="p">)</span>          <span class="c1">// AND HAVING these conditions</span>
            <span class="o">-&gt;</span><span class="nf">having</span><span class="p">(</span><span class="s1">'bar &gt; ?'</span><span class="p">,</span> <span class="s1">'bar_val'</span><span class="p">)</span>  <span class="c1">// bind 'bar_val' to the ? placeholder</span>
            <span class="o">-&gt;</span><span class="nf">orHaving</span><span class="p">(</span><span class="s1">'baz &lt; :baz'</span><span class="p">)</span>        <span class="c1">// OR HAVING these conditions</span>
            <span class="o">-&gt;</span><span class="nf">orderBy</span><span class="p">([</span><span class="s1">'baz'</span><span class="p">])</span>              <span class="c1">// ORDER BY these columns</span>
            <span class="o">-&gt;</span><span class="nf">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>                     <span class="c1">// LIMIT 10</span>
            <span class="o">-&gt;</span><span class="nf">offset</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>                    <span class="c1">// OFFSET 40</span>
            <span class="o">-&gt;</span><span class="nf">forUpdate</span><span class="p">()</span>                   <span class="c1">// FOR UPDATE</span>
            <span class="o">-&gt;</span><span class="nf">union</span><span class="p">()</span>                       <span class="c1">// UNION with a followup SELECT</span>
            <span class="o">-&gt;</span><span class="nf">unionAll</span><span class="p">()</span>                    <span class="c1">// UNION ALL with a followup SELECT</span>
            <span class="o">-&gt;</span><span class="nf">bindValue</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'foo_val'</span><span class="p">)</span>   <span class="c1">// bind one value to a placeholder</span>
            <span class="o">-&gt;</span><span class="nf">bindValues</span><span class="p">([</span>                  <span class="c1">// bind these values to named placeholders</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar_val'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz_val'</span><span class="p">,</span>
            <span class="p">]);</span>

        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">select</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">());</span>

        <span class="c1">// bind the values and execute</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">select</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">fetch</span><span class="p">(</span><span class="err">\</span><span class="no">PDO</span><span class="o">::</span><span class="no">FETCH_ASSOC</span><span class="p">);</span>
        <span class="c1">// or</span>
        <span class="c1">// $result = $this-&gt;pdo-&gt;fetchAssoc($stm, $bind);</span>
</code></pre></div></div>

<p>組み立てたクエリーは<code class="language-plaintext highlighter-rouge">getStatement()</code>で文字列にしてクエリーを行います。</p>

<h3 id="insert-1">INSERT</h3>

<h4 id="単一行のinsert-1">単一行のINSERT</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlInject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlInsertInject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">User</span> <span class="n">extend</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">AuraSqlInject</span><span class="p">;</span>
    <span class="kn">use</span> <span class="nc">AuraSqlInsertInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span>
            <span class="o">-&gt;</span><span class="nf">into</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>                   <span class="c1">// INTO this table</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>                        <span class="c1">// bind values as "(col) VALUES (:col)"</span>
                <span class="s1">'bar'</span><span class="p">,</span>
                <span class="s1">'baz'</span><span class="p">,</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">)</span>            <span class="c1">// raw value as "(ts) VALUES (NOW())"</span>
            <span class="o">-&gt;</span><span class="nf">bindValue</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'foo_val'</span><span class="p">)</span>   <span class="c1">// bind one value to a placeholder</span>
            <span class="o">-&gt;</span><span class="nf">bindValues</span><span class="p">([</span>                  <span class="c1">// bind these values</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'foo'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'zim'</span><span class="p">,</span>
            <span class="p">]);</span>

        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">());</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>
        <span class="c1">// or</span>
        <span class="c1">// $sth = $this-&gt;pdo-&gt;perform($this-&gt;insert-&gt;getStatement(), this-&gt;insert-&gt;getBindValues());</span>

        <span class="c1">// get the last insert ID</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">getLastInsertIdName</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">lastInsertId</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">cols()</code>メソッドはキーがコラム名、値をバインドする値にした連想配列を渡すこともできます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span>
            <span class="o">-&gt;</span><span class="nf">into</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>                   <span class="c1">// insert into this table</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>                        <span class="c1">// insert these columns and bind these values</span>
                <span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="s1">'foo_value'</span><span class="p">,</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar_value'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz_value'</span><span class="p">,</span>
            <span class="p">]);</span>
</code></pre></div></div>

<h4 id="複数行のinsert-1">複数行のINSERT</h4>

<p>複数の行のINSERTを行うためには、最初の行の最後で<code class="language-plaintext highlighter-rouge">addRow()</code>メソッドを使います。その後に次のクエリーを組み立てます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">// insert into this table</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">into</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">);</span>

        <span class="c1">// set up the first row</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>
            <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-0'</span><span class="p">,</span>
            <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-0'</span>
        <span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">);</span>

        <span class="c1">// set up the second row. the columns here are in a different order</span>
        <span class="c1">// than in the first row, but it doesn't matter; the INSERT object</span>
        <span class="c1">// keeps track and builds them the same order as the first row.</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">addRow</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>
            <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-1'</span><span class="p">,</span>
            <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-1'</span>
        <span class="p">]);</span>

        <span class="c1">// set up further rows ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">addRow</span><span class="p">();</span>
        <span class="c1">// ...</span>

        <span class="c1">// execute a bulk insert of all rows</span>
        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">());</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>

</code></pre></div></div>

<blockquote>
  <p>注:最初の行で始めて現れた列の値を指定しないで、行を追加しようとすると例外が投げられます。
<code class="language-plaintext highlighter-rouge">addRow()</code>に列の連想配列を渡すと次の行で使われます。つまり最初の行で<code class="language-plaintext highlighter-rouge">col()</code>や<code class="language-plaintext highlighter-rouge">cols()</code>を指定しないこともできます。</p>
</blockquote>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">// set up the first row</span>
        <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">addRow</span><span class="p">([</span>
            <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-0'</span><span class="p">,</span>
            <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-0'</span>
        <span class="p">]);</span>
        <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">);</span>

        <span class="c1">// set up the second row</span>
        <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">addRow</span><span class="p">([</span>
            <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-1'</span><span class="p">,</span>
            <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-1'</span>
        <span class="p">]);</span>
        <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">);</span>

        <span class="c1">// etc.</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">addRows()</code>を使ってデータベースを一度にセットすることもできます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nv">$rows</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-0'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-0'</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar-1'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz-1'</span>
            <span class="p">],</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insert</span><span class="o">-&gt;</span><span class="nf">addRows</span><span class="p">(</span><span class="nv">$rows</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="update-1">UPDATE</h3>
<p>下記のメソッドを使ってUPDATEクエリーを組み立てます。 メソッドに特定の順番はなく複数回呼ぶことこともできます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">update</span>
            <span class="o">-&gt;</span><span class="nf">table</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>                  <span class="c1">// update this table</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>                        <span class="c1">// bind values as "SET bar = :bar"</span>
                <span class="s1">'bar'</span><span class="p">,</span>
                <span class="s1">'baz'</span><span class="p">,</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'NOW()'</span><span class="p">)</span>            <span class="c1">// raw value as "(ts) VALUES (NOW())"</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'zim = :zim'</span><span class="p">)</span>           <span class="c1">// AND WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'gir = ?'</span><span class="p">,</span> <span class="s1">'doom'</span><span class="p">)</span>      <span class="c1">// bind this value to the condition</span>
            <span class="o">-&gt;</span><span class="nf">orWhere</span><span class="p">(</span><span class="s1">'gir = :gir'</span><span class="p">)</span>         <span class="c1">// OR WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">bindValue</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'bar_val'</span><span class="p">)</span>   <span class="c1">// bind one value to a placeholder</span>
            <span class="o">-&gt;</span><span class="nf">bindValues</span><span class="p">([</span>                  <span class="c1">// bind these values to the query</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="mi">99</span><span class="p">,</span>
                <span class="s1">'zim'</span> <span class="o">=&gt;</span> <span class="s1">'dib'</span><span class="p">,</span>
                <span class="s1">'gir'</span> <span class="o">=&gt;</span> <span class="s1">'doom'</span><span class="p">,</span>
            <span class="p">]);</span>
        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$update</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">())</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">update</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>
        <span class="c1">// or</span>
        <span class="c1">// $sth = $this-&gt;pdo-&gt;perform($this-&gt;update-&gt;getStatement(), $this-&gt;update-&gt;getBindValues());</span>
</code></pre></div></div>

<p>キーを列名、値をバインドされた値（RAW値ではなりません）にした連想配列を<code class="language-plaintext highlighter-rouge">cols()</code>に渡すこともできます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
        <span class="nv">$this</span><span class="o">-</span><span class="n">update</span><span class="o">-&gt;</span><span class="nf">table</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>          <span class="c1">// update this table</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span>                        <span class="c1">// update these columns and bind these values</span>
                <span class="s1">'foo'</span> <span class="o">=&gt;</span> <span class="s1">'foo_value'</span><span class="p">,</span>
                <span class="s1">'bar'</span> <span class="o">=&gt;</span> <span class="s1">'bar_value'</span><span class="p">,</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="s1">'baz_value'</span><span class="p">,</span>
            <span class="p">]);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<h3 id="delete-1">DELETE</h3>
<p>下記のメソッドを使ってDELETEクエリーを組み立てます。 メソッドに特定の順番はなく複数回呼ぶことこともできます。</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">delete</span>
            <span class="o">-&gt;</span><span class="nf">from</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>                   <span class="c1">// FROM this table</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'zim = :zim'</span><span class="p">)</span>           <span class="c1">// AND WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'gir = ?'</span><span class="p">,</span> <span class="s1">'doom'</span><span class="p">)</span>      <span class="c1">// bind this value to the condition</span>
            <span class="o">-&gt;</span><span class="nf">orWhere</span><span class="p">(</span><span class="s1">'gir = :gir'</span><span class="p">)</span>         <span class="c1">// OR WHERE these conditions</span>
            <span class="o">-&gt;</span><span class="nf">bindValue</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'bar_val'</span><span class="p">)</span>   <span class="c1">// bind one value to a placeholder</span>
            <span class="o">-&gt;</span><span class="nf">bindValues</span><span class="p">([</span>                  <span class="c1">// bind these values to the query</span>
                <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="mi">99</span><span class="p">,</span>
                <span class="s1">'zim'</span> <span class="o">=&gt;</span> <span class="s1">'dib'</span><span class="p">,</span>
                <span class="s1">'gir'</span> <span class="o">=&gt;</span> <span class="s1">'doom'</span><span class="p">,</span>
            <span class="p">]);</span>
        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$update</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">())</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">delete</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>
</code></pre></div></div>

<h3 id="パジネーション-1">パジネーション</h3>

<p><a href="https://packagist.org/packages/ray/aura-sql-module">ray/aura-sql-module</a>はRay.Sqlの生SQL、Ray.AuraSqlQueryのクエリービルダー双方でパジネーション（ページ分割）をサポートしています。
バインドする値と１ページあたりのアイテム数、それに{page}をページ番号にしたuri_templateでページャーファクトリーを<code class="language-plaintext highlighter-rouge">newInstance()</code>で生成して、ページ番号で配列アクセスします。</p>

<h4 id="aurasql用-1">Aura.Sql用</h4>
<p>AuraSqlPagerFactoryInterface</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* @var $factory \Ray\AuraSqlModule\Pagerfanta\AuraSqlPagerFactoryInterface */</span>
<span class="nv">$pager</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="nf">newInstance</span><span class="p">(</span><span class="nv">$pdo</span><span class="p">,</span> <span class="nv">$sql</span><span class="p">,</span> <span class="nv">$params</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">'/?page={page}&amp;category=sports'</span><span class="p">);</span> <span class="c1">// 10 items per page</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nv">$pager</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// page 2</span>
<span class="cm">/* @var $page \Ray\AuraSqlModule\Pagerfanta\Page */</span>
<span class="c1">// $page-&gt;data // sliced data (array|\Traversable)</span>
<span class="c1">// $page-&gt;current; (int)</span>
<span class="c1">// $page-&gt;total (int)</span>
<span class="c1">// $page-&gt;hasNext (bool)</span>
<span class="c1">// $page-&gt;hasPrevious (bool)</span>
<span class="c1">// $page-&gt;maxPerPage; (int)</span>
<span class="c1">// (string) $page // pager html (string)</span>
</code></pre></div></div>

<h4 id="aurasqlquery用-1">Aura.SqlQuery用</h4>
<p>AuraSqlQueryPagerFactoryInterface</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// for Select</span>
<span class="cm">/* @var $factory \Ray\AuraSqlModule\Pagerfanta\AuraSqlQueryPagerFactoryInterface */</span>
<span class="nv">$pager</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="nf">newInstance</span><span class="p">(</span><span class="nv">$pdo</span><span class="p">,</span> <span class="nv">$select</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">'/?page={page}&amp;category=sports'</span><span class="p">);</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nv">$pager</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// page 2</span>
<span class="cm">/* @var $page \Ray\AuraSqlModule\Pagerfanta\Page */</span>
</code></pre></div></div>
<blockquote>
  <p>注：Aura.Sqlは生SQLを直接編集していますが現在MySql形式のLIMIT句しか対応していません。</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">$page</code>はイテレータブルです。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">foreach</span> <span class="p">(</span><span class="nv">$page</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
 <span class="c1">// 各行の処理</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ページャーのリンクHTMLのテンプレートを変更するには<code class="language-plaintext highlighter-rouge">TemplateInterface</code>の束縛を変更します。
テンプレート詳細に関しては<a href="https://github.com/whiteoctober/Pagerfanta#views">Pagerfanta</a>をご覧ください。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Pagerfanta\View\Template\TemplateInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Pagerfanta\View\Template\TwitterBootstrap3Template</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\Annotation\PagerViewOption</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ..</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">TemplateInterface</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nc">TwitterBootstrap3Template</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">PagerViewOption</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="nv">$pagerViewOption</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="di-1">DI</h1>

<p>依存性の注入(Dependency Injection)とは、基本的にオブジェクトが必要とするオブジェクト（依存）を、オブジェクト自身に構築させるのではなく、オブジェクトに提供することです。</p>

<p>依存性の注入では、オブジェクトはそのコンストラクタで依存性を受け取ります。オブジェクトを構築するには、まずそのオブジェクトの依存関係を構築しますが、それぞれの依存を構築するためにはそのまた依存が必要、とその繰り返しになります。つまり、オブジェクトを構築するにはオブジェクトグラフを構築する必要があるのです。</p>

<table>
  <tbody>
    <tr>
      <td>オブジェクトグラフとは？</td>
    </tr>
    <tr>
      <td>オブジェクト指向のアプリケーションは<strong>相互に関係のある複雑なオブジェクト網</strong>を持ちます。オブジェクトはあるオブジェクトから所有されているか、他のオブジェクト（またはそのリファレンス）を含んでいるか、そのどちらかでお互いに接続されています。このオブジェクト網をオブジェクトグラフと呼びます。- <a href="http://en.wikipedia.org/wiki/Object_graph">Wikipedia (en)</a></td>
    </tr>
  </tbody>
</table>

<p>オブジェクトグラフを手作業で構築することは、労力がかかり、ミスが発生しやすく、テストが困難になります。その代わりに、Dependency Injector (Ray.Di) がオブジェクトグラフを構築します。</p>

<p>Ray.Diは、BEAR.Sundayで使用されているDIフレームワークで、<a href="https://github.com/google/guice">Google Guice</a>に大きく影響されています。詳しくは<a href="https://ray-di.github.io/manuals/1.0/ja/index.html">Ray.Diのマニュアル</a>をご覧ください。</p>

<h1 id="examples">Examples</h1>

<p><a href="http://bearsunday.github.io/manuals/1.0/en/coding-guide.html">Coding Guide</a>に従って作られたアプリケーションの例です。</p>

<h2 id="polidogtodo">Polidog.Todo</h2>

<p><a href="https://github.com/koriym/Polidog.Todo">https://github.com/koriym/Polidog.Todo</a></p>

<p>基本的なCRUDのアプリケーションです。<code class="language-plaintext highlighter-rouge">var/sql</code>ディレクトリのSQLファイルでDBアクセスをしています。ハイパーリンクを使ったREST APIとテスト、それにフォームのバリデーションテストも含まれます。</p>

<ul>
  <li><a href="https://github.com/ray-di/Ray.AuraSqlModule">ray/aura-sql-module</a> - Extended PDO (<a href="https://github.com/auraphp/Aura.Sql">Aura.Sql</a>)</li>
  <li><a href="https://github.com/ray-di/Ray.WebFormModule">ray/web-form-module</a> - Web form (<a href="https://github.com/auraphp/Aura.Input">Aura.Input</a>)</li>
  <li><a href="https://github.com/madapaja/Madapaja.TwigModule">madapaja/twig-module</a> - Twig template engine</li>
  <li><a href="https://github.com/koriym/Koriym.Now">koriym/now</a> - Current datetime</li>
  <li><a href="https://github.com/koriym/Koriym.QueryLocator">koriym/query-locator</a> - SQL locator</li>
  <li><a href="https://github.com/koriym/Koriym.HttpConstants">koriym/http-constants</a> - Contains the values HTTP</li>
</ul>

<h2 id="myvendorcontactform">MyVendor.ContactForm</h2>

<p><a href="https://github.com/bearsunday/MyVendor.ContactForm">https://github.com/bearsunday/MyVendor.ContactForm</a></p>

<p>各種のフォームページのサンプルです。</p>

<ul>
  <li>最小限のフォーム</li>
  <li>複数のフォーム</li>
  <li>INPUTエレメントをループで生成したフォーム</li>
  <li>チェックボックス、ラジオボタンを含んだプレビュー付きのフォーム</li>
</ul>

<h1 id="フォーム">フォーム</h1>

<p><a href="https://github.com/auraphp/Aura.Input">Aura.Input</a>と<a href="https://github.com/auraphp/Aura.Filter">Aura.Filter</a>を使ったWebフォーム機能は
関連する機能が単体のクラスに集約され、テストや変更が容易です。１つのクラスでWebフォームとバリデーションのみの両方の用途に使えます。</p>

<h2 id="インストール-4">インストール</h2>

<p>Aura.Inputを使ったフォーム処理を追加するのにcomposerで<code class="language-plaintext highlighter-rouge">ray/web-form-module</code>をインストールします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require ray/web-form-module
</code></pre></div></div>

<p>アプリケーションモジュール<code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code>で<code class="language-plaintext highlighter-rouge">AuraInputModule</code>をインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebFormModule\WebFormModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AuraInputModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="webフォーム">Webフォーム</h2>

<p>フォーム要素の登録やルールを定めた<strong>フォームクラス</strong>を作成して、<code class="language-plaintext highlighter-rouge">@FormValidation</code>アノテーションを使って特定のメソッドと束縛します。
メソッドは送信されたデータがバリデーションOKのときのみ実行されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\WebFormModule\AbstractForm</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebFormModule\SetAntiCsrfTrait</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyForm</span> <span class="kd">extends</span> <span class="nc">AbstractForm</span>
<span class="p">{</span>
    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">init</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// set input fields</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">setField</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'text'</span><span class="p">)</span>
             <span class="o">-&gt;</span><span class="nf">setAttribs</span><span class="p">([</span>
                 <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="s1">'name'</span>
             <span class="p">]);</span>
        <span class="c1">// set rules and user defined error message</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="nf">validate</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">is</span><span class="p">(</span><span class="s1">'alnum'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="nf">useFieldMessage</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'Name must be alphabetic only.'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>フォームクラスの<code class="language-plaintext highlighter-rouge">init()</code>メソッドでフォームのinput要素を登録し、バリデーションのフィルターやサニタイズのルールを適用します。バリデーションルールに関してはAura.Filterの<a href="https://github.com/auraphp/Aura.Filter/blob/2.x/docs/validate.md">Rules To Validate Fields</a>、サニタイズに関しては<a href="https://github.com/auraphp/Aura.Filter/blob/2.x/docs/sanitize.md">Rules To Sanitize Fields</a>をご覧ください。</p>

<p>メソッドの引数を連想配列にしたもをバリデーションします。入力を変更したいときは
<code class="language-plaintext highlighter-rouge">SubmitInterface</code>インターフェイスの<code class="language-plaintext highlighter-rouge">submit()メソッド</code>を実装して入力にする値を返します。</p>

<h2 id="formvalidationアノテーション">@FormValidationアノテーション</h2>

<p>フォームのバリデーションを行うメソッドを<code class="language-plaintext highlighter-rouge">@FormValidation</code>でアノテートすると、実行前に<code class="language-plaintext highlighter-rouge">form</code>プロパティのフォームオブジェクトでバリデーションが行われます。
バリデーションに失敗するとメソッド名に<code class="language-plaintext highlighter-rouge">ValidationFailed</code>サフィックスをつけたメソッドが呼ばれます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Di\Di\Inject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\Di\Named</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebFormModule\Annotation\FormValidation</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebFormModule\FormInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyController</span>
<span class="p">{</span>
    <span class="cd">/**
     * @var FormInterface
     */</span>
    <span class="k">protected</span> <span class="nv">$form</span><span class="p">;</span>

    <span class="cd">/**
     * @Inject
     * @Named("contact_form")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">setForm</span><span class="p">(</span><span class="kt">FormInterface</span> <span class="nv">$form</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">form</span> <span class="o">=</span> <span class="nv">$form</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @FormValidation
     * // または
     * @FormValidation(form="form", onFailure="onPostValidationFailed")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$age</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// validation success</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onPostValidationFailed</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$age</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// validation failed</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">@FormValidation</code>アノテーションの<code class="language-plaintext highlighter-rouge">form</code>,<code class="language-plaintext highlighter-rouge">onValidationFailed</code>プロパティを変更して<code class="language-plaintext highlighter-rouge">form</code>プロパティの名前やメソッドの名前を明示的に指定こともできます。</p>

<p><code class="language-plaintext highlighter-rouge">onPostValidationFailed</code>にはサブミットされた値が渡されます。</p>

<h2 id="ビュー">ビュー</h2>

<p>フォームの<code class="language-plaintext highlighter-rouge">input</code>要素やエラーメッセージを取得するには要素名を指定します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$form</span><span class="o">-&gt;</span><span class="nf">input</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span> <span class="c1">// &lt;input id="name" type="text" name="name" size="20" maxlength="20" /&gt;</span>
  <span class="nv">$form</span><span class="o">-&gt;</span><span class="nf">error</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span> <span class="c1">// 文字列「名前には全角文字またはアルファベットを入力して下さい。」またはブランク</span>
</code></pre></div></div>

<p>テンプレートにTwigを使った場合でも同様です。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{{</span> <span class="n">form</span><span class="mf">.</span><span class="nf">input</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span> <span class="p">}}</span>
<span class="p">{{</span> <span class="n">form</span><span class="mf">.</span><span class="nf">error</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span> <span class="p">}}</span>
</code></pre></div></div>

<h2 id="csrf">CSRF</h2>

<p>CSRF(クロスサイトリクエストフォージェリ)対策を行うためにはフォームにCSRFオブジェクトをセットします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\WebFormModule\SetAntiCsrfTrait</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyForm</span> <span class="kd">extends</span> <span class="nc">AbstractAuraForm</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">SetAntiCsrfTrait</span><span class="p">;</span>
</code></pre></div></div>

<p>セキュリティレベルを高めるためには、ユーザーの認証を含んだカスタムCsrfクラスを作成してフォームクラスにセットします。
詳しくはAura.Inputの<a href="https://github.com/auraphp/Aura.Input#applying-csrf-protections">Applying CSRF Protections</a>をご覧ください。</p>

<h2 id="inputvalidation">@InputValidation</h2>

<p><code class="language-plaintext highlighter-rouge">@FormValidation</code>の代わりに<code class="language-plaintext highlighter-rouge">@InputValidation</code>とアノテートするとバリデーションが失敗したときに<code class="language-plaintext highlighter-rouge">Ray\WebFormModule\Exception\ValidationException</code>が投げられるようになります。
この場合はHTML表現は使われません。Web APIに便利です。</p>

<p>キャッチした例外の<code class="language-plaintext highlighter-rouge">error</code>プロパティを<code class="language-plaintext highlighter-rouge">echo</code>すると<a href="https://github.com/blongden/vnd.error">application/vnd.error+json</a>メディアタイプの表現が出力されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">http_response_code</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
<span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>

<span class="c1">// {</span>
<span class="c1">//     "message": "Validation failed",</span>
<span class="c1">//     "path": "/path/to/error",</span>
<span class="c1">//     "validation_messages": {</span>
<span class="c1">//         "name": [</span>
<span class="c1">//             "名前には全角文字またはアルファベットを入力して下さい。"</span>
<span class="c1">//         ]</span>
<span class="c1">//     }</span>
<span class="c1">// }</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">@VndError</code>アノテーションで<code class="language-plaintext highlighter-rouge">vnd.error+json</code>に必要な情報を加えることができます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @FormValidation(form="contactForm")
 * @VndError(
 *   message="foo validation failed",
 *   logref="a1000", path="/path/to/error",
 *   href={"_self"="/path/to/error", "help"="/path/to/help"}
 * )
 */</span>
 <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="vnd-error">Vnd Error</h2>

<p><code class="language-plaintext highlighter-rouge">Ray\WebFormModule\FormVndErrorModule</code>をインストールすると<code class="language-plaintext highlighter-rouge">@FormValidation</code>フォームとアノートしたメソッドも<code class="language-plaintext highlighter-rouge">@InputValidation</code>とアノテートしたメソッドと同じように例外を投げるようになります。
作成したPageリソースをAPIとして使うことが出来ます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebFormModule\FormVndErrorModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">FooModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AuraInputModule</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">override</span><span class="p">(</span><span class="k">new</span> <span class="nc">FormVndErrorModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="デモ">デモ</h2>

<p><a href="https://github.com/bearsunday/MyVendor.ContactForm">MyVendor.ContactForm</a>アプリケーションでフォームのデモを実行して試すことができます。
確認付きのフォームページや、複数のフォームを１ページに設置したときの例などが用意されています。</p>

<h1 id="html-qiq">HTML (Qiq)</h1>

<h2 id="セットアップ">セットアップ</h2>

<p>QiqでHTML表示をするためにcomposerで<code class="language-plaintext highlighter-rouge">bear/qiq-module</code>をインストールします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require bear/qiq-module
</code></pre></div></div>

<p>次にテンプレートやヘルパーを格納するディレクトリを用意します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /path/to/project
cp -r vendor/bear/qiq-module/var/qiq var
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">html</code>コンテキストファイル<code class="language-plaintext highlighter-rouge">src/Module/HtmlModule.php</code>を用意して<code class="language-plaintext highlighter-rouge">QiqModule</code>をインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">MyVendor\MyPackage\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\QiqModule\QiqModule</span><span class="p">;</span>


<span class="kd">class</span> <span class="nc">HtmlModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">QiqModule</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">appMeta</span><span class="o">-&gt;</span><span class="n">appDir</span> <span class="mf">.</span> <span class="s1">'/var/qiq/template'</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="コンテキスト変更">コンテキスト変更</h2>

<p><code class="language-plaintext highlighter-rouge">bin/page.php</code>のコンテキストを変更して<code class="language-plaintext highlighter-rouge">html</code>を有効にします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$context</span> <span class="o">=</span> <span class="s1">'cli-html-app'</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="テンプレート">テンプレート</h2>

<p>Indexリソースのテンプレートを<code class="language-plaintext highlighter-rouge">var/qiq/template/Page/Index.php</code>に用意します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;h1&gt;{{h $this-&gt;greeting }}&lt;/h1&gt;
</code></pre></div></div>

<p>ResourceObjectの<code class="language-plaintext highlighter-rouge">$body</code>がテンプレートに<code class="language-plaintext highlighter-rouge">$this</code>としてアサインされます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/page.php get /
200 OK
content-type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8

&lt;h1&gt;Hello BEAR.Sunday&lt;/h1&gt;
</code></pre></div></div>

<h2 id="カスタムヘルパー">カスタムヘルパー</h2>

<p><a href="https://qiqphp-ja.github.io/1.x/helpers/custom.html#1-8-4">カスタムヘルパー</a> は<code class="language-plaintext highlighter-rouge">Qiq\Helper\</code>のnamespaceで作成します。例: <code class="language-plaintext highlighter-rouge">Qiq\Helper\Foo</code></p>

<p>composer.jsonの<code class="language-plaintext highlighter-rouge">autoload</code>に<code class="language-plaintext highlighter-rouge">Qiq\Helper</code>を指定し(例: <a href="https://github.com/bearsunday/BEAR.QiqModule/blob/1.x/demo/composer.json#L26">composer.json</a>) 、<code class="language-plaintext highlighter-rouge">composer dump-autoload</code>を実行してヘルパークラスをオートロード可能にします。指定ディレクトリに設置するとカスタムヘルパーが利用可能になります。</p>

<h2 id="prodmodule">ProdModule</h2>

<p>プロダクション用にエラーページをHTMLにし、コンパイラキャッシュを有効にするためのモジュールをProdModuleでインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ProdModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">QiqErrorModule</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">QiqProdModule</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">appDir</span> <span class="mf">.</span> <span class="s1">'/var/tmp'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="html-twig-v1">HTML (Twig v1)</h1>

<p>HTML表示のためにcomposerで<code class="language-plaintext highlighter-rouge">madapaja/twig-module</code>をインストールします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require madapaja/twig-module ^1.0
</code></pre></div></div>

<p>次に<code class="language-plaintext highlighter-rouge">html</code>コンテキストファイル<code class="language-plaintext highlighter-rouge">src/Module/HtmlModule.php</code>を用意して<code class="language-plaintext highlighter-rouge">TwigModule</code>をインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">MyVendor\MyPackage\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\AppMeta\AppMeta</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\TwigModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\AbstractModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">HtmlModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">bin/page.php</code>のコンテキストを変更して<code class="language-plaintext highlighter-rouge">html</code>を有効にします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$context</span> <span class="o">=</span> <span class="s1">'cli-html-app'</span><span class="p">;</span>
</code></pre></div></div>
<p>リソースのPHPファイル名に<code class="language-plaintext highlighter-rouge">.html.twig</code>拡張子をつけたファイルでテンプレートを用意します。
<code class="language-plaintext highlighter-rouge">Page/Index.php</code>に対応するのは<code class="language-plaintext highlighter-rouge">Page/Index.html.twig</code>になります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;h1&gt;{{ greeting }}&lt;/h1&gt;
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">$body</code>がテンプレートにアサインされて出力されます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/page.php get /
200 OK
content-type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8

&lt;h1&gt;Hello BEAR.Sunday&lt;/h1&gt;
</code></pre></div></div>

<p>レイアウトや部分的なテンプレートファイルは<code class="language-plaintext highlighter-rouge">var/lib/twig</code>に設置します。</p>

<h2 id="カスタム設定">カスタム設定</h2>

<p>コンテンキストに応じてオプション等を設定したり、テンプレートのパスを追加したりする場合は
<code class="language-plaintext highlighter-rouge">@TwigPaths</code>と<code class="language-plaintext highlighter-rouge">@TwigOptions</code>に設定値を束縛します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">MyVendor\MyPackage\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\Annotation\TwigOptions</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\Annotation\TwigPaths</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\TwigModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\AbstractModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigModule</span><span class="p">());</span>

        <span class="c1">// twig テンプレートパスを追加</span>
        <span class="nv">$appDir</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">));</span>
        <span class="nv">$paths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/src/Resource'</span><span class="p">,</span>
            <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/var/lib/twig'</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">TwigPaths</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="nv">$paths</span><span class="p">);</span>

        <span class="c1">// 環境のオプションを設定することも可能</span>
        <span class="c1">// @see http://twig.sensiolabs.org/doc/api.html#environment-options</span>
        <span class="nv">$options</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'debug'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
            <span class="s1">'cache'</span> <span class="o">=&gt;</span> <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/tmp'</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">TwigOptions</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="他のテンプレートエンジン">他のテンプレートエンジン</h2>

<p>テンプレートエンジンは選択できるだけでなく、複数のテンプレートエンジンをリソース単位で選択することもできます。</p>

<h1 id="html-twig-v2">HTML (Twig v2)</h1>

<h2 id="インストール-5">インストール</h2>

<p>HTML表示のためにcomposerで<a href="https://twig.symfony.com/doc/2.x/">Twig v2</a>のモジュールをインストールします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require madapaja/twig-module ^2.0
</code></pre></div></div>

<p>次に<code class="language-plaintext highlighter-rouge">html</code>コンテキストファイル<code class="language-plaintext highlighter-rouge">src/Module/HtmlModule.php</code>を用意して<code class="language-plaintext highlighter-rouge">TwigModule</code>をインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">MyVendor\MyPackage\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\TwigErrorPageModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\TwigModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\AbstractModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">HtmlModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigModule</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigErrorPageModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">TwigErrorPageModule</code>はエラー表示をHTMLで行うオプションです。<code class="language-plaintext highlighter-rouge">HtmlModule</code>でインストールしないで<code class="language-plaintext highlighter-rouge">ProdModule</code>でインストールして開発時のエラー表示はJSONにすることも出来ます。</p>

<p>次に<code class="language-plaintext highlighter-rouge">templates</code>フォルダをコピーします</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> <span class="nt">-r</span> vendor/madapaja/twig-module/var/templates var/templates
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">bin/page.php</code>や<code class="language-plaintext highlighter-rouge">public/index.php</code>のコンテキストを変更して<code class="language-plaintext highlighter-rouge">html</code>を有効にします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$context</span> <span class="o">=</span> <span class="s1">'cli-html-app'</span><span class="p">;</span> // <span class="s1">'html-app'</span>
</code></pre></div></div>
<h2 id="テンプレート-1">テンプレート</h2>

<p>1つのリソースクラスに１つのテンプレートファイルが<code class="language-plaintext highlighter-rouge">var/templates</code>フォルダに必要です。
例えば<code class="language-plaintext highlighter-rouge">src/Page/Index.php</code>には<code class="language-plaintext highlighter-rouge">var/templates/Page/Index.html.twig</code> が必要です。</p>

<p>テンプレートにリソースの <strong>body</strong>がアサインされます。</p>

<p>例）</p>

<p><code class="language-plaintext highlighter-rouge">src/Page/Index.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$body</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'greeting'</span> <span class="o">=&gt;</span> <span class="s1">'Hello BEAR.Sunday'</span>
    <span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">src/Page/Index.twig.php</code> または <code class="language-plaintext highlighter-rouge">var/templates/Page/Index.twig.php</code></p>

<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">greeting</span> <span class="cp">}}</span><span class="nt">&lt;/h1&gt;</span>
</code></pre></div></div>

<p>出力</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/page.php get /
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
content-type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8

&lt;h1&gt;Hello BEAR.Sunday&lt;/h1&gt;
</code></pre></div></div>

<h2 id="テンプレートファイルの選択">テンプレートファイルの選択</h2>

<p>どのテンプレートを使用するかはリソースでは選択しません。リソースの状態によって<code class="language-plaintext highlighter-rouge">include</code>します。</p>

<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.is_login</span> <span class="cp">%}</span>
    <span class="cp">{{</span> <span class="nv">include</span><span class="p">(</span><span class="s1">'member.html.twig'</span><span class="p">)</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
    <span class="cp">{{</span> <span class="nv">include</span><span class="p">(</span><span class="s1">'guest.html.twig'</span><span class="p">)</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
</code></pre></div></div>

<p>リソースクラスはリソース状態だけに関心を持ち、テンプレートだけがリソース表現に関心を持ちます。
このような設計原則を<a href="https://ja.wikipedia.org/wiki/%E9%96%A2%E5%BF%83%E3%81%AE%E5%88%86%E9%9B%A2">関心の分離(SoC)</a>といいます。</p>

<h2 id="エラーページ">エラーページ</h2>

<p><code class="language-plaintext highlighter-rouge">var/templates/error.html.twig</code>を編集します。エラーページには以下の値がアサインされています。</p>

<table>
  <tbody>
    <tr>
      <td>変数</td>
      <td>意味</td>
      <td>キー</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>status</td>
      <td>HTTP ステータス</td>
      <td>code, message</td>
    </tr>
    <tr>
      <td>e</td>
      <td>例外</td>
      <td>code, message, class</td>
    </tr>
    <tr>
      <td>logref</td>
      <td>ログID</td>
      <td>n/a</td>
    </tr>
  </tbody>
</table>

<p>例</p>

<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'layout/base.html.twig'</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}{{</span> <span class="nv">status.code</span> <span class="cp">}}</span> <span class="cp">{{</span> <span class="nv">status.message</span> <span class="cp">}}{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
    <span class="nt">&lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">status.code</span> <span class="cp">}}</span> <span class="cp">{{</span> <span class="nv">status.message</span> <span class="cp">}}</span><span class="nt">&lt;/h1&gt;</span>
    <span class="cp">{%</span> <span class="k">if</span> <span class="nv">status.code</span> <span class="o">==</span> <span class="nv">404</span> <span class="cp">%}</span>
        <span class="nt">&lt;p&gt;</span>The requested URL was not found on this server.<span class="nt">&lt;/p&gt;</span>
    <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
        <span class="nt">&lt;p&gt;</span>The server is temporarily unable to service your request.<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>refference number: <span class="cp">{{</span> <span class="nv">logref</span> <span class="cp">}}</span><span class="nt">&lt;/p&gt;</span>
    <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</code></pre></div></div>

<h2 id="リソースのアサイン">リソースのアサイン</h2>

<p>リソースクラスのプロパティを参照するにはリソース全体がアサインされる<code class="language-plaintext highlighter-rouge">_ro</code>を参照します。</p>

<p>例）</p>

<p><code class="language-plaintext highlighter-rouge">Todos.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Todos</span> <span class="n">extend</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$code</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$text</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'BEAR'</span>
    <span class="p">];</span>

    <span class="k">public</span> <span class="nv">$body</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'run'</span><span class="p">]</span>
    <span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Todos.html.twig</code></p>

<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{{</span> <span class="nv">_ro.code</span> <span class="cp">}}</span> // 200
<span class="cp">{{</span> <span class="nv">_ro.text.name</span> <span class="cp">}}</span> // 'BEAR'
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">todo</span> <span class="ow">in</span> <span class="nv">_ro.body</span> <span class="cp">%}</span>
  <span class="cp">{{</span> <span class="nv">todo.title</span> <span class="cp">}}</span> // 'run'
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</code></pre></div></div>

<h2 id="ビューの階層構造">ビューの階層構造</h2>

<p>リソースクラス単位でビューを持つ事ができます。構造を良く表し、キャッシュもリソース単位で行われるので効率的です。</p>

<p>例）<code class="language-plaintext highlighter-rouge">app://self/todos</code>を読み込む<code class="language-plaintext highlighter-rouge">page://self/index</code></p>

<h3 id="appselftodos">app://self/todos</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Todos</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">AuraSqlInject</span><span class="p">;</span>
    <span class="kn">use</span> <span class="nc">QueryLocatorInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">fetchAll</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">[</span><span class="s1">'todos_list'</span><span class="p">]);</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{%</span> <span class="k">for</span> <span class="nv">todo</span> <span class="ow">in</span> <span class="nv">_ro.body</span> <span class="cp">%}</span>
  <span class="cp">{{</span> <span class="nv">todo.title</span> <span class="cp">}}</span><span class="nt">&lt;/td&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</code></pre></div></div>

<h3 id="pageselfindex">page://self/index</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="cd">/**
     * @Embed(rel="todos", src="app://self/todos")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'layout/base.html.twig'</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
  <span class="cp">{{</span> <span class="nv">todos</span><span class="o">|</span><span class="nf">raw</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</code></pre></div></div>
<h2 id="拡張">拡張</h2>
<p>Twigを<code class="language-plaintext highlighter-rouge">addExtension()</code>メソッドで拡張する場合には、拡張を行うTwigのProviderクラスを用意し<code class="language-plaintext highlighter-rouge">Twig_Environment</code>クラスに<code class="language-plaintext highlighter-rouge">Provider</code>束縛します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Di\Di\Named</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\ProviderInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyTwigProvider</span> <span class="kd">implements</span> <span class="nc">ProviderInterface</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$twig</span><span class="p">;</span>

    <span class="cd">/**
     * @Named("original")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="err">\</span><span class="n">Twig_Environment</span> <span class="nv">$twig</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// $twig is an original \Twig_Environment instance</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">twig</span> <span class="o">=</span> <span class="nv">$twig</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">get</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Extending Twig</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">twig</span><span class="o">-&gt;</span><span class="nf">addExtension</span><span class="p">(</span><span class="k">new</span> <span class="nc">MyTwigExtension</span><span class="p">());</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">twig</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">HtmlModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigModule</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="err">\</span><span class="n">Twig_Environment</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toProvider</span><span class="p">(</span><span class="nc">MyTwigProvider</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">in</span><span class="p">(</span><span class="nc">Scope</span><span class="o">::</span><span class="no">SINGLETON</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="モバイル">モバイル</h2>

<p>モバイルサイト専用のテンプレートを使用するためには<code class="language-plaintext highlighter-rouge">MobileTwigModule</code>を加えてインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">HtmlModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigModule</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">MobileTwigModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">index.html.twig</code>の代わりに<code class="language-plaintext highlighter-rouge">Index.mobile.twig</code>が <strong>存在すれば</strong>優先して使用されます。変更の必要なテンプレートだけを用意する事ができます。</p>

<h2 id="カスタム設定-1">カスタム設定</h2>

<p>コンテンキストに応じてオプション等を設定したり、テンプレートのパスを追加する場合は<code class="language-plaintext highlighter-rouge">@TwigPaths</code>と<code class="language-plaintext highlighter-rouge">@TwigOptions</code>に設定値を束縛します。</p>

<p>注）キャッシュを常に<code class="language-plaintext highlighter-rouge">var/tmp</code>フォルダに生成するので特にプロダクション用の設定などは特に必要ありません。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">MyVendor\MyPackage\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\Annotation\TwigDebug</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\Annotation\TwigOptions</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\Annotation\TwigPaths</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Madapaja\TwigModule\TwigModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\AbstractModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigModule</span><span class="p">);</span>

        <span class="c1">// テンプレートパスの指定</span>
        <span class="nv">$appDir</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">appMeta</span><span class="o">-&gt;</span><span class="n">appDir</span><span class="p">;</span>
        <span class="nv">$paths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/src/Resource'</span><span class="p">,</span>
            <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/var/templates'</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">TwigPaths</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="nv">$paths</span><span class="p">);</span>

        <span class="c1">// オプション</span>
        <span class="c1">// @see http://twig.sensiolabs.org/doc/api.html#environment-options</span>
        <span class="nv">$options</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'debug'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
            <span class="s1">'cache'</span> <span class="o">=&gt;</span> <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/tmp'</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">TwigOptions</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
        
        <span class="c1">// debugオプションのみを指定する場合</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">TwigDebug</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="html">HTML</h1>

<p>HTML表現のために以下のテンプレートエンジンが利用可能です。</p>

<ul>
  <li><a href="html-twig-v1.html">Twig v1</a></li>
  <li><a href="html-twig-v2.html">Twig v2</a></li>
  <li><a href="html-qiq.html">Qiq</a></li>
</ul>

<h2 id="twig-vs-qiq">Twig vs Qiq</h2>

<p><a href="https://twig.symfony.com">Twig</a>は最初のリリースが2009年にされ多くのユーザーがいます。<a href="https://qiqphp-ja.github.io">Qiq</a>は2021年にリリースされた新しいテンプレートエンジンです。</p>

<p>Twigが暗黙的エスケープをデフォルトにし制御構造などをTwig独自構文にしています。それに対して、Qiqは明示的なエスケープを要求し、PHP構文が基本のテンプレートです。 Twigのコードベースは大きく機能も豊富ですがそれに対してQiqはコンパクトでシンプルです。 （冗長になりますがQiqを完全なPHP構文で記述するとIDEや静的解析フレンドリーになります。）</p>

<h3 id="構文比較">構文比較</h3>

<p>PHP</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?=</span> <span class="nv">$var</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$var</span><span class="p">,</span> <span class="no">ENT_QUOTES</span><span class="o">|</span><span class="no">ENT_DISALLOWED</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">)</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nf">helper</span><span class="p">(</span><span class="nv">$var</span><span class="p">,</span> <span class="no">ENT_QUOTES</span><span class="o">|</span><span class="no">ENT_DISALLOWED</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">))</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$users</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
 * <span class="cp">&lt;?=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>
</code></pre></div></div>

<p>Twig</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{{ var | raw }}
{{ var }}
{{ var | helper }}
{% for user in users %}
  * {{ user.name }}
{% endfor %}
</code></pre></div></div>

<p>Qiq</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{{% var }}
{{h $var }}
{{h helper($var) }}
{{ foreach($users =&gt; $user) }}
  * {{h $user-&gt;name }}
{{ endforeach }}

{{ var }} // 表示されない
</code></pre></div></div>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="cd">/** @var Template $this */</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">h</span><span class="p">(</span><span class="nv">$var</span><span class="p">)</span> <span class="cp">?&gt;</span>
</code></pre></div></div>

<h2 id="レンダラー">レンダラー</h2>

<p><code class="language-plaintext highlighter-rouge">RenderInetrface</code>にバインドされResourceObjectにインジェクトされるレンダラーがリソースの表現を生成します。リソース自身はその表現に関して無関心です。</p>

<p>リソース単位でインジェクトされるので、複数のテンプレートエンジンを同時に使うこともできます。</p>

<h1 id="httpキャッシュ">HTTPキャッシュ</h1>

<p><a href="https://triple-underscore.github.io/RFC2616-ja.html#section-13">RFC2616 Hypertext Transfer Protocol (HTTP/1.1): Caching</a>ではHTTPキャッシュの目的を以下のように定めています。</p>

<blockquote>
  <p>HTTP/1.1 のキャッシングの目的は<strong>リクエストを送る必要を無くしたり、全レスポンスを送る必要を無くす事</strong>です。</p>
</blockquote>

<p>BEAR.Sundayでは<code class="language-plaintext highlighter-rouge">@Cacheable</code>アノテーションによるサーバーサイドでのキャッシュが仕組みがありますが、これを<a href="https://triple-underscore.github.io/RFC7234-ja.html">RFC7234 HTTPキャッシュ</a>にも適用してネットワークキャッシュ（クライアントサイドキャッシュ）をサポートします。</p>

<p>REST標準のキャッシュ制約に従う事で<strong>RFC7234</strong>をサポートしたHTTPクライアントでは、クラアイントでのコーディングなしにクライアントサイドキャッシュやキャッシュサーバーの使用が可能になります。</p>

<h2 id="cache-controlヘッダー">Cache-Controlヘッダー</h2>

<h3 id="ディレクティブ">ディレクティブ</h3>

<p>| ディレクティブ | 説明 |
|–+-</p>

<h1 id="ハイパーメディアapi">ハイパーメディアAPI</h1>

<h2 id="hal">HAL</h2>

<p>BEAR.Sundayは<a href="https://en.wikipedia.org/wiki/Hypertext_Application_Language">HAL</a>ハイパーメディア(<code class="language-plaintext highlighter-rouge">application/hal+json</code>)APIをサポートします。</p>

<p>HALのリソースモデルは以下の要素で構成されます。</p>

<ul>
  <li>リンク</li>
  <li>埋め込みリソース</li>
  <li>状態</li>
</ul>

<p>HALは従来のリソースの状態のみを表すJSONにリンクの<code class="language-plaintext highlighter-rouge">_links</code>と他リソースを埋め込む<code class="language-plaintext highlighter-rouge">_embedded</code>を加えたものです。HALはAPIを探索可能にしてそのAPIドキュメントをAPI自体から発見することができます。</p>

<h3 id="links-1">Links</h3>

<p>以下は有効なHALの例です。自身(<code class="language-plaintext highlighter-rouge">self</code>)のURIへのリンクを持っています。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "_links": {
        "self": { "href": "/user" }
    }
}
</code></pre></div></div>

<h3 id="link-relations">Link Relations</h3>

<p>リンクには<code class="language-plaintext highlighter-rouge">rel</code>（relation）があり、どの様な関係でリンクされているかを表ます。HTMLの<code class="language-plaintext highlighter-rouge">&lt;link&gt;</code>タグや<code class="language-plaintext highlighter-rouge">&lt;a&gt;</code>タグで使われる<code class="language-plaintext highlighter-rouge">rel</code>と同様です。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "_links": {
        "next": { "href": "/page=2" }
    }
}
</code></pre></div></div>

<p>HALについてさらに詳しくは<a href="http://stateless.co/hal_specification.html">http://stateless.co/hal_specification.html</a>をご覧ください。</p>

<h2 id="リソースクラス">リソースクラス</h2>

<p>アノテーションでリンクを貼ったり他のリソースを埋め込むことができます。</p>

<h3 id="link">#[Link]</h3>

<p>リンクが静的なものは<code class="language-plaintext highlighter-rouge">#[Link]</code>属性で表し、動的なものは<code class="language-plaintext highlighter-rouge">body['_links']</code>に代入します。宣言的に記述できる<code class="language-plaintext highlighter-rouge">#[Link]</code>属性が良いでしょう。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[Link(rel="user", href="/user")]</span>
<span class="c1">#[Link(rel="latest-post", href="/latest-post", title="latest post entrty")]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
</code></pre></div></div>

<p>or</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 権限のある場合のみリンクを貼る</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$hasCommentPrivilege</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="s1">'_links'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'comment'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="s1">'href'</span> <span class="o">=&gt;</span> <span class="s1">'/comments/{post-id}'</span><span class="p">,</span>
                    <span class="s1">'templated'</span> <span class="o">=&gt;</span> <span class="kc">true</span>
                <span class="p">]</span>
            <span class="p">]</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="embed">#[Embed]</h3>

<p>他のリソースを静的に埋め込むには<code class="language-plaintext highlighter-rouge">@Embed</code>アノテーションを使い、動的に埋め込むには<code class="language-plaintext highlighter-rouge">body</code>にリクエストを代入します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[Embed(rel="todos", src="/todos{?status}")]</span>
<span class="c1">#[Embed(rel="me", src="/me")]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$status</span><span class="p">):</span> <span class="kt">static</span>

</code></pre></div></div>

<p>or</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'_embedded'</span><span class="p">][</span><span class="s1">'todos'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/todos'</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="apiドキュメント">APIドキュメント</h2>

<p>Curiesの設置されたAPIサーバーをAPIドキュメントサーバーにもすることができます。APIドキュメントの作成の手間や実際のAPIとのずれやその検証、メンテナンスといった問題を解決します。</p>

<p>サービスするためには<code class="language-plaintext highlighter-rouge">bear/api-doc</code>をインストールして<code class="language-plaintext highlighter-rouge">BEAR\ApiDoc\ApiDoc</code>ページクラスを継承して設置します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require bear/api-doc
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">MyVendor\MyPorject\Resource\Page\Rels</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\ApiDoc\ApiDoc</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ApiDoc</span>
<span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Json Schemaのフォルダをwebに公開します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ln -s var/json_schema public/schemas
</code></pre></div></div>

<p>DocblockコメントとJson Shcemaを使ってAPIドキュメントが自動生成されます。ページクラスは独自のレンダラーを持ち<code class="language-plaintext highlighter-rouge">$context</code>の影響を受けないで、人のためのドキュメント(<code class="language-plaintext highlighter-rouge">text/html</code>) をサービスします。<code class="language-plaintext highlighter-rouge">$context</code>の影響を受けないので<code class="language-plaintext highlighter-rouge">App</code>、<code class="language-plaintext highlighter-rouge">Page</code>どちらでも設置可能です。</p>

<p>CURIEsがルートに設置されていれば、API自体がハイパーメディアではない生JSONの場合でも利用可能です。リアルタイムに生成されるドキュメントは常にプロパティ情報やバリデーション制約が正確に反映されます。</p>

<h3 id="デモ-1">デモ</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/koriym/Polidog.Todo.git
cd Polidog.Todo/
composer install
composer setup
composer doc
</code></pre></div></div>

<p><a href="https://github.com/koriym/Polidog.Todo/blob/master/docs/index.md">docs/index.md</a>にAPI docが作成されます。</p>

<h2 id="ブラウズ可能">ブラウズ可能</h2>

<p>HALで記述されたAPIセットは<strong>ヘッドレスのRESTアプリケーション</strong>として機能します。</p>

<p>WebベースのHAL BrowserやコンソールのCURLコマンドでWebサイトと同じようにルートからリンクを辿って始めて全てのリソースにアクセスできます。</p>

<ul>
  <li><a href="https://github.com/mikekelly/hal-browser">HAL Browser</a> - <a href="http://haltalk.herokuapp.com/explorer/browser.html#/">example</a></li>
  <li><a href="https://weluse.github.io/hyperagent/">hyperagent.js</a></li>
</ul>

<h2 id="siren">Siren</h2>

<p><a href="https://github.com/kevinswiber/siren">Siren</a>ハイパーメディア(<code class="language-plaintext highlighter-rouge">application/vnd.siren+json</code>)をサポートした<a href="https://github.com/kuma-guy/BEAR.SirenModule">Sirenモジュール</a> も利用可能です。</p>

<h1 id="インポート">インポート</h1>

<p>BEARのアプリケーションは、マイクロサービスにすることなく複数のBEARアプリケーションを協調して１つのシステムにすることができます。また、他のアプリケーションからBEARのリソースを利用するのも容易です。</p>

<h2 id="composer-インストール">composer インストール</h2>

<p>利用するBEARアプリケーションをcomposerパッケージにしてインストールします。</p>

<p>composer.json</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"require"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"bear/package"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^1.13"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"my-vendor/weekday"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dev-master"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"repositories"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vcs"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://github.com/bearsunday/tutorial1.git"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">bear/package ^1.13</code>が必要です。</p>

<h2 id="モジュールインストール">モジュールインストール</h2>

<p>インポートするホスト名とアプリケーション名（namespace)、コンテキストを指定して<code class="language-plaintext highlighter-rouge">ImportAppModule</code>で他のアプリケーションをインストールします。</p>

<p>AppModule.php</p>
<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gi">+use BEAR\Package\Module\ImportAppModule;
+use BEAR\Package\Module\Import\ImportApp;
</span>
class AppModule extends AbstractAppModule
<span class="err">{</span>
    protected function configure(): void
    {
        // ...
<span class="gi">+        $this-&gt;install(new ImportAppModule([
+            new ImportApp('foo', 'MyVendor\Weekday', 'prod-app')
+        ]));
</span>        $this-&gt;install(new PackageModule());
    }
<span class="err">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ImportAppModule</code>は<code class="language-plaintext highlighter-rouge">BEAR\Resource</code>ではなく<code class="language-plaintext highlighter-rouge">BEAR\Package</code>のものであることに注意してください。</p>

<h2 id="リクエスト">リクエスト</h2>

<p>インポートしたリソースは指定したホスト名を指定して利用します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">ResourceInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'BEAR.Sunday'</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$weekday</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://foo/weekday?year=2022&amp;month=1&amp;day=1'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'greeting'</span> <span class="o">=&gt;</span> <span class="s1">'Hello '</span> <span class="mf">.</span> <span class="nv">$name</span><span class="p">,</span>
            <span class="s1">'weekday'</span> <span class="o">=&gt;</span> <span class="nv">$weekday</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">#[Embed]</code>や<code class="language-plaintext highlighter-rouge">#[Link]</code>も同様に利用できます。</p>

<h2 id="他のシステムから">他のシステムから</h2>

<p>他のフレームワークやCMSからBEARのリソースを利用するのも容易です。</p>

<p>同じようにパッケージとしてインストールして、<code class="language-plaintext highlighter-rouge">Injector::getInstance</code>でrequireしたアプリケーションのリソースクライアントを取得してリクエストします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">use</span> <span class="nc">BEAR\Package\Injector</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceInterface</span><span class="p">;</span>

<span class="nv">$resource</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">(</span>
    <span class="s1">'MyVendor\Weekday'</span><span class="p">,</span>
    <span class="s1">'prod-api-app'</span><span class="p">,</span>
    <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/vendor/my-vendor/weekday'</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="nc">ResourceInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
<span class="nv">$weekdday</span> <span class="o">=</span> <span class="nv">$resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/weekday'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'year'</span> <span class="o">=&gt;</span> <span class="s1">'2022'</span><span class="p">,</span> <span class="s1">'month'</span> <span class="o">=&gt;</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'day'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">]);</span>

<span class="k">echo</span> <span class="nv">$weekdday</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'weekday'</span><span class="p">]</span> <span class="mf">.</span> <span class="kc">PHP_EOL</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="環境変数">環境変数</h2>

<p>環境変数はグローバルです。アプリケーション間でコンフリクトしないようにプリフィックスを付与するなどして注意する必要があります。インポートするアプリケーションは<code class="language-plaintext highlighter-rouge">.env</code>ファイルを使うのではなく、プロダクションと同じようにシェルの環境変数を取得します。</p>

<h2 id="システム境界">システム境界</h2>

<p>大きなアプリケーションを小さな複数のアプリケーションの集合体として構築できる点はマイクロサービスと同じですが、インフラストラクチャのオーバーヘッドの増加などのマイクロサービスのデメリットがありません。 またモジュラーモノリスよりもコンポーネントの独立性や境界が明確です。</p>

<p>このページのコードは <a href="https://github.com/bearsunday/example-import-app/commits/master">bearsunday/example-app-import</a> にあります。</p>

<h1 id="bearsundayとは">BEAR.Sundayとは</h1>

<p>BEAR.Sundayは、クリーンなオブジェクト指向設計と、Webの基本原則に沿ったリソース指向アーキテクチャを組み合わせたPHPのアプリケーションフレームワークです。
このフレームワークは標準への準拠、長期的な視点、高効率、柔軟性、自己記述性に加え、シンプルさを重視します。</p>

<h2 id="フレームワーク">フレームワーク</h2>

<p>BEAR.Sundayは3つのフレームワークで構成されています。</p>

<p><code class="language-plaintext highlighter-rouge">Ray.Di</code>は<a href="http://en.wikipedia.org/wiki/Dependency_inversion_principle">依存性逆転の原則</a>に基づいてオブジェクトの依存をインターフェイスで結びます。</p>

<p><code class="language-plaintext highlighter-rouge">Ray.Aop</code>は<a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming">アスペクト指向プログラミング</a>で本質的関心と横断的関心を結びます。</p>

<p><code class="language-plaintext highlighter-rouge">BEAR.Resource</code>はアプリケーションのデータや機能をリソースにして<a href="https://en.wikipedia.org/wiki/Representational_state_transfer">REST制約</a>で結びます。</p>

<p>フレームワークは、アプリケーション全体に適用される制約と設計原則です。一貫性のある設計と実装を促進し、高品質でクリーンなアプリケーションの構築の力になります。</p>

<h2 id="ライブラリ">ライブラリ</h2>

<p>BEAR.Sunday はフルスタック フレームワークとは異なり、認証やデータベースなどの特定のタスクのための独自のライブラリは提供しません。その代わりに、高品質なサードパーティ製のライブラリを使用することを好みます。</p>

<p>このアプローチは2つの設計思想に基づいています。1つ目は「フレームワークは変わらないがライブラリは変わる」という考え方です。フレームワークがアプリケーションの基盤として安定した構造を提供し続ける一方で、ライブラリは時間の経過とともに進化し、アプリケーションの特定のニーズを満たします。</p>

<p>2つ目は「ライブラリを選択する権利と責任はアプリケーションアーキテクトにある」というものです。アプリケーションアーキテクトは、アプリケーションの要件、制約、および目的に最も適したライブラリを選択する能力と責任を委ねられています。</p>

<p>BEAR.Sundayは、フレームワークとライブラリの違いを”不易流行”（変わらぬ基本原則と時代と共に進化する要素）として明確に区別し、アプリケーション制約としてのフレームワークの役割を重視します。</p>

<h2 id="アーキテクチャ">アーキテクチャ</h2>

<p>BEAR.Sundayは、従来のMVC（Model-View-Controller）アーキテクチャとは異なり、リソース指向アーキテクチャ(ROA)を採用しています。このアーキテクチャでは、アプリケーションの設計において、データとビジネスロジックを統一してリソースとして扱い、それらに対するリンクと操作を中心に設計を行います。リソース指向アーキテクチャはREST APIの設計で広く使用されていますが、BEAR.SundayはそれをWebアプリケーション全体の設計にも適用しています。</p>

<h2 id="長期的な視点">長期的な視点</h2>

<p>BEAR.Sunday は、アプリケーションの長期的な維持を念頭に置いて設計されています。</p>

<ul>
  <li>
    <p><strong>制約</strong>: DI、AOP、RESTの制約に従った一貫したアプリケーション制約は、時間の経過とともに変わることがありません。</p>
  </li>
  <li>
    <p><strong>永遠の1.x</strong>: 2015年の最初のリリース以来、BEAR.Sundayは後方互換性のない変更を導入することなく、継続的に進化してきました。開発者にはフレームワークの定期的な互換性破壊への対応とそのテストが必要という将来の技術負債がありません。</p>
  </li>
  <li>
    <p><strong>標準準拠</strong>：HTTP標準、JsonSchema などの標準に従い、DIはGoogle Guice、AOPはJavaのAop Allianceに基づいています。</p>
  </li>
</ul>

<h2 id="接続性">接続性</h2>

<p>BEAR.Sundayは、Webアプリケーションを超えて、さまざまなクライアントとのシームレスな統合を可能にします。</p>

<ul>
  <li>
    <p><strong>HTTPクライアント</strong>:
HTTPを使用して全てのリソースにアクセスすることが可能です。MVCのモデルやコントローラーと違い、BEAR.Sundayのリソースはクライアントから直接のアクセスが可能です。</p>
  </li>
  <li>
    <p><strong>composerパッケージ</strong>:
composerでvendor下にインストールしたアプリケーションのリソースを直接呼び出す事ができます。マイクロサービスを使わずに複数のアプリケーションを協調する事ができます。</p>
  </li>
  <li>
    <p><strong>多言語フレームワーク</strong>:
BEAR.Thriftを使用して、PHP以外の言語や異なるバージョンのPHPとの連携を可能にします。</p>
  </li>
</ul>

<h2 id="webキャッシュ">Webキャッシュ</h2>

<p>リソース指向アーキテクチャとモダンなCDNの技術を組み合わせることにより、従来のサーバーサイドのTTLキャッシュを超えるWeb本来の分散キャッシングを実現します。BEAR.Sundayの設計思想は、Webの基本原則に沿っており、CDNを中心に配置した分散キャッシュシステムを活用することで、高いパフォーマンスと可用性を実現します。</p>

<ul>
  <li>
    <p><strong>分散キャッシュ</strong>: キャッシュをクライアント、CDN、サーバーサイドに保存することで、CPU コストとネットワークコストの両方を削減します。</p>
  </li>
  <li>
    <p><strong>同一性確認</strong>:
ETagを使用してキャッシュされたコンテンツの同一性を確認し、コンテンツの変更があった場合にのみ再取得することで、ネットワーク効率を向上させます。</p>
  </li>
  <li>
    <p><strong>耐障害性</strong>:
イベントドリブンコンテンツの採用により、キャッシュに有効期限を設けないCDNキャッシュを基本にしたシステムは、PHPやDBがダウンした場合でもコンテンツを提供し続けます。</p>
  </li>
</ul>

<h2 id="パフォーマンス-1">パフォーマンス</h2>

<p>BEAR.Sundayは、最大限の柔軟性を保ちながら、パフォーマンスと効率性に重点を置いて設計されています。
極めて最適化されたブートストラップが実現され、ユーザー体験とシステムリソースの両方に好影響を与えています。
パフォーマンスはいつもBEAR.Sundayの最大関心事の一つであり、設計と開発の決定において常に中心的な役割を果たしています。</p>

<h2 id="because-everything-is-a-resource">Because Everything is a Resource</h2>

<p>「全てがリソース」のBEAR.Sundayは、Webの本質であるリソースを中心に設計されたPHPのWebアプリケーションフレームワークです。その真の価値は、オブジェクト指向原則とREST原則に基づいた優れた制約をアプリケーション全体の制約として提供することにあります。</p>

<p>この制約は、開発者に一貫性のある設計と実装を促し、長期的な視点に立ったアプリケーションの品質を高めます。同時に、この制約は開発者に自由をもたらし、アプリケーション構築の創造性を高めます。</p>

<h1 id="javascript-ui">Javascript UI</h1>

<p>ビューのレンダリングをTwigなどのPHPのテンプレートエンジン等が行う代わりに、サーバーサイドのJavaScriptが行います。
PHP側は認証/認可/初期状態/APIの提供を行い、JSがUIをレンダリングします。</p>

<p>既存のプロジェクトの構造で、アノテートされたリソースのみに適用されるので導入が容易です。</p>

<h2 id="前提条件">前提条件</h2>

<ul>
  <li>PHP 7.1</li>
  <li><a href="https://nodejs.org/ja/">Node.js</a></li>
  <li><a href="https://yarnpkg.com/">yarn</a></li>
  <li><a href="http://php.net/manual/ja/book.v8js.php">V8Js</a> (開発ではオプション)</li>
</ul>

<p>Note: V8JsがインストールされていないとNode.jsでJSが実行されます。</p>

<h2 id="用語-1">用語</h2>

<ul>
  <li><strong>CSR</strong> クライアントサイドレンダリング (Webブラウザで描画)</li>
  <li><strong>SSR</strong> サーバーサイドレンダリング (サーバーサイドのV8またはNode.jsが描画)</li>
</ul>

<h2 id="javascript">JavaScript</h2>

<h3 id="インストール-6">インストール</h3>

<p>プロジェクトに<code class="language-plaintext highlighter-rouge">koriym/ssr-module</code>をインストールします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// composer create-project bear/skeleton MyVendor.MyProject<span class="p">;</span> <span class="nb">cd </span>MyVendor.MyProject // 新規の場合
composer require bear/ssr-module
</code></pre></div></div>

<p>UIスケルトンアプリ<code class="language-plaintext highlighter-rouge">koriym/js-ui-skeleton</code>をインストールします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require koriym/js-ui-skeleton 1.x-dev
<span class="nb">cp</span> <span class="nt">-r</span> vendor/koriym/js-ui-skeleton/ui <span class="nb">.</span>
<span class="nb">cp</span> <span class="nt">-r</span> vendor/koriym/js-ui-skeleton/package.json <span class="nb">.</span>
yarn <span class="nb">install</span>
</code></pre></div></div>

<h3 id="uiアプリケーションの実行">UIアプリケーションの実行</h3>

<p>まずはデモアプリケーションを動かして見ましょう。
現れたWebページからレンダリング方法を選択してJSアプリケーションを実行します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn run ui
</code></pre></div></div>
<p>このアプリケーションの入力は<code class="language-plaintext highlighter-rouge">ui/dev/config/</code>の設定ファイルで設定します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$app</span> <span class="o">=</span> <span class="s1">'index'</span><span class="p">;</span>                   <span class="c1">// =index.bundle.js</span>
<span class="nv">$state</span> <span class="o">=</span> <span class="p">[</span>                        <span class="c1">// アプリケーションステート</span>
    <span class="s1">'hello'</span> <span class="o">=&gt;</span><span class="p">[</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'World'</span><span class="p">]</span>
<span class="p">];</span>
<span class="nv">$metas</span> <span class="o">=</span> <span class="p">[</span>                        <span class="c1">// SSRでのみ必要な値</span>
    <span class="s1">'title'</span> <span class="o">=&gt;</span><span class="s1">'page-title'</span>
<span class="p">];</span>

<span class="k">return</span> <span class="p">[</span><span class="nv">$app</span><span class="p">,</span> <span class="nv">$state</span><span class="p">,</span> <span class="nv">$metas</span><span class="p">];</span>
</code></pre></div></div>

<p>設定ファイルをコピーして、入力値を変えてみましょう。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp ui/dev/config/index.php ui/dev/config/myapp.php
</code></pre></div></div>

<p>ブラウザをリロードして新しい設定を試します。
このようにJavascriptや本体のPHPアプリケーションを変更しないでUIのデータを変更して動作を確認することができます。</p>

<p>このセクションで編集したPHPの設定ファイルはあくまで<code class="language-plaintext highlighter-rouge">yarn run ui</code>で実行する時のみに使用されます。
PHP側が必要とするのはバンドルされて出力されたJSのみです。</p>

<h3 id="uiアプリケーションの作成">UIアプリケーションの作成</h3>

<p>PHPから渡された引数を使ってレンダリングした文字列を返す<strong>render</strong>関数を作成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const render = (state, metas) =&gt; (
  __AWESOME_UI__ // SSR対応のライブラリやJSのテンプレートエンジンを使って文字列を返す
)
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">state</code>はドキュメントルートに必要な値、<code class="language-plaintext highlighter-rouge">metas</code>はそれ以外の値、例えば&lt;head&gt;で使う値などです。<code class="language-plaintext highlighter-rouge">render</code>という関数名は固定です。</p>

<p>ここでは名前を受け取って挨拶を返す関数を作成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const render = state =&gt; (
  `Hello ${state.name}`
)
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ui/src/page/index/hello/server.js</code>として保存して、webpackのエントリーポイントを<code class="language-plaintext highlighter-rouge">ui/entry.js</code>に登録します。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">hello</span><span class="p">:</span> <span class="dl">'</span><span class="s1">src/page/hello/server</span><span class="dl">'</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<p>これで<code class="language-plaintext highlighter-rouge">hello.bundle.js</code>というバンドルされたファイルが出力されるようになりました。</p>

<p>このhelloアプリケーションをテスト実行するためのファイルを<code class="language-plaintext highlighter-rouge">ui/dev/config/myapp.php</code>に作成します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$app</span> <span class="o">=</span> <span class="s1">'hello'</span><span class="p">;</span>
<span class="nv">$state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'World'</span><span class="p">]</span>
<span class="p">];</span>
<span class="nv">$metas</span> <span class="o">=</span> <span class="p">[];</span>

<span class="k">return</span> <span class="p">[</span><span class="nv">$app</span><span class="p">,</span> <span class="nv">$state</span><span class="p">,</span> <span class="nv">$metas</span><span class="p">];</span>
</code></pre></div></div>

<p>以上です！ヴラウザをリロードして試してください。</p>

<p>render関数の中の処理をReactやVue.jsなどのUIフレームワークを使ってリッチなUIを作成できます。
通常のアプリケーションでは依存を最小限にするために<code class="language-plaintext highlighter-rouge">server.js</code>エントリーファイルは以下のようにrenderモジュールを読み込むようにします。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">render</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./render</span><span class="dl">'</span><span class="p">;</span>
<span class="nb">global</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="nx">render</span><span class="p">;</span>
</code></pre></div></div>

<p>ここまでPHP側の作業はありません。SSRのアプリケーション開発はPHP開発と独立して行うことができます。</p>

<h2 id="php">PHP</h2>

<h3 id="モジュールインストール-1">モジュールインストール</h3>

<p>AppModuleに<code class="language-plaintext highlighter-rouge">SsrModule</code>モジュールをインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">use</span> <span class="nc">BEAR\SsrModule\SsrModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$build</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/var/www/build'</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">SsrModule</span><span class="p">(</span><span class="nv">$build</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">$build</code>フォルダはJSのファイルがあるディレクトリです。(<code class="language-plaintext highlighter-rouge">ui/ui.config.js</code>で指定するwebpackの出力先)</p>

<h3 id="ssrアノテーション">@Ssrアノテーション</h3>

<p>リソースをSSRするメソッドに<code class="language-plaintext highlighter-rouge">@Ssr</code>とアノテートします。<code class="language-plaintext highlighter-rouge">app</code>にJSアプリケーション名が必要です。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">php</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\MyRedux\Resource\Page</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\SsrModule\Annotation\Ssr</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="cd">/**
     * @Ssr(app="index_ssr")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="nv">$name</span> <span class="o">=</span> <span class="s1">'BEAR.Sunday'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'hello'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">]</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">$this-&gt;body</code>が<code class="language-plaintext highlighter-rouge">render</code>関数に1つ目の引数として渡されます。
CSRとSSRの値を区別して渡したい場合は<code class="language-plaintext highlighter-rouge">state</code>と<code class="language-plaintext highlighter-rouge">metas</code>でbodyのキーを指定します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @Ssr(
 *   app="index_ssr",
 *   state={"name", "age"},
 *   metas={"title"}
 * )
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'World'</span><span class="p">,</span>
        <span class="s1">'age'</span> <span class="o">=&gt;</span> <span class="mf">4.6E8</span><span class="p">;</span>
        <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'Age of the World'</span>
    <span class="p">];</span>

    <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>実際<code class="language-plaintext highlighter-rouge">state</code>と<code class="language-plaintext highlighter-rouge">metas</code>をどのようにして渡してSSRを実現するかは<code class="language-plaintext highlighter-rouge">ui/src/page/index/server</code>のサンプルアプリケーションをご覧ください。影響を受けるのはアノテートしたメソッドだけで、APIやHTMLのレンダリングの設定はそのままです。</p>

<h3 id="phpアプリケーションの実行設定">PHPアプリケーションの実行設定</h3>

<p><code class="language-plaintext highlighter-rouge">ui/ui.config.js</code>を編集して、<code class="language-plaintext highlighter-rouge">public</code>にweb公開ディレクトリを<code class="language-plaintext highlighter-rouge">build</code>にwebpackのbuild先を指定します。
<code class="language-plaintext highlighter-rouge">build</code>はSsrModuleのインストールで指定したディレクトリと同じです。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">public</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">../var/www</span><span class="dl">'</span><span class="p">),</span>
  <span class="na">build</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">../var/www/build</span><span class="dl">'</span><span class="p">)</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="phpアプリケーションの実行">PHPアプリケーションの実行</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn run dev
</code></pre></div></div>

<p>ライブアップデートで実行します。
PHPファイルの変更があれば自動でリロードされ、Reactのコンポーネントに変更があればリロードなしでコンポーネントをアップデートします。ライブアップデートなしで実行する場合には<code class="language-plaintext highlighter-rouge">yarn run start</code>を実行します。</p>

<p><code class="language-plaintext highlighter-rouge">lint</code>や<code class="language-plaintext highlighter-rouge">test</code>などの他のコマンドは<a href="https://github.com/koriym/Koriym.JsUiSkeleton/blob/1.x/README.ja.md#コマンド">コマンド</a>をご覧ください。</p>

<h2 id="パフォーマンス-2">パフォーマンス</h2>

<p>V8のスナップショットをApc保存する機能を使ってパフォーマンスの大幅な向上が可能です。
<code class="language-plaintext highlighter-rouge">ProdModule</code>で<code class="language-plaintext highlighter-rouge">ApcSsrModule</code>をインストールしてください。
ReactJsやアプリケーションのスナップショットが<code class="language-plaintext highlighter-rouge">APCu</code>に保存され再利用されます。V8jsが必要です。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">ApcSsrModule</span><span class="p">);</span>
</code></pre></div></div>

<p>Apc以外のキャッシュを利用するには<code class="language-plaintext highlighter-rouge">ApcSsrModule</code>のコードを参考にモジュールを作成してください。
PSR16対応のキャッシュが利用可能です。</p>

<p>さらなる高速化のためにはV8をコンパイルする時点でJSコード(ReactJsなど）のスナップショットを取り込みます。
詳しくは以下をご覧ください。</p>

<ul>
  <li><a href="http://stesie.github.io/2016/02/snapshot-performance">20x performance boost with V8Js snapshots</a></li>
  <li><a href="https://github.com/phpv8/v8js/issues/205">v8js - Possibility to Improve Performance with Precompiled Templates/Classes ?</a></li>
</ul>

<h2 id="デバック">デバック</h2>

<ul>
  <li>Chromeプラグイン <a href="https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi">React developer tools</a>、<a href="https://chrome.google.com/webstore/detail/redux-devtools/lmhkpmbekcpmknklioeibfkpmmfibljd">Redux devTools</a>が利用できます。</li>
  <li>500エラーが帰ってくる場合は<code class="language-plaintext highlighter-rouge">var/log</code>や<code class="language-plaintext highlighter-rouge">curl</code> でアクセスしてレスポンス詳細を見てみましょう</li>
</ul>

<h2 id="リファレンス">リファレンス</h2>

<ul>
  <li><a href="http://postd.cc/es6-cheatsheet/">ECMAScript 6</a></li>
  <li><a href="http://mitsuruog.github.io/javascript-style-guide/">Airbnb JavaScript スタイルガイド</a></li>
  <li><a href="https://facebook.github.io/react/">React</a></li>
  <li><a href="http://redux.js.org/">Redux</a></li>
  <li><a href="https://github.com/reactjs/redux">Redux github</a></li>
  <li><a href="https://github.com/gaearon/redux-devtools">Redux devtools</a></li>
  <li><a href="http://karma-runner.github.io/1.0/index.html">Karma test runner</a></li>
  <li><a href="https://mochajs.org/">Mocha test framework</a></li>
  <li><a href="http://chaijs.com/">Chai assertion library</a></li>
  <li><a href="https://yarnpkg.com/">Yarn package manager</a></li>
  <li><a href="https://webpack.js.org/">Webpack module bundler</a></li>
</ul>

<h2 id="その他ビューライブラリ">その他ビューライブラリ</h2>

<ul>
  <li><a href="https://jp.vuejs.org/">Vue.js</a></li>
  <li><a href="http://handlebarsjs.com/">Handlesbar.js</a></li>
  <li><a href="http://olado.github.io/doT/index.html">doT.js</a></li>
  <li><a href="https://pugjs.org/api/getting-started.html">pug</a></li>
  <li><a href="http://twitter.github.io/hogan.js/">Hogan</a> (Twitter)</li>
  <li><a href="https://mozilla.github.io/nunjucks/">Nunjucks</a>(Mozilla)</li>
  <li><a href="http://www.dustjs.com/">dust.js</a> (LinkedIn)</li>
  <li>
    <p><a href="http://markojs.com/">marko</a> (Ebay)</p>
  </li>
  <li>以前のReact JSページは<a href="reactjs.html">ReactJs</a>へ*</li>
</ul>

<h1 id="モジュール-2">モジュール</h1>

<p>モジュールはDIとAOPの束縛のセットです。 BEAR.Sundayではいわゆる設定ファイルや、Configクラス、実行モードなどがありません。各コンポーネントが必要とする値は依存性の注入で与えられます。モジュールがその依存性束縛を行います。</p>

<p>起点となるモジュールが<code class="language-plaintext highlighter-rouge">AppModule</code> (src/Module/AppModule.php)です。
<code class="language-plaintext highlighter-rouge">AppModule</code>で他の必要なモジュールを<code class="language-plaintext highlighter-rouge">install</code>します。</p>

<p>モジュールが必要とする値（ランタイムではなく、コンパイルタイムで必要な値）は手動のコンストラクタインジェクションで束縛を行います。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// 追加モジュール</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AuraSqlModule</span><span class="p">(</span><span class="s1">'mysql:host=localhost;dbname=test'</span><span class="p">,</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'db_username'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'db_password'</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">TwigModule</span><span class="p">));</span>
        <span class="c1">// package標準のモジュール</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">PackageModule</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="diの束縛">DIの束縛</h2>

<p>代表的な束縛を以下に記します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// クラスの束縛</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nv">$interface</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nv">$class</span><span class="p">);</span>
<span class="c1">// プロバイダー（ファクトリー）の束縛</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nv">$interface</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toProvider</span><span class="p">(</span><span class="nv">$provider</span><span class="p">);</span>
<span class="c1">// インスタンス束縛</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nv">$interface</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="nv">$instance</span><span class="p">);</span>
<span class="c1">// 名前付き束縛</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nv">$interface</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nv">$annotation</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nv">$class</span><span class="p">);</span>
<span class="c1">// シングルトン</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nv">$interface</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nv">$class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">in</span><span class="p">(</span><span class="nc">Scope</span><span class="o">::</span><span class="no">SINGLETON</span><span class="p">);</span>
<span class="c1">// コンストラクタ束縛</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nv">$interface</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toConstructor</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$named</span><span class="p">);</span>
</code></pre></div></div>

<p>詳しくは<a href="di.html">DI</a>をご覧ください。</p>

<h2 id="aopの設定">AOPの設定</h2>

<p>AOPはクラスとメソッドを<code class="language-plaintext highlighter-rouge">Matcher</code>で”検索”して、マッチするメソッドにインターセプターを束縛します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bindInterceptor</span><span class="p">(</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">any</span><span class="p">(),</span>                   <span class="c1">// どのクラスの</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">startsWith</span><span class="p">(</span><span class="s1">'delete'</span><span class="p">),</span>    <span class="c1">// "delete"で始まるメソッド名のメソッドには</span>
    <span class="p">[</span><span class="nc">Logger</span><span class="o">::</span><span class="n">class</span><span class="p">]</span>                          <span class="c1">// Loggerインターセプターを束縛</span>
<span class="p">);</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bindInterceptor</span><span class="p">(</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">SubclassesOf</span><span class="p">(</span><span class="nc">AdminPage</span><span class="o">::</span><span class="n">class</span><span class="p">),</span>  <span class="c1">// AdminPageの継承または実装クラスの</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">matcher</span><span class="o">-&gt;</span><span class="nf">annotatedWith</span><span class="p">(</span><span class="nc">Auth</span><span class="o">::</span><span class="n">class</span><span class="p">),</span>      <span class="c1">// @Authアノテーションがアノテートされているメソッドには</span>
    <span class="p">[</span><span class="nc">AdminAuthentication</span><span class="o">::</span><span class="n">class</span><span class="p">]</span>                     <span class="c1">// AdminAuthenticationインターセプターを束縛</span>
<span class="p">);</span>
</code></pre></div></div>

<p>詳しくは<a href="aop.html">AOP</a>をご覧ください。</p>

<h2 id="束縛の優先順位">束縛の優先順位</h2>

<h3 id="同じモジュール内">同じモジュール内</h3>

<p>先に束縛した方が優先します。この場合はFoo1が優先されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">FooInterface</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nc">Foo1</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">FooInterface</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nc">Foo2</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="モジュールインストール-2">モジュールインストール</h3>

<p>先にインストールしたモジュールが優先します。この場合はFoo1Moduleが優先されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">Foo1Module</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">Foo2Module</span><span class="p">);</span>
</code></pre></div></div>

<p>後からのモジュールを優先する場合には<code class="language-plaintext highlighter-rouge">override</code>を使います。この場合はFoo2Moduleが優先されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">Foo1Module</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">override</span><span class="p">(</span><span class="k">new</span> <span class="nc">Foo2Module</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="コンテキスト文字列">コンテキスト文字列</h3>

<p>左のモジュールの束縛が優先されます。<code class="language-plaintext highlighter-rouge">prod-hal-app</code>ならAppModuleよりHalModule、HalModuleよりProdModuleが優先してインストールされます。</p>

<h1 id="パッケージ">パッケージ</h1>

<p>アプリケーションは独立したcomposerパッケージです。</p>

<p>フレームワークは依存として<code class="language-plaintext highlighter-rouge">composer install</code>しますが、他のアプリケーションも依存パッケージとして使うことができます。</p>

<h2 id="アプリケーションパッケージ">アプリケーション・パッケージ</h2>

<h3 id="構造">構造</h3>

<p>BEAR.Sundayアプリケーションのファイルレイアウトは <a href="https://github.com/php-pds/skeleton">php-pds/skeleton</a> に準拠しています。</p>

<h3 id="bin">bin/</h3>

<p>スクリプトで実行可能なコマンドを設置します。</p>

<p>BEARのリソースはコンソール入力とWebの双方からアクセスできます。
呼び出すスクリプトによってコンテキストが変わります。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php options <span class="s1">'/todos'</span> <span class="c"># APIアクセス (appリソース）</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/page.php get <span class="s1">'/todos?id=1'</span> <span class="c"># Webアクセス (pageリソース）</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php <span class="nt">-S</span> 127.0.0.1 bin/app.php <span class="c"># PHPサーバー</span>
</code></pre></div></div>

<p>コンテキストが変わるとアプリケーションの振る舞いが変わります。
ユーザーは独自のコンテキストを作成することができます。</p>

<h3 id="src">src/</h3>

<p>アプリケーション固有のクラスファイルを設置します。</p>

<h3 id="publc">publc/</h3>

<p>Web公開フォルダです。</p>

<h3 id="var">var/</h3>

<p><code class="language-plaintext highlighter-rouge">log</code>,<code class="language-plaintext highlighter-rouge">tmp</code>フォルダは書き込み可能にします。<code class="language-plaintext highlighter-rouge">var/www</code>はWebドキュメントの公開エリアです。
<code class="language-plaintext highlighter-rouge">conf</code>など可変のファイルを設置します。</p>

<h2 id="実行シーケンス-1">実行シーケンス</h2>

<ol>
  <li>コンソール入力(<code class="language-plaintext highlighter-rouge">bin/app.php</code>, <code class="language-plaintext highlighter-rouge">page.php</code>)またはWebサーバーのエントリーファイル(<code class="language-plaintext highlighter-rouge">public/index.php</code>)が<code class="language-plaintext highlighter-rouge">bootstrap.php</code>を実行します。</li>
  <li><code class="language-plaintext highlighter-rouge">bootstrap.php</code>では実行コンテキストに応じたルートオブジェクト<code class="language-plaintext highlighter-rouge">$app</code>を作成します。</li>
  <li><code class="language-plaintext highlighter-rouge">$app</code>に含まれるルーターは外部のHTTPまたはCLIリクエストをアプリケーション内部のリソースリクエストに変換します。</li>
  <li>リソースリクエストが実行され、結果がクライアントに転送されます。</li>
</ol>

<h2 id="フレームワークパッケージ">フレームワーク・パッケージ</h2>

<p>フレームワークは以下のパッケージから構成されます。</p>

<h3 id="rayaop">ray/aop</h3>
<p><a href="https://scrutinizer-ci.com/g/ray-di/Ray.Aop/"><img src="https://scrutinizer-ci.com/g/ray-di/Ray.Aop/badges/quality-score.png?b=2.x" alt="Scrutinizer Quality Score" /></a>
<a href="https://codecov.io/gh/ray-di/Ray.Aop"><img src="https://codecov.io/gh/ray-di/Ray.Aop/branch/2.x/graph/badge.svg?token=eh3c9AF4Mr" alt="codecov" /></a>
<a href="https://shepherd.dev/github/ray-di/Ray.Aop"><img src="https://shepherd.dev/github/ray-di/Ray.Aop/coverage.svg" alt="Type Coverage" /></a>
<a href="https://github.com/ray-di/Ray.Aop/actions/workflows/continuous-integration.yml"><img src="https://github.com/ray-di/Ray.Aop/actions/workflows/continuous-integration.yml/badge.svg" alt="Continuous Integration" /></a></p>

<p>Javeの <a href="http://aopalliance.sourceforge.net/">AOPアライアンス</a> に準拠したAOPフレームワークです。</p>

<h3 id="raydi">ray/di</h3>
<p><a href="https://scrutinizer-ci.com/g/ray-di/Ray.Di/"><img src="https://scrutinizer-ci.com/g/ray-di/Ray.Di/badges/quality-score.png?b=2.x" alt="Scrutinizer Quality Score" /></a>
<a href="https://codecov.io/gh/ray-di/Ray.Di"><img src="https://codecov.io/gh/ray-di/Ray.Di/branch/2.x/graph/badge.svg?token=eh3c9AF4Mr" alt="codecov" /></a>
<a href="https://shepherd.dev/github/ray-di/Ray.Di"><img src="https://shepherd.dev/github/ray-di/Ray.Di/coverage.svg" alt="Type Coverage" /></a>
<a href="https://github.com/ray-di/Ray.Di/actions/workflows/continuous-integration.yml"><img src="https://github.com/ray-di/Ray.Di/actions/workflows/continuous-integration.yml/badge.svg" alt="Continuous Integration" /></a></p>

<p><a href="https://github.com/google/guice">google/guice</a> スタイルのDIフレームワークです。<code class="language-plaintext highlighter-rouge">ray/aop</code>を含みます。</p>

<h3 id="bearresource">bear/resource</h3>
<p><a href="https://scrutinizer-ci.com/g/bearsunday/BEAR.Resource/?branch=1.x"><img src="https://scrutinizer-ci.com/g/bearsunday/BEAR.Resource/badges/quality-score.png?b=1.x" alt="Scrutinizer Code Quality" /></a>
<a href="https://codecov.io/gh/bearsunday/BEAR.Resource"><img src="https://codecov.io/gh/bearsunday/BEAR.Resource/branch/1.x/graph/badge.svg?token=eh3c9AF4Mr" alt="codecov" /></a>
<a href="https://shepherd.dev/github/bearsunday/BEAR.Resource"><img src="https://shepherd.dev/github/bearsunday/BEAR.Resource/coverage.svg" alt="Type Coverage" /></a>
<a href="https://github.com/bearsunday/BEAR.Resource/actions/workflows/continuous-integration.yml"><img src="https://github.com/bearsunday/BEAR.Resource/actions/workflows/continuous-integration.yml/badge.svg" alt="Continuous Integration" /></a></p>

<p>PHPのオブジェクトをRESTサービスとして使用するRESTフレームワークです。<code class="language-plaintext highlighter-rouge">ray/di</code>を含みます。</p>

<h3 id="bearsunday">bear/sunday</h3>
<p><a href="https://scrutinizer-ci.com/g/bearsunday/BEAR.Sunday/?branch=1.x"><img src="https://scrutinizer-ci.com/g/bearsunday/BEAR.Sunday/badges/quality-score.png?b=1.x" alt="Scrutinizer Code Quality" /></a>
<a href="https://codecov.io/gh/bearsunday/BEAR.Sunday"><img src="https://codecov.io/gh/bearsunday/BEAR.Sunday/branch/1.x/graph/badge.svg?token=eh3c9AF4Mr" alt="codecov" /></a>
<a href="https://shepherd.dev/github/bearsunday/BEAR.Sunday"><img src="https://shepherd.dev/github/bearsunday/BEAR.Sunday/coverage.svg" alt="Type Coverage" /></a>
<a href="https://github.com/bearsunday/BEAR.Sunday/actions/workflows/continuous-integration.yml"><img src="https://github.com/bearsunday/BEAR.Sunday/actions/workflows/continuous-integration.yml/badge.svg" alt="Continuous Integration" /></a></p>

<p>フレームワークのインターフェイスパッケージです。<code class="language-plaintext highlighter-rouge">bear/resource</code>を含みます。</p>

<h3 id="bearpackage">bear/package</h3>
<p><a href="https://scrutinizer-ci.com/g/bearsunday/BEAR.Package/?branch=1.x"><img src="https://scrutinizer-ci.com/g/bearsunday/BEAR.Package/badges/quality-score.png?b=1.x" alt="Scrutinizer Code Quality" /></a>
<a href="https://codecov.io/gh/bearsunday/BEAR.Pacakge"><img src="https://codecov.io/gh/bearsunday/BEAR.Package/branch/1.x/graph/badge.svg?token=eh3c9AF4Mr" alt="codecov" /></a>
<a href="https://shepherd.dev/github/bearsunday/BEAR.Package"><img src="https://shepherd.dev/github/bearsunday/BEAR.Package/coverage.svg" alt="Type Coverage" /></a>
<a href="https://github.com/bearsunday/BEAR.Package/actions/workflows/continuous-integration.yml"><img src="https://github.com/bearsunday/BEAR.Package/actions/workflows/continuous-integration.yml/badge.svg" alt="Continuous Integration" /></a></p>

<p><code class="language-plaintext highlighter-rouge">bear/sunday</code>の実装パッケージです。<code class="language-plaintext highlighter-rouge">bear/sunday</code>を含みます。</p>

<h2 id="ライブラリパッケージ">ライブラリ・パッケージ</h2>

<p>必要なライブラリ・パッケージを<code class="language-plaintext highlighter-rouge">composer</code>インストールします。</p>

<table>
  <tbody>
    <tr>
      <td><strong>Category</strong></td>
      <td><strong>Composer package</strong></td>
      <td><strong>Library</strong></td>
    </tr>
    <tr>
      <td>ルーター</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/bearsunday/BEAR.AuraRouterModule">bear/aura-router-module</a></td>
      <td><a href="https://github.com/auraphp/Aura.Router/tree/2.x">Aura.Router v2</a></td>
    </tr>
    <tr>
      <td>データベース</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.MediaQuery">ray/media-query</a></td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.AuraSqlModule">ray/aura-sql-module</a></td>
      <td><a href="https://github.com/auraphp/Aura.Sql/tree/2.x">Aura.Sql v2</a></td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.DbalModule">ray/dbal-module</a></td>
      <td><a href="https://github.com/doctrine/dbal">Doctrine DBAL</a></td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.CakeDbModule">ray/cake-database-module</a></td>
      <td><a href="https://github.com/cakephp/database">CakePHP v3 database</a></td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/kawanamiyuu/Ray.DoctrineOrmModule">ray/doctrine-orm-module</a></td>
      <td><a href="https://github.com/doctrine/doctrine2">Doctrine ORM</a></td>
    </tr>
    <tr>
      <td>ストレージ</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/bearsunday/BEAR.QueryRepository">bear/query-repository</a></td>
      <td>読み書きリポジトリの分離（デフォルト）</td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.QueryModule">bear/query-module</a></td>
      <td>DBやWeb APIなどの外部アクセスの分離</td>
    </tr>
    <tr>
      <td>Web</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="http://bearsunday.github.io/manuals/1.0/ja/html.html">madapaja/twig-module</a></td>
      <td><a href="http://twig.sensiolabs.org/">Twigテンプレートエンジン</a></td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="http://bearsunday.github.io/manuals/1.0/ja/form.html">ray/web-form-module</a></td>
      <td>Webフォーム &amp; バリデーション</td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/Ray-Di/Ray.AuraWebModule">ray/aura-web-module</a></td>
      <td><a href="https://github.com/auraphp/Aura.Web">Aura.Web</a></td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.AuraSessionModule">ray/aura-session-module</a></td>
      <td><a href="https://github.com/auraphp/Aura.Session">Aura.Session</a></td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/kawanamiyuu/Ray.SymfonySessionModule">ray/symfony-session-module</a></td>
      <td><a href="https://github.com/symfony/http-foundation/tree/master/Session">Symfony Session</a></td>
    </tr>
    <tr>
      <td>バリデーション</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.ValidateModule">ray/validate-module</a></td>
      <td><a href="https://github.com/auraphp/Aura.Filter">Aura.Filter</a></td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/satomif/ExtraAuraFilterModule">satomif/extra-aura-filter-module</a></td>
      <td><a href="https://github.com/auraphp/Aura.Filter">Aura.Filter</a></td>
    </tr>
    <tr>
      <td>認証</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/Ray-Di/Ray.OAuthModule">ray/oauth-module</a></td>
      <td>OAuth</td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/kuma-guy/BEAR.JwtAuthModule">kuma-guy/jwt-auth-module</a></td>
      <td>JSON Web Token</td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.RoleModule">ray/role-module</a></td>
      <td><a href="https://github.com/zendframework/zend-permissions-acl">Zend Acl</a>　 Zend Acl</td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/bearsunday/BEAR.AclResource">bear/acl-resource</a></td>
      <td>ACLベースのエンベドリソース</td>
    </tr>
    <tr>
      <td>ハイパーメディア</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/kuma-guy/BEAR.SirenModule">kuma-guy/siren-module</a></td>
      <td>Siren</td>
    </tr>
    <tr>
      <td>開発</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/ray-di/Ray.TestDouble">ray/test-double</a></td>
      <td>テストダブル</td>
    </tr>
    <tr>
      <td>非同期ハイパフォーマンス</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td><a href="https://github.com/bearsunday/MyVendor.Swoole">MyVendor.Swoole</a></td>
      <td><a href="https://github.com/swoole/swoole-src">Swoole</a></td>
    </tr>
  </tbody>
</table>

<h2 id="ベンダーパッケージ">ベンダー・パッケージ</h2>

<p>特定のパッケージやツールの組み合わせをモジュールだけのパッケージにして再利用し、同様のプロジェクトのモジュールを共通化する事ができます。<sup id="fnref:1:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">3</a></sup></p>

<h2 id="semver">Semver</h2>

<p>全てのパッケージは<a href="https://semver.org/lang/ja/">セマンティックバージョニング</a> に従います。マイナーバージョンアップでは後方互換性が破壊されることはありません。</p>

<hr />

<h1 id="プロダクション">プロダクション</h1>

<p>BEAR.Sunday既定の<code class="language-plaintext highlighter-rouge">prod</code>束縛に対して、アプリケーションがそれぞれの<a href="https://en.wikipedia.org/wiki/Deployment_environment">ディプロイ環境</a>に応じたモジュールをカスタマイズして束縛を行ます。</p>

<h2 id="既定のprodmodule">既定のProdModule</h2>

<p>既定の<code class="language-plaintext highlighter-rouge">prod</code>束縛では以下のインターフェイスの束縛がされています。</p>

<ul>
  <li>エラーページ生成ファクトリー</li>
  <li>PSRロガーインターフェイス</li>
  <li>ローカルキャッシュ</li>
  <li>分散キャッシュ</li>
</ul>

<p>詳細はBEAR.Packageの<a href="https://github.com/bearsunday/BEAR.Package/blob/1.x/src/Context/ProdModule.php">ProdModule.php</a>参照。</p>

<h2 id="アプリケーションのprodmodule">アプリケーションのProdModule</h2>

<p>既定のProdModuleに対してアプリケーションの<code class="language-plaintext highlighter-rouge">ProdModule</code>を<code class="language-plaintext highlighter-rouge">src/Module/ProdModule.php</code>に設置してカスタマイズします。特にエラーページと分散キャッシュは重要です。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">MyVendor\Todo\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Package\Context\ProdModule</span> <span class="k">as</span> <span class="nc">PackageProdModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\QueryRepository\CacheVersionModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Module\OptionsMethodModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ProdModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">PackageProdModule</span><span class="p">);</span>       <span class="c1">// デフォルトのprod設定</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">override</span><span class="p">(</span><span class="k">new</span> <span class="nc">OptionsMethodModule</span><span class="p">);</span>    <span class="c1">// OPTIONSメソッドをプロダクションでも有効に</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">CacheVersionModule</span><span class="p">(</span><span class="s1">'1'</span><span class="p">));</span> <span class="c1">// リソースキャッシュのバージョン指定</span>

        <span class="c1">// 独自のエラーページ</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">ErrorPageFactoryInterface</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nc">MyErrorPageFactory</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="キャッシュ">キャッシュ</h2>

<p>キャッシュはローカルキャッシュと、複数のWebサーバー間でシェアをする分散キャッシュの２種類があります。
どちらのキャッシュもデフォルトは<a href="https://www.doctrine-project.org/projects/doctrine-cache/en/1.10/index.html#phpfilecache">PhpFileCache</a>です。</p>

<h3 id="ローカルキャッシュ">ローカルキャッシュ</h3>

<p>ローカルキャッシュはdeploy後に変更のないアノテーション等のキャシュ例に使われ、分散キャッシュはリソース状態の保存に使われます。</p>

<h3 id="分散キャッシュ">分散キャッシュ</h3>

<p>2つ以上のWebサーバーでサービスを行うためには分散キャッシュの構成が必要です。
代表的な<a href="http://php.net/manual/ja/book.memcached.php">memcached</a>、<a href="https://redis.io">Redis</a>のキャッシュエンジンのそれぞれのモジュールが用意されています。</p>

<h3 id="memcached">Memcached</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">BEAR\HelloWorld\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\QueryRepository\StorageMemcachedModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Module\ProdLoggerModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\Context\ProdModule</span> <span class="k">as</span> <span class="nc">PackageProdModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\Scope</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">ProdModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// memcache</span>
        <span class="c1">// {host}:{port}:{weight},...</span>
        <span class="nv">$memcachedServers</span> <span class="o">=</span> <span class="s1">'mem1.domain.com:11211:33,mem2.domain.com:11211:67'</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">StorageMemcachedModule</span><span class="p">(</span><span class="n">memcachedServers</span><span class="p">);</span>

        <span class="c1">// Prodロガーのインストール</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">ProdLoggerModule</span><span class="p">);</span>
        <span class="c1">// デフォルトのProdModuleのインストール</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">PackageProdModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="redis">Redis</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// redis</span>
<span class="nv">$redisServer</span> <span class="o">=</span> <span class="s1">'localhost:6379'</span><span class="p">;</span> <span class="c1">// {host}:{port}</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">StorageRedisModule</span><span class="p">(</span><span class="nv">$redisServer</span><span class="p">);</span>
</code></pre></div></div>

<p>リソースの状態保存は単にTTLによる時間更新のキャッシュとの他に、TTL時間では消えない永続的なストレージとして(CQRS）の運用も可能です。
その場合には<code class="language-plaintext highlighter-rouge">Redis</code>で永続処理を行うか、Cassandraなどの他KVSのストレージアダプターを独自で用意する必要があります。</p>

<h3 id="キャッシュ時間の指定">キャッシュ時間の指定</h3>

<p>デフォルトのTTLを変更する場合<code class="language-plaintext highlighter-rouge">StorageExpiryModule</code>をインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Cache time</span>
<span class="nv">$short</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
<span class="nv">$medium</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">;</span>
<span class="nv">$long</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">;</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">StorageExpiryModule</span><span class="p">(</span><span class="nv">$short</span><span class="p">,</span> <span class="nv">$medium</span><span class="p">,</span> <span class="nv">$long</span><span class="p">);</span>
</code></pre></div></div>
<h3 id="キャッシュバージョンの指定">キャッシュバージョンの指定</h3>

<p>リソースのスキーマが代わり、互換性が失われる時にはキャッシュバージョンを変更します。特にTTL時間で消えないCQRS運用の場合に重要です。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$this-&gt;install(new CacheVersionModule($cacheVersion));
</code></pre></div></div>

<p>ディプロイの度にリソースキャッシュを破棄するためには<code class="language-plaintext highlighter-rouge">$cacheVersion</code>に時刻や乱数の値を割り当てると変更が不要で便利です。</p>

<h2 id="ログ">ログ</h2>

<p><code class="language-plaintext highlighter-rouge">ProdLoggerModule</code>はプロダクション用のリソース実行ログモジュールです。インストールするとGET以外のリクエストを<code class="language-plaintext highlighter-rouge">Psr\Log\LoggerInterface</code>にバインドされているロガーでログします。
特定のリソースや特定の状態でログしたい場合は、カスタムのログを<a href="https://github.com/bearsunday/BEAR.Resource/blob/1.x/src/LoggerInterface.php">BEAR\Resource\LoggerInterface</a>にバインドします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Resource\LoggerInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\AbstractModule</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">MyProdLoggerModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">LoggerInterface</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nc">MyProdLogger</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a href="https://github.com/bearsunday/BEAR.Resource/blob/1.x/src/LoggerInterface.php">LoggerInterface</a>の<code class="language-plaintext highlighter-rouge">__invoke</code>メソッドでリソースのURIとリソース状態が<code class="language-plaintext highlighter-rouge">ResourceObject</code>オブジェクトとして渡されるのでその内容で必要な部分をログします。
作成には<a href="https://github.com/bearsunday/BEAR.Resource/blob/1.x/src/ProdLogger.php">既存の実装 ProdLogger</a>を参考にしてください。</p>

<h2 id="デプロイ">デプロイ</h2>

<h3 id="️-上書き更新を避ける">⚠️ 上書き更新を避ける</h3>

<h4 id="サーバーにディプロイする場合">サーバーにディプロイする場合</h4>

<ul>
  <li>駆動中のプロジェクトフォルダを<code class="language-plaintext highlighter-rouge">rsync</code>などで上書きするのはキャッシュやオンデマンドで生成されるファイルの不一致や、高負荷のサイトではキャパシティを超えるリスクがあります。
安全のために別のディレクトリでセットアップを行いそのセットアップが成功すれば切り替えるようにします。</li>
  <li><a href="http://deployer.org/">Deployer</a>の<a href="https://github.com/bearsunday/deploy">BEAR.Sundayレシピ</a>を利用する事ができます。</li>
</ul>

<h4 id="クラウドにディプロイする時には">クラウドにディプロイする時には</h4>

<ul>
  <li>コンパイルが成功すると0、依存関係の問題を見つけるとコンパイラはexitコード1を出力します。それを利用してCIにコンパイルを組み込む事を推奨します。</li>
</ul>

<h3 id="コンパイル推奨">コンパイル推奨</h3>

<p>セットアップを行う際に<code class="language-plaintext highlighter-rouge">vendor/bin/bear.compile</code>スクリプトを使ってプロジェクトを<strong>ウオームアップ</strong>することができます。
コンパイルスクリプトはDI/AOP用の動的に作成されるファイルやアノテーションなどの静的なキャッシュファイルを全て事前に作成し、最適化されたautoload.phpファイルとpreload.phpを出力します。</p>

<ul>
  <li>コンパイルをすれば全てのクラスでインジェクションを行うのでランタイムでDIのエラーが出る可能性が極めて低くなります。</li>
  <li><code class="language-plaintext highlighter-rouge">.env</code>には含まれた内容はPHPファイルに取り込まれるのでコンパイル後に<code class="language-plaintext highlighter-rouge">.env</code>を消去可能です。</li>
</ul>

<p>コンテントネゴシエーションを行う場合など(ex. api-app, html-app)1つのアプリケーションで複数コンテキストのコンパイルを行うときにはファイルの退避が必要です。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mv autoload.php api.autoload.php
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">composer.json</code>を編集して<code class="language-plaintext highlighter-rouge">composer compile</code>の内容を変更します。</p>

<h3 id="autoloadphp">autoload.php</h3>

<p><code class="language-plaintext highlighter-rouge">{project_path}/autoload.php</code>に最適化されたautoload.phpファイルが出力されます。
<code class="language-plaintext highlighter-rouge">composer dumpa-autoload --optimize</code>で出力される<code class="language-plaintext highlighter-rouge">vendor/autoload.php</code>よりずっと高速です。</p>

<p>注意：<code class="language-plaintext highlighter-rouge">preload.php</code>を利用する場合、ほとんどの利用クラスが読み込まれた状態で起動するのでコンパイルされた<code class="language-plaintext highlighter-rouge">autoload.php</code>は不要です。composerが生成する<code class="language-plaintext highlighter-rouge">vendor/autload.php</code>をご利用ください。</p>

<h3 id="preloadphp">preload.php</h3>

<p><code class="language-plaintext highlighter-rouge">{project_path}/preload.php</code>に最適化されたpreload.phpファイルが出力されます。
preloadを有効にするためにはphp.iniで<a href="https://www.php.net/manual/ja/opcache.configuration.php#ini.opcache.preload">opcache.preload</a>、<a href="https://www.php.net/manual/ja/opcache.configuration.php#ini.opcache.preload-user">opcache.preload</a>を指定する必要があります。PHP 7.4でサポートされた機能ですが、<code class="language-plaintext highlighter-rouge">7.4</code>初期のバージョンでは不安定です。<code class="language-plaintext highlighter-rouge">7.4.4</code>以上の最新版を使いましょう。</p>

<p>例）</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opcache.preload=/path/to/project/preload.php
opcache.preload_user=www-data
</code></pre></div></div>

<p>Note: パフォーマンスベンチマークは[bechmark](https://github.com/bearsunday/BEAR.HelloworldBenchmark/wiki/Intel-Core-i5-3.8-GHz-iMac-(Retina-5K,-27-inch,-2017)-</p>

<ul>
  <li>このマニュアルはBEAR.Package 0.10に対応したマニュアルです。これ以前のものは<a href="/manuals/1.0/ja/archive/production1.html">/manuals/1.0/ja/archive/production1.html</a>をご覧ください。</li>
</ul>

<h1 id="psr-7">PSR-7</h1>

<p><a href="https://www.php-fig.org/psr/psr-7/">PSR7 HTTP message interface</a><sup id="fnref:1:2" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">3</a></sup>を使ってサーバーサイドリクエストの情報を取得したり、BEAR.SundayアプリケーションをPSR7ミドルウエアとして実行する事ができます。</p>

<h2 id="httpリクエスト">HTTPリクエスト</h2>

<p>PHPには<a href="http://php.net/manual/ja/reserved.variables.server.php"><code class="language-plaintext highlighter-rouge">$_SERVER</code></a>や<a href="http://php.net/manual/ja/reserved.variables.cookies.php"><code class="language-plaintext highlighter-rouge">$_COOKIE</code></a>などの<a href="http://php.net/manual/ja/language.variables.superglobals.php">スーパーグローバル</a>がありますが、
それらの代わりに<a href="https://www.php-fig.org/psr/psr-7/">PSR7 HTTP message interface</a>を使ってサーバーサイドリクエストの情報(<code class="language-plaintext highlighter-rouge">$_COOKIE</code>, <code class="language-plaintext highlighter-rouge">$_GET</code>, <code class="language-plaintext highlighter-rouge">$_POST</code>, <code class="language-plaintext highlighter-rouge">$_FILES</code>, <code class="language-plaintext highlighter-rouge">$_SERVER</code>)を受け取ることができます。</p>

<h3 id="serverrequest-サーバーリクエスト全般">ServerRequest （サーバーリクエスト全般）</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">ServerRequestInterface</span> <span class="nv">$serverRequest</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// retrieve cookies</span>
        <span class="nv">$cookie</span> <span class="o">=</span> <span class="nv">$serverRequest</span><span class="o">-&gt;</span><span class="nf">getCookieParams</span><span class="p">();</span> <span class="c1">// $_COOKIE</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="アップロードファイル">アップロードファイル</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">use</span> <span class="nc">Psr\Http\Message\UploadedFileInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\HttpMessage\Annotation\UploadFiles</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="cd">/**
     * @UploadFiles
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$files</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// retrieve file name</span>
        <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$files</span><span class="p">[</span><span class="s1">'my-form'</span><span class="p">][</span><span class="s1">'details'</span><span class="p">][</span><span class="s1">'avatar'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="cm">/* @var UploadedFileInterface $file */</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="nf">getClientFilename</span><span class="p">();</span> <span class="c1">// my-avatar3.png</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="uri">URI</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">use</span> <span class="nc">Psr\Http\Message\UriInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">UriInterface</span> <span class="nv">$uri</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// retrieve host name</span>
        <span class="nv">$host</span> <span class="o">=</span> <span class="nv">$uri</span><span class="o">-&gt;</span><span class="nf">getHost</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="psr7ミドルウエア">PSR7ミドルウエア</h2>

<p>既存のBEAR.Sundayアプリケーションは特別な変更無しに<a href="http://www.php-fig.org/psr/psr-7/">PSR-7</a>ミドルウエアとして動作させることができます。</p>

<p>以下のコマンドで<code class="language-plaintext highlighter-rouge">bear/middleware</code>を追加して、ミドルウエアとして動作させるための<a href="https://github.com/bearsunday/BEAR.Middleware/blob/1.x/bootstrap/bootstrap.php">bootstrapスクリプト</a>に置き換えます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require bear/middleware
<span class="nb">cp </span>vendor/bear/middleware/bootstrap/bootstrap.php bootstrap/bootstrap.php
</code></pre></div></div>

<p>次にスクリプトの<code class="language-plaintext highlighter-rouge">__PACKAGE__\__VENDOR__</code>をアプリケーションの名前に変更すれば完了です。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php <span class="nt">-S</span> 127.0.0.1:8080 <span class="nt">-t</span> public
</code></pre></div></div>

<h3 id="ストリーム">ストリーム</h3>

<p>ミドルウエアに対応したBEAR.Sundayのリソースは<a href="http://php.net/manual/ja/intro.stream.php">ストリーム</a>の出力に対応しています。</p>

<p>HTTP出力は<code class="language-plaintext highlighter-rouge">StreamTransfer</code>が標準です。詳しくは<a href="http://bearsunday.github.io/manuals/1.0/ja/stream.html">ストリーム出力</a>をご覧ください。</p>

<h3 id="新規プロジェクト">新規プロジェクト</h3>

<p>新規でPSR-7のプロジェクトを始めることもできます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer create-project bear/project my-awesome-project
cd my-awesome-project/
php -S 127.0.0.1:8080 -t public
</code></pre></div></div>

<h3 id="psr-7ミドルウエア">PSR-7ミドルウエア</h3>

<ul>
  <li><a href="https://github.com/oscarotero/psr7-middlewares">oscarotero/psr7-middlewares</a></li>
</ul>

<hr />

<h1 id="クイックapi">クイックAPI</h1>

<p>このチュートリアルではデータベースを用いた<a href="https://github.com/koriym/Koriym.DbAppPackage">API用のパッケージ</a>と以下の４つのSQLファイルを使ってWeb APIを作成します。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">completed</span> <span class="k">FROM</span> <span class="n">task</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">completed</span> <span class="k">FROM</span> <span class="n">task</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">task</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">completed</span><span class="p">,</span> <span class="n">created</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(:</span><span class="n">title</span><span class="p">,</span> <span class="p">:</span><span class="n">completed</span><span class="p">,</span> <span class="p">:</span><span class="n">created</span><span class="p">);</span>
<span class="k">UPDATE</span> <span class="n">task</span> <span class="k">SET</span> <span class="n">completed</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span><span class="p">;</span>
</code></pre></div></div>

<h1 id="インストール-7">インストール</h1>

<p>API用プロジェクトのスケルトンをcomposerインストールします。　</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer create-project bear/skeleton MyVendor.Task
</code></pre></div></div>

<p>ベンダー名とパッケージ名をそれぞれ<code class="language-plaintext highlighter-rouge">MyVendor</code>、<code class="language-plaintext highlighter-rouge">Task</code>と入力します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>What is the vendor name ?

(MyVendor):

What is the project name ?

(MyProject):Task
</code></pre></div></div>

<h1 id="データベース-2">データベース</h1>

<p>データベースパッケージをcomposerインストールします。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd MyVendor.Task
composer require koriym/db-app-package
php vendor/koriym/db-app-package/bin/install.php
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">AppModule::configure()</code>でインストールしている<code class="language-plaintext highlighter-rouge">PackageModule</code>を<code class="language-plaintext highlighter-rouge">DbAppPackage</code>に変更します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">DbAppPackage</span><span class="p">(</span><span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'DB_DSN'</span><span class="p">],</span> <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'DB_USER'</span><span class="p">],</span> <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'DB_PASS'</span><span class="p">],</span> <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'DB_READ'</span><span class="p">]));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a href="https://github.com/koriym/Koriym.DbAppPackage"><code class="language-plaintext highlighter-rouge">DbAppPackage</code></a>は<code class="language-plaintext highlighter-rouge">PackageModule</code>に以下の特定のパッケージを追加したものです。</p>

<ul>
  <li><a href="https://github.com/auraphp/Aura.Router/tree/2.x">Aura.Router v2</a> Webルーター</li>
  <li><a href="https://github.com/auraphp/Aura.Sql">Aura.Sql v2</a> PDOを拡張したSQLアダプター</li>
  <li><a href="https://github.com/auraphp/Aura.SqlQuery">Aura.SqlQuery v2</a> クエリービルダー</li>
  <li><a href="https://phinx.org/">Phinx</a> データベースマイグレーション</li>
  <li><a href="https://github.com/koriym/Koriym.QueryLocator">Koriym.QueryLocator</a> SQLロケーター</li>
  <li><a href="https://github.com/koriym/Koriym.DevPdoStatement">Koriym.DevPdoDtatement</a> SQLクエリー調査のための開発用PDOStatement</li>
  <li><a href="https://github.com/koriym/Koriym.Now">Koriym.Now</a> 現在時刻</li>
</ul>

<h2 id="接続設定">接続設定</h2>

<p><code class="language-plaintext highlighter-rouge">.env</code>ファイルでデータベース接続を設定します。<code class="language-plaintext highlighter-rouge">DB_DSN</code>のフォーマットは<a href="http://php.net/manual/ja/pdo.connections.php">PDO</a>です。環境に合わせて適宜変更します。</p>

<p>MySQL</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DB_DSN=mysql:host=localhost;dbname=task
DB_USER=root
DB_PASS=
DB_READ=
</code></pre></div></div>

<p>sqlite</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DB_DSN=sqlite:/tmp/task.sq3
DB_USER=
DB_PASS=
DB_READ=
</code></pre></div></div>

<p>スレイブDBを利用する場合は複数のサーバーリストをカンマ区切りで<code class="language-plaintext highlighter-rouge">DB_READ</code>に設定します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DB_READ=slave1.example.com,slave2.example.com
</code></pre></div></div>

<h2 id="作成">作成</h2>

<p>データベースを作成します。（<code class="language-plaintext highlighter-rouge">sqlite</code>の場合は必要ありません）</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/create_db.php
</code></pre></div></div>

<p><a href="http://docs.phinx.org/en/latest/">Phinx</a>でマイグレーションファイルの生成を行います。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php vendor/bin/phinx create -c var/db/phinx.php MyNewMigration  
</code></pre></div></div>

<p>作成されたマイグレーション編集します。<a href="http://docs.phinx.org/en/latest/migrations.html" title="Phinx マニュアル: Writing Migrations">[?]</a></p>

<p><code class="language-plaintext highlighter-rouge">var/db/20160222042911_my_new_migration.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">use</span> <span class="nc">Phinx\Migration\AbstractMigration</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Phinx\Db\Adapter\MysqlAdapter</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">MyNewMigration</span> <span class="kd">extends</span> <span class="nc">AbstractMigration</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">change</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// create the table</span>
        <span class="nv">$table</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">table</span><span class="p">(</span><span class="s1">'task'</span><span class="p">);</span>
        <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'limit'</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">,</span> <span class="s1">'text'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'limit'</span> <span class="o">=&gt;</span> <span class="nc">MysqlAdapter</span><span class="o">::</span><span class="no">INT_TINY</span><span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'created'</span><span class="p">,</span> <span class="s1">'datetime'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>マイグレーションを実行します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php vendor/bin/phinx migrate -c var/db/phinx.php
php vendor/bin/phinx migrate -c var/db/phinx.php -e test
</code></pre></div></div>

<h1 id="ルーティング">ルーティング</h1>

<p><code class="language-plaintext highlighter-rouge">GET /task/1</code>Webリクエストを<code class="language-plaintext highlighter-rouge">Task::onGet($id)</code>メソッドにルートするために<code class="language-plaintext highlighter-rouge">var/conf/aura.route.php</code>
を編集します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @var $router \BEAR\Package\Provide\Router\AuraRoute */</span>
<span class="nv">$router</span><span class="o">-&gt;</span><span class="nf">route</span><span class="p">(</span><span class="s1">'/task'</span><span class="p">,</span> <span class="s1">'/task/{id}'</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">POST</code>や<code class="language-plaintext highlighter-rouge">PATCH</code>もそれぞ対応するメソッドにルートされます。</p>

<h1 id="sql">SQL</h1>

<p>SQLファイルを設置します。</p>

<p><code class="language-plaintext highlighter-rouge">var/db/sql/task_list.sql</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">completed</span> <span class="k">FROM</span> <span class="n">task</span><span class="p">;</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">var/db/sql/task_item.sql</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">completed</span> <span class="k">FROM</span> <span class="n">task</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">var/db/sql/task_insert.sql</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">task</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">completed</span><span class="p">,</span> <span class="n">created</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(:</span><span class="n">title</span><span class="p">,</span> <span class="p">:</span><span class="n">completed</span><span class="p">,</span> <span class="p">:</span><span class="n">created</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">var/db/sql/task_update.sql</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">UPDATE</span> <span class="n">task</span> <span class="k">SET</span> <span class="n">completed</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span><span class="p">;</span>
</code></pre></div></div>

<h1 id="リソース-3">リソース</h1>

<p>SQLを実行するリソースクラスを<code class="language-plaintext highlighter-rouge">src/Resource/App/Task.php</code>に作成します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Task\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\Now\NowInject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\QueryLocator\QueryLocatorInject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlInject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Task</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">AuraSqlInject</span><span class="p">;</span>
    <span class="kn">use</span> <span class="nc">NowInject</span><span class="p">;</span>
    <span class="kn">use</span> <span class="nc">QueryLocatorInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span> <span class="o">=</span> <span class="kc">null</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="nv">$id</span> <span class="o">?</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">fetchOne</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">[</span><span class="s1">'task_item'</span><span class="p">],</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">])</span> <span class="o">:</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">fetchAssoc</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">[</span><span class="s1">'task_list'</span><span class="p">]);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$title</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$params</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">,</span>
            <span class="s1">'created'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">,</span>
            <span class="s1">'completed'</span> <span class="o">=&gt;</span> <span class="kc">false</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">perform</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">[</span><span class="s1">'task_insert'</span><span class="p">],</span> <span class="nv">$params</span><span class="p">);</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">lastInsertId</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">201</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"/task?id=</span><span class="si">{</span><span class="nv">$id</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onPatch</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$params</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">,</span>
            <span class="s1">'completed'</span> <span class="o">=&gt;</span> <span class="kc">true</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">perform</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">[</span><span class="s1">'task_update'</span><span class="p">],</span> <span class="nv">$params</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="実行">実行</h1>

<p>まずはリソースをコンソールで実行します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php options /task
php bin/app.php post '/task?title=run'
php bin/app.php patch /task/1
php bin/app.php get /task/1
</code></pre></div></div>

<p>次に同じリソースをWebでアクセスするためにWebサーバーをスタートさせます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php -S 127.0.0.1:8080 bin/app.php
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">curl</code>コマンドでアクセスします。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -i -X OPTIONS http://127.0.0.1:8080/task
curl -i -X POST --form "title=mail" http://127.0.0.1:8080/task
curl -i -X PATCH http://127.0.0.1:8080/task/1
curl -i -X GET http://127.0.0.1:8080/task/1
</code></pre></div></div>

<h2 id="テスト-1">テスト</h2>

<p>リソースの操作をテストするためにTaskリソースのテストコードを<code class="language-plaintext highlighter-rouge">/tests/Resource/App/TaskTest.php</code>に追加します。<a href="https://phpunit.de/manual/current/ja/writing-tests-for-phpunit.html" title="PHPUnit 用のテストの書き方">[?]</a></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">namespace</span> <span class="nn">MyVendor\Task\Resource\Page</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\DbAppPackage\AbstractDatabaseTestCase</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">TaskTest</span> <span class="kd">extends</span> <span class="nc">AbstractDatabaseTestCase</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">URI</span> <span class="o">=</span> <span class="s1">'app://self/task'</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">testOnPost</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'shopping'</span><span class="p">];</span>
        <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">post</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="no">URI</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">withQuery</span><span class="p">(</span><span class="nv">$query</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">eager</span><span class="o">-&gt;</span><span class="nf">request</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="nv">$page</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertArrayHasKey</span><span class="p">(</span><span class="s1">'Location'</span><span class="p">,</span> <span class="nv">$page</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$page</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @depends testOnPost
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testPatch</span><span class="p">(</span><span class="kt">ResourceObject</span> <span class="nv">$page</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$uri</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'app://self%s'</span><span class="p">,</span> <span class="nv">$page</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">]);</span>
        <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">patch</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="nv">$uri</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">eager</span><span class="o">-&gt;</span><span class="nf">request</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nv">$page</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$page</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @depends testOnPost
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testGet</span><span class="p">(</span><span class="kt">ResourceObject</span> <span class="nv">$page</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$uri</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'app://self%s'</span><span class="p">,</span> <span class="nv">$page</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">]);</span>
        <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">get</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="nv">$uri</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">eager</span><span class="o">-&gt;</span><span class="nf">request</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="s1">'shopping'</span><span class="p">,</span> <span class="nv">$page</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="s1">'1'</span><span class="p">,</span> <span class="nv">$page</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'completed'</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">phpunit</code>を実行します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phpunit

...
OK (5 tests, 8 assertions)
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">composer test</code>を実行するとコーディングスタイルをチェックする<a href="https://github.com/squizlabs/PHP_CodeSniffer/wiki">phpcs</a>, <a href="https://phpmd.org/about.html">phpmd</a>も合わせて実行されます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer test
</code></pre></div></div>

<h3 id="フィクスチャ">フィクスチャ</h3>

<p><a href="https://phpunit.de/manual/current/ja/database.html#database.set-up-fixture">フィクスチャ</a>とは、アプリケーションやデータベースの初期状態のことです。テストによっては特定のデータベースの状態を前提にしたいことがあります。MySql専用ですがフィクスチャの用意はを簡単です。</p>

<p>まずDBUnitのための接続情報を<code class="language-plaintext highlighter-rouge">tests/phpunit.xml</code>に追加します</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;phpunit</span> <span class="na">bootstrap=</span><span class="s">"tests/bootstrap.php"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;php&gt;</span>
        <span class="nt">&lt;var</span> <span class="na">name=</span><span class="s">"DB_DSN"</span> <span class="na">value=</span><span class="s">"mysql:host=localhost"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;var</span> <span class="na">name=</span><span class="s">"DB_USER"</span> <span class="na">value=</span><span class="s">"root"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;var</span> <span class="na">name=</span><span class="s">"DB_PASSWD"</span> <span class="na">value=</span><span class="s">""</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;var</span> <span class="na">name=</span><span class="s">"DB_DBNAME"</span> <span class="na">value=</span><span class="s">"task_test"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/php&gt;</span>
    ```
</code></pre></div></div>

<p>DBを保存したい状態にしておいて、テストクラスと同じ階層の<code class="language-plaintext highlighter-rouge">fixtures </code>ディレクトリに<code class="language-plaintext highlighter-rouge">mysqldump </code>コマンドで既存のデータベースの状態をdumpします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysqldump <span class="nt">--xml</span> <span class="nt">-t</span> <span class="nt">-u</span> <span class="o">[</span>username] <span class="nt">--password</span><span class="o">=[</span>password] <span class="o">[</span>database] <span class="o">&gt;</span> /path/to/file.xml
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>├── TaskTest.php
└── fixtures
    ├── tag.xml
    └── task.xml
</code></pre></div></div>

<p>複数のxmlは合成され１つのフィクスチャになり、テスト実行前のデータベース状態を再現できます。</p>

<h2 id="スクリプト">スクリプト</h2>

<p>再度環境構築をするために<code class="language-plaintext highlighter-rouge">composer.json</code>の<code class="language-plaintext highlighter-rouge">scripts</code>に以下のコードを追加します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"scripts": {
    "setup": [
        "php bin/create_db.php",
        "php vendor/bin/phinx migrate -c var/db/phinx.php"
    ],
</code></pre></div></div>

<p>setupコマンドで環境構築できます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer setup
</code></pre></div></div>

<h2 id="その他の方法">その他の方法</h2>

<p>依存をコンストラクタではなく、メソッドのパラメーターで受け取る事もできます。（アシスティッドインジェクション）</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Task\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Aura\Sql\ExtendedPdoInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\Now\NowInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\QueryLocator\QueryLocatorInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\Di\Assisted</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Task</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="cd">/**
     * @Assisted({"pdo", "query"})
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="kt">ExtendedPdoInterface</span> <span class="nv">$pdo</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="kt">QueryLocatorInterface</span> <span class="nv">$query</span> <span class="o">=</span> <span class="kc">null</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="nv">$id</span> <span class="o">?</span>
            <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchOne</span><span class="p">(</span><span class="nv">$query</span><span class="p">[</span><span class="s1">'task_item'</span><span class="p">],</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">])</span> <span class="o">:</span>
            <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchAssoc</span><span class="p">(</span><span class="nv">$query</span><span class="p">[</span><span class="s1">'task_list'</span><span class="p">]);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @Assisted({"pdo", "query", "now"})
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$title</span><span class="p">,</span> <span class="kt">ExtendedPdoInterface</span> <span class="nv">$pdo</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="kt">QueryLocatorInterface</span> <span class="nv">$query</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="kt">NowInterface</span> <span class="nv">$now</span> <span class="o">=</span> <span class="kc">null</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$params</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">,</span>
            <span class="s1">'created'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nv">$now</span><span class="p">,</span>
            <span class="s1">'completed'</span> <span class="o">=&gt;</span> <span class="kc">false</span>
        <span class="p">];</span>
        <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">perform</span><span class="p">(</span><span class="nv">$query</span><span class="p">[</span><span class="s1">'task_insert'</span><span class="p">],</span> <span class="nv">$params</span><span class="p">);</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">lastInsertId</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">201</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"/task?id=</span><span class="si">{</span><span class="nv">$id</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @Assisted({"pdo", "query"})
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPatch</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">ExtendedPdoInterface</span> <span class="nv">$pdo</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="kt">QueryLocatorInterface</span> <span class="nv">$query</span> <span class="o">=</span> <span class="kc">null</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$params</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">,</span>
            <span class="s1">'completed'</span> <span class="o">=&gt;</span> <span class="kc">true</span>
        <span class="p">];</span>
        <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">perform</span><span class="p">(</span><span class="nv">$query</span><span class="p">[</span><span class="s1">'task_update'</span><span class="p">],</span> <span class="nv">$params</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>条件によって動的に変わるSQLは<a href="http://bearsunday.github.io/manuals/1.0/ja/database.html#aurasqlquery">Aura.SqlQuery</a>クエリービルダーを利用するのが良いでしょう。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Task\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Aura\Sql\ExtendedPdoInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Aura\SqlQuery\Common\InsertInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Aura\SqlQuery\Common\SelectInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Aura\SqlQuery\Common\UpdateInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\Now\NowInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\Di\Assisted</span><span class="p">;</span>

<span class="cd">/**
 * with assisted injection + query builder
 */</span>
<span class="kd">class</span> <span class="nc">TaskQb</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="cd">/**
     * @Assisted({"pdo", "select"})
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="kt">ExtendedPdoInterface</span> <span class="nv">$pdo</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="kt">SelectInterface</span> <span class="nv">$select</span> <span class="o">=</span> <span class="kc">null</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$select</span><span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'title'</span><span class="p">,</span> <span class="s1">'completed'</span><span class="p">])</span><span class="o">-&gt;</span><span class="nf">from</span><span class="p">(</span><span class="s1">'task'</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">onGetItem</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$pdo</span><span class="p">,</span> <span class="nv">$select</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="nv">$select</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchAssoc</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @Assisted({"pdo", "insert", "now"})
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$title</span><span class="p">,</span> <span class="kt">ExtendedPdoInterface</span> <span class="nv">$pdo</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="kt">InsertInterface</span> <span class="nv">$insert</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="kt">NowInterface</span> <span class="nv">$now</span> <span class="o">=</span> <span class="kc">null</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$params</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">,</span>
            <span class="s1">'created'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nv">$now</span><span class="p">,</span>
            <span class="s1">'completed'</span> <span class="o">=&gt;</span> <span class="kc">false</span>
        <span class="p">];</span>
        <span class="nv">$insert</span>
            <span class="o">-&gt;</span><span class="nf">into</span><span class="p">(</span><span class="s1">'task'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'completed'</span><span class="p">,</span> <span class="s1">'created'</span><span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">bindValues</span><span class="p">(</span><span class="nv">$params</span><span class="p">);</span>
        <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">perform</span><span class="p">(</span><span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">(),</span> <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$insert</span><span class="o">-&gt;</span><span class="nf">getLastInsertIdName</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">lastInsertId</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">201</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"/task?id=</span><span class="si">{</span><span class="nv">$id</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @Assisted({"pdo", "query"})
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPatch</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">ExtendedPdoInterface</span> <span class="nv">$pdo</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="kt">UpdateInterface</span> <span class="nv">$update</span> <span class="o">=</span> <span class="kc">null</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">,</span>
            <span class="s1">'completed'</span> <span class="o">=&gt;</span> <span class="kc">true</span>
        <span class="p">];</span>
        <span class="nv">$update</span>
            <span class="o">-&gt;</span><span class="nf">table</span><span class="p">(</span><span class="s1">'task'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">cols</span><span class="p">([</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'completed'</span><span class="p">,</span> <span class="s1">'created'</span><span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'id = :id'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">bindValues</span><span class="p">(</span><span class="nv">$values</span><span class="p">);</span>
        <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">perform</span><span class="p">(</span><span class="nv">$update</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">(),</span> <span class="nv">$update</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">onGetItem</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">ExtendedPdoInterface</span> <span class="nv">$pdo</span><span class="p">,</span> <span class="kt">SelectInterface</span> <span class="nv">$select</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$select</span><span class="o">-&gt;</span><span class="nf">where</span><span class="p">(</span><span class="s1">'id = :id'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">bindValue</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nv">$id</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nf">fetchOne</span><span class="p">(</span><span class="nv">$select</span><span class="o">-&gt;</span><span class="nf">getStatement</span><span class="p">(),</span> <span class="nv">$select</span><span class="o">-&gt;</span><span class="nf">getBindValues</span><span class="p">());</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h1 id="まとめ">まとめ</h1>

<p>DBの接続情報を<code class="language-plaintext highlighter-rouge">.env</code>で設定して、SQLのファイルをHTTPのURLにマップされたリソースから呼び出してWeb APIを作成しました。テストでDB状態を復元するにはフィクスチャを使います。フィクスチャには<code class="language-plaintext highlighter-rouge">phpunit.xml</code>に接続情報が必要です。</p>

<p><code class="language-plaintext highlighter-rouge">sql</code>フォルダに集められたSQLは一覧性に優れ、SQL単体テストも容易ですがSQL文を直接リソースクラスに記述することもできます。動的に生成するSQLクエリーはクエリービルダーが向いています。依存はコンストラクタだけではなく、実行時のメソッドでも受け取れます。</p>

<p>このチュートリアルで作成したプロジェクトの作成履歴はMyVendor.Taskの<a href="https://github.com/bearsunday/MyVendor.Task/commits/master">commitログ</a>で見ることができます。</p>

<p><em>(この<a href="https://github.com/bearsunday/bearsunday.github.io/blob/master/manuals/1.0/ja/quick-api.md">マニュアル</a>でわかりにくいところや、間違えているところがあれば<a href="https://github.com/bearsunday/bearsunday.github.io/issues">issue</a>で教えてください。)</em></p>

<h1 id="クイックスタート">クイックスタート</h1>

<p>インストールは <a href="http://getcomposer.org">composer</a> で行います。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer create-project <span class="nt">-n</span> bear/skeleton MyVendor.MyProject
<span class="nb">cd </span>MyVendor.MyProject
</code></pre></div></div>

<p>次にPageリソースを作成します。PageリソースはWebページに対応したクラスです。 <code class="language-plaintext highlighter-rouge">src/Resource/Page/Hello.php</code>に作成します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\MyProject\Resource\Page</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Hello</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'BEAR.Sunday'</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'greeting'</span> <span class="o">=&gt;</span> <span class="s1">'Hello '</span> <span class="mf">.</span> <span class="nv">$name</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>GETメソッドでリクエストされると<code class="language-plaintext highlighter-rouge">$name</code>に<code class="language-plaintext highlighter-rouge">$_GET['name']</code>が渡されるので、挨拶を<code class="language-plaintext highlighter-rouge">greeting</code>にセットし<code class="language-plaintext highlighter-rouge">$this</code>を返します。</p>

<p>作成したアプリケーションはコンソールでもWebサーバーでも動作します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/page.php get /hello
php bin/page.php get <span class="s1">'/hello?name=World'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
Content-Type: application/hal+json

<span class="o">{</span>
    <span class="s2">"greeting"</span>: <span class="s2">"Hello World"</span>,
    <span class="s2">"_links"</span>: <span class="o">{</span>
        <span class="s2">"self"</span>: <span class="o">{</span>
            <span class="s2">"href"</span>: <span class="s2">"/hello?name=World"</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ビルトインウェブサーバーを起動し</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php <span class="nt">-S</span> 127.0.0.1:8080 <span class="nt">-t</span> public
</code></pre></div></div>

<p>webブラウザまたはcurlコマンドで<a href="http://127.0.0.1:8080/hello">http://127.0.0.1:8080/hello</a>をリクエストします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> 127.0.0.1:8080/hello
</code></pre></div></div>

<p>このマニュアルはphp7.0のみに対応したものです。php7.1以上では<a href="reactjs.html">reactjs.html</a>をご覧ください。</p>

<h1 id="redux-uiチュートリアル">Redux UIチュートリアル</h1>

<p>このチュートリアルではTwigテンプレートエンジン等の代わりにV8JsとRudux-ReactJsを使ってHTMLレンダリングします。
マルチエントリーの非SPAアプリケーションを主な対象としていてJavaScriptではルーターは使用していません。</p>

<p>既存のテンプレートエンジンを使ったWebアプリケーションから、ページ単位でRedux React UIを使ったアプリケーションに移行することができます。</p>

<h2 id="前提条件-1">前提条件</h2>

<ul>
  <li>php7.0</li>
  <li>V8Js</li>
  <li>node</li>
  <li>yarn</li>
</ul>

<h2 id="インストール-8">インストール</h2>

<p>BEAR.Sundayプロジェクトを作成します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer create-project bear/skeleton MyVendor.MyRedux
</code></pre></div></div>
<p><strong>vendor</strong>名を<code class="language-plaintext highlighter-rouge">MyVendor</code>に<strong>project</strong>名を<code class="language-plaintext highlighter-rouge">MyRedux</code>として入力します。</p>

<p>次に<code class="language-plaintext highlighter-rouge">BEAR.ReactJsModule</code>をインストールします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>MyVendor.MyRedux
composer require bear/reactjs-module　~0.3
</code></pre></div></div>

<p>Reduxのスケルトンアプリをインストールします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> <span class="nt">-r</span> vendor/bear/reactjs-module/ui-skeleton/redux/ui <span class="nb">.</span>
<span class="nb">cp </span>vendor/bear/reactjs-module/ui-skeleton/redux/package.json <span class="nb">.</span>
yarn <span class="nb">install</span>
</code></pre></div></div>

<h2 id="redux-uiの作成">Redux UIの作成</h2>

<p><code class="language-plaintext highlighter-rouge">example</code>からcpして<code class="language-plaintext highlighter-rouge">hello</code>ページを作成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp -r ui/src/page/example ui/src/page/hello
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ui/entry.js</code>を変更します。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">react</span><span class="p">:</span> <span class="dl">'</span><span class="s1">src/react-bundle.js</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">ssr_hello</span><span class="p">:</span> <span class="dl">'</span><span class="s1">src/page/hello/app/server</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">hello</span><span class="p">:</span> <span class="p">[</span>
    <span class="dl">'</span><span class="s1">webpack/hot/dev-server</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">webpack-hot-middleware/client</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">src/page/hello/app/client</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">],</span>
<span class="p">};</span>
</code></pre></div></div>

<p>lintやtest、buildを試してみましょう。（必須ではありません）</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn run lint
yarn run test
^C
yarn run build
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code>にモジュールをインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">php</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\MyRedux\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Package\PackageModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\ReactJsModule\ReduxModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">josegonzalez\Dotenv\Loader</span> <span class="k">as</span> <span class="nc">Dotenv</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//configure()に追加</span>
        <span class="nv">$distDir</span> <span class="o">=</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/var/www/dist'</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">ReduxModule</span><span class="p">(</span><span class="nv">$distDir</span><span class="p">,</span> <span class="s1">'ssr_hello'</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">PackageModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="リソースの作成">リソースの作成</h2>

<p>既存の<code class="language-plaintext highlighter-rouge">src/Resource/Page/Index.php</code>を変更します。リソースオブジェクトのレンダラーをRedux UIにするために<code class="language-plaintext highlighter-rouge">setRenderer</code>セッターインジェクションに<code class="language-plaintext highlighter-rouge">@Inject</code>と<code class="language-plaintext highlighter-rouge">@Named</code>をアノテートします。<code class="language-plaintext highlighter-rouge">@Named</code>の値は<code class="language-plaintext highlighter-rouge">ReduxModule</code>で指定したJSアプリケーションの名前と同じにします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">php</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\MyRedux\Resource\Page</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\RenderInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\Di\Inject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\Di\Named</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="cd">/**
     * @Inject
     * @Named("ssr_hello")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">setRenderer</span><span class="p">(</span><span class="kt">RenderInterface</span> <span class="nv">$renderer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="nf">setRenderer</span><span class="p">(</span><span class="nv">$renderer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="nv">$name</span> <span class="o">=</span> <span class="s1">'BEAR.Sunday'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'To '</span> <span class="mf">.</span> <span class="nv">$name</span><span class="p">,</span>
            <span class="s1">'hello'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'Hello '</span> <span class="mf">.</span> <span class="nv">$name</span><span class="p">]</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="テンプレートの作成">テンプレートの作成</h2>

<p>リソースのテンプレート<code class="language-plaintext highlighter-rouge">src/Resource/Page/Index.html.php </code>を作成します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">php</span>
<span class="cm">/* @var $ssr BEAR\ReactJsModule\Ssr */</span>
<span class="k">list</span><span class="p">(</span><span class="nv">$markup</span><span class="p">,</span> <span class="nv">$script</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$ssr</span><span class="o">-&gt;</span><span class="nf">render</span><span class="p">([</span><span class="s1">'hello'</span><span class="p">]);</span>

<span class="k">return</span> <span class="sh">&lt;&lt;&lt;"EOT"
&lt;!doctype&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;{$ssr-&gt;escape('title')}&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div id="root"&gt;{$markup}&lt;/div&gt;
  &lt;script src="build/react.bundle.js"&gt;&lt;/script&gt;
  &lt;script src="build/hello.bundle.js"&gt;&lt;/script&gt;
  &lt;script&gt;{$script}&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
EOT;</span>
</code></pre></div></div>

<p>リソースオブジェクトから<code class="language-plaintext highlighter-rouge">preloadedState</code>として使う値のキーだけを指定して<code class="language-plaintext highlighter-rouge">render()</code>します。上記リソースから<strong>ページのタイトル</strong>に<code class="language-plaintext highlighter-rouge">title</code>、<strong>ReduxのpreloadedState</strong>に<code class="language-plaintext highlighter-rouge">hello</code>を使用します。</p>

<h2 id="実行-1">実行</h2>

<p><code class="language-plaintext highlighter-rouge">start</code>コマンドを実行するとwebpackが実行され<code class="language-plaintext highlighter-rouge">127.0.0.1:8080</code>でWebサーバーが実行されます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn run start
</code></pre></div></div>

<p>開発用に<code class="language-plaintext highlighter-rouge">dev</code>コマンドを実行すると<code class="language-plaintext highlighter-rouge">phpcs</code>/<code class="language-plaintext highlighter-rouge">phpmd</code>監視や<a href="https://github.com/gaearon/react-hot-loader">HMR</a>、<a href="https://browsersync.io/">browserSync</a>の機能と共に<code class="language-plaintext highlighter-rouge">start</code>が実行されます。 注) HMRはpure functionのコンポーネントには<a href="https://github.com/gaearon/react-transform-hmr/issues/6">対応していないようです</a>。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn run dev
</code></pre></div></div>

<h2 id="デバック-1">デバック</h2>
<ul>
  <li>Chromeプラグイン <a href="https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi">React developer tools</a>、<a href="https://chrome.google.com/webstore/detail/redux-devtools/lmhkpmbekcpmknklioeibfkpmmfibljd">Redux devTools</a>が利用できます。</li>
  <li><code class="language-plaintext highlighter-rouge">{"title":"To BEAR.Sunday","message":"Hello BEAR.Sunday"}</code>などとJSONが出力された場合はレンダラーのインジェクションが行われていなくて、Json Rendererが使用されています。</li>
  <li><code class="language-plaintext highlighter-rouge">Unexpected key "{key}" found in preloadedState</code>の例外は存在しないResouceObject::$bodyのキーを指定していることを示しています。</li>
  <li>500エラーが帰ってくる場合は<code class="language-plaintext highlighter-rouge">var/log</code>や<code class="language-plaintext highlighter-rouge">curl</code> にアクセスしてレスポンス詳細を見てみましょう</li>
</ul>

<p>このチュートリアルで作成したアプリケーションは<a href="https://github.com/bearsunday/MyVendor.MyRedux">MyVendor.MyRedux</a>で参照できます。</p>

<h2 id="リファレンス-1">リファレンス</h2>

<ul>
  <li><a href="http://mitsuruog.github.io/javascript-style-guide/">Airbnb JavaScript スタイルガイド</a></li>
  <li><a href="https://facebook.github.io/react/">React</a></li>
  <li><a href="http://redux.js.org/">Redux</a></li>
  <li><a href="https://github.com/reactjs/redux">Redux github</a></li>
  <li><a href="https://github.com/gaearon/redux-devtools">Redux devtools</a></li>
  <li><a href="http://karma-runner.github.io/1.0/index.html">Karma test runner</a></li>
  <li><a href="https://mochajs.org/">Mocha test framework</a></li>
  <li><a href="http://chaijs.com/">Chai assertion library</a></li>
  <li><a href="https://yarnpkg.com/">Yarn package manager</a></li>
  <li><a href="https://webpack.github.io/">Webapack module bunduler</a></li>
</ul>

<h1 id="redux-uiチュートリアル-1">Redux UIチュートリアル</h1>

<p>このチュートリアルではTwigテンプレートエンジン等の代わりにV8JsとRudux-ReactJsを使ってHTMLレンダリングします。
マルチエントリーの非SPAアプリケーションを主な対象としていてJavaScriptではルーターは使用していません。</p>

<p>既存のテンプレートエンジンを使ったWebアプリケーションから、ページ単位でRedux React UIを使ったアプリケーションに移行することができます。</p>

<h2 id="前提条件-2">前提条件</h2>

<ul>
  <li>php7.1</li>
  <li>V8Js(オプション)</li>
  <li>node</li>
  <li>yarn</li>
</ul>

<p>　※ php7.0での実行は<a href="reactjs-deprecated.html">reactjs-deprecated.html</a>をご覧ください。</p>

<h2 id="インストール-9">インストール</h2>

<p>BEAR.Sundayプロジェクトを作成します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer create-project bear/skeleton MyVendor.MyRedux
</code></pre></div></div>
<p><strong>vendor</strong>名を<code class="language-plaintext highlighter-rouge">MyVendor</code>に<strong>project</strong>名を<code class="language-plaintext highlighter-rouge">MyRedux</code>として入力します。</p>

<p>次に<code class="language-plaintext highlighter-rouge">BEAR.ReactJsModule</code>をインストールします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>MyVendor.MyRedux
composer require bear/reactjs-module ~1.1
</code></pre></div></div>

<p>Reduxのスケルトンアプリををインストールします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> <span class="nt">-r</span> vendor/bear/reactjs-module/ui-skeleton/redux/ui <span class="nb">.</span>
<span class="nb">cp </span>vendor/bear/reactjs-module/ui-skeleton/redux/package.json <span class="nb">.</span>
yarn <span class="nb">install</span>
</code></pre></div></div>

<h2 id="redux-uiの作成-1">Redux UIの作成</h2>

<p><code class="language-plaintext highlighter-rouge">example</code>からcpして<code class="language-plaintext highlighter-rouge">hello</code>ページを作成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp -r ui/src/page/example ui/src/page/hello
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ui/entry.js</code>を変更します。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">react</span><span class="p">:</span> <span class="dl">'</span><span class="s1">src/react-bundle.js</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">ssr_hello</span><span class="p">:</span> <span class="dl">'</span><span class="s1">src/page/hello/app/server</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">hello</span><span class="p">:</span> <span class="p">[</span>
    <span class="dl">'</span><span class="s1">webpack/hot/dev-server</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">webpack-hot-middleware/client</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">src/page/hello/app/client</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">],</span>
<span class="p">};</span>
</code></pre></div></div>

<p>lintやtest、buildを試してみましょう。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn run lint
yarn run test
^C
yarn run build
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code>にモジュールをインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">php</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\MyRedux\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Package\PackageModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\ReactJsModule\ReduxModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">josegonzalez\Dotenv\Loader</span> <span class="k">as</span> <span class="nc">Dotenv</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//configure()に追加</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">ReduxModule</span><span class="p">(</span><span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/var/www/dist, '</span><span class="n">ssr_hello</span><span class="err">'</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">PackageModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="v8jsなしの環境で開発する場合">V8Jsなしの環境で開発する場合</h2>

<p>V8Jsが無い環境でクライアントレンダリングのみでの開発もできます。その場合は以下のように<code class="language-plaintext highlighter-rouge">VoidV8Module</code>をインストールしてください。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">VoidV8Module</span><span class="p">(</span><span class="k">new</span> <span class="nc">ReduxModule</span><span class="p">(</span><span class="nv">$distDir</span><span class="p">,</span> <span class="s1">'ssr_hello'</span><span class="p">)));</span>
</code></pre></div></div>

<h2 id="リソースの作成-1">リソースの作成</h2>

<p>既存の<code class="language-plaintext highlighter-rouge">src/Resource/Page/Index.php</code>を変更します。リソースオブジェクトのレンダラーをRedux UIにするために<code class="language-plaintext highlighter-rouge">setRenderer</code>セッターインジェクションに<code class="language-plaintext highlighter-rouge">@Inject</code>と<code class="language-plaintext highlighter-rouge">@Named</code>をアノテートします。<code class="language-plaintext highlighter-rouge">@Named</code>の値は<code class="language-plaintext highlighter-rouge">ReduxModule</code>で指定したJSアプリケーションの名前と同じにします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">php</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\MyRedux\Resource\Page</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\RenderInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\Di\Inject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\Di\Named</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="cd">/**
     * @Inject
     * @Named("ssr_hello")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">setRenderer</span><span class="p">(</span><span class="kt">RenderInterface</span> <span class="nv">$renderer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="nf">setRenderer</span><span class="p">(</span><span class="nv">$renderer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="nv">$name</span> <span class="o">=</span> <span class="s1">'BEAR.Sunday'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'To '</span> <span class="mf">.</span> <span class="nv">$name</span><span class="p">,</span>
            <span class="s1">'hello'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'Hello '</span> <span class="mf">.</span> <span class="nv">$name</span><span class="p">]</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="テンプレートの作成-1">テンプレートの作成</h2>

<p>リソースのテンプレート<code class="language-plaintext highlighter-rouge">src/Resource/Page/Index.html.php </code>を作成します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">php</span>
<span class="cm">/* @var $ssr BEAR\ReactJsModule\Ssr */</span>
<span class="nv">$view</span> <span class="o">=</span> <span class="nv">$ssr</span><span class="o">-&gt;</span><span class="nf">render</span><span class="p">([</span><span class="s1">'hello'</span><span class="p">]);</span>

<span class="k">return</span> <span class="sh">&lt;&lt;&lt;"EOT"
&lt;!doctype&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;{$ssr-&gt;escape('title')}&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div id="root"&gt;{$view-&gt;markup}&lt;/div&gt;
  &lt;script src="build/react.bundle.js"&gt;&lt;/script&gt;
  &lt;script src="build/hello.bundle.js"&gt;&lt;/script&gt;
  &lt;script&gt;{$view-&gt;js}&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
EOT;</span>
</code></pre></div></div>

<p>リソースオブジェクトから<code class="language-plaintext highlighter-rouge">preloadedState</code>として使う値のキーだけを指定して<code class="language-plaintext highlighter-rouge">render()</code>します。上記リソースから<strong>ページのタイトル</strong>に<code class="language-plaintext highlighter-rouge">title</code>、<strong>ReduxのpreloadedState</strong>に<code class="language-plaintext highlighter-rouge">hello</code>を使用します。</p>

<h2 id="実行-2">実行</h2>

<p><code class="language-plaintext highlighter-rouge">start</code>コマンドを実行するとwebpackが実行され<code class="language-plaintext highlighter-rouge">127.0.0.1:8080</code>でWebサーバーが実行されます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn run start
</code></pre></div></div>

<p>開発用に<code class="language-plaintext highlighter-rouge">dev</code>コマンドを実行すると<code class="language-plaintext highlighter-rouge">phpcs</code>/<code class="language-plaintext highlighter-rouge">phpmd</code>監視や<a href="https://github.com/gaearon/react-hot-loader">HMR</a>、<a href="https://browsersync.io/">browserSync</a>の機能と共に<code class="language-plaintext highlighter-rouge">start</code>が実行されます。 注) HMRはpure functionのコンポーネントには<a href="https://github.com/gaearon/react-transform-hmr/issues/6">対応していないようです</a>。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn run dev
</code></pre></div></div>

<h2 id="デバック-2">デバック</h2>
<ul>
  <li>Chromeプラグイン <a href="https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi">React developer tools</a>、<a href="https://chrome.google.com/webstore/detail/redux-devtools/lmhkpmbekcpmknklioeibfkpmmfibljd">Redux devTools</a>が利用できます。</li>
  <li><code class="language-plaintext highlighter-rouge">{"title":"To BEAR.Sunday","message":"Hello BEAR.Sunday"}</code>などとJSONが出力された場合はレンダラーのインジェクションが行われていなくて、Json Rendererが使用されています。</li>
  <li><code class="language-plaintext highlighter-rouge">Unexpected key "{key}" found in preloadedState</code>の例外は存在しないResouceObject::$bodyのキーを指定していることを示しています。</li>
  <li>500エラーが帰ってくる場合は<code class="language-plaintext highlighter-rouge">var/log</code>や<code class="language-plaintext highlighter-rouge">curl</code> にアクセスしてレスポンス詳細を見てみましょう</li>
</ul>

<p>このチュートリアルで作成したアプリケーションは<a href="https://github.com/bearsunday/MyVendor.MyRedux">MyVendor.MyRedux</a>で参照できます。</p>

<h2 id="リファレンス-2">リファレンス</h2>

<ul>
  <li><a href="http://mitsuruog.github.io/javascript-style-guide/">Airbnb JavaScript スタイルガイド</a></li>
  <li><a href="https://facebook.github.io/react/">React</a></li>
  <li><a href="http://redux.js.org/">Redux</a></li>
  <li><a href="https://github.com/reactjs/redux">Redux github</a></li>
  <li><a href="https://github.com/gaearon/redux-devtools">Redux devtools</a></li>
  <li><a href="http://karma-runner.github.io/1.0/index.html">Karma test runner</a></li>
  <li><a href="https://mochajs.org/">Mocha test framework</a></li>
  <li><a href="http://chaijs.com/">Chai assertion library</a></li>
  <li><a href="https://yarnpkg.com/">Yarn package manager</a></li>
  <li><a href="https://webpack.github.io/">Webapack module bunduler</a></li>
</ul>

<h1 id="リソース-4">リソース</h1>

<p>BEAR.SundayアプリケーションはRESTfulなリソースの集合です。</p>

<h2 id="サービスとしてのオブジェクト">サービスとしてのオブジェクト</h2>

<p><code class="language-plaintext highlighter-rouge">ResourceObject</code>はHTTPのメソッドがPHPのメソッドにマップされたリソースの<strong>サービスのためのオブジェクト</strong>(Object-as-a-service)です。 ステートレスリクエストから、リソースの状態がリソース表現として生成され、クライアントに転送されます。(<a href="http://ja.wikipedia.org/wiki/REST">Representational State Transfer)</a></p>

<p>以下は、ResourceObjectの例です。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$code</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$headers</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$a</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$b</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'sum'</span> <span class="o">=&gt;</span> <span class="nv">$a</span> <span class="o">+</span> <span class="nv">$b</span>  <span class="c1">// $_GET['a'] + $_GET['b']</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$todo</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">201</span><span class="p">;</span> <span class="c1">// ステータスコード</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span> <span class="o">=</span> <span class="p">[</span> <span class="c1">// ヘッダー</span>
            <span class="s1">'Location'</span> <span class="o">=&gt;</span> <span class="s1">'/todo/new_id'</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>PHPのリソースクラスはWebのURIと同じような<code class="language-plaintext highlighter-rouge">page://self/index</code>などのURIを持ち、HTTPのメソッドに準じた<code class="language-plaintext highlighter-rouge">onGet</code>, <code class="language-plaintext highlighter-rouge">onPost</code>などのonメソッドを持ちます。onメソッドで与えられたパラメーターから自身のリソース状態<code class="language-plaintext highlighter-rouge">code</code>,<code class="language-plaintext highlighter-rouge">headers</code>,<code class="language-plaintext highlighter-rouge">body</code>を決定し<code class="language-plaintext highlighter-rouge">$this</code>を返します。</p>

<h2 id="uri-1">URI</h2>

<p>URIはPHPのクラスにマップされています。アプリケーションではクラス名の代わりにURIを使ってリソースにアクセスします。</p>

<table>
  <tbody>
    <tr>
      <td>URI</td>
      <td>Class</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h2 id="ベストプラクティス">ベストプラクティス</h2>

<p>RESTではリソースは他のリソースと接続されています。リンクをうまく使うとコードは簡潔になり、読みやすくテストや変更が容易なコードになります。</p>

<h3 id="embed-1">#[Embed]</h3>

<p>他のリソースの状態を<code class="language-plaintext highlighter-rouge">get</code>する代わりに<code class="language-plaintext highlighter-rouge">#[Embed]</code>でリソースを埋め込みます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// OK but not the best</span>
<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ResourceInterface</span> <span class="nv">$resource</span>
    <span class="p">)</span>

    <span class="kt">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$status</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'todos'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/todos'</span><span class="p">)([</span><span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="nv">$status</span><span class="p">])</span> <span class="c1">// lazy request</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Better</span>
<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[@Embed(rel: 'todos', src: 'app://self/todos{?status}')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$status</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="link-1">#[Link]</h3>

<p>他のリソースの状態を変えるときに<code class="language-plaintext highlighter-rouge">#[Link]</code>で示された次のアクションを<code class="language-plaintext highlighter-rouge">href()</code>（ハイパーリファレンス）を使って辿ります。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// OK but not the best</span>
<span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ResourceInterface</span> <span class="nv">$resource</span>
    <span class="p">)</span>

    <span class="kt">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$title</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="s1">'app://self/todo'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">301</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">LOCATION</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'/'</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Better</span>
<span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ResourceInterface</span> <span class="nv">$resource</span>
    <span class="p">)</span>

    <span class="c1">#[Link(rel: 'create', href: 'app://self/todo', method: 'post')]</span>
    <span class="kt">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$title</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">href</span><span class="p">(</span><span class="s1">'create'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">301</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">LOCATION</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'/'</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="resourceparam">#[ResourceParam]</h3>

<p>他のリソースをリクエストするために他のリソース結果が必要な場合は<code class="language-plaintext highlighter-rouge">#[ResourceParam]</code>を使います。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// OK but not the best</span>
<span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ResourceInterface</span> <span class="nv">$resource</span>
    <span class="p">)</span>

    <span class="kt">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$nickname</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self/login-user'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'nickname'</span><span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'profile'</span><span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self/profile'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$nickname</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">body</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Better</span>
<span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">ResourceInterface</span> <span class="nv">$resource</span>
    <span class="p">)</span>

    <span class="c1">#[ResourceParam(param: 'name', uri: 'app://self//login-user#nickname')]</span>
    <span class="kt">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$name</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'profile'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self/profile'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">body</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Best</span>
<span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[ResourceParam(param: 'name', uri: 'app://self//login-user#nickname')]</span>
    <span class="c1">#[Embed(rel: 'profile', src: 'app://self/profile')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$name</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'profile'</span><span class="p">]</span><span class="o">-&gt;</span><span class="nf">addQuery</span><span class="p">([</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">]);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="リソースキャッシュ">リソースキャッシュ</h2>

<h3 id="cacheable-1">#[Cacheable]</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\Cacheable</span><span class="p">;</span>

<span class="c1">#[Cacheable]</span>
<span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">#[Cacheable]</code>アトリビュートを加えると時間無制限のキャッシュになり値は<strong>クエリーレポジトリ</strong>という名前のキャッシュストレージに格納されます、<code class="language-plaintext highlighter-rouge">get</code>以外のリクエストがあるとレスポンスが更新されます。この時パラメーターを見て同一のリソースの更新かが判断されます。</p>

<p>キャッシュされたレスポンスはHTTPに準じた<code class="language-plaintext highlighter-rouge">Last-Modified</code>と<code class="language-plaintext highlighter-rouge">ETag</code>ヘッダーが付加されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\Cacheable</span><span class="p">;</span>

<span class="c1">#[Cacheable]</span>
<span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="c1">// read</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$name</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="c1">// update</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>例えばこのクラスでは<code class="language-plaintext highlighter-rouge">-&gt;post(10, 'shopping')</code>というリクエストがあると<code class="language-plaintext highlighter-rouge">id=10</code>のクエリーレポジトリの内容が更新されます。この自動更新を利用しない時は<code class="language-plaintext highlighter-rouge">update</code>をfalseにします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">#[Cacheable update: false]</span>
</code></pre></div></div>

<p>時間を指定するには、<code class="language-plaintext highlighter-rouge">expiry</code>を使って、<code class="language-plaintext highlighter-rouge">short</code>, <code class="language-plaintext highlighter-rouge">medium</code>あるいは<code class="language-plaintext highlighter-rouge">long</code>のいずれかを指定できます。</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">#[Cacheable expiry: 'short']</span>
</code></pre></div></div>

<h2 id="purge-refresh">#[Purge] #[Refresh]</h2>

<p>もう１つの方法は<code class="language-plaintext highlighter-rouge">#[Purge]</code>アノテーションや、<code class="language-plaintext highlighter-rouge">#[Refresh]</code>アノテーションで更新対象のURIを指定することです。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\Purge</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\Refresh</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
   <span class="c1">#[Purge(uri: 'app://self/user/friend?user_id={id}')]</span>
   <span class="c1">#[Refresh(uri: 'app://self/user/profile?user_id={id}')]</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">onPut</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$name</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$age</span><span class="p">))</span><span class="o">:</span> <span class="k">static</span>
</code></pre></div></div>

<p>別のクラスのリソースや関連する複数のリソースのクエリーレポジトリの内容を更新することができます。
<code class="language-plaintext highlighter-rouge">#[Purge]</code>はリソースのキャッシュを消去し<code class="language-plaintext highlighter-rouge">#[Refresh]</code>はキャッシュの再生成をメソッド実行直後に行います。</p>

<p>uri-templateに与えられる値は他と同様に<code class="language-plaintext highlighter-rouge">$body</code>にアサインした値が実引数に優先したものです。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\Purge</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\Refresh</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
   <span class="c1">#[Purge(uri: 'app://self/user/friend?user_id={id}')]</span>
   <span class="c1">#[Refresh(uri: 'app://self/user/profile?user_id={id}')]</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">onPut</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$name</span><span class="p">,</span> <span class="nv">$age</span><span class="p">):</span> <span class="kt">static</span>
</code></pre></div></div>

<h2 id="クエリーリポジトリの直接操作">クエリーリポジトリの直接操作</h2>

<p>クエリーリポジトリに格納されているデータは<code class="language-plaintext highlighter-rouge">QueryRepositoryInterface</code>で受け取ったクライアントで直接<code class="language-plaintext highlighter-rouge">put</code>（保存）したり<code class="language-plaintext highlighter-rouge">get</code>したりすることができます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\QueryRepository\QueryRepositoryInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Foo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
    	  <span class="kt">private</span> <span class="n">readonly</span> <span class="nc">QueryRepositoryInterface</span> <span class="nv">$repository</span>
    <span class="p">)</span> <span class="p">{}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">foo</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// 保存</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">repository</span><span class="o">-&gt;</span><span class="nf">put</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">repository</span><span class="o">-&gt;</span><span class="nf">put</span><span class="p">(</span><span class="nv">$resourceObject</span><span class="p">);</span>

        <span class="c1">// 消去</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">repository</span><span class="o">-&gt;</span><span class="nf">purge</span><span class="p">(</span><span class="nv">$resourceObject</span><span class="o">-&gt;</span><span class="n">uri</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">repository</span><span class="o">-&gt;</span><span class="nf">purge</span><span class="p">(</span><span class="k">new</span> <span class="nc">Uri</span><span class="p">(</span><span class="s1">'app://self/user'</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">repository</span><span class="o">-&gt;</span><span class="nf">purge</span><span class="p">(</span><span class="k">new</span> <span class="nc">Uri</span><span class="p">(</span><span class="s1">'app://self/ad/?id={id}'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">]));</span>

        <span class="c1">// 読み込み</span>
        <span class="p">[</span><span class="nv">$code</span><span class="p">,</span> <span class="nv">$headers</span><span class="p">,</span> <span class="nv">$body</span><span class="p">,</span> <span class="nv">$view</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">repository</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="k">new</span> <span class="nc">Uri</span><span class="p">(</span><span class="s1">'app://self/user'</span><span class="p">));</span>
     <span class="p">}</span>
</code></pre></div></div>

<h1 id="リソースリンク">リソースリンク</h1>

<p>リソースは他のリソースをリンクすることができます。リンクは外部のリソースをリンクする外部リンク<sup id="fnref:LO" role="doc-noteref"><a href="#fn:LO" class="footnote" rel="footnote">11</a></sup>と、リソース自身に他のリソースを埋め込む内部リンク<sup id="fnref:LE" role="doc-noteref"><a href="#fn:LE" class="footnote" rel="footnote">12</a></sup>の２種類あります。</p>

<h2 id="外部リンク">外部リンク</h2>

<p>リンクをリンクの名前の<code class="language-plaintext highlighter-rouge">rel</code>（リレーション）と<code class="language-plaintext highlighter-rouge">href</code>で指定します。<code class="language-plaintext highlighter-rouge">href</code>には正規のURIの他に<a href="https://github.com/ioseb/uri-template">RFC6570 URIテンプレート</a>を指定することができます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">#[Link rel: 'profile', href: '/profile{?id}']</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="nv">$id</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="mi">10</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>上記の例では<code class="language-plaintext highlighter-rouge">href</code>はで表されていて、<code class="language-plaintext highlighter-rouge">$body['id']</code>が<code class="language-plaintext highlighter-rouge">{?id}</code>にアサインされます。<a href="https://stateless.group/hal_specification.html">HAL</a>フォーマットでの出力は以下のようになります。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">
    </span><span class="nl">"_links"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"self"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"href"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/test"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"profile"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"href"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/profile?id=10"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="内部リンク">内部リンク</h2>

<p>リソースは別のリソースを埋め込むことができます。<code class="language-plaintext highlighter-rouge">#[Embed]</code>の<code class="language-plaintext highlighter-rouge">src</code>でリソースを指定します。</p>

<p>内部リンクされたリソースも他のリソースを内部リンクしているかもしれません。その場合また内部リンクのリソースが必要で、それが再起的に繰り返され<strong>リソースグラフ</strong>が得られます。クライアントはリソースを何度もフェッチすることなく目的とするリソース群を一度に取得できます。<sup id="fnref:di" role="doc-noteref"><a href="#fn:di" class="footnote" rel="footnote">13</a></sup>　例えば顧客リソースと商品リソースをそれぞれ呼び出す代わりに、注文リソースで両者を埋め込みます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\Embed</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[Embed(rel: 'sports', src: '/news/sports')]</span>
    <span class="c1">#[Embed(rel: 'weather', src: '/news/weather')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
</code></pre></div></div>

<p>埋め込まれるのはリソース<strong>リクエスト</strong>です。レンダリングの時に実行されますが、その前に<code class="language-plaintext highlighter-rouge">addQuery()</code>メソッドで引数を加えたり<code class="language-plaintext highlighter-rouge">withQuery()</code>で引数を置き換えることができます。</p>

<p><code class="language-plaintext highlighter-rouge">src</code>にはURI templateが利用でき、<strong>リクエストメソッドの引数</strong>がバインドされます。（外部リンクと違って<code class="language-plaintext highlighter-rouge">$body</code>ではありません）</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\Embed</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[Embed(rel: 'website', src: '/website{?id}']</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'website'</span><span class="p">]</span><span class="o">-&gt;</span><span class="nf">addQuery</span><span class="p">([</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">]);</span> <span class="c1">// 引数追加</span>
</code></pre></div></div>

<p><a href="https://github.com/blongden/hal">HAL</a>レンダラーでは<code class="language-plaintext highlighter-rouge">_embedded </code>として扱われます。</p>

<h2 id="リンクリクエスト">リンクリクエスト</h2>

<p>クライアントはハイパーリンクで接続されているリソースをリンクすることができます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$blog</span> <span class="o">=</span> <span class="nv">$this</span>
    <span class="o">-&gt;</span><span class="n">resource</span>
    <span class="o">-&gt;</span><span class="n">get</span>
    <span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/user'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">withQuery</span><span class="p">([</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="nf">linkSelf</span><span class="p">(</span><span class="s2">"blog"</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="n">eager</span>
    <span class="o">-&gt;</span><span class="nf">request</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="n">body</span><span class="p">;</span>
</code></pre></div></div>

<p>リンクは３種類あります。<code class="language-plaintext highlighter-rouge">$rel</code>をキーにして元のリソースの<code class="language-plaintext highlighter-rouge">body</code>リンク先のリソースが埋め込まれます。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">linkSelf($rel)</code> リンク先と入れ替わります。</li>
  <li><code class="language-plaintext highlighter-rouge">linkNew($rel)</code> リンク先のリソースがリンク元のリソースに追加されます</li>
  <li><code class="language-plaintext highlighter-rouge">linkCrawl($rel)</code> リンクをクロールしてリソースグラフを作成します。</li>
</ul>

<h3 id="クロール">クロール</h3>

<p>クロールはリスト（配列）になっているリソースを順番にリンクを辿り、複雑なリソースグラフを構成することができます。
クローラーがwebページをクロールするように、リソースクライアントはハイパーリンクをクロールしてリソースグラフを生成します。</p>

<h4 id="クロール例">クロール例</h4>

<p>author, post, meta, tag, tag/name がそれぞれ関連づけられてあるリソースグラフを考えてみます。
このリソースグラフに <strong>post-tree</strong> という名前を付け、それぞれのリソースの<code class="language-plaintext highlighter-rouge">#[Link]</code>アトリビュートでハイパーリファレンス <strong>href</strong> を指定します。</p>

<p>最初に起点となるauthorリソースにはpostリソースへのハイパーリンクがあります。1:nの関係です。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[Link(crawl: "post-tree", rel: "post", href: "app://self/post?author_id={id}")]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="nv">$id</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span>
</code></pre></div></div>

<p>postリソースにはmetaリソースとtagリソースのハイパーリンクがあります。1:nの関係です。</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[Link(crawl: "post-tree", rel: "meta", href: "app://self/meta?post_id={id}")]</span>
<span class="c1">#[Link(crawl: "post-tree", rel: "tag", href: "app://self/tag?post_id={id}")]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="nv">$author_id</span><span class="p">)</span>
<span class="p">{</span>
</code></pre></div></div>

<p>tagリソースはIDだけでそのIDに対応するtag/nameリソースへのハイパーリンクがあります。1:1の関係です。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[Link(crawl:"post-tree", rel:"tag_name", href:"app://self/tag/name?tag_id={tag_id}")]</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="nv">$post_id</span><span class="p">)</span>
</code></pre></div></div>

<p>それぞれが接続されました。クロール名を指定してリクエストします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$graph</span> <span class="o">=</span> <span class="nv">$resource</span>
  <span class="o">-&gt;</span><span class="n">get</span>
  <span class="o">-&gt;</span><span class="nf">uri</span><span class="p">(</span><span class="s1">'app://self/marshal/author'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">linkCrawl</span><span class="p">(</span><span class="s1">'post-tree'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="n">eager</span>
  <span class="o">-&gt;</span><span class="nf">request</span><span class="p">();</span>
</code></pre></div></div>

<p>リソースクライアントは<code class="language-plaintext highlighter-rouge">#[Link]</code>アトリビュートに指定されたクロール名を発見するとその<strong>rel</strong> 名でリソースを接続してリソースグラフを作成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var_export($graph-&gt;body);

array (
    0 =&gt;
    array (
        'name' =&gt; 'Athos',
        'post' =&gt;
        array (
            0 =&gt;
            array (
                'author_id' =&gt; '1',
                'body' =&gt; 'Anna post #1',
                'meta' =&gt;
                array (
                    0 =&gt;
                    array (
                        'data' =&gt; 'meta 1',
                    ),
                ),
                'tag' =&gt;
                array (
                    0 =&gt;
                    array (
                        'tag_name' =&gt;
                        array (
                            0 =&gt;
                            array (
                                'name' =&gt; 'zim',
                            ),
                        ),
                    ),
 ...
</code></pre></div></div>

<h1 id="リソースパラメーター">リソースパラメーター</h1>

<h2 id="基本">基本</h2>

<p>ResourceObjectが必要なHTTPリクエストやCookieなどのWebのランタイムの値は、メソッドの引数に直接渡されます。</p>

<p>HTTPからリクエストでは<code class="language-plaintext highlighter-rouge">onGet</code>、<code class="language-plaintext highlighter-rouge">onPost</code>メソッドの引数にはそれぞれ<code class="language-plaintext highlighter-rouge">$_GET</code>、<code class="language-plaintext highlighter-rouge">$_POST</code>が変数名に応じて渡されます。例えば下記の<code class="language-plaintext highlighter-rouge">$id</code>は<code class="language-plaintext highlighter-rouge">$_GET['id']</code>が渡されます。入力がHTTPの場合に文字列として渡された引数は指定した型にキャストされます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="c1">// ....</span>
</code></pre></div></div>

<h2 id="パラメーターの型">パラメーターの型</h2>

<h3 id="スカラーパラメーター">スカラーパラメーター</h3>

<p>HTTPで渡されるパラメーターは全て文字列ですが<code class="language-plaintext highlighter-rouge">int</code>など文字列以外の型を指定するとキャストされます。</p>

<h3 id="配列パラメーター">配列パラメーター</h3>

<p>パラメーターはネストされたデータ <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">14</a></sup> でも構いません。JSONやネストされたクエリ文字列で送信されたデータは配列で受け取る事ができます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$user</span><span class="p">):</span><span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">'name'</span><span class="p">];</span> <span class="c1">// bear</span>
</code></pre></div></div>

<h3 id="クラスパラメーター">クラスパラメーター</h3>

<p>パラメータ専用のInputクラスで受け取ることもできます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">User</span> <span class="nv">$user</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="c1">// bear</span>
</code></pre></div></div>

<p>Inputクラスは事前にパラメーターをpublicプロパティにしたものを定義しておきます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">php</span>

<span class="kn">namespace</span> <span class="nn">Vendor\App\Input</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="nv">$name</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>この時、コンストラクタがあるとコールされます。<sup id="fnref:php8" role="doc-noteref"><a href="#fn:php8" class="footnote" rel="footnote">15</a></sup></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">php</span>

<span class="kn">namespace</span> <span class="nn">Vendor\App\Input</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__constrcut</span><span class="p">(</span>
        <span class="kt">public</span> <span class="n">readonly</span> <span class="n">int</span> <span class="nv">$id</span><span class="p">,</span>
        <span class="kt">public</span> <span class="n">readonly</span> <span class="n">string</span> <span class="nv">$name</span>
    <span class="p">}</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ネームスペースは任意です。Inputクラスでは入力データをまとめたり検証したりするメソッドを実装する事ができます。</p>

<h3 id="列挙型パラメーター">列挙型パラメーター</h3>

<p>PHP8.1の<a href="https://www.php.net/manual/ja/language.types.enumerations.php">列挙型</a>を指定して取り得る値を制限することができます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">enum</span> <span class="nc">IceCreamId</span><span class="o">:</span> <span class="n">int</span>
<span class="p">{</span>
    <span class="k">case</span> <span class="no">VANILLA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">case</span> <span class="no">PISTACHIO</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">IceCreamId</span> <span class="nv">$iceCreamId</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$iceCreamId</span><span class="o">-&gt;</span><span class="n">value</span> <span class="c1">// 1 or 2</span>
</code></pre></div></div>

<p>上記の場合1か2以外が渡されると<code class="language-plaintext highlighter-rouge">ParameterInvalidEnumException</code>が発生します。</p>

<h2 id="webコンテキスト束縛">Webコンテキスト束縛</h2>

<p><code class="language-plaintext highlighter-rouge">$_GET</code>や<code class="language-plaintext highlighter-rouge">$_COOKIE</code>などのPHPのスーパーグローバルの値をメソッド内で取得するのではなく、メソッドの引数に束縛することができます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\WebContextParam\Annotation\QueryParam</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">foo</span><span class="p">(</span>
    	  <span class="c1">#[QueryParam('id')] string $id</span>
    <span class="p">):</span> <span class="kt">static</span> <span class="p">{</span>
       <span class="c1">// $id = $_GET['id'];</span>
</code></pre></div></div>

<p>その他<code class="language-plaintext highlighter-rouge">$_ENV</code>、<code class="language-plaintext highlighter-rouge">$_POST</code>、<code class="language-plaintext highlighter-rouge">$_SERVER</code>の値を束縛することでできます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\WebContextParam\Annotation\QueryParam</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebContextParam\Annotation\CookieParam</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebContextParam\Annotation\EnvParam</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebContextParam\Annotation\FormParam</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\WebContextParam\Annotation\ServerParam</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span>
        <span class="c1">#[QueryParam('id')] string $userId,            // $_GET['id'];</span>
        <span class="c1">#[CookieParam('id')] string $tokenId = "0000", // $_COOKIE['id'] or "0000" when unset;</span>
        <span class="c1">#[EnvParam('app_mode')] string $app_mode,      // $_ENV['app_mode'];</span>
        <span class="c1">#[FormParam('token')] string $token,           // $_POST['token'];</span>
        <span class="c1">#[ServerParam('SERVER_NAME') string $server    // $_SERVER['SERVER_NAME'];</span>
    <span class="p">):</span> <span class="kt">static</span> <span class="p">{</span>
</code></pre></div></div>

<p>クライアントが値を指定した時は指定した値が優先され、束縛した値は無効になります。テストの時に便利です。</p>

<h2 id="リソース束縛">リソース束縛</h2>

<p><code class="language-plaintext highlighter-rouge">#[ResourceParam]</code>アノテーションを使えば他のリソースリクエストの結果をメソッドの引数に束縛できます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\ResourceParam</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">News</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span>
        <span class="c1">#[ResourceParam('app://self//login#nickname') string $name</span>
    <span class="p">):</span> <span class="kt">static</span> <span class="p">{</span>
</code></pre></div></div>

<p>この例ではメソッドが呼ばれると<code class="language-plaintext highlighter-rouge">login</code>リソースに<code class="language-plaintext highlighter-rouge">get</code>リクエストを行い<code class="language-plaintext highlighter-rouge">$body['nickname']</code>を<code class="language-plaintext highlighter-rouge">$name</code>で受け取ります。</p>

<h2 id="コンテントネゴシエーション-1">コンテントネゴシエーション</h2>

<p>HTTPリクエストの<code class="language-plaintext highlighter-rouge">content-type</code>ヘッダーがサポートされていてます。 <code class="language-plaintext highlighter-rouge">application/json</code>と<code class="language-plaintext highlighter-rouge">x-www-form-urlencoded</code>メディアタイプを判別してパラメーターに値が渡されます。<sup id="fnref:json" role="doc-noteref"><a href="#fn:json" class="footnote" rel="footnote">16</a></sup></p>

<hr />

<h1 id="レンダリングと転送">レンダリングと転送</h1>

<p><img src="https://bearsunday.github.io/images/screen/4r.png" alt="Resource object internal stucture" /></p>

<p>ResourceObjectのリクエストメソッドではリソースの表現について関心を持ちません。コンテキストに応じて注入されたレンダラーがリソースの表現を生成します。同じアプリケーションがコンテキストを変えるだけでHTMLで出力されたり、JSONで出力されたりします。</p>

<h2 id="遅延評価">遅延評価</h2>

<p>レンダリングはリソースが文字列評価された時に行われます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nv">$weekday</span> <span class="o">=</span> <span class="nv">$api</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self/weekday'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'year'</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">'month'</span><span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'day'</span><span class="o">=&gt;</span> <span class="mi">1</span><span class="p">]);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$weekday</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">);</span>
<span class="c1">//array(1) {</span>
<span class="c1">//    ["weekday"]=&gt;</span>
<span class="c1">//  string(3) "Sat"</span>
<span class="c1">//}</span>

<span class="k">echo</span> <span class="nv">$weekday</span><span class="p">;</span>
<span class="c1">//{</span>
<span class="c1">//    "weekday": "Sat",</span>
<span class="c1">//    "_links": {</span>
<span class="c1">//    "self": {</span>
<span class="c1">//        "href": "/weekday/2000/1/1"</span>
<span class="c1">//        }</span>
<span class="c1">//    }</span>
<span class="c1">//}</span>
</code></pre></div></div>
<h2 id="レンダラー-1">レンダラー</h2>

<p>それぞれのResourceObjectはコンテキストによって指定されたその表現のためのレンダラーが注入されています。リソース特有のレンダリング行う時は<code class="language-plaintext highlighter-rouge">renderer</code>プロパティを注入またはセットします。</p>

<p>例）デフォルトで用意されているJSON表現のレンダラーをスクラッチで書くと</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[Inject]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">setRenderer</span><span class="p">(</span><span class="kt">RenderInterface</span> <span class="nv">$renderer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">renderer</span> <span class="o">=</span> <span class="k">new</span> <span class="kd">class</span> <span class="kd">implements</span> <span class="nc">RenderInterface</span> <span class="p">{</span>
            <span class="k">public</span> <span class="k">function</span> <span class="n">render</span><span class="p">(</span><span class="kt">ResourceObject</span> <span class="nv">$ro</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="s1">'content-type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'application/json;'</span><span class="p">;</span>
                <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">view</span> <span class="o">=</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">);</span>

                <span class="k">return</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="転送">転送</h2>

<p>ルートオブジェクト<code class="language-plaintext highlighter-rouge">$app</code>にインジェクトされたリソース表現をクライアント（コンソールやWebクライアント）に転送します。通常、出力は<code class="language-plaintext highlighter-rouge">header</code>関数や<code class="language-plaintext highlighter-rouge">echo</code>で行われるますが、巨大なデータなどには<a href="stream.html">ストリーム転送</a>が有効です。</p>

<p>リソース特有の転送を行う時は<code class="language-plaintext highlighter-rouge">transfer</code>メソッドをオーバーライドします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">transfer</span><span class="p">(</span><span class="kt">TransferInterface</span> <span class="nv">$responder</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$server</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$responder</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="nv">$server</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="リソースの自律性">リソースの自律性</h2>

<p>リソースはリクエストによって自身のリソース状態を変更、それを表現にして転送する機能を各クラスが持っています。</p>

<h1 id="リソース-5">リソース</h1>

<p>BEAR.Sundayアプリケーションはリンクで接続されたリソースの集合です。</p>

<h2 id="サービスとしてのオブジェクト-1">サービスとしてのオブジェクト</h2>

<p><code class="language-plaintext highlighter-rouge">ResourceObject</code>はHTTPのメソッドがPHPのメソッドにマップされたサービスとしてのオブジェクト (Object as a service)です。ステートレスなリクエストで自身のリソース状態を表現にして転送します。
(<a href="http://ja.wikipedia.org/wiki/REST">Representational State Transfer)</a></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$code</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$headers</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$a</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$b</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'sum'</span> <span class="o">=&gt;</span> <span class="nv">$a</span> <span class="o">+</span> <span class="nv">$b</span>  <span class="c1">// $_GET['a'] + $_GET['b']</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$todo</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">201</span><span class="p">;</span> <span class="c1">// ステータスコード</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span> <span class="o">=</span> <span class="p">[</span> <span class="c1">// ヘッダー</span>
            <span class="s1">'Location'</span> <span class="o">=&gt;</span> <span class="s1">'/todo/new_id'</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>PHPのリソースクラスはWebのURIと同じような<code class="language-plaintext highlighter-rouge">app://self/blog/posts/?id=3</code>, <code class="language-plaintext highlighter-rouge">page://self/index</code>などのURIを持ち、HTTPのメソッドに準じた<code class="language-plaintext highlighter-rouge">onGet</code>, <code class="language-plaintext highlighter-rouge">onPost</code>, <code class="language-plaintext highlighter-rouge">onPut</code>, <code class="language-plaintext highlighter-rouge">onPatch</code>, <code class="language-plaintext highlighter-rouge">onDelete</code>インターフェイスを持ちます。</p>

<p>メソッドでは自身のリソース状態<code class="language-plaintext highlighter-rouge">code</code>,<code class="language-plaintext highlighter-rouge">headers</code>,<code class="language-plaintext highlighter-rouge">body</code>を変更し<code class="language-plaintext highlighter-rouge">$this</code>を返します。</p>

<h2 id="uri-2">URI</h2>

<p>PHPのクラスはURIにマップされていて、アプリケーションではクラス名の代わりにURIを使ってリソースにアクセスします。
アプリケーション名が<code class="language-plaintext highlighter-rouge">koriym\todo</code>というアプリケーションの場合、URIとクラスはこのように対応します。</p>

<p>| URI | Class |
|
<sup id="fnref:1:3" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">3</a></sup>:<a href="https://www.php.net/manual/ja/features.file-upload.put-method.php">PUT メソッドのサポート</a>参照
<sup id="fnref:2:1" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">14</a></sup>:<a href="https://www.php.net/manual/ja/function.parse-str.php">parse_str</a>参照 
<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">17</a></sup>:publicプロパティとして定義しないで、<code class="language-plaintext highlighter-rouge">__set()</code>マジックメソッドでバリデーションをする事もできます。</p>

<h1 id="ルーター">ルーター</h1>

<p>ルーターはWebやコンソールなどの外部コンテキストのリソースリクエストを、BEAR.Sunday内部のリソースリクエストに変換します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$request</span> <span class="o">=</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="n">router</span><span class="o">-&gt;</span><span class="nf">match</span><span class="p">(</span><span class="nv">$GLOBALS</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">);</span>
<span class="k">echo</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nv">$request</span><span class="p">;</span>
<span class="c1">// get page://self/user?name=bear</span>
</code></pre></div></div>

<h2 id="webルーター">Webルーター</h2>

<p>デフォルトのWebルーターではHTTPリクエストのパス(<code class="language-plaintext highlighter-rouge">$_SERVER['REQUEST_URI']</code>)に対応したリソースクラスにアクセスされます。
例えば<code class="language-plaintext highlighter-rouge">/index</code>のリクエストは<code class="language-plaintext highlighter-rouge">{Vendor名}\{Project名}\Resource\Page\Index</code>クラスのHTTPメソッドに応じたPHPメソッドにアクセスされます。</p>

<p>Webルーターは規約ベースのルーターです。設定やスクリプトは必要ありません。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">MyVendor\MyProject\Resource\Page</span><span class="p">;</span>

<span class="c1">// page://self/index</span>
<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span> <span class="c1">// GETリクエスト</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="cliルーター">CLIルーター</h2>

<p><code class="language-plaintext highlighter-rouge">cli</code>コンテキストではコンソールからの引数が外部入力になります。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/page.php get /
</code></pre></div></div>

<p>BEAR.SundayアプリケーションはWebとCLIの双方で動作します。</p>

<h2 id="複数の単語を使ったuri">複数の単語を使ったURI</h2>

<p>ハイフンを使い複数の単語を使ったURIのパスはキャメルケースのクラス名を使います。
例えば<code class="language-plaintext highlighter-rouge">/wild-animal</code>のリクエストは<code class="language-plaintext highlighter-rouge">WildAnimal</code>クラスにアクセスされます。</p>

<h2 id="パラメーター-1">パラメーター</h2>

<p>HTTPメソッドに対応して実行されるPHPメソッドの名前と渡される値は以下の通りです。</p>

<table>
  <thead>
    <tr>
      <th>HTTPメソッド</th>
      <th>PHPメソッド</th>
      <th>　渡される値</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>GET</td>
      <td>onGet</td>
      <td>$_GET</td>
    </tr>
    <tr>
      <td>POST</td>
      <td>onPost</td>
      <td>$_POST または 標準入力</td>
    </tr>
    <tr>
      <td>PUT</td>
      <td>onPut</td>
      <td>※標準入力</td>
    </tr>
    <tr>
      <td>PATCH</td>
      <td>onPatch</td>
      <td>※標準入力</td>
    </tr>
    <tr>
      <td>DELETE</td>
      <td>onDelete</td>
      <td>※標準入力　</td>
    </tr>
  </tbody>
</table>

<p>リクエストのメディアタイプは以下の２つが利用できます。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">application/x-www-form-urlencoded</code> // param1=one&amp;param2=two</li>
  <li><code class="language-plaintext highlighter-rouge">application/json</code> // {“param1”: “one”, “param2”: “one”} (POSTの時は標準入力の値が使われます）</li>
</ul>

<p>PHPマニュアルの<a href="http://php.net/manual/ja/features.file-upload.put-method.php">PUT メソッドのサポート</a>もご覧ください。</p>

<h2 id="メソッドオーバーライド">メソッドオーバーライド</h2>

<p>HTTP PUT トラフィックや HTTP DELETE トラフィックを許可しないファイアウォールがあります。
この制約に対応するため、次の2つの方法でこれらの要求を送ることができます。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">X-HTTP-Method-Override</code> POSTリクエストのヘッダーフィールドを使用してPUTリクエストやDELETEリクエストを送る。</li>
  <li><code class="language-plaintext highlighter-rouge">_method</code> URI パラメーターを使用する。例）POST /users?…&amp;_method=PUT</li>
</ul>

<h2 id="auraルーター">Auraルーター</h2>

<p>リクエストのパスをパラメーターとして受け取る場合はAura Routerを使用します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require bear/aura-router-module ^2.0
</code></pre></div></div>

<p>ルータースクリプトのパスを指定して<code class="language-plaintext highlighter-rouge">AuraRouterModule</code>をインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\Provide\Router\AuraRouterModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AuraRouterModule</span><span class="p">(</span><span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/var/conf/aura.route.php'</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>キャッシュされているDIファイルを消去します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm -rf var/tmp/*
</code></pre></div></div>

<h3 id="ルータースクリプト">ルータースクリプト</h3>

<p>ルータースクリプトではグローバルで渡された<code class="language-plaintext highlighter-rouge">Map</code>オブジェクトに対してルートを設定します。
ルーティングにメソッドを指定する必要はありません。１つ目の引数はルート名としてパス、２つ目の引数に名前付きトークンのプレイスフォルダーを含んだパスを指定します。</p>

<p><code class="language-plaintext highlighter-rouge">var/conf/aura.route.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="cm">/* @var \Aura\Router\Map $map */</span>
<span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">route</span><span class="p">(</span><span class="s1">'/blog'</span><span class="p">,</span> <span class="s1">'/blog/{id}'</span><span class="p">);</span>
<span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">route</span><span class="p">(</span><span class="s1">'/blog/comment'</span><span class="p">,</span> <span class="s1">'/blog/{id}/comment'</span><span class="p">);</span>
<span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">route</span><span class="p">(</span><span class="s1">'/user'</span><span class="p">,</span> <span class="s1">'/user/{name}'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">tokens</span><span class="p">([</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'[a-z]+'</span><span class="p">]);</span>
</code></pre></div></div>

<ul>
  <li>
    <p>最初の行では<code class="language-plaintext highlighter-rouge">/blog/bear</code>とアクセスがあると<code class="language-plaintext highlighter-rouge">page://self/blog?id=bear</code>としてアクセスされます。
(=<code class="language-plaintext highlighter-rouge">Blog</code>クラスの<code class="language-plaintext highlighter-rouge">onGet($id)</code>メソッドに<code class="language-plaintext highlighter-rouge">$id</code>=<code class="language-plaintext highlighter-rouge">bear</code>の値でコールされます。)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/blog/{id}/comment</code>は<code class="language-plaintext highlighter-rouge">Blog\Comment</code>クラスにルートされます。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">token()</code>はパラメーターを正規表現で制限するときに使用します。</p>
  </li>
</ul>

<h3 id="優先ルーター">優先ルーター</h3>

<p>Auraルーターでルートされない場合は、Webルーターが使われます。
つまりパスでパラメーターを渡すURIだけにルータースクリプトを用意すればOKです。</p>

<h3 id="パラメーター-2">パラメーター</h3>

<p>パスからパラメーターを取得するためにAuraルーターは様々な方法が用意されています。</p>

<h3 id="カスタムマッチング">カスタムマッチング</h3>

<p>下のスクリプトは<code class="language-plaintext highlighter-rouge">{date}</code>が適切なフォーマットの時だけルートします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">route</span><span class="p">(</span><span class="s1">'/calendar/from'</span><span class="p">,</span> <span class="s1">'/calendar/from/{date}'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">tokens</span><span class="p">([</span>
        <span class="s1">'date'</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$date</span><span class="p">,</span> <span class="nv">$route</span><span class="p">,</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="k">new</span> <span class="err">\</span><span class="nf">DateTime</span><span class="p">(</span><span class="nv">$date</span><span class="p">);</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="err">\</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]);</span>
</code></pre></div></div>

<h3 id="オプション">オプション</h3>

<p>オプションのパラメーターを指定するためにはパスに<code class="language-plaintext highlighter-rouge">{/attribute1,attribute2,attribute3}</code>の表記を加えます。</p>

<p>例）</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">route</span><span class="p">(</span><span class="s1">'archive'</span><span class="p">,</span> <span class="s1">'/archive{/year,month,day}'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">tokens</span><span class="p">([</span>
        <span class="s1">'year'</span> <span class="o">=&gt;</span> <span class="s1">'\d{4}'</span><span class="p">,</span>
        <span class="s1">'month'</span> <span class="o">=&gt;</span> <span class="s1">'\d{2}'</span><span class="p">,</span>
        <span class="s1">'day'</span> <span class="o">=&gt;</span> <span class="s1">'\d{2}'</span><span class="p">,</span>
    <span class="p">]);</span>
</code></pre></div></div>

<p>プレイスホルダーの<strong>内側に</strong>最初のスラッシュがあるのに注意してください。
そうすると下のパスは全て’archive’にルートされパラメーターの値が付加されます。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/archive            : ['year' =&gt; null,   'month' =&gt; null, 'day' = null]</code></li>
  <li><code class="language-plaintext highlighter-rouge">/archive/1979       : ['year' =&gt; '1979', 'month' =&gt; null, 'day' = null]</code></li>
  <li><code class="language-plaintext highlighter-rouge">/archive/1979/11    : ['year' =&gt; '1979', 'month' =&gt; '11', 'day' = null]</code></li>
  <li><code class="language-plaintext highlighter-rouge">/archive/1979/11/07 : ['year' =&gt; '1979', 'month' =&gt; '11', 'day' = '07']</code></li>
</ul>

<p>オプションパラメーターは<strong>並ぶ順に</strong>オプションです。つまり”month”なしで”day”を指定することはできません。</p>

<h3 id="ワイルドカード">ワイルドカード</h3>

<p>任意の長さのパスの末尾パラメーターとして格納したいときには<code class="language-plaintext highlighter-rouge">wildcard()</code>メソッドを使います。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">route</span><span class="p">(</span><span class="s1">'wild'</span><span class="p">,</span> <span class="s1">'/wild'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">wildcard</span><span class="p">(</span><span class="s1">'card'</span><span class="p">);</span>
</code></pre></div></div>
<p>スラッシュで区切られたパスの値が配列になり<code class="language-plaintext highlighter-rouge">wildcard()</code>で指定したパラメーターに格納されます。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/wild             : ['card' =&gt; []]</code></li>
  <li><code class="language-plaintext highlighter-rouge">/wild/foo         : ['card' =&gt; ['foo']]</code></li>
  <li><code class="language-plaintext highlighter-rouge">/wild/foo/bar     : ['card' =&gt; ['foo', 'bar']]</code></li>
  <li><code class="language-plaintext highlighter-rouge">/wild/foo/bar/baz : ['card' =&gt; ['foo', 'bar', 'baz']]</code></li>
</ul>

<p>その他の高度なルートに関してはAura Routerの<a href="https://github.com/auraphp/Aura.Router/blob/3.x/docs/defining-routes.md">defining-routes</a>をご覧ください。</p>

<h3 id="リバースルーティング">リバースルーティング</h3>

<p>ルートの名前とパラメーターの値からURIを生成することができます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Sunday\Extension\Router\RouterInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="cd">/**
     * @var RouterInterface
     */</span>
    <span class="k">private</span> <span class="nv">$router</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">RouterInterface</span> <span class="nv">$router</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">router</span> <span class="o">=</span> <span class="nv">$router</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$userLink</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">router</span><span class="o">-&gt;</span><span class="nf">generate</span><span class="p">(</span><span class="s1">'/user'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'bear'</span><span class="p">]);</span>
        <span class="c1">// '/user/bear'</span>
</code></pre></div></div>

<h3 id="リクエストメソッド">リクエストメソッド</h3>

<p>リクエストメソッドを指定する必要はありません。</p>

<h3 id="リクエストヘッダー">リクエストヘッダー</h3>

<p>通常リクエストヘッダーはAura.Routerに渡されていませんが <code class="language-plaintext highlighter-rouge">RequestHeaderModule</code>をインストールするとAura.Routerでヘッダーを使ったマッチングが可能になります。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">RequestHeaderModule</span><span class="p">());</span>
</code></pre></div></div>

<h2 id="独自のルーターコンポーネント">独自のルーターコンポーネント</h2>

<ul>
  <li><a href="https://github.com/bearsunday/BEAR.AuraRouterModule">BEAR.AuraRouterModule</a>を参考に<a href="https://github.com/bearsunday/BEAR.Sunday/blob/1.x/src/Extension/Router/RouterInterface.php">RouterInterface</a>を実装します。</li>
</ul>

<h1 id="ストリーム出力">ストリーム出力</h1>

<p>通常リソースはレンダラーでレンダリングされて１つの文字列になり最終的にechoで出力されますが、それではサイズがPHPのメモリの限界を超えるようなコンテンツは出力できません。<code class="language-plaintext highlighter-rouge">StreamRenderer</code>を使うとHTTP出力をストリームでき、メモリ消費を低く抑えられます。ストリーム出力は既存のレンダラーと共存して使うこともできます。</p>

<h2 id="トランスファーとレンダラーの変更">トランスファーとレンダラーの変更</h2>

<p>ストリーム出力用のレンダラーとレスポンダーをインジェクトするために、ページに<a href="https://github.com/bearsunday/BEAR.Streamer/blob/1.x/src/StreamTransferInject.php">StreamTransferInject</a>トレイトを<code class="language-plaintext highlighter-rouge">use</code>します。このダウンロードページの例では<code class="language-plaintext highlighter-rouge">$body</code>をストリームのリソース変数にしているので、インジェクトされたレンダラーは無視されリソースがストリーム出力されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Streamer\StreamTransferInject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Download</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">StreamTransferInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$headers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'image/jpeg'</span><span class="p">,</span>
        <span class="s1">'Content-Disposition'</span> <span class="o">=&gt;</span> <span class="s1">'attachment; filename="image.jpg"'</span>
    <span class="p">];</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/BEAR.jpg'</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="nv">$fp</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="レンダラーとの共存">レンダラーとの共存</h2>

<p>ストリーム出力は従来のレンダラーと共存可能です。通常、TwigレンダラーやJSONレンダラーは文字列を生成しますが、その一部にストリームをアサインすると全体がストリームとして出力されます。</p>

<p>これはTwigテンプレートに文字列とresource変数をアサインして、インライン画像のページを生成する例です。</p>

<p>テンプレート</p>

<div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;p&gt;</span>Hello, <span class="cp">{{</span> <span class="nv">name</span> <span class="cp">}}</span><span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"data:image/jpg;base64,</span><span class="cp">{{</span> <span class="nv">image</span> <span class="cp">}}</span><span class="s">"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">name</code>には通常通り文字列をアサインしていますが、<code class="language-plaintext highlighter-rouge">image</code>に画像ファイルのファイルポインタリソースのresource変数を<code class="language-plaintext highlighter-rouge">base64-encode</code>フィルターを通してアサインしています。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Image</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">StreamTransferInject</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'inline image'</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/image.jpg'</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">);</span>
        <span class="nb">stream_filter_append</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="s1">'convert.base64-encode'</span><span class="p">);</span> <span class="c1">// image base64 format</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">,</span>
            <span class="s1">'image'</span> <span class="o">=&gt;</span> <span class="nv">$fp</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ストリーミングのバンドワイズやタイミングをコントロールしたり、クラウドにアップロードしたり等ストリーミングを更にコントロールする場合には<a href="https://github.com/bearsunday/BEAR.Streamer/blob/1.x/src/StreamResponder.php#L45-L48">StreamResponder</a>を参考にして作成して束縛します。</p>

<p>ストリーム出力のdemoが<a href="https://github.com/bearsunday/MyVendor.Stream">MyVendor.Stream</a>にあります。</p>

<h1 id="swoole">Swoole</h1>

<p>SwooleとはC/C++で書かれたPHP拡張の１つで、イベント駆動の非同期＆コルーチンベースの並行処理ネットワーキング通信エンジンです。
Swooleを使ってコマンドラインから直接BEAR.Sundayウエブアプリケーションを実行することができます。パフォーマンスが大幅に向上します。</p>

<h2 id="インストール-10">インストール</h2>

<h3 id="swooleのインストール">Swooleのインストール</h3>

<p>PECL経由</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pecl install swoole
</code></pre></div></div>

<p>ソースから</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/swoole/swoole-src.git &amp;&amp; \
cd swoole-src &amp;&amp; \
phpize &amp;&amp; \
./configure &amp;&amp; \
make &amp;&amp; make install
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">php.ini</code>で<code class="language-plaintext highlighter-rouge">extension=swoole.so</code>を追加してください。</p>

<h3 id="bearswooleのインストール">BEAR.Swooleのインストール</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require bear/swoole ^0.4
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">AppModule</code>でのインストールは必要ありません。</p>

<p><code class="language-plaintext highlighter-rouge">bin/swoole.php</code>にスクリプトを設置します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/autoload.php'</span><span class="p">;</span>
<span class="k">exit</span><span class="p">((</span><span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/vendor/bear/swoole/bootstrap.php'</span><span class="p">)(</span>
    <span class="s1">'prod-hal-app'</span><span class="p">,</span>       <span class="c1">// context</span>
    <span class="s1">'MyVendor\MyProject'</span><span class="p">,</span> <span class="c1">// application name</span>
    <span class="s1">'127.0.0.1'</span><span class="p">,</span>          <span class="c1">// IP</span>
    <span class="mi">8080</span>                  <span class="c1">// port</span>
<span class="p">));</span>
</code></pre></div></div>

<h2 id="実行-3">実行</h2>

<p>サーバーをスタートさせます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/swoole.php
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Swoole http server is started at http://127.0.0.1:8088
</code></pre></div></div>

<h2 id="ベンチマークサイト">ベンチマークサイト</h2>

<p>特定環境でベンチマークテストをするための<a href="https://github.com/bearsunday/BEAR.HelloworldBenchmark">BEAR.HelloworldBenchmark</a>が用意されています。</p>

<p>　* <a href="https://github.com/bearsunday/BEAR.HelloworldBenchmark/wiki">The benchmark result</a></p>

<p><a href="https://github.com/swoole/swoole-src"><img src="https://github.com/swoole/swoole-src/raw/master/mascot.png" /></a></p>

<h1 id="テスト-2">テスト</h1>

<p>適切なテストは、ソフトウェアを継続性のあるより良いものにします。 全ての依存がインジェクトされ、横断的関心事がAOPで提供されるBEAR.Sundayのクリーンなアプリケーションはテストフレンドリーです。</p>

<h2 id="テスト実行">テスト実行</h2>
<p>composerコマンドが用意されています。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer test     // phpunitテスト
composer tests    // test + sa + cs
composer coverge  // testカバレッジ
composer pcov     // testカバレッジ (pcov)
composer sa       // 静的解析
composer cs       // コーディングスタンダード検査
composer cs-fix   // コーディングスタンダード修復

</code></pre></div></div>

<h2 id="リソース-テストケース作成">リソース	テストケース作成</h2>

<p><strong>全てがリソース</strong>のBEAR.Sundayではリソース操作がテストの基本です。<code class="language-plaintext highlighter-rouge">Injector::getInstance</code>でリソースクライアントを取得してリソースの入出力テストを行います。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">TodoTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">ResourceInterface</span> <span class="nv">$resource</span><span class="p">;</span>
    
    <span class="k">protected</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$injector</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">(</span><span class="s1">'test-html-app'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span> <span class="o">=</span> <span class="nv">$injector</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="nc">ResourceInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">testOnPost</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="s1">'page://self/todo'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'test'</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="nc">StatusCode</span><span class="o">::</span><span class="no">CREATED</span><span class="p">,</span> <span class="nv">$page</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="テストダブル">テストダブル</h2>

<p><a href="https://ja.wikipedia.org/wiki/%E3%83%86%E3%82%B9%E3%83%88%E3%83%80%E3%83%96%E3%83%AB">テストダブル</a> (Test Double) とは、ソフトウェアテストでテスト対象が依存しているコンポーネントを置き換える代用品のことです。テストダブルは以下のパターンがあります。</p>

<ul>
  <li>スタブ (テスト対象に「間接的な入力」を提供)</li>
  <li>モック  (テスト対象からの「間接的な出力」をテストダブルの内部で検証）</li>
  <li>スパイ (テスト対象からの「間接的な出力」を記録)</li>
  <li>フェイク (実際のオブジェクトに近い働きのより単純な実装)</li>
  <li><em>ダミー</em>（テスト対象の生成に必要だが呼び出しが行われない）</li>
</ul>

<p>テスト対象のシステム(<a href="https://ja.wikipedia.org/wiki/%E3%83%86%E3%82%B9%E3%83%88%E5%AF%BE%E8%B1%A1%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0">SUT</a>）がテストダブルの出力を使用するのがスタブです。例えばいつも<code class="language-plaintext highlighter-rouge">true</code>を返すようなメソッドを持つテストダブルはスタブです。モックはSUTからテストダブルへの間接的出力の検証をテストコードではなく、テストダブル内部で行います。スパイはモックと同じようにSUTの間接的出力の検証を行うためのものですが、その検証をテストコードで行うためにテストコードから読み取り可能な記録が行われます。</p>

<h3 id="テストダブルの束縛">テストダブルの束縛</h3>

<p>テスト用に束縛を変更する方法は２つあります。コンテキストモジュールで全テストの束縛を横断的に変更する方法と、１テストの中だけで一時的に特定目的だけで束縛を変える方法です。</p>

<h4 id="コンテキストモジュール">コンテキストモジュール</h4>

<p><code class="language-plaintext highlighter-rouge">TestModule</code>を作成してbootstrapで<code class="language-plaintext highlighter-rouge">test</code>コンテキストを利用可能にします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TestModule</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">configure</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">DateTimeInterface</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="k">new</span> <span class="nc">DateTimeImmutable</span><span class="p">(</span><span class="s1">'1970-01-01 00:00:00'</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">Auth</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nc">FakeAuth</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>    
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>テスト用束縛が上書きされたインジェクター</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$injector</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">(</span><span class="s1">'test-hal-app'</span><span class="p">,</span> <span class="nv">$module</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="一時的束縛変更">一時的束縛変更</h2>

<p>１つのテストのための一時的な束縛の変更は<code class="language-plaintext highlighter-rouge">Injector::getOverrideInstance</code>で上書きする束縛を指定します。</p>

<h3 id="スタブフェイク">スタブ、フェイク</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">testBindStub</span><span class="p">():</span> <span class="kt">void</span>
<span class="p">{</span>
    <span class="nv">$module</span> <span class="o">=</span> <span class="k">new</span> <span class="kd">class</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span> <span class="p">{</span>
        <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">():</span> <span class="kt">void</span>
        <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">FooInterface</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">to</span><span class="p">(</span><span class="nc">FakeFoo</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="nv">$injector</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getOverrideInstance</span><span class="p">(</span><span class="s1">'hal-app'</span><span class="p">,</span> <span class="nv">$module</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="モック">モック</h3>

<p>アサーションをテストダブル内部で実行します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">testBindMock</span><span class="p">():</span> <span class="kt">void</span>
<span class="p">{</span>  
    <span class="nv">$mock</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createMock</span><span class="p">(</span><span class="nc">FooInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="c1">//  update() が一度だけコールされ、その際のパラメータは文字列 'something' となるということを期待</span>
    <span class="nv">$mock</span><span class="o">-&gt;</span><span class="nf">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">once</span><span class="p">())</span>
             <span class="o">-&gt;</span><span class="nf">method</span><span class="p">(</span><span class="s1">'update'</span><span class="p">)</span>
             <span class="o">-&gt;</span><span class="nf">with</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">equalTo</span><span class="p">(</span><span class="s1">'something'</span><span class="p">));</span>
    <span class="nv">$module</span> <span class="o">=</span> <span class="k">new</span> <span class="kd">class</span><span class="p">(</span><span class="nv">$mock</span><span class="p">)</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span> <span class="p">{</span>
        <span class="k">public</span> <span class="k">function</span> <span class="n">__constcuct</span><span class="p">(</span>
            <span class="kt">private</span> <span class="nc">FooInterface</span> <span class="nv">$foo</span>
        <span class="p">){}</span>
        <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">():</span> <span class="kt">void</span>
        <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="nc">FooInterface</span><span class="o">::</span><span class="n">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toInstance</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="nv">$injector</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getOverrideInstance</span><span class="p">(</span><span class="s1">'hal-app'</span><span class="p">,</span> <span class="nv">$module</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="スパイ">スパイ</h3>

<p>スパイ対象のインターフェイスまたはクラス名を指定して<code class="language-plaintext highlighter-rouge">SpyModule</code>をインストールします。<sup id="fnref:spy-module" role="doc-noteref"><a href="#fn:spy-module" class="footnote" rel="footnote">18</a></sup> スパイ対象が含まれるSUTを動作させた後に、スパイログで呼び出し回数や呼び出しの値を検証します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">testBindSpy</span><span class="p">():</span> <span class="kt">void</span>
<span class="p">{</span>
    <span class="nv">$module</span> <span class="o">=</span> <span class="k">new</span> <span class="kd">class</span> <span class="kd">extends</span> <span class="nc">AbstractModule</span> <span class="p">{</span>
        <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">():</span> <span class="kt">void</span>
        <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">SpyModule</span><span class="p">([</span><span class="nc">FooInterface</span><span class="o">::</span><span class="n">class</span><span class="p">]));</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="nv">$injector</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getOverrideInstance</span><span class="p">(</span><span class="s1">'hal-app'</span><span class="p">,</span> <span class="nv">$module</span><span class="p">);</span>
    <span class="nv">$resource</span> <span class="o">=</span> <span class="nv">$injector</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="nc">ResourceInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="c1">// 直接、間接に関わらずFooInterfaceオブジェクトのSpyログが記録されます。</span>
    <span class="nv">$resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
    <span class="c1">// Spyログの取り出し</span>
    <span class="nv">$spyLog</span> <span class="o">=</span> <span class="nv">$injector</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="err">\</span><span class="nc">Ray\TestDouble\LoggerInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="c1">// @var array&lt;int, Log&gt; $addLog</span>
    <span class="nv">$addLog</span> <span class="o">=</span> <span class="nv">$spyLog</span><span class="o">-&gt;</span><span class="nf">getLogs</span><span class="p">(</span><span class="nc">FooInterface</span><span class="p">,</span> <span class="s1">'add'</span><span class="p">);</span>   
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$addLog</span><span class="p">),</span> <span class="s1">'Should have received once'</span><span class="p">);</span>
    <span class="c1">// SUTからの引数の検証</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="nv">$addLog</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">arguments</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$addLog</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">namedArguments</span><span class="p">[</span><span class="s1">'a'</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="ダミー">ダミー</h3>

<p>インターフェイスにNullオブジェクトを束縛するには<a href="https://ray-di.github.io/manuals/1.0/ja/null_object_binding.html">Null束縛</a>を使います。</p>

<h2 id="ハイパーメディアテスト">ハイパーメディアテスト</h2>

<p>リソーステストは各エンドポイントの入出力テストです。対してハイパーメディアテストはそのエンドポイントどう繋ぐかというワークフローの振る舞いをテストします。</p>

<p>WorkflowテストはHTTPテストに継承され、１つのコードでPHPとHTTP双方のレベルでテストされます。その際HTTPのテストは<code class="language-plaintext highlighter-rouge">curl</code>で行われ、そのリクエスト・レスポンスはログファイルに記録されます。</p>

<h2 id="良いテストのために">良いテストのために</h2>

<ul>
  <li>実装ではなく、インターフェイスをテストします。</li>
  <li>モックライブラリを利用するよりフェイククラスを作成しましょう。</li>
  <li>テストは仕様です。書きやすさよりも読みやすさを。</li>
</ul>

<p>参考URL</p>

<ul>
  <li><a href="https://nedbatchelder.com/blog/201206/tldw_stop_mocking_start_testing.html">Stop mocking, start testing</a></li>
  <li><a href="https://www.thoughtworks.com/insights/blog/mockists-are-dead-long-live-classicists">Mockists Are Dead</a></li>
</ul>

<hr />

<h1 id="チュートリアル">チュートリアル</h1>

<p>このチュートリアルではBEAR.Sundayの基本機能の<strong>DI</strong>、<strong>AOP</strong>、<strong>REST API</strong>を紹介します。
<a href="https://github.com/bearsunday/tutorial1/commits/v2-php8.2">tutorial1</a>のコミットを参考にして進めましょう。</p>

<h2 id="プロジェクト作成">プロジェクト作成</h2>

<p>年月日を入力すると曜日を返すWebサービスを作成してみましょう。
まずプロジェクトを作成します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer create-project bear/skeleton MyVendor.Weekday
</code></pre></div></div>

<p><strong>vendor</strong>名を<code class="language-plaintext highlighter-rouge">MyVendor</code>に<strong>project</strong>名を<code class="language-plaintext highlighter-rouge">Weekday</code>として入力します。<sup id="fnref:2:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">14</a></sup></p>

<h2 id="リソース-6">リソース</h2>

<p>最初にアプリケーションリソースファイルを<code class="language-plaintext highlighter-rouge">src/Resource/App/Weekday.php</code>に作成します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">DateTimeImmutable</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Weekday</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$year</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$month</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$day</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$dateTime</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nc">DateTimeImmutable</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">,</span> <span class="s2">"</span><span class="nv">$year</span><span class="s2">-</span><span class="nv">$month</span><span class="s2">-</span><span class="nv">$day</span><span class="s2">"</span><span class="p">);</span>
        <span class="nv">$weekday</span> <span class="o">=</span> <span class="nv">$dateTime</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'D'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'weekday'</span> <span class="o">=&gt;</span> <span class="nv">$weekday</span><span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>この<code class="language-plaintext highlighter-rouge">MyVendor\Weekday\Resource\App\Weekday</code>リソースクラスは<code class="language-plaintext highlighter-rouge">/weekday</code>というパスでアクセスすることができます。
<code class="language-plaintext highlighter-rouge">GET</code>メソッドのクエリーが<code class="language-plaintext highlighter-rouge">onGet</code>メソッドの引数に渡されます。</p>

<p>コンソールでアクセスしてみましょう。まずはエラーを試してみます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php get /weekday
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>400 Bad Request
content-type: application/vnd.error+json

{
    "message": "Bad Request",
    "logref": "e29567cd",
</code></pre></div></div>

<p>エラーは<a href="https://github.com/blongden/vnd.error">application/vnd.error+json</a>メディアタイプで返されます。
400はリクエストに問題があるエラーコードです。エラーには<code class="language-plaintext highlighter-rouge">logref</code>IDがつけられ<code class="language-plaintext highlighter-rouge">var/log/</code>でエラーの詳しい内容を参照することができます。</p>

<p>次は引数をつけて正しいリクエストを試します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php get <span class="s1">'/weekday?year=2001&amp;month=1&amp;day=1'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
Content-Type: application/hal+json

<span class="o">{</span>
    <span class="s2">"weekday"</span>: <span class="s2">"Mon"</span>,
    <span class="s2">"_links"</span>: <span class="o">{</span>
        <span class="s2">"self"</span>: <span class="o">{</span>
            <span class="s2">"href"</span>: <span class="s2">"/weekday?year=2001&amp;month=1&amp;day=1"</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><a href="https://tools.ietf.org/html/draft-kelly-json-hal-06">application/hal+json</a>というメディアタイプで結果が正しく返って来ました。</p>

<p>これをWeb APIサービスにしてみましょう。
Built-inサーバーを立ち上げます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php <span class="nt">-S</span> 127.0.0.1:8080 bin/app.php
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">curl</code>でHTTPの<code class="language-plaintext highlighter-rouge">GET</code>リクエストを行って確かめてみましょう。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -i 'http://127.0.0.1:8080/weekday?year=2001&amp;month=1&amp;day=1'
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Host: 127.0.0.1:8080
Date: Tue, 04 May 2021 01:55:59 GMT
Connection: close
X-Powered-By: PHP/8.0.3
Content-Type: application/hal+json

{
    "weekday": "Mon",
    "_links": {
        "self": {
            "href": "/weekday/2001/1/1"
        }
    }
}
</code></pre></div></div>

<p>このリソースクラスにはGET以外のメソッドは用意されていないので、他のメソッドを試すと<code class="language-plaintext highlighter-rouge">405 Method Not Allowed</code>が返されます。これも試してみましょう。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -i -X POST 'http://127.0.0.1:8080/weekday?year=2001&amp;month=1&amp;day=1'
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 405 Method Not Allowed
...
</code></pre></div></div>

<p>HTTP <code class="language-plaintext highlighter-rouge">OPTIONS</code> メソッドリクエストで利用可能なHTTPメソッドと必要なパラメーターを調べることができます。(<a href="https://tools.ietf.org/html/rfc7231#section-4.3.7">RFC7231</a>)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -i -X OPTIONS http://127.0.0.1:8080/weekday
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
...
Content-Type: application/json
Allow: GET

{
    "GET": {
        "parameters": {
            "year": {
                "type": "integer"
            },
            "month": {
                "type": "integer"
            },
            "day": {
                "type": "integer"
            }
        },
        "required": [
            "year",
            "month",
            "day"
        ]
    }
}
</code></pre></div></div>
<h2 id="テスト-3">テスト</h2>

<p><a href="https://phpunit.readthedocs.io/ja/latest/">PHPUnit</a>を使ったリソースのテストを作成しましょう。</p>

<p><code class="language-plaintext highlighter-rouge">tests/Resource/App/WeekdayTest.php</code>に以下のテストコードを記述します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">MyVendor\Weekday\Injector</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PHPUnit\Framework\TestCase</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">WeekdayTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">ResourceInterface</span> <span class="nv">$resource</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$injector</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">(</span><span class="s1">'app'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span> <span class="o">=</span> <span class="nv">$injector</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="nc">ResourceInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">testOnGet</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$ro</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self/weekday'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'year'</span> <span class="o">=&gt;</span> <span class="s1">'2001'</span><span class="p">,</span> <span class="s1">'month'</span> <span class="o">=&gt;</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'day'</span> <span class="o">=&gt;</span> <span class="s1">'1'</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="s1">'Mon'</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'weekday'</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">setUp()</code>ではコンテキスト(app)を指定するとアプリケーションのどのオブジェクトでも生成できるアプリケーションのインジェクター
<code class="language-plaintext highlighter-rouge">Injector</code>を使ってリソースクライアント(<code class="language-plaintext highlighter-rouge">ResourceInterface</code>)を取得していて、テストメソッド<code class="language-plaintext highlighter-rouge">testOnGet</code>でリソースをリクエストしてテストします。</p>

<p>実行してみましょう。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./vendor/bin/phpunit
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PHPUnit 9.5.4 by Sebastian Bergmann and contributors.

....                                                                4 / 4 (100%)

Time: 00:00.281, Memory: 14.00 MB
</code></pre></div></div>

<p>インストールされたプロジェクトには他にはテストやコード検査を実行するコマンドが用意されています。
テストカバレッジを取得するには<code class="language-plaintext highlighter-rouge">composer coverage</code>を実行します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer coverage
</code></pre></div></div>

<p><a href="https://pecl.php.net/package/pcov">pcov</a>はより高速にカバレッジ計測を行います。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer pcov
</code></pre></div></div>

<p>カバレッジの詳細を<code class="language-plaintext highlighter-rouge">build/coverage/index.html</code>をWebブラウザで開くことで見ることができます。</p>

<p>コーディングスタンダードにしたがっているかのチェックは<code class="language-plaintext highlighter-rouge">composer cs</code>コマンドで確認できます。
その自動修正は<code class="language-plaintext highlighter-rouge">composer cs-fix</code>コマンドでできます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer cs
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer cs-fix
</code></pre></div></div>
<h2 id="静的解析">静的解析</h2>

<p>コードの静的解析は<code class="language-plaintext highlighter-rouge">composer sa</code>コマンドでおこないます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer sa
</code></pre></div></div>

<p>これまでのコードで実行してみると、以下のエラーがphpstanで検出されました。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   
  15     Cannot call method format() on DateTimeImmutable|false.  
  

※ 以前のPHP7対応のチュートリアルは[tutorial_v1](tutorial_v1.html)にあります。

[^1]:このプロジェクトのソースコードは各セクション毎に[bearsunday/Tutorial](https://github.com/bearsunday/tutorial1/commits/v2-php8.2)にコミットしています。適宜参照してください。
[^2]:通常は**vendor**名は個人またはチーム（組織）の名前を入力します。githubのアカウント名やチーム名が適当でしょう。**project**にはアプリケーション名を入力します。


# チュートリアル2

このチュートリアルでは以下のツールを用いて標準に基づいた高品質なREST(Hypermedia)アプリケーション開発を学びます。

* JSONのスキーマを定義しバリデーションやドキュメンテーションに利用する [Json Schema](https://json-schema.org/)
* ハイパーメディアタイプ [HAL (Hypertext Application Language)](https://stateless.group/hal_specification.html)  
* CakePHPが開発してるDBマイグレーションツール [Phinx](https://book.cakephp.org/3.0/ja/phinx.html) 
* PHPのインターフェイスとSQL文実行を束縛する [Ray.MediaQuery](https://github.com/ray-di/Ray.MediaQuery)

[tutorial2](https://github.com/bearsunday/tutorial2/commits/v2-php8.2)のコミットを参考にして進めましょう。

## プロジェクト作成

プロジェクトスケルトンを作成します。

</code></pre></div></div>
<p>composer create-project bear/skeleton MyVendor.Ticket</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
**vendor**名を`MyVendor`に**project**名を`Ticket`として入力します。

## マイグレーション

Phinxをインストールします。

</code></pre></div></div>
<p>composer require –dev robmorgan/phinx</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
プロジェクトルートフォルダの`.env.dist`ファイルにDB接続情報を記述します。

</code></pre></div></div>
<p>TKT_DB_HOST=127.0.0.1:3306
TKT_DB_NAME=ticket
TKT_DB_USER=root
TKT_DB_PASS=’’
TKT_DB_SLAVE=’’
TKT_DB_DSN=mysql:host=${TKT_DB_HOST}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
`.env.dist`ファイルはこのようにして、実際の接続情報は`.env`に記述しましょう。[^1]

次にphinxが利用するフォルダを作成します。

```bash
mkdir -p var/phinx/migrations
mkdir var/phinx/seeds
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">.env</code>の接続情報をphinxで利用するために<code class="language-plaintext highlighter-rouge">var/phinx/phinx.php</code>を設置します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">use</span> <span class="nc">BEAR\Dotenv\Dotenv</span><span class="p">;</span>

<span class="k">require_once</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/vendor/autoload.php'</span><span class="p">;</span>

<span class="p">(</span><span class="k">new</span> <span class="nc">Dotenv</span><span class="p">())</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

<span class="nv">$development</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PDO</span><span class="p">(</span><span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_DSN'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_USER'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_PASS'</span><span class="p">));</span>
<span class="nv">$test</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PDO</span><span class="p">(</span><span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_DSN'</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'_test'</span><span class="p">,</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_USER'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_PASS'</span><span class="p">));</span>
<span class="k">return</span> <span class="p">[</span>
    <span class="s1">'paths'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'migrations'</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/migrations'</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">'environments'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'development'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$development</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s2">"SELECT DATABASE()"</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">fetchColumn</span><span class="p">(),</span>
            <span class="s1">'connection'</span> <span class="o">=&gt;</span> <span class="nv">$development</span>
        <span class="p">],</span>
        <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$test</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s2">"SELECT DATABASE()"</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">fetchColumn</span><span class="p">(),</span>
            <span class="s1">'connection'</span> <span class="o">=&gt;</span> <span class="nv">$test</span>
        <span class="p">]</span>
    <span class="p">]</span>
<span class="p">];</span>
</code></pre></div></div>

<h3 id="setupスクリプト">setupスクリプト</h3>

<p>データベース作成やマイグレーションを簡単に実行できるように<code class="language-plaintext highlighter-rouge">bin/setup.php</code>を編集します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">use</span> <span class="nc">BEAR\Dotenv\Dotenv</span><span class="p">;</span>

<span class="k">require_once</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/vendor/autoload.php'</span><span class="p">;</span>

<span class="p">(</span><span class="k">new</span> <span class="nc">Dotenv</span><span class="p">())</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">));</span>

<span class="nb">chdir</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">));</span>
<span class="nb">passthru</span><span class="p">(</span><span class="s1">'rm -rf var/tmp/*'</span><span class="p">);</span>
<span class="nb">passthru</span><span class="p">(</span><span class="s1">'chmod 775 var/tmp'</span><span class="p">);</span>
<span class="nb">passthru</span><span class="p">(</span><span class="s1">'chmod 775 var/log'</span><span class="p">);</span>
<span class="c1">// db</span>
<span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">PDO</span><span class="p">(</span><span class="s1">'mysql:host='</span> <span class="mf">.</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_HOST'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_USER'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_PASS'</span><span class="p">));</span>
<span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'CREATE DATABASE IF NOT EXISTS '</span> <span class="mf">.</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_NAME'</span><span class="p">));</span>
<span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'DROP DATABASE IF EXISTS '</span> <span class="mf">.</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_NAME'</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'_test'</span><span class="p">);</span>
<span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'CREATE DATABASE '</span> <span class="mf">.</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_NAME'</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'_test'</span><span class="p">);</span>
<span class="nb">passthru</span><span class="p">(</span><span class="s1">'./vendor/bin/phinx migrate -c var/phinx/phinx.php -e development'</span><span class="p">);</span>
<span class="nb">passthru</span><span class="p">(</span><span class="s1">'./vendor/bin/phinx migrate -c var/phinx/phinx.php -e test'</span><span class="p">);</span>
</code></pre></div></div>

<p>次に<code class="language-plaintext highlighter-rouge">ticket</code>テーブルを作成するためにマイグレーションクラスを作成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./vendor/bin/phinx create Ticket -c var/phinx/phinx.php
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Phinx by CakePHP - https://phinx.org.

...
created var/phinx/migrations/20210520124501_ticket.php
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">var/phinx/migrations/{current_date}_ticket.php</code>を編集して<code class="language-plaintext highlighter-rouge">change()</code>メソッドを実装します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">use</span> <span class="nc">Phinx\Migration\AbstractMigration</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">Ticket</span> <span class="kd">extends</span> <span class="nc">AbstractMigration</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">change</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$table</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">table</span><span class="p">(</span><span class="s1">'ticket'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">'primary_key'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'id'</span><span class="p">]]);</span>
        <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'uuid'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'null'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'date_created'</span><span class="p">,</span> <span class="s1">'datetime'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">.env.dist</code>ファイルを以下のように変更します。</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code> TKT_DB_USER=root
 TKT_DB_PASS=
 TKT_DB_SLAVE=
<span class="gd">-TKT_DB_DSN=mysql:host=${TKT_DB_HOST}
</span><span class="gi">+TKT_DB_DSN=mysql:host=${TKT_DB_HOST};dbname=${TKT_DB_NAME}
</span></code></pre></div></div>

<p>準備が完了したので、セットアップコマンドを実行してテーブルを作成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer setup
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; php bin/setup.php
...
All Done. Took 0.0248s
</code></pre></div></div>

<p>テーブルが作成されました。次回からこのプロジェクトのデータベース環境を整えるには<code class="language-plaintext highlighter-rouge">composer setup</code>を実行するだけで行えます。</p>

<p>マイグレーションクラスの記述について詳しくは<a href="https://book.cakephp.org/3.0/ja/phinx/migrations.html">Phinxのマニュアル：マイグレーションを書く</a>をご覧ください。</p>

<h2 id="モジュール-3">モジュール</h2>

<p>モジュールをcomposerインストールします。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require ray/identity-value-module ray/media-query -w
</code></pre></div></div>

<p>AppModuleでパッケージをインストールします。</p>

<p><code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Dotenv\Dotenv</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\PackageModule</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\Module\JsonSchemaModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\IdentityValueModule\IdentityValueModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\MediaQuery\DbQueryConfig</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\MediaQuery\MediaQueryModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\MediaQuery\Queries</span><span class="p">;</span>
<span class="kn">use</span> <span class="k">function</span> <span class="n">dirname</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="p">(</span><span class="k">new</span> <span class="nc">Dotenv</span><span class="p">())</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">AuraSqlModule</span><span class="p">(</span>
                <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_DSN'</span><span class="p">),</span>
                <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_USER'</span><span class="p">),</span>
                <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_PASS'</span><span class="p">),</span>
                <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_SLAVE'</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">MediaQueryModule</span><span class="p">(</span>
                <span class="nc">Queries</span><span class="o">::</span><span class="nf">fromDir</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">appMeta</span><span class="o">-&gt;</span><span class="n">appDir</span> <span class="mf">.</span> <span class="s1">'/src/Query'</span><span class="p">),</span> <span class="p">[</span>
                   <span class="k">new</span> <span class="nc">DbQueryConfig</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">appMeta</span><span class="o">-&gt;</span><span class="n">appDir</span> <span class="mf">.</span> <span class="s1">'/var/sql'</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">IdentityValueModule</span><span class="p">());</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">JsonSchemaModule</span><span class="p">(</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">appMeta</span><span class="o">-&gt;</span><span class="n">appDir</span> <span class="mf">.</span> <span class="s1">'/var/schema/response'</span><span class="p">,</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">appMeta</span><span class="o">-&gt;</span><span class="n">appDir</span> <span class="mf">.</span> <span class="s1">'/var/schema/request'</span>
            <span class="p">)</span>
        <span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">PackageModule</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="sql-1">SQL</h2>

<p>チケット用の３つのSQLを<code class="language-plaintext highlighter-rouge">var/sql</code>に保存します。<sup id="fnref:13" role="doc-noteref"><a href="#fn:13" class="footnote" rel="footnote">19</a></sup></p>

<p><code class="language-plaintext highlighter-rouge">var/sql/ticket_add.sql</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ticket add */</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">ticket</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">date_created</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(:</span><span class="n">id</span><span class="p">,</span> <span class="p">:</span><span class="n">title</span><span class="p">,</span> <span class="p">:</span><span class="n">dateCreated</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">var/sql/ticket_list.sql</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ticket list */</span>
<span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">date_created</span>
  <span class="k">FROM</span> <span class="n">ticket</span>
 <span class="k">LIMIT</span> <span class="mi">3</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">var/sql/ticket_item.sql</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ticket item */</span>
<span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">date_created</span>
  <span class="k">FROM</span> <span class="n">ticket</span>
 <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span>
</code></pre></div></div>

<p>作成時に単体でそのSQLが動作するか確認しましょう。</p>

<p>例えば、PHPStormにはデータベースツールの<a href="https://www.jetbrains.com/ja-jp/datagrip/">DataGrip</a>が含まれていて、コード補完やSQLのリファクタリングなどSQL開発に必要な機能が揃っています。
DB接続などのセットアップを行えば、SQLファイルをIDEで直接実行できます。<sup id="fnref:3:1" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">17</a></sup><sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">20</a></sup></p>

<h2 id="jsonschema">JsonSchema</h2>

<p><code class="language-plaintext highlighter-rouge">Ticket</code>（チケットアイテム）、<code class="language-plaintext highlighter-rouge">Tickets</code>（チケットアイテムリスト）のリソース表現を<a href="http://json-schema.org/">JsonSchema</a>で定義し、それぞれ保存します。</p>

<p><code class="language-plaintext highlighter-rouge">var/schema/response/ticket.json</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"$id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ticket.json"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://json-schema.org/draft-07/schema#"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Ticket"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"title"</span><span class="p">,</span><span class="w"> </span><span class="s2">"date_created"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The unique identifier for a ticket."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">64</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The unique identifier for a ticket."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">255</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"date_created"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The date and time that the ticket was created"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"datetime"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">var/schema/response/tickets.json</code></p>

<p>Ticketsはticketの配列です。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"$id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tickets.json"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://json-schema.org/draft-07/schema#"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tickets"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"tickets"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"tickets"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"items"</span><span class="p">:{</span><span class="nl">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"./ticket.json"</span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><strong>$id</strong> - ファイル名を指定しますが、公開する場合はURLを記述します。</li>
  <li><strong>title</strong> - オブジェクト名としてAPIドキュメントで扱われます。</li>
  <li><strong>examples</strong> - 適宜、例を指定しましょう。オブジェクト全体のも指定できます。</li>
</ul>

<p>PHPStormではエディタの右上に緑色のチェックが出ていて問題がない事が分かります。スキーマ作成時にスキーマ自身もバリデートしましょう。</p>

<h2 id="クエリーインターフェイス">クエリーインターフェイス</h2>

<p>インフラストラクチャへのアクセスを抽象化したPHPのインターフェイスを作成します。</p>

<ul>
  <li>Ticketリソースを読み出す <strong>TicketQueryInterface</strong></li>
  <li>Ticketリソースを作成する <strong>TicketCommandInterface</strong></li>
</ul>

<p><code class="language-plaintext highlighter-rouge">src/Query/TicketQueryInterface.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Query</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">MyVendor\Ticket\Entity\Ticket</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\MediaQuery\Annotation\DbQuery</span><span class="p">;</span>

<span class="kd">interface</span> <span class="nc">TicketQueryInterface</span>
<span class="p">{</span>
    <span class="c1">#[DbQuery('ticket_item']</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">item</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">Ticket</span><span class="o">|</span><span class="kc">null</span><span class="p">;</span>

    <span class="cd">/** @return array&lt;Ticket&gt; */</span>
    <span class="c1">#[DbQuery('ticket_list']</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">list</span><span class="p">():</span> <span class="kt">array</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">src/Query/TicketCommandInterface.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Query</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">DateTimeInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\MediaQuery\Annotation\DbQuery</span><span class="p">;</span>

<span class="kd">interface</span> <span class="nc">TicketCommandInterface</span>
<span class="p">{</span>
    <span class="c1">#[DbQuery('ticket_add')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">add</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$title</span><span class="p">,</span> <span class="kt">DateTimeInterface</span> <span class="nv">$dateCreated</span> <span class="o">=</span> <span class="kc">null</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">#[DbQuery]</code>アトリビュートでSQL文を指定します。</p>

<p>このインターフェイスに対する実装を用意する必要はありません。 指定されたSQLのクエリーを行うオブジェクトが自動生成されます。</p>

<p>インターフェイスを<strong>副作用が発生するcommand</strong>または<strong>値を返すquery</strong>という2つの関心に分けていますが、リポジトリパターンのように1つにまとめたり
<a href="https://github.com/pmjones/adr">ADRパターン</a>のように1インターフェイス1メソッドにしても構いません。アプリケーション設計者が方針を決定します。</p>

<h2 id="エンティティ">エンティティ</h2>

<p>メソッドの返り値に<code class="language-plaintext highlighter-rouge">array</code>を指定すると、データベースの結果はそのまま連想配列と得られますが、メソッドの返り値にエンティティの型を指定すると、その型にハイドレーションされます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[DbQuery('ticket_item']</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">item</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">array</span> <span class="c1">// 配列が得られる</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[DbQuery('ticket_item']</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">item</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">Ticket</span><span class="o">|</span><span class="kc">null</span><span class="p">;</span> <span class="c1">// Ticketエンティティが得られる</span>
</code></pre></div></div>

<p>複数行(row_list)の時は<code class="language-plaintext highlighter-rouge">/** @return array&lt;Ticket&gt;*/</code>とphpdocで<code class="language-plaintext highlighter-rouge">Ticket</code>が配列で返ることを指定します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/** @return array&lt;Ticket&gt; */
#[DbQuery('ticket_list')]
public function list(): array; // Ticketエンティティの配列が得られる
</code></pre></div></div>

<p>各行の値は名前引数でコンストラクタに渡されます。<sup id="fnref:named" role="doc-noteref"><a href="#fn:named" class="footnote" rel="footnote">21</a></sup></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Entity</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Ticket</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">public</span> <span class="n">readonly</span> <span class="n">string</span> <span class="nv">$id</span><span class="p">,</span>
        <span class="kt">public</span> <span class="n">readonly</span> <span class="n">string</span> <span class="nv">$title</span><span class="p">,</span>
        <span class="kt">public</span> <span class="n">readonly</span> <span class="n">string</span> <span class="nv">$dateCreated</span>
    <span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="リソース-7">リソース</h2>

<p>リソースクラスはクエリーインターフェイスに依存します。</p>

<h2 id="tikcetリソース">tikcetリソース</h2>

<p><code class="language-plaintext highlighter-rouge">ticket</code>リソースを<code class="language-plaintext highlighter-rouge">src/Resource/App/Ticket.php</code>に作成します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\JsonSchema</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">MyVendor\Ticket\Query\TicketQueryInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Ticket</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="nc">TicketQueryInterface</span> <span class="nv">$query</span>
    <span class="p">){}</span>
    
   <span class="c1">#[JsonSchema("ticket.json")]</span>
   <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span> <span class="o">=</span> <span class="s1">''</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">query</span><span class="o">-&gt;</span><span class="nf">item</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>アトリビュート<code class="language-plaintext highlighter-rouge">#[JsonSchema]</code>は<code class="language-plaintext highlighter-rouge">onGet()</code>で出力される値が<code class="language-plaintext highlighter-rouge">ticket.json</code>のスキーマで定義されている事を表します。
AOPによってリクエスト毎にバリデートされます。</p>

<p>シードを入力してリソースをリクエストしてみましょう。<sup id="fnref:8" role="doc-noteref"><a href="#fn:8" class="footnote" rel="footnote">22</a></sup></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% mysql <span class="nt">-u</span> root <span class="nt">-e</span> <span class="s2">"INSERT INTO ticket (id, title, date_created) VALUES ('1', 'foo', '1970-01-01 00:00:00')"</span> ticket
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% php bin/app.php get <span class="s1">'/ticket?id=1'</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
Content-Type: application/hal+json

<span class="o">{</span>
    <span class="s2">"id"</span>: <span class="s2">"1"</span>,
    <span class="s2">"title"</span>: <span class="s2">"foo"</span>,
    <span class="s2">"date_created"</span>: <span class="s2">"1970-01-01 00:00:01"</span>,
    <span class="s2">"_links"</span>: <span class="o">{</span>
        <span class="s2">"self"</span>: <span class="o">{</span>
            <span class="s2">"href"</span>: <span class="s2">"/ticket?id=1"</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="raymediaquery-1">Ray.MediaQuery</h3>

<p>Ray.MediaQueryを使えば、ボイラープレートとなりやすい実装クラスをコーディングする事なく、インターフェイスから自動生成されたSQL実行オブジェクトがインジェクトされます。<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">23</a></sup></p>

<p>SQL文には<code class="language-plaintext highlighter-rouge">;</code>で区切った複数のSQL分を記述する事ができ、複数のSQLに同じパラメーターが名前でバインドされます。SELECT以外のクエリーではトランザクションも実行されます。</p>

<p>利用クラスはインターフェイスにしか依存していないので、動的にSQLを生成したい場合にはRay.MediaQueryの代わりにクエリービルダーをインジェクトしたSQL実行クラスで組み立てたSQLを実行すれば良いでしょう。
詳しくはマニュアルの<a href="database.html">データベース</a>をご覧ください。</p>

<h2 id="埋め込みリンク">埋め込みリンク</h2>

<p>通常Webサイトのページは複数のリソースを内包します。例えばブログの記事ページであれば、記事以外にもおすすめや広告、カテゴリーリンクなどが含まれるかもしれません。
それらをクライアントがバラバラに取得する代わりに、独立したリソースとして埋め込みリンクで1つのリソースに束ねる事ができます。</p>

<p>HTMLとそこに記述される<code class="language-plaintext highlighter-rouge">&lt;img&gt;</code>タグをイメージしてください。どちらも独立したURLを持ちますが、画像リソースがHTMLリソースに埋めこ込まれていてHTMLを取得するとHTML内に画像が表示されます。
これらはハイパーメディアタイプの<a href="http://amundsen.com/hypermedia/hfactor/#le">Embedding links(LE)</a>と呼ばれるもので、埋め込まれるリソースがリンクされています。</p>

<p>ticketリソースにprojectリソースを埋め込んでみましょう。Projectクラスを用意します。</p>

<p><code class="language-plaintext highlighter-rouge">src/Resource/App/Project.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Project</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'Project A'</span><span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Ticketリソースにアトリビュート<code class="language-plaintext highlighter-rouge">#[Embed]</code>を追加します。</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gi">+use BEAR\Resource\Annotation\Embed;
+use BEAR\Resource\Request;
+
+   #[Embed(src: '/project', rel: 'project')]
</span>    #[JsonSchema("ticket.json")]
    public function onGet(string $id = ''): static
    {
<span class="gi">+        assert($this-&gt;body['project'] instanceof Request);
</span><span class="gd">-        $this-&gt;body = (array) $this-&gt;query-&gt;item($id);
</span><span class="gi">+        $this-&gt;body += (array) $this-&gt;query-&gt;item($id);
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">#[Embed]</code>アトリビュートの<code class="language-plaintext highlighter-rouge">src</code>で指定されたリソースのリクエストがbodyプロパティの<code class="language-plaintext highlighter-rouge">rel</code>キーにインジェクトされ、レンダリング時に遅延評価され文字列表現になります。</p>

<p>例を簡単にするためにこの例ではパラメーターを渡していませんが、メソッド引数が受け取った値をURI templateを使って渡す事もできますし、インジェクトされたリクエストのパラメーターを修正、追加する事ができます。
詳しくは<a href="resource.html">リソース</a>をご覧ください。</p>

<p>もう一度リクエストすると<code class="language-plaintext highlighter-rouge">_embedded</code>というプロパティにprojectリソースの状態が追加されているのが分かります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% php bin/app.php get '/ticket?id=1'
</code></pre></div></div>
<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
{
    "id": "1",
    "title": "2",
    "date_created": "1970-01-01 00:00:01",
<span class="gi">+    "_embedded": {
+        "project": {
+            "title": "Project A",
+        }
</span>    },
</code></pre></div></div>

<p>埋め込みリソースはREST APIの重要な機能です。 コンテンツにツリー構造を与えHTTPリクエストコストを削減します。
情報が他の何の情報を含んでいるかはドメインの関心事です。クライアントで都度取得するのではなく、その関心事はサーバーサイドのLE(埋め込みリンク)でうまく表す事ができます。<sup id="fnref:6" role="doc-noteref"><a href="#fn:6" class="footnote" rel="footnote">24</a></sup></p>

<h2 id="ticketsリソース">ticketsリソース</h2>

<p><code class="language-plaintext highlighter-rouge">POST</code>で作成、<code class="language-plaintext highlighter-rouge">GET</code>でチケットリストが取得できる<code class="language-plaintext highlighter-rouge">tikcets</code>リソースを<code class="language-plaintext highlighter-rouge">src/resource/App/Tickets.php</code>に作成します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\JsonSchema</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\Link</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\HttpConstants\ResponseHeader</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\HttpConstants\StatusCode</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">MyVendor\Ticket\Query\TicketCommandInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">MyVendor\Ticket\Query\TicketQueryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\IdentityValueModule\UuidInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="k">function</span> <span class="nf">uri_template</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Tickets</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">private</span> <span class="nc">TicketQueryInterface</span> <span class="nv">$query</span><span class="p">,</span>
        <span class="kt">private</span> <span class="nc">TicketCommandInterface</span> <span class="nv">$command</span><span class="p">,</span>
        <span class="kt">private</span> <span class="nc">UuidInterface</span> <span class="nv">$uuid</span>
    <span class="p">){}</span>

    <span class="c1">#[Link(rel: "doPost", href: '/tickets')]</span>
    <span class="c1">#[Link(rel: "goTicket", href: '/ticket{?id}')]</span>
    <span class="c1">#[JsonSchema("tickets.json")]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'tickets'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">query</span><span class="o">-&gt;</span><span class="k">list</span><span class="p">()</span>
        <span class="p">];</span>
        
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">#[Link(rel: "goTickets", href: '/tickets')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$title</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">command</span><span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$title</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="nc">StatusCode</span><span class="o">::</span><span class="no">CREATED</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">LOCATION</span><span class="p">]</span> <span class="o">=</span> <span class="nf">uri_template</span><span class="p">(</span><span class="s1">'/ticket{?id}'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">]);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>インジェクトされた<code class="language-plaintext highlighter-rouge">$uuid</code>は文字列にキャストする事でUUIDが得られます。また<code class="language-plaintext highlighter-rouge">#Link[]</code>は他のリソース（アプリケーション状態）へのリンクを表します。</p>

<p><code class="language-plaintext highlighter-rouge">add()</code>メソッドで現在時刻を渡してない事に注目してください。
値が渡されない場合nullではなく、MySQLの現在時刻文字列がSQLにバインドされます。
なぜなら<code class="language-plaintext highlighter-rouge">DateTimeInterface</code>に束縛された現在時刻DateTimeオブジェクトの文字列表現（現在時刻文字列）がSQLに束縛されているからです。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">add</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$title</span><span class="p">,</span> <span class="kt">DateTimeInterface</span> <span class="nv">$dateCreated</span> <span class="o">=</span> <span class="kc">null</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
</code></pre></div></div>
<p>SQL内部でNOW()とハードコーディングする事や、メソッドに毎回現在時刻を渡す手間を省きます。
<code class="language-plaintext highlighter-rouge">DateTimeオブジェクト</code>を渡す事もできるし、テストのコンテキストでは固定のテスト用時刻を束縛することもできます。</p>

<p>このようにクエリーの引数にインターフェイスを指定するとそのオブジェクトをDIを使って取得、その文字列表現がSQLに束縛されます。
例えばログインユーザーIDなどを束縛してアプリケーションで横断的に利用できます。<sup id="fnref:7" role="doc-noteref"><a href="#fn:7" class="footnote" rel="footnote">25</a></sup></p>

<h2 id="ハイパーメディアapiテスト">ハイパーメディアAPIテスト</h2>

<blockquote>
  <p>REST(representational state transfer)という用語は、2000年にRoy Fieldingが博士論文の中で紹介、定義したもので「適切に設計されたWebアプリケーションの動作」をイメージさせることを目的としていてます。
それはWebリソースのネットワーク（仮想ステートマシン）であり、ユーザーはリソース識別子(URL)と、 GETやPOSTなどのリソース操作（アプリケーションステートの遷移）を選択することで、アプリケーションを進行させ、その結果、次のリソースの表現（次のアプリケーションステート）がエンドユーザーに転送されて使用されるというものです。</p>

  <p>– <a href="https://en.wikipedia.org/wiki/Representational_state_transfer">Wikipedia (REST)</a></p>
</blockquote>

<p>RESTアプリケーションでは次のアクションがURLとしてサービスから提供され、クライアントはそれを選択します。</p>

<p>HTML Webアプリケーションは完全にRESTfulです。その操作は「（aタグなどで）<strong>提供されたURLに遷移する</strong>」 または 「<strong>提供されたフォームを埋めて送信する</strong>」この何れかでしかありません。</p>

<p>REST APIのテストも同様に記述します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Hypermedia</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\HttpConstants\ResponseHeader</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">MyVendor\Ticket\Injector</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">MyVendor\Ticket\Query\TicketQueryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PHPUnit\Framework\TestCase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\InjectorInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="k">function</span> <span class="nf">json_decode</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">WorkflowTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="kt">ResourceInterface</span> <span class="nv">$resource</span><span class="p">;</span>
    <span class="k">protected</span> <span class="kt">InjectorInterface</span> <span class="nv">$injector</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">injector</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">(</span><span class="s1">'hal-api-app'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">injector</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="nc">ResourceInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
        <span class="nv">$a</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">injector</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="nc">TicketQueryInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">testIndex</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$index</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nv">$index</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$index</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @depends testIndex
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testGoTickets</span><span class="p">(</span><span class="kt">ResourceObject</span> <span class="nv">$response</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>

        <span class="nv">$json</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nv">$response</span><span class="p">;</span>
        <span class="nv">$href</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$json</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">_links</span><span class="o">-&gt;</span><span class="p">{</span><span class="s1">'goTickets'</span><span class="p">}</span><span class="o">-&gt;</span><span class="n">href</span><span class="p">;</span>
        <span class="nv">$ro</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$href</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$ro</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @depends testGoTickets
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testDoPost</span><span class="p">(</span><span class="kt">ResourceObject</span> <span class="nv">$response</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$json</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nv">$response</span><span class="p">;</span>
        <span class="nv">$href</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$json</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">_links</span><span class="o">-&gt;</span><span class="p">{</span><span class="s1">'doPost'</span><span class="p">}</span><span class="o">-&gt;</span><span class="n">href</span><span class="p">;</span>
        <span class="nv">$ro</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="nv">$href</span><span class="p">,</span> <span class="p">[</span><span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'title1'</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$ro</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @depends testDoPost
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testGoTicket</span><span class="p">(</span><span class="kt">ResourceObject</span> <span class="nv">$response</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$href</span> <span class="o">=</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">LOCATION</span><span class="p">];</span>
        <span class="nv">$ro</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$href</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$ro</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>起点となるルートページも必要です。</p>

<p><code class="language-plaintext highlighter-rouge">src/Resource/App/Index.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\Link</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Index</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[Link(rel: 'goTickets', href: '/tickets')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">setUp</code>ではリソースクライアントを生成、<code class="language-plaintext highlighter-rouge">testIndex()</code>でルートページをアクセスしています。</li>
  <li>レスポンスを受け取った<code class="language-plaintext highlighter-rouge">testGoTickets()</code>メソッドではそのレスポンスオブジェクトをJSON表現にして、次のチケット一覧を取得するリンク<code class="language-plaintext highlighter-rouge">goTickets</code>を取得しています。</li>
  <li>リソースボディのテストを記述する必要はありません。レスポンスのJsonSchemaバリデーションが通ったというが保証されているので、ステータスコードの確認だけでOKです。</li>
  <li>RESTの統一インターフェイスに従い、次にアクセスするリクエストURLは常にレスポンスに含まれます。それを次々に検査します。</li>
</ul>

<blockquote>
  <p><strong>RESTの統一インターフェイス</strong></p>

  <p>1)リソースの識別、2)表現によるリソースの操作、3)自己記述メッセージ、
4)アプリケーション状態のエンジンとしてのハイパーメディア(HATEOAS)の4つのインターフェイス制約です。<sup id="fnref:11" role="doc-noteref"><a href="#fn:11" class="footnote" rel="footnote">26</a></sup></p>
</blockquote>

<p>実行してみましょう</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./vendor/bin/phpunit <span class="nt">--testsuite</span> hypermedia
</code></pre></div></div>

<p>ハイパーメディアAPIテスト（RESTアプリケーションテスト）はRESTアプリケーションがステートマシンであるという事をよく表し、ワークフローをユースケースとして記述する事ができます。
REST APIテストを見ればそのアプリケーションがどのように使われるか網羅されているのが理想です。</p>

<h3 id="httpテスト">HTTPテスト</h3>

<p>HTTPでREST APIのテストを行うためにはテスト全体を継承して、<code class="language-plaintext highlighter-rouge">setUp</code>でクライアントをHTTPテストクライアントにします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">WorkflowTest</span> <span class="kd">extends</span> <span class="nc">Workflow</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpResource</span><span class="p">(</span><span class="s1">'127.0.0.1:8080'</span><span class="p">,</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/index.php'</span><span class="p">,</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/log/workflow.log'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>このクライアントはリソースクライアントと同じインターフェイスを持ちますが、実際のリクエストはビルトインサーバーに対してHTTPリクエストで行われサーバーからのレスポンスを受け取ります。
1つ目の引数はビルトインサーバーのURLです。<code class="language-plaintext highlighter-rouge">new</code>されると二番目の引数で指定されたbootstrapスクリプトでビルトインサーバーが起動します。</p>

<p>テストサーバー用のbootstrapスクリプトもAPIコンテキストに変更します。</p>

<p><code class="language-plaintext highlighter-rouge">tests/Http/index.php</code></p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">-exit((new Bootstrap())('hal-app', $GLOBALS, $_SERVER));
</span><span class="gi">+exit((new Bootstrap())('hal-api-app', $GLOBALS, $_SERVER));
</span></code></pre></div></div>

<p>実行してみましょう。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./vendor/bin/phpunit --testsuite http
</code></pre></div></div>
<h4 id="httpアクセスログ">HTTPアクセスログ</h4>

<p>curlで行われた実際のHTTPリクエスト/レスポンスログが三番目の引数のリソースログに記録されます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -s -i 'http://127.0.0.1:8080/'

HTTP/1.1 200 OK
Host: 127.0.0.1:8080
Date: Fri, 21 May 2021 22:41:02 GMT
Connection: close
X-Powered-By: PHP/8.0.6
Content-Type: application/hal+json

{
    "_links": {
        "self": {
            "href": "/index"
        },
        "goTickets": {
            "href": "/tickets"
        }
    }
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -s -i -H 'Content-Type:application/json' -X POST -d '{"title":"title1"}' http://127.0.0.1:8080/tickets

HTTP/1.1 201 Created
Host: 127.0.0.1:8080
Date: Fri, 21 May 2021 22:41:02 GMT
Connection: close
X-Powered-By: PHP/8.0.6
Location: /ticket?id=421d997c-9a0e-4018-a6c2-9b8758cac6d6
</code></pre></div></div>

<p>実際に記録されたJSONは、特に複雑な構造を持つ場合に確認するのに役に立ちます。APIドキュメントと併せて確認するのにもいいでしょう。
HTTPクライアントはE2Eテストにも利用する事ができます。</p>

<h2 id="apiドキュメント-1">APIドキュメント</h2>

<p>ResourceObjectではメソッドシグネチャーがAPIの入力パラメーターになっていて、レスポンスがスキーマ定義されています。
その自己記述性の高さからAPIドキュメントが自動生成する事ができます。</p>

<p>作成してみましょう。<a href="https://bearsunday.github.io/tutorial2/">docs</a>フォルダにドキュメントが出力されます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer doc
</code></pre></div></div>

<p>​</p>

<p>IDL(インターフェイス定義言語）を記述する労力を削減しますが、より価値があるのはドキュメントが最新のPHPコードに追従し常に正確な事です。
CIに組み込み常にコードとAPIドキュメントが同期している状態にするのがいいでしょう。</p>

<p>関連ドキュメントをリンクする事もできます。設定について詳しくは<a href="apidoc.html">ApiDoc</a>をご覧ください。</p>

<h2 id="コード例">コード例</h2>

<p>以下のコード例も用意しています。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Test</code>コンテキストを追加してテスト毎にDBをクリアするTestModule <a href="https://github.com/bearsunday/tutorial2/commit/4e9704d3bc65b9c7e7a8c13164dfe7cc3d6929b2">4e9704d</a></li>
  <li>DBクエリーで連想配列を返す代わりにハイドレートされたエンティティクラスを返す<a href="">Ray.MediaQuery</a>の<code class="language-plaintext highlighter-rouge">entity</code>オプション <a href="https://github.com/bearsunday/tutorial2/commit/29f0a1f4d4bf51e6c0a722fd6b2f44cb78de999e">29f0a1f</a></li>
  <li>静的なSQLと動的なSQLを合成したクエリービルダー <a href="https://github.com/bearsunday/tutorial2/commit/9d095acfed6150fb99f36d502ae13f03bdf2916d">9d095ac</a></li>
</ul>

<h2 id="rest-framework">REST framework</h2>

<p>Web APIには以下の3つのスタイルがあります。</p>

<ul>
  <li>トンネル (SOAP, GraphQL）</li>
  <li>URI (オブジェクト、CRUD)</li>
  <li>ハイパーメディア (REST)</li>
</ul>

<p>リソースを単なるRPCとして扱うURIスタイル<sup id="fnref:9" role="doc-noteref"><a href="#fn:9" class="footnote" rel="footnote">27</a></sup>に対して、 このチュートリアルで学んだのはリソースがリンクされているRESTです。<sup id="fnref:10" role="doc-noteref"><a href="#fn:10" class="footnote" rel="footnote">28</a></sup>
リソースは<code class="language-plaintext highlighter-rouge">#Link</code>のLO(アウトバウンドリンク)で結ばれワークフローを表し、<code class="language-plaintext highlighter-rouge">#[Embed]</code>のLE(埋め込みリンクで)ツリー構造を表しています。</p>

<p>BEAR.Sundayは標準に基づいたクリーンなコードである事を重視します。</p>

<p>フレームワーク固有のバリデータよりJsonSchema。独自ORMより標準SQL。独自構造JSONよりIANA標準メディアタイプ<sup id="fnref:12" role="doc-noteref"><a href="#fn:12" class="footnote" rel="footnote">29</a></sup>JSON。</p>

<p>アプリケーション設計は「実装が自由である」事ではなく「制約の選択が自由である」という事が重要です。
アプリケーションはその制約に基づき開発効率やパフォーマンス、後方互換性を壊さない進化可能性を目指すと良いでしょう。</p>

<hr />

<p>コメントは説明になるだけでなくスロークエリーログ等からもSQLを特定しやすくなります。</p>

<p>※ 以前のPHP7対応のチュートリアルは<a href="tutorial2_v1.html">tutorial2_v1</a>にあります。</p>

<h1 id="チュートリアル2">チュートリアル2</h1>

<p>このチュートリアルでは以下のツールを用いてタスク管理のチケット作成・取得用REST APIを作成し、疎結合で高品質なREST APIアプリケーションの開発をテスト駆動で学びます。<sup id="fnref:1:4" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">3</a></sup></p>

<ul>
  <li>CakePHPが開発してるフレームワーク非依存の<a href="https://book.cakephp.org/3.0/ja/phinx.html">Phinx</a> DBマイグレーションツール</li>
  <li>JSONのデータ構造を定義しバリデーションやドキュメンテーションに利用する <a href="https://qiita.com/kyoh86/items/e7de290e9a0e989fcc14">Json Schema</a></li>
  <li>SQL文をSQL実行オブジェクトに変換しアプリケーションレイヤーとデータアクセスレイヤーを疎にする <a href="https://github.com/ray-di/Ray.QueryModule">ray/query-module</a></li>
  <li>UUIDや現在時刻をインジェクトする <a href="https://github.com/ray-di/Ray.IdentityValueModule">IdentityValueModule</a></li>
</ul>

<p>作成するAPIはスキーマ定義され、自己記述（self-descriptive)性に優れた高品質なものです。</p>

<p><a href="/manuals/1.0/ja/tutorial.html">チュートリアル</a>と被る箇所もありますがおさらいのつもりでトライしてみましょう。
レポジトリは <a href="https://github.com/bearsunday/tutorial2">bearsunday/tutorial2</a> にあります。うまくいかないときは見比べてみましょう。</p>

<h2 id="プロジェクト作成-1">プロジェクト作成</h2>

<p>プロジェクトスケルトンを作成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer create-project bear/skeleton MyVendor.Ticket
</code></pre></div></div>
<p><strong>vendor</strong>名を<code class="language-plaintext highlighter-rouge">MyVendor</code>に<strong>project</strong>名を<code class="language-plaintext highlighter-rouge">Ticket</code>として入力します。<sup id="fnref:2:3" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">14</a></sup></p>

<h2 id="composerインストール">composerインストール</h2>

<p>次に依存するパッケージを一度にインストールします。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require bear/aura-router-module ray/identity-value-module ray/query-module
composer require --dev robmorgan/phinx bear/api-doc 1.x-dev
</code></pre></div></div>

<h2 id="モジュールインストール-3">モジュールインストール</h2>

<p><code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code>を編集してcomposerでインストールしたパッケージをモジュールインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\PackageModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\Provide\Router\AuraRouterModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Module\JsonSchemaLinkHeaderModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Module\JsonSchemaModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\IdentityValueModule\IdentityValueModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Query\SqlQueryModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$appDir</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">appMeta</span><span class="o">-&gt;</span><span class="n">appDir</span><span class="p">;</span>
        <span class="k">require_once</span> <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/env.php'</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">AuraSqlModule</span><span class="p">(</span>
                <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_DSN'</span><span class="p">),</span>
                <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_USER'</span><span class="p">),</span>
                <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_PASS'</span><span class="p">),</span>
                <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_SLAVE'</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">SqlQueryModule</span><span class="p">(</span><span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/var/sql'</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">IdentityValueModule</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">JsonSchemaModule</span><span class="p">(</span>
                <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/var/json_schema'</span><span class="p">,</span>
                <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/var/json_validate'</span>
            <span class="p">)</span>
        <span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">JsonSchemaLinkHeaderModule</span><span class="p">(</span><span class="s1">'http://www.example.com/'</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">AuraRouterModule</span><span class="p">(</span><span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/var/conf/aura.route.php'</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">PackageModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>テスト用のデータベースのために<code class="language-plaintext highlighter-rouge">src/Module/TestModule.php</code>も作成します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Module</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\AuraSqlModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">TestModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="cd">/**
     * {@inheritdoc}
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">AuraSqlModule</span><span class="p">(</span>
                <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_DSN'</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'_test'</span><span class="p">,</span>
                <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_USER'</span><span class="p">),</span>
                <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_PASS'</span><span class="p">),</span>
                <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_SLAVE'</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>モジュールが必要とするフォルダを作成します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>var/sql
<span class="nb">mkdir </span>var/json_schema
<span class="nb">mkdir </span>var/json_validate
</code></pre></div></div>

<h2 id="ルーターファイル">ルーターファイル</h2>

<p><code class="language-plaintext highlighter-rouge">tickets/{id}</code>のアクセスを<code class="language-plaintext highlighter-rouge">Ticket</code>クラスにルートするためにルーターファイルを<code class="language-plaintext highlighter-rouge">var/conf/aura.route.php</code>に設置します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="cm">/* @var \Aura\Router\Map $map */</span>
<span class="nv">$map</span><span class="o">-&gt;</span><span class="nf">route</span><span class="p">(</span><span class="s1">'/ticket'</span><span class="p">,</span> <span class="s1">'/tickets/{id}'</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="データベース-3">データベース</h2>

<p>プロジェクトルートフォルダの<code class="language-plaintext highlighter-rouge">.env</code>ファイルに接続情報を記述します。<sup id="fnref:6:1" role="doc-noteref"><a href="#fn:6" class="footnote" rel="footnote">24</a></sup></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TKT_DB_HOST=127.0.0.1
TKT_DB_NAME=ticket
TKT_DB_USER=root
TKT_DB_PASS=''
TKT_DB_SLAVE=''
TKT_DB_DSN=mysql:host=${TKT_DB_HOST};dbname=${TKT_DB_NAME}
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">.env</code>はリポジトリにはコミットされません。<code class="language-plaintext highlighter-rouge">.env.dist</code>に記述例を残して置きましょう。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp .env .env.dist
// remove password, etc..
git add .env.dist
</code></pre></div></div>

<h2 id="マイグレーション">マイグレーション</h2>

<p>phinxの実行環境を整えます。</p>

<p>まずはphinxが利用するフォルダを作成します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> var/phinx/migrations
<span class="nb">mkdir </span>var/phinx/seeds
</code></pre></div></div>

<p>次に<code class="language-plaintext highlighter-rouge">.env</code>の接続情報をphinxで利用するために<code class="language-plaintext highlighter-rouge">var/phinx/phinx.php</code>を設置します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/env.php'</span><span class="p">;</span>
<span class="nv">$development</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">PDO</span><span class="p">(</span><span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_DSN'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_USER'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_PASS'</span><span class="p">));</span>
<span class="nv">$test</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">PDO</span><span class="p">(</span><span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_DSN'</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'_test'</span><span class="p">,</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_USER'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_PASS'</span><span class="p">));</span>
<span class="k">return</span> <span class="p">[</span>
    <span class="s1">'paths'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'migrations'</span> <span class="o">=&gt;</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/migrations'</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">'environments'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'development'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$development</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s2">"SELECT DATABASE()"</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">fetchColumn</span><span class="p">(),</span>
            <span class="s1">'connection'</span> <span class="o">=&gt;</span> <span class="nv">$development</span>
        <span class="p">],</span>
        <span class="s1">'test'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$test</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s2">"SELECT DATABASE()"</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">fetchColumn</span><span class="p">(),</span>
            <span class="s1">'connection'</span> <span class="o">=&gt;</span> <span class="nv">$test</span>
        <span class="p">]</span>
    <span class="p">]</span>
<span class="p">];</span>
</code></pre></div></div>
<h2 id="setupスクリプト-1">setupスクリプト</h2>

<p>データベース作成やマイグレーションを簡単に実行できるように<code class="language-plaintext highlighter-rouge">bin/setup.php</code>を編集します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/autoload.php'</span><span class="p">;</span>
<span class="k">require_once</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/env.php'</span><span class="p">;</span>
<span class="c1">// dir</span>
<span class="nb">chdir</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">));</span>
<span class="nb">passthru</span><span class="p">(</span><span class="s1">'rm -rf var/tmp/*'</span><span class="p">);</span>
<span class="nb">passthru</span><span class="p">(</span><span class="s1">'chmod 775 var/tmp'</span><span class="p">);</span>
<span class="nb">passthru</span><span class="p">(</span><span class="s1">'chmod 775 var/log'</span><span class="p">);</span>
<span class="c1">// db</span>
<span class="nv">$pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">PDO</span><span class="p">(</span><span class="s1">'mysql:host='</span> <span class="mf">.</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_HOST'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_USER'</span><span class="p">),</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_PASS'</span><span class="p">));</span>
<span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'CREATE DATABASE IF NOT EXISTS '</span> <span class="mf">.</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_NAME'</span><span class="p">));</span>
<span class="nv">$pdo</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="s1">'CREATE DATABASE IF NOT EXISTS '</span> <span class="mf">.</span> <span class="nb">getenv</span><span class="p">(</span><span class="s1">'TKT_DB_NAME'</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'_test'</span><span class="p">);</span>
<span class="nb">passthru</span><span class="p">(</span><span class="s1">'./vendor/bin/phinx migrate -c var/phinx/phinx.php -e development'</span><span class="p">);</span>
<span class="nb">passthru</span><span class="p">(</span><span class="s1">'./vendor/bin/phinx migrate -c var/phinx/phinx.php -e test'</span><span class="p">);</span>
</code></pre></div></div>

<p>実行してデータベースを作成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer setup
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Phinx by CakePHP - https://phinx.org. 0.10.6

...
using database ticket_test
</code></pre></div></div>

<p>次に<code class="language-plaintext highlighter-rouge">ticket</code>テーブルを作成するためにマイグレーションクラスを作成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./vendor/bin/phinx create Ticket -c var/phinx/phinx.php
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Phinx by CakePHP - https://phinx.org. 0.10.6

...
created var/phinx/migrations/20180920054037_ticket.php
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">var/phinx/migrations/{current_date}_ticket.php</code>を編集して<code class="language-plaintext highlighter-rouge">change()</code>メソッドを実装します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">use</span> <span class="nc">Phinx\Migration\AbstractMigration</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Ticket</span> <span class="kd">extends</span> <span class="nc">AbstractMigration</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">change</span><span class="p">()</span>
    <span class="p">{</span>
         <span class="nv">$table</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">table</span><span class="p">(</span><span class="s1">'ticket'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">'primary_key'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'id'</span><span class="p">]]);</span>
         <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'uuid'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'description'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'assignee'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'created_at'</span><span class="p">,</span> <span class="s1">'datetime'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">addColumn</span><span class="p">(</span><span class="s1">'updated_at'</span><span class="p">,</span> <span class="s1">'datetime'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>もう一度セットアップコマンドを実行してテーブルを作成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer setup
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; php bin/setup.php
Phinx by CakePHP - https://phinx.org. 0.10.6

...
All Done. Took 0.0248s
</code></pre></div></div>

<p>これでテーブルが作成されました。次回からこのプロジェクトのデータベース環境を整えるには<code class="language-plaintext highlighter-rouge">composer setup</code>を実行するだけで行えます。<sup id="fnref:7:1" role="doc-noteref"><a href="#fn:7" class="footnote" rel="footnote">25</a></sup>
マイグレーションクラスの記述について詳しくは<a href="https://book.cakephp.org/3.0/ja/phinx/migrations.html">Phixのマニュアル：マイグレーションを書く</a>をご覧ください。</p>

<h2 id="sql-2">SQL</h2>

<p>チケットをデータベースに保存、読み込むために次の３つのSQLを<code class="language-plaintext highlighter-rouge">var/sql</code>に保存します。</p>

<p><code class="language-plaintext highlighter-rouge">var/sql/ticket_insert.sql</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* create ticket */</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">ticket</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">assignee</span><span class="p">,</span> <span class="n">created_at</span><span class="p">,</span> <span class="n">updated_at</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(:</span><span class="n">id</span><span class="p">,</span> <span class="p">:</span><span class="n">title</span><span class="p">,</span> <span class="p">:</span><span class="n">description</span><span class="p">,</span> <span class="p">:</span><span class="n">status</span><span class="p">,</span> <span class="p">:</span><span class="n">assignee</span><span class="p">,</span> <span class="p">:</span><span class="n">created_at</span><span class="p">,</span> <span class="p">:</span><span class="n">updated_at</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">var/sql/ticket_list.sql</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">assignee</span><span class="p">,</span> <span class="n">created_at</span><span class="p">,</span> <span class="n">updated_at</span>
  <span class="k">FROM</span> <span class="n">ticket</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">var/sql/ticket_item_by_id.sql</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">assignee</span><span class="p">,</span> <span class="n">created_at</span><span class="p">,</span> <span class="n">updated_at</span>
  <span class="k">FROM</span> <span class="n">ticket</span>
 <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="p">:</span><span class="n">id</span>
</code></pre></div></div>

<p>上記のSQLの記述は<a href="https://www.sqlstyle.guide/ja/">SQLスタイルガイド</a>に従ったものです。以下の事柄が推奨されています。</p>

<ul>
  <li>スペースとインデントを慎重に使用しコードを読みやすくする。</li>
  <li>ISO-8601に準拠した日付時間フォーマット（YYYY-MM-DD HH:MM:SS.SSSSS）で格納する。</li>
  <li>移植性のためベンダー固有の関数の代わりに標準のSQL関数のみを使用する。</li>
  <li>必要に応じてSQLコードにコメントを挿入する。可能なら /* で始まり */ で終わるC言語スタイルのコメントを使用し、その他の場合、– で始まり改行で終わる行コメントを使用する。</li>
  <li>スペースを活用し、基底のキーワードがすべて同じ位置で終わるようにコードを整列させる。これは途中で「リバー」を形作り、コードの見通しを良くし、実装の詳細からキーワードを分離することを容易にする。</li>
</ul>

<p>PHPStormで<a href="https://confluence.jetbrains.com/display/CONTEST/Database+Navigator">Database Navigator</a>を使うと、SQLのコード補完や実行が行えます。<a href="https://www.youtube.com/watch?v=P3C0iO1yqhk"></a>
PHPでSQLを実行する前に、データベースツールでSQLを単体で実行して正しく記述できているかを確かめると開発も容易で確実です。</p>

<p><a href="https://www.jetbrains.com/datagrip/">JetBrain DataGrip</a>、<a href="https://www.sequelpro.com/">Sequel Pro</a>、<a href="https://www.mysql.com/jp/products/workbench/">MySQL Workbench</a>などの単体のデータベースツールがあります。</p>

<h2 id="jsonschema-1">JsonSchema</h2>

<p><code class="language-plaintext highlighter-rouge">Ticket</code>（<code class="language-plaintext highlighter-rouge">チケットアイテム</code>）、<code class="language-plaintext highlighter-rouge">Tickets</code>（<code class="language-plaintext highlighter-rouge">チケットアイテムの集合</code>）の２つのリソースを作成するために、まずこれらのリソースの定義を<a href="http://json-schema.org/">JsonSchema</a>で定義します。JsonSchemaについて<a href="https://qiita.com/kyoh86/items/e7de290e9a0e989fcc14">日本語での解説</a>もご覧ください。</p>

<p>それぞれのスキーマファイルを<code class="language-plaintext highlighter-rouge">var/json_schema</code>フォルダに保存します。</p>

<p><code class="language-plaintext highlighter-rouge">var/json_schema/ticket.json</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"$id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ticket.json"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://json-schema.org/draft-07/schema#"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Ticket"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The unique identifier for a ticket."</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The title of the ticket"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"minLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">255</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The description of the ticket"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">255</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"assignee"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The assignee of the ticket"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">255</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The name of the status"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">255</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The date and time that the ticket was created"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"datetime"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The date and time that the ticket was last modified"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"datetime"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"title"</span><span class="p">,</span><span class="w"> </span><span class="s2">"description"</span><span class="p">,</span><span class="w"> </span><span class="s2">"status"</span><span class="p">,</span><span class="w"> </span><span class="s2">"created_at"</span><span class="p">,</span><span class="w"> </span><span class="s2">"updated_at"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">var/json_schema/tickets.json</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"$id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tickets.json"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://json-schema.org/draft-07/schema#"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Collection of Tickets"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ticket.json"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>作成したJSONを<code class="language-plaintext highlighter-rouge">validate-json</code>を使ってバリデートすることができます。<sup id="fnref:13:1" role="doc-noteref"><a href="#fn:13" class="footnote" rel="footnote">19</a></sup></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./vendor/bin/validate-json var/json_schema/ticket.json
./vendor/bin/validate-json var/json_schema/tickets.json
</code></pre></div></div>

<p>これでリソースを定義をすることが出来ました。このスキーマは実際にバリデーションで使うことが出来ます。また独立したJSONファイルはフロントエンドのバリデーションでも使うことができるでしょう。</p>

<h1 id="テスト-4">テスト</h1>

<p>次に今から作ろうとする<code class="language-plaintext highlighter-rouge">/ticket</code>リソースのテストを<code class="language-plaintext highlighter-rouge">tests/Resource/App/TicketsTest.php</code>に用意します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Package\AppInjector</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\HttpConstants\ResponseHeader</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\HttpConstants\StatusCode</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PHPUnit\Framework\TestCase</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">TicketsTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="cd">/**
     * @var ResourceInterface
     */</span>
    <span class="k">private</span> <span class="nv">$resource</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">()</span> <span class="p">:</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nc">AppInjector</span><span class="p">(</span><span class="s1">'MyVendor\Ticket'</span><span class="p">,</span> <span class="s1">'test-app'</span><span class="p">))</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="nc">ResourceInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">testOnPost</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$ro</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="s1">'app://self/tickets'</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'title1'</span><span class="p">,</span>
            <span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="s1">'status1'</span><span class="p">,</span>
            <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="s1">'description1'</span><span class="p">,</span>
            <span class="s1">'assignee'</span> <span class="o">=&gt;</span> <span class="s1">'assignee1'</span>
        <span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="nc">StatusCode</span><span class="o">::</span><span class="no">CREATED</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertStringContainsString</span><span class="p">(</span><span class="s1">'/ticket?id='</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">LOCATION</span><span class="p">]);</span>

        <span class="k">return</span> <span class="nv">$ro</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @depends testOnPost
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testOnGet</span><span class="p">(</span><span class="kt">ResourceObject</span> <span class="nv">$ro</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$location</span> <span class="o">=</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">LOCATION</span><span class="p">];</span>
        <span class="nv">$ro</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self'</span> <span class="mf">.</span> <span class="nv">$location</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="s1">'title1'</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="s1">'description1'</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'description'</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="s1">'assignee1'</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'assignee'</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">$this-&gt;resource</code>は<code class="language-plaintext highlighter-rouge">MyVendor\Ticket</code>アプリケーションを<code class="language-plaintext highlighter-rouge">test-app</code>コンテキストで動作させた時のリソースクライアントです。
<code class="language-plaintext highlighter-rouge">AppModule</code>、<code class="language-plaintext highlighter-rouge">TestModule</code>の順のモジュールで上書きされるのでデータベースはテスト用の<code class="language-plaintext highlighter-rouge">ticket_test</code>データベースが使われます。</p>

<p><code class="language-plaintext highlighter-rouge">testOnPost</code>でリソースをPOSTリクエストで作成して、<code class="language-plaintext highlighter-rouge">testOnGet</code>ではそのレスポンスのLocationヘッダーに表されているリソースのURIをGETリクエストして、作成したリソースが正しいものかをテストしています。</p>

<p>まだ実装してないのでエラーが出ますが、テスト実行を試してみましょう。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer test
</code></pre></div></div>

<p>当面の目標はこのテストがパスするようになる事です。テストを先に用意する事で、作ったリソースの実行やデバックトレースが簡単になり、着手した作業のゴールが明確になります。</p>

<h1 id="リソース-8">リソース</h1>

<p>リソースのロジックはSQLとして、そのバリデーションはJSONファイルで表すことが出来ています。リソースクラスではそれらのファイルを利用します。</p>

<h2 id="tikcetリソース-1">tikcetリソース</h2>

<p><code class="language-plaintext highlighter-rouge">ticket</code>リソースを<code class="language-plaintext highlighter-rouge">src/Resource/App/Ticket.php</code>に作成します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\Cacheable</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\JsonSchema</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Query\Annotation\Query</span><span class="p">;</span>

<span class="cd">/**
 * @Cacheable
 */</span>
<span class="kd">class</span> <span class="nc">Ticket</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="cd">/**
     * @JsonSchema(schema="ticket.json")
     * @Query("ticket_item_by_id", type="row")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$id</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nb">unset</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="ticket---getリクエスト">ticket - GETリクエスト</h2>

<p><code class="language-plaintext highlighter-rouge">GET</code>のための<code class="language-plaintext highlighter-rouge">onGet</code>メソッドを見てみましょう。メソッドシグネチャーを見れば、リクエストに必要な入力は<code class="language-plaintext highlighter-rouge">$_GET['id']</code>のみで、それは省略ができないという事が分かります。</p>

<p><code class="language-plaintext highlighter-rouge">@JsonSchema</code>アノテーションはこのクラスの<code class="language-plaintext highlighter-rouge">body</code>プロパティの<code class="language-plaintext highlighter-rouge">ticket</code>キー配列が<code class="language-plaintext highlighter-rouge">ticket.json</code>で定義されたスキーマであるということを宣言しつつリアルタイムのバリデーションをAOPで毎回行う事で保証しています。</p>

<p><code class="language-plaintext highlighter-rouge">@Query("ticket_item_by_id", type="row")</code>と指定されているので、このメソッドはSQL実行と置き換わります。<code class="language-plaintext highlighter-rouge">var/sql/ticket_item_by_id.sql</code>ファイルのSQLが実行され、その結果が単一行（type=”row”）で返ります。このようにロジックが単純にSQLで置換えられる場合は<code class="language-plaintext highlighter-rouge">@Query</code>を使ってPHPの記述を省略することができます。</p>

<h2 id="tikcetsリソース">tikcetsリソース</h2>

<p>次は<code class="language-plaintext highlighter-rouge">tikcet</code>リソースの集合の<code class="language-plaintext highlighter-rouge">tikcets</code>リソースを<code class="language-plaintext highlighter-rouge">src/resource/App/Tickets.php</code>に作成します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">MyVendor\Ticket\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Package\Annotation\ReturnCreatedResource</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\Cacheable</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\RepositoryModule\Annotation\Purge</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\JsonSchema</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\HttpConstants\ResponseHeader</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Koriym\HttpConstants\StatusCode</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\AuraSqlModule\Annotation\Transactional</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Di\Di\Named</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\IdentityValueModule\NowInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\IdentityValueModule\UuidInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Query\Annotation\Query</span><span class="p">;</span>

<span class="cd">/**
 * @Cacheable
 */</span>
<span class="kd">class</span> <span class="nc">Tickets</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="cd">/**
     * @var callable
     */</span>
    <span class="k">private</span> <span class="nv">$createTicket</span><span class="p">;</span>

    <span class="cd">/**
     * @var NowInterface
     */</span>
    <span class="k">private</span> <span class="nv">$now</span><span class="p">;</span>

    <span class="cd">/**
     * @var UuidInterface
     */</span>
    <span class="k">private</span> <span class="nv">$uuid</span><span class="p">;</span>

    <span class="cd">/**
     * @Named("createTicket=ticket_insert")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">callable</span> <span class="nv">$createTicket</span><span class="p">,</span> <span class="kt">NowInterface</span> <span class="nv">$now</span><span class="p">,</span> <span class="kt">UuidInterface</span> <span class="nv">$uuid</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">createTicket</span> <span class="o">=</span> <span class="nv">$createTicket</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">now</span> <span class="o">=</span> <span class="nv">$now</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">uuid</span> <span class="o">=</span> <span class="nv">$uuid</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @JsonSchema(schema="tickets.json")
     * @Query("ticket_list")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @ReturnCreatedResource
     * @Transactional
     * @Purge(uri="app://self/tickets")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span>
        <span class="kt">string</span> <span class="nv">$title</span><span class="p">,</span>
        <span class="kt">string</span> <span class="nv">$description</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span>
        <span class="kt">string</span> <span class="nv">$assignee</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="p">):</span> <span class="kt">static</span> <span class="p">{</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">uuid</span><span class="p">;</span>
        <span class="nv">$time</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">;</span>
        <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">createTicket</span><span class="p">)([</span>
            <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">,</span>
            <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">,</span>
            <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="nv">$description</span><span class="p">,</span>
            <span class="s1">'assignee'</span> <span class="o">=&gt;</span> <span class="nv">$assignee</span><span class="p">,</span>
            <span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
            <span class="s1">'created_at'</span> <span class="o">=&gt;</span> <span class="nv">$time</span><span class="p">,</span>
            <span class="s1">'updated_at'</span> <span class="o">=&gt;</span> <span class="nv">$time</span><span class="p">,</span>
        <span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="nc">StatusCode</span><span class="o">::</span><span class="no">CREATED</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">[</span><span class="nc">ResponseHeader</span><span class="o">::</span><span class="no">LOCATION</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"/ticket?id=</span><span class="si">{</span><span class="nv">$id</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="tickets---getリクエスト">tickets - GETリクエスト</h2>

<p><code class="language-plaintext highlighter-rouge">var/json_schema/tickets.json</code>JSONスキーマをご覧になってください。<code class="language-plaintext highlighter-rouge">ticket.json</code>スキーマの集合(array)と定義されています。
このようにJSONスキーマはスキーマの構造を表すことができます。メソッドは<code class="language-plaintext highlighter-rouge">/ticket</code>リソース同様に<code class="language-plaintext highlighter-rouge">ticket_list.sql</code>のSQL実行を結果として返します。</p>

<h2 id="tickets---postリクエスト">tickets - POSTリクエスト</h2>

<p>コンストラクタでインジェクトされた<code class="language-plaintext highlighter-rouge">$this-&gt;createTicket</code>は<code class="language-plaintext highlighter-rouge">ticket_insert.sql</code>の実行オブジェクトです。受け取った連想配列をバインドしてSQL実行します。
リソースを作成する時は必ず<code class="language-plaintext highlighter-rouge">Location</code>ヘッダーでリソースのURLを保存するようにします。作成した内容をボディに含みたい時は<code class="language-plaintext highlighter-rouge">@ReturnCreatedResource</code>とアノテートします。</p>

<p>まだ作成していないので見る事は今はできませんが、<code class="language-plaintext highlighter-rouge">OPTIONS</code>コマンドで調べることができます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php options /tickets
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
Content-Type: application/json
Allow: GET, POST

{
    "GET": {
        "schema": {
            "$id": "tickets.json",
            "$schema": "http://json-schema.org/draft-07/schema#",
            "title": "Collection of Tickets",
            "type": "array",
            "items": {
                "$ref": "ticket.json"
            }
        }
    },
    "POST": {
        "request": {
            "parameters": {
                "title": {
                    "type": "string"
                },
                "description": {
                    "type": "string",
                    "default": ""
                },
                "assignee": {
                    "type": "string",
                    "default": ""
                }
            },
            "required": [
                "title"
            ]
        }
    }
}
</code></pre></div></div>

<p>では実際に<code class="language-plaintext highlighter-rouge">/tickets</code>にアクセスしてみましょう。
POSTリクエストでチケット作成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php post '/tickets?title=run'
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>201 Created
Location: /tickets/b0f9c395-3a3d-48ee-921b-ce45a06eee11
content-type: application/hal+json

{
    "id": "b0f9c395-3a3d-48ee-921b-ce45a06eee11",
    "title": "run",
    "description": "",
    "status": "",
    "assignee": "",
    "created": "2018-09-11 13:15:33",
    "updated": "2018-09-11 13:15:33",
    "_links": {
        "self": {
            "href": "/tickets/b0f9c395-3a3d-48ee-921b-ce45a06eee11"
        }
    }
}
</code></pre></div></div>

<p>レスポンスにあるLocationヘッダーのURIをGETリクエストします。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php get '/tickets/b0f9c395-3a3d-48ee-921b-ce45a06eee11'
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
Link: &lt;http://www.example.com/ticket.json&gt;; rel="describedby"
content-type: application/hal+json
ETag: 3794765489
Last-Modified: Tue, 11 Sep 2018 11:16:05 GMT

{
    "id": "b0f9c395-3a3d-48ee-921b-ce45a06eee11",
    "title": "run",
    "description": "",
    "status": "",
    "assignee": "",
    "created": "2018-09-11 13:15:33",
    "updated": "2018-09-11 13:15:33",
    "_links": {
        "self": {
            "href": "/tickets/b0f9c395-3a3d-48ee-921b-ce45a06eee11"
        }
    }
}
</code></pre></div></div>

<p>レスポンスは200 OKで帰ってきましたか？
このレスポンスの定義は<code class="language-plaintext highlighter-rouge">ticket.json</code>で定義されたものであることが<code class="language-plaintext highlighter-rouge">Link</code>ヘッダーの<code class="language-plaintext highlighter-rouge">describedby</code>で分かります。<sup id="fnref:9:1" role="doc-noteref"><a href="#fn:9" class="footnote" rel="footnote">27</a></sup>
<code class="language-plaintext highlighter-rouge">@Cacheable</code>と宣言されたリソースは<code class="language-plaintext highlighter-rouge">ETag</code>と<code class="language-plaintext highlighter-rouge">Last-Modified</code>ヘッダーが付加されより効率の良いHTTPレベルのキャッシュが有効になります。
<code class="language-plaintext highlighter-rouge">@Purge</code>はキャッシュの破壊です。<sup id="fnref:10:1" role="doc-noteref"><a href="#fn:10" class="footnote" rel="footnote">28</a></sup></p>

<p>最初に作ったテストも今はうまくパスするはずです。試してみましょう。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer test
</code></pre></div></div>

<p>コーディング規約通りに書けているか、または<code class="language-plaintext highlighter-rouge">phpdoc</code>がコードと同じように正しく書けているかはツールで調べることができます。
エラーが出れば<code class="language-plaintext highlighter-rouge">cs-fix</code>で直すことができます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer cs-fix
</code></pre></div></div>

<p>ユニットテストとコーディング規約、静的解析ツールを同時に行うこともできます。コミットする前に実行しましょう。<sup id="fnref:3:2" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">17</a></sup></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer tests
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">compile</code>コマンドで最適化された<code class="language-plaintext highlighter-rouge">autoload.php</code>を生成してDI/AOPスクリプトを生成することができます。ディプロイ前は実行しましょう。<sup id="fnref:4:1" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">20</a></sup><sup id="fnref:5:1" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">23</a></sup>
全てをDIするBEAR.Sundayアプリケーションはアプリケーション実行前に依存の問題を見つけることができます。ログでDIの束縛の情報を見る事もできるので開発時でも役に立ちます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer compile
</code></pre></div></div>

<p>テストはパスしてコンパイルもうまくできましたか？ REST APIの完成です！</p>

<h2 id="apiドキュメント-2">APIドキュメント</h2>

<p>APIドキュメントを出力するために<code class="language-plaintext highlighter-rouge">php/bin.php</code>スクリプトを追加します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php

require dirname(__DIR__) . '/vendor/autoload.php';

use BEAR\ApiDoc\DocApp;

$docApp = new DocApp('MyVendor\Ticket');
$docApp-&gt;dumpHtml(dirname(__DIR__) . '/docs', 'app');```
</code></pre></div></div>

<p>ドキュメントのためのディレクトリを作成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir docs
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">composer doc</code>コマンドでAPIサイトのHTMLとJSONが出力されます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/doc.php
</code></pre></div></div>
<p>このサイトをGitHub Pages<sup id="fnref:11:1" role="doc-noteref"><a href="#fn:11" class="footnote" rel="footnote">26</a></sup>などで公開して、APIドキュメントにします。</p>

<p>このようなAPIドキュメントサイトができるはずです。</p>

<p><a href="https://bearsunday.github.io/tutorial2/">https://bearsunday.github.io/tutorial2/</a></p>

<p>もし<code class="language-plaintext highlighter-rouge">github.com</code>を使っていて、APIドキュメントをプライベートにしたい場合にはmarkdownで出力することもできます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$docApp</span><span class="o">-&gt;</span><span class="nf">dumpMd</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__DIR__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/docs'</span><span class="p">,</span> <span class="s1">'app'</span><span class="p">);</span><span class="sb">``</span><span class="err">`</span>
</code></pre></div></div>

<h2 id="終わりに">終わりに</h2>

<ul>
  <li>
    <p>phinxマイグレーションツールを使ってアプリケーションのバージョンに従ったデータベースの環境構築ができるようになりました。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">composer setup</code>コマンドで環境構築ができれば、データベースコマンドを操作する必要がなくディプロイやCIでも便利です。</p>
  </li>
  <li>
    <p>SQLファイルを<code class="language-plaintext highlighter-rouge">var/sql</code>フォルダに置くことでGUIやCLIのSQLツールで単体実行することができ、開発や運用にも便利でテストも容易になります。スタティックなSQLはPhpStormで補完も効くし、GUIでモデリングできるツールもあります。</p>
  </li>
  <li>
    <p>リソースの引数と出力はメソッドやスキーマで宣言されていて明瞭です。AOPでバリデーションが行わることでドキュメントの正当性が保証され、ドキュメントメンテナンスのの労力を最小化できます。</p>
  </li>
</ul>

<p>チュートリアルはうまく行ったでしょうか？ もしうまく行ったならチュートリアル<a href="https://github.com/bearsunday/tutorial2">bearsunday/tutorial2</a>にスターをして記念に残しましょう。
うまくいかない時は<a href="https://gitter.im/bearsunday/BEAR.Sunday">gitter</a>で相談すると解決できるかもしれません。提案や間違いがあれば<a href="https://github.com/bearsunday/bearsunday.github.io/blob/master/manuals/1.0/ja/tutorial2.md">PR</a>をお願いします！</p>

<hr />

<h1 id="チュートリアル-1">チュートリアル</h1>

<p>このチュートリアルではBEAR.Sundayの基本機能の<strong>DI</strong>、<strong>AOP</strong>、<strong>REST API</strong>を紹介します。<sup id="fnref:1:5" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">3</a></sup></p>

<h2 id="プロジェクト作成-2">プロジェクト作成</h2>

<p>年月日を入力すると曜日を返すWebサービスを作成してみましょう。
まずプロジェクトを作成します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer create-project bear/skeleton MyVendor.Weekday
</code></pre></div></div>

<p><strong>vendor</strong>名を<code class="language-plaintext highlighter-rouge">MyVendor</code>に<strong>project</strong>名を<code class="language-plaintext highlighter-rouge">Weekday</code>として入力します。<sup id="fnref:2:4" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">14</a></sup></p>

<h2 id="リソース-9">リソース</h2>

<p>最初にアプリケーションリソースファイルを<code class="language-plaintext highlighter-rouge">src/Resource/App/Weekday.php</code>に作成します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceObject</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">DateTimeImmutable</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Weekday</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$year</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$month</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$day</span><span class="p">):</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$dateTime</span> <span class="o">=</span> <span class="nc">DateTimeImmutable</span><span class="o">::</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">,</span> <span class="s2">"</span><span class="nv">$year</span><span class="s2">-</span><span class="nv">$month</span><span class="s2">-</span><span class="nv">$day</span><span class="s2">"</span><span class="p">);</span>
        <span class="nv">$weekday</span> <span class="o">=</span> <span class="nv">$dateTime</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'D'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'weekday'</span> <span class="o">=&gt;</span> <span class="nv">$weekday</span><span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>この<code class="language-plaintext highlighter-rouge">MyVendor\Weekday\Resource\App\Weekday</code>リソースクラスは<code class="language-plaintext highlighter-rouge">/weekday</code>というパスでアクセスすることができます。
<code class="language-plaintext highlighter-rouge">GET</code>メソッドのクエリーが<code class="language-plaintext highlighter-rouge">onGet</code>メソッドの引数に渡されます。</p>

<p>コンソールでアクセスしてみましょう。まずはエラーを試してみます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php get /weekday
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>400 Bad Request
content-type: application/vnd.error+json

{
    "message": "Bad Request",
    "logref": "e29567cd",
</code></pre></div></div>

<p>エラーは<a href="https://github.com/blongden/vnd.error">application/vnd.error+json</a>メディアタイプで返されます。
400はリクエストに問題があるエラーコードです。エラーには<code class="language-plaintext highlighter-rouge">logref</code>IDがつけられ<code class="language-plaintext highlighter-rouge">var/log/</code>でエラーの詳しい内容を参照することができます。</p>

<p>次は引数をつけて正しいリクエストを試します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php bin/app.php get <span class="s1">'/weekday?year=2001&amp;month=1&amp;day=1'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK
Content-Type: application/hal+json

<span class="o">{</span>
    <span class="s2">"weekday"</span>: <span class="s2">"Mon"</span>,
    <span class="s2">"_links"</span>: <span class="o">{</span>
        <span class="s2">"self"</span>: <span class="o">{</span>
            <span class="s2">"href"</span>: <span class="s2">"/weekday?year=2001&amp;month=1&amp;day=1"</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">application/hal+json</code>というメディアタイプで結果が正しく返って来ました。</p>

<p>これをWeb APIサービスにしてみましょう。
Built-inサーバーを立ち上げます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php <span class="nt">-S</span> 127.0.0.1:8080 bin/app.php
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">curl</code>でHTTPの<code class="language-plaintext highlighter-rouge">GET</code>リクエストを行って確かめてみましょう。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -i 'http://127.0.0.1:8080/weekday?year=2001&amp;month=1&amp;day=1'
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Host: 127.0.0.1:8080
Date: Fri, 01 Sep 2017 09:31:13 +0200
Connection: close
X-Powered-By: PHP/7.1.8
content-type: application/hal+json

{
    "weekday": "Mon",
    "_links": {
        "self": {
            "href": "/weekday/2001/1/1"
        }
    }
}
</code></pre></div></div>

<p>このリソースクラスにはGET以外のメソッドは用意されていないので、他のメソッドを試すと<code class="language-plaintext highlighter-rouge">405 Method Not Allowed</code>が返されます。これも試してみましょう。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -i -X POST 'http://127.0.0.1:8080/weekday?year=2001&amp;month=1&amp;day=1'
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 405 Method Not Allowed
...
</code></pre></div></div>

<p>HTTP <code class="language-plaintext highlighter-rouge">OPTIONS</code> メソッドリクエストで利用可能なHTTPメソッドと必要なパラメーターを調べることができます。(<a href="https://tools.ietf.org/html/rfc7231#section-4.3.7">RFC7231</a>)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -i -X OPTIONS http://127.0.0.1:8080/weekday
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
...
Content-Type: application/json
Allow: GET

{
    "GET": {
        "parameters": {
            "year": {
                "type": "integer"
            },
            "month": {
                "type": "integer"
            },
            "day": {
                "type": "integer"
            }
        },
        "required": [
            "year",
            "month",
            "day"
        ]
    }
}
</code></pre></div></div>
<h2 id="テスト-5">テスト</h2>

<p><a href="https://phpunit.readthedocs.io/ja/latest/">PHPUnit</a>を使ったリソースのテストを作成しましょう。</p>

<p><code class="language-plaintext highlighter-rouge">tests/Resource/App/WeekdayTest.php</code>に以下のテストコードを記述します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">MyVendor\Weekday\Resource\App</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">BEAR\Resource\ResourceInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">MyVendor\Weekday\Injector</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PHPUnit\Framework\TestCase</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">WeekdayTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">ResourceInterface</span> <span class="nv">$resource</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$injector</span> <span class="o">=</span> <span class="nc">Injector</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">(</span><span class="s1">'app'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span> <span class="o">=</span> <span class="nv">$injector</span><span class="o">-&gt;</span><span class="nf">getInstance</span><span class="p">(</span><span class="nc">ResourceInterface</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">testOnGet</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$ro</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'app://self/weekday'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'year'</span> <span class="o">=&gt;</span> <span class="s1">'2001'</span><span class="p">,</span> <span class="s1">'month'</span> <span class="o">=&gt;</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'day'</span> <span class="o">=&gt;</span> <span class="s1">'1'</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="s1">'Mon'</span><span class="p">,</span> <span class="nv">$ro</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'weekday'</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">setUp()</code>ではコンテキスト(app)を指定するとアプリケーションのどのオブジェクトでも生成できるアプリケーションのインジェクター
<code class="language-plaintext highlighter-rouge">Injector</code>を使ってリソースクライアント(<code class="language-plaintext highlighter-rouge">ResourceInterface</code>)を取得していて、テストメソッド<code class="language-plaintext highlighter-rouge">testOnGet</code>でリソースをリクエストしてテストします。</p>

<p>実行してみましょう。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./vendor/bin/phpunit
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PHPUnit 9.5.4 by Sebastian Bergmann and contributors.

....                                                                4 / 4 (100%)

Time: 00:00.281, Memory: 14.00 MB
</code></pre></div></div>

<p>インストールされたプロジェクトには他にはテストやコード検査を実行するコマンドが用意されています。
テストカバレッジを取得するには<code class="language-plaintext highlighter-rouge">composer coverage</code>を実行します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer coverage
</code></pre></div></div>

<p><a href="https://pecl.php.net/package/pcov">pcov</a>はより高速にカバレッジ計測を行います。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer pcov
</code></pre></div></div>

<p>カバレッジの詳細を<code class="language-plaintext highlighter-rouge">build/coverage/index.html</code>をWebブラウザで開くことで見ることができます。</p>

<p>コーディングスタンダードにしたがっているかのチェックは<code class="language-plaintext highlighter-rouge">composer cs</code>コマンドで確認できます。
その自動修正は<code class="language-plaintext highlighter-rouge">composer cs-fix</code>コマンドでできます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer cs
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer cs-fix
</code></pre></div></div>

<p>静的解析は<code class="language-plaintext highlighter-rouge">composer sa</code>コマンドでおこないます。</p>

<p>これまでのコードで実行してみましょう。以下のエラーがphpstanで検出されます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   
  15     Cannot call method format() on DateTimeImmutable|false.  
  

[^1]:このプロジェクトのソースコードは各セクション毎に[bearsunday/Tutorial](https://github.com/bearsunday/Tutorial/commits/master)にコミットしています。適宜参照してください。
[^2]:通常は**vendor**名は個人またはチーム（組織）の名前を入力します。githubのアカウント名やチーム名が適当でしょう。**project**にはアプリケーション名を入力します。
[^3]:最初の`@Embed`を使った方法は[宣言型プログラミング(Declative Programming)
     ](https://ja.wikipedia.org/wiki/%E5%AE%A3%E8%A8%80%E5%9E%8B%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0)、後者は[命令型プログラミング(Imperative Programming)](https://ja.wikipedia.org/wiki/%E5%91%BD%E4%BB%A4%E5%9E%8B%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0)です。`@Embed`を使った前者は簡潔で可読性が高くリソースの関係を良く表しています。



# タイプ

phpのネイティブではサポートされていない型も**PHPdoc type**を記述すれば、静的解析ツールが検査を行い対応するエディターでは補完もされます。
また将来のPHPで採用予定の型も先に利用できます。

例）リソースクラスの`body`の連想配列を"Object-like array"で指定

```php
/** @var array{greeting: string} */
public $body;
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @var list&lt;array{name: string, age:int}&gt; */</span>
<span class="k">public</span> <span class="nv">$body</span><span class="p">;</span>
</code></pre></div></div>

<p>リソースクライアントで取得したオブジェクトは<code class="language-plaintext highlighter-rouge">assert()</code>するとツールが型を理解します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/user'</span><span class="p">,</span> <span class="p">[]);</span>
<span class="nb">assert</span><span class="p">(</span><span class="nv">$user</span> <span class="k">instanceof</span> <span class="nc">User</span><span class="p">);</span>
<span class="nv">$name</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'name'</span><span class="p">];</span> <span class="c1">// nameキーが補間</span>
<span class="nv">$user</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="s1">'__invalid__'</span><span class="p">];</span> <span class="c1">// 未定義キーのアクセスはエラーに</span>
</code></pre></div></div>

<h1 id="リファレンス-3">リファレンス</h1>

<h2 id="アトミック型">アトミック型</h2>

<p>これ以上分割できない型をアトミック型と呼びます。PHP7の型は全てこの型です。ユニオン型や交差型ではアトミック型を組み合わせて利用します。</p>

<h3 id="スカラー型">スカラー型</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @param int $i */</span>
<span class="cd">/** @param float $f */</span>
<span class="cd">/** @param string $str */</span>
<span class="cd">/** @param class-string $class */</span>
<span class="cd">/** @param class-string&lt;AbstractFoo&gt; $fooClass */</span>
<span class="cd">/** @param callable-string $callable */</span>
<span class="cd">/** @param numeric-string $num */</span> 
<span class="cd">/** @param bool $isSet */</span>
<span class="cd">/** @param array-key $key */</span>
<span class="cd">/** @param numeric $num */</span>
<span class="cd">/** @param scalar $a */</span>
</code></pre></div></div>

<h3 id="オブジェクト型">オブジェクト型</h3>

<h4 id="ジェネリックオブジェクト">ジェネリックオブジェクト</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return ArrayObject&lt;int, string&gt; */</span>
</code></pre></div></div>

<h4 id="ジェネレーター">ジェネレーター</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return Generator&lt;int, string, mixed, void&gt; */</span>
</code></pre></div></div>

<h3 id="callable型">Callable型</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return callable(Type1, OptionalType2=, SpreadType3...): ReturnType */</span>
<span class="cd">/** @return Closure(bool):int */</span>
</code></pre></div></div>

<h3 id="値型">値型</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return null */</span>
<span class="cd">/** @return true */</span>
<span class="cd">/** @return 42 */</span>
<span class="cd">/** Foo\Bar::MY_SCALAR_CONST $a */</span>
<span class="cd">/** @param A::class|B::class $s */</span>
</code></pre></div></div>

<h3 id="配列型">配列型</h3>

<h4 id="ジェネリック配列">ジェネリック配列</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return array&lt;TKey, TValue&gt; */</span>
<span class="cd">/** @return array&lt;int, Foo&gt; */</span>
<span class="cd">/** @return array&lt;string, int|string&gt; */</span>

</code></pre></div></div>

<h4 id="オブジェクト風配列-object-like-arrays">オブジェクト風配列 (Object-like arrays)</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return array{0: string, 1: string, foo: stdClass, 28: false} */</span>
<span class="cd">/** @return array{foo: string, bar: int} */</span>
<span class="cd">/** @return array{optional?: string, bar: int} */</span>
</code></pre></div></div>

<h4 id="リスト">リスト</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @param list&lt;string&gt; $stringList */</span>
</code></pre></div></div>

<h4 id="phpdoc配列">PHPDoc配列</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @param string[] $strings */</span>
</code></pre></div></div>

<p>レガシーシンタックスのPHPDoc配列表記は<code class="language-plaintext highlighter-rouge">array&lt;array-key, ValueType&gt;</code>とジェネリック配列型として扱われます。</p>

<h3 id="その他のアトミック型">その他のアトミック型</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return iterable */</span>
<span class="cd">/** @return void */</span>
<span class="cd">/** @return empty */</span>
<span class="cd">/** @return mixed */</span>
</code></pre></div></div>

<h2 id="交差型">交差型</h2>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return A&amp;B */</span>
</code></pre></div></div>

<h2 id="ユニオン型">ユニオン型</h2>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @return int|false */</span>
<span class="cd">/** @return 0|1 */</span>
<span class="cd">/** @return 'a'|'b' */</span>
</code></pre></div></div>

<p>-</p>

<p>関連 PHPStormプラグイン</p>

<ul>
  <li><a href="https://plugins.jetbrains.com/plugin/9927-deep-assoc-completion">deep-array-assoc</a></li>
  <li><a href="https://plugins.jetbrains.com/plugin/12754-phpstan--psalm--generics">phpstan–psalm–generics</a></li>
</ul>

<h1 id="バリデーション">バリデーション</h1>

<ul>
  <li>JSONスキーマでリソースAPIを定義する事ができます。</li>
  <li><code class="language-plaintext highlighter-rouge">@Valid</code>, <code class="language-plaintext highlighter-rouge">@OnValidate</code>アノテーションでバリデーションコードを分離する事ができます。</li>
  <li>Webフォームによるバリデーションは<a href="form.html">フォーム</a>をご覧ください。</li>
</ul>

<h1 id="jsonスキーマ">JSONスキーマ</h1>

<p><a href="http://json-schema.org/">JSON スキーマ</a>とは、JSON objectの記述と検証のための標準です。<code class="language-plaintext highlighter-rouge">#[JsonSchema]</code>アトリビュートが付加されたリソースクラスのメソッドが返すリソース<code class="language-plaintext highlighter-rouge">body</code>に対してJSONスキーマによる検証が行われます。</p>

<h3 id="インストール-11">インストール</h3>

<p>全てのコンテキストで常にバリデーションを行うなら<code class="language-plaintext highlighter-rouge">AppModule</code>、開発中のみバリデーションを行うなら<code class="language-plaintext highlighter-rouge">DevModule</code>などのクラスを作成してその中でインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Resource\Module\JsonSchemaModule</span><span class="p">;</span> <span class="c1">// この行を追加</span>
<span class="kn">use</span> <span class="nc">BEAR\Package\AbstractAppModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">JsonSchemaModule</span><span class="p">(</span>
                <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/var/json_schema'</span><span class="p">,</span>
                <span class="nv">$appDir</span> <span class="mf">.</span> <span class="s1">'/var/json_validate'</span>
            <span class="p">)</span>
        <span class="p">);</span>   <span class="c1">// この行を追加</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ディレクトリ作成</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>var/json_schema
<span class="nb">mkdir </span>var/json_validate
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">var/json_schema/</code>にリソースのbodyの仕様となるJSONスキーマファイル、<code class="language-plaintext highlighter-rouge">var/json_validate/</code>には入力バリデーションのためのJSONスキーマファイルを格納します。</p>

<h3 id="jsonschemaアトリビュート">#[JsonSchema]アトリビュート</h3>

<p>リソースクラスのメソッドで<code class="language-plaintext highlighter-rouge">#[JsonSchema]</code>のアトリビュートを加えます。<code class="language-plaintext highlighter-rouge">schema</code>プロパティにはJSONスキーマファイル名を指定します。</p>

<h3 id="schema">schema</h3>

<p>src/Resource/App/User.php</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\JsonSchema</span><span class="p">;</span> <span class="c1">// この行を追加</span>

<span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[JsonSchema('user.json')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">():</span> <span class="kt">static</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'firstName'</span> <span class="o">=&gt;</span> <span class="s1">'mucha'</span><span class="p">,</span>
            <span class="s1">'lastName'</span> <span class="o">=&gt;</span> <span class="s1">'alfons'</span><span class="p">,</span>
            <span class="s1">'age'</span> <span class="o">=&gt;</span> <span class="mi">12</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>JSONスキーマを設置します。</p>

<p>/var/json_schema/user.json</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"firstName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[a-z</span><span class="se">\\</span><span class="s2">d~+-]+"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"lastName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[a-z</span><span class="se">\\</span><span class="s2">d~+-]+"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"firstName"</span><span class="p">,</span><span class="w"> </span><span class="s2">"lastName"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="key">key</h3>

<p>bodyにインデックスキーがある場合にはアノテーションの<code class="language-plaintext highlighter-rouge">key</code>プロパティで指定します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\JsonSchema</span><span class="p">;</span> <span class="c1">// Add this line</span>

<span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[JsonSchema(key:'user', schema:'user.json')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onGet</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'user'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'firstName'</span> <span class="o">=&gt;</span> <span class="s1">'mucha'</span><span class="p">,</span>
                <span class="s1">'lastName'</span> <span class="o">=&gt;</span> <span class="s1">'alfons'</span><span class="p">,</span>
                <span class="s1">'age'</span> <span class="o">=&gt;</span> <span class="mi">12</span>
            <span class="p">]</span>
        <span class="p">];</span>        

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="params">params</h3>

<p><code class="language-plaintext highlighter-rouge">params </code>プロパティには引数のバリデーションのためのJSONスキーマファイル名を指定します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">BEAR\Resource\Annotation\JsonSchema</span><span class="p">;</span> <span class="c1">// この行を追加</span>

<span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">extends</span> <span class="nc">ResourceObject</span>
<span class="p">{</span>
    <span class="c1">#[JsonSchema(key:'user', schema:'user.json', params:'todo.post.json')]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onPost</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$title</span><span class="p">)</span>
</code></pre></div></div>

<p>JSONスキーマを設置します。</p>

<p><strong>/var/json_validate/todo.post.json</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://json-schema.org/draft-04/schema#"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/todo POST request validation"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"minLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<p>独自ドキュメントの代わりに標準化された方法で常に検証することで、その仕様が<strong>人間にもマシンにも理解できる</strong>確実なものになります。</p>

<h3 id="target">target</h3>

<p>ResourceObjectのbodyに対してでなく、リソースオブジェクトの表現（レンダリングされた結果）に対してスキーマバリデーションを適用にするには<code class="language-plaintext highlighter-rouge">target='view'</code>オプションを指定します。
HALフォーマットで<code class="language-plaintext highlighter-rouge">_link</code>のスキーマが記述できます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#[JsonSchema(schema: 'user.json', target: 'view')]</span>
</code></pre></div></div>

<h3 id="関連リンク">関連リンク</h3>

<ul>
  <li><a href="http://json-schema.org/examples.html">Example</a></li>
  <li><a href="https://spacetelescope.github.io/understanding-json-schema/">Understanding JSON Schema</a></li>
  <li><a href="https://jsonschema.net/#/editor">JSON Schema Generator</a></li>
</ul>

<h2 id="validアノテーション">@Validアノテーション</h2>

<p><code class="language-plaintext highlighter-rouge">@Valid</code>アノテーションは入力のためのバリデーションです。メソッドの実行前にバリデーションメソッドが実行され、
エラーを検知すると例外が発生されエラー処理のためのメソッドを呼ぶこともできます。</p>

<p>分離したバリデーションのコードは可読性に優れテストが容易です。バリデーションのライブラリは<a href="https://github.com/auraphp/Aura.Filter">Aura.Filter</a>や<a href="https://github.com/Respect/Validation">Respect\Validation</a>、あるいは<a href="http://php.net/manual/ja/book.filter.php">PHP標準のFilter</a>を使います。</p>

<h3 id="インストール-12">インストール</h3>

<p>composerインストール</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require ray/validate-module
</code></pre></div></div>

<p>アプリケーションモジュール<code class="language-plaintext highlighter-rouge">src/Module/AppModule.php</code>で<code class="language-plaintext highlighter-rouge">ValidateModule</code>をインストールします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Validation\ValidateModule</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AppModule</span> <span class="kd">extends</span> <span class="nc">AbstractAppModule</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">configure</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">install</span><span class="p">(</span><span class="k">new</span> <span class="nc">ValidateModule</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="アノテーション">アノテーション</h3>

<p>バリデーションのために<code class="language-plaintext highlighter-rouge">@Valid</code>、<code class="language-plaintext highlighter-rouge">@OnValidate</code>、<code class="language-plaintext highlighter-rouge">@OnFailure</code>の３つのアノテーションが用意されています。</p>

<p>まず、バリデーションを行いたいメソッドに<code class="language-plaintext highlighter-rouge">@Valid</code>とアノテートします。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Validation\Annotation\Valid</span><span class="p">;</span>
<span class="c1">// ...</span>
    <span class="cd">/**
     * @Valid
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">createUser</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">@OnValidate</code>とアノテートしたメソッドでバリデーションを行います。引数は元のメソッドと同じにします。メソッド名は自由です。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Validation\Annotation\OnValidate</span><span class="p">;</span>
<span class="c1">// ...</span>
    <span class="cd">/**
     * @OnValidate
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onValidate</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$validation</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Validation</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$name</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$validation</span><span class="o">-&gt;</span><span class="nf">addError</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'name should be string'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$validation</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>バリデーション失敗した要素には<code class="language-plaintext highlighter-rouge">要素名</code>と<code class="language-plaintext highlighter-rouge">エラーメッセージ</code>を指定してValidationオブジェクトに<code class="language-plaintext highlighter-rouge">addError()</code>し、最後にValidationオブジェクトを返します。</p>

<p>バリデーションが失敗すれば<code class="language-plaintext highlighter-rouge">Ray\Validation\Exception\InvalidArgumentException</code>例外が投げられますが、
<code class="language-plaintext highlighter-rouge">@OnFailure</code>メソッドが用意されていればそのメソッドの結果が返されます。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Validation\Annotation\OnFailure</span><span class="p">;</span>
<span class="c1">// ...</span>
    <span class="cd">/**
     * @OnFailure
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onFailure</span><span class="p">(</span><span class="kt">FailureInterface</span> <span class="nv">$failure</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// original parameters</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">defaultName</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$failure</span><span class="o">-&gt;</span><span class="nf">getInvocation</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getArguments</span><span class="p">();</span>

        <span class="c1">// errors</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$failure</span><span class="o">-&gt;</span><span class="nf">getMessages</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$name</span> <span class="o">=&gt;</span> <span class="nv">$messages</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$messages</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">echo</span> <span class="s2">"Input '</span><span class="si">{</span><span class="nv">$name</span><span class="si">}</span><span class="s2">': </span><span class="si">{</span><span class="nv">$message</span><span class="si">}</span><span class="s2">"</span> <span class="mf">.</span> <span class="kc">PHP_EOL</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">@OnFailure</code>メソッドには<code class="language-plaintext highlighter-rouge">$failure</code>が渡され<code class="language-plaintext highlighter-rouge">($failure-&gt;getMessages()</code>でエラーメッセージや<code class="language-plaintext highlighter-rouge">$failure-&gt;getInvocation()</code>でオリジナルメソッド実行のオブジェクトが取得できます。</p>

<h3 id="複数のバリデーション">複数のバリデーション</h3>

<p>１つのクラスに複数のバリデーションメソッドが必要なときは以下のようにバリデーションの名前を指定します。</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Ray\Validation\Annotation\Valid</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Validation\Annotation\OnValidate</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Ray\Validation\Annotation\OnFailure</span><span class="p">;</span>
<span class="c1">// ...</span>

    <span class="cd">/**
     * @Valid("foo")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">fooAction</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$address</span><span class="p">,</span> <span class="nv">$zip</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="cd">/**
     * @OnValidate("foo")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onValidateFoo</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$address</span><span class="p">,</span> <span class="nv">$zip</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="cd">/**
     * @OnFailure("foo")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">onFailureFoo</span><span class="p">(</span><span class="kt">FailureInterface</span> <span class="nv">$failure</span><span class="p">)</span>
    <span class="p">{</span>
</code></pre></div></div>

<h3 id="その他のバリデーション">その他のバリデーション</h3>

<p>複雑なバリデーションの時は別にバリデーションクラスをインジェクトして、<code class="language-plaintext highlighter-rouge">onValidate</code>メソッドから呼び出してバリデーションを行います。DIなのでコンテキストによってバリデーションを変えることもできます。</p>

<h1 id="バージョン">バージョン</h1>

<h2 id="サポートするphp">サポートするPHP</h2>

<p><a href="https://github.com/bearsunday/BEAR.SupportedVersions/actions/workflows/continuous-integration.yml"><img src="https://github.com/bearsunday/BEAR.SupportedVersions/actions/workflows/continuous-integration.yml/badge.svg" alt="Continuous Integration" /></a></p>

<p>BEAR.SundayはサポートされているPHP(<a href="http://php.net/supported-versions.php">Supported Versions</a>) のバージョンのPHPをサポートします。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">8.1</code> (古い安定板 25 Nov 2021 - 25 Nov 2024)</li>
  <li><code class="language-plaintext highlighter-rouge">8.2</code> (古い安定板 8 Dec 2022 - 8 Dec 2025)</li>
  <li><code class="language-plaintext highlighter-rouge">8.3</code> (現在の安定板 23 Nov 2022 - 26 Nov 2026)</li>
</ul>

<p>End of life (<a href="http://php.net/eol.php">EOL</a>)</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">5.5</code> (21 Jul 2016)</li>
  <li><code class="language-plaintext highlighter-rouge">5.6</code> (31 Dec 2018)</li>
  <li><code class="language-plaintext highlighter-rouge">7.0</code> (3 Dec 2018)</li>
  <li><code class="language-plaintext highlighter-rouge">7.1</code> (1 Dec 2019)</li>
  <li><code class="language-plaintext highlighter-rouge">7.2</code> (30 Nov 2020)</li>
  <li><code class="language-plaintext highlighter-rouge">7.3</code> (6 Dec 2021)</li>
  <li><code class="language-plaintext highlighter-rouge">7.4</code> (28 Nov 2022)</li>
  <li><code class="language-plaintext highlighter-rouge">8.0</code> (26 Nov 2023)</li>
</ul>

<p>新規のオプションパッケージは現在の安定板をベースに開発されます。機能とパフォーマンスそれにセキュリティの観点から現在の安定板のPHPを使うことを勧めします。<a href="https://github.com/bearsunday/BEAR.SupportedVersions/">BEAR.SupportedVersions</a>のCIで各バージョンのテストが確認できます。</p>

<h2 id="semver-1">Semver</h2>

<p>BEAR.Sundayは<a href="http://
semver.org/lang/ja/">セマンティックバージョニング</a>に従います。バージョン番号が<code class="language-plaintext highlighter-rouge">0.1</code>増えるだけのマイナーバージョンアップではアプリケーションコードの修正は必要ありません。</p>

<h2 id="バージョニングポリシー">バージョニング・ポリシー</h2>

<ul>
  <li>
    <p>フレームワークのコアパッケージはユーザーコードに変更が必要な破壊的変更(breaking change）を行いません。<sup id="fnref:1:6" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">3</a></sup></p>
  </li>
  <li>
    <p>サポートするPHPがEOLを迎え、必要とするPHPがメジャーバージョンアップ(<code class="language-plaintext highlighter-rouge">5.6</code> →<code class="language-plaintext highlighter-rouge">7.0</code>)してもフレームワークのメジャーバージョンアップは行いません。後方互換性は保たれます。</p>
  </li>
  <li>
    <p>新しいモジュールを使うために必要なPHPのバージョン番号が上がることはあっても、そのために破壊的変更が行われる事はありません。</p>
  </li>
  <li>
    <p>破壊的変更を行わないために、古く不要な機能も削除しないで<sup id="fnref:3:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">17</a></sup>、新しい機能は（置き換えではなく）常に追加されます。</p>
  </li>
</ul>

<p>BEAR.Sundayは堅牢で進化可能<sup id="fnref:2:5" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">14</a></sup>なメンテナンス性の良いコードが<strong>長期的に利用できる</strong>ことを重視します。</p>

<h2 id="パッケージのバージョン">パッケージのバージョン</h2>

<p>フレームワークのバージョンはライブラリのバージョンの固定を行いません。ライブラリはフレームワークのバージョンと無関係にアップデートできます。<code class="language-plaintext highlighter-rouge">composer update</code>で常に依存を最新にする事を勧めます。</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:graph" role="doc-endnote">
      <p>オブジェクトは他のオブジェクトを保持しているか、保持されているかによって繋がっています。これを[Object Graph] (http://en.wikipedia.org/wiki/Object_graph)といいます。$appはそのルートオブジェクトです。 <a href="#fnref:graph" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:dip" role="doc-endnote">
      <p><a href="https://ja.wikipedia.org/wiki/依存性逆転の原則">依存性逆転の法則</a> <a href="#fnref:dip" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:1" role="doc-endnote">
      <p>つまりフレームワークはメジャーバージョンアップを行いません。利用ライブラリ（例えばTwig)モジュールはそのライブラリの破壊的変更に合わせてメジャーバージョンアップされます。 <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:1:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a> <a href="#fnref:1:2" class="reversefootnote" role="doc-backlink">&#8617;<sup>3</sup></a> <a href="#fnref:1:3" class="reversefootnote" role="doc-backlink">&#8617;<sup>4</sup></a> <a href="#fnref:1:4" class="reversefootnote" role="doc-backlink">&#8617;<sup>5</sup></a> <a href="#fnref:1:5" class="reversefootnote" role="doc-backlink">&#8617;<sup>6</sup></a> <a href="#fnref:1:6" class="reversefootnote" role="doc-backlink">&#8617;<sup>7</sup></a></p>
    </li>
    <li id="fn:now" role="doc-endnote">
      <p><a href="https://github.com/koriym/Koriym.Now">koriym/now</a> <a href="#fnref:now" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:inject-all" role="doc-endnote">
      <p>Web APIなど外部のシステムの値を利用する時には、クライアントクラスやWeb APIアクセスリソースなど１つにの場所に集中させDIやAOPでモッキングが容易にするようにします。 <a href="#fnref:inject-all" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:no-trait" role="doc-endnote">
      <p><code class="language-plaintext highlighter-rouge">ResourceInject</code>などのインジェクション用トレイトはインジェクションのボイラープレートコードを削減するために存在しましたが、PHP8で追加された<a href="https://www.php.net/manual/ja/language.oop5.decon.php#language.oop5.decon.constructor.promotion">コンストラクタの引数をプロパティへ昇格させる機能</a>により意味を失いました。コンストラクタインジェクションを使いましょう。 <a href="#fnref:no-trait" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:locater" role="doc-endnote">
      <p><a href="https://github.com/koriym/Koriym.QueryLocator">query-locater</a>はSQLをファイルとして扱うライブラリです。Aura.Sqlと共に使うと便利です。 <a href="#fnref:locater" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:doma" role="doc-endnote">
      <p>JavaのDBアクセスフレームワーク<a href="https://doma.readthedocs.io/en/latest/basic/#examples">Doma</a>と仕組みが似ています。 <a href="#fnref:doma" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:qualifier" role="doc-endnote">
      <p>識別子（クオリファイアー）についてはRay.Diのマニュアルの<a href="https://ray-di.github.io/manuals/1.0/ja/binding_attributes.html">束縛アトリビュート</a>をご覧ください。 <a href="#fnref:qualifier" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:v0dot5" role="doc-endnote">
      <p>以前のバージョン<code class="language-plaintext highlighter-rouge">0.5</code>までは次のようにSQLファイル名で判別していました。”SQL実行の戻り値が単一行なら<code class="language-plaintext highlighter-rouge">item</code>、複数行なら<code class="language-plaintext highlighter-rouge">list</code>のpostfixを付けます。” <a href="#fnref:v0dot5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:LO" role="doc-endnote">
      <p><a href="http://amundsen.com/hypermedia/hfactor/#le">out-bound links</a> 例）htmlは関連した他のhtmlにリンクを張ることができます。 <a href="#fnref:LO" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:LE" role="doc-endnote">
      <p><a href="http://amundsen.com/hypermedia/hfactor/#le">embedded links</a> 例）htmlは独立した画像リソースを埋め込むことができます。 <a href="#fnref:LE" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:di" role="doc-endnote">
      <p>DIで依存関係のツリーがグラフになっているオブジェクトグラフと同様です。 <a href="#fnref:di" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="https://en.wikipedia.org/wiki/Software_evolution">https://en.wikipedia.org/wiki/Software_evolution</a> <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:2:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a> <a href="#fnref:2:2" class="reversefootnote" role="doc-backlink">&#8617;<sup>3</sup></a> <a href="#fnref:2:3" class="reversefootnote" role="doc-backlink">&#8617;<sup>4</sup></a> <a href="#fnref:2:4" class="reversefootnote" role="doc-backlink">&#8617;<sup>5</sup></a> <a href="#fnref:2:5" class="reversefootnote" role="doc-backlink">&#8617;<sup>6</sup></a></p>
    </li>
    <li id="fn:php8" role="doc-endnote">
      <p>この時PHP8.xでは名前付き引数で呼ばれますが、PHP7.xでは順序引数でコールされます。 <a href="#fnref:php8" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:json" role="doc-endnote">
      <p>APIリクエストをJSONで送信する場合には<code class="language-plaintext highlighter-rouge">content-type</code>ヘッダーに<code class="language-plaintext highlighter-rouge">application/json</code>をセットしてください。 <a href="#fnref:json" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p><code class="language-plaintext highlighter-rouge">deprecated</code>扱いにするだけです。 <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:3:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a> <a href="#fnref:3:2" class="reversefootnote" role="doc-backlink">&#8617;<sup>3</sup></a> <a href="#fnref:3:3" class="reversefootnote" role="doc-backlink">&#8617;<sup>4</sup></a></p>
    </li>
    <li id="fn:spy-module" role="doc-endnote">
      <p>SpyModuleの利用には<a href="https://github.com/ray-di/Ray.TestDouble">ray/test-double</a>のインストールが必要です。 <a href="#fnref:spy-module" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:13" role="doc-endnote">
      <p>2018年9月現在php7.3だと実行できますが<code class="language-plaintext highlighter-rouge">PHP Deprecated</code>が表示されます。 <a href="#fnref:13" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:13:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>キャッシュを”温める”ために２度行うと確実です。 <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:4:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:named" role="doc-endnote">
      <p><a href="https://www.php.net/manual/ja/functions.arguments.php#functions.named-arguments">PHP 8.0+ 名前付き引数 ¶</a>、PHP7.xの場合にはコラムの順番になります。 <a href="#fnref:named" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:8" role="doc-endnote">
      <p>ここでは例としてmysqlから直接実行していますが、マイグレーションツールでseedを入力したりIDEのDBツールの利用方法も学びましょう。 <a href="#fnref:8" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p>コンテキストの変更は<code class="language-plaintext highlighter-rouge">composer.json</code>の<code class="language-plaintext highlighter-rouge">compile</code>スクリプトコマンドを編集します。 <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:5:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:6" role="doc-endnote">
      <p>BEAR.Sundayフレームワークが依存する環境変数は１つもありません。 <a href="#fnref:6" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:6:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:7" role="doc-endnote">
      <p>mysqlコマンドの操作などをREADMEで説明する必要もないので便利です。 <a href="#fnref:7" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:7:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:11" role="doc-endnote">
      <p><a href="https://help.github.com/articles/configuring-a-publishing-source-for-github-pages/#publishing-your-github-pages-site-from-a-docs-folder-on-your-master-branch">Publishing your GitHub Pages site from a /docs folder on your master branch</a> <a href="#fnref:11" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:11:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:9" role="doc-endnote">
      <p>http://json-schema.org/latest/json-schema-core.html#rfc.section.10.1 <a href="#fnref:9" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:9:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:10" role="doc-endnote">
      <p><code class="language-plaintext highlighter-rouge">/ticket</code>でPOSTされると<code class="language-plaintext highlighter-rouge">/tickets</code>リソースのキャッシュを破壊しています。<code class="language-plaintext highlighter-rouge">@Refresh</code>とすると破壊のタイミングでキャッシュを再生成します。 <a href="#fnref:10" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:10:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:12" role="doc-endnote">
      <p><a href="https://www.iana.org/assignments/media-types/media-types.xhtml">https://www.iana.org/assignments/media-types/media-types.xhtml</a> <a href="#fnref:12" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

            </article>
        </div>
        <div id="ArticleToc" class="col-lg-2 d-none d-lg-block">
            <nav class="nav side-bar-right"></nav>
        </div>
    </div>
</main>
<footer>
    <div class="container d-md-flex">
        <i class="bear-icon d-none d-lg-block"></i>
        <small>
            © 2011-2024 BEAR.Sunday
        </small>
        <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex">
            <li>
                <a href="https://gitter.im/bearsunday/BEAR.Sunday?utm_source=badge&utm_medium=badge&utm_campaign=pr-badge">Gitter</a>
            </li>
            <li>
                <a href="https://github.com/bearsunday/BEAR.Sunday">Github</a>
            </li>
            <li>
                <a href="https://twitter.com/BEARSunday">Twitter</a>
            </li>
            <li>
                <a href="https://www.facebook.com/pages/BEARSunday/110116939178462?ref=hl">Facebook</a>
            </li>
            <li>
                <a href="http://koriym.github.io/">Blog (JA)</a>
            </li>
            <li>
                <a href="https://github.com/bearsunday/bearsunday.github.io">PR ?</a>
            </li>
        </ul>
    </div>
</footer>
<script src="//code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="//stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-6074569-8', 'bearsunday.github.io'); ga('send', 'pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

<script src="/js/generate-table-of-contents/index.min.js"></script>
<script>
    var toc = generateTableOfContents(document.getElementById('article'));
    var sideBarRight = $('.side-bar-right');
    sideBarRight.append(toc);

    var scrollOffset = $('body').attr('data-offset');
    var articlePaddingTop = $('article').css('padding-top').replace('px', '');
    sideBarRight.find('a').on('click', function (e) {
        e.preventDefault();
        var targetId = $(this).attr('href');
        var targetPositionTop = $(targetId).offset().top - scrollOffset - articlePaddingTop;
        window.scrollTo(0, targetPositionTop)
    });
</script>

</body>
</html>

